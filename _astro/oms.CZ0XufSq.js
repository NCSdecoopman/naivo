(function(){var y={}.hasOwnProperty,S=[].slice;(function(){var h,f;if(this.L!=null)return this.OverlappingMarkerSpiderfier=((h=v.prototype).VERSION="0.2.6",f=2*Math.PI,h.keepSpiderfied=!1,h.nearbyDistance=20,h.circleSpiralSwitchover=9,h.circleFootSeparation=25,h.circleStartAngle=f/12,h.spiralFootSeparation=28,h.spiralLengthStart=11,h.spiralLengthFactor=5,h.legWeight=1.5,h.legColors={usual:"#222",highlighted:"#f00"},h.initMarkerArrays=function(){return this.markers=[],this.markerListeners=[]},h.addMarker=function(e){var t,r;return e._oms!=null||(e._oms=!0,r=this,t=function(){return r.spiderListener(e)},e.addEventListener("click",t),this.markerListeners.push(t),this.markers.push(e)),this},h.getMarkers=function(){return this.markers.slice(0)},h.removeMarker=function(e){var t,r;return e._omsData!=null&&this.unspiderfy(),(t=this.arrIndexOf(this.markers,e))<0||(r=this.markerListeners.splice(t,1)[0],e.removeEventListener("click",r),delete e._oms,this.markers.splice(t,1)),this},h.clearMarkers=function(){var e,t,r,i,s,a;for(this.unspiderfy(),e=t=0,r=(a=this.markers).length;t<r;e=++t)i=a[e],s=this.markerListeners[e],i.removeEventListener("click",s),delete i._oms;return this.initMarkerArrays(),this},h.addListener=function(e,t){var r;return((r=this.listeners)[e]!=null?r[e]:r[e]=[]).push(t),this},h.removeListener=function(e,t){var r;return(r=this.arrIndexOf(this.listeners[e],t))<0||this.listeners[e].splice(r,1),this},h.clearListeners=function(e){return this.listeners[e]=[],this},h.trigger=function(){var e,t,r,i,s,a,l,n;for(t=arguments[0],e=2<=arguments.length?S.call(arguments,1):[],n=[],i=0,s=(l=(a=this.listeners[t])!=null?a:[]).length;i<s;i++)r=l[i],n.push(r.apply(null,e));return n},h.generatePtsCircle=function(e,t){var r,i,s,a,l,n,o;for(l=this.circleFootSeparation*(2+e)/f,i=f/e,o=[],s=a=0,n=e;0<=n?a<n:n<a;s=0<=n?++a:--a)r=this.circleStartAngle+s*i,o.push(new L.Point(t.x+l*Math.cos(r),t.y+l*Math.sin(r)));return o},h.generatePtsSpiral=function(e,t){var r,i,s,a,l,n,o;for(a=this.spiralLengthStart,o=[],i=s=r=0,n=e;0<=n?s<n:n<s;i=0<=n?++s:--s)r+=this.spiralFootSeparation/a+5e-4*i,l=new L.Point(t.x+a*Math.cos(r),t.y+a*Math.sin(r)),a+=f*this.spiralLengthFactor/r,o.push(l);return o},h.spiderListener=function(e){var t,r,i,s,a,l,n,o,g,p;if((l=e._omsData!=null)&&this.keepSpiderfied||this.unspiderfy(),l)return this.trigger("click",e);for(n=[],o=[],g=this.nearbyDistance*this.nearbyDistance,a=this.map.latLngToLayerPoint(e.getLatLng()),t=0,r=(p=this.markers).length;t<r;t++)i=p[t],this.map.hasLayer(i)&&(s=this.map.latLngToLayerPoint(i.getLatLng()),this.ptDistanceSq(s,a)<g?n.push({marker:i,markerPt:s}):o.push(i));return n.length===1?this.trigger("click",e):this.spiderfy(n,o)},h.makeHighlightListeners=function(e){return{highlight:(r=this,function(){return e._omsData.leg.setStyle({color:r.legColors.highlighted})}),unhighlight:(t=this,function(){return e._omsData.leg.setStyle({color:t.legColors.usual})})};var t,r},h.spiderfy=function(e,t){var r,i,s,a,l,n,o,g,p,m,k;return this.spiderfying=!0,m=e.length,r=this.ptAverage((function(){var u,d,c;for(c=[],u=0,d=e.length;u<d;u++)o=e[u],c.push(o.markerPt);return c})()),a=m>=this.circleSpiralSwitchover?this.generatePtsSpiral(m,r).reverse():this.generatePtsCircle(m,r),k=function(){var u,d,c;for(c=[],u=0,d=a.length;u<d;u++)s=a[u],i=this.map.layerPointToLatLng(s),p=this.minExtract(e,(function(P){return function(D){return P.ptDistanceSq(D.markerPt,s)}})(this)),n=p.marker,l=new L.Polyline([n.getLatLng(),i],{color:this.legColors.usual,weight:this.legWeight,clickable:!1}),this.map.addLayer(l),n._omsData={usualPosition:n.getLatLng(),leg:l},this.legColors.highlighted!==this.legColors.usual&&(g=this.makeHighlightListeners(n),n._omsData.highlightListeners=g,n.addEventListener("mouseover",g.highlight),n.addEventListener("mouseout",g.unhighlight)),n.setLatLng(i),n.setZIndexOffset(n.options.zIndexOffset+1e6),c.push(n);return c}.call(this),delete this.spiderfying,this.spiderfied=!0,this.trigger("spiderfy",k,t)},h.unspiderfy=function(e){var t,r,i,s,a,l,n;if(e==null&&(e=null),this.spiderfied==null)return this;for(this.unspiderfying=!0,n=[],a=[],t=0,r=(l=this.markers).length;t<r;t++)(i=l[t])._omsData!=null?(this.map.removeLayer(i._omsData.leg),i!==e&&i.setLatLng(i._omsData.usualPosition),i.setZIndexOffset(i.options.zIndexOffset-1e6),(s=i._omsData.highlightListeners)!=null&&(i.removeEventListener("mouseover",s.highlight),i.removeEventListener("mouseout",s.unhighlight)),delete i._omsData,n.push(i)):a.push(i);return delete this.unspiderfying,delete this.spiderfied,this.trigger("unspiderfy",n,a),this},h.ptDistanceSq=function(e,t){var r,i;return(r=e.x-t.x)*r+(i=e.y-t.y)*i},h.ptAverage=function(e){var t,r,i,s,a,l;for(a=l=0,t=0,r=e.length;t<r;t++)a+=(s=e[t]).x,l+=s.y;return i=e.length,new L.Point(a/i,l/i)},h.minExtract=function(e,t){var r,i,s,a,l,n;for(s=a=0,l=e.length;a<l;s=++a)n=t(e[s]),(r==null||n<i)&&(i=n,r=s);return e.splice(r,1)[0]},h.arrIndexOf=function(e,t){var r,i,s;if(e.indexOf!=null)return e.indexOf(t);for(r=i=0,s=e.length;i<s;r=++i)if(e[r]===t)return r;return-1},v);function v(e,t){var r,i,s,a,l,n;for(s in this.map=e,t==null&&(t={}),t)y.call(t,s)&&(n=t[s],this[s]=n);for(this.initMarkerArrays(),this.listeners={},i=0,a=(l=["click","zoomend"]).length;i<a;i++)r=l[i],this.map.addEventListener(r,(function(o){return function(){return o.unspiderfy()}})(this))}}).call(window)})();
