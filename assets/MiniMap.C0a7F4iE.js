import{_ as Um,r as Jw,f as oE,j as Le,u as aE,c as lE,a as cE,b as uE,d as Xd,w as Wg}from"./MassifSearch.5IMdjnT0.js";import{r as je,g as Qw,R as hE}from"./index.CLiwIxch.js";/* empty css                       */import"./analytics.CwtcqfEL.js";function dE(i,e){for(var t=0;t<e.length;t++){const r=e[t];if(typeof r!="string"&&!Array.isArray(r)){for(const s in r)if(s!=="default"&&!(s in i)){const a=Object.getOwnPropertyDescriptor(r,s);a&&Object.defineProperty(i,s,a.get?a:{enumerable:!0,get:()=>r[s]})}}}return Object.freeze(Object.defineProperty(i,Symbol.toStringTag,{value:"Module"}))}function Hf(i,e){if(!i)throw new Error(e||"loader assertion failed.")}const L_=!!(typeof process!="object"||String(process)!=="[object process]"||process.browser),Dv=typeof process<"u"&&process.version&&/v([0-9]*)/.exec(process.version);Dv&&parseFloat(Dv[1]);const Ov=globalThis,Lv=globalThis.process||{},fE=globalThis.navigator||{};function e1(i){if(typeof window<"u"&&window.process?.type==="renderer"||typeof process<"u"&&process.versions?.electron)return!0;const t=typeof navigator<"u"&&navigator.userAgent;return!!(t&&t.indexOf("Electron")>=0)}function Ja(){return!(typeof process=="object"&&String(process)==="[object process]"&&!process?.browser)||e1()}function pE(i){return Ja()?e1()?"Electron":(fE.userAgent||"").indexOf("Edge")>-1?"Edge":globalThis.chrome?"Chrome":globalThis.safari?"Safari":globalThis.mozInnerScreenX?"Firefox":"Unknown":"Node"}const t1="4.1.0";function gE(i){try{const e=window[i],t="__storage_test__";return e.setItem(t,t),e.removeItem(t),e}catch{return null}}class mE{constructor(e,t,r="sessionStorage"){this.storage=gE(r),this.id=e,this.config=t,this._loadConfiguration()}getConfiguration(){return this.config}setConfiguration(e){if(Object.assign(this.config,e),this.storage){const t=JSON.stringify(this.config);this.storage.setItem(this.id,t)}}_loadConfiguration(){let e={};if(this.storage){const t=this.storage.getItem(this.id);e=t?JSON.parse(t):{}}return Object.assign(this.config,e),this}}function _E(i){let e;return i<10?e=`${i.toFixed(2)}ms`:i<100?e=`${i.toFixed(1)}ms`:i<1e3?e=`${i.toFixed(0)}ms`:e=`${(i/1e3).toFixed(2)}s`,e}function yE(i,e=8){const t=Math.max(e-i.length,0);return`${" ".repeat(t)}${i}`}var qf;(function(i){i[i.BLACK=30]="BLACK",i[i.RED=31]="RED",i[i.GREEN=32]="GREEN",i[i.YELLOW=33]="YELLOW",i[i.BLUE=34]="BLUE",i[i.MAGENTA=35]="MAGENTA",i[i.CYAN=36]="CYAN",i[i.WHITE=37]="WHITE",i[i.BRIGHT_BLACK=90]="BRIGHT_BLACK",i[i.BRIGHT_RED=91]="BRIGHT_RED",i[i.BRIGHT_GREEN=92]="BRIGHT_GREEN",i[i.BRIGHT_YELLOW=93]="BRIGHT_YELLOW",i[i.BRIGHT_BLUE=94]="BRIGHT_BLUE",i[i.BRIGHT_MAGENTA=95]="BRIGHT_MAGENTA",i[i.BRIGHT_CYAN=96]="BRIGHT_CYAN",i[i.BRIGHT_WHITE=97]="BRIGHT_WHITE"})(qf||(qf={}));const xE=10;function Fv(i){return typeof i!="string"?i:(i=i.toUpperCase(),qf[i]||qf.WHITE)}function vE(i,e,t){return!Ja&&typeof i=="string"&&(e&&(i=`\x1B[${Fv(e)}m${i}\x1B[39m`),t&&(i=`\x1B[${Fv(t)+xE}m${i}\x1B[49m`)),i}function bE(i,e=["constructor"]){const t=Object.getPrototypeOf(i),r=Object.getOwnPropertyNames(t),s=i;for(const a of r){const u=s[a];typeof u=="function"&&(e.find(l=>a===l)||(s[a]=u.bind(i)))}}function F_(i,e){if(!i)throw new Error("Assertion failed")}function Gl(){let i;if(Ja()&&Ov.performance)i=Ov?.performance?.now?.();else if("hrtime"in Lv){const e=Lv?.hrtime?.();i=e[0]*1e3+e[1]/1e6}else i=Date.now();return i}const Kl={debug:Ja()&&console.debug||console.log,log:console.log,info:console.info,warn:console.warn,error:console.error},wE={enabled:!0,level:0};function Jl(){}const Bv={},Nv={once:!0};class Nh{constructor({id:e}={id:""}){this.VERSION=t1,this._startTs=Gl(),this._deltaTs=Gl(),this.userData={},this.LOG_THROTTLE_TIMEOUT=0,this.id=e,this.userData={},this._storage=new mE(`__probe-${this.id}__`,wE),this.timeStamp(`${this.id} started`),bE(this),Object.seal(this)}set level(e){this.setLevel(e)}get level(){return this.getLevel()}isEnabled(){return this._storage.config.enabled}getLevel(){return this._storage.config.level}getTotal(){return Number((Gl()-this._startTs).toPrecision(10))}getDelta(){return Number((Gl()-this._deltaTs).toPrecision(10))}set priority(e){this.level=e}get priority(){return this.level}getPriority(){return this.level}enable(e=!0){return this._storage.setConfiguration({enabled:e}),this}setLevel(e){return this._storage.setConfiguration({level:e}),this}get(e){return this._storage.config[e]}set(e,t){this._storage.setConfiguration({[e]:t})}settings(){console.table?console.table(this._storage.config):console.log(this._storage.config)}assert(e,t){if(!e)throw new Error(t||"Assertion failed")}warn(e){return this._getLogFunction(0,e,Kl.warn,arguments,Nv)}error(e){return this._getLogFunction(0,e,Kl.error,arguments)}deprecated(e,t){return this.warn(`\`${e}\` is deprecated and will be removed in a later version. Use \`${t}\` instead`)}removed(e,t){return this.error(`\`${e}\` has been removed. Use \`${t}\` instead`)}probe(e,t){return this._getLogFunction(e,t,Kl.log,arguments,{time:!0,once:!0})}log(e,t){return this._getLogFunction(e,t,Kl.debug,arguments)}info(e,t){return this._getLogFunction(e,t,console.info,arguments)}once(e,t){return this._getLogFunction(e,t,Kl.debug||Kl.info,arguments,Nv)}table(e,t,r){return t?this._getLogFunction(e,t,console.table||Jl,r&&[r],{tag:SE(t)}):Jl}time(e,t){return this._getLogFunction(e,t,console.time?console.time:console.info)}timeEnd(e,t){return this._getLogFunction(e,t,console.timeEnd?console.timeEnd:console.info)}timeStamp(e,t){return this._getLogFunction(e,t,console.timeStamp||Jl)}group(e,t,r={collapsed:!1}){const s=zv({logLevel:e,message:t,opts:r}),{collapsed:a}=r;return s.method=(a?console.groupCollapsed:console.group)||console.info,this._getLogFunction(s)}groupCollapsed(e,t,r={}){return this.group(e,t,Object.assign({},r,{collapsed:!0}))}groupEnd(e){return this._getLogFunction(e,"",console.groupEnd||Jl)}withGroup(e,t,r){this.group(e,t)();try{r()}finally{this.groupEnd(e)()}}trace(){console.trace&&console.trace()}_shouldLog(e){return this.isEnabled()&&this.getLevel()>=i1(e)}_getLogFunction(e,t,r,s,a){if(this._shouldLog(e)){a=zv({logLevel:e,message:t,args:s,opts:a}),r=r||a.method,F_(r),a.total=this.getTotal(),a.delta=this.getDelta(),this._deltaTs=Gl();const u=a.tag||a.message;if(a.once&&u)if(!Bv[u])Bv[u]=Gl();else return Jl;return t=TE(this.id,a.message,a),r.bind(console,t,...a.args)}return Jl}}Nh.VERSION=t1;function i1(i){if(!i)return 0;let e;switch(typeof i){case"number":e=i;break;case"object":e=i.logLevel||i.priority||0;break;default:return 0}return F_(Number.isFinite(e)&&e>=0),e}function zv(i){const{logLevel:e,message:t}=i;i.logLevel=i1(e);const r=i.args?Array.from(i.args):[];for(;r.length&&r.shift()!==t;);switch(typeof e){case"string":case"function":t!==void 0&&r.unshift(t),i.message=e;break;case"object":Object.assign(i,e);break}typeof i.message=="function"&&(i.message=i.message());const s=typeof i.message;return F_(s==="string"||s==="object"),Object.assign(i,{args:r},i.opts)}function TE(i,e,t){if(typeof e=="string"){const r=t.time?yE(_E(t.total)):"";e=t.time?`${i}: ${r}  ${e}`:`${i}: ${e}`,e=vE(e,t.color,t.background)}return e}function SE(i){for(const e in i)for(const t in i[e])return t||"untitled";return"empty"}const Hg="4.3.3",AE=Hg[0]>="0"&&Hg[0]<="9"?`v${Hg}`:"";function EE(){const i=new Nh({id:"loaders.gl"});return globalThis.loaders=globalThis.loaders||{},globalThis.loaders.log=i,globalThis.loaders.version=AE,globalThis.probe=globalThis.probe||{},globalThis.probe.loaders=i,i}const IE=EE();function CE(i,e){return r1(i||{},e)}function r1(i,e,t=0){if(t>3)return e;const r={...i};for(const[s,a]of Object.entries(e))a&&typeof a=="object"&&!Array.isArray(a)?r[s]=r1(r[s]||{},e[s],t+1):r[s]=e[s];return r}const PE="latest";function ME(){return globalThis._loadersgl_?.version||(globalThis._loadersgl_=globalThis._loadersgl_||{},globalThis._loadersgl_.version="4.3.3"),globalThis._loadersgl_.version}const RE=ME();function ta(i,e){if(!i)throw new Error(e||"loaders.gl assertion failed.")}const Ua=typeof process!="object"||String(process)!=="[object process]"||process.browser,kE=typeof window<"u"&&typeof window.orientation<"u",Uv=typeof process<"u"&&process.version&&/v([0-9]*)/.exec(process.version);Uv&&parseFloat(Uv[1]);class DE{name;workerThread;isRunning=!0;result;_resolve=()=>{};_reject=()=>{};constructor(e,t){this.name=e,this.workerThread=t,this.result=new Promise((r,s)=>{this._resolve=r,this._reject=s})}postMessage(e,t){this.workerThread.postMessage({source:"loaders.gl",type:e,payload:t})}done(e){ta(this.isRunning),this.isRunning=!1,this._resolve(e)}error(e){ta(this.isRunning),this.isRunning=!1,this._reject(e)}}class qg{terminate(){}}const Xg=new Map;function OE(i){ta(i.source&&!i.url||!i.source&&i.url);let e=Xg.get(i.source||i.url);return e||(i.url&&(e=LE(i.url),Xg.set(i.url,e)),i.source&&(e=s1(i.source),Xg.set(i.source,e))),ta(e),e}function LE(i){if(!i.startsWith("http"))return i;const e=FE(i);return s1(e)}function s1(i){const e=new Blob([i],{type:"application/javascript"});return URL.createObjectURL(e)}function FE(i){return`try {
  importScripts('${i}');
} catch (error) {
  console.error(error);
  throw error;
}`}function n1(i,e=!0,t){const r=t||new Set;if(i){if(Vv(i))r.add(i);else if(Vv(i.buffer))r.add(i.buffer);else if(!ArrayBuffer.isView(i)){if(e&&typeof i=="object")for(const s in i)n1(i[s],e,r)}}return t===void 0?Array.from(r):[]}function Vv(i){return i?i instanceof ArrayBuffer||typeof MessagePort<"u"&&i instanceof MessagePort||typeof ImageBitmap<"u"&&i instanceof ImageBitmap||typeof OffscreenCanvas<"u"&&i instanceof OffscreenCanvas:!1}const Zg=()=>{};class Vm{name;source;url;terminated=!1;worker;onMessage;onError;_loadableURL="";static isSupported(){return typeof Worker<"u"&&Ua||typeof qg<"u"&&!Ua}constructor(e){const{name:t,source:r,url:s}=e;ta(r||s),this.name=t,this.source=r,this.url=s,this.onMessage=Zg,this.onError=a=>console.log(a),this.worker=Ua?this._createBrowserWorker():this._createNodeWorker()}destroy(){this.onMessage=Zg,this.onError=Zg,this.worker.terminate(),this.terminated=!0}get isRunning(){return!!this.onMessage}postMessage(e,t){t=t||n1(e),this.worker.postMessage(e,t)}_getErrorFromErrorEvent(e){let t="Failed to load ";return t+=`worker ${this.name} from ${this.url}. `,e.message&&(t+=`${e.message} in `),e.lineno&&(t+=`:${e.lineno}:${e.colno}`),new Error(t)}_createBrowserWorker(){this._loadableURL=OE({source:this.source,url:this.url});const e=new Worker(this._loadableURL,{name:this.name});return e.onmessage=t=>{t.data?this.onMessage(t.data):this.onError(new Error("No data received"))},e.onerror=t=>{this.onError(this._getErrorFromErrorEvent(t)),this.terminated=!0},e.onmessageerror=t=>console.error(t),e}_createNodeWorker(){let e;if(this.url){const r=this.url.includes(":/")||this.url.startsWith("/")?this.url:`./${this.url}`;e=new qg(r,{eval:!1})}else if(this.source)e=new qg(this.source,{eval:!0});else throw new Error("no worker");return e.on("message",t=>{this.onMessage(t)}),e.on("error",t=>{this.onError(t)}),e.on("exit",t=>{}),e}}class BE{name="unnamed";source;url;maxConcurrency=1;maxMobileConcurrency=1;onDebug=()=>{};reuseWorkers=!0;props={};jobQueue=[];idleQueue=[];count=0;isDestroyed=!1;static isSupported(){return Vm.isSupported()}constructor(e){this.source=e.source,this.url=e.url,this.setProps(e)}destroy(){this.idleQueue.forEach(e=>e.destroy()),this.isDestroyed=!0}setProps(e){this.props={...this.props,...e},e.name!==void 0&&(this.name=e.name),e.maxConcurrency!==void 0&&(this.maxConcurrency=e.maxConcurrency),e.maxMobileConcurrency!==void 0&&(this.maxMobileConcurrency=e.maxMobileConcurrency),e.reuseWorkers!==void 0&&(this.reuseWorkers=e.reuseWorkers),e.onDebug!==void 0&&(this.onDebug=e.onDebug)}async startJob(e,t=(s,a,u)=>s.done(u),r=(s,a)=>s.error(a)){const s=new Promise(a=>(this.jobQueue.push({name:e,onMessage:t,onError:r,onStart:a}),this));return this._startQueuedJob(),await s}async _startQueuedJob(){if(!this.jobQueue.length)return;const e=this._getAvailableWorker();if(!e)return;const t=this.jobQueue.shift();if(t){this.onDebug({message:"Starting job",name:t.name,workerThread:e,backlog:this.jobQueue.length});const r=new DE(t.name,e);e.onMessage=s=>t.onMessage(r,s.type,s.payload),e.onError=s=>t.onError(r,s),t.onStart(r);try{await r.result}catch(s){console.error(`Worker exception: ${s}`)}finally{this.returnWorkerToQueue(e)}}}returnWorkerToQueue(e){!Ua||this.isDestroyed||!this.reuseWorkers||this.count>this._getMaxConcurrency()?(e.destroy(),this.count--):this.idleQueue.push(e),this.isDestroyed||this._startQueuedJob()}_getAvailableWorker(){if(this.idleQueue.length>0)return this.idleQueue.shift()||null;if(this.count<this._getMaxConcurrency()){this.count++;const e=`${this.name.toLowerCase()} (#${this.count} of ${this.maxConcurrency})`;return new Vm({name:e,source:this.source,url:this.url})}return null}_getMaxConcurrency(){return kE?this.maxMobileConcurrency:this.maxConcurrency}}const NE={maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:!0,onDebug:()=>{}};class Xo{props;workerPools=new Map;static _workerFarm;static isSupported(){return Vm.isSupported()}static getWorkerFarm(e={}){return Xo._workerFarm=Xo._workerFarm||new Xo({}),Xo._workerFarm.setProps(e),Xo._workerFarm}constructor(e){this.props={...NE},this.setProps(e),this.workerPools=new Map}destroy(){for(const e of this.workerPools.values())e.destroy();this.workerPools=new Map}setProps(e){this.props={...this.props,...e};for(const t of this.workerPools.values())t.setProps(this._getWorkerPoolProps())}getWorkerPool(e){const{name:t,source:r,url:s}=e;let a=this.workerPools.get(t);return a||(a=new BE({name:t,source:r,url:s}),a.setProps(this._getWorkerPoolProps()),this.workerPools.set(t,a)),a}_getWorkerPoolProps(){return{maxConcurrency:this.props.maxConcurrency,maxMobileConcurrency:this.props.maxMobileConcurrency,reuseWorkers:this.props.reuseWorkers,onDebug:this.props.onDebug}}}function zE(i,e={}){const t=e[i.id]||{},r=Ua?`${i.id}-worker.js`:`${i.id}-worker-node.js`;let s=t.workerUrl;if(!s&&i.id==="compression"&&(s=e.workerUrl),e._workerType==="test"&&(Ua?s=`modules/${i.module}/dist/${r}`:s=`modules/${i.module}/src/workers/${i.id}-worker-node.ts`),!s){let a=i.version;a==="latest"&&(a=PE);const u=a?`@${a}`:"";s=`https://unpkg.com/@loaders.gl/${i.module}${u}/dist/${r}`}return ta(s),s}function UE(i,e=RE){ta(i,"no worker provided");const t=i.version;return!(!e||!t)}function VE(i,e){return!Xo.isSupported()||!Ua&&!e?._nodeWorkers?!1:i.worker&&e?.worker}async function jE(i,e,t,r,s){const a=i.id,u=zE(i,t),g=Xo.getWorkerFarm(t).getWorkerPool({name:a,url:u});t=JSON.parse(JSON.stringify(t)),r=JSON.parse(JSON.stringify(r||{}));const v=await g.startJob("process-on-worker",$E.bind(null,s));return v.postMessage("process",{input:e,options:t,context:r}),await(await v.result).result}async function $E(i,e,t,r){switch(t){case"done":e.done(r);break;case"error":e.error(new Error(r.error));break;case"process":const{id:s,input:a,options:u}=r;try{const l=await i(a,u);e.postMessage("done",{id:s,result:l})}catch(l){const g=l instanceof Error?l.message:"unknown error";e.postMessage("error",{id:s,error:g})}break;default:console.warn(`parse-with-worker unknown message ${t}`)}}function WE(i,e,t){if(t=t||i.byteLength,i.byteLength<t||e.byteLength<t)return!1;const r=new Uint8Array(i),s=new Uint8Array(e);for(let a=0;a<r.length;++a)if(r[a]!==s[a])return!1;return!0}function HE(...i){return qE(i)}function qE(i){const e=i.map(a=>a instanceof ArrayBuffer?new Uint8Array(a):a),t=e.reduce((a,u)=>a+u.byteLength,0),r=new Uint8Array(t);let s=0;for(const a of e)r.set(a,s),s+=a.byteLength;return r.buffer}async function XE(i){const e=[];for await(const t of i)e.push(t);return HE(...e)}function jv(){let i;if(typeof window<"u"&&window.performance)i=window.performance.now();else if(typeof process<"u"&&process.hrtime){const e=process.hrtime();i=e[0]*1e3+e[1]/1e6}else i=Date.now();return i}class $v{constructor(e,t){this.sampleSize=1,this.time=0,this.count=0,this.samples=0,this.lastTiming=0,this.lastSampleTime=0,this.lastSampleCount=0,this._count=0,this._time=0,this._samples=0,this._startTime=0,this._timerPending=!1,this.name=e,this.type=t,this.reset()}reset(){return this.time=0,this.count=0,this.samples=0,this.lastTiming=0,this.lastSampleTime=0,this.lastSampleCount=0,this._count=0,this._time=0,this._samples=0,this._startTime=0,this._timerPending=!1,this}setSampleSize(e){return this.sampleSize=e,this}incrementCount(){return this.addCount(1),this}decrementCount(){return this.subtractCount(1),this}addCount(e){return this._count+=e,this._samples++,this._checkSampling(),this}subtractCount(e){return this._count-=e,this._samples++,this._checkSampling(),this}addTime(e){return this._time+=e,this.lastTiming=e,this._samples++,this._checkSampling(),this}timeStart(){return this._startTime=jv(),this._timerPending=!0,this}timeEnd(){return this._timerPending?(this.addTime(jv()-this._startTime),this._timerPending=!1,this._checkSampling(),this):this}getSampleAverageCount(){return this.sampleSize>0?this.lastSampleCount/this.sampleSize:0}getSampleAverageTime(){return this.sampleSize>0?this.lastSampleTime/this.sampleSize:0}getSampleHz(){return this.lastSampleTime>0?this.sampleSize/(this.lastSampleTime/1e3):0}getAverageCount(){return this.samples>0?this.count/this.samples:0}getAverageTime(){return this.samples>0?this.time/this.samples:0}getHz(){return this.time>0?this.samples/(this.time/1e3):0}_checkSampling(){this._samples===this.sampleSize&&(this.lastSampleTime=this._time,this.lastSampleCount=this._count,this.count+=this._count,this.time+=this._time,this.samples+=this._samples,this._time=0,this._count=0,this._samples=0)}}class zh{constructor(e){this.stats={},this.id=e.id,this.stats={},this._initializeStats(e.stats),Object.seal(this)}get(e,t="count"){return this._getOrCreate({name:e,type:t})}get size(){return Object.keys(this.stats).length}reset(){for(const e of Object.values(this.stats))e.reset();return this}forEach(e){for(const t of Object.values(this.stats))e(t)}getTable(){const e={};return this.forEach(t=>{e[t.name]={time:t.time||0,count:t.count||0,average:t.getAverageTime()||0,hz:t.getHz()||0}}),e}_initializeStats(e=[]){e.forEach(t=>this._getOrCreate(t))}_getOrCreate(e){const{name:t,type:r}=e;let s=this.stats[t];return s||(e instanceof $v?s=e:s=new $v(t,r),this.stats[t]=s),s}}const ZE="Queued Requests",YE="Active Requests",GE="Cancelled Requests",KE="Queued Requests Ever",JE="Active Requests Ever",QE={id:"request-scheduler",throttleRequests:!0,maxRequests:6,debounceTime:0};class e3{props;stats;activeRequestCount=0;requestQueue=[];requestMap=new Map;updateTimer=null;constructor(e={}){this.props={...QE,...e},this.stats=new zh({id:this.props.id}),this.stats.get(ZE),this.stats.get(YE),this.stats.get(GE),this.stats.get(KE),this.stats.get(JE)}scheduleRequest(e,t=()=>0){if(!this.props.throttleRequests)return Promise.resolve({done:()=>{}});if(this.requestMap.has(e))return this.requestMap.get(e);const r={handle:e,priority:0,getPriority:t},s=new Promise(a=>(r.resolve=a,r));return this.requestQueue.push(r),this.requestMap.set(e,s),this._issueNewRequests(),s}_issueRequest(e){const{handle:t,resolve:r}=e;let s=!1;const a=()=>{s||(s=!0,this.requestMap.delete(t),this.activeRequestCount--,this._issueNewRequests())};return this.activeRequestCount++,r?r({done:a}):Promise.resolve({done:a})}_issueNewRequests(){this.updateTimer!==null&&clearTimeout(this.updateTimer),this.updateTimer=setTimeout(()=>this._issueNewRequestsAsync(),this.props.debounceTime)}_issueNewRequestsAsync(){this.updateTimer!==null&&clearTimeout(this.updateTimer),this.updateTimer=null;const e=Math.max(this.props.maxRequests-this.activeRequestCount,0);if(e!==0){this._updateAllRequests();for(let t=0;t<e;++t){const r=this.requestQueue.shift();r&&this._issueRequest(r)}}}_updateAllRequests(){const e=this.requestQueue;for(let t=0;t<e.length;++t){const r=e[t];this._updateRequest(r)||(e.splice(t,1),this.requestMap.delete(r.handle),t--)}e.sort((t,r)=>t.priority-r.priority)}_updateRequest(e){return e.priority=e.getPriority(e.handle),e.priority<0?(e.resolve(null),!1):!0}}let t3="";const Wv={};function i3(i){for(const e in Wv)if(i.startsWith(e)){const t=Wv[e];i=i.replace(e,t)}return!i.startsWith("http://")&&!i.startsWith("https://")&&(i=`${t3}${i}`),i}function r3(i){return i&&typeof i=="object"&&i.isBuffer}function o1(i){if(r3(i))return i;if(i instanceof ArrayBuffer)return i;if(ArrayBuffer.isView(i))return i.byteOffset===0&&i.byteLength===i.buffer.byteLength?i.buffer:i.buffer.slice(i.byteOffset,i.byteOffset+i.byteLength);if(typeof i=="string"){const e=i;return new TextEncoder().encode(e).buffer}if(i&&typeof i=="object"&&i._toArrayBuffer)return i._toArrayBuffer();throw new Error("toArrayBuffer")}function a1(i){const e=i?i.lastIndexOf("/"):-1;return e>=0?i.substr(e+1):""}function s3(i){const e=i?i.lastIndexOf("/"):-1;return e>=0?i.substr(0,e):""}const n3=i=>typeof i=="boolean",_h=i=>typeof i=="function",Uh=i=>i!==null&&typeof i=="object",Hv=i=>Uh(i)&&i.constructor==={}.constructor,o3=i=>!!i&&typeof i[Symbol.iterator]=="function",a3=i=>i&&typeof i[Symbol.asyncIterator]=="function",Qa=i=>typeof Response<"u"&&i instanceof Response||i&&i.arrayBuffer&&i.text&&i.json,el=i=>typeof Blob<"u"&&i instanceof Blob,l3=i=>i&&typeof i=="object"&&i.isBuffer,c3=i=>typeof ReadableStream<"u"&&i instanceof ReadableStream||Uh(i)&&_h(i.tee)&&_h(i.cancel)&&_h(i.getReader),u3=i=>Uh(i)&&_h(i.read)&&_h(i.pipe)&&n3(i.readable),l1=i=>c3(i)||u3(i);class h3 extends Error{constructor(e,t){super(e),this.reason=t.reason,this.url=t.url,this.response=t.response}reason;url;response}const d3=/^data:([-\w.]+\/[-\w.+]+)(;|,)/,f3=/^([-\w.]+\/[-\w.+]+)/;function qv(i,e){return i.toLowerCase()===e.toLowerCase()}function p3(i){const e=f3.exec(i);return e?e[1]:i}function Xv(i){const e=d3.exec(i);return e?e[1]:""}const c1=/\?.*/;function g3(i){const e=i.match(c1);return e&&e[0]}function B_(i){return i.replace(c1,"")}function m3(i){if(i.length<50)return i;const e=i.slice(i.length-15);return`${i.substr(0,32)}...${e}`}function fp(i){return Qa(i)?i.url:el(i)?i.name||"":typeof i=="string"?i:""}function N_(i){if(Qa(i)){const e=i,t=e.headers.get("content-type")||"",r=B_(e.url);return p3(t)||Xv(r)}return el(i)?i.type||"":typeof i=="string"?Xv(i):""}function _3(i){return Qa(i)?i.headers["content-length"]||-1:el(i)?i.size:typeof i=="string"?i.length:i instanceof ArrayBuffer||ArrayBuffer.isView(i)?i.byteLength:-1}async function u1(i){if(Qa(i))return i;const e={},t=_3(i);t>=0&&(e["content-length"]=String(t));const r=fp(i),s=N_(i);s&&(e["content-type"]=s);const a=await v3(i);a&&(e["x-first-bytes"]=a),typeof i=="string"&&(i=new TextEncoder().encode(i));const u=new Response(i,{headers:e});return Object.defineProperty(u,"url",{value:r}),u}async function y3(i){if(!i.ok)throw await x3(i)}async function x3(i){const e=m3(i.url);let t=`Failed to fetch resource (${i.status}) ${i.statusText}: ${e}`;t=t.length>100?`${t.slice(0,100)}...`:t;const r={reason:i.statusText,url:i.url,response:i};try{const s=i.headers.get("Content-Type");r.reason=!i.bodyUsed&&s?.includes("application/json")?await i.json():await i.text()}catch{}return new h3(t,r)}async function v3(i){if(typeof i=="string")return`data:,${i.slice(0,5)}`;if(i instanceof Blob){const t=i.slice(0,5);return await new Promise(r=>{const s=new FileReader;s.onload=a=>r(a?.target?.result),s.readAsDataURL(t)})}if(i instanceof ArrayBuffer){const t=i.slice(0,5);return`data:base64,${b3(t)}`}return null}function b3(i){let e="";const t=new Uint8Array(i);for(let r=0;r<t.byteLength;r++)e+=String.fromCharCode(t[r]);return btoa(e)}function w3(i){return!T3(i)&&!S3(i)}function T3(i){return i.startsWith("http:")||i.startsWith("https:")}function S3(i){return i.startsWith("data:")}async function Zv(i,e){if(typeof i=="string"){const t=i3(i);return w3(t)&&globalThis.loaders?.fetchNode?globalThis.loaders?.fetchNode(t,e):await fetch(t,e)}return await u1(i)}const Yv=new Nh({id:"loaders.gl"});class A3{log(){return()=>{}}info(){return()=>{}}warn(){return()=>{}}error(){return()=>{}}}class E3{console;constructor(){this.console=console}log(...e){return this.console.log.bind(this.console,...e)}info(...e){return this.console.info.bind(this.console,...e)}warn(...e){return this.console.warn.bind(this.console,...e)}error(...e){return this.console.error.bind(this.console,...e)}}const h1={fetch:null,mimeType:void 0,nothrow:!1,log:new E3,useLocalLibraries:!1,CDN:"https://unpkg.com/@loaders.gl",worker:!0,maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:L_,_nodeWorkers:!1,_workerType:"",limit:0,_limitMB:0,batchSize:"auto",batchDebounceMs:0,metadata:!1,transforms:[]},I3={throws:"nothrow",dataType:"(no longer used)",uri:"baseUri",method:"fetch.method",headers:"fetch.headers",body:"fetch.body",mode:"fetch.mode",credentials:"fetch.credentials",cache:"fetch.cache",redirect:"fetch.redirect",referrer:"fetch.referrer",referrerPolicy:"fetch.referrerPolicy",integrity:"fetch.integrity",keepalive:"fetch.keepalive",signal:"fetch.signal"};function d1(){globalThis.loaders=globalThis.loaders||{};const{loaders:i}=globalThis;return i._state||(i._state={}),i._state}function f1(){const i=d1();return i.globalOptions=i.globalOptions||{...h1},i.globalOptions}function C3(i,e,t,r){return t=t||[],t=Array.isArray(t)?t:[t],P3(i,t),R3(e,i,r)}function P3(i,e){Gv(i,null,h1,I3,e);for(const t of e){const r=i&&i[t.id]||{},s=t.options&&t.options[t.id]||{},a=t.deprecatedOptions&&t.deprecatedOptions[t.id]||{};Gv(r,t.id,s,a,e)}}function Gv(i,e,t,r,s){const a=e||"Top level",u=e?`${e}.`:"";for(const l in i){const g=!e&&Uh(i[l]),v=l==="baseUri"&&!e,T=l==="workerUrl"&&e;if(!(l in t)&&!v&&!T){if(l in r)Yv.warn(`${a} loader option '${u}${l}' no longer supported, use '${r[l]}'`)();else if(!g){const S=M3(l,s);Yv.warn(`${a} loader option '${u}${l}' not recognized. ${S}`)()}}}}function M3(i,e){const t=i.toLowerCase();let r="";for(const s of e)for(const a in s.options){if(i===a)return`Did you mean '${s.id}.${a}'?`;const u=a.toLowerCase();(t.startsWith(u)||u.startsWith(t))&&(r=r||`Did you mean '${s.id}.${a}'?`)}return r}function R3(i,e,t){const s={...i.options||{}};return k3(s,t),s.log===null&&(s.log=new A3),Kv(s,f1()),Kv(s,e),s}function Kv(i,e){for(const t in e)if(t in e){const r=e[t];Hv(r)&&Hv(i[t])?i[t]={...i[t],...e[t]}:i[t]=e[t]}}function k3(i,e){e&&!("baseUri"in i)&&(i.baseUri=e)}function z_(i){return i?(Array.isArray(i)&&(i=i[0]),Array.isArray(i?.extensions)):!1}function U_(i){Hf(i,"null loader"),Hf(z_(i),"invalid loader");let e;return Array.isArray(i)&&(e=i[1],i=i[0],i={...i,options:{...i.options,...e}}),(i?.parseTextSync||i?.parseText)&&(i.text=!0),i.text||(i.binary=!0),i}const p1=()=>{const i=d1();return i.loaderRegistry=i.loaderRegistry||[],i.loaderRegistry};function D3(i){const e=p1();i=Array.isArray(i)?i:[i];for(const t of i){const r=U_(t);e.find(s=>r===s)||e.unshift(r)}}function O3(){return p1()}const L3=/\.([^.]+)$/;async function F3(i,e=[],t,r){if(!g1(i))return null;let s=Jv(i,e,{...t,nothrow:!0},r);if(s)return s;if(el(i)&&(i=await i.slice(0,10).arrayBuffer(),s=Jv(i,e,t,r)),!s&&!t?.nothrow)throw new Error(m1(i));return s}function Jv(i,e=[],t,r){if(!g1(i))return null;if(e&&!Array.isArray(e))return U_(e);let s=[];e&&(s=s.concat(e)),t?.ignoreRegisteredLoaders||s.push(...O3()),N3(s);const a=B3(i,s,t,r);if(!a&&!t?.nothrow)throw new Error(m1(i));return a}function B3(i,e,t,r){const s=fp(i),a=N_(i),u=B_(s)||r?.url;let l=null,g="";return t?.mimeType&&(l=Yg(e,t?.mimeType),g=`match forced by supplied MIME type ${t?.mimeType}`),l=l||z3(e,u),g=g||(l?`matched url ${u}`:""),l=l||Yg(e,a),g=g||(l?`matched MIME type ${a}`:""),l=l||V3(e,i),g=g||(l?`matched initial data ${_1(i)}`:""),t?.fallbackMimeType&&(l=l||Yg(e,t?.fallbackMimeType),g=g||(l?`matched fallback MIME type ${a}`:"")),g&&IE.log(1,`selectLoader selected ${l?.name}: ${g}.`),l}function g1(i){return!(i instanceof Response&&i.status===204)}function m1(i){const e=fp(i),t=N_(i);let r="No valid loader found (";r+=e?`${a1(e)}, `:"no url provided, ",r+=`MIME type: ${t?`"${t}"`:"not provided"}, `;const s=i?_1(i):"";return r+=s?` first bytes: "${s}"`:"first bytes: not available",r+=")",r}function N3(i){for(const e of i)U_(e)}function z3(i,e){const t=e&&L3.exec(e),r=t&&t[1];return r?U3(i,r):null}function U3(i,e){e=e.toLowerCase();for(const t of i)for(const r of t.extensions)if(r.toLowerCase()===e)return t;return null}function Yg(i,e){for(const t of i)if(t.mimeTypes?.some(r=>qv(e,r))||qv(e,`application/x.${t.id}`))return t;return null}function V3(i,e){if(!e)return null;for(const t of i)if(typeof e=="string"){if(j3(e,t))return t}else if(ArrayBuffer.isView(e)){if(Qv(e.buffer,e.byteOffset,t))return t}else if(e instanceof ArrayBuffer&&Qv(e,0,t))return t;return null}function j3(i,e){return e.testText?e.testText(i):(Array.isArray(e.tests)?e.tests:[e.tests]).some(r=>i.startsWith(r))}function Qv(i,e,t){return(Array.isArray(t.tests)?t.tests:[t.tests]).some(s=>$3(i,e,t,s))}function $3(i,e,t,r){if(r instanceof ArrayBuffer)return WE(r,i,r.byteLength);switch(typeof r){case"function":return r(i);case"string":const s=jm(i,e,r.length);return r===s;default:return!1}}function _1(i,e=5){return typeof i=="string"?i.slice(0,e):ArrayBuffer.isView(i)?jm(i.buffer,i.byteOffset,e):i instanceof ArrayBuffer?jm(i,0,e):""}function jm(i,e,t){if(i.byteLength<e+t)return"";const r=new DataView(i);let s="";for(let a=0;a<t;a++)s+=String.fromCharCode(r.getUint8(e+a));return s}const W3=256*1024;function*H3(i,e){const t=e?.chunkSize||W3;let r=0;const s=new TextEncoder;for(;r<i.length;){const a=Math.min(i.length-r,t),u=i.slice(r,r+a);r+=a,yield s.encode(u)}}const q3=256*1024;function*X3(i,e={}){const{chunkSize:t=q3}=e;let r=0;for(;r<i.byteLength;){const s=Math.min(i.byteLength-r,t),a=new ArrayBuffer(s),u=new Uint8Array(i,r,s);new Uint8Array(a).set(u),r+=s,yield a}}const Z3=1024*1024;async function*Y3(i,e){const t=e?.chunkSize||Z3;let r=0;for(;r<i.size;){const s=r+t,a=await i.slice(r,s).arrayBuffer();r=s,yield a}}function eb(i,e){return L_?G3(i,e):K3(i)}async function*G3(i,e){const t=i.getReader();let r;try{for(;;){const s=r||t.read();e?._streamReadAhead&&(r=t.read());const{done:a,value:u}=await s;if(a)return;yield o1(u)}}catch{t.releaseLock()}}async function*K3(i,e){for await(const t of i)yield o1(t)}function J3(i,e){if(typeof i=="string")return H3(i,e);if(i instanceof ArrayBuffer)return X3(i,e);if(el(i))return Y3(i,e);if(l1(i))return eb(i,e);if(Qa(i))return eb(i.body,e);throw new Error("makeIterator")}const y1="Cannot convert supplied data type";function Q3(i,e,t){if(e.text&&typeof i=="string")return i;if(l3(i)&&(i=i.buffer),i instanceof ArrayBuffer){const r=i;return e.text&&!e.binary?new TextDecoder("utf8").decode(r):r}if(ArrayBuffer.isView(i)){if(e.text&&!e.binary)return new TextDecoder("utf8").decode(i);let r=i.buffer;const s=i.byteLength||i.length;return(i.byteOffset!==0||s!==r.byteLength)&&(r=r.slice(i.byteOffset,i.byteOffset+s)),r}throw new Error(y1)}async function eI(i,e,t){const r=i instanceof ArrayBuffer||ArrayBuffer.isView(i);if(typeof i=="string"||r)return Q3(i,e);if(el(i)&&(i=await u1(i)),Qa(i)){const s=i;return await y3(s),e.binary?await s.arrayBuffer():await s.text()}if(l1(i)&&(i=J3(i,t)),o3(i)||a3(i))return XE(i);throw new Error(y1)}function x1(i,e){const t=f1(),r=i||t;return typeof r.fetch=="function"?r.fetch:Uh(r.fetch)?s=>Zv(s,r.fetch):e?.fetch?e?.fetch:Zv}function tI(i,e,t){if(t)return t;const r={fetch:x1(e,i),...i};if(r.url){const s=B_(r.url);r.baseUrl=s,r.queryString=g3(r.url),r.filename=a1(s),r.baseUrl=s3(s)}return Array.isArray(r.loaders)||(r.loaders=null),r}function iI(i,e){if(i&&!Array.isArray(i))return i;let t;if(i&&(t=Array.isArray(i)?i:[i]),e&&e.loaders){const r=Array.isArray(e.loaders)?e.loaders:[e.loaders];t=t?[...t,...r]:r}return t&&t.length?t:void 0}async function Xf(i,e,t,r){e&&!Array.isArray(e)&&!z_(e)&&(r=void 0,t=e,e=void 0),i=await i,t=t||{};const s=fp(i),u=iI(e,r),l=await F3(i,u,t);return l?(t=C3(t,l,u,s),r=tI({url:s,_parse:Xf,loaders:u},t,r||null),await rI(l,i,t,r)):null}async function rI(i,e,t,r){if(UE(i),t=CE(i.options,t),Qa(e)){const a=e,{ok:u,redirected:l,status:g,statusText:v,type:T,url:S}=a,P=Object.fromEntries(a.headers.entries());r.response={headers:P,ok:u,redirected:l,status:g,statusText:v,type:T,url:S}}e=await eI(e,i,t);const s=i;if(s.parseTextSync&&typeof e=="string")return s.parseTextSync(e,t,r);if(VE(i,t))return await jE(i,e,t,r,Xf);if(s.parseText&&typeof e=="string")return await s.parseText(e,t,r);if(s.parse)return await s.parse(e,t,r);throw ta(!s.parseSync),new Error(`${i.id} loader - no parser found and worker is disabled`)}async function Zf(i,e,t,r){let s,a;!Array.isArray(e)&&!z_(e)?(s=[],a=e):(s=e,a=t);const u=x1(a);let l=i;return typeof i=="string"&&(l=await u(i)),el(i)&&(l=await u(i)),Array.isArray(s)?await Xf(l,s,a):await Xf(l,s,a)}const sI="4.3.3",nI=globalThis.loaders?.parseImageNode,$m=typeof Image<"u",Wm=typeof ImageBitmap<"u",oI=!!nI,Hm=L_?!0:oI;function aI(i){switch(i){case"auto":return Wm||$m||Hm;case"imagebitmap":return Wm;case"image":return $m;case"data":return Hm;default:throw new Error(`@loaders.gl/images: image ${i} not supported in this environment`)}}function lI(){if(Wm)return"imagebitmap";if($m)return"image";if(Hm)return"data";throw new Error("Install '@loaders.gl/polyfills' to parse images under Node.js")}function cI(i){const e=hI(i);if(!e)throw new Error("Not an image");return e}function uI(i){switch(cI(i)){case"data":return i;case"image":case"imagebitmap":const e=document.createElement("canvas"),t=e.getContext("2d");if(!t)throw new Error("getImageData");return e.width=i.width,e.height=i.height,t.drawImage(i,0,0),t.getImageData(0,0,i.width,i.height);default:throw new Error("getImageData")}}function hI(i){return typeof ImageBitmap<"u"&&i instanceof ImageBitmap?"imagebitmap":typeof Image<"u"&&i instanceof Image?"image":i&&typeof i=="object"&&i.data&&i.width&&i.height?"data":null}const dI=/^data:image\/svg\+xml/,fI=/\.svg((\?|#).*)?$/;function V_(i){return i&&(dI.test(i)||fI.test(i))}function pI(i,e){if(V_(e)){let r=new TextDecoder().decode(i);try{typeof unescape=="function"&&typeof encodeURIComponent=="function"&&(r=unescape(encodeURIComponent(r)))}catch(a){throw new Error(a.message)}return`data:image/svg+xml;base64,${btoa(r)}`}return v1(i,e)}function v1(i,e){if(V_(e))throw new Error("SVG cannot be parsed directly to imagebitmap");return new Blob([new Uint8Array(i)])}async function b1(i,e,t){const r=pI(i,t),s=self.URL||self.webkitURL,a=typeof r!="string"&&s.createObjectURL(r);try{return await gI(a||r,e)}finally{a&&s.revokeObjectURL(a)}}async function gI(i,e){const t=new Image;return t.src=i,e.image&&e.image.decode&&t.decode?(await t.decode(),t):await new Promise((r,s)=>{try{t.onload=()=>r(t),t.onerror=a=>{const u=a instanceof Error?a.message:"error";s(new Error(u))}}catch(a){s(a)}})}const mI={};let tb=!0;async function _I(i,e,t){let r;V_(t)?r=await b1(i,e,t):r=v1(i,t);const s=e&&e.imagebitmap;return await yI(r,s)}async function yI(i,e=null){if((xI(e)||!tb)&&(e=null),e)try{return await createImageBitmap(i,e)}catch(t){console.warn(t),tb=!1}return await createImageBitmap(i)}function xI(i){for(const e in i||mI)return!1;return!0}function vI(i){return!SI(i,"ftyp",4)||(i[8]&96)===0?null:bI(i)}function bI(i){switch(wI(i,8,12).replace("\0"," ").trim()){case"avif":case"avis":return{extension:"avif",mimeType:"image/avif"};default:return null}}function wI(i,e,t){return String.fromCharCode(...i.slice(e,t))}function TI(i){return[...i].map(e=>e.charCodeAt(0))}function SI(i,e,t=0){const r=TI(e);for(let s=0;s<r.length;++s)if(r[s]!==i[s+t])return!1;return!0}const An=!1,yh=!0;function w1(i){const e=Vh(i);return EI(e)||PI(e)||II(e)||CI(e)||AI(e)}function AI(i){const e=new Uint8Array(i instanceof DataView?i.buffer:i),t=vI(e);return t?{mimeType:t.mimeType,width:0,height:0}:null}function EI(i){const e=Vh(i);return e.byteLength>=24&&e.getUint32(0,An)===2303741511?{mimeType:"image/png",width:e.getUint32(16,An),height:e.getUint32(20,An)}:null}function II(i){const e=Vh(i);return e.byteLength>=10&&e.getUint32(0,An)===1195984440?{mimeType:"image/gif",width:e.getUint16(6,yh),height:e.getUint16(8,yh)}:null}function CI(i){const e=Vh(i);return e.byteLength>=14&&e.getUint16(0,An)===16973&&e.getUint32(2,yh)===e.byteLength?{mimeType:"image/bmp",width:e.getUint32(18,yh),height:e.getUint32(22,yh)}:null}function PI(i){const e=Vh(i);if(!(e.byteLength>=3&&e.getUint16(0,An)===65496&&e.getUint8(2)===255))return null;const{tableMarkers:r,sofMarkers:s}=MI();let a=2;for(;a+9<e.byteLength;){const u=e.getUint16(a,An);if(s.has(u))return{mimeType:"image/jpeg",height:e.getUint16(a+5,An),width:e.getUint16(a+7,An)};if(!r.has(u))return null;a+=2,a+=e.getUint16(a,An)}return null}function MI(){const i=new Set([65499,65476,65484,65501,65534]);for(let t=65504;t<65520;++t)i.add(t);return{tableMarkers:i,sofMarkers:new Set([65472,65473,65474,65475,65477,65478,65479,65481,65482,65483,65485,65486,65487,65502])}}function Vh(i){if(i instanceof DataView)return i;if(ArrayBuffer.isView(i))return new DataView(i.buffer);if(i instanceof ArrayBuffer)return new DataView(i);throw new Error("toDataView")}async function RI(i,e){const{mimeType:t}=w1(i)||{},r=globalThis.loaders?.parseImageNode;return Hf(r),await r(i,t)}async function kI(i,e,t){e=e||{};const s=(e.image||{}).type||"auto",{url:a}=t||{},u=DI(s);let l;switch(u){case"imagebitmap":l=await _I(i,e,a);break;case"image":l=await b1(i,e,a);break;case"data":l=await RI(i);break;default:Hf(!1)}return s==="data"&&(l=uI(l)),l}function DI(i){switch(i){case"auto":case"data":return lI();default:return aI(i),i}}const OI=["png","jpg","jpeg","gif","webp","bmp","ico","svg","avif"],LI=["image/png","image/jpeg","image/gif","image/webp","image/avif","image/bmp","image/vnd.microsoft.icon","image/svg+xml"],FI={image:{type:"auto",decode:!0}},BI={dataType:null,batchType:null,id:"image",module:"images",name:"Images",version:sI,mimeTypes:LI,extensions:OI,parse:kI,tests:[i=>!!w1(new DataView(i))],options:FI},ni=new Nh({id:"deck"});let qm={};function NI(i){qm=i}function Hr(i,e,t,r){ni.level>0&&qm[i]&&qm[i].call(null,e,t,r)}function zI(i){const e=i[0],t=i[i.length-1];return e==="{"&&t==="}"||e==="["&&t==="]"}const UI={dataType:null,batchType:null,id:"JSON",name:"JSON",module:"",version:"",options:{},extensions:["json","geojson"],mimeTypes:["application/json","application/geo+json"],testText:zI,parseTextSync:JSON.parse};function VI(){const i="9.2.5",e=globalThis.deck&&globalThis.deck.VERSION;if(e&&e!==i)throw new Error(`deck.gl - multiple versions detected: ${e} vs ${i}`);return e||(ni.log(1,`deck.gl ${i}`)(),globalThis.deck={...globalThis.deck,VERSION:i,version:i,log:ni,_registerLoggers:NI},D3([UI,[BI,{imagebitmap:{premultiplyAlpha:"none"}}]])),i}const jI=VI();function j_(i,e){if(!i)throw new Error(e||"shadertools: assertion failed.")}const Gg={number:{type:"number",validate(i,e){return Number.isFinite(i)&&typeof e=="object"&&(e.max===void 0||i<=e.max)&&(e.min===void 0||i>=e.min)}},array:{type:"array",validate(i,e){return Array.isArray(i)||ArrayBuffer.isView(i)}}};function $I(i){const e={};for(const[t,r]of Object.entries(i))e[t]=WI(r);return e}function WI(i){let e=ib(i);if(e!=="object")return{value:i,...Gg[e],type:e};if(typeof i=="object")return i?i.type!==void 0?{...i,...Gg[i.type],type:i.type}:i.value===void 0?{type:"object",value:i}:(e=ib(i.value),{...i,...Gg[e],type:e}):{type:"object",value:null};throw new Error("props")}function ib(i){return Array.isArray(i)||ArrayBuffer.isView(i)?"array":typeof i}const HI=`#ifdef MODULE_LOGDEPTH
  logdepth_adjustPosition(gl_Position);
#endif
`,qI=`#ifdef MODULE_MATERIAL
  fragColor = material_filterColor(fragColor);
#endif

#ifdef MODULE_LIGHTING
  fragColor = lighting_filterColor(fragColor);
#endif

#ifdef MODULE_FOG
  fragColor = fog_filterColor(fragColor);
#endif

#ifdef MODULE_PICKING
  fragColor = picking_filterHighlightColor(fragColor);
  fragColor = picking_filterPickingColor(fragColor);
#endif

#ifdef MODULE_LOGDEPTH
  logdepth_setFragDepth();
#endif
`,XI={vertex:HI,fragment:qI},rb=/void\s+main\s*\([^)]*\)\s*\{\n?/,sb=/}\n?[^{}]*$/,Kg=[],Pf="__LUMA_INJECT_DECLARATIONS__";function ZI(i){const e={vertex:{},fragment:{}};for(const t in i){let r=i[t];const s=YI(t);typeof r=="string"&&(r={order:0,injection:r}),e[s][t]=r}return e}function YI(i){const e=i.slice(0,2);switch(e){case"vs":return"vertex";case"fs":return"fragment";default:throw new Error(e)}}function Yf(i,e,t,r=!1){const s=e==="vertex";for(const a in t){const u=t[a];u.sort((g,v)=>g.order-v.order),Kg.length=u.length;for(let g=0,v=u.length;g<v;++g)Kg[g]=u[g].injection;const l=`${Kg.join(`
`)}
`;switch(a){case"vs:#decl":s&&(i=i.replace(Pf,l));break;case"vs:#main-start":s&&(i=i.replace(rb,g=>g+l));break;case"vs:#main-end":s&&(i=i.replace(sb,g=>l+g));break;case"fs:#decl":s||(i=i.replace(Pf,l));break;case"fs:#main-start":s||(i=i.replace(rb,g=>g+l));break;case"fs:#main-end":s||(i=i.replace(sb,g=>l+g));break;default:i=i.replace(a,g=>g+l)}}return i=i.replace(Pf,""),r&&(i=i.replace(/\}\s*$/,a=>a+XI[e])),i}function Gf(i){i.map(e=>GI(e))}function GI(i){if(i.instance)return;Gf(i.dependencies||[]);const{propTypes:e={},deprecations:t=[],inject:r={}}=i,s={normalizedInjections:ZI(r),parsedDeprecations:KI(t)};e&&(s.propValidators=$I(e)),i.instance=s;let a={};e&&(a=Object.entries(e).reduce((u,[l,g])=>{const v=g?.value;return v&&(u[l]=v),u},{})),i.defaultUniforms={...i.defaultUniforms,...a}}function T1(i,e,t){i.deprecations?.forEach(r=>{r.regex?.test(e)&&(r.deprecated?t.deprecated(r.old,r.new)():t.removed(r.old,r.new)())})}function KI(i){return i.forEach(e=>{switch(e.type){case"function":e.regex=new RegExp(`\\b${e.old}\\(`);break;default:e.regex=new RegExp(`${e.type} ${e.old};`)}}),i}function $_(i){Gf(i);const e={},t={};S1({modules:i,level:0,moduleMap:e,moduleDepth:t});const r=Object.keys(t).sort((s,a)=>t[a]-t[s]).map(s=>e[s]);return Gf(r),r}function S1(i){const{modules:e,level:t,moduleMap:r,moduleDepth:s}=i;if(t>=5)throw new Error("Possible loop in shader dependency graph");for(const a of e)r[a.name]=a,(s[a.name]===void 0||s[a.name]<t)&&(s[a.name]=t);for(const a of e)a.dependencies&&S1({modules:a.dependencies,level:t+1,moduleMap:r,moduleDepth:s})}function JI(i){switch(i?.gpu.toLowerCase()){case"apple":return`#define APPLE_GPU
// Apple optimizes away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1
// Intel GPU doesn't have full 32 bits precision in same cases, causes overflow
#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1
`;case"nvidia":return`#define NVIDIA_GPU
// Nvidia optimizes away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
`;case"intel":return`#define INTEL_GPU
// Intel optimizes away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
// Intel's built-in 'tan' function doesn't have acceptable precision
#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1
// Intel GPU doesn't have full 32 bits precision in same cases, causes overflow
#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1
`;case"amd":return`#define AMD_GPU
`;default:return`#define DEFAULT_GPU
// Prevent driver from optimizing away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
// Headless Chrome's software shader 'tan' function doesn't have acceptable precision
#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1
// If the GPU doesn't have full 32 bits precision, will causes overflow
#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1
`}}function QI(i,e){if(Number(i.match(/^#version[ \t]+(\d+)/m)?.[1]||100)!==300)throw new Error("luma.gl v9 only supports GLSL 3.00 shader sources");switch(e){case"vertex":return i=nb(i,eC),i;case"fragment":return i=nb(i,tC),i;default:throw new Error(e)}}const A1=[[/^(#version[ \t]+(100|300[ \t]+es))?[ \t]*\n/,`#version 300 es
`],[/\btexture(2D|2DProj|Cube)Lod(EXT)?\(/g,"textureLod("],[/\btexture(2D|2DProj|Cube)(EXT)?\(/g,"texture("]],eC=[...A1,[Xm("attribute"),"in $1"],[Xm("varying"),"out $1"]],tC=[...A1,[Xm("varying"),"in $1"]];function nb(i,e){for(const[t,r]of e)i=i.replace(t,r);return i}function Xm(i){return new RegExp(`\\b${i}[ \\t]+(\\w+[ \\t]+\\w+(\\[\\w+\\])?;)`,"g")}function E1(i,e){let t="";for(const r in i){const s=i[r];if(t+=`void ${s.signature} {
`,s.header&&(t+=`  ${s.header}`),e[r]){const a=e[r];a.sort((u,l)=>u.order-l.order);for(const u of a)t+=`  ${u.injection}
`}s.footer&&(t+=`  ${s.footer}`),t+=`}
`}return t}function I1(i){const e={vertex:{},fragment:{}};for(const t of i){let r,s;typeof t!="string"?(r=t,s=r.hook):(r={},s=t),s=s.trim();const[a,u]=s.split(":"),l=s.replace(/\(.+/,""),g=Object.assign(r,{signature:u});switch(a){case"vs":e.vertex[l]=g;break;case"fs":e.fragment[l]=g;break;default:throw new Error(a)}}return e}function iC(i,e){return{name:rC(i,e),language:"glsl",version:sC(i)}}function rC(i,e="unnamed"){const r=/#define[^\S\r\n]*SHADER_NAME[^\S\r\n]*([A-Za-z0-9_-]+)\s*/.exec(i);return r?r[1]:e}function sC(i){let e=100;const t=i.match(/[^\s]+/g);if(t&&t.length>=2&&t[0]==="#version"){const r=parseInt(t[1],10);Number.isFinite(r)&&(e=r)}if(e!==100&&e!==300)throw new Error(`Invalid GLSL version ${e}`);return e}const C1=`

${Pf}
`,nC=`precision highp float;
`;function oC(i){const e=$_(i.modules||[]);return{source:lC(i.platformInfo,{...i,source:i.source,stage:"vertex",modules:e}),getUniforms:P1(e)}}function aC(i){const{vs:e,fs:t}=i,r=$_(i.modules||[]);return{vs:ob(i.platformInfo,{...i,source:e,stage:"vertex",modules:r}),fs:ob(i.platformInfo,{...i,source:t,stage:"fragment",modules:r}),getUniforms:P1(r)}}function lC(i,e){const{source:t,stage:r,modules:s,hookFunctions:a=[],inject:u={},log:l}=e;j_(typeof t=="string","shader source must be a string");const g=t;let v="";const T=I1(a),S={},P={},O={};for(const W in u){const G=typeof u[W]=="string"?{injection:u[W],order:0}:u[W],Q=/^(v|f)s:(#)?([\w-]+)$/.exec(W);if(Q){const ae=Q[2],te=Q[3];ae?te==="decl"?P[W]=[G]:O[W]=[G]:S[W]=[G]}else O[W]=[G]}const $=s;for(const W of $){l&&T1(W,g,l);const G=M1(W,"wgsl");v+=G;const Q=W.injections?.[r]||{};for(const ae in Q){const te=/^(v|f)s:#([\w-]+)$/.exec(ae);if(te){const we=te[2]==="decl"?P:O;we[ae]=we[ae]||[],we[ae].push(Q[ae])}else S[ae]=S[ae]||[],S[ae].push(Q[ae])}}return v+=C1,v=Yf(v,r,P),v+=E1(T[r],S),v+=g,v=Yf(v,r,O),v}function ob(i,e){const{source:t,stage:r,language:s="glsl",modules:a,defines:u={},hookFunctions:l=[],inject:g={},prologue:v=!0,log:T}=e;j_(typeof t=="string","shader source must be a string");const S=s==="glsl"?iC(t).version:-1,P=i.shaderLanguageVersion,O=S===100?"#version 100":"#version 300 es",W=t.split(`
`).slice(1).join(`
`),G={};a.forEach(Oe=>{Object.assign(G,Oe.defines)}),Object.assign(G,u);let Q="";switch(s){case"wgsl":break;case"glsl":Q=v?`${O}

// ----- PROLOGUE -------------------------
${`#define SHADER_TYPE_${r.toUpperCase()}`}

${JI(i)}
${r==="fragment"?nC:""}

// ----- APPLICATION DEFINES -------------------------

${cC(G)}

`:`${O}
`;break}const ae=I1(l),te={},me={},we={};for(const Oe in g){const Je=typeof g[Oe]=="string"?{injection:g[Oe],order:0}:g[Oe],it=/^(v|f)s:(#)?([\w-]+)$/.exec(Oe);if(it){const He=it[2],ht=it[3];He?ht==="decl"?me[Oe]=[Je]:we[Oe]=[Je]:te[Oe]=[Je]}else we[Oe]=[Je]}for(const Oe of a){T&&T1(Oe,W,T);const Je=M1(Oe,r);Q+=Je;const it=Oe.instance?.normalizedInjections[r]||{};for(const He in it){const ht=/^(v|f)s:#([\w-]+)$/.exec(He);if(ht){const ft=ht[2]==="decl"?me:we;ft[He]=ft[He]||[],ft[He].push(it[He])}else te[He]=te[He]||[],te[He].push(it[He])}}return Q+="// ----- MAIN SHADER SOURCE -------------------------",Q+=C1,Q=Yf(Q,r,me),Q+=E1(ae[r],te),Q+=W,Q=Yf(Q,r,we),s==="glsl"&&S!==P&&(Q=QI(Q,r)),Q.trim()}function P1(i){return function(t){const r={};for(const s of i){const a=s.getUniforms?.(t,r);Object.assign(r,a)}return r}}function cC(i={}){let e="";for(const t in i){const r=i[t];(r||Number.isFinite(r))&&(e+=`#define ${t.toUpperCase()} ${i[t]}
`)}return e}function M1(i,e){let t;switch(e){case"vertex":t=i.vs||"";break;case"fragment":t=i.fs||"";break;case"wgsl":t=i.source||"";break;default:j_(!1)}if(!i.name)throw new Error("Shader module must have a name");const r=i.name.toUpperCase().replace(/[^0-9a-z]/gi,"_");let s=`// ----- MODULE ${i.name} ---------------

`;return e!=="wgsl"&&(s+=`#define MODULE_${r}
`),s+=`${t}
`,s}const uC=/^\s*\#\s*ifdef\s*([a-zA-Z_]+)\s*$/,hC=/^\s*\#\s*endif\s*$/;function dC(i,e){const t=i.split(`
`),r=[];let s=!0,a=null;for(const u of t){const l=u.match(uC),g=u.match(hC);l?(a=l[1],s=!!e?.defines?.[a]):g?s=!0:s&&r.push(u)}return r.join(`
`)}class Fa{static defaultShaderAssembler;_hookFunctions=[];_defaultModules=[];static getDefaultShaderAssembler(){return Fa.defaultShaderAssembler=Fa.defaultShaderAssembler||new Fa,Fa.defaultShaderAssembler}addDefaultModule(e){this._defaultModules.find(t=>t.name===(typeof e=="string"?e:e.name))||this._defaultModules.push(e)}removeDefaultModule(e){const t=typeof e=="string"?e:e.name;this._defaultModules=this._defaultModules.filter(r=>r.name!==t)}addShaderHook(e,t){t&&(e=Object.assign(t,{hook:e})),this._hookFunctions.push(e)}assembleWGSLShader(e){const t=this._getModuleList(e.modules),r=this._hookFunctions,{source:s,getUniforms:a}=oC({...e,source:e.source,modules:t,hookFunctions:r});return{source:e.platformInfo.shaderLanguage==="wgsl"?dC(s):s,getUniforms:a,modules:t}}assembleGLSLShaderPair(e){const t=this._getModuleList(e.modules),r=this._hookFunctions;return{...aC({...e,vs:e.vs,fs:e.fs,modules:t,hookFunctions:r}),modules:t}}_getModuleList(e=[]){const t=new Array(this._defaultModules.length+e.length),r={};let s=0;for(let a=0,u=this._defaultModules.length;a<u;++a){const l=this._defaultModules[a],g=l.name;t[s++]=l,r[g]=!0}for(let a=0,u=e.length;a<u;++a){const l=e[a],g=l.name;r[g]||(t[s++]=l,r[g]=!0)}return t.length=s,Gf(t),t}}const fC=`out vec4 transform_output;
void main() {
  transform_output = vec4(0);
}`,pC=`#version 300 es
${fC}`;function gC(i){const{input:e,inputChannels:t,output:r}={};if(!e)return pC;if(!t)throw new Error("inputChannels");const s=mC(t),a=_C(e,t);return`#version 300 es
in ${s} ${e};
out vec4 ${r};
void main() {
  ${r} = ${a};
}`}function mC(i){switch(i){case 1:return"float";case 2:return"vec2";case 3:return"vec3";case 4:return"vec4";default:throw new Error(`invalid channels: ${i}`)}}function _C(i,e){switch(e){case 1:return`vec4(${i}, 0.0, 0.0, 1.0)`;case 2:return`vec4(${i}, 0.0, 1.0)`;case 3:return`vec4(${i}, 1.0)`;case 4:return i;default:throw new Error(`invalid channels: ${e}`)}}class yC{stats=new Map;getStats(e){return this.get(e)}get(e){return this.stats.has(e)||this.stats.set(e,new zh({id:e})),this.stats.get(e)}}const R1=new yC,Qe=new Nh({id:"luma.gl"}),Jg={};function pp(i="id"){Jg[i]=Jg[i]||1;const e=Jg[i]++;return`${i}-${e}`}let Mi=class{static defaultProps={id:"undefined",handle:void 0,userData:void 0};toString(){return`${this[Symbol.toStringTag]||this.constructor.name}:"${this.id}"`}id;props;userData={};_device;destroyed=!1;allocatedBytes=0;_attachedResources=new Set;constructor(e,t,r){if(!e)throw new Error("no device");this._device=e,this.props=xC(t,r);const s=this.props.id!=="undefined"?this.props.id:pp(this[Symbol.toStringTag]);this.props.id=s,this.id=s,this.userData=this.props.userData||{},this.addStats()}destroy(){this.destroyResource()}delete(){return this.destroy(),this}getProps(){return this.props}attachResource(e){this._attachedResources.add(e)}detachResource(e){this._attachedResources.delete(e)}destroyAttachedResource(e){this._attachedResources.delete(e)&&e.destroy()}destroyAttachedResources(){for(const e of Object.values(this._attachedResources))e.destroy();this._attachedResources=new Set}destroyResource(){this.destroyAttachedResources(),this.removeStats(),this.destroyed=!0}removeStats(){const e=this._device.statsManager.getStats("Resource Counts"),t=this[Symbol.toStringTag];e.get(`${t}s Active`).decrementCount()}trackAllocatedMemory(e,t=this[Symbol.toStringTag]){const r=this._device.statsManager.getStats("Resource Counts");r.get("GPU Memory").addCount(e),r.get(`${t} Memory`).addCount(e),this.allocatedBytes=e}trackDeallocatedMemory(e=this[Symbol.toStringTag]){const t=this._device.statsManager.getStats("Resource Counts");t.get("GPU Memory").subtractCount(this.allocatedBytes),t.get(`${e} Memory`).subtractCount(this.allocatedBytes),this.allocatedBytes=0}addStats(){const e=this._device.statsManager.getStats("Resource Counts"),t=this[Symbol.toStringTag];e.get("Resources Created").incrementCount(),e.get(`${t}s Created`).incrementCount(),e.get(`${t}s Active`).incrementCount()}};function xC(i,e){const t={...e};for(const r in i)i[r]!==void 0&&(t[r]=i[r]);return t}class Oi extends Mi{static INDEX=16;static VERTEX=32;static UNIFORM=64;static STORAGE=128;static INDIRECT=256;static QUERY_RESOLVE=512;static MAP_READ=1;static MAP_WRITE=2;static COPY_SRC=4;static COPY_DST=8;get[Symbol.toStringTag](){return"Buffer"}usage;indexType;updateTimestamp;constructor(e,t){const r={...t};(t.usage||0)&Oi.INDEX&&!t.indexType&&(t.data instanceof Uint32Array?r.indexType="uint32":t.data instanceof Uint16Array&&(r.indexType="uint16")),delete r.data,super(e,r,Oi.defaultProps),this.usage=r.usage||0,this.indexType=r.indexType,this.updateTimestamp=e.incrementTimestamp()}clone(e){return this.device.createBuffer({...this.props,...e})}static DEBUG_DATA_MAX_LENGTH=32;debugData=new ArrayBuffer(0);_setDebugData(e,t,r){const s=ArrayBuffer.isView(e)?e.buffer:e,a=Math.min(e?e.byteLength:r,Oi.DEBUG_DATA_MAX_LENGTH);s===null?this.debugData=new ArrayBuffer(a):t===0&&r===s.byteLength?this.debugData=s.slice(0,a):this.debugData=s.slice(t,t+a)}static defaultProps={...Mi.defaultProps,usage:0,byteLength:0,byteOffset:0,data:null,indexType:"uint16",onMapped:void 0}}function k1(i){const[e,t,r]=q_[i],s=i.includes("norm"),a=!s&&!i.startsWith("float"),u=i.startsWith("s");return{signedType:e,primitiveType:t,byteLength:r,normalized:s,integer:a,signed:u}}function vC(i){const e=i;switch(e){case"uint8":return"unorm8";case"sint8":return"snorm8";case"uint16":return"unorm16";case"sint16":return"snorm16";default:return e}}function bC(i,e){switch(e){case 1:return i;case 2:return i+i%2;default:return i+(4-i%4)%4}}function W_(i){const e=ArrayBuffer.isView(i)?i.constructor:i;if(e===Uint8ClampedArray)return"uint8";const t=Object.values(q_).find(r=>e===r[4]);if(!t)throw new Error(e.name);return t[0]}function H_(i){const[,,,,e]=q_[i];return e}const q_={uint8:["uint8","u32",1,!1,Uint8Array],sint8:["sint8","i32",1,!1,Int8Array],unorm8:["uint8","f32",1,!0,Uint8Array],snorm8:["sint8","f32",1,!0,Int8Array],uint16:["uint16","u32",2,!1,Uint16Array],sint16:["sint16","i32",2,!1,Int16Array],unorm16:["uint16","u32",2,!0,Uint16Array],snorm16:["sint16","i32",2,!0,Int16Array],float16:["float16","f16",2,!1,Uint16Array],float32:["float32","f32",4,!1,Float32Array],uint32:["uint32","u32",4,!1,Uint32Array],sint32:["sint32","i32",4,!1,Int32Array]};function X_(i){let e;i.endsWith("-webgl")&&(i.replace("-webgl",""),e=!0);const[t,r]=i.split("x"),s=t,a=r?parseInt(r):1,u=k1(s),l={type:s,components:a,byteLength:u.byteLength*a,integer:u.integer,signed:u.signed,normalized:u.normalized};return e&&(l.webglOnly=!0),l}function wC(i,e,t){const r=t?vC(i):i;switch(r){case"unorm8":return e===1?"unorm8":e===3?"unorm8x3-webgl":`${r}x${e}`;case"snorm8":case"uint8":case"sint8":case"uint16":case"sint16":case"unorm16":case"snorm16":case"float16":if(e===1||e===3)throw new Error(`size: ${e}`);return`${r}x${e}`;default:return e===1?r:`${r}x${e}`}}function TC(i,e,t){if(!e||e>4)throw new Error(`size ${e}`);const r=e,s=W_(i);return wC(s,r,t)}function SC(i){let e;switch(i.primitiveType){case"f32":e="float32";break;case"i32":e="sint32";break;case"u32":e="uint32";break;case"f16":return i.components<=2?"float16x2":"float16x4"}return i.components===1?e:`${e}x${i.components}`}const jr="texture-compression-bc",Ci="texture-compression-astc",vn="texture-compression-etc2",AC="texture-compression-etc1-webgl",Zd="texture-compression-pvrtc-webgl",Qg="texture-compression-atc-webgl",Yd="float32-renderable-webgl",em="float16-renderable-webgl",EC="rgb9e5ufloat-renderable-webgl",tm="snorm8-renderable-webgl",ju="norm16-renderable-webgl",im="snorm16-renderable-webgl",Gd="float32-filterable",ab="float16-filterable-webgl";function D1(i){const e=PC[i];if(!e)throw new Error(`Unsupported texture format ${i}`);return e}const IC={r8unorm:{},rg8unorm:{},"rgb8unorm-webgl":{},rgba8unorm:{},"rgba8unorm-srgb":{},r8snorm:{render:tm},rg8snorm:{render:tm},"rgb8snorm-webgl":{},rgba8snorm:{render:tm},r8uint:{},rg8uint:{},rgba8uint:{},r8sint:{},rg8sint:{},rgba8sint:{},bgra8unorm:{},"bgra8unorm-srgb":{},r16unorm:{f:ju},rg16unorm:{render:ju},"rgb16unorm-webgl":{f:ju},rgba16unorm:{render:ju},r16snorm:{f:im},rg16snorm:{render:im},"rgb16snorm-webgl":{f:ju},rgba16snorm:{render:im},r16uint:{},rg16uint:{},rgba16uint:{},r16sint:{},rg16sint:{},rgba16sint:{},r16float:{render:em,filter:"float16-filterable-webgl"},rg16float:{render:em,filter:ab},rgba16float:{render:em,filter:ab},r32uint:{},rg32uint:{},rgba32uint:{},r32sint:{},rg32sint:{},rgba32sint:{},r32float:{render:Yd,filter:Gd},rg32float:{render:!1,filter:Gd},"rgb32float-webgl":{render:Yd,filter:Gd},rgba32float:{render:Yd,filter:Gd},"rgba4unorm-webgl":{channels:"rgba",bitsPerChannel:[4,4,4,4],packed:!0},"rgb565unorm-webgl":{channels:"rgb",bitsPerChannel:[5,6,5,0],packed:!0},"rgb5a1unorm-webgl":{channels:"rgba",bitsPerChannel:[5,5,5,1],packed:!0},rgb9e5ufloat:{channels:"rgb",packed:!0,render:EC},rg11b10ufloat:{channels:"rgb",bitsPerChannel:[11,11,10,0],packed:!0,p:1,render:Yd},rgb10a2unorm:{channels:"rgba",bitsPerChannel:[10,10,10,2],packed:!0,p:1},rgb10a2uint:{channels:"rgba",bitsPerChannel:[10,10,10,2],packed:!0,p:1},stencil8:{attachment:"stencil",bitsPerChannel:[8,0,0,0],dataType:"uint8"},depth16unorm:{attachment:"depth",bitsPerChannel:[16,0,0,0],dataType:"uint16"},depth24plus:{attachment:"depth",bitsPerChannel:[24,0,0,0],dataType:"uint32"},depth32float:{attachment:"depth",bitsPerChannel:[32,0,0,0],dataType:"float32"},"depth24plus-stencil8":{attachment:"depth-stencil",bitsPerChannel:[24,8,0,0],packed:!0},"depth32float-stencil8":{attachment:"depth-stencil",bitsPerChannel:[32,8,0,0],packed:!0}},CC={"bc1-rgb-unorm-webgl":{f:jr},"bc1-rgb-unorm-srgb-webgl":{f:jr},"bc1-rgba-unorm":{f:jr},"bc1-rgba-unorm-srgb":{f:jr},"bc2-rgba-unorm":{f:jr},"bc2-rgba-unorm-srgb":{f:jr},"bc3-rgba-unorm":{f:jr},"bc3-rgba-unorm-srgb":{f:jr},"bc4-r-unorm":{f:jr},"bc4-r-snorm":{f:jr},"bc5-rg-unorm":{f:jr},"bc5-rg-snorm":{f:jr},"bc6h-rgb-ufloat":{f:jr},"bc6h-rgb-float":{f:jr},"bc7-rgba-unorm":{f:jr},"bc7-rgba-unorm-srgb":{f:jr},"etc2-rgb8unorm":{f:vn},"etc2-rgb8unorm-srgb":{f:vn},"etc2-rgb8a1unorm":{f:vn},"etc2-rgb8a1unorm-srgb":{f:vn},"etc2-rgba8unorm":{f:vn},"etc2-rgba8unorm-srgb":{f:vn},"eac-r11unorm":{f:vn},"eac-r11snorm":{f:vn},"eac-rg11unorm":{f:vn},"eac-rg11snorm":{f:vn},"astc-4x4-unorm":{f:Ci},"astc-4x4-unorm-srgb":{f:Ci},"astc-5x4-unorm":{f:Ci},"astc-5x4-unorm-srgb":{f:Ci},"astc-5x5-unorm":{f:Ci},"astc-5x5-unorm-srgb":{f:Ci},"astc-6x5-unorm":{f:Ci},"astc-6x5-unorm-srgb":{f:Ci},"astc-6x6-unorm":{f:Ci},"astc-6x6-unorm-srgb":{f:Ci},"astc-8x5-unorm":{f:Ci},"astc-8x5-unorm-srgb":{f:Ci},"astc-8x6-unorm":{f:Ci},"astc-8x6-unorm-srgb":{f:Ci},"astc-8x8-unorm":{f:Ci},"astc-8x8-unorm-srgb":{f:Ci},"astc-10x5-unorm":{f:Ci},"astc-10x5-unorm-srgb":{f:Ci},"astc-10x6-unorm":{f:Ci},"astc-10x6-unorm-srgb":{f:Ci},"astc-10x8-unorm":{f:Ci},"astc-10x8-unorm-srgb":{f:Ci},"astc-10x10-unorm":{f:Ci},"astc-10x10-unorm-srgb":{f:Ci},"astc-12x10-unorm":{f:Ci},"astc-12x10-unorm-srgb":{f:Ci},"astc-12x12-unorm":{f:Ci},"astc-12x12-unorm-srgb":{f:Ci},"pvrtc-rgb4unorm-webgl":{f:Zd},"pvrtc-rgba4unorm-webgl":{f:Zd},"pvrtc-rbg2unorm-webgl":{f:Zd},"pvrtc-rgba2unorm-webgl":{f:Zd},"etc1-rbg-unorm-webgl":{f:AC},"atc-rgb-unorm-webgl":{f:Qg},"atc-rgba-unorm-webgl":{f:Qg},"atc-rgbai-unorm-webgl":{f:Qg}},PC={...IC,...CC},MC=["bc1","bc2","bc3","bc4","bc5","bc6","bc7","etc1","etc2","eac","atc","astc","pvrtc"],RC=/^(r|rg|rgb|rgba|bgra)([0-9]*)([a-z]*)(-srgb)?(-webgl)?$/;class kC{getInfo(e){return lb(e)}isColor(e){return e.startsWith("rgba")||e.startsWith("bgra")||e.startsWith("rgb")}isDepthStencil(e){return e.startsWith("depth")||e.startsWith("stencil")}isCompressed(e){return MC.some(t=>e.startsWith(t))}getCapabilities(e){const t=D1(e),r={format:e,create:t.f??!0,render:t.render??!0,filter:t.filter??!0,blend:t.blend??!0,store:t.store??!0},s=lb(e),a=e.startsWith("depth")||e.startsWith("stencil"),u=s?.signed,l=s?.integer,g=s?.webgl;return r.render&&=!u,r.filter&&=!a&&!u&&!l&&!g,r}}const mc=new kC;function lb(i){let e=DC(i);if(mc.isCompressed(i)){e.channels="rgb",e.components=3,e.bytesPerPixel=1,e.srgb=!1,e.compressed=!0;const r=OC(i);r&&(e.blockWidth=r.blockWidth,e.blockHeight=r.blockHeight)}const t=RC.exec(i);if(t){const[,r,s,a,u,l]=t,g=`${a}${s}`,v=k1(g),T=v.byteLength*8,S=r.length,P=[T,S>=2?T:0,S>=3?T:0,S>=4?T:0];e={format:i,attachment:e.attachment,dataType:v.signedType,components:S,channels:r,integer:v.integer,signed:v.signed,normalized:v.normalized,bitsPerChannel:P,bytesPerPixel:v.byteLength*r.length,packed:e.packed,srgb:e.srgb},l==="-webgl"&&(e.webgl=!0),u==="-srgb"&&(e.srgb=!0)}return i.endsWith("-webgl")&&(e.webgl=!0),i.endsWith("-srgb")&&(e.srgb=!0),e}function DC(i){const e=D1(i),t=e.bytesPerPixel||1,r=e.bitsPerChannel||[8,8,8,8];return delete e.bitsPerChannel,delete e.bytesPerPixel,delete e.f,delete e.render,delete e.filter,delete e.blend,delete e.store,{...e,format:i,attachment:e.attachment||"color",channels:e.channels||"r",components:e.components||e.channels?.length||1,bytesPerPixel:t,bitsPerChannel:r,dataType:e.dataType||"uint8",srgb:e.srgb??!1,packed:e.packed??!1,webgl:e.webgl??!1,integer:e.integer??!1,signed:e.signed??!1,normalized:e.normalized??!1,compressed:e.compressed??!1}}function OC(i){const t=/.*-(\d+)x(\d+)-.*/.exec(i);if(t){const[,r,s]=t;return{blockWidth:Number(r),blockHeight:Number(s)}}return null}function LC(i){return typeof ImageData<"u"&&i instanceof ImageData||typeof ImageBitmap<"u"&&i instanceof ImageBitmap||typeof HTMLImageElement<"u"&&i instanceof HTMLImageElement||typeof HTMLVideoElement<"u"&&i instanceof HTMLVideoElement||typeof VideoFrame<"u"&&i instanceof VideoFrame||typeof HTMLCanvasElement<"u"&&i instanceof HTMLCanvasElement||typeof OffscreenCanvas<"u"&&i instanceof OffscreenCanvas}function FC(i){if(typeof ImageData<"u"&&i instanceof ImageData||typeof ImageBitmap<"u"&&i instanceof ImageBitmap||typeof HTMLCanvasElement<"u"&&i instanceof HTMLCanvasElement||typeof OffscreenCanvas<"u"&&i instanceof OffscreenCanvas)return{width:i.width,height:i.height};if(typeof HTMLImageElement<"u"&&i instanceof HTMLImageElement)return{width:i.naturalWidth,height:i.naturalHeight};if(typeof HTMLVideoElement<"u"&&i instanceof HTMLVideoElement)return{width:i.videoWidth,height:i.videoHeight};if(typeof VideoFrame<"u"&&i instanceof VideoFrame)return{width:i.displayWidth,height:i.displayHeight};throw new Error("Unknown image type")}class BC{}class NC{features;disabledFeatures;constructor(e=[],t){this.features=new Set(e),this.disabledFeatures=t||{}}*[Symbol.iterator](){yield*this.features}has(e){return!this.disabledFeatures?.[e]&&this.features.has(e)}}class qa{static defaultProps={id:null,powerPreference:"high-performance",failIfMajorPerformanceCaveat:!1,createCanvasContext:void 0,webgl:{},onError:(e,t)=>{},onResize:(e,t)=>{const[r,s]=e.getDevicePixelSize();Qe.log(1,`${e} resized => ${r}x${s}px`)()},onPositionChange:(e,t)=>{const[r,s]=e.getPosition();Qe.log(1,`${e} repositioned => ${r},${s}`)()},onVisibilityChange:e=>Qe.log(1,`${e} Visibility changed ${e.isVisible}`)(),onDevicePixelRatioChange:(e,t)=>Qe.log(1,`${e} DPR changed ${t.oldRatio} => ${e.devicePixelRatio}`)(),debug:Qe.get("debug")||void 0,debugShaders:Qe.get("debug-shaders")||void 0,debugFramebuffers:!!Qe.get("debug-framebuffers"),debugFactories:!!Qe.get("debug-factories"),debugWebGL:!!Qe.get("debug-webgl"),debugSpectorJS:void 0,debugSpectorJSUrl:void 0,_reuseDevices:!1,_requestMaxLimits:!0,_cacheShaders:!1,_cachePipelines:!1,_cacheDestroyPolicy:"unused",_initializeFeatures:!0,_disabledFeatures:{"compilation-status-async-webgl":!0},_handle:void 0};get[Symbol.toStringTag](){return"Device"}toString(){return`Device(${this.id})`}id;props;userData={};statsManager=R1;timestamp=0;_reused=!1;_lumaData={};_textureCaps={};constructor(e){this.props={...qa.defaultProps,...e},this.id=this.props.id||pp(this[Symbol.toStringTag].toLowerCase())}getVertexFormatInfo(e){return X_(e)}isVertexFormatSupported(e){return!0}getTextureFormatInfo(e){return mc.getInfo(e)}getTextureFormatCapabilities(e){let t=this._textureCaps[e];if(!t){const r=this._getDeviceTextureFormatCapabilities(e);t=this._getDeviceSpecificTextureFormatCapabilities(r),this._textureCaps[e]=t}return t}getMipLevelCount(e,t,r=1){const s=Math.max(e,t,r);return 1+Math.floor(Math.log2(s))}isExternalImage(e){return LC(e)}getExternalImageSize(e){return FC(e)}isTextureFormatSupported(e){return this.getTextureFormatCapabilities(e).create}isTextureFormatFilterable(e){return this.getTextureFormatCapabilities(e).filter}isTextureFormatRenderable(e){return this.getTextureFormatCapabilities(e).render}isTextureFormatCompressed(e){return mc.isCompressed(e)}pushDebugGroup(e){this.commandEncoder.pushDebugGroup(e)}popDebugGroup(){this.commandEncoder?.popDebugGroup()}insertDebugMarker(e){this.commandEncoder?.insertDebugMarker(e)}loseDevice(){return!1}incrementTimestamp(){return this.timestamp++}reportError(e,t,...r){return this.props.onError(e,t)?()=>{}:Qe.error(e.message,t,...r)}debug(){if(this.props.debug)debugger;else Qe.once(0,`'Type luma.log.set({debug: true}) in console to enable debug breakpoints',
or create a device with the 'debug: true' prop.`)()}getDefaultCanvasContext(){if(!this.canvasContext)throw new Error("Device has no default CanvasContext. See props.createCanvasContext");return this.canvasContext}beginRenderPass(e){return this.commandEncoder.beginRenderPass(e)}beginComputePass(e){return this.commandEncoder.beginComputePass(e)}getCanvasContext(){return this.getDefaultCanvasContext()}readPixelsToArrayWebGL(e,t){throw new Error("not implemented")}readPixelsToBufferWebGL(e,t){throw new Error("not implemented")}setParametersWebGL(e){throw new Error("not implemented")}getParametersWebGL(e){throw new Error("not implemented")}withParametersWebGL(e,t){throw new Error("not implemented")}clearWebGL(e){throw new Error("not implemented")}resetWebGL(){throw new Error("not implemented")}static _getCanvasContextProps(e){return e.createCanvasContext===!0?{}:e.createCanvasContext}_getDeviceTextureFormatCapabilities(e){const t=mc.getCapabilities(e),r=a=>(typeof a=="string"?this.features.has(a):a)??!0,s=r(t.create);return{format:e,create:s,render:s&&r(t.render),filter:s&&r(t.filter),blend:s&&r(t.blend),store:s&&r(t.store)}}_normalizeBufferProps(e){(e instanceof ArrayBuffer||ArrayBuffer.isView(e))&&(e={data:e});const t={...e};if((e.usage||0)&Oi.INDEX&&(e.indexType||(e.data instanceof Uint32Array?t.indexType="uint32":e.data instanceof Uint16Array&&(t.indexType="uint16")),!t.indexType))throw new Error("indices buffer content must be of type uint16 or uint32");return t}}const zC="set luma.log.level=1 (or higher) to trace rendering",cb="No matching device found. Ensure `@luma.gl/webgl` and/or `@luma.gl/webgpu` modules are imported.";class Kf{static defaultProps={...qa.defaultProps,type:"best-available",adapters:void 0,waitForPageLoad:!0};stats=R1;log=Qe;VERSION="9.2.5";spector;preregisteredAdapters=new Map;constructor(){if(globalThis.luma){if(globalThis.luma.VERSION!==this.VERSION)throw Qe.error(`Found luma.gl ${globalThis.luma.VERSION} while initialzing ${this.VERSION}`)(),Qe.error("'yarn why @luma.gl/core' can help identify the source of the conflict")(),new Error("luma.gl - multiple versions detected: see console log");Qe.error("This version of luma.gl has already been initialized")()}Qe.log(1,`${this.VERSION} - ${zC}`)(),globalThis.luma=this}async createDevice(e={}){const t={...Kf.defaultProps,...e},r=this.selectAdapter(t.type,t.adapters);if(!r)throw new Error(cb);return t.waitForPageLoad&&await r.pageLoaded,await r.create(t)}async attachDevice(e,t){const r=this._getTypeFromHandle(e,t.adapters),s=r&&this.selectAdapter(r,t.adapters);if(!s)throw new Error(cb);return await s?.attach?.(e,t)}registerAdapters(e){for(const t of e)this.preregisteredAdapters.set(t.type,t)}getSupportedAdapters(e=[]){const t=this._getAdapterMap(e);return Array.from(t).map(([,r])=>r).filter(r=>r.isSupported?.()).map(r=>r.type)}getBestAvailableAdapterType(e=[]){const t=["webgpu","webgl","null"],r=this._getAdapterMap(e);for(const s of t)if(r.get(s)?.isSupported?.())return s;return null}selectAdapter(e,t=[]){let r=e;e==="best-available"&&(r=this.getBestAvailableAdapterType(t));const s=this._getAdapterMap(t);return r&&s.get(r)||null}enforceWebGL2(e=!0,t=[]){const s=this._getAdapterMap(t).get("webgl");s||Qe.warn("enforceWebGL2: webgl adapter not found")(),s?.enforceWebGL2?.(e)}setDefaultDeviceProps(e){Object.assign(Kf.defaultProps,e)}_getAdapterMap(e=[]){const t=new Map(this.preregisteredAdapters);for(const r of e)t.set(r.type,r);return t}_getTypeFromHandle(e,t=[]){return e instanceof WebGL2RenderingContext?"webgl":typeof GPUDevice<"u"&&e instanceof GPUDevice||e?.queue?"webgpu":e===null?"null":(e instanceof WebGLRenderingContext?Qe.warn("WebGL1 is not supported",e)():Qe.warn("Unknown handle type",e)(),null)}}const Zm=new Kf;class UC{get pageLoaded(){return $C()}}const VC=Ja()&&typeof document<"u",jC=()=>VC&&document.readyState==="complete";let Kd=null;function $C(){return Kd||(jC()||typeof window>"u"?Kd=Promise.resolve():Kd=new Promise(i=>window.addEventListener("load",()=>i()))),Kd}function WC(){let i,e;return{promise:new Promise((r,s)=>{i=r,e=s}),resolve:i,reject:e}}class Ba{static isHTMLCanvas(e){return typeof HTMLCanvasElement<"u"&&e instanceof HTMLCanvasElement}static isOffscreenCanvas(e){return typeof OffscreenCanvas<"u"&&e instanceof OffscreenCanvas}static defaultProps={id:void 0,canvas:null,width:800,height:600,useDevicePixels:!0,autoResize:!0,container:null,visible:!0,alphaMode:"opaque",colorSpace:"srgb",trackPosition:!1};id;props;canvas;htmlCanvas;offscreenCanvas;type;initialized;isInitialized=!1;isVisible=!0;cssWidth;cssHeight;devicePixelRatio;devicePixelWidth;devicePixelHeight;drawingBufferWidth;drawingBufferHeight;_initializedResolvers=WC();_resizeObserver;_intersectionObserver;_position;destroyed=!1;toString(){return`${this[Symbol.toStringTag]}(${this.id})`}constructor(e){if(this.props={...Ba.defaultProps,...e},e=this.props,this.initialized=this._initializedResolvers.promise,Ja()?e.canvas?typeof e.canvas=="string"?this.canvas=qC(e.canvas):this.canvas=e.canvas:this.canvas=XC(e):this.canvas={width:e.width||1,height:e.height||1},Ba.isHTMLCanvas(this.canvas)?(this.id=e.id||this.canvas.id,this.type="html-canvas",this.htmlCanvas=this.canvas):Ba.isOffscreenCanvas(this.canvas)?(this.id=e.id||"offscreen-canvas",this.type="offscreen-canvas",this.offscreenCanvas=this.canvas):(this.id=e.id||"node-canvas-context",this.type="node"),this.cssWidth=this.htmlCanvas?.clientWidth||this.canvas.width,this.cssHeight=this.htmlCanvas?.clientHeight||this.canvas.height,this.devicePixelWidth=this.canvas.width,this.devicePixelHeight=this.canvas.height,this.drawingBufferWidth=this.canvas.width,this.drawingBufferHeight=this.canvas.height,this.devicePixelRatio=globalThis.devicePixelRatio||1,this._position=[0,0],Ba.isHTMLCanvas(this.canvas)){this._intersectionObserver=new IntersectionObserver(t=>this._handleIntersection(t)),this._intersectionObserver.observe(this.canvas),this._resizeObserver=new ResizeObserver(t=>this._handleResize(t));try{this._resizeObserver.observe(this.canvas,{box:"device-pixel-content-box"})}catch{this._resizeObserver.observe(this.canvas,{box:"content-box"})}setTimeout(()=>this._observeDevicePixelRatio(),0),this.props.trackPosition&&this._trackPosition()}}destroy(){this.destroyed=!0}setProps(e){return"useDevicePixels"in e&&(this.props.useDevicePixels=e.useDevicePixels||!1,this._updateDrawingBufferSize()),this}getCSSSize(){return[this.cssWidth,this.cssHeight]}getPosition(){return this._position}getDevicePixelSize(){return[this.devicePixelWidth,this.devicePixelHeight]}getDrawingBufferSize(){return[this.drawingBufferWidth,this.drawingBufferHeight]}getMaxDrawingBufferSize(){const e=this.device.limits.maxTextureDimension2D;return[e,e]}setDrawingBufferSize(e,t){this.canvas.width=e,this.canvas.height=t,this.drawingBufferWidth=e,this.drawingBufferHeight=t}getDevicePixelRatio(){return typeof window<"u"&&window.devicePixelRatio||1}cssToDevicePixels(e,t=!0){const r=this.cssToDeviceRatio(),[s,a]=this.getDrawingBufferSize();return ZC(e,r,s,a,t)}getPixelSize(){return this.getDevicePixelSize()}getAspect(){const[e,t]=this.getDevicePixelSize();return e/t}cssToDeviceRatio(){try{const[e]=this.getDrawingBufferSize(),[t]=this.getCSSSize();return t?e/t:1}catch{return 1}}resize(e){this.setDrawingBufferSize(e.width,e.height)}_setAutoCreatedCanvasId(e){this.htmlCanvas?.id==="lumagl-auto-created-canvas"&&(this.htmlCanvas.id=e)}_handleIntersection(e){const t=e.find(s=>s.target===this.canvas);if(!t)return;const r=t.isIntersecting;this.isVisible!==r&&(this.isVisible=r,this.device.props.onVisibilityChange(this))}_handleResize(e){const t=e.find(g=>g.target===this.canvas);if(!t)return;this.cssWidth=t.contentBoxSize[0].inlineSize,this.cssHeight=t.contentBoxSize[0].blockSize;const r=this.getDevicePixelSize(),s=t.devicePixelContentBoxSize?.[0].inlineSize||t.contentBoxSize[0].inlineSize*devicePixelRatio,a=t.devicePixelContentBoxSize?.[0].blockSize||t.contentBoxSize[0].blockSize*devicePixelRatio,[u,l]=this.getMaxDrawingBufferSize();this.devicePixelWidth=Math.max(1,Math.min(s,u)),this.devicePixelHeight=Math.max(1,Math.min(a,l)),this._updateDrawingBufferSize(),this.device.props.onResize(this,{oldPixelSize:r})}_updateDrawingBufferSize(){if(this.props.autoResize){if(typeof this.props.useDevicePixels=="number"){const e=this.props.useDevicePixels;this.setDrawingBufferSize(this.cssWidth*e,this.cssHeight*e)}else this.props.useDevicePixels?this.setDrawingBufferSize(this.devicePixelWidth,this.devicePixelHeight):this.setDrawingBufferSize(this.cssWidth,this.cssHeight);this._updateDevice()}this._initializedResolvers.resolve(),this.isInitialized=!0,this.updatePosition()}_observeDevicePixelRatio(){const e=this.devicePixelRatio;this.devicePixelRatio=window.devicePixelRatio,this.updatePosition(),this.device.props.onDevicePixelRatioChange(this,{oldRatio:e}),matchMedia(`(resolution: ${this.devicePixelRatio}dppx)`).addEventListener("change",()=>this._observeDevicePixelRatio(),{once:!0})}_trackPosition(e=100){const t=setInterval(()=>{this.destroyed?clearInterval(t):this.updatePosition()},e)}updatePosition(){const e=this.htmlCanvas?.getBoundingClientRect();if(e){const t=[e.left,e.top];if(this._position??=t,t[0]!==this._position[0]||t[1]!==this._position[1]){const s=this._position;this._position=t,this.device.props.onPositionChange?.(this,{oldPosition:s})}}}}function HC(i){if(typeof i=="string"){const e=document.getElementById(i);if(!e)throw new Error(`${i} is not an HTML element`);return e}return i||document.body}function qC(i){const e=document.getElementById(i);if(!Ba.isHTMLCanvas(e))throw new Error("Object is not a canvas element");return e}function XC(i){const{width:e,height:t}=i,r=document.createElement("canvas");r.id=pp("lumagl-auto-created-canvas"),r.width=e||1,r.height=t||1,r.style.width=Number.isFinite(e)?`${e}px`:"100%",r.style.height=Number.isFinite(t)?`${t}px`:"100%",i?.visible||(r.style.visibility="hidden");const s=HC(i?.container||null);return s.insertBefore(r,s.firstChild),r}function ZC(i,e,t,r,s){const a=i,u=ub(a[0],e,t);let l=hb(a[1],e,r,s),g=ub(a[0]+1,e,t);const v=g===t-1?g:g-1;g=hb(a[1]+1,e,r,s);let T;return s?(g=g===0?g:g+1,T=l,l=g):T=g===r-1?g:g-1,{x:u,y:l,width:Math.max(v-u+1,1),height:Math.max(T-l+1,1)}}function ub(i,e,t){return Math.min(Math.round(i*e),t-1)}function hb(i,e,t,r){return r?Math.max(0,t-1-Math.round(i*e)):Math.min(Math.round(i*e),t-1)}class Xa extends Mi{static defaultProps={...Mi.defaultProps,type:"color-sampler",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge",addressModeW:"clamp-to-edge",magFilter:"nearest",minFilter:"nearest",mipmapFilter:"none",lodMinClamp:0,lodMaxClamp:32,compare:"less-equal",maxAnisotropy:1};get[Symbol.toStringTag](){return"Sampler"}constructor(e,t){t=Xa.normalizeProps(e,t),super(e,t,Xa.defaultProps)}static normalizeProps(e,t){return t}}const YC={"1d":"1d","2d":"2d","2d-array":"2d",cube:"2d","cube-array":"2d","3d":"3d"};class fr extends Mi{static SAMPLE=4;static STORAGE=8;static RENDER=16;static COPY_SRC=1;static COPY_DST=2;static TEXTURE=4;static RENDER_ATTACHMENT=16;dimension;baseDimension;format;width;height;depth;mipLevels;updateTimestamp;get[Symbol.toStringTag](){return"Texture"}toString(){return`Texture(${this.id},${this.format},${this.width}x${this.height})`}constructor(e,t){if(t=fr.normalizeProps(e,t),super(e,t,fr.defaultProps),this.dimension=this.props.dimension,this.baseDimension=YC[this.dimension],this.format=this.props.format,this.width=this.props.width,this.height=this.props.height,this.depth=this.props.depth,this.mipLevels=this.props.mipLevels,this.props.width===void 0||this.props.height===void 0)if(e.isExternalImage(t.data)){const r=e.getExternalImageSize(t.data);this.width=r?.width||1,this.height=r?.height||1}else this.width=1,this.height=1,(this.props.width===void 0||this.props.height===void 0)&&Qe.warn(`${this} created with undefined width or height. This is deprecated. Use AsyncTexture instead.`)();this.updateTimestamp=e.incrementTimestamp()}setSampler(e){this.sampler=e instanceof Xa?e:this.device.createSampler(e)}clone(e){return this.device.createTexture({...this.props,...e})}static normalizeProps(e,t){const r={...t},{width:s,height:a}=r;return typeof s=="number"&&(r.width=Math.max(1,Math.ceil(s))),typeof a=="number"&&(r.height=Math.max(1,Math.ceil(a))),r}_initializeData(e){this.device.isExternalImage(e)?this.copyExternalImage({image:e,width:this.width,height:this.height,depth:this.depth,mipLevel:0,x:0,y:0,z:0,aspect:"all",colorSpace:"srgb",premultipliedAlpha:!1,flipY:!1}):e&&this.copyImageData({data:e,mipLevel:0,x:0,y:0,z:0,aspect:"all"})}_normalizeCopyImageDataOptions(e){const{width:t,height:r,depth:s}=this,a={...fr.defaultCopyDataOptions,width:t,height:r,depth:s,...e},u=this.device.getTextureFormatInfo(this.format);if(!e.bytesPerRow&&!u.bytesPerPixel)throw new Error(`bytesPerRow must be provided for texture format ${this.format}`);return a.bytesPerRow=e.bytesPerRow||t*(u.bytesPerPixel||4),a.rowsPerImage=e.rowsPerImage||r,a}_normalizeCopyExternalImageOptions(e){const t=this.device.getExternalImageSize(e.image),r={...fr.defaultCopyExternalImageOptions,...t,...e};return r.width=Math.min(r.width,this.width-r.x),r.height=Math.min(r.height,this.height-r.y),r}static defaultProps={...Mi.defaultProps,data:null,dimension:"2d",format:"rgba8unorm",usage:fr.TEXTURE|fr.RENDER_ATTACHMENT|fr.COPY_DST,width:void 0,height:void 0,depth:1,mipLevels:1,samples:void 0,sampler:{},view:void 0};static defaultCopyDataOptions={data:void 0,byteOffset:0,bytesPerRow:void 0,rowsPerImage:void 0,mipLevel:0,x:0,y:0,z:0,aspect:"all"};static defaultCopyExternalImageOptions={image:void 0,sourceX:0,sourceY:0,width:void 0,height:void 0,depth:1,mipLevel:0,x:0,y:0,z:0,aspect:"all",colorSpace:"srgb",premultipliedAlpha:!1,flipY:!1}}class gp extends Mi{get[Symbol.toStringTag](){return"TextureView"}constructor(e,t){super(e,t,gp.defaultProps)}static defaultProps={...Mi.defaultProps,format:void 0,dimension:void 0,aspect:"all",baseMipLevel:0,mipLevelCount:void 0,baseArrayLayer:0,arrayLayerCount:void 0}}function GC(i,e,t){let r="";const s=e.split(/\r?\n/),a=i.slice().sort((u,l)=>u.lineNum-l.lineNum);switch(t?.showSourceCode||"no"){case"all":let u=0;for(let l=1;l<=s.length;l++)for(r+=O1(s[l-1],l,t);a.length>u&&a[u].lineNum===l;){const g=a[u++];r+=rm(g,s,g.lineNum,{...t,inlineSource:!1})}for(;a.length>u;){const l=a[u++];r+=rm(l,[],0,{...t,inlineSource:!1})}return r;case"issues":case"no":for(const l of i)r+=rm(l,s,l.lineNum,{inlineSource:t?.showSourceCode!=="no"});return r}}function rm(i,e,t,r){if(r?.inlineSource){const a=KC(e,t),u=i.linePos>0?`${" ".repeat(i.linePos+5)}^^^
`:"";return`
${a}${u}${i.type.toUpperCase()}: ${i.message}

`}const s=i.type==="error"?"red":"#8B4000";return r?.html?`<div class='luma-compiler-log-error' style="color:${s};"><b> ${i.type.toUpperCase()}: ${i.message}</b></div>`:`${i.type.toUpperCase()}: ${i.message}`}function KC(i,e,t){let r="";for(let s=e-2;s<=e;s++){const a=i[s-1];a!==void 0&&(r+=O1(a,e,t))}return r}function O1(i,e,t){const r=t?.html?QC(i):i;return`${JC(String(e),4)}: ${r}${t?.html?"<br/>":`
`}`}function JC(i,e){let t="";for(let r=i.length;r<e;++r)t+=" ";return t+i}function QC(i){return i.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}class mp extends Mi{get[Symbol.toStringTag](){return"Shader"}stage;source;compilationStatus="pending";constructor(e,t){t={...t,debugShaders:t.debugShaders||e.props.debugShaders||"errors"},super(e,{id:eP(t),...t},mp.defaultProps),this.stage=this.props.stage,this.source=this.props.source}getCompilationInfoSync(){return null}getTranslatedSource(){return null}async debugShader(){const e=this.props.debugShaders;switch(e){case"never":return;case"errors":if(this.compilationStatus==="success")return;break}const t=await this.getCompilationInfo();e==="warnings"&&t?.length===0||this._displayShaderLog(t,this.id)}_displayShaderLog(e,t){if(typeof document>"u"||!document?.createElement)return;const r=t,s=`${this.stage} shader "${r}"`;let a=GC(e,this.source,{showSourceCode:"all",html:!0});const u=this.getTranslatedSource();u&&(a+=`<br /><br /><h1>Translated Source</h1><br /><br /><code style="user-select:text;"><pre>${u}</pre></code>`);const l=document.createElement("Button");l.innerHTML=`
<h1>Compilation error in ${s}</h1><br /><br />
<code style="user-select:text;"><pre>
${a}
</pre></code>`,l.style.top="10px",l.style.left="10px",l.style.position="absolute",l.style.zIndex="9999",l.style.width="100%",l.style.textAlign="left",document.body.appendChild(l),document.getElementsByClassName("luma-compiler-log-error")[0]?.scrollIntoView(),l.onclick=()=>{const v=`data:text/plain,${encodeURIComponent(this.source)}`;navigator.clipboard.writeText(v)}}static defaultProps={...Mi.defaultProps,language:"auto",stage:void 0,source:"",sourceMap:null,entryPoint:"main",debugShaders:void 0}}function eP(i){return tP(i.source)||i.id||pp(`unnamed ${i.stage}-shader`)}function tP(i,e="unnamed"){const r=/#define[\s*]SHADER_NAME[\s*]([A-Za-z0-9_-]+)[\s*]/.exec(i);return r?r[1]:e}class _p extends Mi{get[Symbol.toStringTag](){return"Framebuffer"}width;height;constructor(e,t={}){super(e,t,_p.defaultProps),this.width=this.props.width,this.height=this.props.height}clone(e){const t=this.colorAttachments.map(s=>s.texture.clone(e)),r=this.depthStencilAttachment&&this.depthStencilAttachment.texture.clone(e);return this.device.createFramebuffer({...this.props,colorAttachments:t,depthStencilAttachment:r})}resize(e){let t=!e;if(e){const[r,s]=Array.isArray(e)?e:[e.width,e.height];t=t||s!==this.height||r!==this.width,this.width=r,this.height=s}t&&(Qe.log(2,`Resizing framebuffer ${this.id} to ${this.width}x${this.height}`)(),this.resizeAttachments(this.width,this.height))}autoCreateAttachmentTextures(){if(this.props.colorAttachments.length===0&&!this.props.depthStencilAttachment)throw new Error("Framebuffer has noattachments");this.colorAttachments=this.props.colorAttachments.map((t,r)=>{if(typeof t=="string"){const s=this.createColorTexture(t,r);return this.attachResource(s),s.view}return t instanceof fr?t.view:t});const e=this.props.depthStencilAttachment;if(e)if(typeof e=="string"){const t=this.createDepthStencilTexture(e);this.attachResource(t),this.depthStencilAttachment=t.view}else e instanceof fr?this.depthStencilAttachment=e.view:this.depthStencilAttachment=e}createColorTexture(e,t){return this.device.createTexture({id:`${this.id}-color-attachment-${t}`,usage:fr.RENDER_ATTACHMENT,format:e,width:this.width,height:this.height,sampler:{magFilter:"linear",minFilter:"linear"}})}createDepthStencilTexture(e){return this.device.createTexture({id:`${this.id}-depth-stencil-attachment`,usage:fr.RENDER_ATTACHMENT,format:e,width:this.width,height:this.height})}resizeAttachments(e,t){for(let r=0;r<this.colorAttachments.length;++r)if(this.colorAttachments[r]){const s=this.colorAttachments[r].texture.clone({width:e,height:t});this.destroyAttachedResource(this.colorAttachments[r]),this.colorAttachments[r]=s.view,this.attachResource(s.view)}if(this.depthStencilAttachment){const r=this.depthStencilAttachment.texture.clone({width:e,height:t});this.destroyAttachedResource(this.depthStencilAttachment),this.depthStencilAttachment=r.view,this.attachResource(r)}this.updateAttachments()}static defaultProps={...Mi.defaultProps,width:1,height:1,colorAttachments:[],depthStencilAttachment:null}}class Va extends Mi{get[Symbol.toStringTag](){return"RenderPipeline"}shaderLayout;bufferLayout;linkStatus="pending";hash="";constructor(e,t){super(e,t,Va.defaultProps),this.shaderLayout=this.props.shaderLayout,this.bufferLayout=this.props.bufferLayout||[]}static defaultProps={...Mi.defaultProps,vs:null,vertexEntryPoint:"vertexMain",vsConstants:{},fs:null,fragmentEntryPoint:"fragmentMain",fsConstants:{},shaderLayout:null,bufferLayout:[],topology:"triangle-list",colorAttachmentFormats:void 0,depthStencilAttachmentFormat:void 0,parameters:{},bindings:{},uniforms:{}}}class La extends Mi{static defaultClearColor=[0,0,0,1];static defaultClearDepth=1;static defaultClearStencil=0;get[Symbol.toStringTag](){return"RenderPass"}constructor(e,t){t=La.normalizeProps(e,t),super(e,t,La.defaultProps)}static normalizeProps(e,t){return t}static defaultProps={...Mi.defaultProps,framebuffer:null,parameters:void 0,clearColor:La.defaultClearColor,clearColors:void 0,clearDepth:La.defaultClearDepth,clearStencil:La.defaultClearStencil,depthReadOnly:!1,stencilReadOnly:!1,discard:!1,occlusionQuerySet:void 0,timestampQuerySet:void 0,beginTimestampIndex:void 0,endTimestampIndex:void 0}}class Jf extends Mi{get[Symbol.toStringTag](){return"ComputePipeline"}hash="";shaderLayout;constructor(e,t){super(e,t,Jf.defaultProps),this.shaderLayout=t.shaderLayout}static defaultProps={...Mi.defaultProps,shader:void 0,entryPoint:void 0,constants:{},shaderLayout:void 0}}class Z_ extends Mi{get[Symbol.toStringTag](){return"CommandEncoder"}constructor(e,t){super(e,t,Z_.defaultProps)}static defaultProps={...Mi.defaultProps,measureExecutionTime:void 0}}class Y_ extends Mi{get[Symbol.toStringTag](){return"CommandBuffer"}constructor(e,t){super(e,t,Y_.defaultProps)}static defaultProps={...Mi.defaultProps}}function L1(i){return nP[i]}function iP(i){const[e,t]=sP[i],r=e==="i32"||e==="u32",s=e!=="u32",a=rP[e]*t;return{primitiveType:e,components:t,byteLength:a,integer:r,signed:s}}const rP={f32:4,f16:2,i32:4,u32:4},sP={f32:["f32",1],"vec2<f32>":["f32",2],"vec3<f32>":["f32",3],"vec4<f32>":["f32",4],f16:["f16",1],"vec2<f16>":["f16",2],"vec3<f16>":["f16",3],"vec4<f16>":["f16",4],i32:["i32",1],"vec2<i32>":["i32",2],"vec3<i32>":["i32",3],"vec4<i32>":["i32",4],u32:["u32",1],"vec2<u32>":["u32",2],"vec3<u32>":["u32",3],"vec4<u32>":["u32",4]},nP={f32:{type:"f32",components:1},f16:{type:"f16",components:1},i32:{type:"i32",components:1},u32:{type:"u32",components:1},"vec2<f32>":{type:"f32",components:2},"vec3<f32>":{type:"f32",components:3},"vec4<f32>":{type:"f32",components:4},"vec2<f16>":{type:"f16",components:2},"vec3<f16>":{type:"f16",components:3},"vec4<f16>":{type:"f16",components:4},"vec2<i32>":{type:"i32",components:2},"vec3<i32>":{type:"i32",components:3},"vec4<i32>":{type:"i32",components:4},"vec2<u32>":{type:"u32",components:2},"vec3<u32>":{type:"u32",components:3},"vec4<u32>":{type:"u32",components:4},"mat2x2<f32>":{type:"f32",components:4},"mat2x3<f32>":{type:"f32",components:6},"mat2x4<f32>":{type:"f32",components:8},"mat3x2<f32>":{type:"f32",components:6},"mat3x3<f32>":{type:"f32",components:9},"mat3x4<f32>":{type:"f32",components:12},"mat4x2<f32>":{type:"f32",components:8},"mat4x3<f32>":{type:"f32",components:12},"mat4x4<f32>":{type:"f32",components:16},"mat2x2<f16>":{type:"f16",components:4},"mat2x3<f16>":{type:"f16",components:6},"mat2x4<f16>":{type:"f16",components:8},"mat3x2<f16>":{type:"f16",components:6},"mat3x3<f16>":{type:"f16",components:9},"mat3x4<f16>":{type:"f16",components:12},"mat4x2<f16>":{type:"f16",components:8},"mat4x3<f16>":{type:"f16",components:12},"mat4x4<f16>":{type:"f16",components:16},"mat2x2<i32>":{type:"i32",components:4},"mat2x3<i32>":{type:"i32",components:6},"mat2x4<i32>":{type:"i32",components:8},"mat3x2<i32>":{type:"i32",components:6},"mat3x3<i32>":{type:"i32",components:9},"mat3x4<i32>":{type:"i32",components:12},"mat4x2<i32>":{type:"i32",components:8},"mat4x3<i32>":{type:"i32",components:12},"mat4x4<i32>":{type:"i32",components:16},"mat2x2<u32>":{type:"u32",components:4},"mat2x3<u32>":{type:"u32",components:6},"mat2x4<u32>":{type:"u32",components:8},"mat3x2<u32>":{type:"u32",components:6},"mat3x3<u32>":{type:"u32",components:9},"mat3x4<u32>":{type:"u32",components:12},"mat4x2<u32>":{type:"u32",components:8},"mat4x3<u32>":{type:"u32",components:12},"mat4x4<u32>":{type:"u32",components:16}};function F1(i,e){const t={};for(const r of i.attributes){const s=aP(i,e,r.name);s&&(t[r.name]=s)}return t}function oP(i,e,t=16){const r=F1(i,e),s=new Array(t).fill(null);for(const a of Object.values(r))s[a.location]=a;return s}function aP(i,e,t){const r=lP(i,t),s=cP(e,t);if(!r)return null;const a=iP(r.type),u=SC(a),l=s?.vertexFormat||u,g=X_(l);return{attributeName:s?.attributeName||r.name,bufferName:s?.bufferName||r.name,location:r.location,shaderType:r.type,primitiveType:a.primitiveType,shaderComponents:a.components,vertexFormat:l,bufferDataType:g.type,bufferComponents:g.components,normalized:g.normalized,integer:a.integer,stepMode:s?.stepMode||r.stepMode||"vertex",byteOffset:s?.byteOffset||0,byteStride:s?.byteStride||0}}function lP(i,e){const t=i.attributes.find(r=>r.name===e);return t||Qe.warn(`shader layout attribute "${e}" not present in shader`),t||null}function cP(i,e){uP(i);let t=hP(i,e);return t||(t=dP(i,e),t)?t:(Qe.warn(`layout for attribute "${e}" not present in buffer layout`),null)}function uP(i){for(const e of i)(e.attributes&&e.format||!e.attributes&&!e.format)&&Qe.warn(`BufferLayout ${name} must have either 'attributes' or 'format' field`)}function hP(i,e){for(const t of i)if(t.format&&t.name===e)return{attributeName:t.name,bufferName:e,stepMode:t.stepMode,vertexFormat:t.format,byteOffset:0,byteStride:t.byteStride||0};return null}function dP(i,e){for(const t of i){let r=t.byteStride;if(typeof t.byteStride!="number")for(const a of t.attributes||[]){const u=X_(a.format);r+=u.byteLength}const s=t.attributes?.find(a=>a.attribute===e);if(s)return{attributeName:s.attribute,bufferName:t.name,stepMode:t.stepMode,vertexFormat:s.format,byteOffset:s.byteOffset,byteStride:r}}return null}class G_ extends Mi{static defaultProps={...Mi.defaultProps,shaderLayout:void 0,bufferLayout:[]};get[Symbol.toStringTag](){return"VertexArray"}maxVertexAttributes;attributeInfos;indexBuffer=null;attributes;constructor(e,t){super(e,t,G_.defaultProps),this.maxVertexAttributes=e.limits.maxVertexAttributes,this.attributes=new Array(this.maxVertexAttributes).fill(null),this.attributeInfos=oP(t.shaderLayout,t.bufferLayout,this.maxVertexAttributes)}setConstantWebGL(e,t){this.device.reportError(new Error("constant attributes not supported"),this)()}}class K_ extends Mi{static defaultProps={...Mi.defaultProps,layout:void 0,buffers:{}};get[Symbol.toStringTag](){return"TransformFeedback"}constructor(e,t){super(e,t,K_.defaultProps)}}class J_ extends Mi{get[Symbol.toStringTag](){return"QuerySet"}constructor(e,t){super(e,t,J_.defaultProps)}static defaultProps={...Mi.defaultProps,type:void 0,count:void 0}}let Jd;function B1(i){return(!Jd||Jd.byteLength<i)&&(Jd=new ArrayBuffer(i)),Jd}function fP(i,e){const t=B1(i.BYTES_PER_ELEMENT*e);return new i(t,0,e)}function pP(i){return ArrayBuffer.isView(i)&&!(i instanceof DataView)}function Qf(i){return Array.isArray(i)?i.length===0||typeof i[0]=="number":pP(i)}const gP=1024;class mP{layout={};byteLength;constructor(e,t={}){let r=0;for(const[a,u]of Object.entries(e)){const l=L1(u),{type:g,components:v}=l,T=v*(t?.[a]??1);r=bC(r,T);const S=r;r+=T,this.layout[a]={type:g,size:T,offset:S}}r+=(4-r%4)%4;const s=r*4;this.byteLength=Math.max(s,gP)}getData(e){const t=B1(this.byteLength),r={i32:new Int32Array(t),u32:new Uint32Array(t),f32:new Float32Array(t),f16:new Uint16Array(t)};for(const[s,a]of Object.entries(e)){const u=this.layout[s];if(!u){Qe.warn(`Supplied uniform value ${s} not present in uniform block layout`)();continue}const{type:l,size:g,offset:v}=u,T=r[l];if(g===1){if(typeof a!="number"&&typeof a!="boolean"){Qe.warn(`Supplied value for single component uniform ${s} is not a number: ${a}`)();continue}T[v]=Number(a)}else{if(!Qf(a)){Qe.warn(`Supplied value for multi component / array uniform ${s} is not a numeric array: ${a}`)();continue}T.set(a,v)}}return new Uint8Array(t,0,this.byteLength)}has(e){return!!this.layout[e]}get(e){return this.layout[e]}}function _P(i,e,t=16){if(i!==e)return!1;const r=i,s=e;if(!Qf(r))return!1;if(Qf(s)&&r.length===s.length){for(let a=0;a<r.length;++a)if(s[a]!==r[a])return!1}return!0}function yP(i){return Qf(i)?i.slice():i}class xP{name;uniforms={};modifiedUniforms={};modified=!0;bindingLayout={};needsRedraw="initialized";constructor(e){if(this.name=e?.name||"unnamed",e?.name&&e?.shaderLayout){const t=e?.shaderLayout.bindings?.find(s=>s.type==="uniform"&&s.name===e?.name);if(!t)throw new Error(e?.name);const r=t;for(const s of r.uniforms||[])this.bindingLayout[s.name]=s}}setUniforms(e){for(const[t,r]of Object.entries(e))this._setUniform(t,r),this.needsRedraw||this.setNeedsRedraw(`${this.name}.${t}=${r}`)}setNeedsRedraw(e){this.needsRedraw=this.needsRedraw||e}getAllUniforms(){return this.modifiedUniforms={},this.needsRedraw=!1,this.uniforms||{}}_setUniform(e,t){_P(this.uniforms[e],t)||(this.uniforms[e]=yP(t),this.modifiedUniforms[e]=!0,this.modified=!0)}}class vP{uniformBlocks=new Map;uniformBufferLayouts=new Map;uniformBuffers=new Map;constructor(e){for(const[t,r]of Object.entries(e)){const s=t,a=new mP(r.uniformTypes??{},r.uniformSizes??{});this.uniformBufferLayouts.set(s,a);const u=new xP({name:t});u.setUniforms(r.defaultUniforms||{}),this.uniformBlocks.set(s,u)}}destroy(){for(const e of this.uniformBuffers.values())e.destroy()}setUniforms(e){for(const[t,r]of Object.entries(e))this.uniformBlocks.get(t)?.setUniforms(r);this.updateUniformBuffers()}getUniformBufferByteLength(e){return this.uniformBufferLayouts.get(e)?.byteLength||0}getUniformBufferData(e){const t=this.uniformBlocks.get(e)?.getAllUniforms()||{};return this.uniformBufferLayouts.get(e)?.getData(t)}createUniformBuffer(e,t,r){r&&this.setUniforms(r);const s=this.getUniformBufferByteLength(t),a=e.createBuffer({usage:Oi.UNIFORM|Oi.COPY_DST,byteLength:s}),u=this.getUniformBufferData(t);return a.write(u),a}getManagedUniformBuffer(e,t){if(!this.uniformBuffers.get(t)){const r=this.getUniformBufferByteLength(t),s=e.createBuffer({usage:Oi.UNIFORM|Oi.COPY_DST,byteLength:r});this.uniformBuffers.set(t,s)}return this.uniformBuffers.get(t)}updateUniformBuffers(){let e=!1;for(const t of this.uniformBlocks.keys()){const r=this.updateUniformBuffer(t);e||=r}return e&&Qe.log(3,`UniformStore.updateUniformBuffers(): ${e}`)(),e}updateUniformBuffer(e){const t=this.uniformBlocks.get(e);let r=this.uniformBuffers.get(e),s=!1;if(r&&t?.needsRedraw){s||=t.needsRedraw;const a=this.getUniformBufferData(e);r=this.uniformBuffers.get(e),r?.write(a);const u=this.uniformBlocks.get(e)?.getAllUniforms();Qe.log(4,`Writing to uniform buffer ${String(e)}`,a,u)()}return s}}class Ys{constructor(e,t){this.name=e,this.attributes=t,this.size=0}get isArray(){return!1}get isStruct(){return!1}get isTemplate(){return!1}get isPointer(){return!1}getTypeName(){return this.name}}class db{constructor(e,t,r){this.name=e,this.type=t,this.attributes=r,this.offset=0,this.size=0}get isArray(){return this.type.isArray}get isStruct(){return this.type.isStruct}get isTemplate(){return this.type.isTemplate}get align(){return this.type.isStruct?this.type.align:0}get members(){return this.type.isStruct?this.type.members:null}get format(){return this.type.isArray||this.type.isTemplate?this.type.format:null}get count(){return this.type.isArray?this.type.count:0}get stride(){return this.type.isArray?this.type.stride:this.size}}class Zo extends Ys{constructor(e,t){super(e,t),this.members=[],this.align=0,this.startLine=-1,this.endLine=-1,this.inUse=!1}get isStruct(){return!0}}class Qo extends Ys{constructor(e,t){super(e,t),this.count=0,this.stride=0}get isArray(){return!0}getTypeName(){return`array<${this.format.getTypeName()}, ${this.count}>`}}class Ym extends Ys{constructor(e,t,r){super(e,r),this.format=t}get isPointer(){return!0}getTypeName(){return`&${this.format.getTypeName()}`}}class Za extends Ys{constructor(e,t,r,s){super(e,r),this.format=t,this.access=s}get isTemplate(){return!0}getTypeName(){let e=this.name;if(this.format!==null){if(e==="vec2"||e==="vec3"||e==="vec4"||e==="mat2x2"||e==="mat2x3"||e==="mat2x4"||e==="mat3x2"||e==="mat3x3"||e==="mat3x4"||e==="mat4x2"||e==="mat4x3"||e==="mat4x4"){if(this.format.name==="f32")return e+="f",e;if(this.format.name==="i32")return e+="i",e;if(this.format.name==="u32")return e+="u",e;if(this.format.name==="bool")return e+="b",e;if(this.format.name==="f16")return e+="h",e}e+=`<${this.format.name}>`}else if(e==="vec2"||e==="vec3"||e==="vec4")return e;return e}}var Ho;(i=>{i[i.Uniform=0]="Uniform",i[i.Storage=1]="Storage",i[i.Texture=2]="Texture",i[i.Sampler=3]="Sampler",i[i.StorageTexture=4]="StorageTexture"})(Ho||(Ho={}));class Qd{constructor(e,t,r,s,a,u,l){this.name=e,this.type=t,this.group=r,this.binding=s,this.attributes=a,this.resourceType=u,this.access=l}get isArray(){return this.type.isArray}get isStruct(){return this.type.isStruct}get isTemplate(){return this.type.isTemplate}get size(){return this.type.size}get align(){return this.type.isStruct?this.type.align:0}get members(){return this.type.isStruct?this.type.members:null}get format(){return this.type.isArray||this.type.isTemplate?this.type.format:null}get count(){return this.type.isArray?this.type.count:0}get stride(){return this.type.isArray?this.type.stride:this.size}}class bP{constructor(e,t){this.name=e,this.type=t}}let wP=class{constructor(e,t,r,s){this.name=e,this.type=t,this.locationType=r,this.location=s,this.interpolation=null}};class fb{constructor(e,t,r,s){this.name=e,this.type=t,this.locationType=r,this.location=s}}class TP{constructor(e,t,r,s){this.name=e,this.type=t,this.attributes=r,this.id=s}}class SP{constructor(e,t,r){this.name=e,this.type=t,this.attributes=r}}class AP{constructor(e,t=null,r){this.stage=null,this.inputs=[],this.outputs=[],this.arguments=[],this.returnType=null,this.resources=[],this.overrides=[],this.startLine=-1,this.endLine=-1,this.inUse=!1,this.calls=new Set,this.name=e,this.stage=t,this.attributes=r}}class EP{constructor(){this.vertex=[],this.fragment=[],this.compute=[]}}function IP(i){var e=(32768&i)>>15,t=(31744&i)>>10,r=1023&i;return t==0?(e?-1:1)*Math.pow(2,-14)*(r/Math.pow(2,10)):t==31?r?NaN:1/0*(e?-1:1):(e?-1:1)*Math.pow(2,t-15)*(1+r/Math.pow(2,10))}const N1=new Float32Array(1),CP=new Int32Array(N1.buffer),$r=new Uint16Array(1);function PP(i){N1[0]=i;const e=CP[0],t=e>>31&1;let r=e>>23&255,s=8388607&e;if(r===255)return $r[0]=t<<15|31744|(s!==0?512:0),$r[0];if(r===0){if(s===0)return $r[0]=t<<15,$r[0];s|=8388608;let a=113;for(;!(8388608&s);)s<<=1,a--;return r=127-a,s&=8388607,r>0?(s=(s>>126-r)+(s>>127-r&1),$r[0]=t<<15|r<<10|s>>13,$r[0]):($r[0]=t<<15,$r[0])}return r=r-127+15,r>=31?($r[0]=t<<15|31744,$r[0]):r<=0?r<-10?($r[0]=t<<15,$r[0]):(s=(8388608|s)>>1-r,$r[0]=t<<15|s>>13,$r[0]):(s>>=13,$r[0]=t<<15|r<<10|s,$r[0])}const Q_=new Uint32Array(1),z1=new Float32Array(Q_.buffer,0,1);function pb(i){const e=112+(i>>6&31)<<23|(63&i)<<17;return Q_[0]=e,z1[0]}function MP(i,e,t,r,s,a,u,l,g){const v=r*(u>>=s)*(a>>=s)+t*u+e*l;switch(g){case"r8unorm":return[mi(i,v,"8unorm",1)[0]];case"r8snorm":return[mi(i,v,"8snorm",1)[0]];case"r8uint":return[mi(i,v,"8uint",1)[0]];case"r8sint":return[mi(i,v,"8sint",1)[0]];case"rg8unorm":{const T=mi(i,v,"8unorm",2);return[T[0],T[1]]}case"rg8snorm":{const T=mi(i,v,"8snorm",2);return[T[0],T[1]]}case"rg8uint":{const T=mi(i,v,"8uint",2);return[T[0],T[1]]}case"rg8sint":{const T=mi(i,v,"8sint",2);return[T[0],T[1]]}case"rgba8unorm-srgb":case"rgba8unorm":{const T=mi(i,v,"8unorm",4);return[T[0],T[1],T[2],T[3]]}case"rgba8snorm":{const T=mi(i,v,"8snorm",4);return[T[0],T[1],T[2],T[3]]}case"rgba8uint":{const T=mi(i,v,"8uint",4);return[T[0],T[1],T[2],T[3]]}case"rgba8sint":{const T=mi(i,v,"8sint",4);return[T[0],T[1],T[2],T[3]]}case"bgra8unorm-srgb":case"bgra8unorm":{const T=mi(i,v,"8unorm",4);return[T[2],T[1],T[0],T[3]]}case"r16uint":return[mi(i,v,"16uint",1)[0]];case"r16sint":return[mi(i,v,"16sint",1)[0]];case"r16float":return[mi(i,v,"16float",1)[0]];case"rg16uint":{const T=mi(i,v,"16uint",2);return[T[0],T[1]]}case"rg16sint":{const T=mi(i,v,"16sint",2);return[T[0],T[1]]}case"rg16float":{const T=mi(i,v,"16float",2);return[T[0],T[1]]}case"rgba16uint":{const T=mi(i,v,"16uint",4);return[T[0],T[1],T[2],T[3]]}case"rgba16sint":{const T=mi(i,v,"16sint",4);return[T[0],T[1],T[2],T[3]]}case"rgba16float":{const T=mi(i,v,"16float",4);return[T[0],T[1],T[2],T[3]]}case"r32uint":return[mi(i,v,"32uint",1)[0]];case"r32sint":return[mi(i,v,"32sint",1)[0]];case"depth16unorm":case"depth24plus":case"depth24plus-stencil8":case"depth32float":case"depth32float-stencil8":case"r32float":return[mi(i,v,"32float",1)[0]];case"rg32uint":{const T=mi(i,v,"32uint",2);return[T[0],T[1]]}case"rg32sint":{const T=mi(i,v,"32sint",2);return[T[0],T[1]]}case"rg32float":{const T=mi(i,v,"32float",2);return[T[0],T[1]]}case"rgba32uint":{const T=mi(i,v,"32uint",4);return[T[0],T[1],T[2],T[3]]}case"rgba32sint":{const T=mi(i,v,"32sint",4);return[T[0],T[1],T[2],T[3]]}case"rgba32float":{const T=mi(i,v,"32float",4);return[T[0],T[1],T[2],T[3]]}case"rg11b10ufloat":{const T=new Uint32Array(i.buffer,v,1)[0],S=(4192256&T)>>11,P=(4290772992&T)>>22;return[pb(2047&T),pb(S),(function(O){const $=112+(O>>5&31)<<23|(31&O)<<18;return Q_[0]=$,z1[0]})(P),1]}}return null}function mi(i,e,t,r){const s=[0,0,0,0];for(let a=0;a<r;++a)switch(t){case"8unorm":s[a]=i[e]/255,e++;break;case"8snorm":s[a]=i[e]/255*2-1,e++;break;case"8uint":s[a]=i[e],e++;break;case"8sint":s[a]=i[e]-127,e++;break;case"16uint":s[a]=i[e]|i[e+1]<<8,e+=2;break;case"16sint":s[a]=(i[e]|i[e+1]<<8)-32768,e+=2;break;case"16float":s[a]=IP(i[e]|i[e+1]<<8),e+=2;break;case"32uint":case"32sint":s[a]=i[e]|i[e+1]<<8|i[e+2]<<16|i[e+3]<<24,e+=4;break;case"32float":s[a]=new Float32Array(i.buffer,e,1)[0],e+=4}return s}function yi(i,e,t,r,s){for(let a=0;a<r;++a)switch(t){case"8unorm":i[e]=255*s[a],e++;break;case"8snorm":i[e]=.5*(s[a]+1)*255,e++;break;case"8uint":i[e]=s[a],e++;break;case"8sint":i[e]=s[a]+127,e++;break;case"16uint":new Uint16Array(i.buffer,e,1)[0]=s[a],e+=2;break;case"16sint":new Int16Array(i.buffer,e,1)[0]=s[a],e+=2;break;case"16float":{const u=PP(s[a]);new Uint16Array(i.buffer,e,1)[0]=u,e+=2;break}case"32uint":new Uint32Array(i.buffer,e,1)[0]=s[a],e+=4;break;case"32sint":new Int32Array(i.buffer,e,1)[0]=s[a],e+=4;break;case"32float":new Float32Array(i.buffer,e,1)[0]=s[a],e+=4}return s}const sm={r8unorm:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r8snorm:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r8uint:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r8sint:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},rg8unorm:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg8snorm:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg8uint:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg8sint:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rgba8unorm:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},"rgba8unorm-srgb":{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba8snorm:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba8uint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba8sint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},bgra8unorm:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},"bgra8unorm-srgb":{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},r16uint:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r16sint:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r16float:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},rg16uint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg16sint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg16float:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rgba16uint:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba16sint:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba16float:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},r32uint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r32sint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r32float:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},rg32uint:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg32sint:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg32float:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rgba32uint:{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba32sint:{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba32float:{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgb10a2uint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgb10a2unorm:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rg11b10ufloat:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},stencil8:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!1,hasStencil:!0,channels:1},depth16unorm:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!1,channels:1},depth24plus:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!1,depthOnlyFormat:"depth32float",channels:1},"depth24plus-stencil8":{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!0,depthOnlyFormat:"depth32float",channels:1},depth32float:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!1,channels:1},"depth32float-stencil8":{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!0,stencilOnlyFormat:"depth32float",channels:1},rgb9e5ufloat:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},"bc1-rgba-unorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc1-rgba-unorm-srgb":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc2-rgba-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc2-rgba-unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc3-rgba-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc3-rgba-unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc4-r-unorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:1},"bc4-r-snorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:1},"bc5-rg-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:2},"bc5-rg-snorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:2},"bc6h-rgb-ufloat":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc6h-rgb-float":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc7-rgba-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc7-rgba-unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgb8unorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgb8unorm-srgb":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgb8a1unorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgb8a1unorm-srgb":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgba8unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgba8unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"eac-r11unorm":{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!0,channels:1},"eac-r11snorm":{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!0,channels:1},"eac-rg11unorm":{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!0,channels:2},"eac-rg11snorm":{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!0,channels:2},"astc-4x4-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"astc-4x4-unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"astc-5x4-unorm":{bytesPerBlock:16,blockWidth:5,blockHeight:4,isCompressed:!0,channels:4},"astc-5x4-unorm-srgb":{bytesPerBlock:16,blockWidth:5,blockHeight:4,isCompressed:!0,channels:4},"astc-5x5-unorm":{bytesPerBlock:16,blockWidth:5,blockHeight:5,isCompressed:!0,channels:4},"astc-5x5-unorm-srgb":{bytesPerBlock:16,blockWidth:5,blockHeight:5,isCompressed:!0,channels:4},"astc-6x5-unorm":{bytesPerBlock:16,blockWidth:6,blockHeight:5,isCompressed:!0,channels:4},"astc-6x5-unorm-srgb":{bytesPerBlock:16,blockWidth:6,blockHeight:5,isCompressed:!0,channels:4},"astc-6x6-unorm":{bytesPerBlock:16,blockWidth:6,blockHeight:6,isCompressed:!0,channels:4},"astc-6x6-unorm-srgb":{bytesPerBlock:16,blockWidth:6,blockHeight:6,isCompressed:!0,channels:4},"astc-8x5-unorm":{bytesPerBlock:16,blockWidth:8,blockHeight:5,isCompressed:!0,channels:4},"astc-8x5-unorm-srgb":{bytesPerBlock:16,blockWidth:8,blockHeight:5,isCompressed:!0,channels:4},"astc-8x6-unorm":{bytesPerBlock:16,blockWidth:8,blockHeight:6,isCompressed:!0,channels:4},"astc-8x6-unorm-srgb":{bytesPerBlock:16,blockWidth:8,blockHeight:6,isCompressed:!0,channels:4},"astc-8x8-unorm":{bytesPerBlock:16,blockWidth:8,blockHeight:8,isCompressed:!0,channels:4},"astc-8x8-unorm-srgb":{bytesPerBlock:16,blockWidth:8,blockHeight:8,isCompressed:!0,channels:4},"astc-10x5-unorm":{bytesPerBlock:16,blockWidth:10,blockHeight:5,isCompressed:!0,channels:4},"astc-10x5-unorm-srgb":{bytesPerBlock:16,blockWidth:10,blockHeight:5,isCompressed:!0,channels:4},"astc-10x6-unorm":{bytesPerBlock:16,blockWidth:10,blockHeight:6,isCompressed:!0,channels:4},"astc-10x6-unorm-srgb":{bytesPerBlock:16,blockWidth:10,blockHeight:6,isCompressed:!0,channels:4},"astc-10x8-unorm":{bytesPerBlock:16,blockWidth:10,blockHeight:8,isCompressed:!0,channels:4},"astc-10x8-unorm-srgb":{bytesPerBlock:16,blockWidth:10,blockHeight:8,isCompressed:!0,channels:4},"astc-10x10-unorm":{bytesPerBlock:16,blockWidth:10,blockHeight:10,isCompressed:!0,channels:4},"astc-10x10-unorm-srgb":{bytesPerBlock:16,blockWidth:10,blockHeight:10,isCompressed:!0,channels:4},"astc-12x10-unorm":{bytesPerBlock:16,blockWidth:12,blockHeight:10,isCompressed:!0,channels:4},"astc-12x10-unorm-srgb":{bytesPerBlock:16,blockWidth:12,blockHeight:10,isCompressed:!0,channels:4},"astc-12x12-unorm":{bytesPerBlock:16,blockWidth:12,blockHeight:12,isCompressed:!0,channels:4},"astc-12x12-unorm-srgb":{bytesPerBlock:16,blockWidth:12,blockHeight:12,isCompressed:!0,channels:4}};let In=class U1{constructor(){this.id=U1._id++,this.line=0}get isAstNode(){return!0}get astNodeType(){return""}search(e){e(this)}searchBlock(e,t){if(e){t(ep.instance);for(const r of e)r instanceof Array?this.searchBlock(r,t):r.search(t);t(tp.instance)}}constEvaluate(e,t){throw new Error("Cannot evaluate node")}constEvaluateString(e){return this.constEvaluate(e).toString()}};In._id=0;let ep=class extends In{};ep.instance=new ep;class tp extends In{}tp.instance=new tp;const V1=new Set(["all","all","any","select","arrayLength","abs","acos","acosh","asin","asinh","atan","atanh","atan2","ceil","clamp","cos","cosh","countLeadingZeros","countOneBits","countTrailingZeros","cross","degrees","determinant","distance","dot","dot4U8Packed","dot4I8Packed","exp","exp2","extractBits","faceForward","firstLeadingBit","firstTrailingBit","floor","fma","fract","frexp","insertBits","inverseSqrt","ldexp","length","log","log2","max","min","mix","modf","normalize","pow","quantizeToF16","radians","reflect","refract","reverseBits","round","saturate","sign","sin","sinh","smoothStep","sqrt","step","tan","tanh","transpose","trunc","dpdx","dpdxCoarse","dpdxFine","dpdy","dpdyCoarse","dpdyFine","fwidth","fwidthCoarse","fwidthFine","textureDimensions","textureGather","textureGatherCompare","textureLoad","textureNumLayers","textureNumLevels","textureNumSamples","textureSample","textureSampleBias","textureSampleCompare","textureSampleCompareLevel","textureSampleGrad","textureSampleLevel","textureSampleBaseClampToEdge","textureStore","atomicLoad","atomicStore","atomicAdd","atomicSub","atomicMax","atomicMin","atomicAnd","atomicOr","atomicXor","atomicExchange","atomicCompareExchangeWeak","pack4x8snorm","pack4x8unorm","pack4xI8","pack4xU8","pack4x8Clamp","pack4xU8Clamp","pack2x16snorm","pack2x16unorm","pack2x16float","unpack4x8snorm","unpack4x8unorm","unpack4xI8","unpack4xU8","unpack2x16snorm","unpack2x16unorm","unpack2x16float","storageBarrier","textureBarrier","workgroupBarrier","workgroupUniformLoad","subgroupAdd","subgroupExclusiveAdd","subgroupInclusiveAdd","subgroupAll","subgroupAnd","subgroupAny","subgroupBallot","subgroupBroadcast","subgroupBroadcastFirst","subgroupElect","subgroupMax","subgroupMin","subgroupMul","subgroupExclusiveMul","subgroupInclusiveMul","subgroupOr","subgroupShuffle","subgroupShuffleDown","subgroupShuffleUp","subgroupShuffleXor","subgroupXor","quadBroadcast","quadSwapDiagonal","quadSwapX","quadSwapY"]);let $i=class extends In{constructor(){super()}},Ph=class extends $i{constructor(e,t,r,s,a,u){super(),this.calls=new Set,this.name=e,this.args=t,this.returnType=r,this.body=s,this.startLine=a,this.endLine=u}get astNodeType(){return"function"}search(e){if(this.attributes)for(const t of this.attributes)e(t);e(this);for(const t of this.args)e(t);this.searchBlock(this.body,e)}},RP=class extends $i{constructor(e){super(),this.expression=e}get astNodeType(){return"staticAssert"}search(e){this.expression.search(e)}};class j1 extends $i{constructor(e,t){super(),this.condition=e,this.body=t}get astNodeType(){return"while"}search(e){this.condition.search(e),this.searchBlock(this.body,e)}}let Gm=class extends $i{constructor(e,t){super(),this.body=e,this.loopId=t}get astNodeType(){return"continuing"}search(e){this.searchBlock(this.body,e)}},$1=class extends $i{constructor(e,t,r,s){super(),this.init=e,this.condition=t,this.increment=r,this.body=s}get astNodeType(){return"for"}search(e){var t,r,s;(t=this.init)===null||t===void 0||t.search(e),(r=this.condition)===null||r===void 0||r.search(e),(s=this.increment)===null||s===void 0||s.search(e),this.searchBlock(this.body,e)}};class Jn extends $i{constructor(e,t,r,s,a){super(),this.attributes=null,this.name=e,this.type=t,this.storage=r,this.access=s,this.value=a}get astNodeType(){return"var"}search(e){var t;e(this),(t=this.value)===null||t===void 0||t.search(e)}}let ey=class extends $i{constructor(e,t,r){super(),this.attributes=null,this.name=e,this.type=t,this.value=r}get astNodeType(){return"override"}search(e){var t;(t=this.value)===null||t===void 0||t.search(e)}},xh=class extends $i{constructor(e,t,r,s,a){super(),this.attributes=null,this.name=e,this.type=t,this.storage=r,this.access=s,this.value=a}get astNodeType(){return"let"}search(e){var t;e(this),(t=this.value)===null||t===void 0||t.search(e)}},Mf=class extends $i{constructor(e,t,r,s,a){super(),this.attributes=null,this.name=e,this.type=t,this.storage=r,this.access=s,this.value=a}get astNodeType(){return"const"}constEvaluate(e,t){return this.value.constEvaluate(e,t)}search(e){var t;e(this),(t=this.value)===null||t===void 0||t.search(e)}};var oc,uh,Fe,Ie;(i=>{i.increment="++",i.decrement="--"})(oc||(oc={})),(i=>{i.parse=function(e){const t=e;if(t=="parse")throw new Error("Invalid value for IncrementOperator");return i[t]}})(oc||(oc={}));let W1=class extends $i{constructor(e,t){super(),this.operator=e,this.variable=t}get astNodeType(){return"increment"}search(e){this.variable.search(e)}};(i=>{i.assign="=",i.addAssign="+=",i.subtractAssin="-=",i.multiplyAssign="*=",i.divideAssign="/=",i.moduloAssign="%=",i.andAssign="&=",i.orAssign="|=",i.xorAssign="^=",i.shiftLeftAssign="<<=",i.shiftRightAssign=">>="})(uh||(uh={})),(i=>{i.parse=function(e){const t=e;if(t=="parse")throw new Error("Invalid value for AssignOperator");return t}})(uh||(uh={}));let H1=class extends $i{constructor(e,t,r){super(),this.operator=e,this.variable=t,this.value=r}get astNodeType(){return"assign"}search(e){this.variable.search(e),this.value.search(e)}},ty=class extends $i{constructor(e,t){super(),this.name=e,this.args=t}get astNodeType(){return"call"}isBuiltin(){return V1.has(this.name)}search(e){for(const t of this.args)t.search(e);e(this)}},q1=class extends $i{constructor(e,t){super(),this.body=e,this.continuing=t}get astNodeType(){return"loop"}search(e){var t;this.searchBlock(this.body,e),(t=this.continuing)===null||t===void 0||t.search(e)}},X1=class extends $i{constructor(e,t){super(),this.condition=e,this.cases=t}get astNodeType(){return"switch"}search(e){e(this);for(const t of this.cases)t.search(e)}},Z1=class extends $i{constructor(e,t,r,s){super(),this.condition=e,this.body=t,this.elseif=r,this.else=s}get astNodeType(){return"if"}search(e){this.condition.search(e),this.searchBlock(this.body,e),this.searchBlock(this.elseif,e),this.searchBlock(this.else,e)}},Y1=class extends $i{constructor(e){super(),this.value=e}get astNodeType(){return"return"}search(e){var t;(t=this.value)===null||t===void 0||t.search(e)}},kP=class extends $i{constructor(e){super(),this.name=e}get astNodeType(){return"enable"}},DP=class extends $i{constructor(e){super(),this.extensions=e}get astNodeType(){return"requires"}};class G1 extends $i{constructor(e,t){super(),this.severity=e,this.rule=t}get astNodeType(){return"diagnostic"}}class iy extends $i{constructor(e,t){super(),this.name=e,this.type=t}get astNodeType(){return"alias"}}class OP extends $i{constructor(){super()}get astNodeType(){return"discard"}}class K1 extends $i{constructor(){super(),this.condition=null,this.loopId=-1}get astNodeType(){return"break"}}class J1 extends $i{constructor(){super(),this.loopId=-1}get astNodeType(){return"continue"}}class Ge extends $i{constructor(e){super(),this.attributes=null,this.name=e}get astNodeType(){return"type"}get isStruct(){return!1}get isArray(){return!1}static maxFormatType(e){let t=e[0];if(t.name==="f32")return t;for(let r=1;r<e.length;++r){const s=Ge._priority.get(t.name);Ge._priority.get(e[r].name)<s&&(t=e[r])}return t.name==="x32"?Ge.i32:t}getTypeName(){return this.name}}Ge.x32=new Ge("x32"),Ge.f32=new Ge("f32"),Ge.i32=new Ge("i32"),Ge.u32=new Ge("u32"),Ge.f16=new Ge("f16"),Ge.bool=new Ge("bool"),Ge.void=new Ge("void"),Ge._priority=new Map([["f32",0],["f16",1],["u32",2],["i32",3],["x32",3]]);let gb=class extends Ge{constructor(e){super(e)}};class Gn extends Ge{constructor(e,t,r,s){super(e),this.members=t,this.startLine=r,this.endLine=s}get astNodeType(){return"struct"}get isStruct(){return!0}getMemberIndex(e){for(let t=0;t<this.members.length;t++)if(this.members[t].name==e)return t;return-1}search(e){for(const t of this.members)e(t)}}class Re extends Ge{constructor(e,t,r){super(e),this.format=t,this.access=r}get astNodeType(){return"template"}getTypeName(){let e=this.name;if(this.format!==null){if(e==="vec2"||e==="vec3"||e==="vec4"||e==="mat2x2"||e==="mat2x3"||e==="mat2x4"||e==="mat3x2"||e==="mat3x3"||e==="mat3x4"||e==="mat4x2"||e==="mat4x3"||e==="mat4x4"){if(this.format.name==="f32")return e+="f",e;if(this.format.name==="i32")return e+="i",e;if(this.format.name==="u32")return e+="u",e;if(this.format.name==="bool")return e+="b",e;if(this.format.name==="f16")return e+="h",e}e+=`<${this.format.name}>`}else if(e==="vec2"||e==="vec3"||e==="vec4")return e;return e}}Re.vec2f=new Re("vec2",Ge.f32,null),Re.vec3f=new Re("vec3",Ge.f32,null),Re.vec4f=new Re("vec4",Ge.f32,null),Re.vec2i=new Re("vec2",Ge.i32,null),Re.vec3i=new Re("vec3",Ge.i32,null),Re.vec4i=new Re("vec4",Ge.i32,null),Re.vec2u=new Re("vec2",Ge.u32,null),Re.vec3u=new Re("vec3",Ge.u32,null),Re.vec4u=new Re("vec4",Ge.u32,null),Re.vec2h=new Re("vec2",Ge.f16,null),Re.vec3h=new Re("vec3",Ge.f16,null),Re.vec4h=new Re("vec4",Ge.f16,null),Re.vec2b=new Re("vec2",Ge.bool,null),Re.vec3b=new Re("vec3",Ge.bool,null),Re.vec4b=new Re("vec4",Ge.bool,null),Re.mat2x2f=new Re("mat2x2",Ge.f32,null),Re.mat2x3f=new Re("mat2x3",Ge.f32,null),Re.mat2x4f=new Re("mat2x4",Ge.f32,null),Re.mat3x2f=new Re("mat3x2",Ge.f32,null),Re.mat3x3f=new Re("mat3x3",Ge.f32,null),Re.mat3x4f=new Re("mat3x4",Ge.f32,null),Re.mat4x2f=new Re("mat4x2",Ge.f32,null),Re.mat4x3f=new Re("mat4x3",Ge.f32,null),Re.mat4x4f=new Re("mat4x4",Ge.f32,null),Re.mat2x2h=new Re("mat2x2",Ge.f16,null),Re.mat2x3h=new Re("mat2x3",Ge.f16,null),Re.mat2x4h=new Re("mat2x4",Ge.f16,null),Re.mat3x2h=new Re("mat3x2",Ge.f16,null),Re.mat3x3h=new Re("mat3x3",Ge.f16,null),Re.mat3x4h=new Re("mat3x4",Ge.f16,null),Re.mat4x2h=new Re("mat4x2",Ge.f16,null),Re.mat4x3h=new Re("mat4x3",Ge.f16,null),Re.mat4x4h=new Re("mat4x4",Ge.f16,null),Re.mat2x2i=new Re("mat2x2",Ge.i32,null),Re.mat2x3i=new Re("mat2x3",Ge.i32,null),Re.mat2x4i=new Re("mat2x4",Ge.i32,null),Re.mat3x2i=new Re("mat3x2",Ge.i32,null),Re.mat3x3i=new Re("mat3x3",Ge.i32,null),Re.mat3x4i=new Re("mat3x4",Ge.i32,null),Re.mat4x2i=new Re("mat4x2",Ge.i32,null),Re.mat4x3i=new Re("mat4x3",Ge.i32,null),Re.mat4x4i=new Re("mat4x4",Ge.i32,null),Re.mat2x2u=new Re("mat2x2",Ge.u32,null),Re.mat2x3u=new Re("mat2x3",Ge.u32,null),Re.mat2x4u=new Re("mat2x4",Ge.u32,null),Re.mat3x2u=new Re("mat3x2",Ge.u32,null),Re.mat3x3u=new Re("mat3x3",Ge.u32,null),Re.mat3x4u=new Re("mat3x4",Ge.u32,null),Re.mat4x2u=new Re("mat4x2",Ge.u32,null),Re.mat4x3u=new Re("mat4x3",Ge.u32,null),Re.mat4x4u=new Re("mat4x4",Ge.u32,null);class Rf extends Ge{constructor(e,t,r,s){super(e),this.storage=t,this.type=r,this.access=s}get astNodeType(){return"pointer"}}class vh extends Ge{constructor(e,t,r,s){super(e),this.attributes=t,this.format=r,this.count=s}get astNodeType(){return"array"}get isArray(){return!0}}class hh extends Ge{constructor(e,t,r){super(e),this.format=t,this.access=r}get astNodeType(){return"sampler"}}class hn extends In{constructor(){super(),this.postfix=null}}class Ya extends hn{constructor(e){super(),this.value=e}get astNodeType(){return"stringExpr"}toString(){return this.value}constEvaluateString(){return this.value}}class Tn extends hn{constructor(e,t){super(),this.type=e,this.args=t}get astNodeType(){return"createExpr"}search(e){if(e(this),this.args)for(const t of this.args)t.search(e)}constEvaluate(e,t){return t&&(t[0]=this.type),e.evalExpression(this,e.context)}}class ry extends hn{constructor(e,t){super(),this.cachedReturnValue=null,this.name=e,this.args=t}get astNodeType(){return"callExpr"}setCachedReturnValue(e){this.cachedReturnValue=e}get isBuiltin(){return V1.has(this.name)}constEvaluate(e,t){return e.evalExpression(this,e.context)}search(e){for(const t of this.args)t.search(e);e(this)}}class Ls extends hn{constructor(e){super(),this.name=e}get astNodeType(){return"varExpr"}search(e){e(this),this.postfix&&this.postfix.search(e)}constEvaluate(e,t){return e.evalExpression(this,e.context)}}class Q1 extends hn{constructor(e,t){super(),this.name=e,this.initializer=t}get astNodeType(){return"constExpr"}constEvaluate(e,t){if(this.initializer){const r=e.evalExpression(this.initializer,e.context);return r!==null&&this.postfix?r.getSubData(e,this.postfix,e.context):r}return null}search(e){this.initializer.search(e)}}class hr extends hn{constructor(e,t){super(),this.value=e,this.type=t}get astNodeType(){return"literalExpr"}constEvaluate(e,t){return t!==void 0&&(t[0]=this.type),this.value}get isScalar(){return this.value instanceof Ae}get isVector(){return this.value instanceof ne||this.value instanceof Wt}get scalarValue(){return this.value instanceof Ae?this.value.value:(console.error("Value is not scalar."),0)}get vectorValue(){return this.value instanceof ne||this.value instanceof Wt?this.value.data:(console.error("Value is not a vector or matrix."),new Float32Array(0))}}class e2 extends hn{constructor(e,t){super(),this.type=e,this.value=t}get astNodeType(){return"bitcastExpr"}search(e){this.value.search(e)}}class vc extends hn{constructor(e){super(),this.index=e}search(e){this.index.search(e)}}class t2 extends hn{constructor(){super()}}class or extends t2{constructor(e,t){super(),this.operator=e,this.right=t}get astNodeType(){return"unaryOp"}constEvaluate(e,t){return e.evalExpression(this,e.context)}search(e){this.right.search(e)}}class an extends t2{constructor(e,t,r){super(),this.operator=e,this.left=t,this.right=r}get astNodeType(){return"binaryOp"}_getPromotedType(e,t){return e.name===t.name?e:e.name==="f32"||t.name==="f32"?Ge.f32:e.name==="u32"||t.name==="u32"?Ge.u32:Ge.i32}constEvaluate(e,t){return e.evalExpression(this,e.context)}search(e){this.left.search(e),this.right.search(e)}}class i2 extends In{constructor(e){super(),this.body=e}search(e){e(this),this.searchBlock(this.body,e)}}class kf extends hn{constructor(){super()}get astNodeType(){return"default"}}class r2 extends i2{constructor(e,t){super(t),this.selectors=e}get astNodeType(){return"case"}search(e){this.searchBlock(this.body,e)}}class s2 extends i2{constructor(e){super(e)}get astNodeType(){return"default"}search(e){this.searchBlock(this.body,e)}}class mb extends In{constructor(e,t,r){super(),this.name=e,this.type=t,this.attributes=r}get astNodeType(){return"argument"}}class LP extends In{constructor(e,t){super(),this.condition=e,this.body=t}get astNodeType(){return"elseif"}search(e){this.condition.search(e),this.searchBlock(this.body,e)}}class _b extends In{constructor(e,t,r){super(),this.name=e,this.type=t,this.attributes=r}get astNodeType(){return"member"}}class n2 extends In{constructor(e,t){super(),this.name=e,this.value=t}get astNodeType(){return"attribute"}}class Js{constructor(e,t){this.parent=null,this.typeInfo=e,this.parent=t,this.id=Js._id++}clone(){throw`Clone: Not implemented for ${this.constructor.name}`}setDataValue(e,t,r,s){console.error(`SetDataValue: Not implemented for ${this.constructor.name}`)}getSubData(e,t,r){return console.error(`GetDataValue: Not implemented for ${this.constructor.name}`),null}toString(){return`<${this.typeInfo.getTypeName()}>`}}Js._id=0;class Km extends Js{constructor(){super(new Ys("void",null),null)}toString(){return"void"}}Km.void=new Km;class Ql extends Js{constructor(e){super(new Ym("pointer",e.typeInfo,null),null),this.reference=e}clone(){return this}setDataValue(e,t,r,s){this.reference.setDataValue(e,t,r,s)}getSubData(e,t,r){return t?this.reference.getSubData(e,t,r):this}toString(){return`&${this.reference.toString()}`}}class Ae extends Js{constructor(e,t,r=null){super(t,r),e instanceof Int32Array||e instanceof Uint32Array||e instanceof Float32Array?this.data=e:this.typeInfo.name==="x32"?e-Math.floor(e)!==0?this.data=new Float32Array([e]):this.data=e>=0?new Uint32Array([e]):new Int32Array([e]):this.typeInfo.name==="i32"||this.typeInfo.name==="bool"?this.data=new Int32Array([e]):this.typeInfo.name==="u32"?this.data=new Uint32Array([e]):this.typeInfo.name==="f32"||this.typeInfo.name==="f16"?this.data=new Float32Array([e]):console.error("ScalarData2: Invalid type",t)}clone(){if(this.data instanceof Float32Array)return new Ae(new Float32Array(this.data),this.typeInfo,null);if(this.data instanceof Int32Array)return new Ae(new Int32Array(this.data),this.typeInfo,null);if(this.data instanceof Uint32Array)return new Ae(new Uint32Array(this.data),this.typeInfo,null);throw"ScalarData: Invalid data type"}get value(){return this.data[0]}set value(e){this.data[0]=e}setDataValue(e,t,r,s){if(r)return void console.error("SetDataValue: Scalar data does not support postfix",r);if(!(t instanceof Ae))return void console.error("SetDataValue: Invalid value",t);let a=t.data[0];this.typeInfo.name==="i32"||this.typeInfo.name==="u32"?a=Math.floor(a):this.typeInfo.name==="bool"&&(a=a?1:0),this.data[0]=a}getSubData(e,t,r){return t?(console.error("getSubData: Scalar data does not support postfix",t),null):this}toString(){return`${this.value}`}}function FP(i,e,t){const r=e.length;return r===2?t==="f32"?new ne(new Float32Array(e),i.getTypeInfo("vec2f")):t==="i32"||t==="bool"?new ne(new Int32Array(e),i.getTypeInfo("vec2i")):t==="u32"?new ne(new Uint32Array(e),i.getTypeInfo("vec2u")):t==="f16"?new ne(new Float32Array(e),i.getTypeInfo("vec2h")):(console.error(`getSubData: Unknown format ${t}`),null):r===3?t==="f32"?new ne(new Float32Array(e),i.getTypeInfo("vec3f")):t==="i32"||t==="bool"?new ne(new Int32Array(e),i.getTypeInfo("vec3i")):t==="u32"?new ne(new Uint32Array(e),i.getTypeInfo("vec3u")):t==="f16"?new ne(new Float32Array(e),i.getTypeInfo("vec3h")):(console.error(`getSubData: Unknown format ${t}`),null):r===4?t==="f32"?new ne(new Float32Array(e),i.getTypeInfo("vec4f")):t==="i32"||t==="bool"?new ne(new Int32Array(e),i.getTypeInfo("vec4i")):t==="u32"?new ne(new Uint32Array(e),i.getTypeInfo("vec4u")):t==="f16"?new ne(new Float32Array(e),i.getTypeInfo("vec4h")):(console.error(`getSubData: Unknown format ${t}`),null):(console.error(`getSubData: Invalid vector size ${e.length}`),null)}class ne extends Js{constructor(e,t,r=null){if(super(t,r),e instanceof Float32Array||e instanceof Uint32Array||e instanceof Int32Array)this.data=e;else{const s=this.typeInfo.name;s==="vec2f"||s==="vec3f"||s==="vec4f"?this.data=new Float32Array(e):s==="vec2i"||s==="vec3i"||s==="vec4i"?this.data=new Int32Array(e):s==="vec2u"||s==="vec3u"||s==="vec4u"?this.data=new Uint32Array(e):s==="vec2h"||s==="vec3h"||s==="vec4h"?this.data=new Float32Array(e):s==="vec2b"||s==="vec3b"||s==="vec4b"?this.data=new Int32Array(e):s==="vec2"||s==="vec3"||s==="vec4"?this.data=new Float32Array(e):console.error(`VectorData: Invalid type ${s}`)}}clone(){if(this.data instanceof Float32Array)return new ne(new Float32Array(this.data),this.typeInfo,null);if(this.data instanceof Int32Array)return new ne(new Int32Array(this.data),this.typeInfo,null);if(this.data instanceof Uint32Array)return new ne(new Uint32Array(this.data),this.typeInfo,null);throw"VectorData: Invalid data type"}setDataValue(e,t,r,s){r instanceof Ya?console.error("TODO: Set vector postfix"):t instanceof ne?this.data=t.data:console.error("SetDataValue: Invalid value",t)}getSubData(e,t,r){if(t===null)return this;let s=e.getTypeInfo("f32");if(this.typeInfo instanceof Za)s=this.typeInfo.format||s;else{const u=this.typeInfo.name;u==="vec2f"||u==="vec3f"||u==="vec4f"?s=e.getTypeInfo("f32"):u==="vec2i"||u==="vec3i"||u==="vec4i"?s=e.getTypeInfo("i32"):u==="vec2b"||u==="vec3b"||u==="vec4b"?s=e.getTypeInfo("bool"):u==="vec2u"||u==="vec3u"||u==="vec4u"?s=e.getTypeInfo("u32"):u==="vec2h"||u==="vec3h"||u==="vec4h"?s=e.getTypeInfo("f16"):console.error(`GetSubData: Unknown type ${u}`)}let a=this;for(;t!==null&&a!==null;){if(t instanceof vc){const u=t.index;let l=-1;if(u instanceof hr){if(!(u.value instanceof Ae))return console.error(`GetSubData: Invalid array index ${u.value}`),null;l=u.value.value}else{const g=e.evalExpression(u,r);if(!(g instanceof Ae))return console.error("GetSubData: Unknown index type",u),null;l=g.value}if(l<0||l>=a.data.length)return console.error("GetSubData: Index out of range",l),null;if(a.data instanceof Float32Array){const g=new Float32Array(a.data.buffer,a.data.byteOffset+4*l,1);return new Ae(g,s)}if(a.data instanceof Int32Array){const g=new Int32Array(a.data.buffer,a.data.byteOffset+4*l,1);return new Ae(g,s)}if(a.data instanceof Uint32Array){const g=new Uint32Array(a.data.buffer,a.data.byteOffset+4*l,1);return new Ae(g,s)}throw"GetSubData: Invalid data type"}if(!(t instanceof Ya))return console.error("GetSubData: Unknown postfix",t),null;{const u=t.value.toLowerCase();if(u.length===1){let g=0;if(u==="x"||u==="r")g=0;else if(u==="y"||u==="g")g=1;else if(u==="z"||u==="b")g=2;else{if(u!=="w"&&u!=="a")return console.error(`GetSubData: Unknown member ${u}`),null;g=3}if(this.data instanceof Float32Array){let v=new Float32Array(this.data.buffer,this.data.byteOffset+4*g,1);return new Ae(v,s,this)}if(this.data instanceof Int32Array){let v=new Int32Array(this.data.buffer,this.data.byteOffset+4*g,1);return new Ae(v,s,this)}if(this.data instanceof Uint32Array){let v=new Uint32Array(this.data.buffer,this.data.byteOffset+4*g,1);return new Ae(v,s,this)}}const l=[];for(const g of u)g==="x"||g==="r"?l.push(this.data[0]):g==="y"||g==="g"?l.push(this.data[1]):g==="z"||g==="b"?l.push(this.data[2]):g==="w"||g==="a"?l.push(this.data[3]):console.error(`GetDataValue: Unknown member ${g}`);a=FP(e,l,s.name)}t=t.postfix}return a}toString(){let e=`${this.data[0]}`;for(let t=1;t<this.data.length;++t)e+=`, ${this.data[t]}`;return e}}class Wt extends Js{constructor(e,t,r=null){super(t,r),e instanceof Float32Array?this.data=e:this.data=new Float32Array(e)}clone(){return new Wt(new Float32Array(this.data),this.typeInfo,null)}setDataValue(e,t,r,s){r instanceof Ya?console.error("TODO: Set matrix postfix"):t instanceof Wt?this.data=t.data:console.error("SetDataValue: Invalid value",t)}getSubData(e,t,r){if(t===null)return this;const s=this.typeInfo.name;if(e.getTypeInfo("f32"),this.typeInfo instanceof Za)this.typeInfo.format;else if(s.endsWith("f"))e.getTypeInfo("f32");else if(s.endsWith("i"))e.getTypeInfo("i32");else if(s.endsWith("u"))e.getTypeInfo("u32");else{if(!s.endsWith("h"))return console.error(`GetDataValue: Unknown type ${s}`),null;e.getTypeInfo("f16")}if(t instanceof vc){const a=t.index;let u=-1;if(a instanceof hr){if(!(a.value instanceof Ae))return console.error(`GetDataValue: Invalid array index ${a.value}`),null;u=a.value.value}else{const v=e.evalExpression(a,r);if(!(v instanceof Ae))return console.error("GetDataValue: Unknown index type",a),null;u=v.value}if(u<0||u>=this.data.length)return console.error("GetDataValue: Index out of range",u),null;const l=s.endsWith("h")?"h":"f";let g;if(s==="mat2x2"||s==="mat2x2f"||s==="mat2x2h"||s==="mat3x2"||s==="mat3x2f"||s==="mat3x2h"||s==="mat4x2"||s==="mat4x2f"||s==="mat4x2h")g=new ne(new Float32Array(this.data.buffer,this.data.byteOffset+2*u*4,2),e.getTypeInfo(`vec2${l}`));else if(s==="mat2x3"||s==="mat2x3f"||s==="mat2x3h"||s==="mat3x3"||s==="mat3x3f"||s==="mat3x3h"||s==="mat4x3"||s==="mat4x3f"||s==="mat4x3h")g=new ne(new Float32Array(this.data.buffer,this.data.byteOffset+3*u*4,3),e.getTypeInfo(`vec3${l}`));else{if(s!=="mat2x4"&&s!=="mat2x4f"&&s!=="mat2x4h"&&s!=="mat3x4"&&s!=="mat3x4f"&&s!=="mat3x4h"&&s!=="mat4x4"&&s!=="mat4x4f"&&s!=="mat4x4h")return console.error(`GetDataValue: Unknown type ${s}`),null;g=new ne(new Float32Array(this.data.buffer,this.data.byteOffset+4*u*4,4),e.getTypeInfo(`vec4${l}`))}return t.postfix?g.getSubData(e,t.postfix,r):g}return console.error("GetDataValue: Invalid postfix",t),null}toString(){let e=`${this.data[0]}`;for(let t=1;t<this.data.length;++t)e+=`, ${this.data[t]}`;return e}}class Ki extends Js{constructor(e,t,r=0,s=null){super(t,s),this.buffer=e instanceof ArrayBuffer?e:e.buffer,this.offset=r}clone(){const e=new Uint8Array(new Uint8Array(this.buffer,this.offset,this.typeInfo.size));return new Ki(e.buffer,this.typeInfo,0,null)}setDataValue(e,t,r,s){if(t===null)return void console.log("setDataValue: NULL data.");let a=this.offset,u=this.typeInfo;for(;r;){if(r instanceof vc)if(u instanceof Qo){const l=r.index;if(l instanceof hr){if(!(l.value instanceof Ae))return void console.error(`SetDataValue: Invalid index type ${l.value}`);a+=l.value.value*u.stride}else{const g=e.evalExpression(l,s);if(!(g instanceof Ae))return void console.error("SetDataValue: Unknown index type",l);a+=g.value*u.stride}u=u.format}else console.error(`SetDataValue: Type ${u.getTypeName()} is not an array`);else{if(!(r instanceof Ya))return void console.error("SetDataValue: Unknown postfix type",r);{const l=r.value;if(u instanceof Zo){let g=!1;for(const v of u.members)if(v.name===l){a+=v.offset,u=v.type,g=!0;break}if(!g)return void console.error(`SetDataValue: Member ${l} not found`)}else if(u instanceof Ys){const g=u.getTypeName();let v=0;if(l==="x"||l==="r")v=0;else if(l==="y"||l==="g")v=1;else if(l==="z"||l==="b")v=2;else{if(l!=="w"&&l!=="a")return void console.error(`SetDataValue: Unknown member ${l}`);v=3}if(!(t instanceof Ae))return void console.error("SetDataValue: Invalid value",t);const T=t.value;return g==="vec2f"?void(new Float32Array(this.buffer,a,2)[v]=T):g==="vec3f"?void(new Float32Array(this.buffer,a,3)[v]=T):g==="vec4f"?void(new Float32Array(this.buffer,a,4)[v]=T):g==="vec2i"?void(new Int32Array(this.buffer,a,2)[v]=T):g==="vec3i"?void(new Int32Array(this.buffer,a,3)[v]=T):g==="vec4i"?void(new Int32Array(this.buffer,a,4)[v]=T):g==="vec2u"?void(new Uint32Array(this.buffer,a,2)[v]=T):g==="vec3u"?void(new Uint32Array(this.buffer,a,3)[v]=T):g==="vec4u"?void(new Uint32Array(this.buffer,a,4)[v]=T):void console.error(`SetDataValue: Type ${g} is not a struct`)}}}r=r.postfix}this.setData(e,t,u,a,s)}setData(e,t,r,s,a){const u=r.getTypeName();if(u!=="f32"&&u!=="f16")if(u!=="i32"&&u!=="atomic<i32>"&&u!=="x32")if(u!=="u32"&&u!=="atomic<u32>")if(u!=="bool"){if(u==="vec2f"||u==="vec2h"){const l=new Float32Array(this.buffer,s,2);return void(t instanceof ne?(l[0]=t.data[0],l[1]=t.data[1]):(l[0]=t[0],l[1]=t[1]))}if(u==="vec3f"||u==="vec3h"){const l=new Float32Array(this.buffer,s,3);return void(t instanceof ne?(l[0]=t.data[0],l[1]=t.data[1],l[2]=t.data[2]):(l[0]=t[0],l[1]=t[1],l[2]=t[2]))}if(u==="vec4f"||u==="vec4h"){const l=new Float32Array(this.buffer,s,4);return void(t instanceof ne?(l[0]=t.data[0],l[1]=t.data[1],l[2]=t.data[2],l[3]=t.data[3]):(l[0]=t[0],l[1]=t[1],l[2]=t[2],l[3]=t[3]))}if(u==="vec2i"){const l=new Int32Array(this.buffer,s,2);return void(t instanceof ne?(l[0]=t.data[0],l[1]=t.data[1]):(l[0]=t[0],l[1]=t[1]))}if(u==="vec3i"){const l=new Int32Array(this.buffer,s,3);return void(t instanceof ne?(l[0]=t.data[0],l[1]=t.data[1],l[2]=t.data[2]):(l[0]=t[0],l[1]=t[1],l[2]=t[2]))}if(u==="vec4i"){const l=new Int32Array(this.buffer,s,4);return void(t instanceof ne?(l[0]=t.data[0],l[1]=t.data[1],l[2]=t.data[2],l[3]=t.data[3]):(l[0]=t[0],l[1]=t[1],l[2]=t[2],l[3]=t[3]))}if(u==="vec2u"){const l=new Uint32Array(this.buffer,s,2);return void(t instanceof ne?(l[0]=t.data[0],l[1]=t.data[1]):(l[0]=t[0],l[1]=t[1]))}if(u==="vec3u"){const l=new Uint32Array(this.buffer,s,3);return void(t instanceof ne?(l[0]=t.data[0],l[1]=t.data[1],l[2]=t.data[2]):(l[0]=t[0],l[1]=t[1],l[2]=t[2]))}if(u==="vec4u"){const l=new Uint32Array(this.buffer,s,4);return void(t instanceof ne?(l[0]=t.data[0],l[1]=t.data[1],l[2]=t.data[2],l[3]=t.data[3]):(l[0]=t[0],l[1]=t[1],l[2]=t[2],l[3]=t[3]))}if(u==="vec2b"){const l=new Uint32Array(this.buffer,s,2);return void(t instanceof ne?(l[0]=t.data[0],l[1]=t.data[1]):(l[0]=t[0],l[1]=t[1]))}if(u==="vec3b"){const l=new Uint32Array(this.buffer,s,3);return void(t instanceof ne?(l[0]=t.data[0],l[1]=t.data[1],l[2]=t.data[2]):(l[0]=t[0],l[1]=t[1],l[2]=t[2]))}if(u==="vec4b"){const l=new Uint32Array(this.buffer,s,4);return void(t instanceof ne?(l[0]=t.data[0],l[1]=t.data[1],l[2]=t.data[2],l[3]=t.data[3]):(l[0]=t[0],l[1]=t[1],l[2]=t[2],l[3]=t[3]))}if(u==="mat2x2f"||u==="mat2x2h"){const l=new Float32Array(this.buffer,s,4);return void(t instanceof Wt?(l[0]=t.data[0],l[1]=t.data[1],l[2]=t.data[2],l[3]=t.data[3]):(l[0]=t[0],l[1]=t[1],l[2]=t[2],l[3]=t[3]))}if(u==="mat2x3f"||u==="mat2x3h"){const l=new Float32Array(this.buffer,s,6);return void(t instanceof Wt?(l[0]=t.data[0],l[1]=t.data[1],l[2]=t.data[2],l[3]=t.data[3],l[4]=t.data[4],l[5]=t.data[5]):(l[0]=t[0],l[1]=t[1],l[2]=t[2],l[3]=t[3],l[4]=t[4],l[5]=t[5]))}if(u==="mat2x4f"||u==="mat2x4h"){const l=new Float32Array(this.buffer,s,8);return void(t instanceof Wt?(l[0]=t.data[0],l[1]=t.data[1],l[2]=t.data[2],l[3]=t.data[3],l[4]=t.data[4],l[5]=t.data[5],l[6]=t.data[6],l[7]=t.data[7]):(l[0]=t[0],l[1]=t[1],l[2]=t[2],l[3]=t[3],l[4]=t[4],l[5]=t[5],l[6]=t[6],l[7]=t[7]))}if(u==="mat3x2f"||u==="mat3x2h"){const l=new Float32Array(this.buffer,s,6);return void(t instanceof Wt?(l[0]=t.data[0],l[1]=t.data[1],l[2]=t.data[2],l[3]=t.data[3],l[4]=t.data[4],l[5]=t.data[5]):(l[0]=t[0],l[1]=t[1],l[2]=t[2],l[3]=t[3],l[4]=t[4],l[5]=t[5]))}if(u==="mat3x3f"||u==="mat3x3h"){const l=new Float32Array(this.buffer,s,9);return void(t instanceof Wt?(l[0]=t.data[0],l[1]=t.data[1],l[2]=t.data[2],l[3]=t.data[3],l[4]=t.data[4],l[5]=t.data[5],l[6]=t.data[6],l[7]=t.data[7],l[8]=t.data[8]):(l[0]=t[0],l[1]=t[1],l[2]=t[2],l[3]=t[3],l[4]=t[4],l[5]=t[5],l[6]=t[6],l[7]=t[7],l[8]=t[8]))}if(u==="mat3x4f"||u==="mat3x4h"){const l=new Float32Array(this.buffer,s,12);return void(t instanceof Wt?(l[0]=t.data[0],l[1]=t.data[1],l[2]=t.data[2],l[3]=t.data[3],l[4]=t.data[4],l[5]=t.data[5],l[6]=t.data[6],l[7]=t.data[7],l[8]=t.data[8],l[9]=t.data[9],l[10]=t.data[10],l[11]=t.data[11]):(l[0]=t[0],l[1]=t[1],l[2]=t[2],l[3]=t[3],l[4]=t[4],l[5]=t[5],l[6]=t[6],l[7]=t[7],l[8]=t[8],l[9]=t[9],l[10]=t[10],l[11]=t[11]))}if(u==="mat4x2f"||u==="mat4x2h"){const l=new Float32Array(this.buffer,s,8);return void(t instanceof Wt?(l[0]=t.data[0],l[1]=t.data[1],l[2]=t.data[2],l[3]=t.data[3],l[4]=t.data[4],l[5]=t.data[5],l[6]=t.data[6],l[7]=t.data[7]):(l[0]=t[0],l[1]=t[1],l[2]=t[2],l[3]=t[3],l[4]=t[4],l[5]=t[5],l[6]=t[6],l[7]=t[7]))}if(u==="mat4x3f"||u==="mat4x3h"){const l=new Float32Array(this.buffer,s,12);return void(t instanceof Wt?(l[0]=t.data[0],l[1]=t.data[1],l[2]=t.data[2],l[3]=t.data[3],l[4]=t.data[4],l[5]=t.data[5],l[6]=t.data[6],l[7]=t.data[7],l[8]=t.data[8],l[9]=t.data[9],l[10]=t.data[10],l[11]=t.data[11]):(l[0]=t[0],l[1]=t[1],l[2]=t[2],l[3]=t[3],l[4]=t[4],l[5]=t[5],l[6]=t[6],l[7]=t[7],l[8]=t[8],l[9]=t[9],l[10]=t[10],l[11]=t[11]))}if(u==="mat4x4f"||u==="mat4x4h"){const l=new Float32Array(this.buffer,s,16);return void(t instanceof Wt?(l[0]=t.data[0],l[1]=t.data[1],l[2]=t.data[2],l[3]=t.data[3],l[4]=t.data[4],l[5]=t.data[5],l[6]=t.data[6],l[7]=t.data[7],l[8]=t.data[8],l[9]=t.data[9],l[10]=t.data[10],l[11]=t.data[11],l[12]=t.data[12],l[13]=t.data[13],l[14]=t.data[14],l[15]=t.data[15]):(l[0]=t[0],l[1]=t[1],l[2]=t[2],l[3]=t[3],l[4]=t[4],l[5]=t[5],l[6]=t[6],l[7]=t[7],l[8]=t[8],l[9]=t[9],l[10]=t[10],l[11]=t[11],l[12]=t[12],l[13]=t[13],l[14]=t[14],l[15]=t[15]))}if(t instanceof Ki){if(r===t.typeInfo)return void new Uint8Array(this.buffer,s,t.buffer.byteLength).set(new Uint8Array(t.buffer));console.error("SetDataValue: Type mismatch",u,t.typeInfo.getTypeName())}else console.error(`SetData: Unknown type ${u}`)}else t instanceof Ae&&(new Int32Array(this.buffer,s,1)[0]=t.value);else t instanceof Ae&&(new Uint32Array(this.buffer,s,1)[0]=t.value);else t instanceof Ae&&(new Int32Array(this.buffer,s,1)[0]=t.value);else t instanceof Ae&&(new Float32Array(this.buffer,s,1)[0]=t.value)}getSubData(e,t,r){var s,a,u;if(t===null)return this;let l=this.offset,g=this.typeInfo;for(;t;){if(t instanceof vc){const T=t.index,S=T instanceof hn?e.evalExpression(T,r):T;let P=0;if(S instanceof Ae?P=S.value:typeof S=="number"?P=S:console.error("GetDataValue: Invalid index type",T),g instanceof Qo)l+=P*g.stride,g=g.format;else{const O=g.getTypeName();O==="mat4x4"||O==="mat4x4f"||O==="mat4x4h"?(l+=16*P,g=e.getTypeInfo("vec4f")):console.error(`getDataValue: Type ${g.getTypeName()} is not an array`)}}else{if(!(t instanceof Ya))return console.error("GetDataValue: Unknown postfix type",t),null;{const T=t.value;if(g instanceof Zo){let S=!1;for(const P of g.members)if(P.name===T){l+=P.offset,g=P.type,S=!0;break}if(!S)return console.error(`GetDataValue: Member ${T} not found`),null}else if(g instanceof Ys){const S=g.getTypeName();if(S==="vec2f"||S==="vec3f"||S==="vec4f"||S==="vec2i"||S==="vec3i"||S==="vec4i"||S==="vec2u"||S==="vec3u"||S==="vec4u"||S==="vec2b"||S==="vec3b"||S==="vec4b"||S==="vec2h"||S==="vec3h"||S==="vec4h"||S==="vec2"||S==="vec3"||S==="vec4"){if(T.length>0&&T.length<5){let P="f";const O=[];for(let $=0;$<T.length;++$){const W=T[$].toLowerCase();let G=0;if(W==="x"||W==="r")G=0;else if(W==="y"||W==="g")G=1;else if(W==="z"||W==="b")G=2;else{if(W!=="w"&&W!=="a")return console.error(`Unknown member ${T}`),null;G=3}if(T.length===1){if(S.endsWith("f"))return this.buffer.byteLength<l+4*G+4?(console.log("Insufficient buffer data"),null):new Ae(new Float32Array(this.buffer,l+4*G,1),e.getTypeInfo("f32"),this);if(S.endsWith("h"))return new Ae(new Float32Array(this.buffer,l+4*G,1),e.getTypeInfo("f16"),this);if(S.endsWith("i"))return new Ae(new Int32Array(this.buffer,l+4*G,1),e.getTypeInfo("i32"),this);if(S.endsWith("b"))return new Ae(new Int32Array(this.buffer,l+4*G,1),e.getTypeInfo("bool"),this);if(S.endsWith("u"))return new Ae(new Uint32Array(this.buffer,l+4*G,1),e.getTypeInfo("i32"),this)}if(S==="vec2f")O.push(new Float32Array(this.buffer,l,2)[G]);else if(S==="vec3f"){if(l+12>=this.buffer.byteLength)return console.log("Insufficient buffer data"),null;const Q=new Float32Array(this.buffer,l,3);O.push(Q[G])}else if(S==="vec4f")O.push(new Float32Array(this.buffer,l,4)[G]);else if(S==="vec2i")P="i",O.push(new Int32Array(this.buffer,l,2)[G]);else if(S==="vec3i")P="i",O.push(new Int32Array(this.buffer,l,3)[G]);else if(S==="vec4i")P="i",O.push(new Int32Array(this.buffer,l,4)[G]);else if(S==="vec2u"){P="u";const Q=new Uint32Array(this.buffer,l,2);O.push(Q[G])}else S==="vec3u"?(P="u",O.push(new Uint32Array(this.buffer,l,3)[G])):S==="vec4u"&&(P="u",O.push(new Uint32Array(this.buffer,l,4)[G]))}return O.length===2?g=e.getTypeInfo(`vec2${P}`):O.length===3?g=e.getTypeInfo(`vec3${P}`):O.length===4?g=e.getTypeInfo(`vec4${P}`):console.error(`GetDataValue: Invalid vector length ${O.length}`),new ne(O,g,null)}return console.error(`GetDataValue: Unknown member ${T}`),null}return console.error(`GetDataValue: Type ${S} is not a struct`),null}}}t=t.postfix}const v=g.getTypeName();return v==="f32"?new Ae(new Float32Array(this.buffer,l,1),g,this):v==="i32"?new Ae(new Int32Array(this.buffer,l,1),g,this):v==="u32"?new Ae(new Uint32Array(this.buffer,l,1),g,this):v==="vec2f"?new ne(new Float32Array(this.buffer,l,2),g,this):v==="vec3f"?new ne(new Float32Array(this.buffer,l,3),g,this):v==="vec4f"?new ne(new Float32Array(this.buffer,l,4),g,this):v==="vec2i"?new ne(new Int32Array(this.buffer,l,2),g,this):v==="vec3i"?new ne(new Int32Array(this.buffer,l,3),g,this):v==="vec4i"?new ne(new Int32Array(this.buffer,l,4),g,this):v==="vec2u"?new ne(new Uint32Array(this.buffer,l,2),g,this):v==="vec3u"?new ne(new Uint32Array(this.buffer,l,3),g,this):v==="vec4u"?new ne(new Uint32Array(this.buffer,l,4),g,this):g instanceof Za&&g.name==="atomic"?((s=g.format)===null||s===void 0?void 0:s.name)==="u32"?new Ae(new Uint32Array(this.buffer,l,1)[0],g.format,this):((a=g.format)===null||a===void 0?void 0:a.name)==="i32"?new Ae(new Int32Array(this.buffer,l,1)[0],g.format,this):(console.error(`GetDataValue: Invalid atomic format ${(u=g.format)===null||u===void 0?void 0:u.name}`),null):new Ki(this.buffer,g,l,this)}toString(){let e="";if(this.typeInfo instanceof Qo)if(this.typeInfo.format.name==="f32"){const t=new Float32Array(this.buffer,this.offset);e=`[${t[0]}`;for(let r=1;r<t.length;++r)e+=`, ${t[r]}`}else if(this.typeInfo.format.name==="i32"){const t=new Int32Array(this.buffer,this.offset);e=`[${t[0]}`;for(let r=1;r<t.length;++r)e+=`, ${t[r]}`}else if(this.typeInfo.format.name==="u32"){const t=new Uint32Array(this.buffer,this.offset);e=`[${t[0]}`;for(let r=1;r<t.length;++r)e+=`, ${t[r]}`}else if(this.typeInfo.format.name==="vec2f"){const t=new Float32Array(this.buffer,this.offset);e=`[${t[0]}, ${t[1]}]`;for(let r=1;r<t.length/2;++r)e+=`, [${t[2*r]}, ${t[2*r+1]}]`}else if(this.typeInfo.format.name==="vec3f"){const t=new Float32Array(this.buffer,this.offset);e=`[${t[0]}, ${t[1]}, ${t[2]}]`;for(let r=4;r<t.length;r+=4)e+=`, [${t[r]}, ${t[r+1]}, ${t[r+2]}]`}else if(this.typeInfo.format.name==="vec4f"){const t=new Float32Array(this.buffer,this.offset);e=`[${t[0]}, ${t[1]}, ${t[2]}, ${t[3]}]`;for(let r=4;r<t.length;r+=4)e+=`, [${t[r]}, ${t[r+1]}, ${t[r+2]}, ${t[r+3]}]`}else e="[...]";else this.typeInfo instanceof Zo?e+="{...}":e="[...]";return e}}class Kn extends Js{constructor(e,t,r,s){super(t,null),this.data=e,this.descriptor=r,this.view=s}clone(){return new Kn(this.data,this.typeInfo,this.descriptor,this.view)}get width(){var e,t;const r=this.descriptor.size;return r instanceof Array&&r.length>0?(e=r[0])!==null&&e!==void 0?e:0:r instanceof Object&&(t=r.width)!==null&&t!==void 0?t:0}get height(){var e,t;const r=this.descriptor.size;return r instanceof Array&&r.length>1?(e=r[1])!==null&&e!==void 0?e:0:r instanceof Object&&(t=r.height)!==null&&t!==void 0?t:0}get depthOrArrayLayers(){var e,t;const r=this.descriptor.size;return r instanceof Array&&r.length>2?(e=r[2])!==null&&e!==void 0?e:0:r instanceof Object&&(t=r.depthOrArrayLayers)!==null&&t!==void 0?t:0}get format(){var e;return this.descriptor&&(e=this.descriptor.format)!==null&&e!==void 0?e:"rgba8unorm"}get sampleCount(){var e;return this.descriptor&&(e=this.descriptor.sampleCount)!==null&&e!==void 0?e:1}get mipLevelCount(){var e;return this.descriptor&&(e=this.descriptor.mipLevelCount)!==null&&e!==void 0?e:1}get dimension(){var e;return this.descriptor&&(e=this.descriptor.dimension)!==null&&e!==void 0?e:"2d"}getMipLevelSize(e){if(e>=this.mipLevelCount)return[0,0,0];const t=[this.width,this.height,this.depthOrArrayLayers];for(let r=0;r<t.length;++r)t[r]=Math.max(1,t[r]>>e);return t}get texelByteSize(){const e=this.format,t=sm[e];return t?t.isDepthStencil?4:t.bytesPerBlock:0}get bytesPerRow(){return this.width*this.texelByteSize}get isDepthStencil(){const e=this.format,t=sm[e];return!!t&&t.isDepthStencil}getGpuSize(){const e=this.format,t=sm[e],r=this.width;if(!e||r<=0||!t)return-1;const s=this.height,a=this.depthOrArrayLayers,u=this.dimension;return r/t.blockWidth*(u==="1d"?1:s/t.blockHeight)*t.bytesPerBlock*a}getPixel(e,t,r=0,s=0){const a=this.texelByteSize,u=this.bytesPerRow,l=this.height,g=this.data[s];return MP(new Uint8Array(g),e,t,r,s,l,u,a,this.format)}setPixel(e,t,r,s,a){const u=this.texelByteSize,l=this.bytesPerRow,g=this.height,v=this.data[s];(function(T,S,P,O,$,W,G,Q,ae,te){const me=O*(G>>=$)*(W>>=$)+P*G+S*Q;switch(ae){case"r8unorm":return void yi(T,me,"8unorm",1,te);case"r8snorm":return void yi(T,me,"8snorm",1,te);case"r8uint":return void yi(T,me,"8uint",1,te);case"r8sint":return void yi(T,me,"8sint",1,te);case"rg8unorm":return void yi(T,me,"8unorm",2,te);case"rg8snorm":return void yi(T,me,"8snorm",2,te);case"rg8uint":return void yi(T,me,"8uint",2,te);case"rg8sint":return void yi(T,me,"8sint",2,te);case"rgba8unorm-srgb":case"rgba8unorm":case"bgra8unorm-srgb":case"bgra8unorm":return void yi(T,me,"8unorm",4,te);case"rgba8snorm":return void yi(T,me,"8snorm",4,te);case"rgba8uint":return void yi(T,me,"8uint",4,te);case"rgba8sint":return void yi(T,me,"8sint",4,te);case"r16uint":return void yi(T,me,"16uint",1,te);case"r16sint":return void yi(T,me,"16sint",1,te);case"r16float":return void yi(T,me,"16float",1,te);case"rg16uint":return void yi(T,me,"16uint",2,te);case"rg16sint":return void yi(T,me,"16sint",2,te);case"rg16float":return void yi(T,me,"16float",2,te);case"rgba16uint":return void yi(T,me,"16uint",4,te);case"rgba16sint":return void yi(T,me,"16sint",4,te);case"rgba16float":return void yi(T,me,"16float",4,te);case"r32uint":return void yi(T,me,"32uint",1,te);case"r32sint":return void yi(T,me,"32sint",1,te);case"depth16unorm":case"depth24plus":case"depth24plus-stencil8":case"depth32float":case"depth32float-stencil8":case"r32float":return void yi(T,me,"32float",1,te);case"rg32uint":return void yi(T,me,"32uint",2,te);case"rg32sint":return void yi(T,me,"32sint",2,te);case"rg32float":return void yi(T,me,"32float",2,te);case"rgba32uint":return void yi(T,me,"32uint",4,te);case"rgba32sint":return void yi(T,me,"32sint",4,te);case"rgba32float":return void yi(T,me,"32float",4,te);case"rg11b10ufloat":console.error("TODO: rg11b10ufloat not supported for writing")}})(new Uint8Array(v),e,t,r,s,g,l,u,this.format,a)}}(i=>{i[i.token=0]="token",i[i.keyword=1]="keyword",i[i.reserved=2]="reserved"})(Ie||(Ie={}));class Pe{constructor(e,t,r){this.name=e,this.type=t,this.rule=r}toString(){return this.name}}class J{}Fe=J,J.none=new Pe("",Ie.reserved,""),J.eof=new Pe("EOF",Ie.token,""),J.reserved={asm:new Pe("asm",Ie.reserved,"asm"),bf16:new Pe("bf16",Ie.reserved,"bf16"),do:new Pe("do",Ie.reserved,"do"),enum:new Pe("enum",Ie.reserved,"enum"),f16:new Pe("f16",Ie.reserved,"f16"),f64:new Pe("f64",Ie.reserved,"f64"),handle:new Pe("handle",Ie.reserved,"handle"),i8:new Pe("i8",Ie.reserved,"i8"),i16:new Pe("i16",Ie.reserved,"i16"),i64:new Pe("i64",Ie.reserved,"i64"),mat:new Pe("mat",Ie.reserved,"mat"),premerge:new Pe("premerge",Ie.reserved,"premerge"),regardless:new Pe("regardless",Ie.reserved,"regardless"),typedef:new Pe("typedef",Ie.reserved,"typedef"),u8:new Pe("u8",Ie.reserved,"u8"),u16:new Pe("u16",Ie.reserved,"u16"),u64:new Pe("u64",Ie.reserved,"u64"),unless:new Pe("unless",Ie.reserved,"unless"),using:new Pe("using",Ie.reserved,"using"),vec:new Pe("vec",Ie.reserved,"vec"),void:new Pe("void",Ie.reserved,"void")},J.keywords={array:new Pe("array",Ie.keyword,"array"),atomic:new Pe("atomic",Ie.keyword,"atomic"),bool:new Pe("bool",Ie.keyword,"bool"),f32:new Pe("f32",Ie.keyword,"f32"),i32:new Pe("i32",Ie.keyword,"i32"),mat2x2:new Pe("mat2x2",Ie.keyword,"mat2x2"),mat2x3:new Pe("mat2x3",Ie.keyword,"mat2x3"),mat2x4:new Pe("mat2x4",Ie.keyword,"mat2x4"),mat3x2:new Pe("mat3x2",Ie.keyword,"mat3x2"),mat3x3:new Pe("mat3x3",Ie.keyword,"mat3x3"),mat3x4:new Pe("mat3x4",Ie.keyword,"mat3x4"),mat4x2:new Pe("mat4x2",Ie.keyword,"mat4x2"),mat4x3:new Pe("mat4x3",Ie.keyword,"mat4x3"),mat4x4:new Pe("mat4x4",Ie.keyword,"mat4x4"),ptr:new Pe("ptr",Ie.keyword,"ptr"),sampler:new Pe("sampler",Ie.keyword,"sampler"),sampler_comparison:new Pe("sampler_comparison",Ie.keyword,"sampler_comparison"),struct:new Pe("struct",Ie.keyword,"struct"),texture_1d:new Pe("texture_1d",Ie.keyword,"texture_1d"),texture_2d:new Pe("texture_2d",Ie.keyword,"texture_2d"),texture_2d_array:new Pe("texture_2d_array",Ie.keyword,"texture_2d_array"),texture_3d:new Pe("texture_3d",Ie.keyword,"texture_3d"),texture_cube:new Pe("texture_cube",Ie.keyword,"texture_cube"),texture_cube_array:new Pe("texture_cube_array",Ie.keyword,"texture_cube_array"),texture_multisampled_2d:new Pe("texture_multisampled_2d",Ie.keyword,"texture_multisampled_2d"),texture_storage_1d:new Pe("texture_storage_1d",Ie.keyword,"texture_storage_1d"),texture_storage_2d:new Pe("texture_storage_2d",Ie.keyword,"texture_storage_2d"),texture_storage_2d_array:new Pe("texture_storage_2d_array",Ie.keyword,"texture_storage_2d_array"),texture_storage_3d:new Pe("texture_storage_3d",Ie.keyword,"texture_storage_3d"),texture_depth_2d:new Pe("texture_depth_2d",Ie.keyword,"texture_depth_2d"),texture_depth_2d_array:new Pe("texture_depth_2d_array",Ie.keyword,"texture_depth_2d_array"),texture_depth_cube:new Pe("texture_depth_cube",Ie.keyword,"texture_depth_cube"),texture_depth_cube_array:new Pe("texture_depth_cube_array",Ie.keyword,"texture_depth_cube_array"),texture_depth_multisampled_2d:new Pe("texture_depth_multisampled_2d",Ie.keyword,"texture_depth_multisampled_2d"),texture_external:new Pe("texture_external",Ie.keyword,"texture_external"),u32:new Pe("u32",Ie.keyword,"u32"),vec2:new Pe("vec2",Ie.keyword,"vec2"),vec3:new Pe("vec3",Ie.keyword,"vec3"),vec4:new Pe("vec4",Ie.keyword,"vec4"),bitcast:new Pe("bitcast",Ie.keyword,"bitcast"),block:new Pe("block",Ie.keyword,"block"),break:new Pe("break",Ie.keyword,"break"),case:new Pe("case",Ie.keyword,"case"),continue:new Pe("continue",Ie.keyword,"continue"),continuing:new Pe("continuing",Ie.keyword,"continuing"),default:new Pe("default",Ie.keyword,"default"),diagnostic:new Pe("diagnostic",Ie.keyword,"diagnostic"),discard:new Pe("discard",Ie.keyword,"discard"),else:new Pe("else",Ie.keyword,"else"),enable:new Pe("enable",Ie.keyword,"enable"),fallthrough:new Pe("fallthrough",Ie.keyword,"fallthrough"),false:new Pe("false",Ie.keyword,"false"),fn:new Pe("fn",Ie.keyword,"fn"),for:new Pe("for",Ie.keyword,"for"),function:new Pe("function",Ie.keyword,"function"),if:new Pe("if",Ie.keyword,"if"),let:new Pe("let",Ie.keyword,"let"),const:new Pe("const",Ie.keyword,"const"),loop:new Pe("loop",Ie.keyword,"loop"),while:new Pe("while",Ie.keyword,"while"),private:new Pe("private",Ie.keyword,"private"),read:new Pe("read",Ie.keyword,"read"),read_write:new Pe("read_write",Ie.keyword,"read_write"),return:new Pe("return",Ie.keyword,"return"),requires:new Pe("requires",Ie.keyword,"requires"),storage:new Pe("storage",Ie.keyword,"storage"),switch:new Pe("switch",Ie.keyword,"switch"),true:new Pe("true",Ie.keyword,"true"),alias:new Pe("alias",Ie.keyword,"alias"),type:new Pe("type",Ie.keyword,"type"),uniform:new Pe("uniform",Ie.keyword,"uniform"),var:new Pe("var",Ie.keyword,"var"),override:new Pe("override",Ie.keyword,"override"),workgroup:new Pe("workgroup",Ie.keyword,"workgroup"),write:new Pe("write",Ie.keyword,"write"),r8unorm:new Pe("r8unorm",Ie.keyword,"r8unorm"),r8snorm:new Pe("r8snorm",Ie.keyword,"r8snorm"),r8uint:new Pe("r8uint",Ie.keyword,"r8uint"),r8sint:new Pe("r8sint",Ie.keyword,"r8sint"),r16uint:new Pe("r16uint",Ie.keyword,"r16uint"),r16sint:new Pe("r16sint",Ie.keyword,"r16sint"),r16float:new Pe("r16float",Ie.keyword,"r16float"),rg8unorm:new Pe("rg8unorm",Ie.keyword,"rg8unorm"),rg8snorm:new Pe("rg8snorm",Ie.keyword,"rg8snorm"),rg8uint:new Pe("rg8uint",Ie.keyword,"rg8uint"),rg8sint:new Pe("rg8sint",Ie.keyword,"rg8sint"),r32uint:new Pe("r32uint",Ie.keyword,"r32uint"),r32sint:new Pe("r32sint",Ie.keyword,"r32sint"),r32float:new Pe("r32float",Ie.keyword,"r32float"),rg16uint:new Pe("rg16uint",Ie.keyword,"rg16uint"),rg16sint:new Pe("rg16sint",Ie.keyword,"rg16sint"),rg16float:new Pe("rg16float",Ie.keyword,"rg16float"),rgba8unorm:new Pe("rgba8unorm",Ie.keyword,"rgba8unorm"),rgba8unorm_srgb:new Pe("rgba8unorm_srgb",Ie.keyword,"rgba8unorm_srgb"),rgba8snorm:new Pe("rgba8snorm",Ie.keyword,"rgba8snorm"),rgba8uint:new Pe("rgba8uint",Ie.keyword,"rgba8uint"),rgba8sint:new Pe("rgba8sint",Ie.keyword,"rgba8sint"),bgra8unorm:new Pe("bgra8unorm",Ie.keyword,"bgra8unorm"),bgra8unorm_srgb:new Pe("bgra8unorm_srgb",Ie.keyword,"bgra8unorm_srgb"),rgb10a2unorm:new Pe("rgb10a2unorm",Ie.keyword,"rgb10a2unorm"),rg11b10float:new Pe("rg11b10float",Ie.keyword,"rg11b10float"),rg32uint:new Pe("rg32uint",Ie.keyword,"rg32uint"),rg32sint:new Pe("rg32sint",Ie.keyword,"rg32sint"),rg32float:new Pe("rg32float",Ie.keyword,"rg32float"),rgba16uint:new Pe("rgba16uint",Ie.keyword,"rgba16uint"),rgba16sint:new Pe("rgba16sint",Ie.keyword,"rgba16sint"),rgba16float:new Pe("rgba16float",Ie.keyword,"rgba16float"),rgba32uint:new Pe("rgba32uint",Ie.keyword,"rgba32uint"),rgba32sint:new Pe("rgba32sint",Ie.keyword,"rgba32sint"),rgba32float:new Pe("rgba32float",Ie.keyword,"rgba32float"),static_assert:new Pe("static_assert",Ie.keyword,"static_assert")},J.tokens={decimal_float_literal:new Pe("decimal_float_literal",Ie.token,/((-?[0-9]*\.[0-9]+|-?[0-9]+\.[0-9]*)((e|E)(\+|-)?[0-9]+)?[fh]?)|(-?[0-9]+(e|E)(\+|-)?[0-9]+[fh]?)|(-?[0-9]+[fh])/),hex_float_literal:new Pe("hex_float_literal",Ie.token,/-?0x((([0-9a-fA-F]*\.[0-9a-fA-F]+|[0-9a-fA-F]+\.[0-9a-fA-F]*)((p|P)(\+|-)?[0-9]+[fh]?)?)|([0-9a-fA-F]+(p|P)(\+|-)?[0-9]+[fh]?))/),int_literal:new Pe("int_literal",Ie.token,/-?0x[0-9a-fA-F]+|0i?|-?[1-9][0-9]*i?/),uint_literal:new Pe("uint_literal",Ie.token,/0x[0-9a-fA-F]+u|0u|[1-9][0-9]*u/),name:new Pe("name",Ie.token,/([_\p{XID_Start}][\p{XID_Continue}]+)|([\p{XID_Start}])/u),ident:new Pe("ident",Ie.token,/[_a-zA-Z][0-9a-zA-Z_]*/),and:new Pe("and",Ie.token,"&"),and_and:new Pe("and_and",Ie.token,"&&"),arrow:new Pe("arrow ",Ie.token,"->"),attr:new Pe("attr",Ie.token,"@"),forward_slash:new Pe("forward_slash",Ie.token,"/"),bang:new Pe("bang",Ie.token,"!"),bracket_left:new Pe("bracket_left",Ie.token,"["),bracket_right:new Pe("bracket_right",Ie.token,"]"),brace_left:new Pe("brace_left",Ie.token,"{"),brace_right:new Pe("brace_right",Ie.token,"}"),colon:new Pe("colon",Ie.token,":"),comma:new Pe("comma",Ie.token,","),equal:new Pe("equal",Ie.token,"="),equal_equal:new Pe("equal_equal",Ie.token,"=="),not_equal:new Pe("not_equal",Ie.token,"!="),greater_than:new Pe("greater_than",Ie.token,">"),greater_than_equal:new Pe("greater_than_equal",Ie.token,">="),shift_right:new Pe("shift_right",Ie.token,">>"),less_than:new Pe("less_than",Ie.token,"<"),less_than_equal:new Pe("less_than_equal",Ie.token,"<="),shift_left:new Pe("shift_left",Ie.token,"<<"),modulo:new Pe("modulo",Ie.token,"%"),minus:new Pe("minus",Ie.token,"-"),minus_minus:new Pe("minus_minus",Ie.token,"--"),period:new Pe("period",Ie.token,"."),plus:new Pe("plus",Ie.token,"+"),plus_plus:new Pe("plus_plus",Ie.token,"++"),or:new Pe("or",Ie.token,"|"),or_or:new Pe("or_or",Ie.token,"||"),paren_left:new Pe("paren_left",Ie.token,"("),paren_right:new Pe("paren_right",Ie.token,")"),semicolon:new Pe("semicolon",Ie.token,";"),star:new Pe("star",Ie.token,"*"),tilde:new Pe("tilde",Ie.token,"~"),underscore:new Pe("underscore",Ie.token,"_"),xor:new Pe("xor",Ie.token,"^"),plus_equal:new Pe("plus_equal",Ie.token,"+="),minus_equal:new Pe("minus_equal",Ie.token,"-="),times_equal:new Pe("times_equal",Ie.token,"*="),division_equal:new Pe("division_equal",Ie.token,"/="),modulo_equal:new Pe("modulo_equal",Ie.token,"%="),and_equal:new Pe("and_equal",Ie.token,"&="),or_equal:new Pe("or_equal",Ie.token,"|="),xor_equal:new Pe("xor_equal",Ie.token,"^="),shift_right_equal:new Pe("shift_right_equal",Ie.token,">>="),shift_left_equal:new Pe("shift_left_equal",Ie.token,"<<=")},J.simpleTokens={"@":Fe.tokens.attr,"{":Fe.tokens.brace_left,"}":Fe.tokens.brace_right,":":Fe.tokens.colon,",":Fe.tokens.comma,"(":Fe.tokens.paren_left,")":Fe.tokens.paren_right,";":Fe.tokens.semicolon},J.literalTokens={"&":Fe.tokens.and,"&&":Fe.tokens.and_and,"->":Fe.tokens.arrow,"/":Fe.tokens.forward_slash,"!":Fe.tokens.bang,"[":Fe.tokens.bracket_left,"]":Fe.tokens.bracket_right,"=":Fe.tokens.equal,"==":Fe.tokens.equal_equal,"!=":Fe.tokens.not_equal,">":Fe.tokens.greater_than,">=":Fe.tokens.greater_than_equal,">>":Fe.tokens.shift_right,"<":Fe.tokens.less_than,"<=":Fe.tokens.less_than_equal,"<<":Fe.tokens.shift_left,"%":Fe.tokens.modulo,"-":Fe.tokens.minus,"--":Fe.tokens.minus_minus,".":Fe.tokens.period,"+":Fe.tokens.plus,"++":Fe.tokens.plus_plus,"|":Fe.tokens.or,"||":Fe.tokens.or_or,"*":Fe.tokens.star,"~":Fe.tokens.tilde,_:Fe.tokens.underscore,"^":Fe.tokens.xor,"+=":Fe.tokens.plus_equal,"-=":Fe.tokens.minus_equal,"*=":Fe.tokens.times_equal,"/=":Fe.tokens.division_equal,"%=":Fe.tokens.modulo_equal,"&=":Fe.tokens.and_equal,"|=":Fe.tokens.or_equal,"^=":Fe.tokens.xor_equal,">>=":Fe.tokens.shift_right_equal,"<<=":Fe.tokens.shift_left_equal},J.regexTokens={decimal_float_literal:Fe.tokens.decimal_float_literal,hex_float_literal:Fe.tokens.hex_float_literal,int_literal:Fe.tokens.int_literal,uint_literal:Fe.tokens.uint_literal,ident:Fe.tokens.ident},J.storage_class=[Fe.keywords.function,Fe.keywords.private,Fe.keywords.workgroup,Fe.keywords.uniform,Fe.keywords.storage],J.access_mode=[Fe.keywords.read,Fe.keywords.write,Fe.keywords.read_write],J.sampler_type=[Fe.keywords.sampler,Fe.keywords.sampler_comparison],J.sampled_texture_type=[Fe.keywords.texture_1d,Fe.keywords.texture_2d,Fe.keywords.texture_2d_array,Fe.keywords.texture_3d,Fe.keywords.texture_cube,Fe.keywords.texture_cube_array],J.multisampled_texture_type=[Fe.keywords.texture_multisampled_2d],J.storage_texture_type=[Fe.keywords.texture_storage_1d,Fe.keywords.texture_storage_2d,Fe.keywords.texture_storage_2d_array,Fe.keywords.texture_storage_3d],J.depth_texture_type=[Fe.keywords.texture_depth_2d,Fe.keywords.texture_depth_2d_array,Fe.keywords.texture_depth_cube,Fe.keywords.texture_depth_cube_array,Fe.keywords.texture_depth_multisampled_2d],J.texture_external_type=[Fe.keywords.texture_external],J.any_texture_type=[...Fe.sampled_texture_type,...Fe.multisampled_texture_type,...Fe.storage_texture_type,...Fe.depth_texture_type,...Fe.texture_external_type],J.texel_format=[Fe.keywords.r8unorm,Fe.keywords.r8snorm,Fe.keywords.r8uint,Fe.keywords.r8sint,Fe.keywords.r16uint,Fe.keywords.r16sint,Fe.keywords.r16float,Fe.keywords.rg8unorm,Fe.keywords.rg8snorm,Fe.keywords.rg8uint,Fe.keywords.rg8sint,Fe.keywords.r32uint,Fe.keywords.r32sint,Fe.keywords.r32float,Fe.keywords.rg16uint,Fe.keywords.rg16sint,Fe.keywords.rg16float,Fe.keywords.rgba8unorm,Fe.keywords.rgba8unorm_srgb,Fe.keywords.rgba8snorm,Fe.keywords.rgba8uint,Fe.keywords.rgba8sint,Fe.keywords.bgra8unorm,Fe.keywords.bgra8unorm_srgb,Fe.keywords.rgb10a2unorm,Fe.keywords.rg11b10float,Fe.keywords.rg32uint,Fe.keywords.rg32sint,Fe.keywords.rg32float,Fe.keywords.rgba16uint,Fe.keywords.rgba16sint,Fe.keywords.rgba16float,Fe.keywords.rgba32uint,Fe.keywords.rgba32sint,Fe.keywords.rgba32float],J.const_literal=[Fe.tokens.int_literal,Fe.tokens.uint_literal,Fe.tokens.decimal_float_literal,Fe.tokens.hex_float_literal,Fe.keywords.true,Fe.keywords.false],J.literal_or_ident=[Fe.tokens.ident,Fe.tokens.int_literal,Fe.tokens.uint_literal,Fe.tokens.decimal_float_literal,Fe.tokens.hex_float_literal,Fe.tokens.name],J.element_count_expression=[Fe.tokens.int_literal,Fe.tokens.uint_literal,Fe.tokens.ident],J.template_types=[Fe.keywords.vec2,Fe.keywords.vec3,Fe.keywords.vec4,Fe.keywords.mat2x2,Fe.keywords.mat2x3,Fe.keywords.mat2x4,Fe.keywords.mat3x2,Fe.keywords.mat3x3,Fe.keywords.mat3x4,Fe.keywords.mat4x2,Fe.keywords.mat4x3,Fe.keywords.mat4x4,Fe.keywords.atomic,Fe.keywords.bitcast,...Fe.any_texture_type],J.attribute_name=[Fe.tokens.ident,Fe.keywords.block,Fe.keywords.diagnostic],J.assignment_operators=[Fe.tokens.equal,Fe.tokens.plus_equal,Fe.tokens.minus_equal,Fe.tokens.times_equal,Fe.tokens.division_equal,Fe.tokens.modulo_equal,Fe.tokens.and_equal,Fe.tokens.or_equal,Fe.tokens.xor_equal,Fe.tokens.shift_right_equal,Fe.tokens.shift_left_equal],J.increment_operators=[Fe.tokens.plus_plus,Fe.tokens.minus_minus];class yb{constructor(e,t,r,s,a){this.type=e,this.lexeme=t,this.line=r,this.start=s,this.end=a}toString(){return this.lexeme}isTemplateType(){return J.template_types.indexOf(this.type)!=-1}isArrayType(){return this.type==J.keywords.array}isArrayOrTemplateType(){return this.isArrayType()||this.isTemplateType()}}class BP{constructor(e){this._tokens=[],this._start=0,this._current=0,this._line=1,this._source=e??""}scanTokens(){for(;!this._isAtEnd();)if(this._start=this._current,!this.scanToken())throw`Invalid syntax at line ${this._line}`;return this._tokens.push(new yb(J.eof,"",this._line,this._current,this._current)),this._tokens}scanToken(){let e=this._advance();if(e==`
`)return this._line++,!0;if(this._isWhitespace(e))return!0;if(e=="/"){if(this._peekAhead()=="/"){for(;e!=`
`;){if(this._isAtEnd())return!0;e=this._advance()}return this._line++,!0}if(this._peekAhead()=="*"){this._advance();let u=1;for(;u>0;){if(this._isAtEnd())return!0;if(e=this._advance(),e==`
`)this._line++;else if(e=="*"){if(this._peekAhead()=="/"&&(this._advance(),u--,u==0))return!0}else e=="/"&&this._peekAhead()=="*"&&(this._advance(),u++)}return!0}}const t=J.simpleTokens[e];if(t)return this._addToken(t),!0;let r=J.none;const s=this._isAlpha(e),a=e==="_";if(this._isAlphaNumeric(e)){let u=this._peekAhead();for(;this._isAlphaNumeric(u);)e+=this._advance(),u=this._peekAhead()}if(s){const u=J.keywords[e];if(u)return this._addToken(u),!0}if(s||a)return this._addToken(J.tokens.ident),!0;for(;;){let u=this._findType(e);const l=this._peekAhead();if(e=="-"&&this._tokens.length>0){if(l=="=")return this._current++,e+=l,this._addToken(J.tokens.minus_equal),!0;if(l=="-")return this._current++,e+=l,this._addToken(J.tokens.minus_minus),!0;const g=this._tokens.length-1;if((J.literal_or_ident.indexOf(this._tokens[g].type)!=-1||this._tokens[g].type==J.tokens.paren_right)&&l!=">")return this._addToken(u),!0}if(e==">"&&(l==">"||l=="=")){let g=!1,v=this._tokens.length-1;for(let T=0;T<5&&v>=0&&J.assignment_operators.indexOf(this._tokens[v].type)===-1;++T,--v)if(this._tokens[v].type===J.tokens.less_than){v>0&&this._tokens[v-1].isArrayOrTemplateType()&&(g=!0);break}if(g)return this._addToken(u),!0}if(u===J.none){let g=e,v=0;const T=2;for(let S=0;S<T;++S)if(g+=this._peekAhead(S),u=this._findType(g),u!==J.none){v=S;break}if(u===J.none)return r!==J.none&&(this._current--,this._addToken(r),!0);e=g,this._current+=v+1}if(r=u,this._isAtEnd())break;e+=this._advance()}return r!==J.none&&(this._addToken(r),!0)}_findType(e){for(const r in J.regexTokens){const s=J.regexTokens[r];if(this._match(e,s.rule))return s}return J.literalTokens[e]||J.none}_match(e,t){const r=t.exec(e);return r&&r.index==0&&r[0]==e}_isAtEnd(){return this._current>=this._source.length}_isAlpha(e){return!this._isNumeric(e)&&!this._isWhitespace(e)&&e!=="_"&&e!=="."&&e!=="("&&e!==")"&&e!=="["&&e!=="]"&&e!=="{"&&e!=="}"&&e!==","&&e!==";"&&e!==":"&&e!=="="&&e!=="!"&&e!=="<"&&e!==">"&&e!=="+"&&e!=="-"&&e!=="*"&&e!=="/"&&e!=="%"&&e!=="&"&&e!=="|"&&e!=="^"&&e!=="~"&&e!=="@"&&e!=="#"&&e!=="?"&&e!=="'"&&e!=="`"&&e!=='"'&&e!=="\\"&&e!==`
`&&e!=="\r"&&e!=="	"&&e!=="\0"}_isNumeric(e){return e>="0"&&e<="9"}_isAlphaNumeric(e){return this._isAlpha(e)||this._isNumeric(e)||e==="_"}_isWhitespace(e){return e==" "||e=="	"||e=="\r"}_advance(e=0){let t=this._source[this._current];return e=e||0,e++,this._current+=e,t}_peekAhead(e=0){return e=e||0,this._current+e>=this._source.length?"\0":this._source[this._current+e]}_addToken(e){const t=this._source.substring(this._start,this._current);this._tokens.push(new yb(e,t,this._line,this._start,this._current))}}function bt(i){return Array.isArray(i)||i?.buffer instanceof ArrayBuffer}const ip=new Float32Array(1),NP=new Uint32Array(ip.buffer),zP=new Uint32Array(ip.buffer),rp=new Int32Array(1),UP=new Float32Array(rp.buffer),VP=new Uint32Array(rp.buffer),sp=new Uint32Array(1),jP=new Float32Array(sp.buffer),$P=new Int32Array(sp.buffer);function xb(i,e,t){if(e===t)return i;if(e==="f32"){if(t==="i32"||t==="x32")return ip[0]=i,NP[0];if(t==="u32")return ip[0]=i,zP[0]}else if(e==="i32"||e==="x32"){if(t==="f32")return rp[0]=i,UP[0];if(t==="u32")return rp[0]=i,VP[0]}else if(e==="u32"){if(t==="f32")return sp[0]=i,jP[0];if(t==="i32"||t==="x32")return sp[0]=i,$P[0]}return console.error(`Unsupported cast from ${e} to ${t}`),i}class WP{constructor(e){this.resources=null,this.inUse=!1,this.info=null,this.node=e}}class ef{constructor(e,t){this.align=e,this.size=t}}class En{constructor(){this.uniforms=[],this.storage=[],this.textures=[],this.samplers=[],this.aliases=[],this.overrides=[],this.structs=[],this.entry=new EP,this.functions=[],this._types=new Map,this._functions=new Map}_isStorageTexture(e){return e.name=="texture_storage_1d"||e.name=="texture_storage_2d"||e.name=="texture_storage_2d_array"||e.name=="texture_storage_3d"}updateAST(e){for(const t of e)t instanceof Ph&&this._functions.set(t.name,new WP(t));for(const t of e)if(t instanceof Gn){const r=this.getTypeInfo(t,null);r instanceof Zo&&this.structs.push(r)}for(const t of e)if(t instanceof iy)this.aliases.push(this._getAliasInfo(t));else{if(t instanceof ey){const r=t,s=this._getAttributeNum(r.attributes,"id",0),a=r.type!=null?this.getTypeInfo(r.type,r.attributes):null;this.overrides.push(new TP(r.name,a,r.attributes,s));continue}if(this._isUniformVar(t)){const r=t,s=this._getAttributeNum(r.attributes,"group",0),a=this._getAttributeNum(r.attributes,"binding",0),u=this.getTypeInfo(r.type,r.attributes),l=new Qd(r.name,u,s,a,r.attributes,Ho.Uniform,r.access);l.access||(l.access="read"),this.uniforms.push(l);continue}if(this._isStorageVar(t)){const r=t,s=this._getAttributeNum(r.attributes,"group",0),a=this._getAttributeNum(r.attributes,"binding",0),u=this.getTypeInfo(r.type,r.attributes),l=this._isStorageTexture(u),g=new Qd(r.name,u,s,a,r.attributes,l?Ho.StorageTexture:Ho.Storage,r.access);g.access||(g.access="read"),this.storage.push(g);continue}if(this._isTextureVar(t)){const r=t,s=this._getAttributeNum(r.attributes,"group",0),a=this._getAttributeNum(r.attributes,"binding",0),u=this.getTypeInfo(r.type,r.attributes),l=this._isStorageTexture(u),g=new Qd(r.name,u,s,a,r.attributes,l?Ho.StorageTexture:Ho.Texture,r.access);g.access||(g.access="read"),l?this.storage.push(g):this.textures.push(g);continue}if(this._isSamplerVar(t)){const r=t,s=this._getAttributeNum(r.attributes,"group",0),a=this._getAttributeNum(r.attributes,"binding",0),u=this.getTypeInfo(r.type,r.attributes),l=new Qd(r.name,u,s,a,r.attributes,Ho.Sampler,r.access);this.samplers.push(l);continue}}for(const t of e)if(t instanceof Ph){const r=this._getAttribute(t,"vertex"),s=this._getAttribute(t,"fragment"),a=this._getAttribute(t,"compute"),u=r||s||a,l=new AP(t.name,u?.name,t.attributes);l.attributes=t.attributes,l.startLine=t.startLine,l.endLine=t.endLine,this.functions.push(l),this._functions.get(t.name).info=l,u&&(this._functions.get(t.name).inUse=!0,l.inUse=!0,l.resources=this._findResources(t,!!u),l.inputs=this._getInputs(t.args),l.outputs=this._getOutputs(t.returnType),this.entry[u.name].push(l)),l.arguments=t.args.map(g=>new SP(g.name,this.getTypeInfo(g.type,g.attributes),g.attributes)),l.returnType=t.returnType?this.getTypeInfo(t.returnType,t.attributes):null;continue}for(const t of this._functions.values())t.info&&(t.info.inUse=t.inUse,this._addCalls(t.node,t.info.calls));for(const t of this._functions.values())t.node.search(r=>{var s,a,u;if(r instanceof n2){if(r.value)if(bt(r.value))for(const l of r.value)for(const g of this.overrides)l===g.name&&((s=t.info)===null||s===void 0||s.overrides.push(g));else for(const l of this.overrides)r.value===l.name&&((a=t.info)===null||a===void 0||a.overrides.push(l))}else if(r instanceof Ls)for(const l of this.overrides)r.name===l.name&&((u=t.info)===null||u===void 0||u.overrides.push(l))});for(const t of this.uniforms)this._markStructsInUse(t.type);for(const t of this.storage)this._markStructsInUse(t.type)}getFunctionInfo(e){for(const t of this.functions)if(t.name==e)return t;return null}getStructInfo(e){for(const t of this.structs)if(t.name==e)return t;return null}getOverrideInfo(e){for(const t of this.overrides)if(t.name==e)return t;return null}_markStructsInUse(e){if(e)if(e.isStruct){if(e.inUse=!0,e.members)for(const t of e.members)this._markStructsInUse(t.type)}else if(e.isArray)this._markStructsInUse(e.format);else if(e.isTemplate)e.format&&this._markStructsInUse(e.format);else{const t=this._getAlias(e.name);t&&this._markStructsInUse(t)}}_addCalls(e,t){var r;for(const s of e.calls){const a=(r=this._functions.get(s.name))===null||r===void 0?void 0:r.info;a&&t.add(a)}}findResource(e,t,r){if(r){for(const s of this.entry.compute)if(s.name===r){for(const a of s.resources)if(a.group==e&&a.binding==t)return a}for(const s of this.entry.vertex)if(s.name===r){for(const a of s.resources)if(a.group==e&&a.binding==t)return a}for(const s of this.entry.fragment)if(s.name===r){for(const a of s.resources)if(a.group==e&&a.binding==t)return a}}for(const s of this.uniforms)if(s.group==e&&s.binding==t)return s;for(const s of this.storage)if(s.group==e&&s.binding==t)return s;for(const s of this.textures)if(s.group==e&&s.binding==t)return s;for(const s of this.samplers)if(s.group==e&&s.binding==t)return s;return null}_findResource(e){for(const t of this.uniforms)if(t.name==e)return t;for(const t of this.storage)if(t.name==e)return t;for(const t of this.textures)if(t.name==e)return t;for(const t of this.samplers)if(t.name==e)return t;return null}_markStructsFromAST(e){const t=this.getTypeInfo(e,null);this._markStructsInUse(t)}_findResources(e,t){const r=[],s=this,a=[];return e.search(u=>{if(u instanceof ep)a.push({});else if(u instanceof tp)a.pop();else if(u instanceof Jn){const l=u;t&&l.type!==null&&this._markStructsFromAST(l.type),a.length>0&&(a[a.length-1][l.name]=l)}else if(u instanceof Tn){const l=u;t&&l.type!==null&&this._markStructsFromAST(l.type)}else if(u instanceof xh){const l=u;t&&l.type!==null&&this._markStructsFromAST(l.type),a.length>0&&(a[a.length-1][l.name]=l)}else if(u instanceof Ls){const l=u;if(a.length>0&&a[a.length-1][l.name])return;const g=s._findResource(l.name);g&&r.push(g)}else if(u instanceof ry){const l=u,g=s._functions.get(l.name);g&&(t&&(g.inUse=!0),e.calls.add(g.node),g.resources===null&&(g.resources=s._findResources(g.node,t)),r.push(...g.resources))}else if(u instanceof ty){const l=u,g=s._functions.get(l.name);g&&(t&&(g.inUse=!0),e.calls.add(g.node),g.resources===null&&(g.resources=s._findResources(g.node,t)),r.push(...g.resources))}}),[...new Map(r.map(u=>[u.name,u])).values()]}getBindGroups(){const e=[];function t(r,s){r>=e.length&&(e.length=r+1),e[r]===void 0&&(e[r]=[]),s>=e[r].length&&(e[r].length=s+1)}for(const r of this.uniforms)t(r.group,r.binding),e[r.group][r.binding]=r;for(const r of this.storage)t(r.group,r.binding),e[r.group][r.binding]=r;for(const r of this.textures)t(r.group,r.binding),e[r.group][r.binding]=r;for(const r of this.samplers)t(r.group,r.binding),e[r.group][r.binding]=r;return e}_getOutputs(e,t=void 0){if(t===void 0&&(t=[]),e instanceof Gn)this._getStructOutputs(e,t);else{const r=this._getOutputInfo(e);r!==null&&t.push(r)}return t}_getStructOutputs(e,t){for(const r of e.members)if(r.type instanceof Gn)this._getStructOutputs(r.type,t);else{const s=this._getAttribute(r,"location")||this._getAttribute(r,"builtin");if(s!==null){const a=this.getTypeInfo(r.type,r.type.attributes),u=this._parseInt(s.value),l=new fb(r.name,a,s.name,u);t.push(l)}}}_getOutputInfo(e){const t=this._getAttribute(e,"location")||this._getAttribute(e,"builtin");if(t!==null){const r=this.getTypeInfo(e,e.attributes),s=this._parseInt(t.value);return new fb("",r,t.name,s)}return null}_getInputs(e,t=void 0){t===void 0&&(t=[]);for(const r of e)if(r.type instanceof Gn)this._getStructInputs(r.type,t);else{const s=this._getInputInfo(r);s!==null&&t.push(s)}return t}_getStructInputs(e,t){for(const r of e.members)if(r.type instanceof Gn)this._getStructInputs(r.type,t);else{const s=this._getInputInfo(r);s!==null&&t.push(s)}}_getInputInfo(e){const t=this._getAttribute(e,"location")||this._getAttribute(e,"builtin");if(t!==null){const r=this._getAttribute(e,"interpolation"),s=this.getTypeInfo(e.type,e.attributes),a=this._parseInt(t.value),u=new wP(e.name,s,t.name,a);return r!==null&&(u.interpolation=this._parseString(r.value)),u}return null}_parseString(e){return e instanceof Array&&(e=e[0]),e}_parseInt(e){e instanceof Array&&(e=e[0]);const t=parseInt(e);return isNaN(t)?e:t}_getAlias(e){for(const t of this.aliases)if(t.name==e)return t.type;return null}_getAliasInfo(e){return new bP(e.name,this.getTypeInfo(e.type,null))}getTypeInfoByName(e){for(const t of this.structs)if(t.name==e)return t;for(const t of this.aliases)if(t.name==e)return t.type;return null}getTypeInfo(e,t=null){if(this._types.has(e))return this._types.get(e);if(e instanceof Rf){const s=e.type?this.getTypeInfo(e.type,e.attributes):null,a=new Ym(e.name,s,t);return this._types.set(e,a),this._updateTypeInfo(a),a}if(e instanceof vh){const s=e,a=s.format?this.getTypeInfo(s.format,s.attributes):null,u=new Qo(s.name,t);return u.format=a,u.count=s.count,this._types.set(e,u),this._updateTypeInfo(u),u}if(e instanceof Gn){const s=e,a=new Zo(s.name,t);a.startLine=s.startLine,a.endLine=s.endLine;for(const u of s.members){const l=this.getTypeInfo(u.type,u.attributes);a.members.push(new db(u.name,l,u.attributes))}return this._types.set(e,a),this._updateTypeInfo(a),a}if(e instanceof hh){const s=e,a=s.format instanceof Ge,u=s.format?a?this.getTypeInfo(s.format,null):new Ys(s.format,null):null,l=new Za(s.name,u,t,s.access);return this._types.set(e,l),this._updateTypeInfo(l),l}if(e instanceof Re){const s=e,a=s.format?this.getTypeInfo(s.format,null):null,u=new Za(s.name,a,t,s.access);return this._types.set(e,u),this._updateTypeInfo(u),u}const r=new Ys(e.name,t);return this._types.set(e,r),this._updateTypeInfo(r),r}_updateTypeInfo(e){var t,r,s;const a=this._getTypeSize(e);if(e.size=(t=a?.size)!==null&&t!==void 0?t:0,e instanceof Qo&&e.format){const u=this._getTypeSize(e.format);e.stride=Math.max((r=u?.size)!==null&&r!==void 0?r:0,(s=u?.align)!==null&&s!==void 0?s:0),this._updateTypeInfo(e.format)}e instanceof Ym&&this._updateTypeInfo(e.format),e instanceof Zo&&this._updateStructInfo(e)}_updateStructInfo(e){var t;let r=0,s=0,a=0,u=0;for(let l=0,g=e.members.length;l<g;++l){const v=e.members[l],T=this._getTypeSize(v);if(!T)continue;(t=this._getAlias(v.type.name))!==null&&t!==void 0||v.type;const S=T.align,P=T.size;r=this._roundUp(S,r+s),s=P,a=r,u=Math.max(u,S),v.offset=r,v.size=P,this._updateTypeInfo(v.type)}e.size=this._roundUp(u,a+s),e.align=u}_getTypeSize(e){var t,r;if(e==null)return null;const s=this._getAttributeNum(e.attributes,"size",0),a=this._getAttributeNum(e.attributes,"align",0);if(e instanceof db&&(e=e.type),e instanceof Ys){const u=this._getAlias(e.name);u!==null&&(e=u)}{const u=En._typeInfo[e.name];if(u!==void 0){const l=((t=e.format)===null||t===void 0?void 0:t.name)==="f16"?2:1;return new ef(Math.max(a,u.align/l),Math.max(s,u.size/l))}}{const u=En._typeInfo[e.name.substring(0,e.name.length-1)];if(u){const l=e.name[e.name.length-1]==="h"?2:1;return new ef(Math.max(a,u.align/l),Math.max(s,u.size/l))}}if(e instanceof Qo){let u=e,l=8,g=8;const v=this._getTypeSize(u.format);return v!==null&&(g=v.size,l=v.align),g=u.count*this._getAttributeNum((r=e?.attributes)!==null&&r!==void 0?r:null,"stride",this._roundUp(l,g)),s&&(g=s),new ef(Math.max(a,l),Math.max(s,g))}if(e instanceof Zo){let u=0,l=0,g=0,v=0,T=0;for(const S of e.members){const P=this._getTypeSize(S.type);P!==null&&(u=Math.max(P.align,u),g=this._roundUp(P.align,g+v),v=P.size,T=g)}return l=this._roundUp(u,T+v),new ef(Math.max(a,u),Math.max(s,l))}return null}_isUniformVar(e){return e instanceof Jn&&e.storage=="uniform"}_isStorageVar(e){return e instanceof Jn&&e.storage=="storage"}_isTextureVar(e){return e instanceof Jn&&e.type!==null&&En._textureTypes.indexOf(e.type.name)!=-1}_isSamplerVar(e){return e instanceof Jn&&e.type!==null&&En._samplerTypes.indexOf(e.type.name)!=-1}_getAttribute(e,t){const r=e;if(!r||!r.attributes)return null;const s=r.attributes;for(let a of s)if(a.name==t)return a;return null}_getAttributeNum(e,t,r){if(e===null)return r;for(let s of e)if(s.name==t){let a=s!==null&&s.value!==null?s.value:r;return a instanceof Array&&(a=a[0]),typeof a=="number"?a:typeof a=="string"?parseInt(a):r}return r}_roundUp(e,t){return Math.ceil(t/e)*e}}En._typeInfo={f16:{align:2,size:2},i32:{align:4,size:4},u32:{align:4,size:4},f32:{align:4,size:4},atomic:{align:4,size:4},vec2:{align:8,size:8},vec3:{align:16,size:12},vec4:{align:16,size:16},mat2x2:{align:8,size:16},mat3x2:{align:8,size:24},mat4x2:{align:8,size:32},mat2x3:{align:16,size:32},mat3x3:{align:16,size:48},mat4x3:{align:16,size:64},mat2x4:{align:16,size:32},mat3x4:{align:16,size:48},mat4x4:{align:16,size:64}},En._textureTypes=J.any_texture_type.map(i=>i.name),En._samplerTypes=J.sampler_type.map(i=>i.name);let sy=0;class ny{constructor(e,t,r){this.id=sy++,this.name=e,this.value=t,this.node=r}clone(){return new ny(this.name,this.value,this.node)}}class oy{constructor(e){this.id=sy++,this.name=e.name,this.node=e}clone(){return new oy(this.node)}}class ay{constructor(e){this.parent=null,this.variables=new Map,this.functions=new Map,this.currentFunctionName="",this.id=sy++,e&&(this.parent=e,this.currentFunctionName=e.currentFunctionName)}getVariable(e){var t;return this.variables.has(e)?(t=this.variables.get(e))!==null&&t!==void 0?t:null:this.parent?this.parent.getVariable(e):null}getFunction(e){var t;return this.functions.has(e)?(t=this.functions.get(e))!==null&&t!==void 0?t:null:this.parent?this.parent.getFunction(e):null}createVariable(e,t,r){this.variables.set(e,new ny(e,t,r??null))}setVariable(e,t,r){const s=this.getVariable(e);s!==null?s.value=t:this.createVariable(e,t,r)}getVariableValue(e){var t;const r=this.getVariable(e);return(t=r?.value)!==null&&t!==void 0?t:null}clone(){return new ay(this)}}class HP{evalExpression(e,t){return null}getTypeInfo(e){return null}getVariableName(e,t){return""}}class qP{constructor(e){this.exec=e}getTypeInfo(e){return this.exec.getTypeInfo(e)}All(e,t){const r=this.exec.evalExpression(e.args[0],t);let s=!0;if(r instanceof ne)return r.data.forEach(a=>{a||(s=!1)}),new Ae(s?1:0,this.getTypeInfo("bool"));throw new Error(`All() expects a vector argument. Line ${e.line}`)}Any(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne){const s=r.data.some(a=>a);return new Ae(s?1:0,this.getTypeInfo("bool"))}throw new Error(`Any() expects a vector argument. Line ${e.line}`)}Select(e,t){const r=this.exec.evalExpression(e.args[2],t);if(!(r instanceof Ae))throw new Error(`Select() expects a bool condition. Line ${e.line}`);return r.value?this.exec.evalExpression(e.args[1],t):this.exec.evalExpression(e.args[0],t)}ArrayLength(e,t){let r=e.args[0];r instanceof or&&(r=r.right);const s=this.exec.evalExpression(r,t);if(s instanceof Ki&&s.typeInfo.size===0){const a=s.typeInfo,u=s.buffer.byteLength/a.stride;return new Ae(u,this.getTypeInfo("u32"))}return new Ae(s.typeInfo.size,this.getTypeInfo("u32"))}Abs(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne)return new ne(r.data.map(a=>Math.abs(a)),r.typeInfo);const s=r;return new Ae(Math.abs(s.value),s.typeInfo)}Acos(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne)return new ne(r.data.map(a=>Math.acos(a)),r.typeInfo);const s=r;return new Ae(Math.acos(s.value),r.typeInfo)}Acosh(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne)return new ne(r.data.map(a=>Math.acosh(a)),r.typeInfo);const s=r;return new Ae(Math.acosh(s.value),r.typeInfo)}Asin(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne)return new ne(r.data.map(a=>Math.asin(a)),r.typeInfo);const s=r;return new Ae(Math.asin(s.value),r.typeInfo)}Asinh(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne)return new ne(r.data.map(a=>Math.asinh(a)),r.typeInfo);const s=r;return new Ae(Math.asinh(s.value),r.typeInfo)}Atan(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne)return new ne(r.data.map(a=>Math.atan(a)),r.typeInfo);const s=r;return new Ae(Math.atan(s.value),r.typeInfo)}Atanh(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne)return new ne(r.data.map(a=>Math.atanh(a)),r.typeInfo);const s=r;return new Ae(Math.atanh(s.value),r.typeInfo)}Atan2(e,t){const r=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t);if(r instanceof ne&&s instanceof ne)return new ne(r.data.map((l,g)=>Math.atan2(l,s.data[g])),r.typeInfo);const a=r,u=s;return new Ae(Math.atan2(a.value,u.value),r.typeInfo)}Ceil(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne)return new ne(r.data.map(a=>Math.ceil(a)),r.typeInfo);const s=r;return new Ae(Math.ceil(s.value),r.typeInfo)}_clamp(e,t,r){return Math.min(Math.max(e,t),r)}Clamp(e,t){const r=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t),a=this.exec.evalExpression(e.args[2],t);if(r instanceof ne&&s instanceof ne&&a instanceof ne)return new ne(r.data.map((v,T)=>this._clamp(v,s.data[T],a.data[T])),r.typeInfo);const u=r,l=s,g=a;return new Ae(this._clamp(u.value,l.value,g.value),r.typeInfo)}Cos(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne)return new ne(r.data.map(a=>Math.cos(a)),r.typeInfo);const s=r;return new Ae(Math.cos(s.value),r.typeInfo)}Cosh(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne)return new ne(r.data.map(a=>Math.cosh(a)),r.typeInfo);const s=r;return new Ae(Math.cos(s.value),r.typeInfo)}CountLeadingZeros(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne)return new ne(r.data.map(a=>Math.clz32(a)),r.typeInfo);const s=r;return new Ae(Math.clz32(s.value),r.typeInfo)}_countOneBits(e){let t=0;for(;e!==0;)1&e&&t++,e>>=1;return t}CountOneBits(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne)return new ne(r.data.map(a=>this._countOneBits(a)),r.typeInfo);const s=r;return new Ae(this._countOneBits(s.value),r.typeInfo)}_countTrailingZeros(e){if(e===0)return 32;let t=0;for(;!(1&e);)e>>=1,t++;return t}CountTrailingZeros(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne)return new ne(r.data.map(a=>this._countTrailingZeros(a)),r.typeInfo);const s=r;return new Ae(this._countTrailingZeros(s.value),r.typeInfo)}Cross(e,t){const r=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t);if(r instanceof ne&&s instanceof ne){if(r.data.length!==3||s.data.length!==3)return console.error(`Cross() expects 3D vectors. Line ${e.line}`),null;const a=r.data,u=s.data;return new ne([a[1]*u[2]-u[1]*a[2],a[2]*u[0]-u[2]*a[0],a[0]*u[1]-u[0]*a[1]],r.typeInfo)}return console.error(`Cross() expects vector arguments. Line ${e.line}`),null}Degrees(e,t){const r=this.exec.evalExpression(e.args[0],t),s=180/Math.PI;return r instanceof ne?new ne(r.data.map(a=>a*s),r.typeInfo):new Ae(r.value*s,this.getTypeInfo("f32"))}Determinant(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof Wt){const s=r.data,a=r.typeInfo.getTypeName(),u=a.endsWith("h")?this.getTypeInfo("f16"):this.getTypeInfo("f32");if(a==="mat2x2"||a==="mat2x2f"||a==="mat2x2h")return new Ae(s[0]*s[3]-s[1]*s[2],u);if(a==="mat2x3"||a==="mat2x3f"||a==="mat2x3h")return new Ae(s[0]*(s[4]*s[8]-s[5]*s[7])-s[1]*(s[3]*s[8]-s[5]*s[6])+s[2]*(s[3]*s[7]-s[4]*s[6]),u);if(a==="mat2x4"||a==="mat2x4f"||a==="mat2x4h")console.error(`TODO: Determinant for ${a}`);else if(a==="mat3x2"||a==="mat3x2f"||a==="mat3x2h")console.error(`TODO: Determinant for ${a}`);else{if(a==="mat3x3"||a==="mat3x3f"||a==="mat3x3h")return new Ae(s[0]*(s[4]*s[8]-s[5]*s[7])-s[1]*(s[3]*s[8]-s[5]*s[6])+s[2]*(s[3]*s[7]-s[4]*s[6]),u);a==="mat3x4"||a==="mat3x4f"||a==="mat3x4h"||a==="mat4x2"||a==="mat4x2f"||a==="mat4x2h"||a==="mat4x3"||a==="mat4x3f"||a==="mat4x3h"?console.error(`TODO: Determinant for ${a}`):a!=="mat4x4"&&a!=="mat4x4f"&&a!=="mat4x4h"||console.error(`TODO: Determinant for ${a}`)}}return console.error(`Determinant expects a matrix argument. Line ${e.line}`),null}Distance(e,t){const r=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t);if(r instanceof ne&&s instanceof ne){let l=0;for(let g=0;g<r.data.length;++g)l+=(r.data[g]-s.data[g])*(r.data[g]-s.data[g]);return new Ae(Math.sqrt(l),this.getTypeInfo("f32"))}const a=r,u=s;return new Ae(Math.abs(a.value-u.value),r.typeInfo)}_dot(e,t){let r=0;for(let s=0;s<e.length;++s)r+=t[s]*e[s];return r}Dot(e,t){const r=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t);return r instanceof ne&&s instanceof ne?new Ae(this._dot(r.data,s.data),this.getTypeInfo("f32")):(console.error(`Dot() expects vector arguments. Line ${e.line}`),null)}Dot4U8Packed(e,t){return console.error(`TODO: dot4U8Packed. Line ${e.line}`),null}Dot4I8Packed(e,t){return console.error(`TODO: dot4I8Packed. Line ${e.line}`),null}Exp(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne)return new ne(r.data.map(a=>Math.exp(a)),r.typeInfo);const s=r;return new Ae(Math.exp(s.value),r.typeInfo)}Exp2(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne)return new ne(r.data.map(a=>Math.pow(2,a)),r.typeInfo);const s=r;return new Ae(Math.pow(2,s.value),r.typeInfo)}ExtractBits(e,t){const r=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t),a=this.exec.evalExpression(e.args[2],t);if(s.typeInfo.name!=="u32"&&s.typeInfo.name!=="x32")return console.error(`ExtractBits() expects an i32 offset argument. Line ${e.line}`),null;if(a.typeInfo.name!=="u32"&&a.typeInfo.name!=="x32")return console.error(`ExtractBits() expects an i32 count argument. Line ${e.line}`),null;const u=s.value,l=a.value;if(r instanceof ne)return new ne(r.data.map(v=>v>>u&(1<<l)-1),r.typeInfo);if(r.typeInfo.name!=="i32"&&r.typeInfo.name!=="x32")return console.error(`ExtractBits() expects an i32 argument. Line ${e.line}`),null;const g=r.value;return new Ae(g>>u&(1<<l)-1,this.getTypeInfo("i32"))}FaceForward(e,t){const r=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t),a=this.exec.evalExpression(e.args[2],t);if(r instanceof ne&&s instanceof ne&&a instanceof ne){const u=this._dot(s.data,a.data);return new ne(u<0?Array.from(r.data):r.data.map(l=>-l),r.typeInfo)}return console.error(`FaceForward() expects vector arguments. Line ${e.line}`),null}_firstLeadingBit(e){return e===0?-1:31-Math.clz32(e)}FirstLeadingBit(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne)return new ne(r.data.map(a=>this._firstLeadingBit(a)),r.typeInfo);const s=r;return new Ae(this._firstLeadingBit(s.value),r.typeInfo)}_firstTrailingBit(e){return e===0?-1:Math.log2(e&-e)}FirstTrailingBit(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne)return new ne(r.data.map(a=>this._firstTrailingBit(a)),r.typeInfo);const s=r;return new Ae(this._firstTrailingBit(s.value),r.typeInfo)}Floor(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne)return new ne(r.data.map(a=>Math.floor(a)),r.typeInfo);const s=r;return new Ae(Math.floor(s.value),r.typeInfo)}Fma(e,t){const r=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t),a=this.exec.evalExpression(e.args[2],t);if(r instanceof ne&&s instanceof ne&&a instanceof ne)return r.data.length!==s.data.length||r.data.length!==a.data.length?(console.error(`Fma() expects vectors of the same length. Line ${e.line}`),null):new ne(r.data.map((v,T)=>v*s.data[T]+a.data[T]),r.typeInfo);const u=r,l=s,g=a;return new Ae(u.value*l.value+g.value,u.typeInfo)}Fract(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne)return new ne(r.data.map(a=>a-Math.floor(a)),r.typeInfo);const s=r;return new Ae(s.value-Math.floor(s.value),r.typeInfo)}Frexp(e,t){return console.error(`TODO: frexp. Line ${e.line}`),null}InsertBits(e,t){const r=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t),a=this.exec.evalExpression(e.args[2],t),u=this.exec.evalExpression(e.args[3],t);if(a.typeInfo.name!=="u32"&&a.typeInfo.name!=="x32")return console.error(`InsertBits() expects an i32 offset argument. Line ${e.line}`),null;const l=a.value,g=(1<<u.value)-1<<l,v=~g;if(r instanceof ne&&s instanceof ne)return new ne(r.data.map((P,O)=>P&v|s.data[O]<<l&g),r.typeInfo);const T=r.value,S=s.value;return new Ae(T&v|S<<l&g,r.typeInfo)}InverseSqrt(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne)return new ne(r.data.map(a=>1/Math.sqrt(a)),r.typeInfo);const s=r;return new Ae(1/Math.sqrt(s.value),r.typeInfo)}Ldexp(e,t){return console.error(`TODO: ldexp. Line ${e.line}`),null}Length(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne){let a=0;return r.data.forEach(u=>{a+=u*u}),new Ae(Math.sqrt(a),this.getTypeInfo("f32"))}const s=r;return new Ae(Math.abs(s.value),r.typeInfo)}Log(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne)return new ne(r.data.map(a=>Math.log(a)),r.typeInfo);const s=r;return new Ae(Math.log(s.value),r.typeInfo)}Log2(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne)return new ne(r.data.map(a=>Math.log2(a)),r.typeInfo);const s=r;return new Ae(Math.log2(s.value),r.typeInfo)}Max(e,t){const r=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t);if(r instanceof ne&&s instanceof ne)return new ne(r.data.map((l,g)=>Math.max(l,s.data[g])),r.typeInfo);const a=r,u=s;return new Ae(Math.max(a.value,u.value),r.typeInfo)}Min(e,t){const r=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t);if(r instanceof ne&&s instanceof ne)return new ne(r.data.map((l,g)=>Math.min(l,s.data[g])),r.typeInfo);const a=r,u=s;return new Ae(Math.min(a.value,u.value),r.typeInfo)}Mix(e,t){const r=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t),a=this.exec.evalExpression(e.args[2],t);if(r instanceof ne&&s instanceof ne&&a instanceof ne)return new ne(r.data.map((g,v)=>r.data[v]*(1-a.data[v])+s.data[v]*a.data[v]),r.typeInfo);const u=s,l=a;return new Ae(r.value*(1-l.value)+u.value*l.value,r.typeInfo)}Modf(e,t){const r=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t);if(r instanceof ne&&s instanceof ne)return new ne(r.data.map((u,l)=>u%s.data[l]),r.typeInfo);const a=s;return new Ae(r.value%a.value,r.typeInfo)}Normalize(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne){const s=this.Length(e,t).value;return new ne(r.data.map(a=>a/s),r.typeInfo)}return console.error(`Normalize() expects a vector argument. Line ${e.line}`),null}Pow(e,t){const r=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t);if(r instanceof ne&&s instanceof ne)return new ne(r.data.map((l,g)=>Math.pow(l,s.data[g])),r.typeInfo);const a=r,u=s;return new Ae(Math.pow(a.value,u.value),r.typeInfo)}QuantizeToF16(e,t){const r=this.exec.evalExpression(e.args[0],t);return r instanceof ne?new ne(r.data.map(s=>s),r.typeInfo):new Ae(r.value,r.typeInfo)}Radians(e,t){const r=this.exec.evalExpression(e.args[0],t);return r instanceof ne?new ne(r.data.map(s=>s*Math.PI/180),r.typeInfo):new Ae(r.value*Math.PI/180,this.getTypeInfo("f32"))}Reflect(e,t){let r=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t);if(r instanceof ne&&s instanceof ne){const a=this._dot(r.data,s.data);return new ne(r.data.map((u,l)=>u-2*a*s.data[l]),r.typeInfo)}return console.error(`Reflect() expects vector arguments. Line ${e.line}`),null}Refract(e,t){let r=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t),a=this.exec.evalExpression(e.args[2],t);if(r instanceof ne&&s instanceof ne&&a instanceof Ae){const u=this._dot(s.data,r.data);return new ne(r.data.map((l,g)=>{const v=1-a.value*a.value*(1-u*u);if(v<0)return 0;const T=Math.sqrt(v);return a.value*l-(a.value*u+T)*s.data[g]}),r.typeInfo)}return console.error(`Refract() expects vector arguments and a scalar argument. Line ${e.line}`),null}ReverseBits(e,t){return console.error(`TODO: reverseBits. Line ${e.line}`),null}Round(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne)return new ne(r.data.map(a=>Math.round(a)),r.typeInfo);const s=r;return new Ae(Math.round(s.value),r.typeInfo)}Saturate(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne)return new ne(r.data.map(a=>Math.min(Math.max(a,0),1)),r.typeInfo);const s=r;return new Ae(Math.min(Math.max(s.value,0),1),r.typeInfo)}Sign(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne)return new ne(r.data.map(a=>Math.sign(a)),r.typeInfo);const s=r;return new Ae(Math.sign(s.value),r.typeInfo)}Sin(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne)return new ne(r.data.map(a=>Math.sin(a)),r.typeInfo);const s=r;return new Ae(Math.sin(s.value),r.typeInfo)}Sinh(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne)return new ne(r.data.map(a=>Math.sinh(a)),r.typeInfo);const s=r;return new Ae(Math.sinh(s.value),r.typeInfo)}_smoothstep(e,t,r){const s=Math.min(Math.max((r-e)/(t-e),0),1);return s*s*(3-2*s)}SmoothStep(e,t){const r=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t),a=this.exec.evalExpression(e.args[2],t);if(a instanceof ne&&r instanceof ne&&s instanceof ne)return new ne(a.data.map((v,T)=>this._smoothstep(r.data[T],s.data[T],v)),a.typeInfo);const u=r,l=s,g=a;return new Ae(this._smoothstep(u.value,l.value,g.value),a.typeInfo)}Sqrt(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne)return new ne(r.data.map(a=>Math.sqrt(a)),r.typeInfo);const s=r;return new Ae(Math.sqrt(s.value),r.typeInfo)}Step(e,t){const r=this.exec.evalExpression(e.args[0],t),s=this.exec.evalExpression(e.args[1],t);if(s instanceof ne&&r instanceof ne)return new ne(s.data.map((u,l)=>u<r.data[l]?0:1),s.typeInfo);const a=r;return new Ae(s.value<a.value?0:1,a.typeInfo)}Tan(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne)return new ne(r.data.map(a=>Math.tan(a)),r.typeInfo);const s=r;return new Ae(Math.tan(s.value),r.typeInfo)}Tanh(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne)return new ne(r.data.map(a=>Math.tanh(a)),r.typeInfo);const s=r;return new Ae(Math.tanh(s.value),r.typeInfo)}_getTransposeType(e){const t=e.getTypeName();return t==="mat2x2f"||t==="mat2x2h"?e:t==="mat2x3f"?this.getTypeInfo("mat3x2f"):t==="mat2x3h"?this.getTypeInfo("mat3x2h"):t==="mat2x4f"?this.getTypeInfo("mat4x2f"):t==="mat2x4h"?this.getTypeInfo("mat4x2h"):t==="mat3x2f"?this.getTypeInfo("mat2x3f"):t==="mat3x2h"?this.getTypeInfo("mat2x3h"):t==="mat3x3f"||t==="mat3x3h"?e:t==="mat3x4f"?this.getTypeInfo("mat4x3f"):t==="mat3x4h"?this.getTypeInfo("mat4x3h"):t==="mat4x2f"?this.getTypeInfo("mat2x4f"):t==="mat4x2h"?this.getTypeInfo("mat2x4h"):t==="mat4x3f"?this.getTypeInfo("mat3x4f"):t==="mat4x3h"?this.getTypeInfo("mat3x4h"):(t==="mat4x4f"||t==="mat4x4h"||console.error(`Invalid matrix type ${t}`),e)}Transpose(e,t){const r=this.exec.evalExpression(e.args[0],t);if(!(r instanceof Wt))return console.error(`Transpose() expects a matrix argument. Line ${e.line}`),null;const s=this._getTransposeType(r.typeInfo);if(r.typeInfo.name==="mat2x2"||r.typeInfo.name==="mat2x2f"||r.typeInfo.name==="mat2x2h"){const a=r.data;return new Wt([a[0],a[2],a[1],a[3]],s)}if(r.typeInfo.name==="mat2x3"||r.typeInfo.name==="mat2x3f"||r.typeInfo.name==="mat2x3h"){const a=r.data;return new Wt([a[0],a[3],a[6],a[1],a[4],a[7]],s)}if(r.typeInfo.name==="mat2x4"||r.typeInfo.name==="mat2x4f"||r.typeInfo.name==="mat2x4h"){const a=r.data;return new Wt([a[0],a[4],a[8],a[12],a[1],a[5],a[9],a[13]],s)}if(r.typeInfo.name==="mat3x2"||r.typeInfo.name==="mat3x2f"||r.typeInfo.name==="mat3x2h"){const a=r.data;return new Wt([a[0],a[3],a[1],a[4],a[2],a[5]],s)}if(r.typeInfo.name==="mat3x3"||r.typeInfo.name==="mat3x3f"||r.typeInfo.name==="mat3x3h"){const a=r.data;return new Wt([a[0],a[3],a[6],a[1],a[4],a[7],a[2],a[5],a[8]],s)}if(r.typeInfo.name==="mat3x4"||r.typeInfo.name==="mat3x4f"||r.typeInfo.name==="mat3x4h"){const a=r.data;return new Wt([a[0],a[4],a[8],a[12],a[1],a[5],a[9],a[13],a[2],a[6],a[10],a[14]],s)}if(r.typeInfo.name==="mat4x2"||r.typeInfo.name==="mat4x2f"||r.typeInfo.name==="mat4x2h"){const a=r.data;return new Wt([a[0],a[4],a[1],a[5],a[2],a[6]],s)}if(r.typeInfo.name==="mat4x3"||r.typeInfo.name==="mat4x3f"||r.typeInfo.name==="mat4x3h"){const a=r.data;return new Wt([a[0],a[4],a[8],a[1],a[5],a[9],a[2],a[6],a[10]],s)}if(r.typeInfo.name==="mat4x4"||r.typeInfo.name==="mat4x4f"||r.typeInfo.name==="mat4x4h"){const a=r.data;return new Wt([a[0],a[4],a[8],a[12],a[1],a[5],a[9],a[13],a[2],a[6],a[10],a[14],a[3],a[7],a[11],a[15]],s)}return console.error(`Invalid matrix type ${r.typeInfo.name}`),null}Trunc(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof ne)return new ne(r.data.map(a=>Math.trunc(a)),r.typeInfo);const s=r;return new Ae(Math.trunc(s.value),r.typeInfo)}Dpdx(e,t){return console.error(`TODO: dpdx. Line ${e.line}`),null}DpdxCoarse(e,t){return console.error(`TODO: dpdxCoarse. Line ${e.line}`),null}DpdxFine(e,t){return console.error("TODO: dpdxFine"),null}Dpdy(e,t){return console.error("TODO: dpdy"),null}DpdyCoarse(e,t){return console.error("TODO: dpdyCoarse"),null}DpdyFine(e,t){return console.error("TODO: dpdyFine"),null}Fwidth(e,t){return console.error("TODO: fwidth"),null}FwidthCoarse(e,t){return console.error("TODO: fwidthCoarse"),null}FwidthFine(e,t){return console.error("TODO: fwidthFine"),null}TextureDimensions(e,t){const r=e.args[0],s=e.args.length>1?this.exec.evalExpression(e.args[1],t).value:0;if(r instanceof Ls){const a=r.name,u=t.getVariableValue(a);if(u instanceof Kn){if(s<0||s>=u.mipLevelCount)return console.error(`Invalid mip level for textureDimensions. Line ${e.line}`),null;const l=u.getMipLevelSize(s),g=u.dimension;return g==="1d"?new Ae(l[0],this.getTypeInfo("u32")):g==="3d"?new ne(l,this.getTypeInfo("vec3u")):g==="2d"?new ne(l.slice(0,2),this.getTypeInfo("vec2u")):(console.error(`Invalid texture dimension ${g} not found. Line ${e.line}`),null)}return console.error(`Texture ${a} not found. Line ${e.line}`),null}return console.error(`Invalid texture argument for textureDimensions. Line ${e.line}`),null}TextureGather(e,t){return console.error("TODO: textureGather"),null}TextureGatherCompare(e,t){return console.error("TODO: textureGatherCompare"),null}TextureLoad(e,t){const r=e.args[0],s=this.exec.evalExpression(e.args[1],t),a=e.args.length>2?this.exec.evalExpression(e.args[2],t).value:0;if(!(s instanceof ne)||s.data.length!==2)return console.error(`Invalid UV argument for textureLoad. Line ${e.line}`),null;if(r instanceof Ls){const u=r.name,l=t.getVariableValue(u);if(l instanceof Kn){const g=Math.floor(s.data[0]),v=Math.floor(s.data[1]);if(g<0||g>=l.width||v<0||v>=l.height)return console.error(`Texture ${u} out of bounds. Line ${e.line}`),null;const T=l.getPixel(g,v,0,a);return T===null?(console.error(`Invalid texture format for textureLoad. Line ${e.line}`),null):new ne(T,this.getTypeInfo("vec4f"))}return console.error(`Texture ${u} not found. Line ${e.line}`),null}return console.error(`Invalid texture argument for textureLoad. Line ${e.line}`),null}TextureNumLayers(e,t){const r=e.args[0];if(r instanceof Ls){const s=r.name,a=t.getVariableValue(s);return a instanceof Kn?new Ae(a.depthOrArrayLayers,this.getTypeInfo("u32")):(console.error(`Texture ${s} not found. Line ${e.line}`),null)}return console.error(`Invalid texture argument for textureNumLayers. Line ${e.line}`),null}TextureNumLevels(e,t){const r=e.args[0];if(r instanceof Ls){const s=r.name,a=t.getVariableValue(s);return a instanceof Kn?new Ae(a.mipLevelCount,this.getTypeInfo("u32")):(console.error(`Texture ${s} not found. Line ${e.line}`),null)}return console.error(`Invalid texture argument for textureNumLevels. Line ${e.line}`),null}TextureNumSamples(e,t){const r=e.args[0];if(r instanceof Ls){const s=r.name,a=t.getVariableValue(s);return a instanceof Kn?new Ae(a.sampleCount,this.getTypeInfo("u32")):(console.error(`Texture ${s} not found. Line ${e.line}`),null)}return console.error(`Invalid texture argument for textureNumSamples. Line ${e.line}`),null}TextureSample(e,t){return console.error("TODO: textureSample"),null}TextureSampleBias(e,t){return console.error("TODO: textureSampleBias"),null}TextureSampleCompare(e,t){return console.error("TODO: textureSampleCompare"),null}TextureSampleCompareLevel(e,t){return console.error("TODO: textureSampleCompareLevel"),null}TextureSampleGrad(e,t){return console.error("TODO: textureSampleGrad"),null}TextureSampleLevel(e,t){return console.error("TODO: textureSampleLevel"),null}TextureSampleBaseClampToEdge(e,t){return console.error("TODO: textureSampleBaseClampToEdge"),null}TextureStore(e,t){const r=e.args[0],s=this.exec.evalExpression(e.args[1],t),a=e.args.length===4?this.exec.evalExpression(e.args[2],t).value:0,u=e.args.length===4?this.exec.evalExpression(e.args[3],t).data:this.exec.evalExpression(e.args[2],t).data;if(u.length!==4)return console.error(`Invalid value argument for textureStore. Line ${e.line}`),null;if(!(s instanceof ne)||s.data.length!==2)return console.error(`Invalid UV argument for textureStore. Line ${e.line}`),null;if(r instanceof Ls){const l=r.name,g=t.getVariableValue(l);if(g instanceof Kn){const v=g.getMipLevelSize(0),T=Math.floor(s.data[0]),S=Math.floor(s.data[1]);return T<0||T>=v[0]||S<0||S>=v[1]?(console.error(`Texture ${l} out of bounds. Line ${e.line}`),null):(g.setPixel(T,S,0,a,Array.from(u)),null)}return console.error(`Texture ${l} not found. Line ${e.line}`),null}return console.error(`Invalid texture argument for textureStore. Line ${e.line}`),null}AtomicLoad(e,t){let r=e.args[0];r instanceof or&&(r=r.right);const s=this.exec.getVariableName(r,t);return t.getVariable(s).value.getSubData(this.exec,r.postfix,t)}AtomicStore(e,t){let r=e.args[0];r instanceof or&&(r=r.right);const s=this.exec.getVariableName(r,t),a=t.getVariable(s);let u=e.args[1];const l=this.exec.evalExpression(u,t),g=a.value.getSubData(this.exec,r.postfix,t);return g instanceof Ae&&l instanceof Ae&&(g.value=l.value),a.value instanceof Ki&&a.value.setDataValue(this.exec,g,r.postfix,t),null}AtomicAdd(e,t){let r=e.args[0];r instanceof or&&(r=r.right);const s=this.exec.getVariableName(r,t),a=t.getVariable(s);let u=e.args[1];const l=this.exec.evalExpression(u,t),g=a.value.getSubData(this.exec,r.postfix,t),v=new Ae(g.value,g.typeInfo);return g instanceof Ae&&l instanceof Ae&&(g.value+=l.value),a.value instanceof Ki&&a.value.setDataValue(this.exec,g,r.postfix,t),v}AtomicSub(e,t){let r=e.args[0];r instanceof or&&(r=r.right);const s=this.exec.getVariableName(r,t),a=t.getVariable(s);let u=e.args[1];const l=this.exec.evalExpression(u,t),g=a.value.getSubData(this.exec,r.postfix,t),v=new Ae(g.value,g.typeInfo);return g instanceof Ae&&l instanceof Ae&&(g.value-=l.value),a.value instanceof Ki&&a.value.setDataValue(this.exec,g,r.postfix,t),v}AtomicMax(e,t){let r=e.args[0];r instanceof or&&(r=r.right);const s=this.exec.getVariableName(r,t),a=t.getVariable(s);let u=e.args[1];const l=this.exec.evalExpression(u,t),g=a.value.getSubData(this.exec,r.postfix,t),v=new Ae(g.value,g.typeInfo);return g instanceof Ae&&l instanceof Ae&&(g.value=Math.max(g.value,l.value)),a.value instanceof Ki&&a.value.setDataValue(this.exec,g,r.postfix,t),v}AtomicMin(e,t){let r=e.args[0];r instanceof or&&(r=r.right);const s=this.exec.getVariableName(r,t),a=t.getVariable(s);let u=e.args[1];const l=this.exec.evalExpression(u,t),g=a.value.getSubData(this.exec,r.postfix,t),v=new Ae(g.value,g.typeInfo);return g instanceof Ae&&l instanceof Ae&&(g.value=Math.min(g.value,l.value)),a.value instanceof Ki&&a.value.setDataValue(this.exec,g,r.postfix,t),v}AtomicAnd(e,t){let r=e.args[0];r instanceof or&&(r=r.right);const s=this.exec.getVariableName(r,t),a=t.getVariable(s);let u=e.args[1];const l=this.exec.evalExpression(u,t),g=a.value.getSubData(this.exec,r.postfix,t),v=new Ae(g.value,g.typeInfo);return g instanceof Ae&&l instanceof Ae&&(g.value=g.value&l.value),a.value instanceof Ki&&a.value.setDataValue(this.exec,g,r.postfix,t),v}AtomicOr(e,t){let r=e.args[0];r instanceof or&&(r=r.right);const s=this.exec.getVariableName(r,t),a=t.getVariable(s);let u=e.args[1];const l=this.exec.evalExpression(u,t),g=a.value.getSubData(this.exec,r.postfix,t),v=new Ae(g.value,g.typeInfo);return g instanceof Ae&&l instanceof Ae&&(g.value=g.value|l.value),a.value instanceof Ki&&a.value.setDataValue(this.exec,g,r.postfix,t),v}AtomicXor(e,t){let r=e.args[0];r instanceof or&&(r=r.right);const s=this.exec.getVariableName(r,t),a=t.getVariable(s);let u=e.args[1];const l=this.exec.evalExpression(u,t),g=a.value.getSubData(this.exec,r.postfix,t),v=new Ae(g.value,g.typeInfo);return g instanceof Ae&&l instanceof Ae&&(g.value=g.value^l.value),a.value instanceof Ki&&a.value.setDataValue(this.exec,g,r.postfix,t),v}AtomicExchange(e,t){let r=e.args[0];r instanceof or&&(r=r.right);const s=this.exec.getVariableName(r,t),a=t.getVariable(s);let u=e.args[1];const l=this.exec.evalExpression(u,t),g=a.value.getSubData(this.exec,r.postfix,t),v=new Ae(g.value,g.typeInfo);return g instanceof Ae&&l instanceof Ae&&(g.value=l.value),a.value instanceof Ki&&a.value.setDataValue(this.exec,g,r.postfix,t),v}AtomicCompareExchangeWeak(e,t){return console.error("TODO: atomicCompareExchangeWeak"),null}Pack4x8snorm(e,t){return console.error("TODO: pack4x8snorm"),null}Pack4x8unorm(e,t){return console.error("TODO: pack4x8unorm"),null}Pack4xI8(e,t){return console.error("TODO: pack4xI8"),null}Pack4xU8(e,t){return console.error("TODO: pack4xU8"),null}Pack4x8Clamp(e,t){return console.error("TODO: pack4x8Clamp"),null}Pack4xU8Clamp(e,t){return console.error("TODO: pack4xU8Clamp"),null}Pack2x16snorm(e,t){return console.error("TODO: pack2x16snorm"),null}Pack2x16unorm(e,t){return console.error("TODO: pack2x16unorm"),null}Pack2x16float(e,t){return console.error("TODO: pack2x16float"),null}Unpack4x8snorm(e,t){return console.error("TODO: unpack4x8snorm"),null}Unpack4x8unorm(e,t){return console.error("TODO: unpack4x8unorm"),null}Unpack4xI8(e,t){return console.error("TODO: unpack4xI8"),null}Unpack4xU8(e,t){return console.error("TODO: unpack4xU8"),null}Unpack2x16snorm(e,t){return console.error("TODO: unpack2x16snorm"),null}Unpack2x16unorm(e,t){return console.error("TODO: unpack2x16unorm"),null}Unpack2x16float(e,t){return console.error("TODO: unpack2x16float"),null}StorageBarrier(e,t){return null}TextureBarrier(e,t){return null}WorkgroupBarrier(e,t){return null}WorkgroupUniformLoad(e,t){return null}SubgroupAdd(e,t){return console.error("TODO: subgroupAdd"),null}SubgroupExclusiveAdd(e,t){return console.error("TODO: subgroupExclusiveAdd"),null}SubgroupInclusiveAdd(e,t){return console.error("TODO: subgroupInclusiveAdd"),null}SubgroupAll(e,t){return console.error("TODO: subgroupAll"),null}SubgroupAnd(e,t){return console.error("TODO: subgroupAnd"),null}SubgroupAny(e,t){return console.error("TODO: subgroupAny"),null}SubgroupBallot(e,t){return console.error("TODO: subgroupBallot"),null}SubgroupBroadcast(e,t){return console.error("TODO: subgroupBroadcast"),null}SubgroupBroadcastFirst(e,t){return console.error("TODO: subgroupBroadcastFirst"),null}SubgroupElect(e,t){return console.error("TODO: subgroupElect"),null}SubgroupMax(e,t){return console.error("TODO: subgroupMax"),null}SubgroupMin(e,t){return console.error("TODO: subgroupMin"),null}SubgroupMul(e,t){return console.error("TODO: subgroupMul"),null}SubgroupExclusiveMul(e,t){return console.error("TODO: subgroupExclusiveMul"),null}SubgroupInclusiveMul(e,t){return console.error("TODO: subgroupInclusiveMul"),null}SubgroupOr(e,t){return console.error("TODO: subgroupOr"),null}SubgroupShuffle(e,t){return console.error("TODO: subgroupShuffle"),null}SubgroupShuffleDown(e,t){return console.error("TODO: subgroupShuffleDown"),null}SubgroupShuffleUp(e,t){return console.error("TODO: subgroupShuffleUp"),null}SubgroupShuffleXor(e,t){return console.error("TODO: subgroupShuffleXor"),null}SubgroupXor(e,t){return console.error("TODO: subgroupXor"),null}QuadBroadcast(e,t){return console.error("TODO: quadBroadcast"),null}QuadSwapDiagonal(e,t){return console.error("TODO: quadSwapDiagonal"),null}QuadSwapX(e,t){return console.error("TODO: quadSwapX"),null}QuadSwapY(e,t){return console.error("TODO: quadSwapY"),null}}const nm={vec2:2,vec2f:2,vec2i:2,vec2u:2,vec2b:2,vec2h:2,vec3:3,vec3f:3,vec3i:3,vec3u:3,vec3b:3,vec3h:3,vec4:4,vec4f:4,vec4i:4,vec4u:4,vec4b:4,vec4h:4},ss={mat2x2:[2,2,4],mat2x2f:[2,2,4],mat2x2h:[2,2,4],mat2x3:[2,3,6],mat2x3f:[2,3,6],mat2x3h:[2,3,6],mat2x4:[2,4,8],mat2x4f:[2,4,8],mat2x4h:[2,4,8],mat3x2:[3,2,6],mat3x2f:[3,2,6],mat3x2h:[3,2,6],mat3x3:[3,3,9],mat3x3f:[3,3,9],mat3x3h:[3,3,9],mat3x4:[3,4,12],mat3x4f:[3,4,12],mat3x4h:[3,4,12],mat4x2:[4,2,8],mat4x2f:[4,2,8],mat4x2h:[4,2,8],mat4x3:[4,3,12],mat4x3f:[4,3,12],mat4x3h:[4,3,12],mat4x4:[4,4,16],mat4x4f:[4,4,16],mat4x4h:[4,4,16]};class Wr extends HP{constructor(e,t){var r;super(),this.ast=e??[],this.reflection=new En,this.reflection.updateAST(this.ast),this.context=(r=t?.clone())!==null&&r!==void 0?r:new ay,this.builtins=new qP(this),this.typeInfo={bool:this.getTypeInfo(Ge.bool),i32:this.getTypeInfo(Ge.i32),u32:this.getTypeInfo(Ge.u32),f32:this.getTypeInfo(Ge.f32),f16:this.getTypeInfo(Ge.f16),vec2f:this.getTypeInfo(Re.vec2f),vec2u:this.getTypeInfo(Re.vec2u),vec2i:this.getTypeInfo(Re.vec2i),vec2h:this.getTypeInfo(Re.vec2h),vec3f:this.getTypeInfo(Re.vec3f),vec3u:this.getTypeInfo(Re.vec3u),vec3i:this.getTypeInfo(Re.vec3i),vec3h:this.getTypeInfo(Re.vec3h),vec4f:this.getTypeInfo(Re.vec4f),vec4u:this.getTypeInfo(Re.vec4u),vec4i:this.getTypeInfo(Re.vec4i),vec4h:this.getTypeInfo(Re.vec4h),mat2x2f:this.getTypeInfo(Re.mat2x2f),mat2x3f:this.getTypeInfo(Re.mat2x3f),mat2x4f:this.getTypeInfo(Re.mat2x4f),mat3x2f:this.getTypeInfo(Re.mat3x2f),mat3x3f:this.getTypeInfo(Re.mat3x3f),mat3x4f:this.getTypeInfo(Re.mat3x4f),mat4x2f:this.getTypeInfo(Re.mat4x2f),mat4x3f:this.getTypeInfo(Re.mat4x3f),mat4x4f:this.getTypeInfo(Re.mat4x4f)}}getVariableValue(e){var t,r;const s=(r=(t=this.context.getVariable(e))===null||t===void 0?void 0:t.value)!==null&&r!==void 0?r:null;if(s===null)return null;if(s instanceof Ae)return s.value;if(s instanceof ne||s instanceof Wt)return Array.from(s.data);if(s instanceof Ki&&s.typeInfo instanceof Qo){if(s.typeInfo.format.name==="u32")return Array.from(new Uint32Array(s.buffer,s.offset,s.typeInfo.count));if(s.typeInfo.format.name==="i32")return Array.from(new Int32Array(s.buffer,s.offset,s.typeInfo.count));if(s.typeInfo.format.name==="f32")return Array.from(new Float32Array(s.buffer,s.offset,s.typeInfo.count))}return console.error(`Unsupported return variable type ${s.typeInfo.name}`),null}execute(e){(e=e??{}).constants&&this._setOverrides(e.constants,this.context),this._execStatements(this.ast,this.context)}dispatchWorkgroups(e,t,r,s){const a=this.context.clone();(s=s??{}).constants&&this._setOverrides(s.constants,a),this._execStatements(this.ast,a);const u=a.getFunction(e);if(!u)return void console.error(`Function ${e} not found`);if(typeof t=="number")t=[t,1,1];else{if(t.length===0)return void console.error("Invalid dispatch count");t.length===1?t=[t[0],1,1]:t.length===2?t=[t[0],t[1],1]:t.length>3&&(t=[t[0],t[1],t[2]])}const l=t[0],g=t[1],v=t[2],T=this.getTypeInfo("vec3u");a.setVariable("@num_workgroups",new ne(t,T));const S=this.reflection.getFunctionInfo(e);S===null&&console.error(`Function ${e} not found in reflection data`);for(const P in r)for(const O in r[P]){const $=r[P][O];a.variables.forEach(W=>{var G;const Q=W.node;if(Q?.attributes){let ae=null,te=null;for(const me of Q.attributes)me.name==="binding"?ae=me.value:me.name==="group"&&(te=me.value);if(O==ae&&P==te){let me=!1;for(const we of S.resources)if(we.name===W.name&&we.group===parseInt(P)&&we.binding===parseInt(O)){me=!0;break}if(me)if($.texture!==void 0&&$.descriptor!==void 0){const we=new Kn($.texture,this.getTypeInfo(Q.type),$.descriptor,(G=$.texture.view)!==null&&G!==void 0?G:null);W.value=we}else $.uniform!==void 0?W.value=new Ki($.uniform,this.getTypeInfo(Q.type)):W.value=new Ki($,this.getTypeInfo(Q.type))}}})}for(let P=0;P<v;++P)for(let O=0;O<g;++O)for(let $=0;$<l;++$)a.setVariable("@workgroup_id",new ne([$,O,P],this.getTypeInfo("vec3u"))),this._dispatchWorkgroup(u,[$,O,P],a)}execStatement(e,t){if(e instanceof Y1)return this.evalExpression(e.value,t);if(e instanceof K1){if(e.condition){const r=this.evalExpression(e.condition,t);if(!(r instanceof Ae))throw new Error("Invalid break-if condition");if(!r.value)return null}return Wr._breakObj}if(e instanceof J1)return Wr._continueObj;if(e instanceof xh)this._let(e,t);else if(e instanceof Jn)this._var(e,t);else if(e instanceof Mf)this._const(e,t);else if(e instanceof Ph)this._function(e,t);else{if(e instanceof Z1)return this._if(e,t);if(e instanceof X1)return this._switch(e,t);if(e instanceof $1)return this._for(e,t);if(e instanceof j1)return this._while(e,t);if(e instanceof q1)return this._loop(e,t);if(e instanceof Gm){const r=t.clone();return r.currentFunctionName=t.currentFunctionName,this._execStatements(e.body,r)}if(e instanceof H1)this._assign(e,t);else if(e instanceof W1)this._increment(e,t);else{if(e instanceof Gn)return null;if(e instanceof ey){const r=e.name;t.getVariable(r)===null&&t.setVariable(r,new Ae(0,this.getTypeInfo("u32")))}else if(e instanceof ty)this._call(e,t);else{if(e instanceof G1||e instanceof iy)return null;console.error("Invalid statement type.",e,`Line ${e.line}`)}}}return null}evalExpression(e,t){return e instanceof an?this._evalBinaryOp(e,t):e instanceof hr?this._evalLiteral(e,t):e instanceof Ls?this._evalVariable(e,t):e instanceof ry?this._evalCall(e,t):e instanceof Tn?this._evalCreate(e,t):e instanceof Q1?this._evalConst(e,t):e instanceof e2?this._evalBitcast(e,t):e instanceof or?this._evalUnaryOp(e,t):(console.error("Invalid expression type",e,`Line ${e.line}`),null)}getTypeInfo(e){var t;if(e instanceof Ge){const s=this.reflection.getTypeInfo(e);if(s!==null)return s}let r=(t=this.typeInfo[e])!==null&&t!==void 0?t:null;return r!==null||(r=this.reflection.getTypeInfoByName(e)),r}_setOverrides(e,t){for(const r in e){const s=e[r],a=this.reflection.getOverrideInfo(r);a!==null?(a.type===null&&(a.type=this.getTypeInfo("u32")),a.type.name==="u32"||a.type.name==="i32"||a.type.name==="f32"||a.type.name==="f16"?t.setVariable(r,new Ae(s,a.type)):a.type.name==="bool"?t.setVariable(r,new Ae(s?1:0,a.type)):a.type.name==="vec2"||a.type.name==="vec3"||a.type.name==="vec4"||a.type.name==="vec2f"||a.type.name==="vec3f"||a.type.name==="vec4f"||a.type.name==="vec2i"||a.type.name==="vec3i"||a.type.name==="vec4i"||a.type.name==="vec2u"||a.type.name==="vec3u"||a.type.name==="vec4u"||a.type.name==="vec2h"||a.type.name==="vec3h"||a.type.name==="vec4h"?t.setVariable(r,new ne(s,a.type)):console.error(`Invalid constant type for ${r}`)):console.error(`Override ${r} does not exist in the shader.`)}}_dispatchWorkgroup(e,t,r){const s=[1,1,1];for(const T of e.node.attributes)if(T.name==="workgroup_size"){if(T.value.length>0){const S=r.getVariableValue(T.value[0]);s[0]=S instanceof Ae?S.value:parseInt(T.value[0])}if(T.value.length>1){const S=r.getVariableValue(T.value[1]);s[1]=S instanceof Ae?S.value:parseInt(T.value[1])}if(T.value.length>2){const S=r.getVariableValue(T.value[2]);s[2]=S instanceof Ae?S.value:parseInt(T.value[2])}}const a=this.getTypeInfo("vec3u"),u=this.getTypeInfo("u32");r.setVariable("@workgroup_size",new ne(s,a));const l=s[0],g=s[1],v=s[2];for(let T=0,S=0;T<v;++T)for(let P=0;P<g;++P)for(let O=0;O<l;++O,++S){const $=[O,P,T],W=[O+t[0]*s[0],P+t[1]*s[1],T+t[2]*s[2]];r.setVariable("@local_invocation_id",new ne($,a)),r.setVariable("@global_invocation_id",new ne(W,a)),r.setVariable("@local_invocation_index",new Ae(S,u)),this._dispatchExec(e,r)}}_dispatchExec(e,t){for(const r of e.node.args)for(const s of r.attributes)if(s.name==="builtin"){const a=`@${s.value}`,u=t.getVariable(a);u!==void 0&&t.variables.set(r.name,u)}this._execStatements(e.node.body,t)}getVariableName(e,t){for(;e instanceof or;)e=e.right;return e instanceof Ls?e.name:(console.error("Unknown variable type",e,"Line",e.line),null)}_execStatements(e,t){for(const r of e){if(r instanceof Array){const a=t.clone(),u=this._execStatements(r,a);if(u)return u;continue}const s=this.execStatement(r,t);if(s)return s}return null}_call(e,t){const r=t.clone();r.currentFunctionName=e.name;const s=t.getFunction(e.name);if(s){for(let a=0;a<s.node.args.length;++a){const u=s.node.args[a],l=this.evalExpression(e.args[a],r);r.setVariable(u.name,l,u)}this._execStatements(s.node.body,r)}else e.isBuiltin?this._callBuiltinFunction(e,r):this.getTypeInfo(e.name)&&this._evalCreate(e,t)}_increment(e,t){const r=this.getVariableName(e.variable,t),s=t.getVariable(r);s?e.operator==="++"?s.value instanceof Ae?s.value.value++:console.error(`Variable ${r} is not a scalar. Line ${e.line}`):e.operator==="--"?s.value instanceof Ae?s.value.value--:console.error(`Variable ${r} is not a scalar. Line ${e.line}`):console.error(`Unknown increment operator ${e.operator}. Line ${e.line}`):console.error(`Variable ${r} not found. Line ${e.line}`)}_getVariableData(e,t){if(e instanceof Ls){const r=this.getVariableName(e,t),s=t.getVariable(r);return s===null?(console.error(`Variable ${r} not found. Line ${e.line}`),null):s.value.getSubData(this,e.postfix,t)}if(e instanceof or){if(e.operator==="*"){const r=this._getVariableData(e.right,t);return r instanceof Ql?r.reference.getSubData(this,e.postfix,t):(console.error(`Variable ${e.right} is not a pointer. Line ${e.line}`),null)}if(e.operator==="&"){const r=this._getVariableData(e.right,t);return new Ql(r)}}return null}_assign(e,t){let r=null,s="<var>",a=null;if(e.variable instanceof or){const g=this._getVariableData(e.variable,t),v=this.evalExpression(e.value,t),T=e.operator;if(T==="="){if(g instanceof Ae||g instanceof ne||g instanceof Wt){if(v instanceof Ae||v instanceof ne||v instanceof Wt&&g.data.length===v.data.length)return void g.data.set(v.data);console.error(`Invalid assignment. Line ${e.line}`)}else if(g instanceof Ki&&v instanceof Ki&&g.buffer.byteLength-g.offset>=v.buffer.byteLength-v.offset)return void(g.buffer.byteLength%4==0?new Uint32Array(g.buffer,g.offset,g.typeInfo.size/4).set(new Uint32Array(v.buffer,v.offset,v.typeInfo.size/4)):new Uint8Array(g.buffer,g.offset,g.typeInfo.size).set(new Uint8Array(v.buffer,v.offset,v.typeInfo.size)));return console.error(`Invalid assignment. Line ${e.line}`),null}if(T==="+=")return g instanceof Ae||g instanceof ne||g instanceof Wt?v instanceof Ae||v instanceof ne||v instanceof Wt?void g.data.set(v.data.map((S,P)=>g.data[P]+S)):void console.error(`Invalid assignment . Line ${e.line}`):void console.error(`Invalid assignment. Line ${e.line}`);if(T==="-=")return(g instanceof Ae||g instanceof ne||g instanceof Wt)&&(v instanceof Ae||v instanceof ne||v instanceof Wt)?void g.data.set(v.data.map((S,P)=>g.data[P]-S)):void console.error(`Invalid assignment. Line ${e.line}`)}if(e.variable instanceof or){if(e.variable.operator==="*"){s=this.getVariableName(e.variable.right,t);const g=t.getVariable(s);if(!(g&&g.value instanceof Ql))return void console.error(`Variable ${s} is not a pointer. Line ${e.line}`);r=g.value.reference;let v=e.variable.postfix;if(!v){let T=e.variable.right;for(;T instanceof or;){if(T.postfix){v=T.postfix;break}T=T.right}}v&&(r=r.getSubData(this,v,t))}}else{a=e.variable.postfix,s=this.getVariableName(e.variable,t);const g=t.getVariable(s);if(g===null)return void console.error(`Variable ${s} not found. Line ${e.line}`);r=g.value}if(r instanceof Ql&&(r=r.reference),r===null)return void console.error(`Variable ${s} not found. Line ${e.line}`);const u=this.evalExpression(e.value,t),l=e.operator;if(l!=="="){const g=r.getSubData(this,a,t);if(g instanceof ne&&u instanceof Ae){const v=g.data,T=u.value;if(l==="+=")for(let S=0;S<v.length;++S)v[S]+=T;else if(l==="-=")for(let S=0;S<v.length;++S)v[S]-=T;else if(l==="*=")for(let S=0;S<v.length;++S)v[S]*=T;else if(l==="/=")for(let S=0;S<v.length;++S)v[S]/=T;else if(l==="%=")for(let S=0;S<v.length;++S)v[S]%=T;else if(l==="&=")for(let S=0;S<v.length;++S)v[S]&=T;else if(l==="|=")for(let S=0;S<v.length;++S)v[S]|=T;else if(l==="^=")for(let S=0;S<v.length;++S)v[S]^=T;else if(l==="<<=")for(let S=0;S<v.length;++S)v[S]<<=T;else if(l===">>=")for(let S=0;S<v.length;++S)v[S]>>=T;else console.error(`Invalid operator ${l}. Line ${e.line}`)}else if(g instanceof ne&&u instanceof ne){const v=g.data,T=u.data;if(v.length!==T.length)return void console.error(`Vector length mismatch. Line ${e.line}`);if(l==="+=")for(let S=0;S<v.length;++S)v[S]+=T[S];else if(l==="-=")for(let S=0;S<v.length;++S)v[S]-=T[S];else if(l==="*=")for(let S=0;S<v.length;++S)v[S]*=T[S];else if(l==="/=")for(let S=0;S<v.length;++S)v[S]/=T[S];else if(l==="%=")for(let S=0;S<v.length;++S)v[S]%=T[S];else if(l==="&=")for(let S=0;S<v.length;++S)v[S]&=T[S];else if(l==="|=")for(let S=0;S<v.length;++S)v[S]|=T[S];else if(l==="^=")for(let S=0;S<v.length;++S)v[S]^=T[S];else if(l==="<<=")for(let S=0;S<v.length;++S)v[S]<<=T[S];else if(l===">>=")for(let S=0;S<v.length;++S)v[S]>>=T[S];else console.error(`Invalid operator ${l}. Line ${e.line}`)}else{if(!(g instanceof Ae&&u instanceof Ae))return void console.error(`Invalid type for ${e.operator} operator. Line ${e.line}`);l==="+="?g.value+=u.value:l==="-="?g.value-=u.value:l==="*="?g.value*=u.value:l==="/="?g.value/=u.value:l==="%="?g.value%=u.value:l==="&="?g.value&=u.value:l==="|="?g.value|=u.value:l==="^="?g.value^=u.value:l==="<<="?g.value<<=u.value:l===">>="?g.value>>=u.value:console.error(`Invalid operator ${l}. Line ${e.line}`)}return void(r instanceof Ki&&r.setDataValue(this,g,a,t))}if(r instanceof Ki)r.setDataValue(this,u,a,t);else if(a){if(!(r instanceof ne||r instanceof Wt))return void console.error(`Variable ${s} is not a vector or matrix. Line ${e.line}`);if(a instanceof vc){const g=this.evalExpression(a.index,t).value;if(r instanceof ne){if(!(u instanceof Ae))return void console.error(`Invalid assignment to ${s}. Line ${e.line}`);r.data[g]=u.value}else{if(!(r instanceof Wt))return void console.error(`Invalid assignment to ${s}. Line ${e.line}`);{const v=this.evalExpression(a.index,t).value;if(v<0)return void console.error(`Invalid assignment to ${s}. Line ${e.line}`);if(!(u instanceof ne))return void console.error(`Invalid assignment to ${s}. Line ${e.line}`);{const T=r.typeInfo.getTypeName();if(T==="mat2x2"||T==="mat2x2f"||T==="mat2x2h"){if(!(v<2&&u.data.length===2))return void console.error(`Invalid assignment to ${s}. Line ${e.line}`);r.data[2*v]=u.data[0],r.data[2*v+1]=u.data[1]}else if(T==="mat2x3"||T==="mat2x3f"||T==="mat2x3h"){if(!(v<2&&u.data.length===3))return void console.error(`Invalid assignment to ${s}. Line ${e.line}`);r.data[3*v]=u.data[0],r.data[3*v+1]=u.data[1],r.data[3*v+2]=u.data[2]}else if(T==="mat2x4"||T==="mat2x4f"||T==="mat2x4h"){if(!(v<2&&u.data.length===4))return void console.error(`Invalid assignment to ${s}. Line ${e.line}`);r.data[4*v]=u.data[0],r.data[4*v+1]=u.data[1],r.data[4*v+2]=u.data[2],r.data[4*v+3]=u.data[3]}else if(T==="mat3x2"||T==="mat3x2f"||T==="mat3x2h"){if(!(v<3&&u.data.length===2))return void console.error(`Invalid assignment to ${s}. Line ${e.line}`);r.data[2*v]=u.data[0],r.data[2*v+1]=u.data[1]}else if(T==="mat3x3"||T==="mat3x3f"||T==="mat3x3h"){if(!(v<3&&u.data.length===3))return void console.error(`Invalid assignment to ${s}. Line ${e.line}`);r.data[3*v]=u.data[0],r.data[3*v+1]=u.data[1],r.data[3*v+2]=u.data[2]}else if(T==="mat3x4"||T==="mat3x4f"||T==="mat3x4h"){if(!(v<3&&u.data.length===4))return void console.error(`Invalid assignment to ${s}. Line ${e.line}`);r.data[4*v]=u.data[0],r.data[4*v+1]=u.data[1],r.data[4*v+2]=u.data[2],r.data[4*v+3]=u.data[3]}else if(T==="mat4x2"||T==="mat4x2f"||T==="mat4x2h"){if(!(v<4&&u.data.length===2))return void console.error(`Invalid assignment to ${s}. Line ${e.line}`);r.data[2*v]=u.data[0],r.data[2*v+1]=u.data[1]}else if(T==="mat4x3"||T==="mat4x3f"||T==="mat4x3h"){if(!(v<4&&u.data.length===3))return void console.error(`Invalid assignment to ${s}. Line ${e.line}`);r.data[3*v]=u.data[0],r.data[3*v+1]=u.data[1],r.data[3*v+2]=u.data[2]}else{if(T!=="mat4x4"&&T!=="mat4x4f"&&T!=="mat4x4h")return void console.error(`Invalid assignment to ${s}. Line ${e.line}`);if(!(v<4&&u.data.length===4))return void console.error(`Invalid assignment to ${s}. Line ${e.line}`);r.data[4*v]=u.data[0],r.data[4*v+1]=u.data[1],r.data[4*v+2]=u.data[2],r.data[4*v+3]=u.data[3]}}}}}else if(a instanceof Ya){const g=a.value;if(!(r instanceof ne))return void console.error(`Invalid assignment to ${g}. Variable ${s} is not a vector. Line ${e.line}`);if(u instanceof Ae){if(g.length>1)return void console.error(`Invalid assignment to ${g} for variable ${s}. Line ${e.line}`);if(g==="x")r.data[0]=u.value;else if(g==="y"){if(r.data.length<2)return void console.error(`Invalid assignment to ${g} for variable ${s}. Line ${e.line}`);r.data[1]=u.value}else if(g==="z"){if(r.data.length<3)return void console.error(`Invalid assignment to ${g} for variable ${s}. Line ${e.line}`);r.data[2]=u.value}else if(g==="w"){if(r.data.length<4)return void console.error(`Invalid assignment to ${g} for variable ${s}. Line ${e.line}`);r.data[3]=u.value}}else{if(!(u instanceof ne))return void console.error(`Invalid assignment to ${s}. Line ${e.line}`);if(g.length!==u.data.length)return void console.error(`Invalid assignment to ${g} for variable ${s}. Line ${e.line}`);for(let v=0;v<g.length;++v){const T=g[v];if(T==="x"||T==="r")r.data[0]=u.data[v];else if(T==="y"||T==="g"){if(u.data.length<2)return void console.error(`Invalid assignment to ${T} for variable ${s}. Line ${e.line}`);r.data[1]=u.data[v]}else if(T==="z"||T==="b"){if(u.data.length<3)return void console.error(`Invalid assignment to ${T} for variable ${s}. Line ${e.line}`);r.data[2]=u.data[v]}else{if(T!=="w"&&T!=="a")return void console.error(`Invalid assignment to ${T} for variable ${s}. Line ${e.line}`);if(u.data.length<4)return void console.error(`Invalid assignment to ${T} for variable ${s}. Line ${e.line}`);r.data[3]=u.data[v]}}}}}else r instanceof Ae&&u instanceof Ae?r.value=u.value:r instanceof ne&&u instanceof ne||r instanceof Wt&&u instanceof Wt?r.data.set(u.data):console.error(`Invalid assignment to ${s}. Line ${e.line}`)}_function(e,t){const r=new oy(e);t.functions.set(e.name,r)}_const(e,t){let r=null;e.value!==null&&(r=this.evalExpression(e.value,t)),t.createVariable(e.name,r,e)}_let(e,t){let r=null;if(e.value!==null){if(r=this.evalExpression(e.value,t),r===null)return void console.error(`Invalid value for variable ${e.name}. Line ${e.line}`);e.value instanceof or||(r=r.clone())}else{const s=e.type.name;if(s==="f32"||s==="i32"||s==="u32"||s==="bool"||s==="f16"||s==="vec2"||s==="vec3"||s==="vec4"||s==="vec2f"||s==="vec3f"||s==="vec4f"||s==="vec2i"||s==="vec3i"||s==="vec4i"||s==="vec2u"||s==="vec3u"||s==="vec4u"||s==="vec2h"||s==="vec3h"||s==="vec4h"||s==="vec2b"||s==="vec3b"||s==="vec4b"||s==="mat2x2"||s==="mat2x3"||s==="mat2x4"||s==="mat3x2"||s==="mat3x3"||s==="mat3x4"||s==="mat4x2"||s==="mat4x3"||s==="mat4x4"||s==="mat2x2f"||s==="mat2x3f"||s==="mat2x4f"||s==="mat3x2f"||s==="mat3x3f"||s==="mat3x4f"||s==="mat4x2f"||s==="mat4x3f"||s==="mat4x4f"||s==="mat2x2h"||s==="mat2x3h"||s==="mat2x4h"||s==="mat3x2h"||s==="mat3x3h"||s==="mat3x4h"||s==="mat4x2h"||s==="mat4x3h"||s==="mat4x4h"||s==="array"){const a=new Tn(e.type,[]);r=this._evalCreate(a,t)}}t.createVariable(e.name,r,e)}_var(e,t){let r=null;if(e.value!==null){if(r=this.evalExpression(e.value,t),r===null)return void console.error(`Invalid value for variable ${e.name}. Line ${e.line}`);e.value instanceof or||(r=r.clone())}else{if(e.type===null)return void console.error(`Variable ${e.name} has no type. Line ${e.line}`);const s=e.type.name;if(s==="f32"||s==="i32"||s==="u32"||s==="bool"||s==="f16"||s==="vec2"||s==="vec3"||s==="vec4"||s==="vec2f"||s==="vec3f"||s==="vec4f"||s==="vec2i"||s==="vec3i"||s==="vec4i"||s==="vec2u"||s==="vec3u"||s==="vec4u"||s==="vec2h"||s==="vec3h"||s==="vec4h"||s==="vec2b"||s==="vec3b"||s==="vec4b"||s==="mat2x2"||s==="mat2x3"||s==="mat2x4"||s==="mat3x2"||s==="mat3x3"||s==="mat3x4"||s==="mat4x2"||s==="mat4x3"||s==="mat4x4"||s==="mat2x2f"||s==="mat2x3f"||s==="mat2x4f"||s==="mat3x2f"||s==="mat3x3f"||s==="mat3x4f"||s==="mat4x2f"||s==="mat4x3f"||s==="mat4x4f"||s==="mat2x2h"||s==="mat2x3h"||s==="mat2x4h"||s==="mat3x2h"||s==="mat3x3h"||s==="mat3x4h"||s==="mat4x2h"||s==="mat4x3h"||s==="mat4x4h"||e.type instanceof vh||e.type instanceof Gn||e.type instanceof Re){const a=new Tn(e.type,[]);r=this._evalCreate(a,t)}}t.createVariable(e.name,r,e)}_switch(e,t){t=t.clone();const r=this.evalExpression(e.condition,t);if(!(r instanceof Ae))return console.error(`Invalid if condition. Line ${e.line}`),null;let s=null;for(const a of e.cases)if(a instanceof r2)for(const u of a.selectors){if(u instanceof kf){s=a;continue}const l=this.evalExpression(u,t);if(!(l instanceof Ae))return console.error(`Invalid case selector. Line ${e.line}`),null;if(l.value===r.value)return this._execStatements(a.body,t)}else a instanceof s2&&(s=a);return s?this._execStatements(s.body,t):null}_if(e,t){t=t.clone();const r=this.evalExpression(e.condition,t);if(!(r instanceof Ae))return console.error(`Invalid if condition. Line ${e.line}`),null;if(r.value)return this._execStatements(e.body,t);for(const s of e.elseif){const a=this.evalExpression(s.condition,t);if(!(a instanceof Ae))return console.error(`Invalid if condition. Line ${e.line}`),null;if(a.value)return this._execStatements(s.body,t)}return e.else?this._execStatements(e.else,t):null}_getScalarValue(e){return e instanceof Ae?e.value:(console.error("Expected scalar value.",e),0)}_for(e,t){for(t=t.clone(),this.execStatement(e.init,t);this._getScalarValue(this.evalExpression(e.condition,t));){const r=this._execStatements(e.body,t);if(r===Wr._breakObj)break;if(r!==null&&r!==Wr._continueObj)return r;this.execStatement(e.increment,t)}return null}_loop(e,t){for(t=t.clone();;){const r=this._execStatements(e.body,t);if(r===Wr._breakObj)break;if(r===Wr._continueObj){if(e.continuing&&this._execStatements(e.continuing.body,t)===Wr._breakObj)break}else if(r!==null)return r}return null}_while(e,t){for(t=t.clone();this._getScalarValue(this.evalExpression(e.condition,t));){const r=this._execStatements(e.body,t);if(r===Wr._breakObj)break;if(r!==Wr._continueObj&&r!==null)return r}return null}_evalBitcast(e,t){const r=this.evalExpression(e.value,t),s=e.type;if(r instanceof Ae){const a=xb(r.value,r.typeInfo.name,s.name);return new Ae(a,this.getTypeInfo(s))}if(r instanceof ne){const a=r.typeInfo.getTypeName();let u="";if(a.endsWith("f"))u="f32";else if(a.endsWith("i"))u="i32";else if(a.endsWith("u"))u="u32";else if(a.endsWith("b"))u="bool";else{if(!a.endsWith("h"))return console.error(`Unknown vector type ${a}. Line ${e.line}`),null;u="f16"}const l=s.getTypeName();let g="";if(l.endsWith("f"))g="f32";else if(l.endsWith("i"))g="i32";else if(l.endsWith("u"))g="u32";else if(l.endsWith("b"))g="bool";else{if(!l.endsWith("h"))return console.error(`Unknown vector type ${g}. Line ${e.line}`),null;g="f16"}const v=(function(T,S,P){if(S===P)return T;const O=new Array(T.length);for(let $=0;$<T.length;$++)O[$]=xb(T[$],S,P);return O})(Array.from(r.data),u,g);return new ne(v,this.getTypeInfo(s))}return console.error(`TODO: bitcast for ${r.typeInfo.name}. Line ${e.line}`),null}_evalConst(e,t){return t.getVariableValue(e.name).clone().getSubData(this,e.postfix,t)}_evalCreate(e,t){var r;if(e instanceof Tn){if(e.type===null)return Km.void;switch(e.type.getTypeName()){case"bool":case"i32":case"u32":case"f32":case"f16":return this._callConstructorValue(e,t);case"vec2":case"vec3":case"vec4":case"vec2f":case"vec3f":case"vec4f":case"vec2h":case"vec3h":case"vec4h":case"vec2i":case"vec3i":case"vec4i":case"vec2u":case"vec3u":case"vec4u":case"vec2b":case"vec3b":case"vec4b":return this._callConstructorVec(e,t);case"mat2x2":case"mat2x2f":case"mat2x2h":case"mat2x3":case"mat2x3f":case"mat2x3h":case"mat2x4":case"mat2x4f":case"mat2x4h":case"mat3x2":case"mat3x2f":case"mat3x2h":case"mat3x3":case"mat3x3f":case"mat3x3h":case"mat3x4":case"mat3x4f":case"mat3x4h":case"mat4x2":case"mat4x2f":case"mat4x2h":case"mat4x3":case"mat4x3f":case"mat4x3h":case"mat4x4":case"mat4x4f":case"mat4x4h":return this._callConstructorMatrix(e,t)}}const s=e instanceof Tn?e.type.name:e.name,a=e instanceof Tn?this.getTypeInfo(e.type):this.getTypeInfo(e.name);if(a===null)return console.error(`Unknown type ${s}. Line ${e.line}`),null;if(a.size===0)return null;const u=new Ki(new ArrayBuffer(a.size),a,0);if(a instanceof Zo){if(e.args)for(let l=0;l<e.args.length;++l){const g=a.members[l],v=e.args[l],T=this.evalExpression(v,t);u.setData(this,T,g.type,g.offset,t)}}else if(a instanceof Qo){let l=0;if(e.args)for(let g=0;g<e.args.length;++g){const v=e.args[g],T=this.evalExpression(v,t);a.format===null&&(((r=T.typeInfo)===null||r===void 0?void 0:r.name)==="x32"?a.format=this.getTypeInfo("i32"):a.format=T.typeInfo),u.setData(this,T,a.format,l,t),l+=a.stride}}else console.error(`Unknown type "${s}". Line ${e.line}`);return e instanceof Tn?u.getSubData(this,e.postfix,t):u}_evalLiteral(e,t){const r=this.getTypeInfo(e.type),s=r.name;return s==="x32"||s==="u32"||s==="f32"||s==="f16"||s==="i32"||s==="bool"?new Ae(e.scalarValue,r):s==="vec2"||s==="vec3"||s==="vec4"||s==="vec2f"||s==="vec3f"||s==="vec4f"||s==="vec2h"||s==="vec3h"||s==="vec4h"||s==="vec2i"||s==="vec3i"||s==="vec4i"||s==="vec2u"||s==="vec3u"||s==="vec4u"?this._callConstructorVec(e,t):s==="mat2x2"||s==="mat2x3"||s==="mat2x4"||s==="mat3x2"||s==="mat3x3"||s==="mat3x4"||s==="mat4x2"||s==="mat4x3"||s==="mat4x4"||s==="mat2x2f"||s==="mat2x3f"||s==="mat2x4f"||s==="mat3x2f"||s==="mat3x3f"||s==="mat3x4f"||s==="mat4x2f"||s==="mat4x3f"||s==="mat4x4f"||s==="mat2x2h"||s==="mat2x3h"||s==="mat2x4h"||s==="mat3x2h"||s==="mat3x3h"||s==="mat3x4h"||s==="mat4x2h"||s==="mat4x3h"||s==="mat4x4h"?this._callConstructorMatrix(e,t):e.value}_evalVariable(e,t){const r=t.getVariableValue(e.name);return r===null?r:r.getSubData(this,e.postfix,t)}_maxFormatTypeInfo(e){let t=e[0];if(t.name==="f32")return t;for(let r=1;r<e.length;++r){const s=Wr._priority.get(t.name);Wr._priority.get(e[r].name)<s&&(t=e[r])}return t.name==="x32"?this.getTypeInfo("i32"):t}_evalUnaryOp(e,t){const r=this.evalExpression(e.right,t);if(e.operator==="&")return new Ql(r);if(e.operator==="*")return r instanceof Ql?r.reference.getSubData(this,e.postfix,t):(console.error(`Invalid dereference. Line ${e.line}`),null);const s=r instanceof Ae?r.value:r instanceof ne?Array.from(r.data):null;switch(e.operator){case"+":{if(bt(s)){const l=s.map((g,v)=>+g);return new ne(l,r.typeInfo)}const a=s,u=this._maxFormatTypeInfo([r.typeInfo,r.typeInfo]);return new Ae(+a,u)}case"-":{if(bt(s)){const l=s.map((g,v)=>-g);return new ne(l,r.typeInfo)}const a=s,u=this._maxFormatTypeInfo([r.typeInfo,r.typeInfo]);return new Ae(-a,u)}case"!":{if(bt(s)){const l=s.map((g,v)=>g?0:1);return new ne(l,r.typeInfo)}const a=s,u=this._maxFormatTypeInfo([r.typeInfo,r.typeInfo]);return new Ae(a?0:1,u)}case"~":{if(bt(s)){const l=s.map((g,v)=>~g);return new ne(l,r.typeInfo)}const a=s,u=this._maxFormatTypeInfo([r.typeInfo,r.typeInfo]);return new Ae(~a,u)}}return console.error(`Invalid unary operator ${e.operator}. Line ${e.line}`),null}_evalBinaryOp(e,t){const r=this.evalExpression(e.left,t),s=this.evalExpression(e.right,t),a=r instanceof Ae?r.value:r instanceof ne||r instanceof Wt?Array.from(r.data):null,u=s instanceof Ae?s.value:s instanceof ne||s instanceof Wt?Array.from(s.data):null;switch(e.operator){case"+":{if(bt(a)&&bt(u)){const T=a,S=u;if(T.length!==S.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const P=T.map((O,$)=>O+S[$]);return new ne(P,r.typeInfo)}if(bt(a)){const T=u,S=a.map((P,O)=>P+T);return new ne(S,r.typeInfo)}if(bt(u)){const T=a,S=u.map((P,O)=>T+P);return new ne(S,s.typeInfo)}const l=a,g=u,v=this._maxFormatTypeInfo([r.typeInfo,s.typeInfo]);return new Ae(l+g,v)}case"-":{if(bt(a)&&bt(u)){const T=a,S=u;if(T.length!==S.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const P=T.map((O,$)=>O-S[$]);return new ne(P,r.typeInfo)}if(bt(a)){const T=u,S=a.map((P,O)=>P-T);return new ne(S,r.typeInfo)}if(bt(u)){const T=a,S=u.map((P,O)=>T-P);return new ne(S,s.typeInfo)}const l=a,g=u,v=this._maxFormatTypeInfo([r.typeInfo,s.typeInfo]);return new Ae(l-g,v)}case"*":{if(bt(a)&&bt(u)){const T=a,S=u;if(r instanceof Wt&&s instanceof Wt){const P=(function(G,Q,ae,te){if(ss[Q.name]===void 0||ss[te.name]===void 0)return null;const me=ss[Q.name][0],we=ss[Q.name][1],Oe=ss[te.name][0];if(me!==ss[te.name][1])return null;const Je=new Array(Oe*we);for(let it=0;it<we;it++)for(let He=0;He<Oe;He++){let ht=0;for(let Ye=0;Ye<me;Ye++)ht+=G[Ye*we+it]*ae[He*me+Ye];Je[it*Oe+He]=ht}return Je})(T,r.typeInfo,S,s.typeInfo);if(P===null)return console.error(`Matrix multiplication failed. Line ${e.line}.`),null;const O=ss[s.typeInfo.name][0],$=ss[r.typeInfo.name][1],W=this.getTypeInfo(`mat${O}x${$}f`);return new Wt(P,W)}if(r instanceof Wt&&s instanceof ne){const P=(function(O,$,W,G){if(ss[$.name]===void 0||nm[G.name]===void 0)return null;const Q=ss[$.name][0],ae=ss[$.name][1];if(Q!==W.length)return null;const te=new Array(ae);for(let me=0;me<ae;me++){let we=0;for(let Oe=0;Oe<Q;Oe++)we+=O[Oe*ae+me]*W[Oe];te[me]=we}return te})(T,r.typeInfo,S,s.typeInfo);return P===null?(console.error(`Matrix vector multiplication failed. Line ${e.line}.`),null):new ne(P,s.typeInfo)}if(r instanceof ne&&s instanceof Wt){const P=(function(O,$,W,G){if(nm[$.name]===void 0||ss[G.name]===void 0)return null;const Q=ss[G.name][0],ae=ss[G.name][1];if(ae!==O.length)return null;const te=[];for(let me=0;me<Q;me++){let we=0;for(let Oe=0;Oe<ae;Oe++)we+=O[Oe]*W[Oe*Q+me];te[me]=we}return te})(T,r.typeInfo,S,s.typeInfo);return P===null?(console.error(`Matrix vector multiplication failed. Line ${e.line}.`),null):new ne(P,r.typeInfo)}{if(T.length!==S.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const P=T.map((O,$)=>O*S[$]);return new ne(P,r.typeInfo)}}if(bt(a)){const T=u,S=a.map((P,O)=>P*T);return r instanceof Wt?new Wt(S,r.typeInfo):new ne(S,r.typeInfo)}if(bt(u)){const T=a,S=u.map((P,O)=>T*P);return s instanceof Wt?new Wt(S,s.typeInfo):new ne(S,s.typeInfo)}const l=a,g=u,v=this._maxFormatTypeInfo([r.typeInfo,s.typeInfo]);return new Ae(l*g,v)}case"%":{if(bt(a)&&bt(u)){const T=a,S=u;if(T.length!==S.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const P=T.map((O,$)=>O%S[$]);return new ne(P,r.typeInfo)}if(bt(a)){const T=u,S=a.map((P,O)=>P%T);return new ne(S,r.typeInfo)}if(bt(u)){const T=a,S=u.map((P,O)=>T%P);return new ne(S,s.typeInfo)}const l=a,g=u,v=this._maxFormatTypeInfo([r.typeInfo,s.typeInfo]);return new Ae(l%g,v)}case"/":{if(bt(a)&&bt(u)){const T=a,S=u;if(T.length!==S.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const P=T.map((O,$)=>O/S[$]);return new ne(P,r.typeInfo)}if(bt(a)){const T=u,S=a.map((P,O)=>P/T);return new ne(S,r.typeInfo)}if(bt(u)){const T=a,S=u.map((P,O)=>T/P);return new ne(S,s.typeInfo)}const l=a,g=u,v=this._maxFormatTypeInfo([r.typeInfo,s.typeInfo]);return new Ae(l/g,v)}case"&":{if(bt(a)&&bt(u)){const T=a,S=u;if(T.length!==S.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const P=T.map((O,$)=>O&S[$]);return new ne(P,r.typeInfo)}if(bt(a)){const T=u,S=a.map((P,O)=>P&T);return new ne(S,r.typeInfo)}if(bt(u)){const T=a,S=u.map((P,O)=>T&P);return new ne(S,s.typeInfo)}const l=a,g=u,v=this._maxFormatTypeInfo([r.typeInfo,s.typeInfo]);return new Ae(l&g,v)}case"|":{if(bt(a)&&bt(u)){const T=a,S=u;if(T.length!==S.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const P=T.map((O,$)=>O|S[$]);return new ne(P,r.typeInfo)}if(bt(a)){const T=u,S=a.map((P,O)=>P|T);return new ne(S,r.typeInfo)}if(bt(u)){const T=a,S=u.map((P,O)=>T|P);return new ne(S,s.typeInfo)}const l=a,g=u,v=this._maxFormatTypeInfo([r.typeInfo,s.typeInfo]);return new Ae(l|g,v)}case"^":{if(bt(a)&&bt(u)){const T=a,S=u;if(T.length!==S.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const P=T.map((O,$)=>O^S[$]);return new ne(P,r.typeInfo)}if(bt(a)){const T=u,S=a.map((P,O)=>P^T);return new ne(S,r.typeInfo)}if(bt(u)){const T=a,S=u.map((P,O)=>T^P);return new ne(S,s.typeInfo)}const l=a,g=u,v=this._maxFormatTypeInfo([r.typeInfo,s.typeInfo]);return new Ae(l^g,v)}case"<<":{if(bt(a)&&bt(u)){const T=a,S=u;if(T.length!==S.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const P=T.map((O,$)=>O<<S[$]);return new ne(P,r.typeInfo)}if(bt(a)){const T=u,S=a.map((P,O)=>P<<T);return new ne(S,r.typeInfo)}if(bt(u)){const T=a,S=u.map((P,O)=>T<<P);return new ne(S,s.typeInfo)}const l=a,g=u,v=this._maxFormatTypeInfo([r.typeInfo,s.typeInfo]);return new Ae(l<<g,v)}case">>":{if(bt(a)&&bt(u)){const T=a,S=u;if(T.length!==S.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const P=T.map((O,$)=>O>>S[$]);return new ne(P,r.typeInfo)}if(bt(a)){const T=u,S=a.map((P,O)=>P>>T);return new ne(S,r.typeInfo)}if(bt(u)){const T=a,S=u.map((P,O)=>T>>P);return new ne(S,s.typeInfo)}const l=a,g=u,v=this._maxFormatTypeInfo([r.typeInfo,s.typeInfo]);return new Ae(l>>g,v)}case">":if(bt(a)&&bt(u)){const l=a,g=u;if(l.length!==g.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const v=l.map((T,S)=>T>g[S]?1:0);return new ne(v,r.typeInfo)}if(bt(a)){const l=u,g=a.map((v,T)=>v>l?1:0);return new ne(g,r.typeInfo)}if(bt(u)){const l=a,g=u.map((v,T)=>l>v?1:0);return new ne(g,s.typeInfo)}return new Ae(a>u?1:0,this.getTypeInfo("bool"));case"<":if(bt(a)&&bt(u)){const l=a,g=u;if(l.length!==g.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const v=l.map((T,S)=>T<g[S]?1:0);return new ne(v,r.typeInfo)}if(bt(a)){const l=u,g=a.map((v,T)=>v<l?1:0);return new ne(g,r.typeInfo)}if(bt(u)){const l=a,g=u.map((v,T)=>l<v?1:0);return new ne(g,s.typeInfo)}return new Ae(a<u?1:0,this.getTypeInfo("bool"));case"==":if(bt(a)&&bt(u)){const l=a,g=u;if(l.length!==g.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const v=l.map((T,S)=>T===g[S]?1:0);return new ne(v,r.typeInfo)}if(bt(a)){const l=u,g=a.map((v,T)=>v==l?1:0);return new ne(g,r.typeInfo)}if(bt(u)){const l=a,g=u.map((v,T)=>l==v?1:0);return new ne(g,s.typeInfo)}return new Ae(a===u?1:0,this.getTypeInfo("bool"));case"!=":if(bt(a)&&bt(u)){const l=a,g=u;if(l.length!==g.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const v=l.map((T,S)=>T!==g[S]?1:0);return new ne(v,r.typeInfo)}if(bt(a)){const l=u,g=a.map((v,T)=>v!==l?1:0);return new ne(g,r.typeInfo)}if(bt(u)){const l=a,g=u.map((v,T)=>l!==v?1:0);return new ne(g,s.typeInfo)}return new Ae(a!==u?1:0,this.getTypeInfo("bool"));case">=":if(bt(a)&&bt(u)){const l=a,g=u;if(l.length!==g.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const v=l.map((T,S)=>T>=g[S]?1:0);return new ne(v,r.typeInfo)}if(bt(a)){const l=u,g=a.map((v,T)=>v>=l?1:0);return new ne(g,r.typeInfo)}if(bt(u)){const l=a,g=u.map((v,T)=>l>=v?1:0);return new ne(g,s.typeInfo)}return new Ae(a>=u?1:0,this.getTypeInfo("bool"));case"<=":if(bt(a)&&bt(u)){const l=a,g=u;if(l.length!==g.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const v=l.map((T,S)=>T<=g[S]?1:0);return new ne(v,r.typeInfo)}if(bt(a)){const l=u,g=a.map((v,T)=>v<=l?1:0);return new ne(g,r.typeInfo)}if(bt(u)){const l=a,g=u.map((v,T)=>l<=v?1:0);return new ne(g,s.typeInfo)}return new Ae(a<=u?1:0,this.getTypeInfo("bool"));case"&&":if(bt(a)&&bt(u)){const l=a,g=u;if(l.length!==g.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const v=l.map((T,S)=>T&&g[S]?1:0);return new ne(v,r.typeInfo)}if(bt(a)){const l=u,g=a.map((v,T)=>v&&l?1:0);return new ne(g,r.typeInfo)}if(bt(u)){const l=a,g=u.map((v,T)=>l&&v?1:0);return new ne(g,s.typeInfo)}return new Ae(a&&u?1:0,this.getTypeInfo("bool"));case"||":if(bt(a)&&bt(u)){const l=a,g=u;if(l.length!==g.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const v=l.map((T,S)=>T||g[S]?1:0);return new ne(v,r.typeInfo)}if(bt(a)){const l=u,g=a.map((v,T)=>v||l?1:0);return new ne(g,r.typeInfo)}if(bt(u)){const l=a,g=u.map((v,T)=>l||v?1:0);return new ne(g,s.typeInfo)}return new Ae(a||u?1:0,this.getTypeInfo("bool"))}return console.error(`Unknown operator ${e.operator}. Line ${e.line}`),null}_evalCall(e,t){if(e.cachedReturnValue!==null)return e.cachedReturnValue;const r=t.clone();r.currentFunctionName=e.name;const s=t.getFunction(e.name);if(!s)return e.isBuiltin?this._callBuiltinFunction(e,r):this.getTypeInfo(e.name)?this._evalCreate(e,t):(console.error(`Unknown function "${e.name}". Line ${e.line}`),null);for(let a=0;a<s.node.args.length;++a){const u=s.node.args[a],l=this.evalExpression(e.args[a],r);r.createVariable(u.name,l,u)}return this._execStatements(s.node.body,r)}_callBuiltinFunction(e,t){switch(e.name){case"all":return this.builtins.All(e,t);case"any":return this.builtins.Any(e,t);case"select":return this.builtins.Select(e,t);case"arrayLength":return this.builtins.ArrayLength(e,t);case"abs":return this.builtins.Abs(e,t);case"acos":return this.builtins.Acos(e,t);case"acosh":return this.builtins.Acosh(e,t);case"asin":return this.builtins.Asin(e,t);case"asinh":return this.builtins.Asinh(e,t);case"atan":return this.builtins.Atan(e,t);case"atanh":return this.builtins.Atanh(e,t);case"atan2":return this.builtins.Atan2(e,t);case"ceil":return this.builtins.Ceil(e,t);case"clamp":return this.builtins.Clamp(e,t);case"cos":return this.builtins.Cos(e,t);case"cosh":return this.builtins.Cosh(e,t);case"countLeadingZeros":return this.builtins.CountLeadingZeros(e,t);case"countOneBits":return this.builtins.CountOneBits(e,t);case"countTrailingZeros":return this.builtins.CountTrailingZeros(e,t);case"cross":return this.builtins.Cross(e,t);case"degrees":return this.builtins.Degrees(e,t);case"determinant":return this.builtins.Determinant(e,t);case"distance":return this.builtins.Distance(e,t);case"dot":return this.builtins.Dot(e,t);case"dot4U8Packed":return this.builtins.Dot4U8Packed(e,t);case"dot4I8Packed":return this.builtins.Dot4I8Packed(e,t);case"exp":return this.builtins.Exp(e,t);case"exp2":return this.builtins.Exp2(e,t);case"extractBits":return this.builtins.ExtractBits(e,t);case"faceForward":return this.builtins.FaceForward(e,t);case"firstLeadingBit":return this.builtins.FirstLeadingBit(e,t);case"firstTrailingBit":return this.builtins.FirstTrailingBit(e,t);case"floor":return this.builtins.Floor(e,t);case"fma":return this.builtins.Fma(e,t);case"fract":return this.builtins.Fract(e,t);case"frexp":return this.builtins.Frexp(e,t);case"insertBits":return this.builtins.InsertBits(e,t);case"inverseSqrt":return this.builtins.InverseSqrt(e,t);case"ldexp":return this.builtins.Ldexp(e,t);case"length":return this.builtins.Length(e,t);case"log":return this.builtins.Log(e,t);case"log2":return this.builtins.Log2(e,t);case"max":return this.builtins.Max(e,t);case"min":return this.builtins.Min(e,t);case"mix":return this.builtins.Mix(e,t);case"modf":return this.builtins.Modf(e,t);case"normalize":return this.builtins.Normalize(e,t);case"pow":return this.builtins.Pow(e,t);case"quantizeToF16":return this.builtins.QuantizeToF16(e,t);case"radians":return this.builtins.Radians(e,t);case"reflect":return this.builtins.Reflect(e,t);case"refract":return this.builtins.Refract(e,t);case"reverseBits":return this.builtins.ReverseBits(e,t);case"round":return this.builtins.Round(e,t);case"saturate":return this.builtins.Saturate(e,t);case"sign":return this.builtins.Sign(e,t);case"sin":return this.builtins.Sin(e,t);case"sinh":return this.builtins.Sinh(e,t);case"smoothstep":return this.builtins.SmoothStep(e,t);case"sqrt":return this.builtins.Sqrt(e,t);case"step":return this.builtins.Step(e,t);case"tan":return this.builtins.Tan(e,t);case"tanh":return this.builtins.Tanh(e,t);case"transpose":return this.builtins.Transpose(e,t);case"trunc":return this.builtins.Trunc(e,t);case"dpdx":return this.builtins.Dpdx(e,t);case"dpdxCoarse":return this.builtins.DpdxCoarse(e,t);case"dpdxFine":return this.builtins.DpdxFine(e,t);case"dpdy":return this.builtins.Dpdy(e,t);case"dpdyCoarse":return this.builtins.DpdyCoarse(e,t);case"dpdyFine":return this.builtins.DpdyFine(e,t);case"fwidth":return this.builtins.Fwidth(e,t);case"fwidthCoarse":return this.builtins.FwidthCoarse(e,t);case"fwidthFine":return this.builtins.FwidthFine(e,t);case"textureDimensions":return this.builtins.TextureDimensions(e,t);case"textureGather":return this.builtins.TextureGather(e,t);case"textureGatherCompare":return this.builtins.TextureGatherCompare(e,t);case"textureLoad":return this.builtins.TextureLoad(e,t);case"textureNumLayers":return this.builtins.TextureNumLayers(e,t);case"textureNumLevels":return this.builtins.TextureNumLevels(e,t);case"textureNumSamples":return this.builtins.TextureNumSamples(e,t);case"textureSample":return this.builtins.TextureSample(e,t);case"textureSampleBias":return this.builtins.TextureSampleBias(e,t);case"textureSampleCompare":return this.builtins.TextureSampleCompare(e,t);case"textureSampleCompareLevel":return this.builtins.TextureSampleCompareLevel(e,t);case"textureSampleGrad":return this.builtins.TextureSampleGrad(e,t);case"textureSampleLevel":return this.builtins.TextureSampleLevel(e,t);case"textureSampleBaseClampToEdge":return this.builtins.TextureSampleBaseClampToEdge(e,t);case"textureStore":return this.builtins.TextureStore(e,t);case"atomicLoad":return this.builtins.AtomicLoad(e,t);case"atomicStore":return this.builtins.AtomicStore(e,t);case"atomicAdd":return this.builtins.AtomicAdd(e,t);case"atomicSub":return this.builtins.AtomicSub(e,t);case"atomicMax":return this.builtins.AtomicMax(e,t);case"atomicMin":return this.builtins.AtomicMin(e,t);case"atomicAnd":return this.builtins.AtomicAnd(e,t);case"atomicOr":return this.builtins.AtomicOr(e,t);case"atomicXor":return this.builtins.AtomicXor(e,t);case"atomicExchange":return this.builtins.AtomicExchange(e,t);case"atomicCompareExchangeWeak":return this.builtins.AtomicCompareExchangeWeak(e,t);case"pack4x8snorm":return this.builtins.Pack4x8snorm(e,t);case"pack4x8unorm":return this.builtins.Pack4x8unorm(e,t);case"pack4xI8":return this.builtins.Pack4xI8(e,t);case"pack4xU8":return this.builtins.Pack4xU8(e,t);case"pack4x8Clamp":return this.builtins.Pack4x8Clamp(e,t);case"pack4xU8Clamp":return this.builtins.Pack4xU8Clamp(e,t);case"pack2x16snorm":return this.builtins.Pack2x16snorm(e,t);case"pack2x16unorm":return this.builtins.Pack2x16unorm(e,t);case"pack2x16float":return this.builtins.Pack2x16float(e,t);case"unpack4x8snorm":return this.builtins.Unpack4x8snorm(e,t);case"unpack4x8unorm":return this.builtins.Unpack4x8unorm(e,t);case"unpack4xI8":return this.builtins.Unpack4xI8(e,t);case"unpack4xU8":return this.builtins.Unpack4xU8(e,t);case"unpack2x16snorm":return this.builtins.Unpack2x16snorm(e,t);case"unpack2x16unorm":return this.builtins.Unpack2x16unorm(e,t);case"unpack2x16float":return this.builtins.Unpack2x16float(e,t);case"storageBarrier":return this.builtins.StorageBarrier(e,t);case"textureBarrier":return this.builtins.TextureBarrier(e,t);case"workgroupBarrier":return this.builtins.WorkgroupBarrier(e,t);case"workgroupUniformLoad":return this.builtins.WorkgroupUniformLoad(e,t);case"subgroupAdd":return this.builtins.SubgroupAdd(e,t);case"subgroupExclusiveAdd":return this.builtins.SubgroupExclusiveAdd(e,t);case"subgroupInclusiveAdd":return this.builtins.SubgroupInclusiveAdd(e,t);case"subgroupAll":return this.builtins.SubgroupAll(e,t);case"subgroupAnd":return this.builtins.SubgroupAnd(e,t);case"subgroupAny":return this.builtins.SubgroupAny(e,t);case"subgroupBallot":return this.builtins.SubgroupBallot(e,t);case"subgroupBroadcast":return this.builtins.SubgroupBroadcast(e,t);case"subgroupBroadcastFirst":return this.builtins.SubgroupBroadcastFirst(e,t);case"subgroupElect":return this.builtins.SubgroupElect(e,t);case"subgroupMax":return this.builtins.SubgroupMax(e,t);case"subgroupMin":return this.builtins.SubgroupMin(e,t);case"subgroupMul":return this.builtins.SubgroupMul(e,t);case"subgroupExclusiveMul":return this.builtins.SubgroupExclusiveMul(e,t);case"subgroupInclusiveMul":return this.builtins.SubgroupInclusiveMul(e,t);case"subgroupOr":return this.builtins.SubgroupOr(e,t);case"subgroupShuffle":return this.builtins.SubgroupShuffle(e,t);case"subgroupShuffleDown":return this.builtins.SubgroupShuffleDown(e,t);case"subgroupShuffleUp":return this.builtins.SubgroupShuffleUp(e,t);case"subgroupShuffleXor":return this.builtins.SubgroupShuffleXor(e,t);case"subgroupXor":return this.builtins.SubgroupXor(e,t);case"quadBroadcast":return this.builtins.QuadBroadcast(e,t);case"quadSwapDiagonal":return this.builtins.QuadSwapDiagonal(e,t);case"quadSwapX":return this.builtins.QuadSwapX(e,t);case"quadSwapY":return this.builtins.QuadSwapY(e,t)}const r=t.getFunction(e.name);if(r){const s=t.clone();for(let a=0;a<r.node.args.length;++a){const u=r.node.args[a],l=this.evalExpression(e.args[a],s);s.setVariable(u.name,l,u)}return this._execStatements(r.node.body,s)}return null}_callConstructorValue(e,t){if(!e.args||e.args.length===0)return new Ae(0,this.getTypeInfo(e.type));const r=this.evalExpression(e.args[0],t);return r.typeInfo=this.getTypeInfo(e.type),r.getSubData(this,e.postfix,t).clone()}_callConstructorVec(e,t){const r=this.getTypeInfo(e.type),s=e.type.getTypeName(),a=nm[s];if(a===void 0)return console.error(`Invalid vec constructor ${s}. Line ${e.line}`),null;const u=[];if(e instanceof hr)if(e.isVector){const l=e.vectorValue;for(const g of l)u.push(g)}else u.push(e.scalarValue);else if(e.args)for(const l of e.args){const g=this.evalExpression(l,t);if(g instanceof ne){const v=g.data;for(let T=0;T<v.length;++T){let S=v[T];u.push(S)}}else if(g instanceof Ae){let v=g.value;u.push(v)}}if(e.type instanceof Re&&e.type.format===null&&(e.type.format=Re.f32),u.length===0){const l=new Array(a).fill(0);return new ne(l,r).getSubData(this,e.postfix,t)}if(u.length===1)for(;u.length<a;)u.push(u[0]);return u.length<a?(console.error(`Invalid vec constructor. Line ${e.line}`),null):new ne(u.length>a?u.slice(0,a):u,r).getSubData(this,e.postfix,t)}_callConstructorMatrix(e,t){const r=this.getTypeInfo(e.type),s=e.type.getTypeName(),a=ss[s];if(a===void 0)return console.error(`Invalid matrix constructor ${s}. Line ${e.line}`),null;const u=[];if(e instanceof hr)if(e.isVector){const l=e.vectorValue;for(const g of l)u.push(g)}else u.push(e.scalarValue);else if(e.args)for(const l of e.args){const g=this.evalExpression(l,t);g instanceof ne?u.push(...g.data):g instanceof Ae?u.push(g.value):g instanceof Wt&&u.push(...g.data)}if(r instanceof Za&&r.format===null&&(r.format=this.getTypeInfo("f32")),u.length===0){const l=new Array(a[2]).fill(0);return new Wt(l,r).getSubData(this,e.postfix,t)}return u.length!==a[2]?(console.error(`Invalid matrix constructor. Line ${e.line}`),null):new Wt(u,r).getSubData(this,e.postfix,t)}}Wr._breakObj=new Js(new Ys("BREAK",null),null),Wr._continueObj=new Js(new Ys("CONTINUE",null),null),Wr._priority=new Map([["f32",0],["f16",1],["u32",2],["i32",3],["x32",3]]);class XP{constructor(){this.constants=new Map,this.aliases=new Map,this.structs=new Map}}class ZP{constructor(){this._tokens=[],this._current=0,this._currentLine=1,this._deferArrayCountEval=[],this._currentLoop=[],this._context=new XP,this._exec=new Wr,this._forwardTypeCount=0}parse(e){this._initialize(e),this._deferArrayCountEval.length=0;const t=[];for(;!this._isAtEnd();){const r=this._global_decl_or_directive();if(!r)break;t.push(r)}if(this._deferArrayCountEval.length>0){for(const r of this._deferArrayCountEval){const s=r.arrayType,a=r.countNode;if(a instanceof Ls){const u=a.name,l=this._context.constants.get(u);if(l)try{const g=l.constEvaluate(this._exec);s.count=g}catch{}}}this._deferArrayCountEval.length=0}if(this._forwardTypeCount>0)for(const r of t)r.search(s=>{s instanceof _b||s instanceof Rf?s.type=this._forwardType(s.type):s instanceof vh?s.format=this._forwardType(s.format):s instanceof Jn||s instanceof xh||s instanceof Mf?s.type=this._forwardType(s.type):s instanceof Ph?s.returnType=this._forwardType(s.returnType):s instanceof mb&&(s.type=this._forwardType(s.type))});return t}_forwardType(e){if(e instanceof gb){const t=this._getType(e.name);if(t)return t}else e instanceof Rf?e.type=this._forwardType(e.type):e instanceof vh&&(e.format=this._forwardType(e.format));return e}_initialize(e){if(e)if(typeof e=="string"){const t=new BP(e);this._tokens=t.scanTokens()}else this._tokens=e;else this._tokens=[];this._current=0}_updateNode(e,t){return e.line=t??this._currentLine,e}_error(e,t){return{token:e,message:t,toString:()=>`${t}`}}_isAtEnd(){return this._current>=this._tokens.length||this._peek().type==J.eof}_match(e){if(e instanceof Pe)return!!this._check(e)&&(this._advance(),!0);for(let t=0,r=e.length;t<r;++t){const s=e[t];if(this._check(s))return this._advance(),!0}return!1}_consume(e,t){if(this._check(e))return this._advance();throw this._error(this._peek(),`${t}. Line:${this._currentLine}`)}_check(e){if(this._isAtEnd())return!1;const t=this._peek();if(e instanceof Array){const r=t.type;let s=!1;for(const a of e){if(r===a)return!0;a===J.tokens.name&&(s=!0)}if(s){const a=J.tokens.name.rule.exec(t.lexeme);if(a&&a.index==0&&a[0]==t.lexeme)return!0}return!1}if(t.type===e)return!0;if(e===J.tokens.name){const r=J.tokens.name.rule.exec(t.lexeme);return r&&r.index==0&&r[0]==t.lexeme}return!1}_advance(){var e,t;return this._currentLine=(t=(e=this._peek())===null||e===void 0?void 0:e.line)!==null&&t!==void 0?t:-1,this._isAtEnd()||this._current++,this._previous()}_peek(){return this._tokens[this._current]}_previous(){return this._tokens[this._current-1]}_global_decl_or_directive(){for(;this._match(J.tokens.semicolon)&&!this._isAtEnd(););if(this._match(J.keywords.alias)){const t=this._type_alias();return this._consume(J.tokens.semicolon,"Expected ';'"),this._exec.reflection.updateAST([t]),t}if(this._match(J.keywords.diagnostic)){const t=this._diagnostic();return this._consume(J.tokens.semicolon,"Expected ';'"),this._exec.reflection.updateAST([t]),t}if(this._match(J.keywords.requires)){const t=this._requires_directive();return this._consume(J.tokens.semicolon,"Expected ';'"),this._exec.reflection.updateAST([t]),t}if(this._match(J.keywords.enable)){const t=this._enable_directive();return this._consume(J.tokens.semicolon,"Expected ';'"),this._exec.reflection.updateAST([t]),t}const e=this._attribute();if(this._check(J.keywords.var)){const t=this._global_variable_decl();return t!=null&&(t.attributes=e),this._consume(J.tokens.semicolon,"Expected ';'."),this._exec.reflection.updateAST([t]),t}if(this._check(J.keywords.override)){const t=this._override_variable_decl();return t!=null&&(t.attributes=e),this._consume(J.tokens.semicolon,"Expected ';'."),this._exec.reflection.updateAST([t]),t}if(this._check(J.keywords.let)){const t=this._global_let_decl();return t!=null&&(t.attributes=e),this._consume(J.tokens.semicolon,"Expected ';'."),this._exec.reflection.updateAST([t]),t}if(this._check(J.keywords.const)){const t=this._global_const_decl();return t!=null&&(t.attributes=e),this._consume(J.tokens.semicolon,"Expected ';'."),this._exec.reflection.updateAST([t]),t}if(this._check(J.keywords.struct)){const t=this._struct_decl();return t!=null&&(t.attributes=e),this._exec.reflection.updateAST([t]),t}if(this._check(J.keywords.fn)){const t=this._function_decl();return t!=null&&(t.attributes=e),this._exec.reflection.updateAST([t]),t}return null}_function_decl(){if(!this._match(J.keywords.fn))return null;const e=this._currentLine,t=this._consume(J.tokens.ident,"Expected function name.").toString();this._consume(J.tokens.paren_left,"Expected '(' for function arguments.");const r=[];if(!this._check(J.tokens.paren_right))do{if(this._check(J.tokens.paren_right))break;const l=this._attribute(),g=this._consume(J.tokens.name,"Expected argument name.").toString();this._consume(J.tokens.colon,"Expected ':' for argument type.");const v=this._attribute(),T=this._type_decl();T!=null&&(T.attributes=v,r.push(this._updateNode(new mb(g,T,l))))}while(this._match(J.tokens.comma));this._consume(J.tokens.paren_right,"Expected ')' after function arguments.");let s=null;if(this._match(J.tokens.arrow)){const l=this._attribute();s=this._type_decl(),s!=null&&(s.attributes=l)}const a=this._compound_statement(),u=this._currentLine;return this._updateNode(new Ph(t,r,s,a,e,u),e)}_compound_statement(){const e=[];for(this._consume(J.tokens.brace_left,"Expected '{' for block.");!this._check(J.tokens.brace_right);){const t=this._statement();t!==null&&e.push(t)}return this._consume(J.tokens.brace_right,"Expected '}' for block."),e}_statement(){for(;this._match(J.tokens.semicolon)&&!this._isAtEnd(););if(this._check(J.tokens.attr)&&this._attribute(),this._check(J.keywords.if))return this._if_statement();if(this._check(J.keywords.switch))return this._switch_statement();if(this._check(J.keywords.loop))return this._loop_statement();if(this._check(J.keywords.for))return this._for_statement();if(this._check(J.keywords.while))return this._while_statement();if(this._check(J.keywords.continuing))return this._continuing_statement();if(this._check(J.keywords.static_assert))return this._static_assert_statement();if(this._check(J.tokens.brace_left))return this._compound_statement();let e=null;if(this._check(J.keywords.return))e=this._return_statement();else if(this._check([J.keywords.var,J.keywords.let,J.keywords.const]))e=this._variable_statement();else if(this._match(J.keywords.discard))e=this._updateNode(new OP);else if(this._match(J.keywords.break)){const t=this._updateNode(new K1);if(this._currentLoop.length>0){const r=this._currentLoop[this._currentLoop.length-1];t.loopId=r.id}e=t,this._check(J.keywords.if)&&(this._advance(),t.condition=this._optional_paren_expression())}else if(this._match(J.keywords.continue)){const t=this._updateNode(new J1);if(!(this._currentLoop.length>0))throw this._error(this._peek(),`Continue statement must be inside a loop. Line: ${t.line}`);{const r=this._currentLoop[this._currentLoop.length-1];t.loopId=r.id}e=t}else e=this._increment_decrement_statement()||this._func_call_statement()||this._assignment_statement();return e!=null&&this._consume(J.tokens.semicolon,"Expected ';' after statement."),e}_static_assert_statement(){if(!this._match(J.keywords.static_assert))return null;const e=this._currentLine,t=this._optional_paren_expression();return this._updateNode(new RP(t),e)}_while_statement(){if(!this._match(J.keywords.while))return null;const e=this._updateNode(new j1(null,null));return this._currentLoop.push(e),e.condition=this._optional_paren_expression(),this._check(J.tokens.attr)&&this._attribute(),e.body=this._compound_statement(),this._currentLoop.pop(),e}_continuing_statement(){const e=this._currentLoop.length>0?this._currentLoop[this._currentLoop.length-1].id:-1;if(!this._match(J.keywords.continuing))return null;const t=this._currentLine,r=this._compound_statement();return this._updateNode(new Gm(r,e),t)}_for_statement(){if(!this._match(J.keywords.for))return null;this._consume(J.tokens.paren_left,"Expected '('.");const e=this._updateNode(new $1(null,null,null,null));return this._currentLoop.push(e),e.init=this._check(J.tokens.semicolon)?null:this._for_init(),this._consume(J.tokens.semicolon,"Expected ';'."),e.condition=this._check(J.tokens.semicolon)?null:this._short_circuit_or_expression(),this._consume(J.tokens.semicolon,"Expected ';'."),e.increment=this._check(J.tokens.paren_right)?null:this._for_increment(),this._consume(J.tokens.paren_right,"Expected ')'."),this._check(J.tokens.attr)&&this._attribute(),e.body=this._compound_statement(),this._currentLoop.pop(),e}_for_init(){return this._variable_statement()||this._func_call_statement()||this._assignment_statement()}_for_increment(){return this._func_call_statement()||this._increment_decrement_statement()||this._assignment_statement()}_variable_statement(){if(this._check(J.keywords.var)){const e=this._variable_decl();if(e===null)throw this._error(this._peek(),"Variable declaration expected.");let t=null;return this._match(J.tokens.equal)&&(t=this._short_circuit_or_expression()),this._updateNode(new Jn(e.name,e.type,e.storage,e.access,t),e.line)}if(this._match(J.keywords.let)){const e=this._currentLine,t=this._consume(J.tokens.name,"Expected name for let.").toString();let r=null;if(this._match(J.tokens.colon)){const a=this._attribute();r=this._type_decl(),r!=null&&(r.attributes=a)}this._consume(J.tokens.equal,"Expected '=' for let.");const s=this._short_circuit_or_expression();return this._updateNode(new xh(t,r,null,null,s),e)}if(this._match(J.keywords.const)){const e=this._currentLine,t=this._consume(J.tokens.name,"Expected name for const.").toString();let r=null;if(this._match(J.tokens.colon)){const a=this._attribute();r=this._type_decl(),r!=null&&(r.attributes=a)}this._consume(J.tokens.equal,"Expected '=' for const.");const s=this._short_circuit_or_expression();return r===null&&s instanceof hr&&(r=s.type),this._updateNode(new Mf(t,r,null,null,s),e)}return null}_increment_decrement_statement(){const e=this._current,t=this._unary_expression();if(t==null)return null;if(!this._check(J.increment_operators))return this._current=e,null;const r=this._consume(J.increment_operators,"Expected increment operator");return this._updateNode(new W1(r.type===J.tokens.plus_plus?oc.increment:oc.decrement,t))}_assignment_statement(){let e=null;const t=this._currentLine;if(this._check(J.tokens.brace_right))return null;let r=this._match(J.tokens.underscore);if(r||(e=this._unary_expression()),!r&&e==null)return null;const s=this._consume(J.assignment_operators,"Expected assignment operator."),a=this._short_circuit_or_expression();return this._updateNode(new H1(uh.parse(s.lexeme),e,a),t)}_func_call_statement(){if(!this._check(J.tokens.ident))return null;const e=this._currentLine,t=this._current,r=this._consume(J.tokens.ident,"Expected function name."),s=this._argument_expression_list();return s===null?(this._current=t,null):this._updateNode(new ty(r.lexeme,s),e)}_loop_statement(){if(!this._match(J.keywords.loop))return null;this._check(J.tokens.attr)&&this._attribute(),this._consume(J.tokens.brace_left,"Expected '{' for loop.");const e=this._updateNode(new q1([],null));this._currentLoop.push(e);let t=this._statement();for(;t!==null;){if(Array.isArray(t))for(let r of t)e.body.push(r);else e.body.push(t);if(t instanceof Gm){e.continuing=t;break}t=this._statement()}return this._currentLoop.pop(),this._consume(J.tokens.brace_right,"Expected '}' for loop."),e}_switch_statement(){if(!this._match(J.keywords.switch))return null;const e=this._updateNode(new X1(null,[]));if(this._currentLoop.push(e),e.condition=this._optional_paren_expression(),this._check(J.tokens.attr)&&this._attribute(),this._consume(J.tokens.brace_left,"Expected '{' for switch."),e.cases=this._switch_body(),e.cases==null||e.cases.length==0)throw this._error(this._previous(),"Expected 'case' or 'default'.");return this._consume(J.tokens.brace_right,"Expected '}' for switch."),this._currentLoop.pop(),e}_switch_body(){const e=[];let t=!1;for(;this._check([J.keywords.default,J.keywords.case]);){if(this._match(J.keywords.case)){const r=this._case_selectors();for(const a of r)if(a instanceof kf){if(t)throw this._error(this._previous(),"Multiple default cases in switch statement.");t=!0;break}this._match(J.tokens.colon),this._check(J.tokens.attr)&&this._attribute(),this._consume(J.tokens.brace_left,"Exected '{' for switch case.");const s=this._case_body();this._consume(J.tokens.brace_right,"Exected '}' for switch case."),e.push(this._updateNode(new r2(r,s)))}if(this._match(J.keywords.default)){if(t)throw this._error(this._previous(),"Multiple default cases in switch statement.");this._match(J.tokens.colon),this._check(J.tokens.attr)&&this._attribute(),this._consume(J.tokens.brace_left,"Exected '{' for switch default.");const r=this._case_body();this._consume(J.tokens.brace_right,"Exected '}' for switch default."),e.push(this._updateNode(new s2(r)))}}return e}_case_selectors(){const e=[];for(this._match(J.keywords.default)?e.push(this._updateNode(new kf)):e.push(this._shift_expression());this._match(J.tokens.comma);)this._match(J.keywords.default)?e.push(this._updateNode(new kf)):e.push(this._shift_expression());return e}_case_body(){if(this._match(J.keywords.fallthrough))return this._consume(J.tokens.semicolon,"Expected ';'"),[];let e=this._statement();if(e==null)return[];e instanceof Array||(e=[e]);const t=this._case_body();return t.length==0?e:[...e,t[0]]}_if_statement(){if(!this._match(J.keywords.if))return null;const e=this._currentLine,t=this._optional_paren_expression();this._check(J.tokens.attr)&&this._attribute();const r=this._compound_statement();let s=[];this._match_elseif()&&(this._check(J.tokens.attr)&&this._attribute(),s=this._elseif_statement(s));let a=null;return this._match(J.keywords.else)&&(this._check(J.tokens.attr)&&this._attribute(),a=this._compound_statement()),this._updateNode(new Z1(t,r,s,a),e)}_match_elseif(){return this._tokens[this._current].type===J.keywords.else&&this._tokens[this._current+1].type===J.keywords.if&&(this._advance(),this._advance(),!0)}_elseif_statement(e=[]){const t=this._optional_paren_expression(),r=this._compound_statement();return e.push(this._updateNode(new LP(t,r))),this._match_elseif()&&(this._check(J.tokens.attr)&&this._attribute(),this._elseif_statement(e)),e}_return_statement(){if(!this._match(J.keywords.return))return null;const e=this._short_circuit_or_expression();return this._updateNode(new Y1(e))}_short_circuit_or_expression(){let e=this._short_circuit_and_expr();for(;this._match(J.tokens.or_or);)e=this._updateNode(new an(this._previous().toString(),e,this._short_circuit_and_expr()));return e}_short_circuit_and_expr(){let e=this._inclusive_or_expression();for(;this._match(J.tokens.and_and);)e=this._updateNode(new an(this._previous().toString(),e,this._inclusive_or_expression()));return e}_inclusive_or_expression(){let e=this._exclusive_or_expression();for(;this._match(J.tokens.or);)e=this._updateNode(new an(this._previous().toString(),e,this._exclusive_or_expression()));return e}_exclusive_or_expression(){let e=this._and_expression();for(;this._match(J.tokens.xor);)e=this._updateNode(new an(this._previous().toString(),e,this._and_expression()));return e}_and_expression(){let e=this._equality_expression();for(;this._match(J.tokens.and);)e=this._updateNode(new an(this._previous().toString(),e,this._equality_expression()));return e}_equality_expression(){const e=this._relational_expression();return this._match([J.tokens.equal_equal,J.tokens.not_equal])?this._updateNode(new an(this._previous().toString(),e,this._relational_expression())):e}_relational_expression(){let e=this._shift_expression();for(;this._match([J.tokens.less_than,J.tokens.greater_than,J.tokens.less_than_equal,J.tokens.greater_than_equal]);)e=this._updateNode(new an(this._previous().toString(),e,this._shift_expression()));return e}_shift_expression(){let e=this._additive_expression();for(;this._match([J.tokens.shift_left,J.tokens.shift_right]);)e=this._updateNode(new an(this._previous().toString(),e,this._additive_expression()));return e}_additive_expression(){let e=this._multiplicative_expression();for(;this._match([J.tokens.plus,J.tokens.minus]);)e=this._updateNode(new an(this._previous().toString(),e,this._multiplicative_expression()));return e}_multiplicative_expression(){let e=this._unary_expression();for(;this._match([J.tokens.star,J.tokens.forward_slash,J.tokens.modulo]);)e=this._updateNode(new an(this._previous().toString(),e,this._unary_expression()));return e}_unary_expression(){return this._match([J.tokens.minus,J.tokens.bang,J.tokens.tilde,J.tokens.star,J.tokens.and])?this._updateNode(new or(this._previous().toString(),this._unary_expression())):this._singular_expression()}_singular_expression(){const e=this._primary_expression(),t=this._postfix_expression();return t&&(e.postfix=t),e}_postfix_expression(){if(this._match(J.tokens.bracket_left)){const e=this._short_circuit_or_expression();this._consume(J.tokens.bracket_right,"Expected ']'.");const t=this._updateNode(new vc(e)),r=this._postfix_expression();return r&&(t.postfix=r),t}if(this._match(J.tokens.period)){const e=this._consume(J.tokens.name,"Expected member name."),t=this._postfix_expression(),r=this._updateNode(new Ya(e.lexeme));return t&&(r.postfix=t),r}return null}_getStruct(e){return this._context.aliases.has(e)?this._context.aliases.get(e).type:this._context.structs.has(e)?this._context.structs.get(e):null}_getType(e){const t=this._getStruct(e);if(t!==null)return t;switch(e){case"void":return Ge.void;case"bool":return Ge.bool;case"i32":return Ge.i32;case"u32":return Ge.u32;case"f32":return Ge.f32;case"f16":return Ge.f16;case"vec2f":return Re.vec2f;case"vec3f":return Re.vec3f;case"vec4f":return Re.vec4f;case"vec2i":return Re.vec2i;case"vec3i":return Re.vec3i;case"vec4i":return Re.vec4i;case"vec2u":return Re.vec2u;case"vec3u":return Re.vec3u;case"vec4u":return Re.vec4u;case"vec2h":return Re.vec2h;case"vec3h":return Re.vec3h;case"vec4h":return Re.vec4h;case"mat2x2f":return Re.mat2x2f;case"mat2x3f":return Re.mat2x3f;case"mat2x4f":return Re.mat2x4f;case"mat3x2f":return Re.mat3x2f;case"mat3x3f":return Re.mat3x3f;case"mat3x4f":return Re.mat3x4f;case"mat4x2f":return Re.mat4x2f;case"mat4x3f":return Re.mat4x3f;case"mat4x4f":return Re.mat4x4f;case"mat2x2h":return Re.mat2x2h;case"mat2x3h":return Re.mat2x3h;case"mat2x4h":return Re.mat2x4h;case"mat3x2h":return Re.mat3x2h;case"mat3x3h":return Re.mat3x3h;case"mat3x4h":return Re.mat3x4h;case"mat4x2h":return Re.mat4x2h;case"mat4x3h":return Re.mat4x3h;case"mat4x4h":return Re.mat4x4h;case"mat2x2i":return Re.mat2x2i;case"mat2x3i":return Re.mat2x3i;case"mat2x4i":return Re.mat2x4i;case"mat3x2i":return Re.mat3x2i;case"mat3x3i":return Re.mat3x3i;case"mat3x4i":return Re.mat3x4i;case"mat4x2i":return Re.mat4x2i;case"mat4x3i":return Re.mat4x3i;case"mat4x4i":return Re.mat4x4i;case"mat2x2u":return Re.mat2x2u;case"mat2x3u":return Re.mat2x3u;case"mat2x4u":return Re.mat2x4u;case"mat3x2u":return Re.mat3x2u;case"mat3x3u":return Re.mat3x3u;case"mat3x4u":return Re.mat3x4u;case"mat4x2u":return Re.mat4x2u;case"mat4x3u":return Re.mat4x3u;case"mat4x4u":return Re.mat4x4u}return null}_validateTypeRange(e,t){if(t.name==="i32"){if(e<-2147483648||e>2147483647)throw this._error(this._previous(),`Value out of range for i32: ${e}. Line: ${this._currentLine}.`)}else if(t.name==="u32"&&(e<0||e>4294967295))throw this._error(this._previous(),`Value out of range for u32: ${e}. Line: ${this._currentLine}.`)}_primary_expression(){if(this._match(J.tokens.ident)){const r=this._previous().toString();if(this._check(J.tokens.paren_left)){const s=this._argument_expression_list(),a=this._getType(r);return a!==null?this._updateNode(new Tn(a,s)):this._updateNode(new ry(r,s))}if(this._context.constants.has(r)){const s=this._context.constants.get(r);return this._updateNode(new Q1(r,s.value))}return this._updateNode(new Ls(r))}if(this._match(J.tokens.int_literal)){const r=this._previous().toString();let s=r.endsWith("i")||r.endsWith("i")?Ge.i32:r.endsWith("u")||r.endsWith("U")?Ge.u32:Ge.x32;const a=parseInt(r);return this._validateTypeRange(a,s),this._updateNode(new hr(new Ae(a,this._exec.getTypeInfo(s)),s))}if(this._match(J.tokens.uint_literal)){const r=parseInt(this._previous().toString());return this._validateTypeRange(r,Ge.u32),this._updateNode(new hr(new Ae(r,this._exec.getTypeInfo(Ge.u32)),Ge.u32))}if(this._match([J.tokens.decimal_float_literal,J.tokens.hex_float_literal])){let r=this._previous().toString(),s=r.endsWith("h");s&&(r=r.substring(0,r.length-1));const a=parseFloat(r);this._validateTypeRange(a,s?Ge.f16:Ge.f32);const u=s?Ge.f16:Ge.f32;return this._updateNode(new hr(new Ae(a,this._exec.getTypeInfo(u)),u))}if(this._match([J.keywords.true,J.keywords.false])){let r=this._previous().toString()===J.keywords.true.rule;return this._updateNode(new hr(new Ae(r?1:0,this._exec.getTypeInfo(Ge.bool)),Ge.bool))}if(this._check(J.tokens.paren_left))return this._paren_expression();if(this._match(J.keywords.bitcast)){this._consume(J.tokens.less_than,"Expected '<'.");const r=this._type_decl();this._consume(J.tokens.greater_than,"Expected '>'.");const s=this._paren_expression();return this._updateNode(new e2(r,s))}const e=this._type_decl(),t=this._argument_expression_list();return this._updateNode(new Tn(e,t))}_argument_expression_list(){if(!this._match(J.tokens.paren_left))return null;const e=[];do{if(this._check(J.tokens.paren_right))break;const t=this._short_circuit_or_expression();e.push(t)}while(this._match(J.tokens.comma));return this._consume(J.tokens.paren_right,"Expected ')' for agument list"),e}_optional_paren_expression(){this._match(J.tokens.paren_left);const e=this._short_circuit_or_expression();return this._match(J.tokens.paren_right),e}_paren_expression(){this._consume(J.tokens.paren_left,"Expected '('.");const e=this._short_circuit_or_expression();return this._consume(J.tokens.paren_right,"Expected ')'."),e}_struct_decl(){if(!this._match(J.keywords.struct))return null;const e=this._currentLine,t=this._consume(J.tokens.ident,"Expected name for struct.").toString();this._consume(J.tokens.brace_left,"Expected '{' for struct body.");const r=[];for(;!this._check(J.tokens.brace_right);){const u=this._attribute(),l=this._consume(J.tokens.name,"Expected variable name.").toString();this._consume(J.tokens.colon,"Expected ':' for struct member type.");const g=this._attribute(),v=this._type_decl();v!=null&&(v.attributes=g),this._check(J.tokens.brace_right)?this._match(J.tokens.comma):this._consume(J.tokens.comma,"Expected ',' for struct member."),r.push(this._updateNode(new _b(l,v,u)))}this._consume(J.tokens.brace_right,"Expected '}' after struct body.");const s=this._currentLine,a=this._updateNode(new Gn(t,r,e,s),e);return this._context.structs.set(t,a),a}_global_variable_decl(){const e=this._variable_decl();if(!e)return null;if(this._match(J.tokens.equal)){const t=this._const_expression();e.value=t}if(e.type!==null&&e.value instanceof hr){if(e.value.type.name!=="x32"&&e.type.getTypeName()!==e.value.type.getTypeName())throw this._error(this._peek(),`Invalid cast from ${e.value.type.name} to ${e.type.name}. Line:${this._currentLine}`);e.value.isScalar&&this._validateTypeRange(e.value.scalarValue,e.type),e.value.type=e.type}else e.type===null&&e.value instanceof hr&&(e.type=e.value.type.name==="x32"?Ge.i32:e.value.type,e.value.isScalar&&this._validateTypeRange(e.value.scalarValue,e.type));return e}_override_variable_decl(){const e=this._override_decl();return e&&this._match(J.tokens.equal)&&(e.value=this._const_expression()),e}_global_const_decl(){var e;if(!this._match(J.keywords.const))return null;const t=this._consume(J.tokens.name,"Expected variable name"),r=this._currentLine;let s=null;if(this._match(J.tokens.colon)){const g=this._attribute();s=this._type_decl(),s!=null&&(s.attributes=g)}let a=null;this._consume(J.tokens.equal,"const declarations require an assignment");const u=this._short_circuit_or_expression();try{let g=[Ge.f32],v=u.constEvaluate(this._exec,g);v instanceof Ae&&this._validateTypeRange(v.value,g[0]),g[0]instanceof Re&&g[0].format===null&&v.typeInfo instanceof Za&&v.typeInfo.format!==null&&(v.typeInfo.format.name==="f16"?g[0].format=Ge.f16:v.typeInfo.format.name==="f32"?g[0].format=Ge.f32:v.typeInfo.format.name==="i32"?g[0].format=Ge.i32:v.typeInfo.format.name==="u32"?g[0].format=Ge.u32:v.typeInfo.format.name==="bool"?g[0].format=Ge.bool:console.error(`TODO: impelement template format type ${v.typeInfo.format.name}`)),a=this._updateNode(new hr(v,g[0])),this._exec.context.setVariable(t.toString(),v)}catch{a=u}if(s!==null&&a instanceof hr){if(a.type.name!=="x32"&&s.getTypeName()!==a.type.getTypeName())throw this._error(this._peek(),`Invalid cast from ${a.type.name} to ${s.name}. Line:${this._currentLine}`);a.type=s,a.isScalar&&this._validateTypeRange(a.scalarValue,a.type)}else s===null&&a instanceof hr&&(s=(e=a?.type)!==null&&e!==void 0?e:Ge.f32,s===Ge.x32&&(s=Ge.i32));const l=this._updateNode(new Mf(t.toString(),s,"","",a),r);return this._context.constants.set(l.name,l),l}_global_let_decl(){if(!this._match(J.keywords.let))return null;const e=this._currentLine,t=this._consume(J.tokens.name,"Expected variable name");let r=null;if(this._match(J.tokens.colon)){const a=this._attribute();r=this._type_decl(),r!=null&&(r.attributes=a)}let s=null;if(this._match(J.tokens.equal)&&(s=this._const_expression()),r!==null&&s instanceof hr){if(s.type.name!=="x32"&&r.getTypeName()!==s.type.getTypeName())throw this._error(this._peek(),`Invalid cast from ${s.type.name} to ${r.name}. Line:${this._currentLine}`);s.type=r}else r===null&&s instanceof hr&&(r=s.type.name==="x32"?Ge.i32:s.type);return s instanceof hr&&s.isScalar&&this._validateTypeRange(s.scalarValue,r),this._updateNode(new xh(t.toString(),r,"","",s),e)}_const_expression(){return this._short_circuit_or_expression()}_variable_decl(){if(!this._match(J.keywords.var))return null;const e=this._currentLine;let t="",r="";this._match(J.tokens.less_than)&&(t=this._consume(J.storage_class,"Expected storage_class.").toString(),this._match(J.tokens.comma)&&(r=this._consume(J.access_mode,"Expected access_mode.").toString()),this._consume(J.tokens.greater_than,"Expected '>'."));const s=this._consume(J.tokens.name,"Expected variable name");let a=null;if(this._match(J.tokens.colon)){const u=this._attribute();a=this._type_decl(),a!=null&&(a.attributes=u)}return this._updateNode(new Jn(s.toString(),a,t,r,null),e)}_override_decl(){if(!this._match(J.keywords.override))return null;const e=this._consume(J.tokens.name,"Expected variable name");let t=null;if(this._match(J.tokens.colon)){const r=this._attribute();t=this._type_decl(),t!=null&&(t.attributes=r)}return this._updateNode(new ey(e.toString(),t,null))}_diagnostic(){this._consume(J.tokens.paren_left,"Expected '('");const e=this._consume(J.tokens.ident,"Expected severity control name.");this._consume(J.tokens.comma,"Expected ','");let t=this._consume(J.tokens.ident,"Expected diagnostic rule name.").toString();return this._match(J.tokens.period)&&(t+=`.${this._consume(J.tokens.ident,"Expected diagnostic message.").toString()}`),this._consume(J.tokens.paren_right,"Expected ')'"),this._updateNode(new G1(e.toString(),t))}_enable_directive(){const e=this._consume(J.tokens.ident,"identity expected.");return this._updateNode(new kP(e.toString()))}_requires_directive(){const e=[this._consume(J.tokens.ident,"identity expected.").toString()];for(;this._match(J.tokens.comma);){const t=this._consume(J.tokens.ident,"identity expected.");e.push(t.toString())}return this._updateNode(new DP(e))}_type_alias(){const e=this._consume(J.tokens.ident,"identity expected.");this._consume(J.tokens.equal,"Expected '=' for type alias.");let t=this._type_decl();if(t===null)throw this._error(this._peek(),"Expected Type for Alias.");this._context.aliases.has(t.name)&&(t=this._context.aliases.get(t.name).type);const r=this._updateNode(new iy(e.toString(),t));return this._context.aliases.set(r.name,r),r}_type_decl(){if(this._check([J.tokens.ident,...J.texel_format,J.keywords.bool,J.keywords.f32,J.keywords.i32,J.keywords.u32])){const r=this._advance().toString();if(this._context.structs.has(r))return this._context.structs.get(r);if(this._context.aliases.has(r))return this._context.aliases.get(r).type;if(!this._getType(r)){const s=this._updateNode(new gb(r));return this._forwardTypeCount++,s}return this._updateNode(new Ge(r))}let e=this._texture_sampler_types();if(e)return e;if(this._check(J.template_types)){let r=this._advance().toString(),s=null,a=null;return this._match(J.tokens.less_than)&&(s=this._type_decl(),a=null,this._match(J.tokens.comma)&&(a=this._consume(J.access_mode,"Expected access_mode for pointer").toString()),this._consume(J.tokens.greater_than,"Expected '>' for type.")),this._updateNode(new Re(r,s,a))}if(this._match(J.keywords.ptr)){let r=this._previous().toString();this._consume(J.tokens.less_than,"Expected '<' for pointer.");const s=this._consume(J.storage_class,"Expected storage_class for pointer");this._consume(J.tokens.comma,"Expected ',' for pointer.");const a=this._type_decl();let u=null;return this._match(J.tokens.comma)&&(u=this._consume(J.access_mode,"Expected access_mode for pointer").toString()),this._consume(J.tokens.greater_than,"Expected '>' for pointer."),this._updateNode(new Rf(r,s.toString(),a,u))}const t=this._attribute();if(this._match(J.keywords.array)){let r=null,s=-1;const a=this._previous();let u=null;if(this._match(J.tokens.less_than)){r=this._type_decl(),this._context.aliases.has(r.name)&&(r=this._context.aliases.get(r.name).type);let g="";if(this._match(J.tokens.comma)){u=this._shift_expression();try{g=u.constEvaluate(this._exec).toString(),u=null}catch{g="1"}}this._consume(J.tokens.greater_than,"Expected '>' for array."),s=g?parseInt(g):0}const l=this._updateNode(new vh(a.toString(),t,r,s));return u&&this._deferArrayCountEval.push({arrayType:l,countNode:u}),l}return null}_texture_sampler_types(){if(this._match(J.sampler_type))return this._updateNode(new hh(this._previous().toString(),null,null));if(this._match(J.depth_texture_type))return this._updateNode(new hh(this._previous().toString(),null,null));if(this._match(J.sampled_texture_type)||this._match(J.multisampled_texture_type)){const e=this._previous();this._consume(J.tokens.less_than,"Expected '<' for sampler type.");const t=this._type_decl();return this._consume(J.tokens.greater_than,"Expected '>' for sampler type."),this._updateNode(new hh(e.toString(),t,null))}if(this._match(J.storage_texture_type)){const e=this._previous();this._consume(J.tokens.less_than,"Expected '<' for sampler type.");const t=this._consume(J.texel_format,"Invalid texel format.").toString();this._consume(J.tokens.comma,"Expected ',' after texel format.");const r=this._consume(J.access_mode,"Expected access mode for storage texture type.").toString();return this._consume(J.tokens.greater_than,"Expected '>' for sampler type."),this._updateNode(new hh(e.toString(),t,r))}return null}_attribute(){let e=[];for(;this._match(J.tokens.attr);){const t=this._consume(J.attribute_name,"Expected attribute name"),r=this._updateNode(new n2(t.toString(),null));if(this._match(J.tokens.paren_left)){if(r.value=this._consume(J.literal_or_ident,"Expected attribute value").toString(),this._check(J.tokens.comma)){this._advance();do{const s=this._consume(J.literal_or_ident,"Expected attribute value").toString();r.value instanceof Array||(r.value=[r.value]),r.value.push(s)}while(this._match(J.tokens.comma))}this._consume(J.tokens.paren_right,"Expected ')'")}e.push(r)}return e.length==0?null:e}}class YP extends En{constructor(e){super(),e&&this.update(e)}update(e){const t=new ZP().parse(e);this.updateAST(t)}}function GP(i){const e={attributes:[],bindings:[]};let t;try{t=KP(i)}catch(a){return Qe.error(a.message)(),e}for(const a of t.uniforms){const u=[];for(const l of a.type?.members||[])u.push({name:l.name,type:vb(l.type)});e.bindings.push({type:"uniform",name:a.name,group:a.group,location:a.binding,members:u})}for(const a of t.textures)e.bindings.push({type:"texture",name:a.name,group:a.group,location:a.binding});for(const a of t.samplers)e.bindings.push({type:"sampler",name:a.name,group:a.group,location:a.binding});const r=t.entry.vertex[0],s=r?.inputs.length||0;for(let a=0;a<s;a++){const u=r.inputs[a];if(u.locationType==="location"){const l=vb(u.type);e.attributes.push({name:u.name,location:Number(u.location),type:l})}}return e}function vb(i){return i?.format?`${i.name}<${i.format.name}>`:i.name}function KP(i){try{return new YP(i)}catch(e){if(e instanceof Error)throw e;let t="WGSL parse error";throw typeof e=="object"&&e?.message&&(t+=`: ${e.message} `),typeof e=="object"&&e?.token&&(t+=e.token.line||""),new Error(t,{cause:e})}}const JP={EPSILON:1e-12,debug:!1,precision:4,printTypes:!1,printDegrees:!1,printRowMajor:!0,_cartographicRadians:!1};globalThis.mathgl=globalThis.mathgl||{config:{...JP}};const ms=globalThis.mathgl.config;function QP(i,{precision:e=ms.precision}={}){return i=eM(i),`${parseFloat(i.toPrecision(e))}`}function Ga(i){return Array.isArray(i)||ArrayBuffer.isView(i)&&!(i instanceof DataView)}function Yo(i,e,t){return iM(i,r=>Math.max(e,Math.min(t,r)))}function ja(i,e,t){return Ga(i)?i.map((r,s)=>ja(r,e[s],t)):t*e+(1-t)*i}function eo(i,e,t){const r=ms.EPSILON;try{if(i===e)return!0;if(Ga(i)&&Ga(e)){if(i.length!==e.length)return!1;for(let s=0;s<i.length;++s)if(!eo(i[s],e[s]))return!1;return!0}return i&&i.equals?i.equals(e):e&&e.equals?e.equals(i):typeof i=="number"&&typeof e=="number"?Math.abs(i-e)<=ms.EPSILON*Math.max(1,Math.abs(i),Math.abs(e)):!1}finally{ms.EPSILON=r}}function eM(i){return Math.round(i/ms.EPSILON)*ms.EPSILON}function tM(i){return i.clone?i.clone():new Array(i.length)}function iM(i,e,t){if(Ga(i)){const r=i;t=t||tM(r);for(let s=0;s<t.length&&s<r.length;++s){const a=typeof i=="number"?i:i[s];t[s]=e(a,s,t)}return t}return e(i)}class ly extends Array{clone(){return new this.constructor().copy(this)}fromArray(e,t=0){for(let r=0;r<this.ELEMENTS;++r)this[r]=e[r+t];return this.check()}toArray(e=[],t=0){for(let r=0;r<this.ELEMENTS;++r)e[t+r]=this[r];return e}toObject(e){return e}from(e){return Array.isArray(e)?this.copy(e):this.fromObject(e)}to(e){return e===this?this:Ga(e)?this.toArray(e):this.toObject(e)}toTarget(e){return e?this.to(e):this}toFloat32Array(){return new Float32Array(this)}toString(){return this.formatString(ms)}formatString(e){let t="";for(let r=0;r<this.ELEMENTS;++r)t+=(r>0?", ":"")+QP(this[r],e);return`${e.printTypes?this.constructor.name:""}[${t}]`}equals(e){if(!e||this.length!==e.length)return!1;for(let t=0;t<this.ELEMENTS;++t)if(!eo(this[t],e[t]))return!1;return!0}exactEquals(e){if(!e||this.length!==e.length)return!1;for(let t=0;t<this.ELEMENTS;++t)if(this[t]!==e[t])return!1;return!0}negate(){for(let e=0;e<this.ELEMENTS;++e)this[e]=-this[e];return this.check()}lerp(e,t,r){if(r===void 0)return this.lerp(this,e,t);for(let s=0;s<this.ELEMENTS;++s){const a=e[s],u=typeof t=="number"?t:t[s];this[s]=a+r*(u-a)}return this.check()}min(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=Math.min(e[t],this[t]);return this.check()}max(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=Math.max(e[t],this[t]);return this.check()}clamp(e,t){for(let r=0;r<this.ELEMENTS;++r)this[r]=Math.min(Math.max(this[r],e[r]),t[r]);return this.check()}add(...e){for(const t of e)for(let r=0;r<this.ELEMENTS;++r)this[r]+=t[r];return this.check()}subtract(...e){for(const t of e)for(let r=0;r<this.ELEMENTS;++r)this[r]-=t[r];return this.check()}scale(e){if(typeof e=="number")for(let t=0;t<this.ELEMENTS;++t)this[t]*=e;else for(let t=0;t<this.ELEMENTS&&t<e.length;++t)this[t]*=e[t];return this.check()}multiplyByScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]*=e;return this.check()}check(){if(ms.debug&&!this.validate())throw new Error(`math.gl: ${this.constructor.name} some fields set to invalid numbers'`);return this}validate(){let e=this.length===this.ELEMENTS;for(let t=0;t<this.ELEMENTS;++t)e=e&&Number.isFinite(this[t]);return e}sub(e){return this.subtract(e)}setScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=e;return this.check()}addScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]+=e;return this.check()}subScalar(e){return this.addScalar(-e)}multiplyScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]*=e;return this.check()}divideScalar(e){return this.multiplyByScalar(1/e)}clampScalar(e,t){for(let r=0;r<this.ELEMENTS;++r)this[r]=Math.min(Math.max(this[r],e),t);return this.check()}get elements(){return this}}function rM(i,e){if(i.length!==e)return!1;for(let t=0;t<i.length;++t)if(!Number.isFinite(i[t]))return!1;return!0}function Di(i){if(!Number.isFinite(i))throw new Error(`Invalid number ${JSON.stringify(i)}`);return i}function bh(i,e,t=""){if(ms.debug&&!rM(i,e))throw new Error(`math.gl: ${t} some fields set to invalid numbers'`);return i}function Mh(i,e){if(!i)throw new Error(`math.gl assertion ${e}`)}class o2 extends ly{get x(){return this[0]}set x(e){this[0]=Di(e)}get y(){return this[1]}set y(e){this[1]=Di(e)}len(){return Math.sqrt(this.lengthSquared())}magnitude(){return this.len()}lengthSquared(){let e=0;for(let t=0;t<this.ELEMENTS;++t)e+=this[t]*this[t];return e}magnitudeSquared(){return this.lengthSquared()}distance(e){return Math.sqrt(this.distanceSquared(e))}distanceSquared(e){let t=0;for(let r=0;r<this.ELEMENTS;++r){const s=this[r]-e[r];t+=s*s}return Di(t)}dot(e){let t=0;for(let r=0;r<this.ELEMENTS;++r)t+=this[r]*e[r];return Di(t)}normalize(){const e=this.magnitude();if(e!==0)for(let t=0;t<this.ELEMENTS;++t)this[t]/=e;return this.check()}multiply(...e){for(const t of e)for(let r=0;r<this.ELEMENTS;++r)this[r]*=t[r];return this.check()}divide(...e){for(const t of e)for(let r=0;r<this.ELEMENTS;++r)this[r]/=t[r];return this.check()}lengthSq(){return this.lengthSquared()}distanceTo(e){return this.distance(e)}distanceToSquared(e){return this.distanceSquared(e)}getComponent(e){return Mh(e>=0&&e<this.ELEMENTS,"index is out of range"),Di(this[e])}setComponent(e,t){return Mh(e>=0&&e<this.ELEMENTS,"index is out of range"),this[e]=t,this.check()}addVectors(e,t){return this.copy(e).add(t)}subVectors(e,t){return this.copy(e).subtract(t)}multiplyVectors(e,t){return this.copy(e).multiply(t)}addScaledVector(e,t){return this.add(new this.constructor(e).multiplyScalar(t))}}const wh=1e-6;let un=typeof Float32Array<"u"?Float32Array:Array;function sM(){const i=new un(2);return un!=Float32Array&&(i[0]=0,i[1]=0),i}function bb(i,e,t){return i[0]=e[0]+t[0],i[1]=e[1]+t[1],i}function nM(i,e){return i[0]=-e[0],i[1]=-e[1],i}function a2(i,e,t,r){const s=e[0],a=e[1];return i[0]=s+r*(t[0]-s),i[1]=a+r*(t[1]-a),i}function oM(i,e,t){const r=e[0],s=e[1];return i[0]=t[0]*r+t[3]*s+t[6],i[1]=t[1]*r+t[4]*s+t[7],i}function aM(i,e,t){const r=e[0],s=e[1];return i[0]=t[0]*r+t[4]*s+t[12],i[1]=t[1]*r+t[5]*s+t[13],i}(function(){const i=sM();return function(e,t,r,s,a,u){let l,g;for(t||(t=2),r||(r=0),s?g=Math.min(s*t+r,e.length):g=e.length,l=r;l<g;l+=t)i[0]=e[l],i[1]=e[l+1],a(i,i,u),e[l]=i[0],e[l+1]=i[1];return e}})();function lM(i,e,t){const r=e[0],s=e[1],a=t[3]*r+t[7]*s||1;return i[0]=(t[0]*r+t[4]*s)/a,i[1]=(t[1]*r+t[5]*s)/a,i}function l2(i,e,t){const r=e[0],s=e[1],a=e[2],u=t[3]*r+t[7]*s+t[11]*a||1;return i[0]=(t[0]*r+t[4]*s+t[8]*a)/u,i[1]=(t[1]*r+t[5]*s+t[9]*a)/u,i[2]=(t[2]*r+t[6]*s+t[10]*a)/u,i}function cM(i,e,t){const r=e[0],s=e[1];return i[0]=t[0]*r+t[2]*s,i[1]=t[1]*r+t[3]*s,i[2]=e[2],i}function uM(i,e,t){const r=e[0],s=e[1];return i[0]=t[0]*r+t[2]*s,i[1]=t[1]*r+t[3]*s,i[2]=e[2],i[3]=e[3],i}function c2(i,e,t){const r=e[0],s=e[1],a=e[2];return i[0]=t[0]*r+t[3]*s+t[6]*a,i[1]=t[1]*r+t[4]*s+t[7]*a,i[2]=t[2]*r+t[5]*s+t[8]*a,i[3]=e[3],i}function u2(){const i=new un(3);return un!=Float32Array&&(i[0]=0,i[1]=0,i[2]=0),i}function hM(i){const e=i[0],t=i[1],r=i[2];return Math.sqrt(e*e+t*t+r*r)}function wb(i,e,t){const r=new un(3);return r[0]=i,r[1]=e,r[2]=t,r}function dM(i,e,t){return i[0]=e[0]-t[0],i[1]=e[1]-t[1],i[2]=e[2]-t[2],i}function fM(i){const e=i[0],t=i[1],r=i[2];return e*e+t*t+r*r}function pM(i,e){return i[0]=-e[0],i[1]=-e[1],i[2]=-e[2],i}function gM(i,e){const t=e[0],r=e[1],s=e[2];let a=t*t+r*r+s*s;return a>0&&(a=1/Math.sqrt(a)),i[0]=e[0]*a,i[1]=e[1]*a,i[2]=e[2]*a,i}function h2(i,e){return i[0]*e[0]+i[1]*e[1]+i[2]*e[2]}function Df(i,e,t){const r=e[0],s=e[1],a=e[2],u=t[0],l=t[1],g=t[2];return i[0]=s*g-a*l,i[1]=a*u-r*g,i[2]=r*l-s*u,i}function mM(i,e,t,r){const s=e[0],a=e[1],u=e[2];return i[0]=s+r*(t[0]-s),i[1]=a+r*(t[1]-a),i[2]=u+r*(t[2]-u),i}function cy(i,e,t){const r=e[0],s=e[1],a=e[2];let u=t[3]*r+t[7]*s+t[11]*a+t[15];return u=u||1,i[0]=(t[0]*r+t[4]*s+t[8]*a+t[12])/u,i[1]=(t[1]*r+t[5]*s+t[9]*a+t[13])/u,i[2]=(t[2]*r+t[6]*s+t[10]*a+t[14])/u,i}function d2(i,e,t){const r=e[0],s=e[1],a=e[2];return i[0]=r*t[0]+s*t[3]+a*t[6],i[1]=r*t[1]+s*t[4]+a*t[7],i[2]=r*t[2]+s*t[5]+a*t[8],i}function f2(i,e,t){const r=t[0],s=t[1],a=t[2],u=t[3],l=e[0],g=e[1],v=e[2];let T=s*v-a*g,S=a*l-r*v,P=r*g-s*l,O=s*P-a*S,$=a*T-r*P,W=r*S-s*T;const G=u*2;return T*=G,S*=G,P*=G,O*=2,$*=2,W*=2,i[0]=l+T+O,i[1]=g+S+$,i[2]=v+P+W,i}function _M(i,e,t,r){const s=[],a=[];return s[0]=e[0]-t[0],s[1]=e[1]-t[1],s[2]=e[2]-t[2],a[0]=s[0],a[1]=s[1]*Math.cos(r)-s[2]*Math.sin(r),a[2]=s[1]*Math.sin(r)+s[2]*Math.cos(r),i[0]=a[0]+t[0],i[1]=a[1]+t[1],i[2]=a[2]+t[2],i}function yM(i,e,t,r){const s=[],a=[];return s[0]=e[0]-t[0],s[1]=e[1]-t[1],s[2]=e[2]-t[2],a[0]=s[2]*Math.sin(r)+s[0]*Math.cos(r),a[1]=s[1],a[2]=s[2]*Math.cos(r)-s[0]*Math.sin(r),i[0]=a[0]+t[0],i[1]=a[1]+t[1],i[2]=a[2]+t[2],i}function xM(i,e,t,r){const s=[],a=[];return s[0]=e[0]-t[0],s[1]=e[1]-t[1],s[2]=e[2]-t[2],a[0]=s[0]*Math.cos(r)-s[1]*Math.sin(r),a[1]=s[0]*Math.sin(r)+s[1]*Math.cos(r),a[2]=s[2],i[0]=a[0]+t[0],i[1]=a[1]+t[1],i[2]=a[2]+t[2],i}function vM(i,e){const t=i[0],r=i[1],s=i[2],a=e[0],u=e[1],l=e[2],g=Math.sqrt((t*t+r*r+s*s)*(a*a+u*u+l*l)),v=g&&h2(i,e)/g;return Math.acos(Math.min(Math.max(v,-1),1))}const p2=dM,g2=hM,om=fM;(function(){const i=u2();return function(e,t,r,s,a,u){let l,g;for(t||(t=3),r||(r=0),s?g=Math.min(s*t+r,e.length):g=e.length,l=r;l<g;l+=t)i[0]=e[l],i[1]=e[l+1],i[2]=e[l+2],a(i,i,u),e[l]=i[0],e[l+1]=i[1],e[l+2]=i[2];return e}})();const am=[0,0,0];let tf;class Mt extends o2{static get ZERO(){return tf||(tf=new Mt(0,0,0),Object.freeze(tf)),tf}constructor(e=0,t=0,r=0){super(-0,-0,-0),arguments.length===1&&Ga(e)?this.copy(e):(ms.debug&&(Di(e),Di(t),Di(r)),this[0]=e,this[1]=t,this[2]=r)}set(e,t,r){return this[0]=e,this[1]=t,this[2]=r,this.check()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this.check()}fromObject(e){return ms.debug&&(Di(e.x),Di(e.y),Di(e.z)),this[0]=e.x,this[1]=e.y,this[2]=e.z,this.check()}toObject(e){return e.x=this[0],e.y=this[1],e.z=this[2],e}get ELEMENTS(){return 3}get z(){return this[2]}set z(e){this[2]=Di(e)}angle(e){return vM(this,e)}cross(e){return Df(this,this,e),this.check()}rotateX({radians:e,origin:t=am}){return _M(this,this,t,e),this.check()}rotateY({radians:e,origin:t=am}){return yM(this,this,t,e),this.check()}rotateZ({radians:e,origin:t=am}){return xM(this,this,t,e),this.check()}transform(e){return this.transformAsPoint(e)}transformAsPoint(e){return cy(this,this,e),this.check()}transformAsVector(e){return l2(this,this,e),this.check()}transformByMatrix3(e){return d2(this,this,e),this.check()}transformByMatrix2(e){return cM(this,this,e),this.check()}transformByQuaternion(e){return f2(this,this,e),this.check()}}let rf;class uy extends o2{static get ZERO(){return rf||(rf=new uy(0,0,0,0),Object.freeze(rf)),rf}constructor(e=0,t=0,r=0,s=0){super(-0,-0,-0,-0),Ga(e)&&arguments.length===1?this.copy(e):(ms.debug&&(Di(e),Di(t),Di(r),Di(s)),this[0]=e,this[1]=t,this[2]=r,this[3]=s)}set(e,t,r,s){return this[0]=e,this[1]=t,this[2]=r,this[3]=s,this.check()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3],this.check()}fromObject(e){return ms.debug&&(Di(e.x),Di(e.y),Di(e.z),Di(e.w)),this[0]=e.x,this[1]=e.y,this[2]=e.z,this[3]=e.w,this}toObject(e){return e.x=this[0],e.y=this[1],e.z=this[2],e.w=this[3],e}get ELEMENTS(){return 4}get z(){return this[2]}set z(e){this[2]=Di(e)}get w(){return this[3]}set w(e){this[3]=Di(e)}transform(e){return cy(this,this,e),this.check()}transformByMatrix3(e){return c2(this,this,e),this.check()}transformByMatrix2(e){return uM(this,this,e),this.check()}transformByQuaternion(e){return f2(this,this,e),this.check()}applyMatrix4(e){return e.transform(this,this),this}}class m2 extends ly{toString(){let e="[";if(ms.printRowMajor){e+="row-major:";for(let t=0;t<this.RANK;++t)for(let r=0;r<this.RANK;++r)e+=` ${this[r*this.RANK+t]}`}else{e+="column-major:";for(let t=0;t<this.ELEMENTS;++t)e+=` ${this[t]}`}return e+="]",e}getElementIndex(e,t){return t*this.RANK+e}getElement(e,t){return this[t*this.RANK+e]}setElement(e,t,r){return this[t*this.RANK+e]=Di(r),this}getColumn(e,t=new Array(this.RANK).fill(-0)){const r=e*this.RANK;for(let s=0;s<this.RANK;++s)t[s]=this[r+s];return t}setColumn(e,t){const r=e*this.RANK;for(let s=0;s<this.RANK;++s)this[r+s]=t[s];return this}}function bM(){const i=new un(9);return un!=Float32Array&&(i[1]=0,i[2]=0,i[3]=0,i[5]=0,i[6]=0,i[7]=0),i[0]=1,i[4]=1,i[8]=1,i}function wM(i,e){if(i===e){const t=e[1],r=e[2],s=e[5];i[1]=e[3],i[2]=e[6],i[3]=t,i[5]=e[7],i[6]=r,i[7]=s}else i[0]=e[0],i[1]=e[3],i[2]=e[6],i[3]=e[1],i[4]=e[4],i[5]=e[7],i[6]=e[2],i[7]=e[5],i[8]=e[8];return i}function TM(i,e){const t=e[0],r=e[1],s=e[2],a=e[3],u=e[4],l=e[5],g=e[6],v=e[7],T=e[8],S=T*u-l*v,P=-T*a+l*g,O=v*a-u*g;let $=t*S+r*P+s*O;return $?($=1/$,i[0]=S*$,i[1]=(-T*r+s*v)*$,i[2]=(l*r-s*u)*$,i[3]=P*$,i[4]=(T*t-s*g)*$,i[5]=(-l*t+s*a)*$,i[6]=O*$,i[7]=(-v*t+r*g)*$,i[8]=(u*t-r*a)*$,i):null}function SM(i){const e=i[0],t=i[1],r=i[2],s=i[3],a=i[4],u=i[5],l=i[6],g=i[7],v=i[8];return e*(v*a-u*g)+t*(-v*s+u*l)+r*(g*s-a*l)}function Tb(i,e,t){const r=e[0],s=e[1],a=e[2],u=e[3],l=e[4],g=e[5],v=e[6],T=e[7],S=e[8],P=t[0],O=t[1],$=t[2],W=t[3],G=t[4],Q=t[5],ae=t[6],te=t[7],me=t[8];return i[0]=P*r+O*u+$*v,i[1]=P*s+O*l+$*T,i[2]=P*a+O*g+$*S,i[3]=W*r+G*u+Q*v,i[4]=W*s+G*l+Q*T,i[5]=W*a+G*g+Q*S,i[6]=ae*r+te*u+me*v,i[7]=ae*s+te*l+me*T,i[8]=ae*a+te*g+me*S,i}function AM(i,e,t){const r=e[0],s=e[1],a=e[2],u=e[3],l=e[4],g=e[5],v=e[6],T=e[7],S=e[8],P=t[0],O=t[1];return i[0]=r,i[1]=s,i[2]=a,i[3]=u,i[4]=l,i[5]=g,i[6]=P*r+O*u+v,i[7]=P*s+O*l+T,i[8]=P*a+O*g+S,i}function EM(i,e,t){const r=e[0],s=e[1],a=e[2],u=e[3],l=e[4],g=e[5],v=e[6],T=e[7],S=e[8],P=Math.sin(t),O=Math.cos(t);return i[0]=O*r+P*u,i[1]=O*s+P*l,i[2]=O*a+P*g,i[3]=O*u-P*r,i[4]=O*l-P*s,i[5]=O*g-P*a,i[6]=v,i[7]=T,i[8]=S,i}function Sb(i,e,t){const r=t[0],s=t[1];return i[0]=r*e[0],i[1]=r*e[1],i[2]=r*e[2],i[3]=s*e[3],i[4]=s*e[4],i[5]=s*e[5],i[6]=e[6],i[7]=e[7],i[8]=e[8],i}function IM(i,e){const t=e[0],r=e[1],s=e[2],a=e[3],u=t+t,l=r+r,g=s+s,v=t*u,T=r*u,S=r*l,P=s*u,O=s*l,$=s*g,W=a*u,G=a*l,Q=a*g;return i[0]=1-S-$,i[3]=T-Q,i[6]=P+G,i[1]=T+Q,i[4]=1-v-$,i[7]=O-W,i[2]=P-G,i[5]=O+W,i[8]=1-v-S,i}var Jm;(function(i){i[i.COL0ROW0=0]="COL0ROW0",i[i.COL0ROW1=1]="COL0ROW1",i[i.COL0ROW2=2]="COL0ROW2",i[i.COL1ROW0=3]="COL1ROW0",i[i.COL1ROW1=4]="COL1ROW1",i[i.COL1ROW2=5]="COL1ROW2",i[i.COL2ROW0=6]="COL2ROW0",i[i.COL2ROW1=7]="COL2ROW1",i[i.COL2ROW2=8]="COL2ROW2"})(Jm||(Jm={}));const CM=Object.freeze([1,0,0,0,1,0,0,0,1]);class Rr extends m2{static get IDENTITY(){return MM()}static get ZERO(){return PM()}get ELEMENTS(){return 9}get RANK(){return 3}get INDICES(){return Jm}constructor(e,...t){super(-0,-0,-0,-0,-0,-0,-0,-0,-0),arguments.length===1&&Array.isArray(e)?this.copy(e):t.length>0?this.copy([e,...t]):this.identity()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3],this[4]=e[4],this[5]=e[5],this[6]=e[6],this[7]=e[7],this[8]=e[8],this.check()}identity(){return this.copy(CM)}fromObject(e){return this.check()}fromQuaternion(e){return IM(this,e),this.check()}set(e,t,r,s,a,u,l,g,v){return this[0]=e,this[1]=t,this[2]=r,this[3]=s,this[4]=a,this[5]=u,this[6]=l,this[7]=g,this[8]=v,this.check()}setRowMajor(e,t,r,s,a,u,l,g,v){return this[0]=e,this[1]=s,this[2]=l,this[3]=t,this[4]=a,this[5]=g,this[6]=r,this[7]=u,this[8]=v,this.check()}determinant(){return SM(this)}transpose(){return wM(this,this),this.check()}invert(){return TM(this,this),this.check()}multiplyLeft(e){return Tb(this,e,this),this.check()}multiplyRight(e){return Tb(this,this,e),this.check()}rotate(e){return EM(this,this,e),this.check()}scale(e){return Array.isArray(e)?Sb(this,this,e):Sb(this,this,[e,e]),this.check()}translate(e){return AM(this,this,e),this.check()}transform(e,t){let r;switch(e.length){case 2:r=oM(t||[-0,-0],e,this);break;case 3:r=d2(t||[-0,-0,-0],e,this);break;case 4:r=c2(t||[-0,-0,-0,-0],e,this);break;default:throw new Error("Illegal vector")}return bh(r,e.length),r}transformVector(e,t){return this.transform(e,t)}transformVector2(e,t){return this.transform(e,t)}transformVector3(e,t){return this.transform(e,t)}}let sf,nf=null;function PM(){return sf||(sf=new Rr([0,0,0,0,0,0,0,0,0]),Object.freeze(sf)),sf}function MM(){return nf||(nf=new Rr,Object.freeze(nf)),nf}function RM(i){return i[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=1,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i}function kM(i,e){if(i===e){const t=e[1],r=e[2],s=e[3],a=e[6],u=e[7],l=e[11];i[1]=e[4],i[2]=e[8],i[3]=e[12],i[4]=t,i[6]=e[9],i[7]=e[13],i[8]=r,i[9]=a,i[11]=e[14],i[12]=s,i[13]=u,i[14]=l}else i[0]=e[0],i[1]=e[4],i[2]=e[8],i[3]=e[12],i[4]=e[1],i[5]=e[5],i[6]=e[9],i[7]=e[13],i[8]=e[2],i[9]=e[6],i[10]=e[10],i[11]=e[14],i[12]=e[3],i[13]=e[7],i[14]=e[11],i[15]=e[15];return i}function Qm(i,e){const t=e[0],r=e[1],s=e[2],a=e[3],u=e[4],l=e[5],g=e[6],v=e[7],T=e[8],S=e[9],P=e[10],O=e[11],$=e[12],W=e[13],G=e[14],Q=e[15],ae=t*l-r*u,te=t*g-s*u,me=t*v-a*u,we=r*g-s*l,Oe=r*v-a*l,Je=s*v-a*g,it=T*W-S*$,He=T*G-P*$,ht=T*Q-O*$,Ye=S*G-P*W,ft=S*Q-O*W,Ke=P*Q-O*G;let Ze=ae*Ke-te*ft+me*Ye+we*ht-Oe*He+Je*it;return Ze?(Ze=1/Ze,i[0]=(l*Ke-g*ft+v*Ye)*Ze,i[1]=(s*ft-r*Ke-a*Ye)*Ze,i[2]=(W*Je-G*Oe+Q*we)*Ze,i[3]=(P*Oe-S*Je-O*we)*Ze,i[4]=(g*ht-u*Ke-v*He)*Ze,i[5]=(t*Ke-s*ht+a*He)*Ze,i[6]=(G*me-$*Je-Q*te)*Ze,i[7]=(T*Je-P*me+O*te)*Ze,i[8]=(u*ft-l*ht+v*it)*Ze,i[9]=(r*ht-t*ft-a*it)*Ze,i[10]=($*Oe-W*me+Q*ae)*Ze,i[11]=(S*me-T*Oe-O*ae)*Ze,i[12]=(l*He-u*Ye-g*it)*Ze,i[13]=(t*Ye-r*He+s*it)*Ze,i[14]=(W*te-$*we-G*ae)*Ze,i[15]=(T*we-S*te+P*ae)*Ze,i):null}function DM(i){const e=i[0],t=i[1],r=i[2],s=i[3],a=i[4],u=i[5],l=i[6],g=i[7],v=i[8],T=i[9],S=i[10],P=i[11],O=i[12],$=i[13],W=i[14],G=i[15],Q=e*u-t*a,ae=e*l-r*a,te=t*l-r*u,me=v*$-T*O,we=v*W-S*O,Oe=T*W-S*$,Je=e*Oe-t*we+r*me,it=a*Oe-u*we+l*me,He=v*te-T*ae+S*Q,ht=O*te-$*ae+W*Q;return g*Je-s*it+G*He-P*ht}function $a(i,e,t){const r=e[0],s=e[1],a=e[2],u=e[3],l=e[4],g=e[5],v=e[6],T=e[7],S=e[8],P=e[9],O=e[10],$=e[11],W=e[12],G=e[13],Q=e[14],ae=e[15];let te=t[0],me=t[1],we=t[2],Oe=t[3];return i[0]=te*r+me*l+we*S+Oe*W,i[1]=te*s+me*g+we*P+Oe*G,i[2]=te*a+me*v+we*O+Oe*Q,i[3]=te*u+me*T+we*$+Oe*ae,te=t[4],me=t[5],we=t[6],Oe=t[7],i[4]=te*r+me*l+we*S+Oe*W,i[5]=te*s+me*g+we*P+Oe*G,i[6]=te*a+me*v+we*O+Oe*Q,i[7]=te*u+me*T+we*$+Oe*ae,te=t[8],me=t[9],we=t[10],Oe=t[11],i[8]=te*r+me*l+we*S+Oe*W,i[9]=te*s+me*g+we*P+Oe*G,i[10]=te*a+me*v+we*O+Oe*Q,i[11]=te*u+me*T+we*$+Oe*ae,te=t[12],me=t[13],we=t[14],Oe=t[15],i[12]=te*r+me*l+we*S+Oe*W,i[13]=te*s+me*g+we*P+Oe*G,i[14]=te*a+me*v+we*O+Oe*Q,i[15]=te*u+me*T+we*$+Oe*ae,i}function np(i,e,t){const r=t[0],s=t[1],a=t[2];let u,l,g,v,T,S,P,O,$,W,G,Q;return e===i?(i[12]=e[0]*r+e[4]*s+e[8]*a+e[12],i[13]=e[1]*r+e[5]*s+e[9]*a+e[13],i[14]=e[2]*r+e[6]*s+e[10]*a+e[14],i[15]=e[3]*r+e[7]*s+e[11]*a+e[15]):(u=e[0],l=e[1],g=e[2],v=e[3],T=e[4],S=e[5],P=e[6],O=e[7],$=e[8],W=e[9],G=e[10],Q=e[11],i[0]=u,i[1]=l,i[2]=g,i[3]=v,i[4]=T,i[5]=S,i[6]=P,i[7]=O,i[8]=$,i[9]=W,i[10]=G,i[11]=Q,i[12]=u*r+T*s+$*a+e[12],i[13]=l*r+S*s+W*a+e[13],i[14]=g*r+P*s+G*a+e[14],i[15]=v*r+O*s+Q*a+e[15]),i}function hy(i,e,t){const r=t[0],s=t[1],a=t[2];return i[0]=e[0]*r,i[1]=e[1]*r,i[2]=e[2]*r,i[3]=e[3]*r,i[4]=e[4]*s,i[5]=e[5]*s,i[6]=e[6]*s,i[7]=e[7]*s,i[8]=e[8]*a,i[9]=e[9]*a,i[10]=e[10]*a,i[11]=e[11]*a,i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15],i}function OM(i,e,t,r){let s=r[0],a=r[1],u=r[2],l=Math.sqrt(s*s+a*a+u*u),g,v,T,S,P,O,$,W,G,Q,ae,te,me,we,Oe,Je,it,He,ht,Ye,ft,Ke,Ze,ve;return l<wh?null:(l=1/l,s*=l,a*=l,u*=l,v=Math.sin(t),g=Math.cos(t),T=1-g,S=e[0],P=e[1],O=e[2],$=e[3],W=e[4],G=e[5],Q=e[6],ae=e[7],te=e[8],me=e[9],we=e[10],Oe=e[11],Je=s*s*T+g,it=a*s*T+u*v,He=u*s*T-a*v,ht=s*a*T-u*v,Ye=a*a*T+g,ft=u*a*T+s*v,Ke=s*u*T+a*v,Ze=a*u*T-s*v,ve=u*u*T+g,i[0]=S*Je+W*it+te*He,i[1]=P*Je+G*it+me*He,i[2]=O*Je+Q*it+we*He,i[3]=$*Je+ae*it+Oe*He,i[4]=S*ht+W*Ye+te*ft,i[5]=P*ht+G*Ye+me*ft,i[6]=O*ht+Q*Ye+we*ft,i[7]=$*ht+ae*Ye+Oe*ft,i[8]=S*Ke+W*Ze+te*ve,i[9]=P*Ke+G*Ze+me*ve,i[10]=O*Ke+Q*Ze+we*ve,i[11]=$*Ke+ae*Ze+Oe*ve,e!==i&&(i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15]),i)}function _2(i,e,t){const r=Math.sin(t),s=Math.cos(t),a=e[4],u=e[5],l=e[6],g=e[7],v=e[8],T=e[9],S=e[10],P=e[11];return e!==i&&(i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3],i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15]),i[4]=a*s+v*r,i[5]=u*s+T*r,i[6]=l*s+S*r,i[7]=g*s+P*r,i[8]=v*s-a*r,i[9]=T*s-u*r,i[10]=S*s-l*r,i[11]=P*s-g*r,i}function LM(i,e,t){const r=Math.sin(t),s=Math.cos(t),a=e[0],u=e[1],l=e[2],g=e[3],v=e[8],T=e[9],S=e[10],P=e[11];return e!==i&&(i[4]=e[4],i[5]=e[5],i[6]=e[6],i[7]=e[7],i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15]),i[0]=a*s-v*r,i[1]=u*s-T*r,i[2]=l*s-S*r,i[3]=g*s-P*r,i[8]=a*r+v*s,i[9]=u*r+T*s,i[10]=l*r+S*s,i[11]=g*r+P*s,i}function y2(i,e,t){const r=Math.sin(t),s=Math.cos(t),a=e[0],u=e[1],l=e[2],g=e[3],v=e[4],T=e[5],S=e[6],P=e[7];return e!==i&&(i[8]=e[8],i[9]=e[9],i[10]=e[10],i[11]=e[11],i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15]),i[0]=a*s+v*r,i[1]=u*s+T*r,i[2]=l*s+S*r,i[3]=g*s+P*r,i[4]=v*s-a*r,i[5]=T*s-u*r,i[6]=S*s-l*r,i[7]=P*s-g*r,i}function FM(i,e){const t=e[0],r=e[1],s=e[2],a=e[4],u=e[5],l=e[6],g=e[8],v=e[9],T=e[10];return i[0]=Math.sqrt(t*t+r*r+s*s),i[1]=Math.sqrt(a*a+u*u+l*l),i[2]=Math.sqrt(g*g+v*v+T*T),i}function BM(i,e){const t=e[0],r=e[1],s=e[2],a=e[3],u=t+t,l=r+r,g=s+s,v=t*u,T=r*u,S=r*l,P=s*u,O=s*l,$=s*g,W=a*u,G=a*l,Q=a*g;return i[0]=1-S-$,i[1]=T+Q,i[2]=P-G,i[3]=0,i[4]=T-Q,i[5]=1-v-$,i[6]=O+W,i[7]=0,i[8]=P+G,i[9]=O-W,i[10]=1-v-S,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i}function NM(i,e,t,r,s,a,u){const l=1/(t-e),g=1/(s-r),v=1/(a-u);return i[0]=a*2*l,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=a*2*g,i[6]=0,i[7]=0,i[8]=(t+e)*l,i[9]=(s+r)*g,i[10]=(u+a)*v,i[11]=-1,i[12]=0,i[13]=0,i[14]=u*a*2*v,i[15]=0,i}function zM(i,e,t,r,s){const a=1/Math.tan(e/2);if(i[0]=a/t,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=a,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[11]=-1,i[12]=0,i[13]=0,i[15]=0,s!=null&&s!==1/0){const u=1/(r-s);i[10]=(s+r)*u,i[14]=2*s*r*u}else i[10]=-1,i[14]=-2*r;return i}const UM=zM;function VM(i,e,t,r,s,a,u){const l=1/(e-t),g=1/(r-s),v=1/(a-u);return i[0]=-2*l,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=-2*g,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=2*v,i[11]=0,i[12]=(e+t)*l,i[13]=(s+r)*g,i[14]=(u+a)*v,i[15]=1,i}const jM=VM;function $M(i,e,t,r){let s,a,u,l,g,v,T,S,P,O;const $=e[0],W=e[1],G=e[2],Q=r[0],ae=r[1],te=r[2],me=t[0],we=t[1],Oe=t[2];return Math.abs($-me)<wh&&Math.abs(W-we)<wh&&Math.abs(G-Oe)<wh?RM(i):(S=$-me,P=W-we,O=G-Oe,s=1/Math.sqrt(S*S+P*P+O*O),S*=s,P*=s,O*=s,a=ae*O-te*P,u=te*S-Q*O,l=Q*P-ae*S,s=Math.sqrt(a*a+u*u+l*l),s?(s=1/s,a*=s,u*=s,l*=s):(a=0,u=0,l=0),g=P*l-O*u,v=O*a-S*l,T=S*u-P*a,s=Math.sqrt(g*g+v*v+T*T),s?(s=1/s,g*=s,v*=s,T*=s):(g=0,v=0,T=0),i[0]=a,i[1]=g,i[2]=S,i[3]=0,i[4]=u,i[5]=v,i[6]=P,i[7]=0,i[8]=l,i[9]=T,i[10]=O,i[11]=0,i[12]=-(a*$+u*W+l*G),i[13]=-(g*$+v*W+T*G),i[14]=-(S*$+P*W+O*G),i[15]=1,i)}function WM(){const i=new un(4);return un!=Float32Array&&(i[0]=0,i[1]=0,i[2]=0,i[3]=0),i}function HM(i,e,t){return i[0]=e[0]+t[0],i[1]=e[1]+t[1],i[2]=e[2]+t[2],i[3]=e[3]+t[3],i}function dy(i,e,t){return i[0]=e[0]*t,i[1]=e[1]*t,i[2]=e[2]*t,i[3]=e[3]*t,i}function qM(i){const e=i[0],t=i[1],r=i[2],s=i[3];return Math.sqrt(e*e+t*t+r*r+s*s)}function XM(i){const e=i[0],t=i[1],r=i[2],s=i[3];return e*e+t*t+r*r+s*s}function ZM(i,e){const t=e[0],r=e[1],s=e[2],a=e[3];let u=t*t+r*r+s*s+a*a;return u>0&&(u=1/Math.sqrt(u)),i[0]=t*u,i[1]=r*u,i[2]=s*u,i[3]=a*u,i}function YM(i,e){return i[0]*e[0]+i[1]*e[1]+i[2]*e[2]+i[3]*e[3]}function GM(i,e,t,r){const s=e[0],a=e[1],u=e[2],l=e[3];return i[0]=s+r*(t[0]-s),i[1]=a+r*(t[1]-a),i[2]=u+r*(t[2]-u),i[3]=l+r*(t[3]-l),i}function Pc(i,e,t){const r=e[0],s=e[1],a=e[2],u=e[3];return i[0]=t[0]*r+t[4]*s+t[8]*a+t[12]*u,i[1]=t[1]*r+t[5]*s+t[9]*a+t[13]*u,i[2]=t[2]*r+t[6]*s+t[10]*a+t[14]*u,i[3]=t[3]*r+t[7]*s+t[11]*a+t[15]*u,i}function KM(i,e,t){const r=e[0],s=e[1],a=e[2],u=t[0],l=t[1],g=t[2],v=t[3],T=v*r+l*a-g*s,S=v*s+g*r-u*a,P=v*a+u*s-l*r,O=-u*r-l*s-g*a;return i[0]=T*v+O*-u+S*-g-P*-l,i[1]=S*v+O*-l+P*-u-T*-g,i[2]=P*v+O*-g+T*-l-S*-u,i[3]=e[3],i}(function(){const i=WM();return function(e,t,r,s,a,u){let l,g;for(t||(t=4),r||(r=0),s?g=Math.min(s*t+r,e.length):g=e.length,l=r;l<g;l+=t)i[0]=e[l],i[1]=e[l+1],i[2]=e[l+2],i[3]=e[l+3],a(i,i,u),e[l]=i[0],e[l+1]=i[1],e[l+2]=i[2],e[l+3]=i[3];return e}})();var e_;(function(i){i[i.COL0ROW0=0]="COL0ROW0",i[i.COL0ROW1=1]="COL0ROW1",i[i.COL0ROW2=2]="COL0ROW2",i[i.COL0ROW3=3]="COL0ROW3",i[i.COL1ROW0=4]="COL1ROW0",i[i.COL1ROW1=5]="COL1ROW1",i[i.COL1ROW2=6]="COL1ROW2",i[i.COL1ROW3=7]="COL1ROW3",i[i.COL2ROW0=8]="COL2ROW0",i[i.COL2ROW1=9]="COL2ROW1",i[i.COL2ROW2=10]="COL2ROW2",i[i.COL2ROW3=11]="COL2ROW3",i[i.COL3ROW0=12]="COL3ROW0",i[i.COL3ROW1=13]="COL3ROW1",i[i.COL3ROW2=14]="COL3ROW2",i[i.COL3ROW3=15]="COL3ROW3"})(e_||(e_={}));const JM=45*Math.PI/180,QM=1,lm=.1,cm=500,eR=Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);class Mr extends m2{static get IDENTITY(){return iR()}static get ZERO(){return tR()}get ELEMENTS(){return 16}get RANK(){return 4}get INDICES(){return e_}constructor(e){super(-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0),arguments.length===1&&Array.isArray(e)?this.copy(e):this.identity()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3],this[4]=e[4],this[5]=e[5],this[6]=e[6],this[7]=e[7],this[8]=e[8],this[9]=e[9],this[10]=e[10],this[11]=e[11],this[12]=e[12],this[13]=e[13],this[14]=e[14],this[15]=e[15],this.check()}set(e,t,r,s,a,u,l,g,v,T,S,P,O,$,W,G){return this[0]=e,this[1]=t,this[2]=r,this[3]=s,this[4]=a,this[5]=u,this[6]=l,this[7]=g,this[8]=v,this[9]=T,this[10]=S,this[11]=P,this[12]=O,this[13]=$,this[14]=W,this[15]=G,this.check()}setRowMajor(e,t,r,s,a,u,l,g,v,T,S,P,O,$,W,G){return this[0]=e,this[1]=a,this[2]=v,this[3]=O,this[4]=t,this[5]=u,this[6]=T,this[7]=$,this[8]=r,this[9]=l,this[10]=S,this[11]=W,this[12]=s,this[13]=g,this[14]=P,this[15]=G,this.check()}toRowMajor(e){return e[0]=this[0],e[1]=this[4],e[2]=this[8],e[3]=this[12],e[4]=this[1],e[5]=this[5],e[6]=this[9],e[7]=this[13],e[8]=this[2],e[9]=this[6],e[10]=this[10],e[11]=this[14],e[12]=this[3],e[13]=this[7],e[14]=this[11],e[15]=this[15],e}identity(){return this.copy(eR)}fromObject(e){return this.check()}fromQuaternion(e){return BM(this,e),this.check()}frustum(e){const{left:t,right:r,bottom:s,top:a,near:u=lm,far:l=cm}=e;return l===1/0?rR(this,t,r,s,a,u):NM(this,t,r,s,a,u,l),this.check()}lookAt(e){const{eye:t,center:r=[0,0,0],up:s=[0,1,0]}=e;return $M(this,t,r,s),this.check()}ortho(e){const{left:t,right:r,bottom:s,top:a,near:u=lm,far:l=cm}=e;return jM(this,t,r,s,a,u,l),this.check()}orthographic(e){const{fovy:t=JM,aspect:r=QM,focalDistance:s=1,near:a=lm,far:u=cm}=e;Ab(t);const l=t/2,g=s*Math.tan(l),v=g*r;return this.ortho({left:-v,right:v,bottom:-g,top:g,near:a,far:u})}perspective(e){const{fovy:t=45*Math.PI/180,aspect:r=1,near:s=.1,far:a=500}=e;return Ab(t),UM(this,t,r,s,a),this.check()}determinant(){return DM(this)}getScale(e=[-0,-0,-0]){return e[0]=Math.sqrt(this[0]*this[0]+this[1]*this[1]+this[2]*this[2]),e[1]=Math.sqrt(this[4]*this[4]+this[5]*this[5]+this[6]*this[6]),e[2]=Math.sqrt(this[8]*this[8]+this[9]*this[9]+this[10]*this[10]),e}getTranslation(e=[-0,-0,-0]){return e[0]=this[12],e[1]=this[13],e[2]=this[14],e}getRotation(e,t){e=e||[-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0],t=t||[-0,-0,-0];const r=this.getScale(t),s=1/r[0],a=1/r[1],u=1/r[2];return e[0]=this[0]*s,e[1]=this[1]*a,e[2]=this[2]*u,e[3]=0,e[4]=this[4]*s,e[5]=this[5]*a,e[6]=this[6]*u,e[7]=0,e[8]=this[8]*s,e[9]=this[9]*a,e[10]=this[10]*u,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}getRotationMatrix3(e,t){e=e||[-0,-0,-0,-0,-0,-0,-0,-0,-0],t=t||[-0,-0,-0];const r=this.getScale(t),s=1/r[0],a=1/r[1],u=1/r[2];return e[0]=this[0]*s,e[1]=this[1]*a,e[2]=this[2]*u,e[3]=this[4]*s,e[4]=this[5]*a,e[5]=this[6]*u,e[6]=this[8]*s,e[7]=this[9]*a,e[8]=this[10]*u,e}transpose(){return kM(this,this),this.check()}invert(){return Qm(this,this),this.check()}multiplyLeft(e){return $a(this,e,this),this.check()}multiplyRight(e){return $a(this,this,e),this.check()}rotateX(e){return _2(this,this,e),this.check()}rotateY(e){return LM(this,this,e),this.check()}rotateZ(e){return y2(this,this,e),this.check()}rotateXYZ(e){return this.rotateX(e[0]).rotateY(e[1]).rotateZ(e[2])}rotateAxis(e,t){return OM(this,this,e,t),this.check()}scale(e){return hy(this,this,Array.isArray(e)?e:[e,e,e]),this.check()}translate(e){return np(this,this,e),this.check()}transform(e,t){return e.length===4?(t=Pc(t||[-0,-0,-0,-0],e,this),bh(t,4),t):this.transformAsPoint(e,t)}transformAsPoint(e,t){const{length:r}=e;let s;switch(r){case 2:s=aM(t||[-0,-0],e,this);break;case 3:s=cy(t||[-0,-0,-0],e,this);break;default:throw new Error("Illegal vector")}return bh(s,e.length),s}transformAsVector(e,t){let r;switch(e.length){case 2:r=lM(t||[-0,-0],e,this);break;case 3:r=l2(t||[-0,-0,-0],e,this);break;default:throw new Error("Illegal vector")}return bh(r,e.length),r}transformPoint(e,t){return this.transformAsPoint(e,t)}transformVector(e,t){return this.transformAsPoint(e,t)}transformDirection(e,t){return this.transformAsVector(e,t)}makeRotationX(e){return this.identity().rotateX(e)}makeTranslation(e,t,r){return this.identity().translate([e,t,r])}}let of,af;function tR(){return of||(of=new Mr([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),Object.freeze(of)),of}function iR(){return af||(af=new Mr,Object.freeze(af)),af}function Ab(i){if(i>Math.PI*2)throw Error("expected radians")}function rR(i,e,t,r,s,a){const u=2*a/(t-e),l=2*a/(s-r),g=(t+e)/(t-e),v=(s+r)/(s-r),T=-1,S=-1,P=-2*a;return i[0]=u,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=l,i[6]=0,i[7]=0,i[8]=g,i[9]=v,i[10]=T,i[11]=S,i[12]=0,i[13]=0,i[14]=P,i[15]=0,i}function Eb(){const i=new un(4);return un!=Float32Array&&(i[0]=0,i[1]=0,i[2]=0),i[3]=1,i}function sR(i){return i[0]=0,i[1]=0,i[2]=0,i[3]=1,i}function x2(i,e,t){t=t*.5;const r=Math.sin(t);return i[0]=r*e[0],i[1]=r*e[1],i[2]=r*e[2],i[3]=Math.cos(t),i}function Ib(i,e,t){const r=e[0],s=e[1],a=e[2],u=e[3],l=t[0],g=t[1],v=t[2],T=t[3];return i[0]=r*T+u*l+s*v-a*g,i[1]=s*T+u*g+a*l-r*v,i[2]=a*T+u*v+r*g-s*l,i[3]=u*T-r*l-s*g-a*v,i}function nR(i,e,t){t*=.5;const r=e[0],s=e[1],a=e[2],u=e[3],l=Math.sin(t),g=Math.cos(t);return i[0]=r*g+u*l,i[1]=s*g+a*l,i[2]=a*g-s*l,i[3]=u*g-r*l,i}function oR(i,e,t){t*=.5;const r=e[0],s=e[1],a=e[2],u=e[3],l=Math.sin(t),g=Math.cos(t);return i[0]=r*g-a*l,i[1]=s*g+u*l,i[2]=a*g+r*l,i[3]=u*g-s*l,i}function aR(i,e,t){t*=.5;const r=e[0],s=e[1],a=e[2],u=e[3],l=Math.sin(t),g=Math.cos(t);return i[0]=r*g+s*l,i[1]=s*g-r*l,i[2]=a*g+u*l,i[3]=u*g-a*l,i}function lR(i,e){const t=e[0],r=e[1],s=e[2];return i[0]=t,i[1]=r,i[2]=s,i[3]=Math.sqrt(Math.abs(1-t*t-r*r-s*s)),i}function Of(i,e,t,r){const s=e[0],a=e[1],u=e[2],l=e[3];let g=t[0],v=t[1],T=t[2],S=t[3],P,O,$,W,G;return P=s*g+a*v+u*T+l*S,P<0&&(P=-P,g=-g,v=-v,T=-T,S=-S),1-P>wh?(O=Math.acos(P),G=Math.sin(O),$=Math.sin((1-r)*O)/G,W=Math.sin(r*O)/G):($=1-r,W=r),i[0]=$*s+W*g,i[1]=$*a+W*v,i[2]=$*u+W*T,i[3]=$*l+W*S,i}function cR(i,e){const t=e[0],r=e[1],s=e[2],a=e[3],u=t*t+r*r+s*s+a*a,l=u?1/u:0;return i[0]=-t*l,i[1]=-r*l,i[2]=-s*l,i[3]=a*l,i}function uR(i,e){return i[0]=-e[0],i[1]=-e[1],i[2]=-e[2],i[3]=e[3],i}function v2(i,e){const t=e[0]+e[4]+e[8];let r;if(t>0)r=Math.sqrt(t+1),i[3]=.5*r,r=.5/r,i[0]=(e[5]-e[7])*r,i[1]=(e[6]-e[2])*r,i[2]=(e[1]-e[3])*r;else{let s=0;e[4]>e[0]&&(s=1),e[8]>e[s*3+s]&&(s=2);const a=(s+1)%3,u=(s+2)%3;r=Math.sqrt(e[s*3+s]-e[a*3+a]-e[u*3+u]+1),i[s]=.5*r,r=.5/r,i[3]=(e[a*3+u]-e[u*3+a])*r,i[a]=(e[a*3+s]+e[s*3+a])*r,i[u]=(e[u*3+s]+e[s*3+u])*r}return i}const hR=HM,dR=dy,fR=YM,pR=GM,gR=qM,mR=XM,b2=ZM,_R=(function(){const i=u2(),e=wb(1,0,0),t=wb(0,1,0);return function(r,s,a){const u=h2(s,a);return u<-.999999?(Df(i,e,s),g2(i)<1e-6&&Df(i,t,s),gM(i,i),x2(r,i,Math.PI),r):u>.999999?(r[0]=0,r[1]=0,r[2]=0,r[3]=1,r):(Df(i,s,a),r[0]=i[0],r[1]=i[1],r[2]=i[2],r[3]=1+u,b2(r,r))}})();(function(){const i=Eb(),e=Eb();return function(t,r,s,a,u,l){return Of(i,r,u,l),Of(e,s,a,l),Of(t,i,e,2*l*(1-l)),t}})();(function(){const i=bM();return function(e,t,r,s){return i[0]=r[0],i[3]=r[1],i[6]=r[2],i[1]=s[0],i[4]=s[1],i[7]=s[2],i[2]=-t[0],i[5]=-t[1],i[8]=-t[2],b2(e,v2(e,i))}})();const yR=[0,0,0,1];class Cb extends ly{constructor(e=0,t=0,r=0,s=1){super(-0,-0,-0,-0),Array.isArray(e)&&arguments.length===1?this.copy(e):this.set(e,t,r,s)}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3],this.check()}set(e,t,r,s){return this[0]=e,this[1]=t,this[2]=r,this[3]=s,this.check()}fromObject(e){return this[0]=e.x,this[1]=e.y,this[2]=e.z,this[3]=e.w,this.check()}fromMatrix3(e){return v2(this,e),this.check()}fromAxisRotation(e,t){return x2(this,e,t),this.check()}identity(){return sR(this),this.check()}setAxisAngle(e,t){return this.fromAxisRotation(e,t)}get ELEMENTS(){return 4}get x(){return this[0]}set x(e){this[0]=Di(e)}get y(){return this[1]}set y(e){this[1]=Di(e)}get z(){return this[2]}set z(e){this[2]=Di(e)}get w(){return this[3]}set w(e){this[3]=Di(e)}len(){return gR(this)}lengthSquared(){return mR(this)}dot(e){return fR(this,e)}rotationTo(e,t){return _R(this,e,t),this.check()}add(e){return hR(this,this,e),this.check()}calculateW(){return lR(this,this),this.check()}conjugate(){return uR(this,this),this.check()}invert(){return cR(this,this),this.check()}lerp(e,t,r){return r===void 0?this.lerp(this,e,t):(pR(this,e,t,r),this.check())}multiplyRight(e){return Ib(this,this,e),this.check()}multiplyLeft(e){return Ib(this,e,this),this.check()}normalize(){const e=this.len(),t=e>0?1/e:0;return this[0]=this[0]*t,this[1]=this[1]*t,this[2]=this[2]*t,this[3]=this[3]*t,e===0&&(this[3]=1),this.check()}rotateX(e){return nR(this,this,e),this.check()}rotateY(e){return oR(this,this,e),this.check()}rotateZ(e){return aR(this,this,e),this.check()}scale(e){return dR(this,this,e),this.check()}slerp(e,t,r){let s,a,u;switch(arguments.length){case 1:({start:s=yR,target:a,ratio:u}=e);break;case 2:s=this,a=e,u=t;break;default:s=e,a=t,u=r}return Of(this,s,a,u),this.check()}transformVector4(e,t=new uy){return KM(t,e,this),bh(t,4)}lengthSq(){return this.lengthSquared()}setFromAxisAngle(e,t){return this.setAxisAngle(e,t)}premultiply(e){return this.multiplyLeft(e)}multiply(e){return this.multiplyRight(e)}}const xR=1e-15,vR=1e-20;function w2(i,e=[],t=0){const r=Math.fround(i),s=i-r;return e[t]=r,e[t+1]=s,e}function bR(i){return i-Math.fround(i)}function wR(i){const e=new Float32Array(32);for(let t=0;t<4;++t)for(let r=0;r<4;++r){const s=t*4+r;w2(i[r*4+t],e,s*2)}return e}const TR=`#ifdef LUMA_FP32_TAN_PRECISION_WORKAROUND

// All these functions are for substituting tan() function from Intel GPU only
const float TWO_PI = 6.2831854820251465;
const float PI_2 = 1.5707963705062866;
const float PI_16 = 0.1963495463132858;

const float SIN_TABLE_0 = 0.19509032368659973;
const float SIN_TABLE_1 = 0.3826834261417389;
const float SIN_TABLE_2 = 0.5555702447891235;
const float SIN_TABLE_3 = 0.7071067690849304;

const float COS_TABLE_0 = 0.9807852506637573;
const float COS_TABLE_1 = 0.9238795042037964;
const float COS_TABLE_2 = 0.8314695954322815;
const float COS_TABLE_3 = 0.7071067690849304;

const float INVERSE_FACTORIAL_3 = 1.666666716337204e-01; // 1/3!
const float INVERSE_FACTORIAL_5 = 8.333333767950535e-03; // 1/5!
const float INVERSE_FACTORIAL_7 = 1.9841270113829523e-04; // 1/7!
const float INVERSE_FACTORIAL_9 = 2.75573188446287533e-06; // 1/9!

float sin_taylor_fp32(float a) {
  float r, s, t, x;

  if (a == 0.0) {
    return 0.0;
  }

  x = -a * a;
  s = a;
  r = a;

  r = r * x;
  t = r * INVERSE_FACTORIAL_3;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_5;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_7;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_9;
  s = s + t;

  return s;
}

void sincos_taylor_fp32(float a, out float sin_t, out float cos_t) {
  if (a == 0.0) {
    sin_t = 0.0;
    cos_t = 1.0;
  }
  sin_t = sin_taylor_fp32(a);
  cos_t = sqrt(1.0 - sin_t * sin_t);
}

float tan_taylor_fp32(float a) {
    float sin_a;
    float cos_a;

    if (a == 0.0) {
        return 0.0;
    }

    // 2pi range reduction
    float z = floor(a / TWO_PI);
    float r = a - TWO_PI * z;

    float t;
    float q = floor(r / PI_2 + 0.5);
    int j = int(q);

    if (j < -2 || j > 2) {
        return 1.0 / 0.0;
    }

    t = r - PI_2 * q;

    q = floor(t / PI_16 + 0.5);
    int k = int(q);
    int abs_k = int(abs(float(k)));

    if (abs_k > 4) {
        return 1.0 / 0.0;
    } else {
        t = t - PI_16 * q;
    }

    float u = 0.0;
    float v = 0.0;

    float sin_t, cos_t;
    float s, c;
    sincos_taylor_fp32(t, sin_t, cos_t);

    if (k == 0) {
        s = sin_t;
        c = cos_t;
    } else {
        if (abs(float(abs_k) - 1.0) < 0.5) {
            u = COS_TABLE_0;
            v = SIN_TABLE_0;
        } else if (abs(float(abs_k) - 2.0) < 0.5) {
            u = COS_TABLE_1;
            v = SIN_TABLE_1;
        } else if (abs(float(abs_k) - 3.0) < 0.5) {
            u = COS_TABLE_2;
            v = SIN_TABLE_2;
        } else if (abs(float(abs_k) - 4.0) < 0.5) {
            u = COS_TABLE_3;
            v = SIN_TABLE_3;
        }
        if (k > 0) {
            s = u * sin_t + v * cos_t;
            c = u * cos_t - v * sin_t;
        } else {
            s = u * sin_t - v * cos_t;
            c = u * cos_t + v * sin_t;
        }
    }

    if (j == 0) {
        sin_a = s;
        cos_a = c;
    } else if (j == 1) {
        sin_a = c;
        cos_a = -s;
    } else if (j == -1) {
        sin_a = -c;
        cos_a = s;
    } else {
        sin_a = -s;
        cos_a = -c;
    }
    return sin_a / cos_a;
}
#endif

float tan_fp32(float a) {
#ifdef LUMA_FP32_TAN_PRECISION_WORKAROUND
  return tan_taylor_fp32(a);
#else
  return tan(a);
#endif
}
`,SR={name:"fp32",vs:TR},AR=`
uniform fp64arithmeticUniforms {
  uniform float ONE;
} fp64;

/*
About LUMA_FP64_CODE_ELIMINATION_WORKAROUND

The purpose of this workaround is to prevent shader compilers from
optimizing away necessary arithmetic operations by swapping their sequences
or transform the equation to some 'equivalent' form.

The method is to multiply an artifical variable, ONE, which will be known to
the compiler to be 1 only at runtime. The whole expression is then represented
as a polynomial with respective to ONE. In the coefficients of all terms, only one a
and one b should appear

err = (a + b) * ONE^6 - a * ONE^5 - (a + b) * ONE^4 + a * ONE^3 - b - (a + b) * ONE^2 + a * ONE
*/

// Divide float number to high and low floats to extend fraction bits
vec2 split(float a) {
  const float SPLIT = 4097.0;
  float t = a * SPLIT;
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  float a_hi = t * fp64.ONE - (t - a);
  float a_lo = a * fp64.ONE - a_hi;
#else
  float a_hi = t - (t - a);
  float a_lo = a - a_hi;
#endif
  return vec2(a_hi, a_lo);
}

// Divide float number again when high float uses too many fraction bits
vec2 split2(vec2 a) {
  vec2 b = split(a.x);
  b.y += a.y;
  return b;
}

// Special sum operation when a > b
vec2 quickTwoSum(float a, float b) {
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  float sum = (a + b) * fp64.ONE;
  float err = b - (sum - a) * fp64.ONE;
#else
  float sum = a + b;
  float err = b - (sum - a);
#endif
  return vec2(sum, err);
}

// General sum operation
vec2 twoSum(float a, float b) {
  float s = (a + b);
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  float v = (s * fp64.ONE - a) * fp64.ONE;
  float err = (a - (s - v) * fp64.ONE) * fp64.ONE * fp64.ONE * fp64.ONE + (b - v);
#else
  float v = s - a;
  float err = (a - (s - v)) + (b - v);
#endif
  return vec2(s, err);
}

vec2 twoSub(float a, float b) {
  float s = (a - b);
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  float v = (s * fp64.ONE - a) * fp64.ONE;
  float err = (a - (s - v) * fp64.ONE) * fp64.ONE * fp64.ONE * fp64.ONE - (b + v);
#else
  float v = s - a;
  float err = (a - (s - v)) - (b + v);
#endif
  return vec2(s, err);
}

vec2 twoSqr(float a) {
  float prod = a * a;
  vec2 a_fp64 = split(a);
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  float err = ((a_fp64.x * a_fp64.x - prod) * fp64.ONE + 2.0 * a_fp64.x *
    a_fp64.y * fp64.ONE * fp64.ONE) + a_fp64.y * a_fp64.y * fp64.ONE * fp64.ONE * fp64.ONE;
#else
  float err = ((a_fp64.x * a_fp64.x - prod) + 2.0 * a_fp64.x * a_fp64.y) + a_fp64.y * a_fp64.y;
#endif
  return vec2(prod, err);
}

vec2 twoProd(float a, float b) {
  float prod = a * b;
  vec2 a_fp64 = split(a);
  vec2 b_fp64 = split(b);
  float err = ((a_fp64.x * b_fp64.x - prod) + a_fp64.x * b_fp64.y +
    a_fp64.y * b_fp64.x) + a_fp64.y * b_fp64.y;
  return vec2(prod, err);
}

vec2 sum_fp64(vec2 a, vec2 b) {
  vec2 s, t;
  s = twoSum(a.x, b.x);
  t = twoSum(a.y, b.y);
  s.y += t.x;
  s = quickTwoSum(s.x, s.y);
  s.y += t.y;
  s = quickTwoSum(s.x, s.y);
  return s;
}

vec2 sub_fp64(vec2 a, vec2 b) {
  vec2 s, t;
  s = twoSub(a.x, b.x);
  t = twoSub(a.y, b.y);
  s.y += t.x;
  s = quickTwoSum(s.x, s.y);
  s.y += t.y;
  s = quickTwoSum(s.x, s.y);
  return s;
}

vec2 mul_fp64(vec2 a, vec2 b) {
  vec2 prod = twoProd(a.x, b.x);
  // y component is for the error
  prod.y += a.x * b.y;
#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)
  prod = split2(prod);
#endif
  prod = quickTwoSum(prod.x, prod.y);
  prod.y += a.y * b.x;
#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)
  prod = split2(prod);
#endif
  prod = quickTwoSum(prod.x, prod.y);
  return prod;
}

vec2 div_fp64(vec2 a, vec2 b) {
  float xn = 1.0 / b.x;
#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)
  vec2 yn = mul_fp64(a, vec2(xn, 0));
#else
  vec2 yn = a * xn;
#endif
  float diff = (sub_fp64(a, mul_fp64(b, yn))).x;
  vec2 prod = twoProd(xn, diff);
  return sum_fp64(yn, prod);
}

vec2 sqrt_fp64(vec2 a) {
  if (a.x == 0.0 && a.y == 0.0) return vec2(0.0, 0.0);
  if (a.x < 0.0) return vec2(0.0 / 0.0, 0.0 / 0.0);

  float x = 1.0 / sqrt(a.x);
  float yn = a.x * x;
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  vec2 yn_sqr = twoSqr(yn) * fp64.ONE;
#else
  vec2 yn_sqr = twoSqr(yn);
#endif
  float diff = sub_fp64(a, yn_sqr).x;
  vec2 prod = twoProd(x * 0.5, diff);
#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)
  return sum_fp64(split(yn), prod);
#else
  return sum_fp64(vec2(yn, 0.0), prod);
#endif
}
`,ER={ONE:1},IR={name:"fp64arithmetic",vs:AR,defaultUniforms:ER,uniformTypes:{ONE:"f32"},fp64ify:w2,fp64LowPart:bR,fp64ifyMatrix4:wR},CR=[0,1,1,1],PR=`uniform pickingUniforms {
  float isActive;
  float isAttribute;
  float isHighlightActive;
  float useFloatColors;
  vec3 highlightedObjectColor;
  vec4 highlightColor;
} picking;

out vec4 picking_vRGBcolor_Avalid;

// Normalize unsigned byte color to 0-1 range
vec3 picking_normalizeColor(vec3 color) {
  return picking.useFloatColors > 0.5 ? color : color / 255.0;
}

// Normalize unsigned byte color to 0-1 range
vec4 picking_normalizeColor(vec4 color) {
  return picking.useFloatColors > 0.5 ? color : color / 255.0;
}

bool picking_isColorZero(vec3 color) {
  return dot(color, vec3(1.0)) < 0.00001;
}

bool picking_isColorValid(vec3 color) {
  return dot(color, vec3(1.0)) > 0.00001;
}

// Check if this vertex is highlighted 
bool isVertexHighlighted(vec3 vertexColor) {
  vec3 highlightedObjectColor = picking_normalizeColor(picking.highlightedObjectColor);
  return
    bool(picking.isHighlightActive) && picking_isColorZero(abs(vertexColor - highlightedObjectColor));
}

// Set the current picking color
void picking_setPickingColor(vec3 pickingColor) {
  pickingColor = picking_normalizeColor(pickingColor);

  if (bool(picking.isActive)) {
    // Use alpha as the validity flag. If pickingColor is [0, 0, 0] fragment is non-pickable
    picking_vRGBcolor_Avalid.a = float(picking_isColorValid(pickingColor));

    if (!bool(picking.isAttribute)) {
      // Stores the picking color so that the fragment shader can render it during picking
      picking_vRGBcolor_Avalid.rgb = pickingColor;
    }
  } else {
    // Do the comparison with selected item color in vertex shader as it should mean fewer compares
    picking_vRGBcolor_Avalid.a = float(isVertexHighlighted(pickingColor));
  }
}

void picking_setPickingAttribute(float value) {
  if (bool(picking.isAttribute)) {
    picking_vRGBcolor_Avalid.r = value;
  }
}

void picking_setPickingAttribute(vec2 value) {
  if (bool(picking.isAttribute)) {
    picking_vRGBcolor_Avalid.rg = value;
  }
}

void picking_setPickingAttribute(vec3 value) {
  if (bool(picking.isAttribute)) {
    picking_vRGBcolor_Avalid.rgb = value;
  }
}
`,MR=`uniform pickingUniforms {
  float isActive;
  float isAttribute;
  float isHighlightActive;
  float useFloatColors;
  vec3 highlightedObjectColor;
  vec4 highlightColor;
} picking;

in vec4 picking_vRGBcolor_Avalid;

/*
 * Returns highlight color if this item is selected.
 */
vec4 picking_filterHighlightColor(vec4 color) {
  // If we are still picking, we don't highlight
  if (picking.isActive > 0.5) {
    return color;
  }

  bool selected = bool(picking_vRGBcolor_Avalid.a);

  if (selected) {
    // Blend in highlight color based on its alpha value
    float highLightAlpha = picking.highlightColor.a;
    float blendedAlpha = highLightAlpha + color.a * (1.0 - highLightAlpha);
    float highLightRatio = highLightAlpha / blendedAlpha;

    vec3 blendedRGB = mix(color.rgb, picking.highlightColor.rgb, highLightRatio);
    return vec4(blendedRGB, blendedAlpha);
  } else {
    return color;
  }
}

/*
 * Returns picking color if picking enabled else unmodified argument.
 */
vec4 picking_filterPickingColor(vec4 color) {
  if (bool(picking.isActive)) {
    if (picking_vRGBcolor_Avalid.a == 0.0) {
      discard;
    }
    return picking_vRGBcolor_Avalid;
  }
  return color;
}

/*
 * Returns picking color if picking is enabled if not
 * highlight color if this item is selected, otherwise unmodified argument.
 */
vec4 picking_filterColor(vec4 color) {
  vec4 highlightColor = picking_filterHighlightColor(color);
  return picking_filterPickingColor(highlightColor);
}
`,Pb={props:{},uniforms:{},name:"picking",uniformTypes:{isActive:"f32",isAttribute:"f32",isHighlightActive:"f32",useFloatColors:"f32",highlightedObjectColor:"vec3<f32>",highlightColor:"vec4<f32>"},defaultUniforms:{isActive:!1,isAttribute:!1,isHighlightActive:!1,useFloatColors:!0,highlightedObjectColor:[0,0,0],highlightColor:CR},vs:PR,fs:MR,getUniforms:RR};function RR(i={},e){const t={};if(i.highlightedObjectColor!==void 0)if(i.highlightedObjectColor===null)t.isHighlightActive=!1;else{t.isHighlightActive=!0;const r=i.highlightedObjectColor.slice(0,3);t.highlightedObjectColor=r}if(i.highlightColor){const r=Array.from(i.highlightColor,s=>s/255);Number.isFinite(r[3])||(r[3]=1),t.highlightColor=r}return i.isActive!==void 0&&(t.isActive=!!i.isActive,t.isAttribute=!!i.isAttribute),i.useFloatColors!==void 0&&(t.useFloatColors=!!i.useFloatColors),t}const Mb=`precision highp int;

// #if (defined(SHADER_TYPE_FRAGMENT) && defined(LIGHTING_FRAGMENT)) || (defined(SHADER_TYPE_VERTEX) && defined(LIGHTING_VERTEX))
struct AmbientLight {
  vec3 color;
};

struct PointLight {
  vec3 color;
  vec3 position;
  vec3 attenuation; // 2nd order x:Constant-y:Linear-z:Exponential
};

struct DirectionalLight {
  vec3 color;
  vec3 direction;
};

uniform lightingUniforms {
  int enabled;
  int lightType;

  int directionalLightCount;
  int pointLightCount;

  vec3 ambientColor;

  vec3 lightColor0;
  vec3 lightPosition0;
  vec3 lightDirection0;
  vec3 lightAttenuation0;

  vec3 lightColor1;
  vec3 lightPosition1;
  vec3 lightDirection1;
  vec3 lightAttenuation1;

  vec3 lightColor2;
  vec3 lightPosition2;
  vec3 lightDirection2;
  vec3 lightAttenuation2;
} lighting;

PointLight lighting_getPointLight(int index) {
  switch (index) {
    case 0:
      return PointLight(lighting.lightColor0, lighting.lightPosition0, lighting.lightAttenuation0);
    case 1:
      return PointLight(lighting.lightColor1, lighting.lightPosition1, lighting.lightAttenuation1);
    case 2:
    default:  
      return PointLight(lighting.lightColor2, lighting.lightPosition2, lighting.lightAttenuation2);
  }
}

DirectionalLight lighting_getDirectionalLight(int index) {
  switch (index) {
    case 0:
      return DirectionalLight(lighting.lightColor0, lighting.lightDirection0);
    case 1:
      return DirectionalLight(lighting.lightColor1, lighting.lightDirection1);
    case 2:
    default:   
      return DirectionalLight(lighting.lightColor2, lighting.lightDirection2);
  }
} 

float getPointLightAttenuation(PointLight pointLight, float distance) {
  return pointLight.attenuation.x
       + pointLight.attenuation.y * distance
       + pointLight.attenuation.z * distance * distance;
}

// #endif
`,kR=`// #if (defined(SHADER_TYPE_FRAGMENT) && defined(LIGHTING_FRAGMENT)) || (defined(SHADER_TYPE_VERTEX) && defined(LIGHTING_VERTEX))
struct AmbientLight {
  color: vec3<f32>,
};

struct PointLight {
  color: vec3<f32>,
  position: vec3<f32>,
  attenuation: vec3<f32>, // 2nd order x:Constant-y:Linear-z:Exponential
};

struct DirectionalLight {
  color: vec3<f32>,
  direction: vec3<f32>,
};

struct lightingUniforms {
  enabled: i32,
  pointLightCount: i32,
  directionalLightCount: i32,

  ambientColor: vec3<f32>,

  // TODO - support multiple lights by uncommenting arrays below
  lightType: i32,
  lightColor: vec3<f32>,
  lightDirection: vec3<f32>,
  lightPosition: vec3<f32>,
  lightAttenuation: vec3<f32>,

  // AmbientLight ambientLight;
  // PointLight pointLight[MAX_LIGHTS];
  // DirectionalLight directionalLight[MAX_LIGHTS];
};

// Binding 0:1 is reserved for lighting (Note: could go into separate bind group as it is stable across draw calls)
@binding(1) @group(0) var<uniform> lighting : lightingUniforms;

fn lighting_getPointLight(index: i32) -> PointLight {
  return PointLight(lighting.lightColor, lighting.lightPosition, lighting.lightAttenuation);
}

fn lighting_getDirectionalLight(index: i32) -> DirectionalLight {
  return DirectionalLight(lighting.lightColor, lighting.lightDirection);
} 

fn getPointLightAttenuation(pointLight: PointLight, distance: f32) -> f32 {
  return pointLight.attenuation.x
       + pointLight.attenuation.y * distance
       + pointLight.attenuation.z * distance * distance;
}
`,DR=5,OR=255;var Rh;(function(i){i[i.POINT=0]="POINT",i[i.DIRECTIONAL=1]="DIRECTIONAL"})(Rh||(Rh={}));const Lf={props:{},uniforms:{},name:"lighting",defines:{},uniformTypes:{enabled:"i32",lightType:"i32",directionalLightCount:"i32",pointLightCount:"i32",ambientColor:"vec3<f32>",lightColor0:"vec3<f32>",lightPosition0:"vec3<f32>",lightDirection0:"vec3<f32>",lightAttenuation0:"vec3<f32>",lightColor1:"vec3<f32>",lightPosition1:"vec3<f32>",lightDirection1:"vec3<f32>",lightAttenuation1:"vec3<f32>",lightColor2:"vec3<f32>",lightPosition2:"vec3<f32>",lightDirection2:"vec3<f32>",lightAttenuation2:"vec3<f32>"},defaultUniforms:{enabled:1,lightType:Rh.POINT,directionalLightCount:0,pointLightCount:0,ambientColor:[.1,.1,.1],lightColor0:[1,1,1],lightPosition0:[1,1,2],lightDirection0:[1,1,1],lightAttenuation0:[1,0,0],lightColor1:[1,1,1],lightPosition1:[1,1,2],lightDirection1:[1,1,1],lightAttenuation1:[1,0,0],lightColor2:[1,1,1],lightPosition2:[1,1,2],lightDirection2:[1,1,1],lightAttenuation2:[1,0,0]},source:kR,vs:Mb,fs:Mb,getUniforms:LR};function LR(i,e={}){if(i=i&&{...i},!i)return{...Lf.defaultUniforms};i.lights&&(i={...i,...BR(i.lights),lights:void 0});const{ambientLight:t,pointLights:r,directionalLights:s}=i||{};if(!(t||r&&r.length>0||s&&s.length>0))return{...Lf.defaultUniforms,enabled:0};const u={...Lf.defaultUniforms,...e,...FR({ambientLight:t,pointLights:r,directionalLights:s})};return i.enabled!==void 0&&(u.enabled=i.enabled?1:0),u}function FR({ambientLight:i,pointLights:e=[],directionalLights:t=[]}){const r={};r.ambientColor=um(i);let s=0;for(const a of e){r.lightType=Rh.POINT;const u=s;r[`lightColor${u}`]=um(a),r[`lightPosition${u}`]=a.position,r[`lightAttenuation${u}`]=a.attenuation||[1,0,0],s++}for(const a of t){r.lightType=Rh.DIRECTIONAL;const u=s;r[`lightColor${u}`]=um(a),r[`lightDirection${u}`]=a.direction,s++}return s>DR&&Qe.warn("MAX_LIGHTS exceeded")(),r.directionalLightCount=t.length,r.pointLightCount=e.length,r}function BR(i){const e={pointLights:[],directionalLights:[]};for(const t of i||[])switch(t.type){case"ambient":e.ambientLight=t;break;case"directional":e.directionalLights?.push(t);break;case"point":e.pointLights?.push(t);break}return e}function um(i={}){const{color:e=[0,0,0],intensity:t=1}=i;return e.map(r=>r*t/OR)}const NR=`uniform phongMaterialUniforms {
  uniform float ambient;
  uniform float diffuse;
  uniform float shininess;
  uniform vec3  specularColor;
} material;
`,zR=`#define MAX_LIGHTS 3

uniform phongMaterialUniforms {
  uniform float ambient;
  uniform float diffuse;
  uniform float shininess;
  uniform vec3  specularColor;
} material;

vec3 lighting_getLightColor(vec3 surfaceColor, vec3 light_direction, vec3 view_direction, vec3 normal_worldspace, vec3 color) {
  vec3 halfway_direction = normalize(light_direction + view_direction);
  float lambertian = dot(light_direction, normal_worldspace);
  float specular = 0.0;
  if (lambertian > 0.0) {
    float specular_angle = max(dot(normal_worldspace, halfway_direction), 0.0);
    specular = pow(specular_angle, material.shininess);
  }
  lambertian = max(lambertian, 0.0);
  return (lambertian * material.diffuse * surfaceColor + specular * material.specularColor) * color;
}

vec3 lighting_getLightColor(vec3 surfaceColor, vec3 cameraPosition, vec3 position_worldspace, vec3 normal_worldspace) {
  vec3 lightColor = surfaceColor;

  if (lighting.enabled == 0) {
    return lightColor;
  }

  vec3 view_direction = normalize(cameraPosition - position_worldspace);
  lightColor = material.ambient * surfaceColor * lighting.ambientColor;

  for (int i = 0; i < lighting.pointLightCount; i++) {
    PointLight pointLight = lighting_getPointLight(i);
    vec3 light_position_worldspace = pointLight.position;
    vec3 light_direction = normalize(light_position_worldspace - position_worldspace);
    float light_attenuation = getPointLightAttenuation(pointLight, distance(light_position_worldspace, position_worldspace));
    lightColor += lighting_getLightColor(surfaceColor, light_direction, view_direction, normal_worldspace, pointLight.color / light_attenuation);
  }

  int totalLights = min(MAX_LIGHTS, lighting.pointLightCount + lighting.directionalLightCount);
  for (int i = lighting.pointLightCount; i < totalLights; i++) {
    DirectionalLight directionalLight = lighting_getDirectionalLight(i);
    lightColor += lighting_getLightColor(surfaceColor, -directionalLight.direction, view_direction, normal_worldspace, directionalLight.color);
  }
  
  return lightColor;
}
`,UR=`struct phongMaterialUniforms {
  ambient: f32,
  diffuse: f32,
  shininess: f32,
  specularColor: vec3<f32>,
};

@binding(2) @group(0) var<uniform> phongMaterial : phongMaterialUniforms;

fn lighting_getLightColor(surfaceColor: vec3<f32>, light_direction: vec3<f32>, view_direction: vec3<f32>, normal_worldspace: vec3<f32>, color: vec3<f32>) -> vec3<f32> {
  let halfway_direction: vec3<f32> = normalize(light_direction + view_direction);
  var lambertian: f32 = dot(light_direction, normal_worldspace);
  var specular: f32 = 0.0;
  if (lambertian > 0.0) {
    let specular_angle = max(dot(normal_worldspace, halfway_direction), 0.0);
    specular = pow(specular_angle, phongMaterial.shininess);
  }
  lambertian = max(lambertian, 0.0);
  return (lambertian * phongMaterial.diffuse * surfaceColor + specular * phongMaterial.specularColor) * color;
}

fn lighting_getLightColor2(surfaceColor: vec3<f32>, cameraPosition: vec3<f32>, position_worldspace: vec3<f32>, normal_worldspace: vec3<f32>) -> vec3<f32> {
  var lightColor: vec3<f32> = surfaceColor;

  if (lighting.enabled == 0) {
    return lightColor;
  }

  let view_direction: vec3<f32> = normalize(cameraPosition - position_worldspace);
  lightColor = phongMaterial.ambient * surfaceColor * lighting.ambientColor;

  if (lighting.lightType == 0) {
    let pointLight: PointLight  = lighting_getPointLight(0);
    let light_position_worldspace: vec3<f32> = pointLight.position;
    let light_direction: vec3<f32> = normalize(light_position_worldspace - position_worldspace);
    lightColor += lighting_getLightColor(surfaceColor, light_direction, view_direction, normal_worldspace, pointLight.color);
  } else if (lighting.lightType == 1) {
    var directionalLight: DirectionalLight = lighting_getDirectionalLight(0);
    lightColor += lighting_getLightColor(surfaceColor, -directionalLight.direction, view_direction, normal_worldspace, directionalLight.color);
  }
  
  return lightColor;
  /*
  for (int i = 0; i < MAX_LIGHTS; i++) {
    if (i >= lighting.pointLightCount) {
      break;
    }
    PointLight pointLight = lighting.pointLight[i];
    vec3 light_position_worldspace = pointLight.position;
    vec3 light_direction = normalize(light_position_worldspace - position_worldspace);
    lightColor += lighting_getLightColor(surfaceColor, light_direction, view_direction, normal_worldspace, pointLight.color);
  }

  for (int i = 0; i < MAX_LIGHTS; i++) {
    if (i >= lighting.directionalLightCount) {
      break;
    }
    DirectionalLight directionalLight = lighting.directionalLight[i];
    lightColor += lighting_getLightColor(surfaceColor, -directionalLight.direction, view_direction, normal_worldspace, directionalLight.color);
  }
  */
}

fn lighting_getSpecularLightColor(cameraPosition: vec3<f32>, position_worldspace: vec3<f32>, normal_worldspace: vec3<f32>) -> vec3<f32>{
  var lightColor = vec3<f32>(0, 0, 0);
  let surfaceColor = vec3<f32>(0, 0, 0);

  if (lighting.enabled == 0) {
    let view_direction = normalize(cameraPosition - position_worldspace);

    switch (lighting.lightType) {
      case 0, default: {
        let pointLight: PointLight = lighting_getPointLight(0);
        let light_position_worldspace: vec3<f32> = pointLight.position;
        let light_direction: vec3<f32> = normalize(light_position_worldspace - position_worldspace);
        lightColor += lighting_getLightColor(surfaceColor, light_direction, view_direction, normal_worldspace, pointLight.color);
      }
      case 1: {
        let directionalLight: DirectionalLight = lighting_getDirectionalLight(0);
        lightColor += lighting_getLightColor(surfaceColor, -directionalLight.direction, view_direction, normal_worldspace, directionalLight.color);
      }
    }
  }
  return lightColor;
}
`,T2={props:{},name:"gouraudMaterial",vs:zR.replace("phongMaterial","gouraudMaterial"),fs:NR.replace("phongMaterial","gouraudMaterial"),source:UR.replaceAll("phongMaterial","gouraudMaterial"),defines:{LIGHTING_VERTEX:!0},dependencies:[Lf],uniformTypes:{ambient:"f32",diffuse:"f32",shininess:"f32",specularColor:"vec3<f32>"},defaultUniforms:{ambient:.35,diffuse:.6,shininess:32,specularColor:[.15,.15,.15]},getUniforms(i){const e={...i};return e.specularColor&&(e.specularColor=e.specularColor.map(t=>t/255)),{...T2.defaultUniforms,...e}}},Rb=`uniform layerUniforms {
  uniform float opacity;
} layer;
`,VR={name:"layer",vs:Rb,fs:Rb,getUniforms:i=>({opacity:Math.pow(i.opacity,1/2.2)}),uniformTypes:{opacity:"f32"}},jR=`

struct ColorUniforms {
  opacity: f32,
};

var<private> color: ColorUniforms = ColorUniforms(1.0);
// TODO (kaapp) avoiding binding index collisions to handle layer opacity 
// requires some thought.
// @group(0) @binding(0) var<uniform> color: ColorUniforms;

@must_use
fn deckgl_premultiplied_alpha(fragColor: vec4<f32>) -> vec4<f32> {
    return vec4(fragColor.rgb * fragColor.a, fragColor.a); 
};
`,$R={name:"color",dependencies:[],source:jR,getUniforms:i=>({}),uniformTypes:{opacity:"f32"}},WR=`const SMOOTH_EDGE_RADIUS: f32 = 0.5;

struct VertexGeometry {
  position: vec4<f32>,
  worldPosition: vec3<f32>,
  worldPositionAlt: vec3<f32>,
  normal: vec3<f32>,
  uv: vec2<f32>,
  pickingColor: vec3<f32>,
};

var<private> geometry_: VertexGeometry = VertexGeometry(
  vec4<f32>(0.0, 0.0, 1.0, 0.0),
  vec3<f32>(0.0, 0.0, 0.0),
  vec3<f32>(0.0, 0.0, 0.0),
  vec3<f32>(0.0, 0.0, 0.0),
  vec2<f32>(0.0, 0.0),
  vec3<f32>(0.0, 0.0, 0.0)
);

struct FragmentGeometry {
  uv: vec2<f32>,
};

var<private> fragmentGeometry: FragmentGeometry;

fn smoothedge(edge: f32, x: f32) -> f32 {
  return smoothstep(edge - SMOOTH_EDGE_RADIUS, edge + SMOOTH_EDGE_RADIUS, x);
}
`,S2="#define SMOOTH_EDGE_RADIUS 0.5",HR=`${S2}

struct VertexGeometry {
  vec4 position;
  vec3 worldPosition;
  vec3 worldPositionAlt;
  vec3 normal;
  vec2 uv;
  vec3 pickingColor;
} geometry = VertexGeometry(
  vec4(0.0, 0.0, 1.0, 0.0),
  vec3(0.0),
  vec3(0.0),
  vec3(0.0),
  vec2(0.0),
  vec3(0.0)
);
`,qR=`${S2}

struct FragmentGeometry {
  vec2 uv;
} geometry;

float smoothedge(float edge, float x) {
  return smoothstep(edge - SMOOTH_EDGE_RADIUS, edge + SMOOTH_EDGE_RADIUS, x);
}
`,A2={name:"geometry",source:WR,vs:HR,fs:qR},XR=25;var ar;(function(i){i[i.Start=1]="Start",i[i.Move=2]="Move",i[i.End=4]="End",i[i.Cancel=8]="Cancel"})(ar||(ar={}));var dr;(function(i){i[i.None=0]="None",i[i.Left=1]="Left",i[i.Right=2]="Right",i[i.Up=4]="Up",i[i.Down=8]="Down",i[i.Horizontal=3]="Horizontal",i[i.Vertical=12]="Vertical",i[i.All=15]="All"})(dr||(dr={}));var Gt;(function(i){i[i.Possible=1]="Possible",i[i.Began=2]="Began",i[i.Changed=4]="Changed",i[i.Ended=8]="Ended",i[i.Recognized=8]="Recognized",i[i.Cancelled=16]="Cancelled",i[i.Failed=32]="Failed"})(Gt||(Gt={}));const ZR="compute",YR="auto",t_="manipulation",Ff="none",i_="pan-x",r_="pan-y";function GR(i){if(i.includes(Ff))return Ff;const e=i.includes(i_),t=i.includes(r_);return e&&t?Ff:e||t?e?i_:r_:i.includes(t_)?t_:YR}class KR{constructor(e,t){this.actions="",this.manager=e,this.set(t)}set(e){e===ZR&&(e=this.compute()),this.manager.element&&(this.manager.element.style.touchAction=e,this.actions=e)}update(){this.set(this.manager.options.touchAction)}compute(){let e=[];for(const t of this.manager.recognizers)t.options.enable&&(e=e.concat(t.getTouchAction()));return GR(e.join(" "))}}function op(i){return i.trim().split(/\s+/g)}function hm(i,e,t){if(i)for(const r of op(e))i.addEventListener(r,t,!1)}function dm(i,e,t){if(i)for(const r of op(e))i.removeEventListener(r,t,!1)}function kb(i){return(i.ownerDocument||i).defaultView}function JR(i,e){let t=i;for(;t;){if(t===e)return!0;t=t.parentNode}return!1}function E2(i){const e=i.length;if(e===1)return{x:Math.round(i[0].clientX),y:Math.round(i[0].clientY)};let t=0,r=0,s=0;for(;s<e;)t+=i[s].clientX,r+=i[s].clientY,s++;return{x:Math.round(t/e),y:Math.round(r/e)}}function Db(i){const e=[];let t=0;for(;t<i.pointers.length;)e[t]={clientX:Math.round(i.pointers[t].clientX),clientY:Math.round(i.pointers[t].clientY)},t++;return{timeStamp:Date.now(),pointers:e,center:E2(e),deltaX:i.deltaX,deltaY:i.deltaY}}function I2(i,e){const t=e.x-i.x,r=e.y-i.y;return Math.sqrt(t*t+r*r)}function Ob(i,e){const t=e.clientX-i.clientX,r=e.clientY-i.clientY;return Math.sqrt(t*t+r*r)}function QR(i,e){const t=e.x-i.x,r=e.y-i.y;return Math.atan2(r,t)*180/Math.PI}function Lb(i,e){const t=e.clientX-i.clientX,r=e.clientY-i.clientY;return Math.atan2(r,t)*180/Math.PI}function C2(i,e){return i===e?dr.None:Math.abs(i)>=Math.abs(e)?i<0?dr.Left:dr.Right:e<0?dr.Up:dr.Down}function ek(i,e){const t=e.center;let r=i.offsetDelta,s=i.prevDelta;const a=i.prevInput;return(e.eventType===ar.Start||a?.eventType===ar.End)&&(s=i.prevDelta={x:a?.deltaX||0,y:a?.deltaY||0},r=i.offsetDelta={x:t.x,y:t.y}),{deltaX:s.x+(t.x-r.x),deltaY:s.y+(t.y-r.y)}}function P2(i,e,t){return{x:e/i||0,y:t/i||0}}function tk(i,e){return Ob(e[0],e[1])/Ob(i[0],i[1])}function ik(i,e){return Lb(e[1],e[0])-Lb(i[1],i[0])}function rk(i,e){const t=i.lastInterval||e,r=e.timeStamp-t.timeStamp;let s,a,u,l;if(e.eventType!==ar.Cancel&&(r>XR||t.velocity===void 0)){const g=e.deltaX-t.deltaX,v=e.deltaY-t.deltaY,T=P2(r,g,v);a=T.x,u=T.y,s=Math.abs(T.x)>Math.abs(T.y)?T.x:T.y,l=C2(g,v),i.lastInterval=e}else s=t.velocity,a=t.velocityX,u=t.velocityY,l=t.direction;e.velocity=s,e.velocityX=a,e.velocityY=u,e.direction=l}function sk(i,e){const{session:t}=i,{pointers:r}=e,{length:s}=r;t.firstInput||(t.firstInput=Db(e)),s>1&&!t.firstMultiple?t.firstMultiple=Db(e):s===1&&(t.firstMultiple=!1);const{firstInput:a,firstMultiple:u}=t,l=u?u.center:a.center,g=e.center=E2(r);e.timeStamp=Date.now(),e.deltaTime=e.timeStamp-a.timeStamp,e.angle=QR(l,g),e.distance=I2(l,g);const{deltaX:v,deltaY:T}=ek(t,e);e.deltaX=v,e.deltaY=T,e.offsetDirection=C2(e.deltaX,e.deltaY);const S=P2(e.deltaTime,e.deltaX,e.deltaY);e.overallVelocityX=S.x,e.overallVelocityY=S.y,e.overallVelocity=Math.abs(S.x)>Math.abs(S.y)?S.x:S.y,e.scale=u?tk(u.pointers,r):1,e.rotation=u?ik(u.pointers,r):0,e.maxPointers=t.prevInput?e.pointers.length>t.prevInput.maxPointers?e.pointers.length:t.prevInput.maxPointers:e.pointers.length;let P=i.element;return JR(e.srcEvent.target,P)&&(P=e.srcEvent.target),e.target=P,rk(t,e),e}function nk(i,e,t){const r=t.pointers.length,s=t.changedPointers.length,a=e&ar.Start&&r-s===0,u=e&(ar.End|ar.Cancel)&&r-s===0;t.isFirst=!!a,t.isFinal=!!u,a&&(i.session={}),t.eventType=e;const l=sk(i,t);i.emit("hammer.input",l),i.recognize(l),i.session.prevInput=l}let ok=class{constructor(e){this.evEl="",this.evWin="",this.evTarget="",this.domHandler=t=>{this.manager.options.enable&&this.handler(t)},this.manager=e,this.element=e.element,this.target=e.options.inputTarget||e.element}callback(e,t){nk(this.manager,e,t)}init(){hm(this.element,this.evEl,this.domHandler),hm(this.target,this.evTarget,this.domHandler),hm(kb(this.element),this.evWin,this.domHandler)}destroy(){dm(this.element,this.evEl,this.domHandler),dm(this.target,this.evTarget,this.domHandler),dm(kb(this.element),this.evWin,this.domHandler)}};const ak={pointerdown:ar.Start,pointermove:ar.Move,pointerup:ar.End,pointercancel:ar.Cancel,pointerout:ar.Cancel},lk="pointerdown",ck="pointermove pointerup pointercancel";class uk extends ok{constructor(e){super(e),this.evEl=lk,this.evWin=ck,this.store=this.manager.session.pointerEvents=[],this.init()}handler(e){const{store:t}=this;let r=!1;const s=ak[e.type],a=e.pointerType,u=a==="touch";let l=t.findIndex(g=>g.pointerId===e.pointerId);s&ar.Start&&(e.buttons||u)?l<0&&(t.push(e),l=t.length-1):s&(ar.End|ar.Cancel)&&(r=!0),!(l<0)&&(t[l]=e,this.callback(s,{pointers:t,changedPointers:[e],eventType:s,pointerType:a,srcEvent:e}),r&&t.splice(l,1))}}const hk=["","webkit","Moz","MS","ms","o"];function dk(i,e){const t=e[0].toUpperCase()+e.slice(1);for(const r of hk){const s=r?r+t:e;if(s in i)return s}}const fk=1,Fb=2,Bb={touchAction:"compute",enable:!0,inputTarget:null,cssProps:{userSelect:"none",userDrag:"none",touchCallout:"none",tapHighlightColor:"rgba(0,0,0,0)"}};class pk{constructor(e,t){this.options={...Bb,...t,cssProps:{...Bb.cssProps,...t.cssProps},inputTarget:t.inputTarget||e},this.handlers={},this.session={},this.recognizers=[],this.oldCssProps={},this.element=e,this.input=new uk(this),this.touchAction=new KR(this,this.options.touchAction),this.toggleCssProps(!0)}set(e){return Object.assign(this.options,e),e.touchAction&&this.touchAction.update(),e.inputTarget&&(this.input.destroy(),this.input.target=e.inputTarget,this.input.init()),this}stop(e){this.session.stopped=e?Fb:fk}recognize(e){const{session:t}=this;if(t.stopped)return;this.session.prevented&&e.srcEvent.preventDefault();let r;const{recognizers:s}=this;let{curRecognizer:a}=t;(!a||a&&a.state&Gt.Recognized)&&(a=t.curRecognizer=null);let u=0;for(;u<s.length;)r=s[u],t.stopped!==Fb&&(!a||r===a||r.canRecognizeWith(a))?r.recognize(e):r.reset(),!a&&r.state&(Gt.Began|Gt.Changed|Gt.Ended)&&(a=t.curRecognizer=r),u++}get(e){const{recognizers:t}=this;for(let r=0;r<t.length;r++)if(t[r].options.event===e)return t[r];return null}add(e){if(Array.isArray(e)){for(const r of e)this.add(r);return this}const t=this.get(e.options.event);return t&&this.remove(t),this.recognizers.push(e),e.manager=this,this.touchAction.update(),e}remove(e){if(Array.isArray(e)){for(const r of e)this.remove(r);return this}const t=typeof e=="string"?this.get(e):e;if(t){const{recognizers:r}=this,s=r.indexOf(t);s!==-1&&(r.splice(s,1),this.touchAction.update())}return this}on(e,t){if(!e||!t)return;const{handlers:r}=this;for(const s of op(e))r[s]=r[s]||[],r[s].push(t)}off(e,t){if(!e)return;const{handlers:r}=this;for(const s of op(e))t?r[s]&&r[s].splice(r[s].indexOf(t),1):delete r[s]}emit(e,t){const r=this.handlers[e]&&this.handlers[e].slice();if(!r||!r.length)return;const s=t;s.type=e,s.preventDefault=function(){t.srcEvent.preventDefault()};let a=0;for(;a<r.length;)r[a](s),a++}destroy(){this.toggleCssProps(!1),this.handlers={},this.session={},this.input.destroy(),this.element=null}toggleCssProps(e){const{element:t}=this;if(t){for(const[r,s]of Object.entries(this.options.cssProps)){const a=dk(t.style,r);e?(this.oldCssProps[a]=t.style[a],t.style[a]=s):t.style[a]=this.oldCssProps[a]||""}e||(this.oldCssProps={})}}}let gk=1;function mk(){return gk++}function Nb(i){return i&Gt.Cancelled?"cancel":i&Gt.Ended?"end":i&Gt.Changed?"move":i&Gt.Began?"start":""}class M2{constructor(e){this.options=e,this.id=mk(),this.state=Gt.Possible,this.simultaneous={},this.requireFail=[]}set(e){return Object.assign(this.options,e),this.manager.touchAction.update(),this}recognizeWith(e){if(Array.isArray(e)){for(const s of e)this.recognizeWith(s);return this}let t;if(typeof e=="string"){if(t=this.manager.get(e),!t)throw new Error(`Cannot find recognizer ${e}`)}else t=e;const{simultaneous:r}=this;return r[t.id]||(r[t.id]=t,t.recognizeWith(this)),this}dropRecognizeWith(e){if(Array.isArray(e)){for(const r of e)this.dropRecognizeWith(r);return this}let t;return typeof e=="string"?t=this.manager.get(e):t=e,t&&delete this.simultaneous[t.id],this}requireFailure(e){if(Array.isArray(e)){for(const s of e)this.requireFailure(s);return this}let t;if(typeof e=="string"){if(t=this.manager.get(e),!t)throw new Error(`Cannot find recognizer ${e}`)}else t=e;const{requireFail:r}=this;return r.indexOf(t)===-1&&(r.push(t),t.requireFailure(this)),this}dropRequireFailure(e){if(Array.isArray(e)){for(const r of e)this.dropRequireFailure(r);return this}let t;if(typeof e=="string"?t=this.manager.get(e):t=e,t){const r=this.requireFail.indexOf(t);r>-1&&this.requireFail.splice(r,1)}return this}hasRequireFailures(){return!!this.requireFail.find(e=>e.options.enable)}canRecognizeWith(e){return!!this.simultaneous[e.id]}emit(e){if(!e)return;const{state:t}=this;t<Gt.Ended&&this.manager.emit(this.options.event+Nb(t),e),this.manager.emit(this.options.event,e),e.additionalEvent&&this.manager.emit(e.additionalEvent,e),t>=Gt.Ended&&this.manager.emit(this.options.event+Nb(t),e)}tryEmit(e){this.canEmit()?this.emit(e):this.state=Gt.Failed}canEmit(){let e=0;for(;e<this.requireFail.length;){if(!(this.requireFail[e].state&(Gt.Failed|Gt.Possible)))return!1;e++}return!0}recognize(e){const t={...e};if(!this.options.enable){this.reset(),this.state=Gt.Failed;return}this.state&(Gt.Recognized|Gt.Cancelled|Gt.Failed)&&(this.state=Gt.Possible),this.state=this.process(t),this.state&(Gt.Began|Gt.Changed|Gt.Ended|Gt.Cancelled)&&this.tryEmit(t)}getEventNames(){return[this.options.event]}reset(){}}class R2 extends M2{attrTest(e){const t=this.options.pointers;return t===0||e.pointers.length===t}process(e){const{state:t}=this,{eventType:r}=e,s=t&(Gt.Began|Gt.Changed),a=this.attrTest(e);return s&&(r&ar.Cancel||!a)?t|Gt.Cancelled:s||a?r&ar.End?t|Gt.Ended:t&Gt.Began?t|Gt.Changed:Gt.Began:Gt.Failed}}class zb extends M2{constructor(e={}){super({enable:!0,event:"tap",pointers:1,taps:1,interval:300,time:250,threshold:9,posThreshold:10,...e}),this.pTime=null,this.pCenter=null,this._timer=null,this._input=null,this.count=0}getTouchAction(){return[t_]}process(e){const{options:t}=this,r=e.pointers.length===t.pointers,s=e.distance<t.threshold,a=e.deltaTime<t.time;if(this.reset(),e.eventType&ar.Start&&this.count===0)return this.failTimeout();if(s&&a&&r){if(e.eventType!==ar.End)return this.failTimeout();const u=this.pTime?e.timeStamp-this.pTime<t.interval:!0,l=!this.pCenter||I2(this.pCenter,e.center)<t.posThreshold;if(this.pTime=e.timeStamp,this.pCenter=e.center,!l||!u?this.count=1:this.count+=1,this._input=e,this.count%t.taps===0)return this.hasRequireFailures()?(this._timer=setTimeout(()=>{this.state=Gt.Recognized,this.tryEmit(this._input)},t.interval),Gt.Began):Gt.Recognized}return Gt.Failed}failTimeout(){return this._timer=setTimeout(()=>{this.state=Gt.Failed},this.options.interval),Gt.Failed}reset(){clearTimeout(this._timer)}emit(e){this.state===Gt.Recognized&&(e.tapCount=this.count,this.manager.emit(this.options.event,e))}}const _k=["","start","move","end","cancel","up","down","left","right"];class Ub extends R2{constructor(e={}){super({enable:!0,pointers:1,event:"pan",threshold:10,direction:dr.All,...e}),this.pX=null,this.pY=null}getTouchAction(){const{options:{direction:e}}=this,t=[];return e&dr.Horizontal&&t.push(r_),e&dr.Vertical&&t.push(i_),t}getEventNames(){return _k.map(e=>this.options.event+e)}directionTest(e){const{options:t}=this;let r=!0,{distance:s}=e,{direction:a}=e;const u=e.deltaX,l=e.deltaY;return a&t.direction||(t.direction&dr.Horizontal?(a=u===0?dr.None:u<0?dr.Left:dr.Right,r=u!==this.pX,s=Math.abs(e.deltaX)):(a=l===0?dr.None:l<0?dr.Up:dr.Down,r=l!==this.pY,s=Math.abs(e.deltaY))),e.direction=a,r&&s>t.threshold&&!!(a&t.direction)}attrTest(e){return super.attrTest(e)&&(!!(this.state&Gt.Began)||!(this.state&Gt.Began)&&this.directionTest(e))}emit(e){this.pX=e.deltaX,this.pY=e.deltaY;const t=dr[e.direction].toLowerCase();t&&(e.additionalEvent=this.options.event+t),super.emit(e)}}const yk=["","start","move","end","cancel","in","out"];class xk extends R2{constructor(e={}){super({enable:!0,event:"pinch",threshold:0,pointers:2,...e})}getTouchAction(){return[Ff]}getEventNames(){return yk.map(e=>this.options.event+e)}attrTest(e){return super.attrTest(e)&&(Math.abs(e.scale-1)>this.options.threshold||!!(this.state&Gt.Began))}emit(e){if(e.scale!==1){const t=e.scale<1?"in":"out";e.additionalEvent=this.options.event+t}super.emit(e)}}class yp{constructor(e,t,r){this.element=e,this.callback=t,this.options=r}}const vk=typeof navigator<"u"&&navigator.userAgent?navigator.userAgent.toLowerCase():"",bk=vk.indexOf("firefox")!==-1,Vb=4.000244140625,wk=40,Tk=.25;class Sk extends yp{constructor(e,t,r){super(e,t,{enable:!0,...r}),this.handleEvent=s=>{if(!this.options.enable)return;let a=s.deltaY;globalThis.WheelEvent&&(bk&&s.deltaMode===globalThis.WheelEvent.DOM_DELTA_PIXEL&&(a/=globalThis.devicePixelRatio),s.deltaMode===globalThis.WheelEvent.DOM_DELTA_LINE&&(a*=wk)),a!==0&&a%Vb===0&&(a=Math.floor(a/Vb)),s.shiftKey&&a&&(a=a*Tk),this.callback({type:"wheel",center:{x:s.clientX,y:s.clientY},delta:-a,srcEvent:s,pointerType:"mouse",target:s.target})},e.addEventListener("wheel",this.handleEvent,{passive:!1})}destroy(){this.element.removeEventListener("wheel",this.handleEvent)}enableEventType(e,t){e==="wheel"&&(this.options.enable=t)}}const jb=["mousedown","mousemove","mouseup","mouseover","mouseout","mouseleave"];class Ak extends yp{constructor(e,t,r){super(e,t,{enable:!0,...r}),this.handleEvent=a=>{this.handleOverEvent(a),this.handleOutEvent(a),this.handleEnterEvent(a),this.handleLeaveEvent(a),this.handleMoveEvent(a)},this.pressed=!1;const{enable:s}=this.options;this.enableMoveEvent=s,this.enableLeaveEvent=s,this.enableEnterEvent=s,this.enableOutEvent=s,this.enableOverEvent=s,jb.forEach(a=>e.addEventListener(a,this.handleEvent))}destroy(){jb.forEach(e=>this.element.removeEventListener(e,this.handleEvent))}enableEventType(e,t){switch(e){case"pointermove":this.enableMoveEvent=t;break;case"pointerover":this.enableOverEvent=t;break;case"pointerout":this.enableOutEvent=t;break;case"pointerenter":this.enableEnterEvent=t;break;case"pointerleave":this.enableLeaveEvent=t;break}}handleOverEvent(e){this.enableOverEvent&&e.type==="mouseover"&&this._emit("pointerover",e)}handleOutEvent(e){this.enableOutEvent&&e.type==="mouseout"&&this._emit("pointerout",e)}handleEnterEvent(e){this.enableEnterEvent&&e.type==="mouseenter"&&this._emit("pointerenter",e)}handleLeaveEvent(e){this.enableLeaveEvent&&e.type==="mouseleave"&&this._emit("pointerleave",e)}handleMoveEvent(e){if(this.enableMoveEvent)switch(e.type){case"mousedown":e.button>=0&&(this.pressed=!0);break;case"mousemove":e.buttons===0&&(this.pressed=!1),this.pressed||this._emit("pointermove",e);break;case"mouseup":this.pressed=!1;break}}_emit(e,t){this.callback({type:e,center:{x:t.clientX,y:t.clientY},srcEvent:t,pointerType:"mouse",target:t.target})}}const $b=["keydown","keyup"];class Ek extends yp{constructor(e,t,r){super(e,t,{enable:!0,tabIndex:0,...r}),this.handleEvent=s=>{const a=s.target||s.srcElement;a.tagName==="INPUT"&&a.type==="text"||a.tagName==="TEXTAREA"||(this.enableDownEvent&&s.type==="keydown"&&this.callback({type:"keydown",srcEvent:s,key:s.key,target:s.target}),this.enableUpEvent&&s.type==="keyup"&&this.callback({type:"keyup",srcEvent:s,key:s.key,target:s.target}))},this.enableDownEvent=this.options.enable,this.enableUpEvent=this.options.enable,e.tabIndex=this.options.tabIndex,e.style.outline="none",$b.forEach(s=>e.addEventListener(s,this.handleEvent))}destroy(){$b.forEach(e=>this.element.removeEventListener(e,this.handleEvent))}enableEventType(e,t){e==="keydown"&&(this.enableDownEvent=t),e==="keyup"&&(this.enableUpEvent=t)}}class Ik extends yp{constructor(e,t,r){super(e,t,r),this.handleEvent=s=>{this.options.enable&&this.callback({type:"contextmenu",center:{x:s.clientX,y:s.clientY},srcEvent:s,pointerType:"mouse",target:s.target})},e.addEventListener("contextmenu",this.handleEvent)}destroy(){this.element.removeEventListener("contextmenu",this.handleEvent)}enableEventType(e,t){e==="contextmenu"&&(this.options.enable=t)}}const Wb=1,s_=2,Hb=4,Ck={pointerdown:Wb,pointermove:s_,pointerup:Hb,mousedown:Wb,mousemove:s_,mouseup:Hb},Pk=0,Mk=1,Rk=2,kk=1,Dk=2,Ok=4;function Lk(i){const e=Ck[i.srcEvent.type];if(!e)return null;const{buttons:t,button:r}=i.srcEvent;let s=!1,a=!1,u=!1;return e===s_?(s=!!(t&kk),a=!!(t&Ok),u=!!(t&Dk)):(s=r===Pk,a=r===Mk,u=r===Rk),{leftButton:s,middleButton:a,rightButton:u}}function Fk(i,e){const t=i.center;if(!t)return null;const r=e.getBoundingClientRect(),s=r.width/e.offsetWidth||1,a=r.height/e.offsetHeight||1,u={x:(t.x-r.left-e.clientLeft)/s,y:(t.y-r.top-e.clientTop)/a};return{center:t,offsetCenter:u}}const Bk={srcElement:"root",priority:0};class Nk{constructor(e,t){this.handleEvent=r=>{if(this.isEmpty())return;const s=this._normalizeEvent(r);let a=r.srcEvent.target;for(;a&&a!==s.rootElement;){if(this._emit(s,a),s.handled)return;a=a.parentNode}this._emit(s,"root")},this.eventManager=e,this.recognizerName=t,this.handlers=[],this.handlersByElement=new Map,this._active=!1}isEmpty(){return!this._active}add(e,t,r,s=!1,a=!1){const{handlers:u,handlersByElement:l}=this,g={...Bk,...r};let v=l.get(g.srcElement);v||(v=[],l.set(g.srcElement,v));const T={type:e,handler:t,srcElement:g.srcElement,priority:g.priority};s&&(T.once=!0),a&&(T.passive=!0),u.push(T),this._active=this._active||!T.passive;let S=v.length-1;for(;S>=0&&!(v[S].priority>=T.priority);)S--;v.splice(S+1,0,T)}remove(e,t){const{handlers:r,handlersByElement:s}=this;for(let a=r.length-1;a>=0;a--){const u=r[a];if(u.type===e&&u.handler===t){r.splice(a,1);const l=s.get(u.srcElement);l.splice(l.indexOf(u),1),l.length===0&&s.delete(u.srcElement)}}this._active=r.some(a=>!a.passive)}_emit(e,t){const r=this.handlersByElement.get(t);if(r){let s=!1;const a=()=>{e.handled=!0},u=()=>{e.handled=!0,s=!0},l=[];for(let g=0;g<r.length;g++){const{type:v,handler:T,once:S}=r[g];if(T({...e,type:v,stopPropagation:a,stopImmediatePropagation:u}),S&&l.push(r[g]),s)break}for(let g=0;g<l.length;g++){const{type:v,handler:T}=l[g];this.remove(v,T)}}}_normalizeEvent(e){const t=this.eventManager.getElement();return{...e,...Lk(e),...Fk(e,t),preventDefault:()=>{e.srcEvent.preventDefault()},stopImmediatePropagation:null,stopPropagation:null,handled:!1,rootElement:t}}}function zk(i){if("recognizer"in i)return i;let e;const t=Array.isArray(i)?[...i]:[i];if(typeof t[0]=="function"){const r=t.shift(),s=t.shift()||{};e=new r(s)}else e=t.shift();return{recognizer:e,recognizeWith:typeof t[0]=="string"?[t[0]]:t[0],requireFailure:typeof t[1]=="string"?[t[1]]:t[1]}}class Uk{constructor(e=null,t={}){if(this._onBasicInput=r=>{this.manager.emit(r.srcEvent.type,r)},this._onOtherEvent=r=>{this.manager.emit(r.type,r)},this.options={recognizers:[],events:{},touchAction:"compute",tabIndex:0,cssProps:{},...t},this.events=new Map,this.element=e,!!e){this.manager=new pk(e,this.options);for(const r of this.options.recognizers){const{recognizer:s,recognizeWith:a,requireFailure:u}=zk(r);this.manager.add(s),a&&s.recognizeWith(a),u&&s.requireFailure(u)}this.manager.on("hammer.input",this._onBasicInput),this.wheelInput=new Sk(e,this._onOtherEvent,{enable:!1}),this.moveInput=new Ak(e,this._onOtherEvent,{enable:!1}),this.keyInput=new Ek(e,this._onOtherEvent,{enable:!1,tabIndex:t.tabIndex}),this.contextmenuInput=new Ik(e,this._onOtherEvent,{enable:!1}),this.on(this.options.events)}}getElement(){return this.element}destroy(){this.element&&(this.wheelInput.destroy(),this.moveInput.destroy(),this.keyInput.destroy(),this.contextmenuInput.destroy(),this.manager.destroy())}on(e,t,r){this._addEventHandler(e,t,r,!1)}once(e,t,r){this._addEventHandler(e,t,r,!0)}watch(e,t,r){this._addEventHandler(e,t,r,!1,!0)}off(e,t){this._removeEventHandler(e,t)}_toggleRecognizer(e,t){const{manager:r}=this;if(!r)return;const s=r.get(e);s&&(s.set({enable:t}),r.touchAction.update()),this.wheelInput?.enableEventType(e,t),this.moveInput?.enableEventType(e,t),this.keyInput?.enableEventType(e,t),this.contextmenuInput?.enableEventType(e,t)}_addEventHandler(e,t,r,s,a){if(typeof e!="string"){r=t;for(const[v,T]of Object.entries(e))this._addEventHandler(v,T,r,s,a);return}const{manager:u,events:l}=this;if(!u)return;let g=l.get(e);if(!g){const v=this._getRecognizerName(e)||e;g=new Nk(this,v),l.set(e,g),u&&u.on(e,g.handleEvent)}g.add(e,t,r,s,a),g.isEmpty()||this._toggleRecognizer(g.recognizerName,!0)}_removeEventHandler(e,t){if(typeof e!="string"){for(const[a,u]of Object.entries(e))this._removeEventHandler(a,u);return}const{events:r}=this,s=r.get(e);if(s&&(s.remove(e,t),s.isEmpty())){const{recognizerName:a}=s;let u=!1;for(const l of r.values())if(l.recognizerName===a&&!l.isEmpty()){u=!0;break}u||this._toggleRecognizer(a,!1)}}_getRecognizerName(e){return this.manager.recognizers.find(t=>t.getEventNames().includes(e))?.options.event}}const li={DEFAULT:-1,LNGLAT:1,METER_OFFSETS:2,LNGLAT_OFFSETS:3,CARTESIAN:0};Object.defineProperty(li,"IDENTITY",{get:()=>(ni.deprecated("COORDINATE_SYSTEM.IDENTITY","COORDINATE_SYSTEM.CARTESIAN")(),0)});const Bs={WEB_MERCATOR:1,GLOBE:2,WEB_MERCATOR_AUTO_OFFSET:4,IDENTITY:0},to={common:0,meters:1,pixels:2},n_={click:"onClick",dblclick:"onClick",panstart:"onDragStart",panmove:"onDrag",panend:"onDragEnd"},qb={multipan:[Ub,{threshold:10,direction:dr.Vertical,pointers:2}],pinch:[xk,{},null,["multipan"]],pan:[Ub,{threshold:1},["pinch"],["multipan"]],dblclick:[zb,{event:"dblclick",taps:2}],click:[zb,{event:"click"},null,["dblclick"]]};function Vk(i,e){if(i===e)return!0;if(Array.isArray(i)){const t=i.length;if(!e||e.length!==t)return!1;for(let r=0;r<t;r++)if(i[r]!==e[r])return!1;return!0}return!1}function jh(i){let e={},t;return r=>{for(const s in r)if(!Vk(r[s],e[s])){t=i(r),e=r;break}return t}}const Xb=[0,0,0,0],jk=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0],k2=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],$k=[0,0,0],D2=[0,0,0],Wk=jh(Xk);function O2(i,e,t=D2){t.length<3&&(t=[t[0],t[1],0]);let r=t,s,a=!0;switch(e===li.LNGLAT_OFFSETS||e===li.METER_OFFSETS?s=t:s=i.isGeospatial?[Math.fround(i.longitude),Math.fround(i.latitude),0]:null,i.projectionMode){case Bs.WEB_MERCATOR:(e===li.LNGLAT||e===li.CARTESIAN)&&(s=[0,0,0],a=!1);break;case Bs.WEB_MERCATOR_AUTO_OFFSET:e===li.LNGLAT?r=s:e===li.CARTESIAN&&(r=[Math.fround(i.center[0]),Math.fround(i.center[1]),0],s=i.unprojectPosition(r),r[0]-=t[0],r[1]-=t[1],r[2]-=t[2]);break;case Bs.IDENTITY:r=i.position.map(Math.fround),r[2]=r[2]||0;break;case Bs.GLOBE:a=!1,s=null;break;default:a=!1}return{geospatialOrigin:s,shaderCoordinateOrigin:r,offsetMode:a}}function Hk(i,e,t){const{viewMatrixUncentered:r,projectionMatrix:s}=i;let{viewMatrix:a,viewProjectionMatrix:u}=i,l=Xb,g=Xb,v=i.cameraPosition;const{geospatialOrigin:T,shaderCoordinateOrigin:S,offsetMode:P}=O2(i,e,t);return P&&(g=i.projectPosition(T||S),v=[v[0]-g[0],v[1]-g[1],v[2]-g[2]],g[3]=1,l=Pc([],g,u),a=r||a,u=$a([],s,a),u=$a([],u,jk)),{viewMatrix:a,viewProjectionMatrix:u,projectionCenter:l,originCommon:g,cameraPosCommon:v,shaderCoordinateOrigin:S,geospatialOrigin:T}}function qk({viewport:i,devicePixelRatio:e=1,modelMatrix:t=null,coordinateSystem:r=li.DEFAULT,coordinateOrigin:s=D2,autoWrapLongitude:a=!1}){r===li.DEFAULT&&(r=i.isGeospatial?li.LNGLAT:li.CARTESIAN);const u=Wk({viewport:i,devicePixelRatio:e,coordinateSystem:r,coordinateOrigin:s});return u.wrapLongitude=a,u.modelMatrix=t||k2,u}function Xk({viewport:i,devicePixelRatio:e,coordinateSystem:t,coordinateOrigin:r}){const{projectionCenter:s,viewProjectionMatrix:a,originCommon:u,cameraPosCommon:l,shaderCoordinateOrigin:g,geospatialOrigin:v}=Hk(i,t,r),T=i.getDistanceScales(),S=[i.width*e,i.height*e],P=Pc([],[0,0,-i.focalDistance,1],i.projectionMatrix)[3]||1,O={coordinateSystem:t,projectionMode:i.projectionMode,coordinateOrigin:g,commonOrigin:u.slice(0,3),center:s,pseudoMeters:!!i._pseudoMeters,viewportSize:S,devicePixelRatio:e,focalDistance:P,commonUnitsPerMeter:T.unitsPerMeter,commonUnitsPerWorldUnit:T.unitsPerMeter,commonUnitsPerWorldUnit2:$k,scale:i.scale,wrapLongitude:!1,viewProjectionMatrix:a,modelMatrix:k2,cameraPosition:l};if(v){const $=i.getDistanceScales(v);switch(t){case li.METER_OFFSETS:O.commonUnitsPerWorldUnit=$.unitsPerMeter,O.commonUnitsPerWorldUnit2=$.unitsPerMeter2;break;case li.LNGLAT:case li.LNGLAT_OFFSETS:i._pseudoMeters||(O.commonUnitsPerMeter=$.unitsPerMeter),O.commonUnitsPerWorldUnit=$.unitsPerDegree,O.commonUnitsPerWorldUnit2=$.unitsPerDegree2;break;case li.CARTESIAN:O.commonUnitsPerWorldUnit=[1,1,$.unitsPerMeter[2]],O.commonUnitsPerWorldUnit2=[0,0,$.unitsPerMeter2[2]];break}}return O}const Zk=Object.keys(li).map(i=>`const COORDINATE_SYSTEM_${i}: i32 = ${li[i]};`).join(""),Yk=Object.keys(Bs).map(i=>`const PROJECTION_MODE_${i}: i32 = ${Bs[i]};`).join(""),Gk=Object.keys(to).map(i=>`const UNIT_${i.toUpperCase()}: i32 = ${to[i]};`).join(""),Kk=`${Zk}
${Yk}
${Gk}

const TILE_SIZE: f32 = 512.0;
const PI: f32 = 3.1415926536;
const WORLD_SCALE: f32 = TILE_SIZE / (PI * 2.0);
const ZERO_64_LOW: vec3<f32> = vec3<f32>(0.0, 0.0, 0.0);
const EARTH_RADIUS: f32 = 6370972.0; // meters
const GLOBE_RADIUS: f32 = 256.0;

// -----------------------------------------------------------------------------
// Uniform block (converted from GLSL uniform block)
// -----------------------------------------------------------------------------
struct ProjectUniforms {
  wrapLongitude: i32,
  coordinateSystem: i32,
  commonUnitsPerMeter: vec3<f32>,
  projectionMode: i32,
  scale: f32,
  commonUnitsPerWorldUnit: vec3<f32>,
  commonUnitsPerWorldUnit2: vec3<f32>,
  center: vec4<f32>,
  modelMatrix: mat4x4<f32>,
  viewProjectionMatrix: mat4x4<f32>,
  viewportSize: vec2<f32>,
  devicePixelRatio: f32,
  focalDistance: f32,
  cameraPosition: vec3<f32>,
  coordinateOrigin: vec3<f32>,
  commonOrigin: vec3<f32>,
  pseudoMeters: i32,
};

@group(0) @binding(0)
var<uniform> project: ProjectUniforms;

// -----------------------------------------------------------------------------
// Geometry data
// (In your GLSL code, "geometry" was assumed to be available globally. In WGSL,
// you might supply this via vertex attributes or a uniform. Here we define a
// uniform struct for demonstration.)
// -----------------------------------------------------------------------------

// Structure to carry additional geometry data used by deck.gl filters.
struct Geometry {
  worldPosition: vec3<f32>,
  worldPositionAlt: vec3<f32>,
  position: vec4<f32>,
  normal: vec3<f32>,
  uv: vec2<f32>,
  pickingColor: vec3<f32>,
};

// @group(0) @binding(1)
var<private> geometry: Geometry;
`,Jk=`${Kk}

// -----------------------------------------------------------------------------
// Functions
// -----------------------------------------------------------------------------

// Returns an adjustment factor for commonUnitsPerMeter
fn _project_size_at_latitude(lat: f32) -> f32 {
  let y = clamp(lat, -89.9, 89.9);
  return 1.0 / cos(radians(y));
}

// Overloaded version: scales a value in meters at a given latitude.
fn _project_size_at_latitude_m(meters: f32, lat: f32) -> f32 {
  return meters * project.commonUnitsPerMeter.z * _project_size_at_latitude(lat);
}

// Computes a non-linear scale factor based on geometry.
// (Note: This function relies on "geometry" being provided.)
fn project_size() -> f32 {
  if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR &&
      project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT &&
      project.pseudoMeters == 0) {
    if (geometry.position.w == 0.0) {
      return _project_size_at_latitude(geometry.worldPosition.y);
    }
    let y: f32 = geometry.position.y / TILE_SIZE * 2.0 - 1.0;
    let y2 = y * y;
    let y4 = y2 * y2;
    let y6 = y4 * y2;
    return 1.0 + 4.9348 * y2 + 4.0587 * y4 + 1.5642 * y6;
  }
  return 1.0;
}

// Overloads to scale offsets (meters to world units)
fn project_size_float(meters: f32) -> f32 {
  return meters * project.commonUnitsPerMeter.z * project_size();
}

fn project_size_vec2(meters: vec2<f32>) -> vec2<f32> {
  return meters * project.commonUnitsPerMeter.xy * project_size();
}

fn project_size_vec3(meters: vec3<f32>) -> vec3<f32> {
  return meters * project.commonUnitsPerMeter * project_size();
}

fn project_size_vec4(meters: vec4<f32>) -> vec4<f32> {
  return vec4<f32>(meters.xyz * project.commonUnitsPerMeter, meters.w);
}

// Returns a rotation matrix aligning the zaxis with the given up vector.
fn project_get_orientation_matrix(up: vec3<f32>) -> mat3x3<f32> {
  let uz = normalize(up);
  let ux = select(
    vec3<f32>(1.0, 0.0, 0.0),
    normalize(vec3<f32>(uz.y, -uz.x, 0.0)),
    abs(uz.z) == 1.0
  );
  let uy = cross(uz, ux);
  return mat3x3<f32>(ux, uy, uz);
}

// Since WGSL does not support "out" parameters, we return a struct.
struct RotationResult {
  needsRotation: bool,
  transform: mat3x3<f32>,
};

fn project_needs_rotation(commonPosition: vec3<f32>) -> RotationResult {
  if (project.projectionMode == PROJECTION_MODE_GLOBE) {
    return RotationResult(true, project_get_orientation_matrix(commonPosition));
  } else {
    return RotationResult(false, mat3x3<f32>());  // identity alternative if needed
  };
}

// Projects a normal vector from the current coordinate system to world space.
fn project_normal(vector: vec3<f32>) -> vec3<f32> {
  let normal_modelspace = project.modelMatrix * vec4<f32>(vector, 0.0);
  var n = normalize(normal_modelspace.xyz * project.commonUnitsPerMeter);
  let rotResult = project_needs_rotation(geometry.position.xyz);
  if (rotResult.needsRotation) {
    n = rotResult.transform * n;
  }
  return n;
}

// Applies a scale offset based on y-offset (dy)
fn project_offset_(offset: vec4<f32>) -> vec4<f32> {
  let dy: f32 = offset.y;
  let commonUnitsPerWorldUnit = project.commonUnitsPerWorldUnit + project.commonUnitsPerWorldUnit2 * dy;
  return vec4<f32>(offset.xyz * commonUnitsPerWorldUnit, offset.w);
}

// Projects lng/lat coordinates to a unit tile [0,1]
fn project_mercator_(lnglat: vec2<f32>) -> vec2<f32> {
  var x = lnglat.x;
  if (project.wrapLongitude != 0) {
    x = ((x + 180.0) % 360.0) - 180.0;
  }
  let y = clamp(lnglat.y, -89.9, 89.9);
  return vec2<f32>(
    radians(x) + PI,
    PI + log(tan(PI * 0.25 + radians(y) * 0.5))
  ) * WORLD_SCALE;
}

// Projects lng/lat/z coordinates for a globe projection.
fn project_globe_(lnglatz: vec3<f32>) -> vec3<f32> {
  let lambda = radians(lnglatz.x);
  let phi = radians(lnglatz.y);
  let cosPhi = cos(phi);
  let D = (lnglatz.z / EARTH_RADIUS + 1.0) * GLOBE_RADIUS;
  return vec3<f32>(
    sin(lambda) * cosPhi,
    -cos(lambda) * cosPhi,
    sin(phi)
  ) * D;
}

// Projects positions (with an optional 64-bit low part) from the input
// coordinate system to the common space.
fn project_position_vec4_f64(position: vec4<f32>, position64Low: vec3<f32>) -> vec4<f32> {
  var position_world = project.modelMatrix * position;

  // Work around for a Mac+NVIDIA bug:
  if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR) {
    if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      return vec4<f32>(
        project_mercator_(position_world.xy),
        _project_size_at_latitude_m(position_world.z, position_world.y),
        position_world.w
      );
    }
    if (project.coordinateSystem == COORDINATE_SYSTEM_CARTESIAN) {
      position_world = vec4f(position_world.xyz + project.coordinateOrigin, position_world.w);
    }
  }
  if (project.projectionMode == PROJECTION_MODE_GLOBE) {
    if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      return vec4<f32>(
        project_globe_(position_world.xyz),
        position_world.w
      );
    }
  }
  if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET) {
    if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      if (abs(position_world.y - project.coordinateOrigin.y) > 0.25) {
        return vec4<f32>(
          project_mercator_(position_world.xy) - project.commonOrigin.xy,
          project_size_float(position_world.z),
          position_world.w
        );
      }
    }
  }
  if (project.projectionMode == PROJECTION_MODE_IDENTITY ||
      (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET &&
       (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT ||
        project.coordinateSystem == COORDINATE_SYSTEM_CARTESIAN))) {
    position_world = vec4f(position_world.xyz - project.coordinateOrigin, position_world.w);
  }

  return project_offset_(position_world) +
         project_offset_(project.modelMatrix * vec4<f32>(position64Low, 0.0));
}

// Overloaded versions for different input types.
fn project_position_vec4_f32(position: vec4<f32>) -> vec4<f32> {
  return project_position_vec4_f64(position, ZERO_64_LOW);
}

fn project_position_vec3_f64(position: vec3<f32>, position64Low: vec3<f32>) -> vec3<f32> {
  let projected_position = project_position_vec4_f64(vec4<f32>(position, 1.0), position64Low);
  return projected_position.xyz;
}

fn project_position_vec3_f32(position: vec3<f32>) -> vec3<f32> {
  let projected_position = project_position_vec4_f64(vec4<f32>(position, 1.0), ZERO_64_LOW);
  return projected_position.xyz;
}

fn project_position_vec2_f32(position: vec2<f32>) -> vec2<f32> {
  let projected_position = project_position_vec4_f64(vec4<f32>(position, 0.0, 1.0), ZERO_64_LOW);
  return projected_position.xy;
}

// Transforms a common space position to clip space.
fn project_common_position_to_clipspace_with_projection(position: vec4<f32>, viewProjectionMatrix: mat4x4<f32>, center: vec4<f32>) -> vec4<f32> {
  return viewProjectionMatrix * position + center;
}

// Uses the project viewProjectionMatrix and center.
fn project_common_position_to_clipspace(position: vec4<f32>) -> vec4<f32> {
  return project_common_position_to_clipspace_with_projection(position, project.viewProjectionMatrix, project.center);
}

// Returns a clip space offset corresponding to a given number of screen pixels.
fn project_pixel_size_to_clipspace(pixels: vec2<f32>) -> vec2<f32> {
  let offset = pixels / project.viewportSize * project.devicePixelRatio * 2.0;
  return offset * project.focalDistance;
}

fn project_meter_size_to_pixel(meters: f32) -> f32 {
  return project_size_float(meters) * project.scale;
}

fn project_unit_size_to_pixel(size: f32, unit: i32) -> f32 {
  if (unit == UNIT_METERS) {
    return project_meter_size_to_pixel(size);
  } else if (unit == UNIT_COMMON) {
    return size * project.scale;
  }
  // UNIT_PIXELS: no scaling applied.
  return size;
}

fn project_pixel_size_float(pixels: f32) -> f32 {
  return pixels / project.scale;
}

fn project_pixel_size_vec2(pixels: vec2<f32>) -> vec2<f32> {
  return pixels / project.scale;
}
`,Qk=Object.keys(li).map(i=>`const int COORDINATE_SYSTEM_${i} = ${li[i]};`).join(""),eD=Object.keys(Bs).map(i=>`const int PROJECTION_MODE_${i} = ${Bs[i]};`).join(""),tD=Object.keys(to).map(i=>`const int UNIT_${i.toUpperCase()} = ${to[i]};`).join(""),iD=`${Qk}
${eD}
${tD}
uniform projectUniforms {
bool wrapLongitude;
int coordinateSystem;
vec3 commonUnitsPerMeter;
int projectionMode;
float scale;
vec3 commonUnitsPerWorldUnit;
vec3 commonUnitsPerWorldUnit2;
vec4 center;
mat4 modelMatrix;
mat4 viewProjectionMatrix;
vec2 viewportSize;
float devicePixelRatio;
float focalDistance;
vec3 cameraPosition;
vec3 coordinateOrigin;
vec3 commonOrigin;
bool pseudoMeters;
} project;
const float TILE_SIZE = 512.0;
const float PI = 3.1415926536;
const float WORLD_SCALE = TILE_SIZE / (PI * 2.0);
const vec3 ZERO_64_LOW = vec3(0.0);
const float EARTH_RADIUS = 6370972.0;
const float GLOBE_RADIUS = 256.0;
float project_size_at_latitude(float lat) {
float y = clamp(lat, -89.9, 89.9);
return 1.0 / cos(radians(y));
}
float project_size() {
if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR &&
project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT &&
project.pseudoMeters == false) {
if (geometry.position.w == 0.0) {
return project_size_at_latitude(geometry.worldPosition.y);
}
float y = geometry.position.y / TILE_SIZE * 2.0 - 1.0;
float y2 = y * y;
float y4 = y2 * y2;
float y6 = y4 * y2;
return 1.0 + 4.9348 * y2 + 4.0587 * y4 + 1.5642 * y6;
}
return 1.0;
}
float project_size_at_latitude(float meters, float lat) {
return meters * project.commonUnitsPerMeter.z * project_size_at_latitude(lat);
}
float project_size(float meters) {
return meters * project.commonUnitsPerMeter.z * project_size();
}
vec2 project_size(vec2 meters) {
return meters * project.commonUnitsPerMeter.xy * project_size();
}
vec3 project_size(vec3 meters) {
return meters * project.commonUnitsPerMeter * project_size();
}
vec4 project_size(vec4 meters) {
return vec4(meters.xyz * project.commonUnitsPerMeter, meters.w);
}
mat3 project_get_orientation_matrix(vec3 up) {
vec3 uz = normalize(up);
vec3 ux = abs(uz.z) == 1.0 ? vec3(1.0, 0.0, 0.0) : normalize(vec3(uz.y, -uz.x, 0));
vec3 uy = cross(uz, ux);
return mat3(ux, uy, uz);
}
bool project_needs_rotation(vec3 commonPosition, out mat3 transform) {
if (project.projectionMode == PROJECTION_MODE_GLOBE) {
transform = project_get_orientation_matrix(commonPosition);
return true;
}
return false;
}
vec3 project_normal(vec3 vector) {
vec4 normal_modelspace = project.modelMatrix * vec4(vector, 0.0);
vec3 n = normalize(normal_modelspace.xyz * project.commonUnitsPerMeter);
mat3 rotation;
if (project_needs_rotation(geometry.position.xyz, rotation)) {
n = rotation * n;
}
return n;
}
vec4 project_offset_(vec4 offset) {
float dy = offset.y;
vec3 commonUnitsPerWorldUnit = project.commonUnitsPerWorldUnit + project.commonUnitsPerWorldUnit2 * dy;
return vec4(offset.xyz * commonUnitsPerWorldUnit, offset.w);
}
vec2 project_mercator_(vec2 lnglat) {
float x = lnglat.x;
if (project.wrapLongitude) {
x = mod(x + 180., 360.0) - 180.;
}
float y = clamp(lnglat.y, -89.9, 89.9);
return vec2(
radians(x) + PI,
PI + log(tan_fp32(PI * 0.25 + radians(y) * 0.5))
) * WORLD_SCALE;
}
vec3 project_globe_(vec3 lnglatz) {
float lambda = radians(lnglatz.x);
float phi = radians(lnglatz.y);
float cosPhi = cos(phi);
float D = (lnglatz.z / EARTH_RADIUS + 1.0) * GLOBE_RADIUS;
return vec3(
sin(lambda) * cosPhi,
-cos(lambda) * cosPhi,
sin(phi)
) * D;
}
vec4 project_position(vec4 position, vec3 position64Low) {
vec4 position_world = project.modelMatrix * position;
if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR) {
if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
return vec4(
project_mercator_(position_world.xy),
project_size_at_latitude(position_world.z, position_world.y),
position_world.w
);
}
if (project.coordinateSystem == COORDINATE_SYSTEM_CARTESIAN) {
position_world.xyz += project.coordinateOrigin;
}
}
if (project.projectionMode == PROJECTION_MODE_GLOBE) {
if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
return vec4(
project_globe_(position_world.xyz),
position_world.w
);
}
}
if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET) {
if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
if (abs(position_world.y - project.coordinateOrigin.y) > 0.25) {
return vec4(
project_mercator_(position_world.xy) - project.commonOrigin.xy,
project_size(position_world.z),
position_world.w
);
}
}
}
if (project.projectionMode == PROJECTION_MODE_IDENTITY ||
(project.projectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET &&
(project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT ||
project.coordinateSystem == COORDINATE_SYSTEM_CARTESIAN))) {
position_world.xyz -= project.coordinateOrigin;
}
return project_offset_(position_world) + project_offset_(project.modelMatrix * vec4(position64Low, 0.0));
}
vec4 project_position(vec4 position) {
return project_position(position, ZERO_64_LOW);
}
vec3 project_position(vec3 position, vec3 position64Low) {
vec4 projected_position = project_position(vec4(position, 1.0), position64Low);
return projected_position.xyz;
}
vec3 project_position(vec3 position) {
vec4 projected_position = project_position(vec4(position, 1.0), ZERO_64_LOW);
return projected_position.xyz;
}
vec2 project_position(vec2 position) {
vec4 projected_position = project_position(vec4(position, 0.0, 1.0), ZERO_64_LOW);
return projected_position.xy;
}
vec4 project_common_position_to_clipspace(vec4 position, mat4 viewProjectionMatrix, vec4 center) {
return viewProjectionMatrix * position + center;
}
vec4 project_common_position_to_clipspace(vec4 position) {
return project_common_position_to_clipspace(position, project.viewProjectionMatrix, project.center);
}
vec2 project_pixel_size_to_clipspace(vec2 pixels) {
vec2 offset = pixels / project.viewportSize * project.devicePixelRatio * 2.0;
return offset * project.focalDistance;
}
float project_size_to_pixel(float meters) {
return project_size(meters) * project.scale;
}
float project_size_to_pixel(float size, int unit) {
if (unit == UNIT_METERS) return project_size_to_pixel(size);
if (unit == UNIT_COMMON) return size * project.scale;
return size;
}
float project_pixel_size(float pixels) {
return pixels / project.scale;
}
vec2 project_pixel_size(vec2 pixels) {
return pixels / project.scale;
}
`,rD={};function sD(i=rD){return"viewport"in i?qk(i):{}}const fy={name:"project",dependencies:[SR,A2],source:Jk,vs:iD,getUniforms:sD,uniformTypes:{wrapLongitude:"f32",coordinateSystem:"i32",commonUnitsPerMeter:"vec3<f32>",projectionMode:"i32",scale:"f32",commonUnitsPerWorldUnit:"vec3<f32>",commonUnitsPerWorldUnit2:"vec3<f32>",center:"vec4<f32>",modelMatrix:"mat4x4<f32>",viewProjectionMatrix:"mat4x4<f32>",viewportSize:"vec2<f32>",devicePixelRatio:"f32",focalDistance:"f32",cameraPosition:"vec3<f32>",coordinateOrigin:"vec3<f32>",commonOrigin:"vec3<f32>",pseudoMeters:"f32"}},nD=`// Define a structure to hold both the clip-space position and the common position.
struct ProjectResult {
  clipPosition: vec4<f32>,
  commonPosition: vec4<f32>,
};

// This function mimics the GLSL version with the 'out' parameter by returning both values.
fn project_position_to_clipspace_and_commonspace(
    position: vec3<f32>,
    position64Low: vec3<f32>,
    offset: vec3<f32>
) -> ProjectResult {
  // Compute the projected position.
  let projectedPosition: vec3<f32> = project_position_vec3_f64(position, position64Low);

  // Start with the provided offset.
  var finalOffset: vec3<f32> = offset;

  // Get whether a rotation is needed and the rotation matrix.
  let rotationResult = project_needs_rotation(projectedPosition);

  // If rotation is needed, update the offset.
  if (rotationResult.needsRotation) {
    finalOffset = rotationResult.transform * offset;
  }

  // Compute the common position.
  let commonPosition: vec4<f32> = vec4<f32>(projectedPosition + finalOffset, 1.0);

  // Convert to clip-space.
  let clipPosition: vec4<f32> = project_common_position_to_clipspace(commonPosition);

  return ProjectResult(clipPosition, commonPosition);
}

// A convenience overload that returns only the clip-space position.
fn project_position_to_clipspace(
    position: vec3<f32>,
    position64Low: vec3<f32>,
    offset: vec3<f32>
) -> vec4<f32> {
  return project_position_to_clipspace_and_commonspace(position, position64Low, offset).clipPosition;
}
`,oD=`vec4 project_position_to_clipspace(
  vec3 position, vec3 position64Low, vec3 offset, out vec4 commonPosition
) {
  vec3 projectedPosition = project_position(position, position64Low);
  mat3 rotation;
  if (project_needs_rotation(projectedPosition, rotation)) {
    // offset is specified as ENU
    // when in globe projection, rotate offset so that the ground alighs with the surface of the globe
    offset = rotation * offset;
  }
  commonPosition = vec4(projectedPosition + offset, 1.0);
  return project_common_position_to_clipspace(commonPosition);
}

vec4 project_position_to_clipspace(
  vec3 position, vec3 position64Low, vec3 offset
) {
  vec4 commonPosition;
  return project_position_to_clipspace(position, position64Low, offset, commonPosition);
}
`,Mc={name:"project32",dependencies:[fy],source:nD,vs:oD};function aD(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function _c(i,e){const t=Pc([],e,i);return dy(t,t,1/t[3]),t}function Zb(i,e){const t=i%e;return t<0?e+t:t}function o_(i,e,t){return i<e?e:i>t?t:i}function lD(i){return Math.log(i)*Math.LOG2E}const py=Math.log2||lD;function io(i,e){if(!i)throw new Error(e||"@math.gl/web-mercator: assertion failed.")}const ln=Math.PI,L2=ln/4,Gs=ln/180,a_=180/ln,bc=512,ap=4003e4,ac=85.051129,cD=1.5;function uD(i){return py(i)}function ia(i){const[e,t]=i;io(Number.isFinite(e)),io(Number.isFinite(t)&&t>=-90&&t<=90,"invalid latitude");const r=e*Gs,s=t*Gs,a=bc*(r+ln)/(2*ln),u=bc*(ln+Math.log(Math.tan(L2+s*.5)))/(2*ln);return[a,u]}function wc(i){const[e,t]=i,r=e/bc*(2*ln)-ln,s=2*(Math.atan(Math.exp(t/bc*(2*ln)-ln))-L2);return[r*a_,s*a_]}function hD(i){const{latitude:e}=i;io(Number.isFinite(e));const t=Math.cos(e*Gs);return uD(ap*t)-9}function fm(i){const e=Math.cos(i*Gs);return bc/ap/e}function l_(i){const{latitude:e,longitude:t,highPrecision:r=!1}=i;io(Number.isFinite(e)&&Number.isFinite(t));const s=bc,a=Math.cos(e*Gs),u=s/360,l=u/a,g=s/ap/a,v={unitsPerMeter:[g,g,g],metersPerUnit:[1/g,1/g,1/g],unitsPerDegree:[u,l,g],degreesPerUnit:[1/u,1/l,1/g]};if(r){const T=Gs*Math.tan(e*Gs)/a,S=u*T/2,P=s/ap*T,O=P/l*g;v.unitsPerDegree2=[0,S,P],v.unitsPerMeter2=[O,0,O]}return v}function F2(i,e){const[t,r,s]=i,[a,u,l]=e,{unitsPerMeter:g,unitsPerMeter2:v}=l_({longitude:t,latitude:r,highPrecision:!0}),T=ia(i);T[0]+=a*(g[0]+v[0]*u),T[1]+=u*(g[1]+v[1]*u);const S=wc(T),P=(s||0)+(l||0);return Number.isFinite(s)||Number.isFinite(l)?[S[0],S[1],P]:S}function dD(i){const{height:e,pitch:t,bearing:r,altitude:s,scale:a,center:u}=i,l=aD();np(l,l,[0,0,-s]),_2(l,l,-t*Gs),y2(l,l,r*Gs);const g=a/e;return hy(l,l,[g,g,g]),u&&np(l,l,pM([],u)),l}function fD(i){const{width:e,height:t,altitude:r,pitch:s=0,offset:a,center:u,scale:l,nearZMultiplier:g=1,farZMultiplier:v=1}=i;let{fovy:T=kh(cD)}=i;r!==void 0&&(T=kh(r));const S=T*Gs,P=s*Gs,O=gy(T);let $=O;u&&($+=u[2]*l/Math.cos(P)/t);const W=S*(.5+(a?a[1]:0)/t),G=Math.sin(W)*$/Math.sin(o_(Math.PI/2-P-W,.01,Math.PI-.01)),Q=Math.sin(P)*G+$,ae=$*10,te=Math.min(Q*v,ae);return{fov:S,aspect:e/t,focalDistance:O,near:g,far:te}}function kh(i){return 2*Math.atan(.5/i)*a_}function gy(i){return .5/Math.tan(.5*i*Gs)}function B2(i,e){const[t,r,s=0]=i;return io(Number.isFinite(t)&&Number.isFinite(r)&&Number.isFinite(s)),_c(e,[t,r,s,1])}function my(i,e,t=0){const[r,s,a]=i;if(io(Number.isFinite(r)&&Number.isFinite(s),"invalid pixel coordinate"),Number.isFinite(a))return _c(e,[r,s,a,1]);const u=_c(e,[r,s,0,1]),l=_c(e,[r,s,1,1]),g=u[2],v=l[2],T=g===v?0:((t||0)-g)/(v-g);return a2([],u,l,T)}function pD(i){const{width:e,height:t,bounds:r,minExtent:s=0,maxZoom:a=24,offset:u=[0,0]}=i,[[l,g],[v,T]]=r,S=gD(i.padding),P=ia([l,o_(T,-ac,ac)]),O=ia([v,o_(g,-ac,ac)]),$=[Math.max(Math.abs(O[0]-P[0]),s),Math.max(Math.abs(O[1]-P[1]),s)],W=[e-S.left-S.right-Math.abs(u[0])*2,t-S.top-S.bottom-Math.abs(u[1])*2];io(W[0]>0&&W[1]>0);const G=W[0]/$[0],Q=W[1]/$[1],ae=(S.right-S.left)/2/G,te=(S.top-S.bottom)/2/Q,me=[(O[0]+P[0])/2+ae,(O[1]+P[1])/2+te],we=wc(me),Oe=Math.min(a,py(Math.abs(Math.min(G,Q))));return io(Number.isFinite(Oe)),{longitude:we[0],latitude:we[1],zoom:Oe}}function gD(i=0){return typeof i=="number"?{top:i,bottom:i,left:i,right:i}:(io(Number.isFinite(i.top)&&Number.isFinite(i.bottom)&&Number.isFinite(i.left)&&Number.isFinite(i.right)),i)}const Yb=Math.PI/180;function mD(i,e=0){const{width:t,height:r,unproject:s}=i,a={targetZ:e},u=s([0,r],a),l=s([t,r],a);let g,v;const T=i.fovy?.5*i.fovy*Yb:Math.atan(.5/i.altitude),S=(90-i.pitch)*Yb;return T>S-.01?(g=Gb(i,0,e),v=Gb(i,t,e)):(g=s([0,0],a),v=s([t,0],a)),[u,l,v,g]}function Gb(i,e,t){const{pixelUnprojectionMatrix:r}=i,s=_c(r,[e,0,1,1]),a=_c(r,[e,i.height,1,1]),l=(t*i.distanceScales.unitsPerMeter[2]-s[2])/(a[2]-s[2]),g=a2([],s,a,l),v=wc(g);return v.push(t),v}const Kb=512;function _D(i){const{width:e,height:t,pitch:r=0}=i;let{longitude:s,latitude:a,zoom:u,bearing:l=0}=i;(s<-180||s>180)&&(s=Zb(s+180,360)-180),(l<-180||l>180)&&(l=Zb(l+180,360)-180);const g=py(t/Kb);if(u<=g)u=g,a=0;else{const v=t/2/Math.pow(2,u),T=wc([0,v])[1];if(a<T)a=T;else{const S=wc([0,Kb-v])[1];a>S&&(a=S)}}return{width:e,height:t,longitude:s,latitude:a,zoom:u,pitch:r,bearing:l}}const N2=`
uniform shadowUniforms {
  bool drawShadowMap;
  bool useShadowMap;
  vec4 color;
  highp int lightId;
  float lightCount;
  mat4 viewProjectionMatrix0;
  mat4 viewProjectionMatrix1;
  vec4 projectCenter0;
  vec4 projectCenter1;
} shadow;
`,yD=`
const int max_lights = 2;

out vec3 shadow_vPosition[max_lights];

vec4 shadow_setVertexPosition(vec4 position_commonspace) {
  mat4 viewProjectionMatrices[max_lights];
  viewProjectionMatrices[0] = shadow.viewProjectionMatrix0;
  viewProjectionMatrices[1] = shadow.viewProjectionMatrix1;
  vec4 projectCenters[max_lights];
  projectCenters[0] = shadow.projectCenter0;
  projectCenters[1] = shadow.projectCenter1;

  if (shadow.drawShadowMap) {
    return project_common_position_to_clipspace(position_commonspace, viewProjectionMatrices[shadow.lightId], projectCenters[shadow.lightId]);
  }
  if (shadow.useShadowMap) {
    for (int i = 0; i < max_lights; i++) {
      if(i < int(shadow.lightCount)) {
        vec4 shadowMap_position = project_common_position_to_clipspace(position_commonspace, viewProjectionMatrices[i], projectCenters[i]);
        shadow_vPosition[i] = (shadowMap_position.xyz / shadowMap_position.w + 1.0) / 2.0;
      }
    }
  }
  return gl_Position;
}
`,xD=`
${N2}
${yD}
`,vD=`
const int max_lights = 2;
uniform sampler2D shadow_uShadowMap0;
uniform sampler2D shadow_uShadowMap1;

in vec3 shadow_vPosition[max_lights];

const vec4 bitPackShift = vec4(1.0, 255.0, 65025.0, 16581375.0);
const vec4 bitUnpackShift = 1.0 / bitPackShift;
const vec4 bitMask = vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0,  0.0);

float shadow_getShadowWeight(vec3 position, sampler2D shadowMap) {
  vec4 rgbaDepth = texture(shadowMap, position.xy);

  float z = dot(rgbaDepth, bitUnpackShift);
  return smoothstep(0.001, 0.01, position.z - z);
}

vec4 shadow_filterShadowColor(vec4 color) {
  if (shadow.drawShadowMap) {
    vec4 rgbaDepth = fract(gl_FragCoord.z * bitPackShift);
    rgbaDepth -= rgbaDepth.gbaa * bitMask;
    return rgbaDepth;
  }
  if (shadow.useShadowMap) {
    float shadowAlpha = 0.0;
    shadowAlpha += shadow_getShadowWeight(shadow_vPosition[0], shadow_uShadowMap0);
    if(shadow.lightCount > 1.0) {
      shadowAlpha += shadow_getShadowWeight(shadow_vPosition[1], shadow_uShadowMap1);
    }
    shadowAlpha *= shadow.color.a / shadow.lightCount;
    float blendedAlpha = shadowAlpha + color.a * (1.0 - shadowAlpha);

    return vec4(
      mix(color.rgb, shadow.color.rgb, shadowAlpha / blendedAlpha),
      blendedAlpha
    );
  }
  return color;
}
`,bD=`
${N2}
${vD}
`,wD=jh(ID),TD=jh(CD),SD=[0,0,0,1],AD=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0];function ED(i,e){const[t,r,s]=i,a=my([t,r,s],e);return Number.isFinite(s)?a:[a[0],a[1],0]}function ID({viewport:i,center:e}){return new Mr(i.viewProjectionMatrix).invert().transform(e)}function CD({viewport:i,shadowMatrices:e}){const t=[],r=i.pixelUnprojectionMatrix,s=i.isGeospatial?void 0:1,a=[[0,0,s],[i.width,0,s],[0,i.height,s],[i.width,i.height,s],[0,0,-1],[i.width,0,-1],[0,i.height,-1],[i.width,i.height,-1]].map(u=>ED(u,r));for(const u of e){const l=u.clone().translate(new Mt(i.center).negate()),g=a.map(T=>l.transform(T)),v=new Mr().ortho({left:Math.min(...g.map(T=>T[0])),right:Math.max(...g.map(T=>T[0])),bottom:Math.min(...g.map(T=>T[1])),top:Math.max(...g.map(T=>T[1])),near:Math.min(...g.map(T=>-T[2])),far:Math.max(...g.map(T=>-T[2]))});t.push(v.multiplyRight(u))}return t}function PD(i){const{shadowEnabled:e=!0,project:t}=i;if(!e||!t||!i.shadowMatrices||!i.shadowMatrices.length)return{drawShadowMap:!1,useShadowMap:!1,shadow_uShadowMap0:i.dummyShadowMap,shadow_uShadowMap1:i.dummyShadowMap};const r=fy.getUniforms(t),s=wD({viewport:t.viewport,center:r.center}),a=[],u=TD({shadowMatrices:i.shadowMatrices,viewport:t.viewport}).slice();for(let g=0;g<i.shadowMatrices.length;g++){const v=u[g],T=v.clone().translate(new Mt(t.viewport.center).negate());r.coordinateSystem===li.LNGLAT&&r.projectionMode===Bs.WEB_MERCATOR?(u[g]=T,a[g]=s):(u[g]=v.clone().multiplyRight(AD),a[g]=T.transform(s))}const l={drawShadowMap:!!i.drawToShadowMap,useShadowMap:i.shadowMaps?i.shadowMaps.length>0:!1,color:i.shadowColor||SD,lightId:i.shadowLightId||0,lightCount:i.shadowMatrices.length,shadow_uShadowMap0:i.dummyShadowMap,shadow_uShadowMap1:i.dummyShadowMap};for(let g=0;g<u.length;g++)l[`viewProjectionMatrix${g}`]=u[g],l[`projectCenter${g}`]=a[g];for(let g=0;g<2;g++)l[`shadow_uShadowMap${g}`]=i.shadowMaps&&i.shadowMaps[g]||i.dummyShadowMap;return l}const Jb={name:"shadow",dependencies:[fy],vs:xD,fs:bD,inject:{"vs:DECKGL_FILTER_GL_POSITION":`
    position = shadow_setVertexPosition(geometry.position);
    `,"fs:DECKGL_FILTER_COLOR":`
    color = shadow_filterShadowColor(color);
    `},getUniforms:PD,uniformTypes:{drawShadowMap:"f32",useShadowMap:"f32",color:"vec4<f32>",lightId:"i32",lightCount:"f32",viewProjectionMatrix0:"mat4x4<f32>",viewProjectionMatrix1:"mat4x4<f32>",projectCenter0:"vec4<f32>",projectCenter1:"vec4<f32>"}},Rc={...Pb,defaultUniforms:{...Pb.defaultUniforms,useFloatColors:!1},inject:{"vs:DECKGL_FILTER_GL_POSITION":`
    // for picking depth values
    picking_setPickingAttribute(position.z / position.w);
  `,"vs:DECKGL_FILTER_COLOR":`
  picking_setPickingColor(geometry.pickingColor);
  `,"fs:DECKGL_FILTER_COLOR":{order:99,injection:`
  // use highlight color if this fragment belongs to the selected object.
  color = picking_filterHighlightColor(color);

  // use picking color if rendering to picking FBO.
  color = picking_filterPickingColor(color);
    `}}},MD=[A2],RD=["vs:DECKGL_FILTER_SIZE(inout vec3 size, VertexGeometry geometry)","vs:DECKGL_FILTER_GL_POSITION(inout vec4 position, VertexGeometry geometry)","vs:DECKGL_FILTER_COLOR(inout vec4 color, VertexGeometry geometry)","fs:DECKGL_FILTER_COLOR(inout vec4 color, FragmentGeometry geometry)"],kD=[];function DD(i){const e=Fa.getDefaultShaderAssembler();for(const r of MD)e.addDefaultModule(r);e._hookFunctions.length=0;const t=i==="glsl"?RD:kD;for(const r of t)e.addShaderHook(r);return e}const OD=[255,255,255],LD=1;let FD=0;class BD{constructor(e={}){this.type="ambient";const{color:t=OD}=e,{intensity:r=LD}=e;this.id=e.id||`ambient-${FD++}`,this.color=t,this.intensity=r}}const ND=[255,255,255],zD=1,UD=[0,0,-1];let VD=0;class Qb{constructor(e={}){this.type="directional";const{color:t=ND}=e,{intensity:r=zD}=e,{direction:s=UD}=e,{_shadow:a=!1}=e;this.id=e.id||`directional-${VD++}`,this.color=t,this.intensity=r,this.type="directional",this.direction=new Mt(s).normalize().toArray(),this.shadow=a}getProjectedLight(e){return this}}class jD{constructor(e,t={id:"pass"}){const{id:r}=t;this.id=r,this.device=e,this.props={...t}}setProps(e){Object.assign(this.props,e)}render(e){}cleanup(){}}class _y extends jD{constructor(){super(...arguments),this._lastRenderIndex=-1}render(e){const[t,r]=this.device.canvasContext.getDrawingBufferSize(),s=e.clearCanvas??!0,a=e.clearColor??(s?[0,0,0,0]:!1),u=s?1:!1,l=s?0:!1,g=e.colorMask??15,v={viewport:[0,0,t,r]};e.colorMask&&(v.colorMask=g),e.scissorRect&&(v.scissorRect=e.scissorRect);const T=this.device.beginRenderPass({framebuffer:e.target,parameters:v,clearColor:a,clearDepth:u,clearStencil:l});try{return this._drawLayers(T,e)}finally{T.end(),this.device.submit()}}_drawLayers(e,t){const{target:r,shaderModuleProps:s,viewports:a,views:u,onViewportActive:l,clearStack:g=!0}=t;t.pass=t.pass||"unknown",g&&(this._lastRenderIndex=-1);const v=[];for(const T of a){const S=u&&u[T.id];l?.(T);const P=this._getDrawLayerParams(T,t),O=T.subViewports||[T];for(const $ of O){const W=this._drawLayersInViewport(e,{target:r,shaderModuleProps:s,viewport:$,view:S,pass:t.pass,layers:t.layers},P);v.push(W)}}return v}_getDrawLayerParams(e,{layers:t,pass:r,isPicking:s=!1,layerFilter:a,cullRect:u,effects:l,shaderModuleProps:g},v=!1){const T=[],S=z2(this._lastRenderIndex+1),P={layer:t[0],viewport:e,isPicking:s,renderPass:r,cullRect:u},O={};for(let $=0;$<t.length;$++){const W=t[$],G=this._shouldDrawLayer(W,P,a,O),Q={shouldDrawLayer:G};G&&!v&&(Q.shouldDrawLayer=!0,Q.layerRenderIndex=S(W,G),Q.shaderModuleProps=this._getShaderModuleProps(W,l,r,g),Q.layerParameters={...W.context.deck?.props.parameters,...this.getLayerParameters(W,$,e)}),T[$]=Q}return T}_drawLayersInViewport(e,{layers:t,shaderModuleProps:r,pass:s,target:a,viewport:u,view:l},g){const v=$D(this.device,{shaderModuleProps:r,target:a,viewport:u});if(l){const{clear:S,clearColor:P,clearDepth:O,clearStencil:$}=l.props;if(S){let W=[0,0,0,0],G=1,Q=0;Array.isArray(P)?W=[...P.slice(0,3),P[3]||255].map(te=>te/255):P===!1&&(W=!1),O!==void 0&&(G=O),$!==void 0&&(Q=$),this.device.beginRenderPass({framebuffer:a,parameters:{viewport:v,scissorRect:v},clearColor:W,clearDepth:G,clearStencil:Q}).end()}}const T={totalCount:t.length,visibleCount:0,compositeCount:0,pickableCount:0};e.setParameters({viewport:v});for(let S=0;S<t.length;S++){const P=t[S],O=g[S],{shouldDrawLayer:$}=O;if($&&P.props.pickable&&T.pickableCount++,P.isComposite&&T.compositeCount++,P.isDrawable&&O.shouldDrawLayer){const{layerRenderIndex:W,shaderModuleProps:G,layerParameters:Q}=O;T.visibleCount++,this._lastRenderIndex=Math.max(this._lastRenderIndex,W),G.project&&(G.project.viewport=u),P.context.renderPass=e;try{P._drawLayer({renderPass:e,shaderModuleProps:G,uniforms:{layerIndex:W},parameters:Q})}catch(ae){P.raiseError(ae,`drawing ${P} to ${s}`)}}}return T}shouldDrawLayer(e){return!0}getShaderModuleProps(e,t,r){return null}getLayerParameters(e,t,r){return e.props.parameters}_shouldDrawLayer(e,t,r,s){if(!(e.props.visible&&this.shouldDrawLayer(e)))return!1;t.layer=e;let u=e.parent;for(;u;){if(!u.props.visible||!u.filterSubLayer(t))return!1;t.layer=u,u=u.parent}if(r){const l=t.layer.id;if(l in s||(s[l]=r(t)),!s[l])return!1}return e.activateViewport(t.viewport),!0}_getShaderModuleProps(e,t,r,s){const a=this.device.canvasContext.cssToDeviceRatio(),u=e.internalState?.propsInTransition||e.props,l={layer:u,picking:{isActive:!1},project:{viewport:e.context.viewport,devicePixelRatio:a,modelMatrix:u.modelMatrix,coordinateSystem:u.coordinateSystem,coordinateOrigin:u.coordinateOrigin,autoWrapLongitude:e.wrapLongitude}};if(t)for(const g of t)e0(l,g.getShaderModuleProps?.(e,l));return e0(l,this.getShaderModuleProps(e,t,l),s)}}function z2(i=0,e={}){const t={},r=(s,a)=>{const u=s.props._offset,l=s.id,g=s.parent&&s.parent.id;let v;if(g&&!(g in e)&&r(s.parent,!1),g in t){const T=t[g]=t[g]||z2(e[g],e);v=T(s,a),t[l]=T}else Number.isFinite(u)?(v=u+(e[g]||0),t[l]=null):v=i;return a&&v>=i&&(i=v+1),e[l]=v,v};return r}function $D(i,{shaderModuleProps:e,target:t,viewport:r}){const s=e?.project?.devicePixelRatio??i.canvasContext.cssToDeviceRatio(),[,a]=i.canvasContext.getDrawingBufferSize(),u=t?t.height:a,l=r;return[l.x*s,u-(l.y+l.height)*s,l.width*s,l.height*s]}function e0(i,...e){for(const t of e)if(t)for(const r in t)i[r]?Object.assign(i[r],t[r]):i[r]=t[r];return i}class WD extends _y{constructor(e,t){super(e,t);const r=e.createTexture({format:"rgba8unorm",width:1,height:1,sampler:{minFilter:"linear",magFilter:"linear",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge"}}),s=e.createTexture({format:"depth16unorm",width:1,height:1});this.fbo=e.createFramebuffer({id:"shadowmap",width:1,height:1,colorAttachments:[r],depthStencilAttachment:s})}delete(){this.fbo&&(this.fbo.destroy(),this.fbo=null)}getShadowMap(){return this.fbo.colorAttachments[0].texture}render(e){const t=this.fbo,r=this.device.canvasContext.cssToDeviceRatio(),s=e.viewports[0],a=s.width*r,u=s.height*r,l=[1,1,1,1];(a!==t.width||u!==t.height)&&t.resize({width:a,height:u}),super.render({...e,clearColor:l,target:t,pass:"shadow"})}getLayerParameters(e,t,r){return{...e.props.parameters,blend:!1,depthWriteEnabled:!0,depthCompare:"less-equal"}}shouldDrawLayer(e){return e.props.shadowEnabled!==!1}getShaderModuleProps(e,t,r){return{shadow:{project:r.project,drawToShadowMap:!0}}}}const HD={color:[255,255,255],intensity:1},t0=[{color:[255,255,255],intensity:1,direction:[-1,3,-1]},{color:[255,255,255],intensity:.9,direction:[1,-8,-2.5]}],qD=[0,0,0,200/255];class U2{constructor(e={}){this.id="lighting-effect",this.shadowColor=qD,this.shadow=!1,this.directionalLights=[],this.pointLights=[],this.shadowPasses=[],this.dummyShadowMap=null,this.setProps(e)}setup(e){this.context=e;const{device:t,deck:r}=e;this.shadow&&!this.dummyShadowMap&&(this._createShadowPasses(t),r._addDefaultShaderModule(Jb),this.dummyShadowMap=t.createTexture({width:1,height:1}))}setProps(e){this.ambientLight=void 0,this.directionalLights=[],this.pointLights=[];for(const t in e){const r=e[t];switch(r.type){case"ambient":this.ambientLight=r;break;case"directional":this.directionalLights.push(r);break;case"point":this.pointLights.push(r);break}}this._applyDefaultLights(),this.shadow=this.directionalLights.some(t=>t.shadow),this.context&&this.setup(this.context),this.props=e}preRender({layers:e,layerFilter:t,viewports:r,onViewportActive:s,views:a}){if(this.shadow){this.shadowMatrices=this._calculateMatrices();for(let u=0;u<this.shadowPasses.length;u++)this.shadowPasses[u].render({layers:e,layerFilter:t,viewports:r,onViewportActive:s,views:a,shaderModuleProps:{shadow:{shadowLightId:u,dummyShadowMap:this.dummyShadowMap,shadowMatrices:this.shadowMatrices}}})}}getShaderModuleProps(e,t){const r=this.shadow?{project:t.project,shadowMaps:this.shadowPasses.map(u=>u.getShadowMap()),dummyShadowMap:this.dummyShadowMap,shadowColor:this.shadowColor,shadowMatrices:this.shadowMatrices}:{},s={enabled:!0,ambientLight:this.ambientLight,directionalLights:this.directionalLights.map(u=>u.getProjectedLight({layer:e})),pointLights:this.pointLights.map(u=>u.getProjectedLight({layer:e}))},a=e.props.material;return{shadow:r,lighting:s,phongMaterial:a,gouraudMaterial:a}}cleanup(e){for(const t of this.shadowPasses)t.delete();this.shadowPasses.length=0,this.dummyShadowMap&&(this.dummyShadowMap.destroy(),this.dummyShadowMap=null,e.deck._removeDefaultShaderModule(Jb))}_calculateMatrices(){const e=[];for(const t of this.directionalLights){const r=new Mr().lookAt({eye:new Mt(t.direction).negate()});e.push(r)}return e}_createShadowPasses(e){for(let t=0;t<this.directionalLights.length;t++){const r=new WD(e);this.shadowPasses[t]=r}}_applyDefaultLights(){const{ambientLight:e,pointLights:t,directionalLights:r}=this;!e&&t.length===0&&r.length===0&&(this.ambientLight=new BD(HD),this.directionalLights.push(new Qb(t0[0]),new Qb(t0[1])))}}class XD{constructor(e={}){this._pool=[],this.opts={overAlloc:2,poolSize:100},this.setOptions(e)}setOptions(e){Object.assign(this.opts,e)}allocate(e,t,{size:r=1,type:s,padding:a=0,copy:u=!1,initialize:l=!1,maxCount:g}){const v=s||e&&e.constructor||Float32Array,T=t*r+a;if(ArrayBuffer.isView(e)){if(T<=e.length)return e;if(T*e.BYTES_PER_ELEMENT<=e.buffer.byteLength)return new v(e.buffer,0,T)}let S=1/0;g&&(S=g*r+a);const P=this._allocate(v,T,l,S);return e&&u?P.set(e):l||P.fill(0,0,4),this._release(e),P}release(e){this._release(e)}_allocate(e,t,r,s){let a=Math.max(Math.ceil(t*this.opts.overAlloc),1);a>s&&(a=s);const u=this._pool,l=e.BYTES_PER_ELEMENT*a,g=u.findIndex(v=>v.byteLength>=l);if(g>=0){const v=new e(u.splice(g,1)[0],0,a);return r&&v.fill(0),v}return new e(a)}_release(e){if(!ArrayBuffer.isView(e))return;const t=this._pool,{buffer:r}=e,{byteLength:s}=r,a=t.findIndex(u=>u.byteLength>=s);a<0?t.push(r):(a>0||t.length<this.opts.poolSize)&&t.splice(a,0,r),t.length>this.opts.poolSize&&t.shift()}}const Tc=new XD;function dh(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function ZD(i){return[i[12],i[13],i[14]]}function YD(i){return{left:ec(i[3]+i[0],i[7]+i[4],i[11]+i[8],i[15]+i[12]),right:ec(i[3]-i[0],i[7]-i[4],i[11]-i[8],i[15]-i[12]),bottom:ec(i[3]+i[1],i[7]+i[5],i[11]+i[9],i[15]+i[13]),top:ec(i[3]-i[1],i[7]-i[5],i[11]-i[9],i[15]-i[13]),near:ec(i[3]+i[2],i[7]+i[6],i[11]+i[10],i[15]+i[14]),far:ec(i[3]-i[2],i[7]-i[6],i[11]-i[10],i[15]-i[14])}}const i0=new Mt;function ec(i,e,t,r){i0.set(i,e,t);const s=i0.len();return{distance:r/s,normal:new Mt(-i/s,-e/s,-t/s)}}function GD(i){return i-Math.fround(i)}let $u;function pm(i,e){const{size:t=1,startIndex:r=0}=e,s=e.endIndex!==void 0?e.endIndex:i.length,a=(s-r)/t;$u=Tc.allocate($u,a,{type:Float32Array,size:t*2});let u=r,l=0;for(;u<s;){for(let g=0;g<t;g++){const v=i[u++];$u[l+g]=v,$u[l+g+t]=GD(v)}l+=t*2}return $u.subarray(0,a*t*2)}function KD(i){let e=null,t=!1;for(const r of i)r&&(e?(t||(e=[[e[0][0],e[0][1]],[e[1][0],e[1][1]]],t=!0),e[0][0]=Math.min(e[0][0],r[0][0]),e[0][1]=Math.min(e[0][1],r[0][1]),e[1][0]=Math.max(e[1][0],r[1][0]),e[1][1]=Math.max(e[1][1],r[1][1])):e=r);return e}const JD=Math.PI/180,QD=dh(),r0=[0,0,0],eO={unitsPerMeter:[1,1,1],metersPerUnit:[1,1,1]};function tO({width:i,height:e,orthographic:t,fovyRadians:r,focalDistance:s,padding:a,near:u,far:l}){const g=i/e,v=t?new Mr().orthographic({fovy:r,aspect:g,focalDistance:s,near:u,far:l}):new Mr().perspective({fovy:r,aspect:g,near:u,far:l});if(a){const{left:T=0,right:S=0,top:P=0,bottom:O=0}=a,$=Yo((T+i-S)/2,0,i)-i/2,W=Yo((P+e-O)/2,0,e)-e/2;v[8]-=$*2/i,v[9]+=W*2/e}return v}class kc{constructor(e={}){this._frustumPlanes={},this.id=e.id||this.constructor.displayName||"viewport",this.x=e.x||0,this.y=e.y||0,this.width=e.width||1,this.height=e.height||1,this.zoom=e.zoom||0,this.padding=e.padding,this.distanceScales=e.distanceScales||eO,this.focalDistance=e.focalDistance||1,this.position=e.position||r0,this.modelMatrix=e.modelMatrix||null;const{longitude:t,latitude:r}=e;this.isGeospatial=Number.isFinite(r)&&Number.isFinite(t),this._initProps(e),this._initMatrices(e),this.equals=this.equals.bind(this),this.project=this.project.bind(this),this.unproject=this.unproject.bind(this),this.projectPosition=this.projectPosition.bind(this),this.unprojectPosition=this.unprojectPosition.bind(this),this.projectFlat=this.projectFlat.bind(this),this.unprojectFlat=this.unprojectFlat.bind(this)}get subViewports(){return null}get metersPerPixel(){return this.distanceScales.metersPerUnit[2]/this.scale}get projectionMode(){return this.isGeospatial?this.zoom<12?Bs.WEB_MERCATOR:Bs.WEB_MERCATOR_AUTO_OFFSET:Bs.IDENTITY}equals(e){return e instanceof kc?this===e?!0:e.width===this.width&&e.height===this.height&&e.scale===this.scale&&eo(e.projectionMatrix,this.projectionMatrix)&&eo(e.viewMatrix,this.viewMatrix):!1}project(e,{topLeft:t=!0}={}){const r=this.projectPosition(e),s=B2(r,this.pixelProjectionMatrix),[a,u]=s,l=t?u:this.height-u;return e.length===2?[a,l]:[a,l,s[2]]}unproject(e,{topLeft:t=!0,targetZ:r}={}){const[s,a,u]=e,l=t?a:this.height-a,g=r&&r*this.distanceScales.unitsPerMeter[2],v=my([s,l,u],this.pixelUnprojectionMatrix,g),[T,S,P]=this.unprojectPosition(v);return Number.isFinite(u)?[T,S,P]:Number.isFinite(r)?[T,S,r]:[T,S]}projectPosition(e){const[t,r]=this.projectFlat(e),s=(e[2]||0)*this.distanceScales.unitsPerMeter[2];return[t,r,s]}unprojectPosition(e){const[t,r]=this.unprojectFlat(e),s=(e[2]||0)*this.distanceScales.metersPerUnit[2];return[t,r,s]}projectFlat(e){if(this.isGeospatial){const t=ia(e);return t[1]=Yo(t[1],-318,830),t}return e}unprojectFlat(e){return this.isGeospatial?wc(e):e}getBounds(e={}){const t={targetZ:e.z||0},r=this.unproject([0,0],t),s=this.unproject([this.width,0],t),a=this.unproject([0,this.height],t),u=this.unproject([this.width,this.height],t);return[Math.min(r[0],s[0],a[0],u[0]),Math.min(r[1],s[1],a[1],u[1]),Math.max(r[0],s[0],a[0],u[0]),Math.max(r[1],s[1],a[1],u[1])]}getDistanceScales(e){return e&&this.isGeospatial?l_({longitude:e[0],latitude:e[1],highPrecision:!0}):this.distanceScales}containsPixel({x:e,y:t,width:r=1,height:s=1}){return e<this.x+this.width&&this.x<e+r&&t<this.y+this.height&&this.y<t+s}getFrustumPlanes(){return this._frustumPlanes.near?this._frustumPlanes:(Object.assign(this._frustumPlanes,YD(this.viewProjectionMatrix)),this._frustumPlanes)}panByPosition(e,t){return null}_initProps(e){const t=e.longitude,r=e.latitude;this.isGeospatial&&(Number.isFinite(e.zoom)||(this.zoom=hD({latitude:r})+Math.log2(this.focalDistance)),this.distanceScales=e.distanceScales||l_({latitude:r,longitude:t}));const s=Math.pow(2,this.zoom);this.scale=s;const{position:a,modelMatrix:u}=e;let l=r0;if(a&&(l=u?new Mr(u).transformAsVector(a,[]):a),this.isGeospatial){const g=this.projectPosition([t,r,0]);this.center=new Mt(l).scale(this.distanceScales.unitsPerMeter).add(g)}else this.center=this.projectPosition(l)}_initMatrices(e){const{viewMatrix:t=QD,projectionMatrix:r=null,orthographic:s=!1,fovyRadians:a,fovy:u=75,near:l=.1,far:g=1e3,padding:v=null,focalDistance:T=1}=e;this.viewMatrixUncentered=t,this.viewMatrix=new Mr().multiplyRight(t).translate(new Mt(this.center).negate()),this.projectionMatrix=r||tO({width:this.width,height:this.height,orthographic:s,fovyRadians:a||u*JD,focalDistance:T,padding:v,near:l,far:g});const S=dh();$a(S,S,this.projectionMatrix),$a(S,S,this.viewMatrix),this.viewProjectionMatrix=S,this.viewMatrixInverse=Qm([],this.viewMatrix)||this.viewMatrix,this.cameraPosition=ZD(this.viewMatrixInverse);const P=dh(),O=dh();hy(P,P,[this.width/2,-this.height/2,1]),np(P,P,[1,-1,0]),$a(O,P,this.viewProjectionMatrix),this.pixelProjectionMatrix=O,this.pixelUnprojectionMatrix=Qm(dh(),this.pixelProjectionMatrix),this.pixelUnprojectionMatrix||ni.warn("Pixel project matrix not invertible")()}}kc.displayName="Viewport";class ra extends kc{constructor(e={}){const{latitude:t=0,longitude:r=0,zoom:s=0,pitch:a=0,bearing:u=0,nearZMultiplier:l=.1,farZMultiplier:g=1.01,nearZ:v,farZ:T,orthographic:S=!1,projectionMatrix:P,repeat:O=!1,worldOffset:$=0,position:W,padding:G,legacyMeterSizes:Q=!1}=e;let{width:ae,height:te,altitude:me=1.5}=e;const we=Math.pow(2,s);ae=ae||1,te=te||1;let Oe,Je=null;if(P)me=P[5]/2,Oe=kh(me);else{e.fovy?(Oe=e.fovy,me=gy(Oe)):Oe=kh(me);let He;if(G){const{top:ht=0,bottom:Ye=0}=G;He=[0,Yo((ht+te-Ye)/2,0,te)-te/2]}Je=fD({width:ae,height:te,scale:we,center:W&&[0,0,W[2]*fm(t)],offset:He,pitch:a,fovy:Oe,nearZMultiplier:l,farZMultiplier:g}),Number.isFinite(v)&&(Je.near=v),Number.isFinite(T)&&(Je.far=T)}let it=dD({height:te,pitch:a,bearing:u,scale:we,altitude:me});$&&(it=new Mr().translate([512*$,0,0]).multiplyLeft(it)),super({...e,width:ae,height:te,viewMatrix:it,longitude:r,latitude:t,zoom:s,...Je,fovy:Oe,focalDistance:me}),this.latitude=t,this.longitude=r,this.zoom=s,this.pitch=a,this.bearing=u,this.altitude=me,this.fovy=Oe,this.orthographic=S,this._subViewports=O?[]:null,this._pseudoMeters=Q,Object.freeze(this)}get subViewports(){if(this._subViewports&&!this._subViewports.length){const e=this.getBounds(),t=Math.floor((e[0]+180)/360),r=Math.ceil((e[2]-180)/360);for(let s=t;s<=r;s++){const a=s?new ra({...this,worldOffset:s}):this;this._subViewports.push(a)}}return this._subViewports}projectPosition(e){if(this._pseudoMeters)return super.projectPosition(e);const[t,r]=this.projectFlat(e),s=(e[2]||0)*fm(e[1]);return[t,r,s]}unprojectPosition(e){if(this._pseudoMeters)return super.unprojectPosition(e);const[t,r]=this.unprojectFlat(e),s=(e[2]||0)/fm(r);return[t,r,s]}addMetersToLngLat(e,t){return F2(e,t)}panByPosition(e,t){const r=my(t,this.pixelUnprojectionMatrix),s=this.projectFlat(e),a=bb([],s,nM([],r)),u=bb([],this.center,a),[l,g]=this.unprojectFlat(u);return{longitude:l,latitude:g}}getBounds(e={}){const t=mD(this,e.z||0);return[Math.min(t[0][0],t[1][0],t[2][0],t[3][0]),Math.min(t[0][1],t[1][1],t[2][1],t[3][1]),Math.max(t[0][0],t[1][0],t[2][0],t[3][0]),Math.max(t[0][1],t[1][1],t[2][1],t[3][1])]}fitBounds(e,t={}){const{width:r,height:s}=this,{longitude:a,latitude:u,zoom:l}=pD({width:r,height:s,bounds:e,...t});return new ra({width:r,height:s,longitude:a,latitude:u,zoom:l})}}ra.displayName="WebMercatorViewport";const s0=[0,0,0];function gm(i,e,t=!1){const r=e.projectPosition(i);if(t&&e instanceof ra){const[s,a,u=0]=i,l=e.getDistanceScales([s,a]);r[2]=u*l.unitsPerMeter[2]}return r}function iO(i){const{viewport:e,modelMatrix:t,coordinateOrigin:r}=i;let{coordinateSystem:s,fromCoordinateSystem:a,fromCoordinateOrigin:u}=i;return s===li.DEFAULT&&(s=e.isGeospatial?li.LNGLAT:li.CARTESIAN),a===void 0&&(a=s),u===void 0&&(u=r),{viewport:e,coordinateSystem:s,coordinateOrigin:r,modelMatrix:t,fromCoordinateSystem:a,fromCoordinateOrigin:u}}function V2(i,{viewport:e,modelMatrix:t,coordinateSystem:r,coordinateOrigin:s,offsetMode:a}){let[u,l,g=0]=i;switch(t&&([u,l,g]=Pc([],[u,l,g,1],t)),r){case li.LNGLAT:return gm([u,l,g],e,a);case li.LNGLAT_OFFSETS:return gm([u+s[0],l+s[1],g+(s[2]||0)],e,a);case li.METER_OFFSETS:return gm(F2(s,[u,l,g]),e,a);case li.CARTESIAN:default:return e.isGeospatial?[u+s[0],l+s[1],g+s[2]]:e.projectPosition([u,l,g])}}function rO(i,e){const{viewport:t,coordinateSystem:r,coordinateOrigin:s,modelMatrix:a,fromCoordinateSystem:u,fromCoordinateOrigin:l}=iO(e),{autoOffset:g=!0}=e,{geospatialOrigin:v=s0,shaderCoordinateOrigin:T=s0,offsetMode:S=!1}=g?O2(t,r,s):{},P=V2(i,{viewport:t,modelMatrix:a,coordinateSystem:u,coordinateOrigin:l,offsetMode:S});if(S){const O=t.projectPosition(v||T);p2(P,P,O)}return P}let sO=1,nO=1;class j2{time=0;channels=new Map;animations=new Map;playing=!1;lastEngineTime=-1;constructor(){}addChannel(e){const{delay:t=0,duration:r=Number.POSITIVE_INFINITY,rate:s=1,repeat:a=1}=e,u=sO++,l={time:0,delay:t,duration:r,rate:s,repeat:a};return this._setChannelTime(l,this.time),this.channels.set(u,l),u}removeChannel(e){this.channels.delete(e);for(const[t,r]of this.animations)r.channel===e&&this.detachAnimation(t)}isFinished(e){const t=this.channels.get(e);return t===void 0?!1:this.time>=t.delay+t.duration*t.repeat}getTime(e){if(e===void 0)return this.time;const t=this.channels.get(e);return t===void 0?-1:t.time}setTime(e){this.time=Math.max(0,e);const t=this.channels.values();for(const s of t)this._setChannelTime(s,this.time);const r=this.animations.values();for(const s of r){const{animation:a,channel:u}=s;a.setTime(this.getTime(u))}}play(){this.playing=!0}pause(){this.playing=!1,this.lastEngineTime=-1}reset(){this.setTime(0)}attachAnimation(e,t){const r=nO++;return this.animations.set(r,{animation:e,channel:t}),e.setTime(this.getTime(t)),r}detachAnimation(e){this.animations.delete(e)}update(e){this.playing&&(this.lastEngineTime===-1&&(this.lastEngineTime=e),this.setTime(this.time+(e-this.lastEngineTime)),this.lastEngineTime=e)}_setChannelTime(e,t){const r=t-e.delay,s=e.duration*e.repeat;r>=s?e.time=e.duration*e.rate:(e.time=Math.max(0,r)%e.duration,e.time*=e.rate)}}function oO(i){return typeof window<"u"&&window.requestAnimationFrame?window.requestAnimationFrame(i):setTimeout(i,1e3/60)}function aO(i){return typeof window<"u"&&window.cancelAnimationFrame?window.cancelAnimationFrame(i):clearTimeout(i)}let lO=0;class yy{static defaultAnimationLoopProps={device:null,onAddHTML:()=>"",onInitialize:async()=>null,onRender:()=>{},onFinalize:()=>{},onError:e=>console.error(e),stats:Zm.stats.get(`animation-loop-${lO++}`),autoResizeViewport:!1};device=null;canvas=null;props;animationProps=null;timeline=null;stats;cpuTime;gpuTime;frameRate;display;needsRedraw="initialized";_initialized=!1;_running=!1;_animationFrameId=null;_nextFramePromise=null;_resolveNextFrame=null;_cpuStartTime=0;_error=null;constructor(e){if(this.props={...yy.defaultAnimationLoopProps,...e},e=this.props,!e.device)throw new Error("No device provided");this.stats=e.stats||new zh({id:"animation-loop-stats"}),this.cpuTime=this.stats.get("CPU Time"),this.gpuTime=this.stats.get("GPU Time"),this.frameRate=this.stats.get("Frame Rate"),this.setProps({autoResizeViewport:e.autoResizeViewport}),this.start=this.start.bind(this),this.stop=this.stop.bind(this),this._onMousemove=this._onMousemove.bind(this),this._onMouseleave=this._onMouseleave.bind(this)}destroy(){this.stop(),this._setDisplay(null)}delete(){this.destroy()}reportError(e){this.props.onError(e),this._error=e}setNeedsRedraw(e){return this.needsRedraw=this.needsRedraw||e,this}setProps(e){return"autoResizeViewport"in e&&(this.props.autoResizeViewport=e.autoResizeViewport||!1),this}async start(){if(this._running)return this;this._running=!0;try{let e;return this._initialized||(this._initialized=!0,await this._initDevice(),this._initialize(),await this.props.onInitialize(this._getAnimationProps())),this._running?(e!==!1&&(this._cancelAnimationFrame(),this._requestAnimationFrame()),this):null}catch(e){const t=e instanceof Error?e:new Error("Unknown error");throw this.props.onError(t),t}}stop(){return this._running&&(this.animationProps&&!this._error&&this.props.onFinalize(this.animationProps),this._cancelAnimationFrame(),this._nextFramePromise=null,this._resolveNextFrame=null,this._running=!1),this}redraw(){return this.device?.isLost||this._error?this:(this._beginFrameTimers(),this._setupFrame(),this._updateAnimationProps(),this._renderFrame(this._getAnimationProps()),this._clearNeedsRedraw(),this._resolveNextFrame&&(this._resolveNextFrame(this),this._nextFramePromise=null,this._resolveNextFrame=null),this._endFrameTimers(),this)}attachTimeline(e){return this.timeline=e,this.timeline}detachTimeline(){this.timeline=null}waitForRender(){return this.setNeedsRedraw("waitForRender"),this._nextFramePromise||(this._nextFramePromise=new Promise(e=>{this._resolveNextFrame=e})),this._nextFramePromise}async toDataURL(){if(this.setNeedsRedraw("toDataURL"),await this.waitForRender(),this.canvas instanceof HTMLCanvasElement)return this.canvas.toDataURL();throw new Error("OffscreenCanvas")}_initialize(){this._startEventHandling(),this._initializeAnimationProps(),this._updateAnimationProps(),this._resizeViewport()}_setDisplay(e){this.display&&(this.display.destroy(),this.display.animationLoop=null),e&&(e.animationLoop=this),this.display=e}_requestAnimationFrame(){this._running&&(this._animationFrameId=oO(this._animationFrame.bind(this)))}_cancelAnimationFrame(){this._animationFrameId!==null&&(aO(this._animationFrameId),this._animationFrameId=null)}_animationFrame(){this._running&&(this.redraw(),this._requestAnimationFrame())}_renderFrame(e){if(this.display){this.display._renderFrame(e);return}this.props.onRender(this._getAnimationProps()),this.device?.submit()}_clearNeedsRedraw(){this.needsRedraw=!1}_setupFrame(){this._resizeViewport()}_initializeAnimationProps(){const e=this.device?.getDefaultCanvasContext();if(!this.device||!e)throw new Error("loop");const t=e?.canvas,r=e.props.useDevicePixels;this.animationProps={animationLoop:this,device:this.device,canvasContext:e,canvas:t,useDevicePixels:r,timeline:this.timeline,needsRedraw:!1,width:1,height:1,aspect:1,time:0,startTime:Date.now(),engineTime:0,tick:0,tock:0,_mousePosition:null}}_getAnimationProps(){if(!this.animationProps)throw new Error("animationProps");return this.animationProps}_updateAnimationProps(){if(!this.animationProps)return;const{width:e,height:t,aspect:r}=this._getSizeAndAspect();(e!==this.animationProps.width||t!==this.animationProps.height)&&this.setNeedsRedraw("drawing buffer resized"),r!==this.animationProps.aspect&&this.setNeedsRedraw("drawing buffer aspect changed"),this.animationProps.width=e,this.animationProps.height=t,this.animationProps.aspect=r,this.animationProps.needsRedraw=this.needsRedraw,this.animationProps.engineTime=Date.now()-this.animationProps.startTime,this.timeline&&this.timeline.update(this.animationProps.engineTime),this.animationProps.tick=Math.floor(this.animationProps.time/1e3*60),this.animationProps.tock++,this.animationProps.time=this.timeline?this.timeline.getTime():this.animationProps.engineTime}async _initDevice(){if(this.device=await this.props.device,!this.device)throw new Error("No device provided");this.canvas=this.device.getDefaultCanvasContext().canvas||null}_createInfoDiv(){if(this.canvas&&this.props.onAddHTML){const e=document.createElement("div");document.body.appendChild(e),e.style.position="relative";const t=document.createElement("div");t.style.position="absolute",t.style.left="10px",t.style.bottom="10px",t.style.width="300px",t.style.background="white",this.canvas instanceof HTMLCanvasElement&&e.appendChild(this.canvas),e.appendChild(t);const r=this.props.onAddHTML(t);r&&(t.innerHTML=r)}}_getSizeAndAspect(){if(!this.device)return{width:1,height:1,aspect:1};const[e,t]=this.device?.getDefaultCanvasContext().getDevicePixelSize()||[1,1];let r=1;const s=this.device?.getDefaultCanvasContext().canvas;return s&&s.clientHeight?r=s.clientWidth/s.clientHeight:e>0&&t>0&&(r=e/t),{width:e,height:t,aspect:r}}_resizeViewport(){this.props.autoResizeViewport&&this.device.gl&&this.device.gl.viewport(0,0,this.device.gl.drawingBufferWidth,this.device.gl.drawingBufferHeight)}_beginFrameTimers(){this.frameRate.timeEnd(),this.frameRate.timeStart(),this.cpuTime.timeStart()}_endFrameTimers(){this.cpuTime.timeEnd()}_startEventHandling(){this.canvas&&(this.canvas.addEventListener("mousemove",this._onMousemove.bind(this)),this.canvas.addEventListener("mouseleave",this._onMouseleave.bind(this)))}_onMousemove(e){e instanceof MouseEvent&&(this._getAnimationProps()._mousePosition=[e.offsetX,e.offsetY])}_onMouseleave(e){this._getAnimationProps()._mousePosition=null}}const mm={};function $h(i="id"){mm[i]=mm[i]||1;const e=mm[i]++;return`${i}-${e}`}class n0{id;userData={};topology;bufferLayout=[];vertexCount;indices;attributes;constructor(e){if(this.id=e.id||$h("geometry"),this.topology=e.topology,this.indices=e.indices||null,this.attributes=e.attributes,this.vertexCount=e.vertexCount,this.bufferLayout=e.bufferLayout||[],this.indices&&!(this.indices.usage&Oi.INDEX))throw new Error("Index buffer must have INDEX usage")}destroy(){this.indices?.destroy();for(const e of Object.values(this.attributes))e.destroy()}getVertexCount(){return this.vertexCount}getAttributes(){return this.attributes}getIndexes(){return this.indices||null}_calculateVertexCount(e){return e.byteLength/12}}function cO(i,e){if(e instanceof n0)return e;const t=uO(i,e),{attributes:r,bufferLayout:s}=hO(i,e);return new n0({topology:e.topology||"triangle-list",bufferLayout:s,vertexCount:e.vertexCount,indices:t,attributes:r})}function uO(i,e){if(!e.indices)return;const t=e.indices.value;return i.createBuffer({usage:Oi.INDEX,data:t})}function hO(i,e){const t=[],r={};for(const[a,u]of Object.entries(e.attributes)){let l=a;switch(a){case"POSITION":l="positions";break;case"NORMAL":l="normals";break;case"TEXCOORD_0":l="texCoords";break;case"COLOR_0":l="colors";break}if(u){r[l]=i.createBuffer({data:u.value,id:`${a}-buffer`});const{value:g,size:v,normalized:T}=u;t.push({name:l,format:TC(g,v,T)})}}const s=e._calculateVertexCount(e.attributes,e.indices);return{attributes:r,bufferLayout:t,vertexCount:s}}class xy{static defaultProps={...Va.defaultProps};static getDefaultPipelineFactory(e){return e._lumaData.defaultPipelineFactory=e._lumaData.defaultPipelineFactory||new xy(e),e._lumaData.defaultPipelineFactory}device;cachingEnabled;destroyPolicy;debug;_hashCounter=0;_hashes={};_renderPipelineCache={};_computePipelineCache={};get[Symbol.toStringTag](){return"PipelineFactory"}toString(){return`PipelineFactory(${this.device.id})`}constructor(e){this.device=e,this.cachingEnabled=e.props._cachePipelines,this.destroyPolicy=e.props._cacheDestroyPolicy,this.debug=e.props.debugFactories}createRenderPipeline(e){if(!this.cachingEnabled)return this.device.createRenderPipeline(e);const t={...Va.defaultProps,...e},r=this._renderPipelineCache,s=this._hashRenderPipeline(t);let a=r[s]?.pipeline;return a?(r[s].useCount++,this.debug&&Qe.log(3,`${this}: ${r[s].pipeline} reused, count=${r[s].useCount}, (id=${e.id})`)()):(a=this.device.createRenderPipeline({...t,id:t.id?`${t.id}-cached`:$h("unnamed-cached")}),a.hash=s,r[s]={pipeline:a,useCount:1},this.debug&&Qe.log(3,`${this}: ${a} created, count=${r[s].useCount}`)()),a}createComputePipeline(e){if(!this.cachingEnabled)return this.device.createComputePipeline(e);const t={...Jf.defaultProps,...e},r=this._computePipelineCache,s=this._hashComputePipeline(t);let a=r[s]?.pipeline;return a?(r[s].useCount++,this.debug&&Qe.log(3,`${this}: ${r[s].pipeline} reused, count=${r[s].useCount}, (id=${e.id})`)()):(a=this.device.createComputePipeline({...t,id:t.id?`${t.id}-cached`:void 0}),a.hash=s,r[s]={pipeline:a,useCount:1},this.debug&&Qe.log(3,`${this}: ${a} created, count=${r[s].useCount}`)()),a}release(e){if(!this.cachingEnabled){e.destroy();return}const t=this._getCache(e),r=e.hash;t[r].useCount--,t[r].useCount===0?(this._destroyPipeline(e),this.debug&&Qe.log(3,`${this}: ${e} released and destroyed`)()):t[r].useCount<0?(Qe.error(`${this}: ${e} released, useCount < 0, resetting`)(),t[r].useCount=0):this.debug&&Qe.log(3,`${this}: ${e} released, count=${t[r].useCount}`)()}_destroyPipeline(e){const t=this._getCache(e);switch(this.destroyPolicy){case"never":return!1;case"unused":return delete t[e.hash],e.destroy(),!0}}_getCache(e){let t;if(e instanceof Jf&&(t=this._computePipelineCache),e instanceof Va&&(t=this._renderPipelineCache),!t)throw new Error(`${this}`);if(!t[e.hash])throw new Error(`${this}: ${e} matched incorrect entry`);return t}_hashComputePipeline(e){const{type:t}=this.device,r=this._getHash(e.shader.source);return`${t}/C/${r}`}_hashRenderPipeline(e){const t=e.vs?this._getHash(e.vs.source):0,r=e.fs?this._getHash(e.fs.source):0,s="-",a=this._getHash(JSON.stringify(e.bufferLayout)),{type:u}=this.device;switch(u){case"webgl":return`${u}/R/${t}/${r}V${s}BL${a}`;case"webgpu":default:const l=this._getHash(JSON.stringify(e.parameters));return`${u}/R/${t}/${r}V${s}T${e.topology}P${l}BL${a}`}}_getHash(e){return this._hashes[e]===void 0&&(this._hashes[e]=this._hashCounter++),this._hashes[e]}}class vy{static defaultProps={...mp.defaultProps};static getDefaultShaderFactory(e){return e._lumaData.defaultShaderFactory||=new vy(e),e._lumaData.defaultShaderFactory}device;cachingEnabled;destroyPolicy;debug;_cache={};get[Symbol.toStringTag](){return"ShaderFactory"}toString(){return`${this[Symbol.toStringTag]}(${this.device.id})`}constructor(e){this.device=e,this.cachingEnabled=e.props._cacheShaders,this.destroyPolicy=e.props._cacheDestroyPolicy,this.debug=!0}createShader(e){if(!this.cachingEnabled)return this.device.createShader(e);const t=this._hashShader(e);let r=this._cache[t];if(r)r.useCount++,this.debug&&Qe.log(3,`${this}: Reusing shader ${r.shader.id} count=${r.useCount}`)();else{const s=this.device.createShader({...e,id:e.id?`${e.id}-cached`:void 0});this._cache[t]=r={shader:s,useCount:1},this.debug&&Qe.log(3,`${this}: Created new shader ${s.id}`)()}return r.shader}release(e){if(!this.cachingEnabled){e.destroy();return}const t=this._hashShader(e),r=this._cache[t];if(r)if(r.useCount--,r.useCount===0)this.destroyPolicy==="unused"&&(delete this._cache[t],r.shader.destroy(),this.debug&&Qe.log(3,`${this}: Releasing shader ${e.id}, destroyed`)());else{if(r.useCount<0)throw new Error(`ShaderFactory: Shader ${e.id} released too many times`);this.debug&&Qe.log(3,`${this}: Releasing shader ${e.id} count=${r.useCount}`)()}}_hashShader(e){return`${e.stage}:${e.source}`}}function dO(i,e){const t={},r="Values";if(i.attributes.length===0&&!i.varyings?.length)return{"No attributes or varyings":{[r]:"N/A"}};for(const s of i.attributes)if(s){const a=`${s.location} ${s.name}: ${s.type}`;t[`in ${a}`]={[r]:s.stepMode||"vertex"}}for(const s of i.varyings||[]){const a=`${s.location} ${s.name}`;t[`out ${a}`]={[r]:JSON.stringify(s)}}return t}let wr=null,_m=null;function fO(i,{id:e,minimap:t,opaque:r,top:s="0",left:a="0",rgbaScale:u=1}){wr||(wr=document.createElement("canvas"),wr.id=e,wr.title=e,wr.style.zIndex="100",wr.style.position="absolute",wr.style.top=s,wr.style.left=a,wr.style.border="blue 5px solid",wr.style.transform="scaleY(-1)",document.body.appendChild(wr),_m=wr.getContext("2d")),(wr.width!==i.width||wr.height!==i.height)&&(wr.width=i.width/2,wr.height=i.height/2,wr.style.width="400px",wr.style.height="400px");const l=i.device.readPixelsToArrayWebGL(i),g=_m?.createImageData(i.width,i.height);if(g){for(let T=0;T<l.length;T+=4)g.data[0+T+0]=l[T+0]*u,g.data[0+T+1]=l[T+1]*u,g.data[0+T+2]=l[T+2]*u,g.data[0+T+3]=r?255:l[T+3]*u;_m?.putImageData(g,0,0)}}function c_(i,e,t){if(i===e)return!0;if(!t||!i||!e)return!1;if(Array.isArray(i)){if(!Array.isArray(e)||i.length!==e.length)return!1;for(let r=0;r<i.length;r++)if(!c_(i[r],e[r],t-1))return!1;return!0}if(Array.isArray(e))return!1;if(typeof i=="object"&&typeof e=="object"){const r=Object.keys(i),s=Object.keys(e);if(r.length!==s.length)return!1;for(const a of r)if(!e.hasOwnProperty(a)||!c_(i[a],e[a],t-1))return!1;return!0}return!1}class ym{bufferLayouts;constructor(e){this.bufferLayouts=e}getBufferLayout(e){return this.bufferLayouts.find(t=>t.name===e)||null}getAttributeNamesForBuffer(e){return e.attributes?e.attributes?.map(t=>t.attribute):[e.name]}mergeBufferLayouts(e,t){const r=[...e];for(const s of t){const a=r.findIndex(u=>u.name===s.name);a<0?r.push(s):r[a]=s}return r}getBufferIndex(e){const t=this.bufferLayouts.findIndex(r=>r.name===e);return t===-1&&Qe.warn(`BufferLayout: Missing buffer for "${e}".`)(),t}}function pO(i,e){const t=Object.fromEntries(i.attributes.map(s=>[s.name,s.location])),r=e.slice();return r.sort((s,a)=>{const u=s.attributes?s.attributes.map(T=>T.attribute):[s.name],l=a.attributes?a.attributes.map(T=>T.attribute):[a.name],g=Math.min(...u.map(T=>t[T])),v=Math.min(...l.map(T=>t[T]));return g-v}),r}function gO(i){return ArrayBuffer.isView(i)&&!(i instanceof DataView)}function mO(i){return Array.isArray(i)?i.length===0||typeof i[0]=="number":!1}function _O(i){return gO(i)||mO(i)}function yO(i){return _O(i)||typeof i=="number"||typeof i=="boolean"}function xO(i){const e={bindings:{},uniforms:{}};return Object.keys(i).forEach(t=>{const r=i[t];yO(r)?e.uniforms[t]=r:e.bindings[t]=r}),e}class vO{options={disableWarnings:!1};modules;moduleUniforms;moduleBindings;constructor(e,t){Object.assign(this.options,t);const r=$_(Object.values(e).filter(s=>s.dependencies));for(const s of r)e[s.name]=s;Qe.log(1,"Creating ShaderInputs with modules",Object.keys(e))(),this.modules=e,this.moduleUniforms={},this.moduleBindings={};for(const[s,a]of Object.entries(e))this._addModule(a),a.name&&s!==a.name&&!this.options.disableWarnings&&Qe.warn(`Module name: ${s} vs ${a.name}`)()}destroy(){}setProps(e){for(const t of Object.keys(e)){const r=t,s=e[r]||{},a=this.modules[r];if(!a){this.options.disableWarnings||Qe.warn(`Module ${t} not found`)();continue}const u=this.moduleUniforms[r],l=this.moduleBindings[r],g=a.getUniforms?.(s,u)||s,{uniforms:v,bindings:T}=xO(g);this.moduleUniforms[r]={...u,...v},this.moduleBindings[r]={...l,...T}}}getModules(){return Object.values(this.modules)}getUniformValues(){return this.moduleUniforms}getBindingValues(){const e={};for(const t of Object.values(this.moduleBindings))Object.assign(e,t);return e}getDebugTable(){const e={};for(const[t,r]of Object.entries(this.moduleUniforms))for(const[s,a]of Object.entries(r))e[`${t}.${s}`]={type:this.modules[t].uniformTypes?.[s],value:String(a)};return e}_addModule(e){const t=e.name;this.moduleUniforms[t]=e.defaultUniforms||{},this.moduleBindings[t]={}}}let bO="";async function wO(i,e){const t=new Image;return t.crossOrigin="anonymous",t.src=i.startsWith("http")?i:bO+i,await t.decode(),e?await createImageBitmap(t,e):await createImageBitmap(t)}const TO=["+X","-X","+Y","-Y","+Z","-Z"],SO=["+X","-X","+Y","-Y","+Z","-Z"];class Th{device;id;props;texture;sampler;view;ready;isReady=!1;destroyed=!1;resolveReady=()=>{};rejectReady=()=>{};get[Symbol.toStringTag](){return"AsyncTexture"}toString(){return`AsyncTexture:"${this.id}"(${this.isReady?"ready":"loading"})`}constructor(e,t){this.device=e;const r=$h("async-texture");this.props={...Th.defaultProps,id:r,...t},this.id=this.props.id,t={...t},typeof t?.data=="string"&&t.dimension==="2d"&&(t.data=wO(t.data)),t.mipmaps&&(t.mipLevels="auto"),this.ready=new Promise((s,a)=>{this.resolveReady=()=>{this.isReady=!0,s()},this.rejectReady=a}),this.initAsync(t)}async initAsync(e){const t=e.data,r=await $2(t).then(void 0,this.rejectReady);if(this.destroyed)return;const s=this.props.width&&this.props.height?{width:this.props.width,height:this.props.height}:this.getTextureDataSize(r);if(!s)throw new Error("Texture size could not be determined");const a={...s,...e,data:void 0,mipLevels:1},u=this.device.getMipLevelCount(a.width,a.height);if(a.mipLevels=this.props.mipLevels==="auto"?u:Math.min(u,this.props.mipLevels),this.texture=this.device.createTexture(a),this.sampler=this.texture.sampler,this.view=this.texture.view,e.data)switch(this.props.dimension){case"1d":this._setTexture1DData(this.texture,r);break;case"2d":this._setTexture2DData(r);break;case"3d":this._setTexture3DData(this.texture,r);break;case"2d-array":this._setTextureArrayData(this.texture,r);break;case"cube":this._setTextureCubeData(this.texture,r);break;case"cube-array":this._setTextureCubeArrayData(this.texture,r);break}this.props.mipmaps&&this.generateMipmaps(),Qe.info(1,`${this} loaded`),this.resolveReady()}destroy(){this.texture&&(this.texture.destroy(),this.texture=null),this.destroyed=!0}generateMipmaps(){this.texture.generateMipmapsWebGL()}setSampler(e={}){this.texture.setSampler(e instanceof Xa?e:this.device.createSampler(e))}resize(e){if(!this.isReady)throw new Error("Cannot resize texture before it is ready");if(e.width===this.texture.width&&e.height===this.texture.height)return!1;if(this.texture){const t=this.texture;this.texture=t.clone(e),t.destroy()}return!0}isTextureLevelData(e){const t=e?.data;return ArrayBuffer.isView(t)}getTextureDataSize(e){if(!e||ArrayBuffer.isView(e))return null;if(Array.isArray(e))return this.getTextureDataSize(e[0]);if(this.device.isExternalImage(e))return this.device.getExternalImageSize(e);if(e&&typeof e=="object"&&e.constructor===Object){const r=Object.values(e)[0];return{width:r.width,height:r.height}}throw new Error("texture size deduction failed")}getCubeFaceDepth(e){switch(e){case"+X":return 0;case"-X":return 1;case"+Y":return 2;case"-Y":return 3;case"+Z":return 4;case"-Z":return 5;default:throw new Error(e)}}setTextureData(e){}_setTexture1DData(e,t){throw new Error("setTexture1DData not supported in WebGL.")}_setTexture2DData(e,t=0){if(!this.texture)throw new Error("Texture not initialized");const r=this._normalizeTextureData(e);r.length>1&&this.props.mipmaps!==!1&&Qe.warn(`Texture ${this.id} mipmap and multiple LODs.`)();for(let s=0;s<r.length;s++){const a=r[s];this.device.isExternalImage(a)?this.texture.copyExternalImage({image:a,depth:t,mipLevel:s,flipY:!0}):this.texture.copyImageData({data:a.data,mipLevel:s})}}_setTexture3DData(e,t){if(this.texture?.props.dimension!=="3d")throw new Error(this.id);for(let r=0;r<t.length;r++)this._setTexture2DData(t[r],r)}_setTextureCubeData(e,t){if(this.texture?.props.dimension!=="cube")throw new Error(this.id);for(const[r,s]of Object.entries(t)){const a=SO.indexOf(r);this._setTexture2DData(s,a)}}_setTextureArrayData(e,t){if(this.texture?.props.dimension!=="2d-array")throw new Error(this.id);for(let r=0;r<t.length;r++)this._setTexture2DData(t[r],r)}_setTextureCubeArrayData(e,t){throw new Error("setTextureCubeArrayData not supported in WebGL2.")}_setTextureCubeFaceData(e,t,r,s=0){Array.isArray(t)&&t.length>1&&this.props.mipmaps!==!1&&Qe.warn(`${this.id} has mipmap and multiple LODs.`)();const a=TO.indexOf(r);this._setTexture2DData(t,a)}_normalizeTextureData(e){const t=this.texture;let r;return ArrayBuffer.isView(e)?r=[{data:e,width:t.width,height:t.height}]:Array.isArray(e)?r=e:r=[e],r}static defaultProps={...fr.defaultProps,data:null,mipmaps:!1}}async function $2(i){if(i=await i,Array.isArray(i))return await Promise.all(i.map($2));if(i&&typeof i=="object"&&i.constructor===Object){const e=i,t=await Promise.all(Object.values(e)),r=Object.keys(e),s={};for(let a=0;a<r.length;a++)s[r[a]]=t[a];return s}return i}const Ra=2,AO=1e4;class Ks{static defaultProps={...Va.defaultProps,source:void 0,vs:null,fs:null,id:"unnamed",handle:void 0,userData:{},defines:{},modules:[],geometry:null,indexBuffer:null,attributes:{},constantAttributes:{},varyings:[],isInstanced:void 0,instanceCount:0,vertexCount:0,shaderInputs:void 0,pipelineFactory:void 0,shaderFactory:void 0,transformFeedback:void 0,shaderAssembler:Fa.getDefaultShaderAssembler(),debugShaders:void 0,disableWarnings:void 0};device;id;source;vs;fs;pipelineFactory;shaderFactory;userData={};parameters;topology;bufferLayout;isInstanced=void 0;instanceCount=0;vertexCount;indexBuffer=null;bufferAttributes={};constantAttributes={};bindings={};vertexArray;transformFeedback=null;pipeline;shaderInputs;_uniformStore;_attributeInfos={};_gpuGeometry=null;props;_pipelineNeedsUpdate="newly created";_needsRedraw="initializing";_destroyed=!1;_lastDrawTimestamp=-1;get[Symbol.toStringTag](){return"Model"}toString(){return`Model(${this.id})`}constructor(e,t){this.props={...Ks.defaultProps,...t},t=this.props,this.id=t.id||$h("model"),this.device=e,Object.assign(this.userData,t.userData);const r=Object.fromEntries(this.props.modules?.map(g=>[g.name,g])||[]),s=t.shaderInputs||new vO(r,{disableWarnings:this.props.disableWarnings});this.setShaderInputs(s);const a=IO(e),u=(this.props.modules?.length>0?this.props.modules:this.shaderInputs?.getModules())||[];if(this.device.type==="webgpu"&&this.props.source){const{source:g,getUniforms:v}=this.props.shaderAssembler.assembleWGSLShader({platformInfo:a,...this.props,modules:u});this.source=g,this._getModuleUniforms=v,this.props.shaderLayout||=GP(this.source)}else{const{vs:g,fs:v,getUniforms:T}=this.props.shaderAssembler.assembleGLSLShaderPair({platformInfo:a,...this.props,modules:u});this.vs=g,this.fs=v,this._getModuleUniforms=T}this.vertexCount=this.props.vertexCount,this.instanceCount=this.props.instanceCount,this.topology=this.props.topology,this.bufferLayout=this.props.bufferLayout,this.parameters=this.props.parameters,t.geometry&&this.setGeometry(t.geometry),this.pipelineFactory=t.pipelineFactory||xy.getDefaultPipelineFactory(this.device),this.shaderFactory=t.shaderFactory||vy.getDefaultShaderFactory(this.device),this.pipeline=this._updatePipeline(),this.vertexArray=e.createVertexArray({shaderLayout:this.pipeline.shaderLayout,bufferLayout:this.pipeline.bufferLayout}),this._gpuGeometry&&this._setGeometryAttributes(this._gpuGeometry),"isInstanced"in t&&(this.isInstanced=t.isInstanced),t.instanceCount&&this.setInstanceCount(t.instanceCount),t.vertexCount&&this.setVertexCount(t.vertexCount),t.indexBuffer&&this.setIndexBuffer(t.indexBuffer),t.attributes&&this.setAttributes(t.attributes),t.constantAttributes&&this.setConstantAttributes(t.constantAttributes),t.bindings&&this.setBindings(t.bindings),t.transformFeedback&&(this.transformFeedback=t.transformFeedback),Object.seal(this)}destroy(){this._destroyed||(this.pipelineFactory.release(this.pipeline),this.shaderFactory.release(this.pipeline.vs),this.pipeline.fs&&this.shaderFactory.release(this.pipeline.fs),this._uniformStore.destroy(),this._gpuGeometry?.destroy(),this._destroyed=!0)}needsRedraw(){this._getBindingsUpdateTimestamp()>this._lastDrawTimestamp&&this.setNeedsRedraw("contents of bound textures or buffers updated");const e=this._needsRedraw;return this._needsRedraw=!1,e}setNeedsRedraw(e){this._needsRedraw||=e}predraw(){this.updateShaderInputs(),this.pipeline=this._updatePipeline()}draw(e){const t=this._areBindingsLoading();if(t)return Qe.info(Ra,`>>> DRAWING ABORTED ${this.id}: ${t} not loaded`)(),!1;try{e.pushDebugGroup(`${this}.predraw(${e})`),this.predraw()}finally{e.popDebugGroup()}let r;try{e.pushDebugGroup(`${this}.draw(${e})`),this._logDrawCallStart(),this.pipeline=this._updatePipeline();const s=this._getBindings();this.pipeline.setBindings(s,{disableWarnings:this.props.disableWarnings});const{indexBuffer:a}=this.vertexArray,u=a?a.byteLength/(a.indexType==="uint32"?4:2):void 0;r=this.pipeline.draw({renderPass:e,vertexArray:this.vertexArray,isInstanced:this.isInstanced,vertexCount:this.vertexCount,instanceCount:this.instanceCount,indexCount:u,transformFeedback:this.transformFeedback||void 0,parameters:this.parameters,topology:this.topology})}finally{e.popDebugGroup(),this._logDrawCallEnd()}return this._logFramebuffer(e),r?(this._lastDrawTimestamp=this.device.timestamp,this._needsRedraw=!1):this._needsRedraw="waiting for resource initialization",r}setGeometry(e){this._gpuGeometry?.destroy();const t=e&&cO(this.device,e);if(t){this.setTopology(t.topology||"triangle-list");const r=new ym(this.bufferLayout);this.bufferLayout=r.mergeBufferLayouts(t.bufferLayout,this.bufferLayout),this.vertexArray&&this._setGeometryAttributes(t)}this._gpuGeometry=t}setTopology(e){e!==this.topology&&(this.topology=e,this._setPipelineNeedsUpdate("topology"))}setBufferLayout(e){const t=new ym(this.bufferLayout);this.bufferLayout=this._gpuGeometry?t.mergeBufferLayouts(e,this._gpuGeometry.bufferLayout):e,this._setPipelineNeedsUpdate("bufferLayout"),this.pipeline=this._updatePipeline(),this.vertexArray=this.device.createVertexArray({shaderLayout:this.pipeline.shaderLayout,bufferLayout:this.pipeline.bufferLayout}),this._gpuGeometry&&this._setGeometryAttributes(this._gpuGeometry)}setParameters(e){c_(e,this.parameters,2)||(this.parameters=e,this._setPipelineNeedsUpdate("parameters"))}setInstanceCount(e){this.instanceCount=e,this.isInstanced===void 0&&e>0&&(this.isInstanced=!0),this.setNeedsRedraw("instanceCount")}setVertexCount(e){this.vertexCount=e,this.setNeedsRedraw("vertexCount")}setShaderInputs(e){this.shaderInputs=e,this._uniformStore=new vP(this.shaderInputs.modules);for(const[t,r]of Object.entries(this.shaderInputs.modules))if(EO(r)){const s=this._uniformStore.getManagedUniformBuffer(this.device,t);this.bindings[`${t}Uniforms`]=s}this.setNeedsRedraw("shaderInputs")}updateShaderInputs(){this._uniformStore.setUniforms(this.shaderInputs.getUniformValues()),this.setBindings(this.shaderInputs.getBindingValues()),this.setNeedsRedraw("shaderInputs")}setBindings(e){Object.assign(this.bindings,e),this.setNeedsRedraw("bindings")}setTransformFeedback(e){this.transformFeedback=e,this.setNeedsRedraw("transformFeedback")}setIndexBuffer(e){this.vertexArray.setIndexBuffer(e),this.setNeedsRedraw("indexBuffer")}setAttributes(e,t){const r=t?.disableWarnings??this.props.disableWarnings;e.indices&&Qe.warn(`Model:${this.id} setAttributes() - indexBuffer should be set using setIndexBuffer()`)(),this.bufferLayout=pO(this.pipeline.shaderLayout,this.bufferLayout);const s=new ym(this.bufferLayout);for(const[a,u]of Object.entries(e)){const l=s.getBufferLayout(a);if(!l){r||Qe.warn(`Model(${this.id}): Missing layout for buffer "${a}".`)();continue}const g=s.getAttributeNamesForBuffer(l);let v=!1;for(const T of g){const S=this._attributeInfos[T];if(S){const P=this.device.type==="webgpu"?s.getBufferIndex(S.bufferName):S.location;this.vertexArray.setBuffer(P,u),v=!0}}!v&&!r&&Qe.warn(`Model(${this.id}): Ignoring buffer "${u.id}" for unknown attribute "${a}"`)()}this.setNeedsRedraw("attributes")}setConstantAttributes(e,t){for(const[r,s]of Object.entries(e)){const a=this._attributeInfos[r];a?this.vertexArray.setConstantWebGL(a.location,s):(t?.disableWarnings??this.props.disableWarnings)||Qe.warn(`Model "${this.id}: Ignoring constant supplied for unknown attribute "${r}"`)()}this.setNeedsRedraw("constants")}_areBindingsLoading(){for(const e of Object.values(this.bindings))if(e instanceof Th&&!e.isReady)return e.id;return!1}_getBindings(){const e={};for(const[t,r]of Object.entries(this.bindings))r instanceof Th?r.isReady&&(e[t]=r.texture):e[t]=r;return e}_getBindingsUpdateTimestamp(){let e=0;for(const t of Object.values(this.bindings))t instanceof gp?e=Math.max(e,t.texture.updateTimestamp):t instanceof Oi||t instanceof fr?e=Math.max(e,t.updateTimestamp):t instanceof Th?e=t.texture?Math.max(e,t.texture.updateTimestamp):1/0:t instanceof Xa||(e=Math.max(e,t.buffer.updateTimestamp));return e}_setGeometryAttributes(e){const t={...e.attributes};for(const[r]of Object.entries(t))!this.pipeline.shaderLayout.attributes.find(s=>s.name===r)&&r!=="positions"&&delete t[r];this.vertexCount=e.vertexCount,this.setIndexBuffer(e.indices||null),this.setAttributes(e.attributes,{disableWarnings:!0}),this.setAttributes(t,{disableWarnings:this.props.disableWarnings}),this.setNeedsRedraw("geometry attributes")}_setPipelineNeedsUpdate(e){this._pipelineNeedsUpdate||=e,this.setNeedsRedraw(e)}_updatePipeline(){if(this._pipelineNeedsUpdate){let e=null,t=null;this.pipeline&&(Qe.log(1,`Model ${this.id}: Recreating pipeline because "${this._pipelineNeedsUpdate}".`)(),e=this.pipeline.vs,t=this.pipeline.fs),this._pipelineNeedsUpdate=!1;const r=this.shaderFactory.createShader({id:`${this.id}-vertex`,stage:"vertex",source:this.source||this.vs,debugShaders:this.props.debugShaders});let s=null;this.source?s=r:this.fs&&(s=this.shaderFactory.createShader({id:`${this.id}-fragment`,stage:"fragment",source:this.source||this.fs,debugShaders:this.props.debugShaders})),this.pipeline=this.pipelineFactory.createRenderPipeline({...this.props,bufferLayout:this.bufferLayout,topology:this.topology,parameters:this.parameters,bindings:this._getBindings(),vs:r,fs:s}),this._attributeInfos=F1(this.pipeline.shaderLayout,this.bufferLayout),e&&this.shaderFactory.release(e),t&&this.shaderFactory.release(t)}return this.pipeline}_lastLogTime=0;_logOpen=!1;_logDrawCallStart(){const e=Qe.level>3?0:AO;Qe.level<2||Date.now()-this._lastLogTime<e||(this._lastLogTime=Date.now(),this._logOpen=!0,Qe.group(Ra,`>>> DRAWING MODEL ${this.id}`,{collapsed:Qe.level<=2})())}_logDrawCallEnd(){if(this._logOpen){const e=dO(this.pipeline.shaderLayout,this.id);Qe.table(Ra,e)();const t=this.shaderInputs.getDebugTable();Qe.table(Ra,t)();const r=this._getAttributeDebugTable();Qe.table(Ra,this._attributeInfos)(),Qe.table(Ra,r)(),Qe.groupEnd(Ra)(),this._logOpen=!1}}_drawCount=0;_logFramebuffer(e){const t=this.device.props.debugFramebuffers;if(this._drawCount++,!t)return;const r=e.props.framebuffer;r&&fO(r,{id:r.id,minimap:!0})}_getAttributeDebugTable(){const e={};for(const[t,r]of Object.entries(this._attributeInfos)){const s=this.vertexArray.attributes[r.location];e[r.location]={name:t,type:r.shaderType,values:s?this._getBufferOrConstantValues(s,r.bufferDataType):"null"}}if(this.vertexArray.indexBuffer){const{indexBuffer:t}=this.vertexArray,r=t.indexType==="uint32"?new Uint32Array(t.debugData):new Uint16Array(t.debugData);e.indices={name:"indices",type:t.indexType,values:r.toString()}}return e}_getBufferOrConstantValues(e,t){const r=H_(t);return(e instanceof Oi?new r(e.debugData):e).toString()}}function EO(i){return!!(i.uniformTypes&&!CO(i.uniformTypes))}function IO(i){return{type:i.type,shaderLanguage:i.info.shadingLanguage,shaderLanguageVersion:i.info.shadingLanguageVersion,gpu:i.info.gpu,features:i.features}}function CO(i){for(const e in i)return!1;return!0}class Sc{device;model;transformFeedback;static defaultProps={...Ks.defaultProps,outputs:void 0,feedbackBuffers:void 0};static isSupported(e){return e?.info?.type==="webgl"}constructor(e,t=Sc.defaultProps){if(!Sc.isSupported(e))throw new Error("BufferTransform not yet implemented on WebGPU");this.device=e,this.model=new Ks(this.device,{id:t.id||"buffer-transform-model",fs:t.fs||gC(),topology:t.topology||"point-list",varyings:t.outputs||t.varyings,...t}),this.transformFeedback=this.device.createTransformFeedback({layout:this.model.pipeline.shaderLayout,buffers:t.feedbackBuffers}),this.model.setTransformFeedback(this.transformFeedback),Object.seal(this)}destroy(){this.model&&this.model.destroy()}delete(){this.destroy()}run(e){e?.inputBuffers&&this.model.setAttributes(e.inputBuffers),e?.outputBuffers&&this.transformFeedback.setBuffers(e.outputBuffers);const t=this.device.beginRenderPass(e);this.model.draw(t),t.end()}getBuffer(e){return this.transformFeedback.getBuffer(e)}readAsync(e){const t=this.getBuffer(e);if(!t)throw new Error("BufferTransform#getBuffer");if(t instanceof Oi)return t.readAsync();const{buffer:r,byteOffset:s=0,byteLength:a=r.byteLength}=t;return r.readAsync(s,a)}}class Ac{id;topology;vertexCount;indices;attributes;userData={};constructor(e){const{attributes:t={},indices:r=null,vertexCount:s=null}=e;this.id=e.id||$h("geometry"),this.topology=e.topology,r&&(this.indices=ArrayBuffer.isView(r)?{value:r,size:1}:r),this.attributes={};for(const[a,u]of Object.entries(t)){const l=ArrayBuffer.isView(u)?{value:u}:u;if(!ArrayBuffer.isView(l.value))throw new Error(`${this._print(a)}: must be typed array or object with value as typed array`);if((a==="POSITION"||a==="positions")&&!l.size&&(l.size=3),a==="indices"){if(this.indices)throw new Error("Multiple indices detected");this.indices=l}else this.attributes[a]=l}this.indices&&this.indices.isIndexed!==void 0&&(this.indices=Object.assign({},this.indices),delete this.indices.isIndexed),this.vertexCount=s||this._calculateVertexCount(this.attributes,this.indices)}getVertexCount(){return this.vertexCount}getAttributes(){return this.indices?{indices:this.indices,...this.attributes}:this.attributes}_print(e){return`Geometry ${this.id} attribute ${e}`}_setAttributes(e,t){return this}_calculateVertexCount(e,t){if(t)return t.value.length;let r=1/0;for(const s of Object.values(e)){const{value:a,size:u,constant:l}=s;!l&&a&&u!==void 0&&u>=1&&(r=Math.min(r,a.length/u))}return r}}const PO={blendColorOperation:"add",blendColorSrcFactor:"one",blendColorDstFactor:"zero",blendAlphaOperation:"add",blendAlphaSrcFactor:"constant",blendAlphaDstFactor:"zero"};class W2 extends _y{constructor(){super(...arguments),this._colorEncoderState=null}render(e){return"pickingFBO"in e?this._drawPickingBuffer(e):super.render(e)}_drawPickingBuffer({layers:e,layerFilter:t,views:r,viewports:s,onViewportActive:a,pickingFBO:u,deviceRect:{x:l,y:g,width:v,height:T},cullRect:S,effects:P,pass:O="picking",pickZ:$,shaderModuleProps:W}){this.pickZ=$;const G=this._resetColorEncoder($),Q=[l,g,v,T],ae=super.render({target:u,layers:e,layerFilter:t,views:r,viewports:s,onViewportActive:a,cullRect:S,effects:P?.filter(me=>me.useInPicking),pass:O,isPicking:!0,shaderModuleProps:W,clearColor:[0,0,0,0],colorMask:15,scissorRect:Q});return this._colorEncoderState=null,{decodePickingColor:G&&RO.bind(null,G),stats:ae}}shouldDrawLayer(e){const{pickable:t,operation:r}=e.props;return t&&r.includes("draw")||r.includes("terrain")||r.includes("mask")}getShaderModuleProps(e,t,r){return{picking:{isActive:1,isAttribute:this.pickZ},lighting:{enabled:!1}}}getLayerParameters(e,t,r){const s={...e.props.parameters},{pickable:a,operation:u}=e.props;return!this._colorEncoderState||u.includes("terrain")?s.blend=!1:a&&u.includes("draw")&&(Object.assign(s,PO),s.blend=!0,s.blendColor=MO(this._colorEncoderState,e,r)),s}_resetColorEncoder(e){return this._colorEncoderState=e?null:{byLayer:new Map,byAlpha:[]},this._colorEncoderState}}function MO(i,e,t){const{byLayer:r,byAlpha:s}=i;let a,u=r.get(e);return u?(u.viewports.push(t),a=u.a):(a=r.size+1,a<=255?(u={a,layer:e,viewports:[t]},r.set(e,u),s[a]=u):(ni.warn("Too many pickable layers, only picking the first 255")(),a=0)),[0,0,0,a/255]}function RO(i,e){const t=i.byAlpha[e[3]];return t&&{pickedLayer:t.layer,pickedViewports:t.viewports,pickedObjectIndex:t.layer.decodePickingColor(e)}}const sc={NO_STATE:"Awaiting state",MATCHED:"Matched. State transferred from previous layer",INITIALIZED:"Initialized",AWAITING_GC:"Discarded. Awaiting garbage collection",AWAITING_FINALIZATION:"No longer matched. Awaiting garbage collection",FINALIZED:"Finalized! Awaiting garbage collection"},lp=Symbol.for("component"),ea=Symbol.for("propTypes"),xm=Symbol.for("deprecatedProps"),yc=Symbol.for("asyncPropDefaults"),Ka=Symbol.for("asyncPropOriginal"),Go=Symbol.for("asyncPropResolved");function xp(i,e=()=>!0){return Array.isArray(i)?H2(i,e,[]):e(i)?[i]:[]}function H2(i,e,t){let r=-1;for(;++r<i.length;){const s=i[r];Array.isArray(s)?H2(s,e,t):e(s)&&t.push(s)}return t}function kO({target:i,source:e,start:t=0,count:r=1}){const s=e.length,a=r*s;let u=0;for(let l=t;u<s;u++)i[l++]=e[u];for(;u<a;)u<a-u?(i.copyWithin(t+u,t,t+u),u*=2):(i.copyWithin(t+u,t,t+a-u),u=a);return i}class DO{constructor(e,t,r){this._loadCount=0,this._subscribers=new Set,this.id=e,this.context=r,this.setData(t)}subscribe(e){this._subscribers.add(e)}unsubscribe(e){this._subscribers.delete(e)}inUse(){return this._subscribers.size>0}delete(){}getData(){return this.isLoaded?this._error?Promise.reject(this._error):this._content:this._loader.then(()=>this.getData())}setData(e,t){if(e===this._data&&!t)return;this._data=e;const r=++this._loadCount;let s=e;typeof e=="string"&&(s=Zf(e)),s instanceof Promise?(this.isLoaded=!1,this._loader=s.then(a=>{this._loadCount===r&&(this.isLoaded=!0,this._error=void 0,this._content=a)}).catch(a=>{this._loadCount===r&&(this.isLoaded=!0,this._error=a||!0)})):(this.isLoaded=!0,this._error=void 0,this._content=e);for(const a of this._subscribers)a.onChange(this.getData())}}class OO{constructor(e){this.protocol=e.protocol||"resource://",this._context={device:e.device,gl:e.device?.gl,resourceManager:this},this._resources={},this._consumers={},this._pruneRequest=null}contains(e){return e.startsWith(this.protocol)?!0:e in this._resources}add({resourceId:e,data:t,forceUpdate:r=!1,persistent:s=!0}){let a=this._resources[e];a?a.setData(t,r):(a=new DO(e,t,this._context),this._resources[e]=a),a.persistent=s}remove(e){const t=this._resources[e];t&&(t.delete(),delete this._resources[e])}unsubscribe({consumerId:e}){const t=this._consumers[e];if(t){for(const r in t){const s=t[r],a=this._resources[s.resourceId];a&&a.unsubscribe(s)}delete this._consumers[e],this.prune()}}subscribe({resourceId:e,onChange:t,consumerId:r,requestId:s="default"}){const{_resources:a,protocol:u}=this;e.startsWith(u)&&(e=e.replace(u,""),a[e]||this.add({resourceId:e,data:null,persistent:!1}));const l=a[e];if(this._track(r,s,l,t),l)return l.getData()}prune(){this._pruneRequest||(this._pruneRequest=setTimeout(()=>this._prune(),0))}finalize(){for(const e in this._resources)this._resources[e].delete()}_track(e,t,r,s){const a=this._consumers,u=a[e]=a[e]||{};let l=u[t];const g=l&&l.resourceId&&this._resources[l.resourceId];g&&(g.unsubscribe(l),this.prune()),r&&(l?(l.onChange=s,l.resourceId=r.id):l={onChange:s,resourceId:r.id},u[t]=l,r.subscribe(l))}_prune(){this._pruneRequest=null;for(const e of Object.keys(this._resources)){const t=this._resources[e];!t.persistent&&!t.inUse()&&(t.delete(),delete this._resources[e])}}}const LO="layerManager.setLayers",FO="layerManager.activateViewport";class BO{constructor(e,t){this._lastRenderedLayers=[],this._needsRedraw=!1,this._needsUpdate=!1,this._nextLayers=null,this._debug=!1,this._defaultShaderModulesChanged=!1,this.activateViewport=l=>{Hr(FO,this,l),l&&(this.context.viewport=l)};const{deck:r,stats:s,viewport:a,timeline:u}=t||{};this.layers=[],this.resourceManager=new OO({device:e,protocol:"deck://"}),this.context={mousePosition:null,userData:{},layerManager:this,device:e,gl:e?.gl,deck:r,shaderAssembler:DD(e?.info?.shadingLanguage||"glsl"),defaultShaderModules:[VR],renderPass:void 0,stats:s||new zh({id:"deck.gl"}),viewport:a||new kc({id:"DEFAULT-INITIAL-VIEWPORT"}),timeline:u||new j2,resourceManager:this.resourceManager,onError:void 0},Object.seal(this)}finalize(){this.resourceManager.finalize();for(const e of this.layers)this._finalizeLayer(e)}needsRedraw(e={clearRedrawFlags:!1}){let t=this._needsRedraw;e.clearRedrawFlags&&(this._needsRedraw=!1);for(const r of this.layers){const s=r.getNeedsRedraw(e);t=t||s}return t}needsUpdate(){return this._nextLayers&&this._nextLayers!==this._lastRenderedLayers?"layers changed":this._defaultShaderModulesChanged?"shader modules changed":this._needsUpdate}setNeedsRedraw(e){this._needsRedraw=this._needsRedraw||e}setNeedsUpdate(e){this._needsUpdate=this._needsUpdate||e}getLayers({layerIds:e}={}){return e?this.layers.filter(t=>e.find(r=>t.id.indexOf(r)===0)):this.layers}setProps(e){"debug"in e&&(this._debug=e.debug),"userData"in e&&(this.context.userData=e.userData),"layers"in e&&(this._nextLayers=e.layers),"onError"in e&&(this.context.onError=e.onError)}setLayers(e,t){Hr(LO,this,t,e),this._lastRenderedLayers=e;const r=xp(e,Boolean);for(const s of r)s.context=this.context;this._updateLayers(this.layers,r)}updateLayers(){const e=this.needsUpdate();e&&(this.setNeedsRedraw(`updating layers: ${e}`),this.setLayers(this._nextLayers||this._lastRenderedLayers,e)),this._nextLayers=null}addDefaultShaderModule(e){const{defaultShaderModules:t}=this.context;t.find(r=>r.name===e.name)||(t.push(e),this._defaultShaderModulesChanged=!0)}removeDefaultShaderModule(e){const{defaultShaderModules:t}=this.context,r=t.findIndex(s=>s.name===e.name);r>=0&&(t.splice(r,1),this._defaultShaderModulesChanged=!0)}_handleError(e,t,r){r.raiseError(t,`${e} of ${r}`)}_updateLayers(e,t){const r={};for(const u of e)r[u.id]?ni.warn(`Multiple old layers with same id ${u.id}`)():r[u.id]=u;if(this._defaultShaderModulesChanged){for(const u of e)u.setNeedsUpdate(),u.setChangeFlags({extensionsChanged:!0});this._defaultShaderModulesChanged=!1}const s=[];this._updateSublayersRecursively(t,r,s),this._finalizeOldLayers(r);let a=!1;for(const u of s)if(u.hasUniformTransition()){a=`Uniform transition in ${u}`;break}this._needsUpdate=a,this.layers=s}_updateSublayersRecursively(e,t,r){for(const s of e){s.context=this.context;const a=t[s.id];a===null&&ni.warn(`Multiple new layers with same id ${s.id}`)(),t[s.id]=null;let u=null;try{this._debug&&a!==s&&s.validateProps(),a?(this._transferLayerState(a,s),this._updateLayer(s)):this._initializeLayer(s),r.push(s),u=s.isComposite?s.getSubLayers():null}catch(l){this._handleError("matching",l,s)}u&&this._updateSublayersRecursively(u,t,r)}}_finalizeOldLayers(e){for(const t in e){const r=e[t];r&&this._finalizeLayer(r)}}_initializeLayer(e){try{e._initialize(),e.lifecycle=sc.INITIALIZED}catch(t){this._handleError("initialization",t,e)}}_transferLayerState(e,t){t._transferState(e),t.lifecycle=sc.MATCHED,t!==e&&(e.lifecycle=sc.AWAITING_GC)}_updateLayer(e){try{e._update()}catch(t){this._handleError("update",t,e)}}_finalizeLayer(e){this._needsRedraw=this._needsRedraw||`finalized ${e}`,e.lifecycle=sc.AWAITING_FINALIZATION;try{e._finalize(),e.lifecycle=sc.FINALIZED}catch(t){this._handleError("finalization",t,e)}}}function Zs(i,e,t){if(i===e)return!0;if(!t||!i||!e)return!1;if(Array.isArray(i)){if(!Array.isArray(e)||i.length!==e.length)return!1;for(let r=0;r<i.length;r++)if(!Zs(i[r],e[r],t-1))return!1;return!0}if(Array.isArray(e))return!1;if(typeof i=="object"&&typeof e=="object"){const r=Object.keys(i),s=Object.keys(e);if(r.length!==s.length)return!1;for(const a of r)if(!e.hasOwnProperty(a)||!Zs(i[a],e[a],t-1))return!1;return!0}return!1}class NO{constructor(e){this.views=[],this.width=100,this.height=100,this.viewState={},this.controllers={},this.timeline=e.timeline,this._viewports=[],this._viewportMap={},this._isUpdating=!1,this._needsRedraw="First render",this._needsUpdate="Initialize",this._eventManager=e.eventManager,this._eventCallbacks={onViewStateChange:e.onViewStateChange,onInteractionStateChange:e.onInteractionStateChange},Object.seal(this),this.setProps(e)}finalize(){for(const e in this.controllers){const t=this.controllers[e];t&&t.finalize()}this.controllers={}}needsRedraw(e={clearRedrawFlags:!1}){const t=this._needsRedraw;return e.clearRedrawFlags&&(this._needsRedraw=!1),t}setNeedsUpdate(e){this._needsUpdate=this._needsUpdate||e,this._needsRedraw=this._needsRedraw||e}updateViewStates(){for(const e in this.controllers){const t=this.controllers[e];t&&t.updateTransition()}}getViewports(e){return e?this._viewports.filter(t=>t.containsPixel(e)):this._viewports}getViews(){const e={};return this.views.forEach(t=>{e[t.id]=t}),e}getView(e){return this.views.find(t=>t.id===e)}getViewState(e){const t=typeof e=="string"?this.getView(e):e,r=t&&this.viewState[t.getViewStateId()]||this.viewState;return t?t.filterViewState(r):r}getViewport(e){return this._viewportMap[e]}unproject(e,t){const r=this.getViewports(),s={x:e[0],y:e[1]};for(let a=r.length-1;a>=0;--a){const u=r[a];if(u.containsPixel(s)){const l=e.slice();return l[0]-=u.x,l[1]-=u.y,u.unproject(l,t)}}return null}setProps(e){e.views&&this._setViews(e.views),e.viewState&&this._setViewState(e.viewState),("width"in e||"height"in e)&&this._setSize(e.width,e.height),this._isUpdating||this._update()}_update(){this._isUpdating=!0,this._needsUpdate&&(this._needsUpdate=!1,this._rebuildViewports()),this._needsUpdate&&(this._needsUpdate=!1,this._rebuildViewports()),this._isUpdating=!1}_setSize(e,t){(e!==this.width||t!==this.height)&&(this.width=e,this.height=t,this.setNeedsUpdate("Size changed"))}_setViews(e){e=xp(e,Boolean),this._diffViews(e,this.views)&&this.setNeedsUpdate("views changed"),this.views=e}_setViewState(e){e?(!Zs(e,this.viewState,3)&&this.setNeedsUpdate("viewState changed"),this.viewState=e):ni.warn("missing `viewState` or `initialViewState`")()}_createController(e,t){const r=t.type;return new r({timeline:this.timeline,eventManager:this._eventManager,onViewStateChange:this._eventCallbacks.onViewStateChange,onStateChange:this._eventCallbacks.onInteractionStateChange,makeViewport:a=>this.getView(e.id)?.makeViewport({viewState:a,width:this.width,height:this.height})})}_updateController(e,t,r,s){const a=e.controller;if(a&&r){const u={...t,...a,id:e.id,x:r.x,y:r.y,width:r.width,height:r.height};return(!s||s.constructor!==a.type)&&(s=this._createController(e,u)),s&&s.setProps(u),s}return null}_rebuildViewports(){const{views:e}=this,t=this.controllers;this._viewports=[],this.controllers={};let r=!1;for(let s=e.length;s--;){const a=e[s],u=this.getViewState(a),l=a.makeViewport({viewState:u,width:this.width,height:this.height});let g=t[a.id];const v=!!a.controller;v&&!g&&(r=!0),(r||!v)&&g&&(g.finalize(),g=null),this.controllers[a.id]=this._updateController(a,u,l,g),l&&this._viewports.unshift(l)}for(const s in t){const a=t[s];a&&!this.controllers[s]&&a.finalize()}this._buildViewportMap()}_buildViewportMap(){this._viewportMap={},this._viewports.forEach(e=>{e.id&&(this._viewportMap[e.id]=this._viewportMap[e.id]||e)})}_diffViews(e,t){return e.length!==t.length?!0:e.some((r,s)=>!e[s].equals(t[s]))}}const zO=/([0-9]+\.?[0-9]*)(%|px)/;function zo(i){switch(typeof i){case"number":return{position:i,relative:!1};case"string":const e=zO.exec(i);if(e&&e.length>=3){const t=e[2]==="%",r=parseFloat(e[1]);return{position:t?r/100:r,relative:t}}default:throw new Error(`Could not parse position string ${i}`)}}function Uo(i,e){return i.relative?Math.round(i.position*e):i.position}class Ec{constructor(e){const{id:t,x:r=0,y:s=0,width:a="100%",height:u="100%",padding:l=null}=e;this.id=t||this.constructor.displayName||"view",this.props={...e,id:this.id},this._x=zo(r),this._y=zo(s),this._width=zo(a),this._height=zo(u),this._padding=l&&{left:zo(l.left||0),right:zo(l.right||0),top:zo(l.top||0),bottom:zo(l.bottom||0)},this.equals=this.equals.bind(this),Object.seal(this)}equals(e){return this===e?!0:this.constructor===e.constructor&&Zs(this.props,e.props,2)}clone(e){const t=this.constructor;return new t({...this.props,...e})}makeViewport({width:e,height:t,viewState:r}){r=this.filterViewState(r);const s=this.getDimensions({width:e,height:t});if(!s.height||!s.width)return null;const a=this.getViewportType(r);return new a({...r,...this.props,...s})}getViewStateId(){const{viewState:e}=this.props;return typeof e=="string"?e:e?.id||this.id}filterViewState(e){if(this.props.viewState&&typeof this.props.viewState=="object"){if(!this.props.viewState.id)return this.props.viewState;const t={...e};for(const r in this.props.viewState)r!=="id"&&(t[r]=this.props.viewState[r]);return t}return e}getDimensions({width:e,height:t}){const r={x:Uo(this._x,e),y:Uo(this._y,t),width:Uo(this._width,e),height:Uo(this._height,t)};return this._padding&&(r.padding={left:Uo(this._padding.left,e),top:Uo(this._padding.top,t),right:Uo(this._padding.right,e),bottom:Uo(this._padding.bottom,t)}),r}get controller(){const e=this.props.controller;return e?e===!0?{type:this.ControllerType}:typeof e=="function"?{type:e}:{type:this.ControllerType,...e}:null}}class vp{constructor(e){this._inProgress=!1,this._handle=null,this.time=0,this.settings={duration:0},this._timeline=e}get inProgress(){return this._inProgress}start(e){this.cancel(),this.settings=e,this._inProgress=!0,this.settings.onStart?.(this)}end(){this._inProgress&&(this._timeline.removeChannel(this._handle),this._handle=null,this._inProgress=!1,this.settings.onEnd?.(this))}cancel(){this._inProgress&&(this.settings.onInterrupt?.(this),this._timeline.removeChannel(this._handle),this._handle=null,this._inProgress=!1)}update(){if(!this._inProgress)return!1;if(this._handle===null){const{_timeline:e,settings:t}=this;this._handle=e.addChannel({delay:e.getTime(),duration:t.duration})}return this.time=this._timeline.getTime(this._handle),this._onUpdate(),this.settings.onUpdate?.(this),this._timeline.isFinished(this._handle)&&this.end(),!0}_onUpdate(){}}const o0=()=>{},u_={BREAK:1,SNAP_TO_END:2,IGNORE:3},UO=i=>i,VO=u_.BREAK;class jO{constructor(e){this._onTransitionUpdate=t=>{const{time:r,settings:{interpolator:s,startProps:a,endProps:u,duration:l,easing:g}}=t,v=g(r/l),T=s.interpolateProps(a,u,v);this.propsInTransition=this.getControllerState({...this.props,...T}).getViewportProps(),this.onViewStateChange({viewState:this.propsInTransition,oldViewState:this.props})},this.getControllerState=e.getControllerState,this.propsInTransition=null,this.transition=new vp(e.timeline),this.onViewStateChange=e.onViewStateChange||o0,this.onStateChange=e.onStateChange||o0}finalize(){this.transition.cancel()}getViewportInTransition(){return this.propsInTransition}processViewStateChange(e){let t=!1;const r=this.props;if(this.props=e,!r||this._shouldIgnoreViewportChange(r,e))return!1;if(this._isTransitionEnabled(e)){let s=r;if(this.transition.inProgress){const{interruption:a,endProps:u}=this.transition.settings;s={...r,...a===u_.SNAP_TO_END?u:this.propsInTransition||r}}this._triggerTransition(s,e),t=!0}else this.transition.cancel();return t}updateTransition(){this.transition.update()}_isTransitionEnabled(e){const{transitionDuration:t,transitionInterpolator:r}=e;return(t>0||t==="auto")&&!!r}_isUpdateDueToCurrentTransition(e){return this.transition.inProgress&&this.propsInTransition?this.transition.settings.interpolator.arePropsEqual(e,this.propsInTransition):!1}_shouldIgnoreViewportChange(e,t){return this.transition.inProgress?this.transition.settings.interruption===u_.IGNORE||this._isUpdateDueToCurrentTransition(t):this._isTransitionEnabled(t)?t.transitionInterpolator.arePropsEqual(e,t):!0}_triggerTransition(e,t){const r=this.getControllerState(e),s=this.getControllerState(t).shortestPathFrom(r),a=t.transitionInterpolator,u=a.getDuration?a.getDuration(e,t):t.transitionDuration;if(u===0)return;const l=a.initializeProps(e,s);this.propsInTransition={};const g={duration:u,easing:t.transitionEasing||UO,interpolator:a,interruption:t.transitionInterruption||VO,startProps:l.start,endProps:l.end,onStart:t.onTransitionStart,onUpdate:this._onTransitionUpdate,onInterrupt:this._onTransitionEnd(t.onTransitionInterrupt),onEnd:this._onTransitionEnd(t.onTransitionEnd)};this.transition.start(g),this.onStateChange({inTransition:!0}),this.updateTransition()}_onTransitionEnd(e){return t=>{this.propsInTransition=null,this.onStateChange({inTransition:!1,isZooming:!1,isPanning:!1,isRotating:!1}),e?.(t)}}}function Pr(i,e){if(!i)throw new Error(e||"deck.gl: assertion failed.")}class $O{constructor(e){const{compare:t,extract:r,required:s}=e;this._propsToCompare=t,this._propsToExtract=r||t,this._requiredProps=s}arePropsEqual(e,t){for(const r of this._propsToCompare)if(!(r in e)||!(r in t)||!eo(e[r],t[r]))return!1;return!0}initializeProps(e,t){const r={},s={};for(const a of this._propsToExtract)(a in e||a in t)&&(r[a]=e[a],s[a]=t[a]);return this._checkRequiredProps(r),this._checkRequiredProps(s),{start:r,end:s}}getDuration(e,t){return t.transitionDuration}_checkRequiredProps(e){this._requiredProps&&this._requiredProps.forEach(t=>{const r=e[t];Pr(Number.isFinite(r)||Array.isArray(r),`${t} is required for transition`)})}}const WO=["longitude","latitude","zoom","bearing","pitch"],HO=["longitude","latitude","zoom"];class q2 extends $O{constructor(e={}){const t=Array.isArray(e)?e:e.transitionProps,r=Array.isArray(e)?{}:e;r.transitionProps=Array.isArray(t)?{compare:t,required:t}:t||{compare:WO,required:HO},super(r.transitionProps),this.opts=r}initializeProps(e,t){const r=super.initializeProps(e,t),{makeViewport:s,around:a}=this.opts;if(s&&a){const u=s(e),l=s(t),g=u.unproject(a);r.start.around=a,Object.assign(r.end,{around:l.project(g),aroundPosition:g,width:t.width,height:t.height})}return r}interpolateProps(e,t,r){const s={};for(const a of this._propsToExtract)s[a]=ja(e[a]||0,t[a]||0,r);if(t.aroundPosition&&this.opts.makeViewport){const a=this.opts.makeViewport({...t,...s});Object.assign(s,a.panByPosition(t.aroundPosition,ja(e.around,t.around,r)))}return s}}const Zn={transitionDuration:0},qO=300,lf=i=>1-(1-i)*(1-i),tc={WHEEL:["wheel"],PAN:["panstart","panmove","panend"],PINCH:["pinchstart","pinchmove","pinchend"],MULTI_PAN:["multipanstart","multipanmove","multipanend"],DOUBLE_CLICK:["dblclick"],KEYBOARD:["keydown"]},ka={};class XO{constructor(e){this.state={},this._events={},this._interactionState={isDragging:!1},this._customEvents=[],this._eventStartBlocked=null,this._panMove=!1,this.invertPan=!1,this.dragMode="rotate",this.inertia=0,this.scrollZoom=!0,this.dragPan=!0,this.dragRotate=!0,this.doubleClickZoom=!0,this.touchZoom=!0,this.touchRotate=!1,this.keyboard=!0,this.transitionManager=new jO({...e,getControllerState:t=>new this.ControllerState(t),onViewStateChange:this._onTransition.bind(this),onStateChange:this._setInteractionState.bind(this)}),this.handleEvent=this.handleEvent.bind(this),this.eventManager=e.eventManager,this.onViewStateChange=e.onViewStateChange||(()=>{}),this.onStateChange=e.onStateChange||(()=>{}),this.makeViewport=e.makeViewport}set events(e){this.toggleEvents(this._customEvents,!1),this.toggleEvents(e,!0),this._customEvents=e,this.props&&this.setProps(this.props)}finalize(){for(const e in this._events)this._events[e]&&this.eventManager?.off(e,this.handleEvent);this.transitionManager.finalize()}handleEvent(e){this._controllerState=void 0;const t=this._eventStartBlocked;switch(e.type){case"panstart":return t?!1:this._onPanStart(e);case"panmove":return this._onPan(e);case"panend":return this._onPanEnd(e);case"pinchstart":return t?!1:this._onPinchStart(e);case"pinchmove":return this._onPinch(e);case"pinchend":return this._onPinchEnd(e);case"multipanstart":return t?!1:this._onMultiPanStart(e);case"multipanmove":return this._onMultiPan(e);case"multipanend":return this._onMultiPanEnd(e);case"dblclick":return this._onDoubleClick(e);case"wheel":return this._onWheel(e);case"keydown":return this._onKeyDown(e);default:return!1}}get controllerState(){return this._controllerState=this._controllerState||new this.ControllerState({makeViewport:this.makeViewport,...this.props,...this.state}),this._controllerState}getCenter(e){const{x:t,y:r}=this.props,{offsetCenter:s}=e;return[s.x-t,s.y-r]}isPointInBounds(e,t){const{width:r,height:s}=this.props;if(t&&t.handled)return!1;const a=e[0]>=0&&e[0]<=r&&e[1]>=0&&e[1]<=s;return a&&t&&t.stopPropagation(),a}isFunctionKeyPressed(e){const{srcEvent:t}=e;return!!(t.metaKey||t.altKey||t.ctrlKey||t.shiftKey)}isDragging(){return this._interactionState.isDragging||!1}blockEvents(e){const t=setTimeout(()=>{this._eventStartBlocked===t&&(this._eventStartBlocked=null)},e);this._eventStartBlocked=t}setProps(e){e.dragMode&&(this.dragMode=e.dragMode),this.props=e,"transitionInterpolator"in e||(e.transitionInterpolator=this._getTransitionProps().transitionInterpolator),this.transitionManager.processViewStateChange(e);const{inertia:t}=e;this.inertia=Number.isFinite(t)?t:t===!0?qO:0;const{scrollZoom:r=!0,dragPan:s=!0,dragRotate:a=!0,doubleClickZoom:u=!0,touchZoom:l=!0,touchRotate:g=!1,keyboard:v=!0}=e,T=!!this.onViewStateChange;this.toggleEvents(tc.WHEEL,T&&r),this.toggleEvents(tc.PAN,T),this.toggleEvents(tc.PINCH,T&&(l||g)),this.toggleEvents(tc.MULTI_PAN,T&&g),this.toggleEvents(tc.DOUBLE_CLICK,T&&u),this.toggleEvents(tc.KEYBOARD,T&&v),this.scrollZoom=r,this.dragPan=s,this.dragRotate=a,this.doubleClickZoom=u,this.touchZoom=l,this.touchRotate=g,this.keyboard=v}updateTransition(){this.transitionManager.updateTransition()}toggleEvents(e,t){this.eventManager&&e.forEach(r=>{this._events[r]!==t&&(this._events[r]=t,t?this.eventManager.on(r,this.handleEvent):this.eventManager.off(r,this.handleEvent))})}updateViewport(e,t=null,r={}){const s={...e.getViewportProps(),...t},a=this.controllerState!==e;if(this.state=e.getState(),this._setInteractionState(r),a){const u=this.controllerState&&this.controllerState.getViewportProps();this.onViewStateChange&&this.onViewStateChange({viewState:s,interactionState:this._interactionState,oldViewState:u,viewId:this.props.id})}}_onTransition(e){this.onViewStateChange({...e,interactionState:this._interactionState,viewId:this.props.id})}_setInteractionState(e){Object.assign(this._interactionState,e),this.onStateChange(this._interactionState)}_onPanStart(e){const t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;let r=this.isFunctionKeyPressed(e)||e.rightButton||!1;(this.invertPan||this.dragMode==="pan")&&(r=!r);const s=this.controllerState[r?"panStart":"rotateStart"]({pos:t});return this._panMove=r,this.updateViewport(s,Zn,{isDragging:!0}),!0}_onPan(e){return this.isDragging()?this._panMove?this._onPanMove(e):this._onPanRotate(e):!1}_onPanEnd(e){return this.isDragging()?this._panMove?this._onPanMoveEnd(e):this._onPanRotateEnd(e):!1}_onPanMove(e){if(!this.dragPan)return!1;const t=this.getCenter(e),r=this.controllerState.pan({pos:t});return this.updateViewport(r,Zn,{isDragging:!0,isPanning:!0}),!0}_onPanMoveEnd(e){const{inertia:t}=this;if(this.dragPan&&t&&e.velocity){const r=this.getCenter(e),s=[r[0]+e.velocityX*t/2,r[1]+e.velocityY*t/2],a=this.controllerState.pan({pos:s}).panEnd();this.updateViewport(a,{...this._getTransitionProps(),transitionDuration:t,transitionEasing:lf},{isDragging:!1,isPanning:!0})}else{const r=this.controllerState.panEnd();this.updateViewport(r,null,{isDragging:!1,isPanning:!1})}return!0}_onPanRotate(e){if(!this.dragRotate)return!1;const t=this.getCenter(e),r=this.controllerState.rotate({pos:t});return this.updateViewport(r,Zn,{isDragging:!0,isRotating:!0}),!0}_onPanRotateEnd(e){const{inertia:t}=this;if(this.dragRotate&&t&&e.velocity){const r=this.getCenter(e),s=[r[0]+e.velocityX*t/2,r[1]+e.velocityY*t/2],a=this.controllerState.rotate({pos:s}).rotateEnd();this.updateViewport(a,{...this._getTransitionProps(),transitionDuration:t,transitionEasing:lf},{isDragging:!1,isRotating:!0})}else{const r=this.controllerState.rotateEnd();this.updateViewport(r,null,{isDragging:!1,isRotating:!1})}return!0}_onWheel(e){if(!this.scrollZoom)return!1;const t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;e.srcEvent.preventDefault();const{speed:r=.01,smooth:s=!1}=this.scrollZoom===!0?{}:this.scrollZoom,{delta:a}=e;let u=2/(1+Math.exp(-Math.abs(a*r)));a<0&&u!==0&&(u=1/u);const l=s?{...this._getTransitionProps({around:t}),transitionDuration:250}:Zn,g=this.controllerState.zoom({pos:t,scale:u});return this.updateViewport(g,l,{isZooming:!0,isPanning:!0}),!0}_onMultiPanStart(e){const t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;const r=this.controllerState.rotateStart({pos:t});return this.updateViewport(r,Zn,{isDragging:!0}),!0}_onMultiPan(e){if(!this.touchRotate||!this.isDragging())return!1;const t=this.getCenter(e);t[0]-=e.deltaX;const r=this.controllerState.rotate({pos:t});return this.updateViewport(r,Zn,{isDragging:!0,isRotating:!0}),!0}_onMultiPanEnd(e){if(!this.isDragging())return!1;const{inertia:t}=this;if(this.touchRotate&&t&&e.velocityY){const r=this.getCenter(e),s=[r[0],r[1]+=e.velocityY*t/2],a=this.controllerState.rotate({pos:s});this.updateViewport(a,{...this._getTransitionProps(),transitionDuration:t,transitionEasing:lf},{isDragging:!1,isRotating:!0}),this.blockEvents(t)}else{const r=this.controllerState.rotateEnd();this.updateViewport(r,null,{isDragging:!1,isRotating:!1})}return!0}_onPinchStart(e){const t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;const r=this.controllerState.zoomStart({pos:t}).rotateStart({pos:t});return ka._startPinchRotation=e.rotation,ka._lastPinchEvent=e,this.updateViewport(r,Zn,{isDragging:!0}),!0}_onPinch(e){if(!this.touchZoom&&!this.touchRotate||!this.isDragging())return!1;let t=this.controllerState;if(this.touchZoom){const{scale:r}=e,s=this.getCenter(e);t=t.zoom({pos:s,scale:r})}if(this.touchRotate){const{rotation:r}=e;t=t.rotate({deltaAngleX:ka._startPinchRotation-r})}return this.updateViewport(t,Zn,{isDragging:!0,isPanning:this.touchZoom,isZooming:this.touchZoom,isRotating:this.touchRotate}),ka._lastPinchEvent=e,!0}_onPinchEnd(e){if(!this.isDragging())return!1;const{inertia:t}=this,{_lastPinchEvent:r}=ka;if(this.touchZoom&&t&&r&&e.scale!==r.scale){const s=this.getCenter(e);let a=this.controllerState.rotateEnd();const u=Math.log2(e.scale),l=(u-Math.log2(r.scale))/(e.deltaTime-r.deltaTime),g=Math.pow(2,u+l*t/2);a=a.zoom({pos:s,scale:g}).zoomEnd(),this.updateViewport(a,{...this._getTransitionProps({around:s}),transitionDuration:t,transitionEasing:lf},{isDragging:!1,isPanning:this.touchZoom,isZooming:this.touchZoom,isRotating:!1}),this.blockEvents(t)}else{const s=this.controllerState.zoomEnd().rotateEnd();this.updateViewport(s,null,{isDragging:!1,isPanning:!1,isZooming:!1,isRotating:!1})}return ka._startPinchRotation=null,ka._lastPinchEvent=null,!0}_onDoubleClick(e){if(!this.doubleClickZoom)return!1;const t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;const r=this.isFunctionKeyPressed(e),s=this.controllerState.zoom({pos:t,scale:r?.5:2});return this.updateViewport(s,this._getTransitionProps({around:t}),{isZooming:!0,isPanning:!0}),this.blockEvents(100),!0}_onKeyDown(e){if(!this.keyboard)return!1;const t=this.isFunctionKeyPressed(e),{zoomSpeed:r,moveSpeed:s,rotateSpeedX:a,rotateSpeedY:u}=this.keyboard===!0?{}:this.keyboard,{controllerState:l}=this;let g;const v={};switch(e.srcEvent.code){case"Minus":g=t?l.zoomOut(r).zoomOut(r):l.zoomOut(r),v.isZooming=!0;break;case"Equal":g=t?l.zoomIn(r).zoomIn(r):l.zoomIn(r),v.isZooming=!0;break;case"ArrowLeft":t?(g=l.rotateLeft(a),v.isRotating=!0):(g=l.moveLeft(s),v.isPanning=!0);break;case"ArrowRight":t?(g=l.rotateRight(a),v.isRotating=!0):(g=l.moveRight(s),v.isPanning=!0);break;case"ArrowUp":t?(g=l.rotateUp(u),v.isRotating=!0):(g=l.moveUp(s),v.isPanning=!0);break;case"ArrowDown":t?(g=l.rotateDown(u),v.isRotating=!0):(g=l.moveDown(s),v.isPanning=!0);break;default:return!1}return this.updateViewport(g,this._getTransitionProps(),v),!0}_getTransitionProps(e){const{transition:t}=this;return!t||!t.transitionInterpolator?Zn:e?{...t,transitionInterpolator:new q2({...e,...t.transitionInterpolator.opts,makeViewport:this.controllerState.makeViewport})}:t}}class ZO{constructor(e,t){this._viewportProps=this.applyConstraints(e),this._state=t}getViewportProps(){return this._viewportProps}getState(){return this._state}}const a0=5,YO=1.2;class GO extends ZO{constructor(e){const{width:t,height:r,latitude:s,longitude:a,zoom:u,bearing:l=0,pitch:g=0,altitude:v=1.5,position:T=[0,0,0],maxZoom:S=20,minZoom:P=0,maxPitch:O=60,minPitch:$=0,startPanLngLat:W,startZoomLngLat:G,startRotatePos:Q,startBearing:ae,startPitch:te,startZoom:me,normalize:we=!0}=e;Pr(Number.isFinite(a)),Pr(Number.isFinite(s)),Pr(Number.isFinite(u)),super({width:t,height:r,latitude:s,longitude:a,zoom:u,bearing:l,pitch:g,altitude:v,maxZoom:S,minZoom:P,maxPitch:O,minPitch:$,normalize:we,position:T},{startPanLngLat:W,startZoomLngLat:G,startRotatePos:Q,startBearing:ae,startPitch:te,startZoom:me}),this.makeViewport=e.makeViewport}panStart({pos:e}){return this._getUpdatedState({startPanLngLat:this._unproject(e)})}pan({pos:e,startPos:t}){const r=this.getState().startPanLngLat||this._unproject(t);if(!r)return this;const a=this.makeViewport(this.getViewportProps()).panByPosition(r,e);return this._getUpdatedState(a)}panEnd(){return this._getUpdatedState({startPanLngLat:null})}rotateStart({pos:e}){return this._getUpdatedState({startRotatePos:e,startBearing:this.getViewportProps().bearing,startPitch:this.getViewportProps().pitch})}rotate({pos:e,deltaAngleX:t=0,deltaAngleY:r=0}){const{startRotatePos:s,startBearing:a,startPitch:u}=this.getState();if(!s||a===void 0||u===void 0)return this;let l;return e?l=this._getNewRotation(e,s,u,a):l={bearing:a+t,pitch:u+r},this._getUpdatedState(l)}rotateEnd(){return this._getUpdatedState({startBearing:null,startPitch:null})}zoomStart({pos:e}){return this._getUpdatedState({startZoomLngLat:this._unproject(e),startZoom:this.getViewportProps().zoom})}zoom({pos:e,startPos:t,scale:r}){let{startZoom:s,startZoomLngLat:a}=this.getState();if(a||(s=this.getViewportProps().zoom,a=this._unproject(t)||this._unproject(e)),!a)return this;const{maxZoom:u,minZoom:l}=this.getViewportProps();let g=s+Math.log2(r);g=Yo(g,l,u);const v=this.makeViewport({...this.getViewportProps(),zoom:g});return this._getUpdatedState({zoom:g,...v.panByPosition(a,e)})}zoomEnd(){return this._getUpdatedState({startZoomLngLat:null,startZoom:null})}zoomIn(e=2){return this._zoomFromCenter(e)}zoomOut(e=2){return this._zoomFromCenter(1/e)}moveLeft(e=100){return this._panFromCenter([e,0])}moveRight(e=100){return this._panFromCenter([-e,0])}moveUp(e=100){return this._panFromCenter([0,e])}moveDown(e=100){return this._panFromCenter([0,-e])}rotateLeft(e=15){return this._getUpdatedState({bearing:this.getViewportProps().bearing-e})}rotateRight(e=15){return this._getUpdatedState({bearing:this.getViewportProps().bearing+e})}rotateUp(e=10){return this._getUpdatedState({pitch:this.getViewportProps().pitch+e})}rotateDown(e=10){return this._getUpdatedState({pitch:this.getViewportProps().pitch-e})}shortestPathFrom(e){const t=e.getViewportProps(),r={...this.getViewportProps()},{bearing:s,longitude:a}=r;return Math.abs(s-t.bearing)>180&&(r.bearing=s<0?s+360:s-360),Math.abs(a-t.longitude)>180&&(r.longitude=a<0?a+360:a-360),r}applyConstraints(e){const{maxZoom:t,minZoom:r,zoom:s}=e;e.zoom=Yo(s,r,t);const{maxPitch:a,minPitch:u,pitch:l}=e;e.pitch=Yo(l,u,a);const{normalize:g=!0}=e;return g&&Object.assign(e,_D(e)),e}_zoomFromCenter(e){const{width:t,height:r}=this.getViewportProps();return this.zoom({pos:[t/2,r/2],scale:e})}_panFromCenter(e){const{width:t,height:r}=this.getViewportProps();return this.pan({startPos:[t/2,r/2],pos:[t/2+e[0],r/2+e[1]]})}_getUpdatedState(e){return new this.constructor({makeViewport:this.makeViewport,...this.getViewportProps(),...this.getState(),...e})}_unproject(e){const t=this.makeViewport(this.getViewportProps());return e&&t.unproject(e)}_getNewRotation(e,t,r,s){const a=e[0]-t[0],u=e[1]-t[1],l=e[1],g=t[1],{width:v,height:T}=this.getViewportProps(),S=a/v;let P=0;u>0?Math.abs(T-g)>a0&&(P=u/(g-T)*YO):u<0&&g>a0&&(P=1-l/g),P=Yo(P,-1,1);const{minPitch:O,maxPitch:$}=this.getViewportProps(),W=s+180*S;let G=r;return P>0?G=r+P*($-r):P<0&&(G=r-P*(O-r)),{pitch:G,bearing:W}}}class KO extends XO{constructor(){super(...arguments),this.ControllerState=GO,this.transition={transitionDuration:300,transitionInterpolator:new q2({transitionProps:{compare:["longitude","latitude","zoom","bearing","pitch","position"],required:["longitude","latitude","zoom"]}})},this.dragMode="pan"}setProps(e){e.position=e.position||[0,0,0];const t=this.props;super.setProps(e),(!t||t.height!==e.height)&&this.updateViewport(new this.ControllerState({makeViewport:this.makeViewport,...e,...this.state}))}}class X2 extends Ec{constructor(e={}){super(e)}getViewportType(){return ra}get ControllerType(){return KO}}X2.displayName="MapView";const JO=new U2;function QO(i,e){const t=i.order??1/0,r=e.order??1/0;return t-r}class eL{constructor(e){this._resolvedEffects=[],this._defaultEffects=[],this.effects=[],this._context=e,this._needsRedraw="Initial render",this._setEffects([])}addDefaultEffect(e){const t=this._defaultEffects;if(!t.find(r=>r.id===e.id)){const r=t.findIndex(s=>QO(s,e)>0);r<0?t.push(e):t.splice(r,0,e),e.setup(this._context),this._setEffects(this.effects)}}setProps(e){"effects"in e&&(Zs(e.effects,this.effects,1)||this._setEffects(e.effects))}needsRedraw(e={clearRedrawFlags:!1}){const t=this._needsRedraw;return e.clearRedrawFlags&&(this._needsRedraw=!1),t}getEffects(){return this._resolvedEffects}_setEffects(e){const t={};for(const s of this.effects)t[s.id]=s;const r=[];for(const s of e){const a=t[s.id];let u=s;a&&a!==s?a.setProps?(a.setProps(s.props),u=a):a.cleanup(this._context):a||s.setup(this._context),r.push(u),delete t[s.id]}for(const s in t)t[s].cleanup(this._context);this.effects=r,this._resolvedEffects=r.concat(this._defaultEffects),e.some(s=>s instanceof U2)||this._resolvedEffects.push(JO),this._needsRedraw="effects changed"}finalize(){for(const e of this._resolvedEffects)e.cleanup(this._context);this.effects.length=0,this._resolvedEffects.length=0,this._defaultEffects.length=0}}class tL extends _y{shouldDrawLayer(e){const{operation:t}=e.props;return t.includes("draw")||t.includes("terrain")}}const iL="deckRenderer.renderLayers";class rL{constructor(e){this.device=e,this.layerFilter=null,this.drawPickingColors=!1,this.drawLayersPass=new tL(e),this.pickLayersPass=new W2(e),this.renderCount=0,this._needsRedraw="Initial render",this.renderBuffers=[],this.lastPostProcessEffect=null}setProps(e){this.layerFilter!==e.layerFilter&&(this.layerFilter=e.layerFilter,this._needsRedraw="layerFilter changed"),this.drawPickingColors!==e.drawPickingColors&&(this.drawPickingColors=e.drawPickingColors,this._needsRedraw="drawPickingColors changed")}renderLayers(e){if(!e.viewports.length)return;const t=this.drawPickingColors?this.pickLayersPass:this.drawLayersPass,r={layerFilter:this.layerFilter,isPicking:this.drawPickingColors,...e};r.effects&&this._preRender(r.effects,r);const s=this.lastPostProcessEffect?this.renderBuffers[0]:r.target;this.lastPostProcessEffect&&(r.clearColor=[0,0,0,0],r.clearCanvas=!0);const a=t.render({...r,target:s});r.effects&&(this.lastPostProcessEffect&&(r.clearCanvas=e.clearCanvas===void 0?!0:e.clearCanvas),this._postRender(r.effects,r)),this.renderCount++,Hr(iL,this,a,e)}needsRedraw(e={clearRedrawFlags:!1}){const t=this._needsRedraw;return e.clearRedrawFlags&&(this._needsRedraw=!1),t}finalize(){const{renderBuffers:e}=this;for(const t of e)t.delete();e.length=0}_preRender(e,t){this.lastPostProcessEffect=null,t.preRenderStats=t.preRenderStats||{};for(const r of e)t.preRenderStats[r.id]=r.preRender(t),r.postRender&&(this.lastPostProcessEffect=r.id);this.lastPostProcessEffect&&this._resizeRenderBuffers()}_resizeRenderBuffers(){const{renderBuffers:e}=this,t=this.device.canvasContext.getDrawingBufferSize(),[r,s]=t;e.length===0&&[0,1].map(a=>{const u=this.device.createTexture({sampler:{minFilter:"linear",magFilter:"linear"},width:r,height:s});e.push(this.device.createFramebuffer({id:`deck-renderbuffer-${a}`,colorAttachments:[u]}))});for(const a of e)a.resize(t)}_postRender(e,t){const{renderBuffers:r}=this,s={...t,inputBuffer:r[0],swapBuffer:r[1]};for(const a of e)if(a.postRender){s.target=a.id===this.lastPostProcessEffect?t.target:void 0;const u=a.postRender(s);s.inputBuffer=u,s.swapBuffer=u===r[0]?r[1]:r[0]}}}const sL={pickedColor:null,pickedObjectIndex:-1};function l0({pickedColors:i,decodePickingColor:e,deviceX:t,deviceY:r,deviceRadius:s,deviceRect:a}){const{x:u,y:l,width:g,height:v}=a;let T=s*s,S=-1,P=0;for(let O=0;O<v;O++){const $=O+l-r,W=$*$;if(W>T)P+=4*g;else for(let G=0;G<g;G++){if(i[P+3]-1>=0){const ae=G+u-t,te=ae*ae+W;te<=T&&(T=te,S=P)}P+=4}}if(S>=0){const O=i.slice(S,S+4),$=e(O);if($){const W=Math.floor(S/4/g),G=S/4-W*g;return{...$,pickedColor:O,pickedX:u+G,pickedY:l+W}}ni.error("Picked non-existent layer. Is picking buffer corrupt?")()}return sL}function c0({pickedColors:i,decodePickingColor:e}){const t=new Map;if(i){for(let r=0;r<i.length;r+=4)if(i[r+3]-1>=0){const a=i.slice(r,r+4),u=a.join(",");if(!t.has(u)){const l=e(a);l?t.set(u,{...l,color:a}):ni.error("Picked non-existent layer. Is picking buffer corrupt?")()}}}return Array.from(t.values())}function h_({pickInfo:i,viewports:e,pixelRatio:t,x:r,y:s,z:a}){let u=e[0];e.length>1&&(u=nL(i?.pickedViewports||e,{x:r,y:s}));let l;if(u){const g=[r-u.x,s-u.y];a!==void 0&&(g[2]=a),l=u.unproject(g)}return{color:null,layer:null,viewport:u,index:-1,picked:!1,x:r,y:s,pixel:[r,s],coordinate:l,devicePixel:i&&"pickedX"in i?[i.pickedX,i.pickedY]:void 0,pixelRatio:t}}function u0(i){const{pickInfo:e,lastPickedInfo:t,mode:r,layers:s}=i,{pickedColor:a,pickedLayer:u,pickedObjectIndex:l}=e,g=u?[u]:[];if(r==="hover"){const S=t.index,P=t.layerId,O=u?u.props.id:null;if(O!==P||l!==S){if(O!==P){const $=s.find(W=>W.props.id===P);$&&g.unshift($)}t.layerId=O,t.index=l,t.info=null}}const v=h_(i),T=new Map;return T.set(null,v),g.forEach(S=>{let P={...v};S===u&&(P.color=a,P.index=l,P.picked=!0),P=d_({layer:S,info:P,mode:r});const O=P.layer;S===u&&r==="hover"&&(t.info=P),T.set(O.id,P),r==="hover"&&O.updateAutoHighlight(P)}),T}function d_({layer:i,info:e,mode:t}){for(;i&&e;){const r=e.layer||null;e.sourceLayer=r,e.layer=i,e=i.getPickingInfo({info:e,mode:t,sourceLayer:r}),i=i.parent}return e}function nL(i,e){for(let t=i.length-1;t>=0;t--){const r=i[t];if(r.containsPixel(e))return r}return i[0]}class oL{constructor(e){this._pickable=!0,this.device=e,this.pickLayersPass=new W2(e),this.lastPickedInfo={index:-1,layerId:null,info:null}}setProps(e){"layerFilter"in e&&(this.layerFilter=e.layerFilter),"_pickable"in e&&(this._pickable=e._pickable)}finalize(){this.pickingFBO&&this.pickingFBO.destroy(),this.depthFBO&&this.depthFBO.destroy()}pickObjectAsync(e){return this._pickClosestObjectAsync(e)}pickObjectsAsync(e){return this._pickVisibleObjectsAsync(e)}pickObject(e){return this._pickClosestObject(e)}pickObjects(e){return this._pickVisibleObjects(e)}getLastPickedObject({x:e,y:t,layers:r,viewports:s},a=this.lastPickedInfo.info){const u=a&&a.layer&&a.layer.id,l=a&&a.viewport&&a.viewport.id,g=u?r.find(P=>P.id===u):null,v=l&&s.find(P=>P.id===l)||s[0],T=v&&v.unproject([e-v.x,t-v.y]);return{...a,...{x:e,y:t,viewport:v,coordinate:T,layer:g}}}_resizeBuffer(){if(!this.pickingFBO&&(this.pickingFBO=this.device.createFramebuffer({colorAttachments:["rgba8unorm"],depthStencilAttachment:"depth16unorm"}),this.device.isTextureFormatRenderable("rgba32float"))){const t=this.device.createFramebuffer({colorAttachments:["rgba32float"],depthStencilAttachment:"depth16unorm"});this.depthFBO=t}const{canvas:e}=this.device.getDefaultCanvasContext();this.pickingFBO?.resize({width:e.width,height:e.height}),this.depthFBO?.resize({width:e.width,height:e.height})}_getPickable(e){if(this._pickable===!1)return null;const t=e.filter(r=>this.pickLayersPass.shouldDrawLayer(r)&&!r.isComposite);return t.length?t:null}async _pickClosestObjectAsync({layers:e,views:t,viewports:r,x:s,y:a,radius:u=0,depth:l=1,mode:g="query",unproject3D:v,onViewportActive:T,effects:S}){const P=this.device.canvasContext.cssToDeviceRatio(),O=this._getPickable(e);if(!O||r.length===0)return{result:[],emptyInfo:h_({viewports:r,x:s,y:a,pixelRatio:P})};this._resizeBuffer();const $=this.device.canvasContext.cssToDevicePixels([s,a],!0),W=[$.x+Math.floor($.width/2),$.y+Math.floor($.height/2)],G=Math.round(u*P),{width:Q,height:ae}=this.pickingFBO,te=this._getPickingRect({deviceX:W[0],deviceY:W[1],deviceRadius:G,deviceWidth:Q,deviceHeight:ae}),me={x:s-u,y:a-u,width:u*2+1,height:u*2+1};let we;const Oe=[],Je=new Set;for(let it=0;it<l;it++){let He;if(te){const Ye=this._drawAndSample({layers:O,views:t,viewports:r,onViewportActive:T,deviceRect:te,cullRect:me,effects:S,pass:`picking:${g}`});He=l0({...Ye,deviceX:W[0],deviceY:W[1],deviceRadius:G,deviceRect:te})}else He={pickedColor:null,pickedObjectIndex:-1};let ht;if(He.pickedLayer&&v&&this.depthFBO){const{pickedColors:Ye}=this._drawAndSample({layers:[He.pickedLayer],views:t,viewports:r,onViewportActive:T,deviceRect:{x:He.pickedX,y:He.pickedY,width:1,height:1},cullRect:me,effects:S,pass:`picking:${g}:z`},!0);Ye[3]&&(ht=Ye[0])}He.pickedLayer&&it+1<l&&(Je.add(He.pickedLayer),He.pickedLayer.disablePickingIndex(He.pickedObjectIndex)),we=u0({pickInfo:He,lastPickedInfo:this.lastPickedInfo,mode:g,layers:O,viewports:r,x:s,y:a,z:ht,pixelRatio:P});for(const Ye of we.values())Ye.layer&&Oe.push(Ye);if(!He.pickedColor)break}for(const it of Je)it.restorePickingColors();return{result:Oe,emptyInfo:we.get(null)}}_pickClosestObject({layers:e,views:t,viewports:r,x:s,y:a,radius:u=0,depth:l=1,mode:g="query",unproject3D:v,onViewportActive:T,effects:S}){const P=this.device.canvasContext.cssToDeviceRatio(),O=this._getPickable(e);if(!O||r.length===0)return{result:[],emptyInfo:h_({viewports:r,x:s,y:a,pixelRatio:P})};this._resizeBuffer();const $=this.device.canvasContext.cssToDevicePixels([s,a],!0),W=[$.x+Math.floor($.width/2),$.y+Math.floor($.height/2)],G=Math.round(u*P),{width:Q,height:ae}=this.pickingFBO,te=this._getPickingRect({deviceX:W[0],deviceY:W[1],deviceRadius:G,deviceWidth:Q,deviceHeight:ae}),me={x:s-u,y:a-u,width:u*2+1,height:u*2+1};let we;const Oe=[],Je=new Set;for(let it=0;it<l;it++){let He;if(te){const Ye=this._drawAndSample({layers:O,views:t,viewports:r,onViewportActive:T,deviceRect:te,cullRect:me,effects:S,pass:`picking:${g}`});He=l0({...Ye,deviceX:W[0],deviceY:W[1],deviceRadius:G,deviceRect:te})}else He={pickedColor:null,pickedObjectIndex:-1};let ht;if(He.pickedLayer&&v&&this.depthFBO){const{pickedColors:Ye}=this._drawAndSample({layers:[He.pickedLayer],views:t,viewports:r,onViewportActive:T,deviceRect:{x:He.pickedX,y:He.pickedY,width:1,height:1},cullRect:me,effects:S,pass:`picking:${g}:z`},!0);Ye[3]&&(ht=Ye[0])}He.pickedLayer&&it+1<l&&(Je.add(He.pickedLayer),He.pickedLayer.disablePickingIndex(He.pickedObjectIndex)),we=u0({pickInfo:He,lastPickedInfo:this.lastPickedInfo,mode:g,layers:O,viewports:r,x:s,y:a,z:ht,pixelRatio:P});for(const Ye of we.values())Ye.layer&&Oe.push(Ye);if(!He.pickedColor)break}for(const it of Je)it.restorePickingColors();return{result:Oe,emptyInfo:we.get(null)}}async _pickVisibleObjectsAsync({layers:e,views:t,viewports:r,x:s,y:a,width:u=1,height:l=1,mode:g="query",maxObjects:v=null,onViewportActive:T,effects:S}){const P=this._getPickable(e);if(!P||r.length===0)return[];this._resizeBuffer();const O=this.device.canvasContext.cssToDeviceRatio(),$=this.device.canvasContext.cssToDevicePixels([s,a],!0),W=$.x,G=$.y+$.height,Q=this.device.canvasContext.cssToDevicePixels([s+u,a+l],!0),ae=Q.x+Q.width,te=Q.y,me={x:W,y:te,width:ae-W,height:G-te},we=this._drawAndSample({layers:P,views:t,viewports:r,onViewportActive:T,deviceRect:me,cullRect:{x:s,y:a,width:u,height:l},effects:S,pass:`picking:${g}`}),Oe=c0(we),Je=new Map,it=[],He=Number.isFinite(v);for(let ht=0;ht<Oe.length&&!(He&&it.length>=v);ht++){const Ye=Oe[ht];let ft={color:Ye.pickedColor,layer:null,index:Ye.pickedObjectIndex,picked:!0,x:s,y:a,pixelRatio:O};ft=d_({layer:Ye.pickedLayer,info:ft,mode:g});const Ke=ft.layer.id;Je.has(Ke)||Je.set(Ke,new Set);const Ze=Je.get(Ke),ve=ft.object??ft.index;Ze.has(ve)||(Ze.add(ve),it.push(ft))}return it}_pickVisibleObjects({layers:e,views:t,viewports:r,x:s,y:a,width:u=1,height:l=1,mode:g="query",maxObjects:v=null,onViewportActive:T,effects:S}){const P=this._getPickable(e);if(!P||r.length===0)return[];this._resizeBuffer();const O=this.device.canvasContext.cssToDeviceRatio(),$=this.device.canvasContext.cssToDevicePixels([s,a],!0),W=$.x,G=$.y+$.height,Q=this.device.canvasContext.cssToDevicePixels([s+u,a+l],!0),ae=Q.x+Q.width,te=Q.y,me={x:W,y:te,width:ae-W,height:G-te},we=this._drawAndSample({layers:P,views:t,viewports:r,onViewportActive:T,deviceRect:me,cullRect:{x:s,y:a,width:u,height:l},effects:S,pass:`picking:${g}`}),Oe=c0(we),Je=new Map,it=[],He=Number.isFinite(v);for(let ht=0;ht<Oe.length&&!(He&&it.length>=v);ht++){const Ye=Oe[ht];let ft={color:Ye.pickedColor,layer:null,index:Ye.pickedObjectIndex,picked:!0,x:s,y:a,pixelRatio:O};ft=d_({layer:Ye.pickedLayer,info:ft,mode:g});const Ke=ft.layer.id;Je.has(Ke)||Je.set(Ke,new Set);const Ze=Je.get(Ke),ve=ft.object??ft.index;Ze.has(ve)||(Ze.add(ve),it.push(ft))}return it}async _drawAndSampleAsync({layers:e,views:t,viewports:r,onViewportActive:s,deviceRect:a,cullRect:u,effects:l,pass:g},v=!1){const T=v?this.depthFBO:this.pickingFBO,S={layers:e,layerFilter:this.layerFilter,views:t,viewports:r,onViewportActive:s,pickingFBO:T,deviceRect:a,cullRect:u,effects:l,pass:g,pickZ:v,preRenderStats:{},isPicking:!0};for(const ae of l)ae.useInPicking&&(S.preRenderStats[ae.id]=ae.preRender(S));const{decodePickingColor:P}=this.pickLayersPass.render(S),{x:O,y:$,width:W,height:G}=a,Q=new(v?Float32Array:Uint8Array)(W*G*4);return this.device.readPixelsToArrayWebGL(T,{sourceX:O,sourceY:$,sourceWidth:W,sourceHeight:G,target:Q}),{pickedColors:Q,decodePickingColor:P}}_drawAndSample({layers:e,views:t,viewports:r,onViewportActive:s,deviceRect:a,cullRect:u,effects:l,pass:g},v=!1){const T=v?this.depthFBO:this.pickingFBO,S={layers:e,layerFilter:this.layerFilter,views:t,viewports:r,onViewportActive:s,pickingFBO:T,deviceRect:a,cullRect:u,effects:l,pass:g,pickZ:v,preRenderStats:{},isPicking:!0};for(const ae of l)ae.useInPicking&&(S.preRenderStats[ae.id]=ae.preRender(S));const{decodePickingColor:P}=this.pickLayersPass.render(S),{x:O,y:$,width:W,height:G}=a,Q=new(v?Float32Array:Uint8Array)(W*G*4);return this.device.readPixelsToArrayWebGL(T,{sourceX:O,sourceY:$,sourceWidth:W,sourceHeight:G,target:Q}),{pickedColors:Q,decodePickingColor:P}}_getPickingRect({deviceX:e,deviceY:t,deviceRadius:r,deviceWidth:s,deviceHeight:a}){const u=Math.max(0,e-r),l=Math.max(0,t-r),g=Math.min(s,e+r+1)-u,v=Math.min(a,t+r+1)-l;return g<=0||v<=0?null:{x:u,y:l,width:g,height:v}}}const aL={"top-left":{top:0,left:0},"top-right":{top:0,right:0},"bottom-left":{bottom:0,left:0},"bottom-right":{bottom:0,right:0},fill:{top:0,left:0,bottom:0,right:0}},lL="top-left",h0="__root";class cL{constructor({deck:e,parentElement:t}){this.defaultWidgets=[],this.widgets=[],this.resolvedWidgets=[],this.containers={},this.lastViewports={},this.deck=e,t?.classList.add("deck-widget-container"),this.parentElement=t}getWidgets(){return this.resolvedWidgets}setProps(e){if(e.widgets&&!Zs(e.widgets,this.widgets,1)){const t=e.widgets.filter(Boolean);this._setWidgets(t)}}finalize(){for(const e of this.getWidgets())this._removeWidget(e);this.defaultWidgets.length=0,this.resolvedWidgets.length=0;for(const e in this.containers)this.containers[e].remove()}addDefault(e){this.defaultWidgets.find(t=>t.id===e.id)||(this._addWidget(e),this.defaultWidgets.push(e),this._setWidgets(this.widgets))}onRedraw({viewports:e,layers:t}){const r=e.reduce((s,a)=>(s[a.id]=a,s),{});for(const s of this.getWidgets()){const{viewId:a}=s;if(a){const u=r[a];u&&(s.onViewportChange&&s.onViewportChange(u),s.onRedraw?.({viewports:[u],layers:t}))}else{if(s.onViewportChange)for(const u of e)s.onViewportChange(u);s.onRedraw?.({viewports:e,layers:t})}}this.lastViewports=r,this._updateContainers()}onHover(e,t){for(const r of this.getWidgets()){const{viewId:s}=r;(!s||s===e.viewport?.id)&&r.onHover?.(e,t)}}onEvent(e,t){const r=n_[t.type];if(r)for(const s of this.getWidgets()){const{viewId:a}=s;(!a||a===e.viewport?.id)&&s[r]?.(e,t)}}_setWidgets(e){const t={};for(const r of this.resolvedWidgets)t[r.id]=r;this.resolvedWidgets.length=0;for(const r of this.defaultWidgets)t[r.id]=null,this.resolvedWidgets.push(r);for(let r of e){const s=t[r.id];s?s.viewId!==r.viewId||s.placement!==r.placement?(this._removeWidget(s),this._addWidget(r)):r!==s&&(s.setProps(r.props),r=s):this._addWidget(r),t[r.id]=null,this.resolvedWidgets.push(r)}for(const r in t){const s=t[r];s&&this._removeWidget(s)}this.widgets=e}_addWidget(e){const{viewId:t=null,placement:r=lL}=e;e.widgetManager=this,e.deck=this.deck,e.rootElement=e._onAdd({deck:this.deck,viewId:t}),e.rootElement&&this._getContainer(t,r).append(e.rootElement),e.updateHTML()}_removeWidget(e){e.onRemove?.(),e.rootElement&&e.rootElement.remove(),e.rootElement=void 0,e.deck=void 0,e.widgetManager=void 0}_getContainer(e,t){const r=e||h0;let s=this.containers[r];s||(s=document.createElement("div"),s.style.pointerEvents="none",s.style.position="absolute",s.style.overflow="hidden",this.parentElement?.append(s),this.containers[r]=s);let a=s.querySelector(`.${t}`);return a||(a=globalThis.document.createElement("div"),a.className=t,a.style.position="absolute",a.style.zIndex="2",Object.assign(a.style,aL[t]),s.append(a)),a}_updateContainers(){const e=this.deck.width,t=this.deck.height;for(const r in this.containers){const s=this.lastViewports[r]||null,a=r===h0||s,u=this.containers[r];a?(u.style.display="block",u.style.left=`${s?s.x:0}px`,u.style.top=`${s?s.y:0}px`,u.style.width=`${s?s.width:e}px`,u.style.height=`${s?s.height:t}px`):u.style.display="none"}}}function d0(i,e){e&&Object.entries(e).map(([t,r])=>{t.startsWith("--")?i.style.setProperty(t,r):i.style[t]=r})}function uL(i,e){e&&Object.keys(e).map(t=>{t.startsWith("--")?i.style.removeProperty(t):i.style[t]=""})}class by{constructor(e){this.viewId=null,this.props={...this.constructor.defaultProps,...e},this.id=this.props.id}setProps(e){const t=this.props,r=this.rootElement;r&&t.className!==e.className&&(t.className&&r.classList.remove(t.className),e.className&&r.classList.add(e.className)),r&&!Zs(t.style,e.style,1)&&(uL(r,t.style),d0(r,e.style)),Object.assign(this.props,e),this.updateHTML()}updateHTML(){this.rootElement&&this.onRenderHTML(this.rootElement)}onCreateRootElement(){const e=["deck-widget",this.className,this.props.className],t=document.createElement("div");return e.filter(r=>typeof r=="string"&&r.length>0).forEach(r=>t.classList.add(r)),d0(t,this.props.style),t}_onAdd(e){return this.onAdd(e)??this.onCreateRootElement()}onAdd(e){}onRemove(){}onViewportChange(e){}onRedraw(e){}onHover(e,t){}onClick(e,t){}onDrag(e,t){}onDragStart(e,t){}onDragEnd(e,t){}}by.defaultProps={id:"widget",style:{},className:""};const hL={zIndex:"1",position:"absolute",pointerEvents:"none",color:"#a0a7b4",backgroundColor:"#29323c",padding:"10px",top:"0",left:"0",display:"none"};class Z2 extends by{constructor(e={}){super(e),this.id="default-tooltip",this.placement="fill",this.className="deck-tooltip",this.isVisible=!1,this.setProps(e)}onCreateRootElement(){const e=document.createElement("div");return e.className=this.className,Object.assign(e.style,hL),e}onRenderHTML(e){}onViewportChange(e){this.isVisible&&e.id===this.lastViewport?.id&&!e.equals(this.lastViewport)&&this.setTooltip(null),this.lastViewport=e}onHover(e){const{deck:t}=this,r=t&&t.props.getTooltip;if(!r)return;const s=r(e);this.setTooltip(s,e.x,e.y)}setTooltip(e,t,r){const s=this.rootElement;if(s){if(typeof e=="string")s.innerText=e;else if(e)e.text&&(s.innerText=e.text),e.html&&(s.innerHTML=e.html),e.className&&(s.className=e.className);else{this.isVisible=!1,s.style.display="none";return}this.isVisible=!0,s.style.display="block",s.style.transform=`translate(${t}px, ${r}px)`,e&&typeof e=="object"&&"style"in e&&Object.assign(s.style,e.style)}}}Z2.defaultProps={...by.defaultProps};var lc;(function(i){i[i.DEPTH_BUFFER_BIT=256]="DEPTH_BUFFER_BIT",i[i.STENCIL_BUFFER_BIT=1024]="STENCIL_BUFFER_BIT",i[i.COLOR_BUFFER_BIT=16384]="COLOR_BUFFER_BIT",i[i.POINTS=0]="POINTS",i[i.LINES=1]="LINES",i[i.LINE_LOOP=2]="LINE_LOOP",i[i.LINE_STRIP=3]="LINE_STRIP",i[i.TRIANGLES=4]="TRIANGLES",i[i.TRIANGLE_STRIP=5]="TRIANGLE_STRIP",i[i.TRIANGLE_FAN=6]="TRIANGLE_FAN",i[i.ZERO=0]="ZERO",i[i.ONE=1]="ONE",i[i.SRC_COLOR=768]="SRC_COLOR",i[i.ONE_MINUS_SRC_COLOR=769]="ONE_MINUS_SRC_COLOR",i[i.SRC_ALPHA=770]="SRC_ALPHA",i[i.ONE_MINUS_SRC_ALPHA=771]="ONE_MINUS_SRC_ALPHA",i[i.DST_ALPHA=772]="DST_ALPHA",i[i.ONE_MINUS_DST_ALPHA=773]="ONE_MINUS_DST_ALPHA",i[i.DST_COLOR=774]="DST_COLOR",i[i.ONE_MINUS_DST_COLOR=775]="ONE_MINUS_DST_COLOR",i[i.SRC_ALPHA_SATURATE=776]="SRC_ALPHA_SATURATE",i[i.CONSTANT_COLOR=32769]="CONSTANT_COLOR",i[i.ONE_MINUS_CONSTANT_COLOR=32770]="ONE_MINUS_CONSTANT_COLOR",i[i.CONSTANT_ALPHA=32771]="CONSTANT_ALPHA",i[i.ONE_MINUS_CONSTANT_ALPHA=32772]="ONE_MINUS_CONSTANT_ALPHA",i[i.FUNC_ADD=32774]="FUNC_ADD",i[i.FUNC_SUBTRACT=32778]="FUNC_SUBTRACT",i[i.FUNC_REVERSE_SUBTRACT=32779]="FUNC_REVERSE_SUBTRACT",i[i.BLEND_EQUATION=32777]="BLEND_EQUATION",i[i.BLEND_EQUATION_RGB=32777]="BLEND_EQUATION_RGB",i[i.BLEND_EQUATION_ALPHA=34877]="BLEND_EQUATION_ALPHA",i[i.BLEND_DST_RGB=32968]="BLEND_DST_RGB",i[i.BLEND_SRC_RGB=32969]="BLEND_SRC_RGB",i[i.BLEND_DST_ALPHA=32970]="BLEND_DST_ALPHA",i[i.BLEND_SRC_ALPHA=32971]="BLEND_SRC_ALPHA",i[i.BLEND_COLOR=32773]="BLEND_COLOR",i[i.ARRAY_BUFFER_BINDING=34964]="ARRAY_BUFFER_BINDING",i[i.ELEMENT_ARRAY_BUFFER_BINDING=34965]="ELEMENT_ARRAY_BUFFER_BINDING",i[i.LINE_WIDTH=2849]="LINE_WIDTH",i[i.ALIASED_POINT_SIZE_RANGE=33901]="ALIASED_POINT_SIZE_RANGE",i[i.ALIASED_LINE_WIDTH_RANGE=33902]="ALIASED_LINE_WIDTH_RANGE",i[i.CULL_FACE_MODE=2885]="CULL_FACE_MODE",i[i.FRONT_FACE=2886]="FRONT_FACE",i[i.DEPTH_RANGE=2928]="DEPTH_RANGE",i[i.DEPTH_WRITEMASK=2930]="DEPTH_WRITEMASK",i[i.DEPTH_CLEAR_VALUE=2931]="DEPTH_CLEAR_VALUE",i[i.DEPTH_FUNC=2932]="DEPTH_FUNC",i[i.STENCIL_CLEAR_VALUE=2961]="STENCIL_CLEAR_VALUE",i[i.STENCIL_FUNC=2962]="STENCIL_FUNC",i[i.STENCIL_FAIL=2964]="STENCIL_FAIL",i[i.STENCIL_PASS_DEPTH_FAIL=2965]="STENCIL_PASS_DEPTH_FAIL",i[i.STENCIL_PASS_DEPTH_PASS=2966]="STENCIL_PASS_DEPTH_PASS",i[i.STENCIL_REF=2967]="STENCIL_REF",i[i.STENCIL_VALUE_MASK=2963]="STENCIL_VALUE_MASK",i[i.STENCIL_WRITEMASK=2968]="STENCIL_WRITEMASK",i[i.STENCIL_BACK_FUNC=34816]="STENCIL_BACK_FUNC",i[i.STENCIL_BACK_FAIL=34817]="STENCIL_BACK_FAIL",i[i.STENCIL_BACK_PASS_DEPTH_FAIL=34818]="STENCIL_BACK_PASS_DEPTH_FAIL",i[i.STENCIL_BACK_PASS_DEPTH_PASS=34819]="STENCIL_BACK_PASS_DEPTH_PASS",i[i.STENCIL_BACK_REF=36003]="STENCIL_BACK_REF",i[i.STENCIL_BACK_VALUE_MASK=36004]="STENCIL_BACK_VALUE_MASK",i[i.STENCIL_BACK_WRITEMASK=36005]="STENCIL_BACK_WRITEMASK",i[i.VIEWPORT=2978]="VIEWPORT",i[i.SCISSOR_BOX=3088]="SCISSOR_BOX",i[i.COLOR_CLEAR_VALUE=3106]="COLOR_CLEAR_VALUE",i[i.COLOR_WRITEMASK=3107]="COLOR_WRITEMASK",i[i.UNPACK_ALIGNMENT=3317]="UNPACK_ALIGNMENT",i[i.PACK_ALIGNMENT=3333]="PACK_ALIGNMENT",i[i.MAX_TEXTURE_SIZE=3379]="MAX_TEXTURE_SIZE",i[i.MAX_VIEWPORT_DIMS=3386]="MAX_VIEWPORT_DIMS",i[i.SUBPIXEL_BITS=3408]="SUBPIXEL_BITS",i[i.RED_BITS=3410]="RED_BITS",i[i.GREEN_BITS=3411]="GREEN_BITS",i[i.BLUE_BITS=3412]="BLUE_BITS",i[i.ALPHA_BITS=3413]="ALPHA_BITS",i[i.DEPTH_BITS=3414]="DEPTH_BITS",i[i.STENCIL_BITS=3415]="STENCIL_BITS",i[i.POLYGON_OFFSET_UNITS=10752]="POLYGON_OFFSET_UNITS",i[i.POLYGON_OFFSET_FACTOR=32824]="POLYGON_OFFSET_FACTOR",i[i.TEXTURE_BINDING_2D=32873]="TEXTURE_BINDING_2D",i[i.SAMPLE_BUFFERS=32936]="SAMPLE_BUFFERS",i[i.SAMPLES=32937]="SAMPLES",i[i.SAMPLE_COVERAGE_VALUE=32938]="SAMPLE_COVERAGE_VALUE",i[i.SAMPLE_COVERAGE_INVERT=32939]="SAMPLE_COVERAGE_INVERT",i[i.COMPRESSED_TEXTURE_FORMATS=34467]="COMPRESSED_TEXTURE_FORMATS",i[i.VENDOR=7936]="VENDOR",i[i.RENDERER=7937]="RENDERER",i[i.VERSION=7938]="VERSION",i[i.IMPLEMENTATION_COLOR_READ_TYPE=35738]="IMPLEMENTATION_COLOR_READ_TYPE",i[i.IMPLEMENTATION_COLOR_READ_FORMAT=35739]="IMPLEMENTATION_COLOR_READ_FORMAT",i[i.BROWSER_DEFAULT_WEBGL=37444]="BROWSER_DEFAULT_WEBGL",i[i.STATIC_DRAW=35044]="STATIC_DRAW",i[i.STREAM_DRAW=35040]="STREAM_DRAW",i[i.DYNAMIC_DRAW=35048]="DYNAMIC_DRAW",i[i.ARRAY_BUFFER=34962]="ARRAY_BUFFER",i[i.ELEMENT_ARRAY_BUFFER=34963]="ELEMENT_ARRAY_BUFFER",i[i.BUFFER_SIZE=34660]="BUFFER_SIZE",i[i.BUFFER_USAGE=34661]="BUFFER_USAGE",i[i.CURRENT_VERTEX_ATTRIB=34342]="CURRENT_VERTEX_ATTRIB",i[i.VERTEX_ATTRIB_ARRAY_ENABLED=34338]="VERTEX_ATTRIB_ARRAY_ENABLED",i[i.VERTEX_ATTRIB_ARRAY_SIZE=34339]="VERTEX_ATTRIB_ARRAY_SIZE",i[i.VERTEX_ATTRIB_ARRAY_STRIDE=34340]="VERTEX_ATTRIB_ARRAY_STRIDE",i[i.VERTEX_ATTRIB_ARRAY_TYPE=34341]="VERTEX_ATTRIB_ARRAY_TYPE",i[i.VERTEX_ATTRIB_ARRAY_NORMALIZED=34922]="VERTEX_ATTRIB_ARRAY_NORMALIZED",i[i.VERTEX_ATTRIB_ARRAY_POINTER=34373]="VERTEX_ATTRIB_ARRAY_POINTER",i[i.VERTEX_ATTRIB_ARRAY_BUFFER_BINDING=34975]="VERTEX_ATTRIB_ARRAY_BUFFER_BINDING",i[i.CULL_FACE=2884]="CULL_FACE",i[i.FRONT=1028]="FRONT",i[i.BACK=1029]="BACK",i[i.FRONT_AND_BACK=1032]="FRONT_AND_BACK",i[i.BLEND=3042]="BLEND",i[i.DEPTH_TEST=2929]="DEPTH_TEST",i[i.DITHER=3024]="DITHER",i[i.POLYGON_OFFSET_FILL=32823]="POLYGON_OFFSET_FILL",i[i.SAMPLE_ALPHA_TO_COVERAGE=32926]="SAMPLE_ALPHA_TO_COVERAGE",i[i.SAMPLE_COVERAGE=32928]="SAMPLE_COVERAGE",i[i.SCISSOR_TEST=3089]="SCISSOR_TEST",i[i.STENCIL_TEST=2960]="STENCIL_TEST",i[i.NO_ERROR=0]="NO_ERROR",i[i.INVALID_ENUM=1280]="INVALID_ENUM",i[i.INVALID_VALUE=1281]="INVALID_VALUE",i[i.INVALID_OPERATION=1282]="INVALID_OPERATION",i[i.OUT_OF_MEMORY=1285]="OUT_OF_MEMORY",i[i.CONTEXT_LOST_WEBGL=37442]="CONTEXT_LOST_WEBGL",i[i.CW=2304]="CW",i[i.CCW=2305]="CCW",i[i.DONT_CARE=4352]="DONT_CARE",i[i.FASTEST=4353]="FASTEST",i[i.NICEST=4354]="NICEST",i[i.GENERATE_MIPMAP_HINT=33170]="GENERATE_MIPMAP_HINT",i[i.BYTE=5120]="BYTE",i[i.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",i[i.SHORT=5122]="SHORT",i[i.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",i[i.INT=5124]="INT",i[i.UNSIGNED_INT=5125]="UNSIGNED_INT",i[i.FLOAT=5126]="FLOAT",i[i.DOUBLE=5130]="DOUBLE",i[i.DEPTH_COMPONENT=6402]="DEPTH_COMPONENT",i[i.ALPHA=6406]="ALPHA",i[i.RGB=6407]="RGB",i[i.RGBA=6408]="RGBA",i[i.LUMINANCE=6409]="LUMINANCE",i[i.LUMINANCE_ALPHA=6410]="LUMINANCE_ALPHA",i[i.UNSIGNED_SHORT_4_4_4_4=32819]="UNSIGNED_SHORT_4_4_4_4",i[i.UNSIGNED_SHORT_5_5_5_1=32820]="UNSIGNED_SHORT_5_5_5_1",i[i.UNSIGNED_SHORT_5_6_5=33635]="UNSIGNED_SHORT_5_6_5",i[i.FRAGMENT_SHADER=35632]="FRAGMENT_SHADER",i[i.VERTEX_SHADER=35633]="VERTEX_SHADER",i[i.COMPILE_STATUS=35713]="COMPILE_STATUS",i[i.DELETE_STATUS=35712]="DELETE_STATUS",i[i.LINK_STATUS=35714]="LINK_STATUS",i[i.VALIDATE_STATUS=35715]="VALIDATE_STATUS",i[i.ATTACHED_SHADERS=35717]="ATTACHED_SHADERS",i[i.ACTIVE_ATTRIBUTES=35721]="ACTIVE_ATTRIBUTES",i[i.ACTIVE_UNIFORMS=35718]="ACTIVE_UNIFORMS",i[i.MAX_VERTEX_ATTRIBS=34921]="MAX_VERTEX_ATTRIBS",i[i.MAX_VERTEX_UNIFORM_VECTORS=36347]="MAX_VERTEX_UNIFORM_VECTORS",i[i.MAX_VARYING_VECTORS=36348]="MAX_VARYING_VECTORS",i[i.MAX_COMBINED_TEXTURE_IMAGE_UNITS=35661]="MAX_COMBINED_TEXTURE_IMAGE_UNITS",i[i.MAX_VERTEX_TEXTURE_IMAGE_UNITS=35660]="MAX_VERTEX_TEXTURE_IMAGE_UNITS",i[i.MAX_TEXTURE_IMAGE_UNITS=34930]="MAX_TEXTURE_IMAGE_UNITS",i[i.MAX_FRAGMENT_UNIFORM_VECTORS=36349]="MAX_FRAGMENT_UNIFORM_VECTORS",i[i.SHADER_TYPE=35663]="SHADER_TYPE",i[i.SHADING_LANGUAGE_VERSION=35724]="SHADING_LANGUAGE_VERSION",i[i.CURRENT_PROGRAM=35725]="CURRENT_PROGRAM",i[i.NEVER=512]="NEVER",i[i.LESS=513]="LESS",i[i.EQUAL=514]="EQUAL",i[i.LEQUAL=515]="LEQUAL",i[i.GREATER=516]="GREATER",i[i.NOTEQUAL=517]="NOTEQUAL",i[i.GEQUAL=518]="GEQUAL",i[i.ALWAYS=519]="ALWAYS",i[i.KEEP=7680]="KEEP",i[i.REPLACE=7681]="REPLACE",i[i.INCR=7682]="INCR",i[i.DECR=7683]="DECR",i[i.INVERT=5386]="INVERT",i[i.INCR_WRAP=34055]="INCR_WRAP",i[i.DECR_WRAP=34056]="DECR_WRAP",i[i.NEAREST=9728]="NEAREST",i[i.LINEAR=9729]="LINEAR",i[i.NEAREST_MIPMAP_NEAREST=9984]="NEAREST_MIPMAP_NEAREST",i[i.LINEAR_MIPMAP_NEAREST=9985]="LINEAR_MIPMAP_NEAREST",i[i.NEAREST_MIPMAP_LINEAR=9986]="NEAREST_MIPMAP_LINEAR",i[i.LINEAR_MIPMAP_LINEAR=9987]="LINEAR_MIPMAP_LINEAR",i[i.TEXTURE_MAG_FILTER=10240]="TEXTURE_MAG_FILTER",i[i.TEXTURE_MIN_FILTER=10241]="TEXTURE_MIN_FILTER",i[i.TEXTURE_WRAP_S=10242]="TEXTURE_WRAP_S",i[i.TEXTURE_WRAP_T=10243]="TEXTURE_WRAP_T",i[i.TEXTURE_2D=3553]="TEXTURE_2D",i[i.TEXTURE=5890]="TEXTURE",i[i.TEXTURE_CUBE_MAP=34067]="TEXTURE_CUBE_MAP",i[i.TEXTURE_BINDING_CUBE_MAP=34068]="TEXTURE_BINDING_CUBE_MAP",i[i.TEXTURE_CUBE_MAP_POSITIVE_X=34069]="TEXTURE_CUBE_MAP_POSITIVE_X",i[i.TEXTURE_CUBE_MAP_NEGATIVE_X=34070]="TEXTURE_CUBE_MAP_NEGATIVE_X",i[i.TEXTURE_CUBE_MAP_POSITIVE_Y=34071]="TEXTURE_CUBE_MAP_POSITIVE_Y",i[i.TEXTURE_CUBE_MAP_NEGATIVE_Y=34072]="TEXTURE_CUBE_MAP_NEGATIVE_Y",i[i.TEXTURE_CUBE_MAP_POSITIVE_Z=34073]="TEXTURE_CUBE_MAP_POSITIVE_Z",i[i.TEXTURE_CUBE_MAP_NEGATIVE_Z=34074]="TEXTURE_CUBE_MAP_NEGATIVE_Z",i[i.MAX_CUBE_MAP_TEXTURE_SIZE=34076]="MAX_CUBE_MAP_TEXTURE_SIZE",i[i.TEXTURE0=33984]="TEXTURE0",i[i.ACTIVE_TEXTURE=34016]="ACTIVE_TEXTURE",i[i.REPEAT=10497]="REPEAT",i[i.CLAMP_TO_EDGE=33071]="CLAMP_TO_EDGE",i[i.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT",i[i.TEXTURE_WIDTH=4096]="TEXTURE_WIDTH",i[i.TEXTURE_HEIGHT=4097]="TEXTURE_HEIGHT",i[i.FLOAT_VEC2=35664]="FLOAT_VEC2",i[i.FLOAT_VEC3=35665]="FLOAT_VEC3",i[i.FLOAT_VEC4=35666]="FLOAT_VEC4",i[i.INT_VEC2=35667]="INT_VEC2",i[i.INT_VEC3=35668]="INT_VEC3",i[i.INT_VEC4=35669]="INT_VEC4",i[i.BOOL=35670]="BOOL",i[i.BOOL_VEC2=35671]="BOOL_VEC2",i[i.BOOL_VEC3=35672]="BOOL_VEC3",i[i.BOOL_VEC4=35673]="BOOL_VEC4",i[i.FLOAT_MAT2=35674]="FLOAT_MAT2",i[i.FLOAT_MAT3=35675]="FLOAT_MAT3",i[i.FLOAT_MAT4=35676]="FLOAT_MAT4",i[i.SAMPLER_2D=35678]="SAMPLER_2D",i[i.SAMPLER_CUBE=35680]="SAMPLER_CUBE",i[i.LOW_FLOAT=36336]="LOW_FLOAT",i[i.MEDIUM_FLOAT=36337]="MEDIUM_FLOAT",i[i.HIGH_FLOAT=36338]="HIGH_FLOAT",i[i.LOW_INT=36339]="LOW_INT",i[i.MEDIUM_INT=36340]="MEDIUM_INT",i[i.HIGH_INT=36341]="HIGH_INT",i[i.FRAMEBUFFER=36160]="FRAMEBUFFER",i[i.RENDERBUFFER=36161]="RENDERBUFFER",i[i.RGBA4=32854]="RGBA4",i[i.RGB5_A1=32855]="RGB5_A1",i[i.RGB565=36194]="RGB565",i[i.DEPTH_COMPONENT16=33189]="DEPTH_COMPONENT16",i[i.STENCIL_INDEX=6401]="STENCIL_INDEX",i[i.STENCIL_INDEX8=36168]="STENCIL_INDEX8",i[i.DEPTH_STENCIL=34041]="DEPTH_STENCIL",i[i.RENDERBUFFER_WIDTH=36162]="RENDERBUFFER_WIDTH",i[i.RENDERBUFFER_HEIGHT=36163]="RENDERBUFFER_HEIGHT",i[i.RENDERBUFFER_INTERNAL_FORMAT=36164]="RENDERBUFFER_INTERNAL_FORMAT",i[i.RENDERBUFFER_RED_SIZE=36176]="RENDERBUFFER_RED_SIZE",i[i.RENDERBUFFER_GREEN_SIZE=36177]="RENDERBUFFER_GREEN_SIZE",i[i.RENDERBUFFER_BLUE_SIZE=36178]="RENDERBUFFER_BLUE_SIZE",i[i.RENDERBUFFER_ALPHA_SIZE=36179]="RENDERBUFFER_ALPHA_SIZE",i[i.RENDERBUFFER_DEPTH_SIZE=36180]="RENDERBUFFER_DEPTH_SIZE",i[i.RENDERBUFFER_STENCIL_SIZE=36181]="RENDERBUFFER_STENCIL_SIZE",i[i.FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE=36048]="FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE",i[i.FRAMEBUFFER_ATTACHMENT_OBJECT_NAME=36049]="FRAMEBUFFER_ATTACHMENT_OBJECT_NAME",i[i.FRAMEBUFFER_ATTACHMENT_TEXTURE_LEVEL=36050]="FRAMEBUFFER_ATTACHMENT_TEXTURE_LEVEL",i[i.FRAMEBUFFER_ATTACHMENT_TEXTURE_CUBE_MAP_FACE=36051]="FRAMEBUFFER_ATTACHMENT_TEXTURE_CUBE_MAP_FACE",i[i.COLOR_ATTACHMENT0=36064]="COLOR_ATTACHMENT0",i[i.DEPTH_ATTACHMENT=36096]="DEPTH_ATTACHMENT",i[i.STENCIL_ATTACHMENT=36128]="STENCIL_ATTACHMENT",i[i.DEPTH_STENCIL_ATTACHMENT=33306]="DEPTH_STENCIL_ATTACHMENT",i[i.NONE=0]="NONE",i[i.FRAMEBUFFER_COMPLETE=36053]="FRAMEBUFFER_COMPLETE",i[i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT=36054]="FRAMEBUFFER_INCOMPLETE_ATTACHMENT",i[i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT=36055]="FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT",i[i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS=36057]="FRAMEBUFFER_INCOMPLETE_DIMENSIONS",i[i.FRAMEBUFFER_UNSUPPORTED=36061]="FRAMEBUFFER_UNSUPPORTED",i[i.FRAMEBUFFER_BINDING=36006]="FRAMEBUFFER_BINDING",i[i.RENDERBUFFER_BINDING=36007]="RENDERBUFFER_BINDING",i[i.READ_FRAMEBUFFER=36008]="READ_FRAMEBUFFER",i[i.DRAW_FRAMEBUFFER=36009]="DRAW_FRAMEBUFFER",i[i.MAX_RENDERBUFFER_SIZE=34024]="MAX_RENDERBUFFER_SIZE",i[i.INVALID_FRAMEBUFFER_OPERATION=1286]="INVALID_FRAMEBUFFER_OPERATION",i[i.UNPACK_FLIP_Y_WEBGL=37440]="UNPACK_FLIP_Y_WEBGL",i[i.UNPACK_PREMULTIPLY_ALPHA_WEBGL=37441]="UNPACK_PREMULTIPLY_ALPHA_WEBGL",i[i.UNPACK_COLORSPACE_CONVERSION_WEBGL=37443]="UNPACK_COLORSPACE_CONVERSION_WEBGL",i[i.READ_BUFFER=3074]="READ_BUFFER",i[i.UNPACK_ROW_LENGTH=3314]="UNPACK_ROW_LENGTH",i[i.UNPACK_SKIP_ROWS=3315]="UNPACK_SKIP_ROWS",i[i.UNPACK_SKIP_PIXELS=3316]="UNPACK_SKIP_PIXELS",i[i.PACK_ROW_LENGTH=3330]="PACK_ROW_LENGTH",i[i.PACK_SKIP_ROWS=3331]="PACK_SKIP_ROWS",i[i.PACK_SKIP_PIXELS=3332]="PACK_SKIP_PIXELS",i[i.TEXTURE_BINDING_3D=32874]="TEXTURE_BINDING_3D",i[i.UNPACK_SKIP_IMAGES=32877]="UNPACK_SKIP_IMAGES",i[i.UNPACK_IMAGE_HEIGHT=32878]="UNPACK_IMAGE_HEIGHT",i[i.MAX_3D_TEXTURE_SIZE=32883]="MAX_3D_TEXTURE_SIZE",i[i.MAX_ELEMENTS_VERTICES=33e3]="MAX_ELEMENTS_VERTICES",i[i.MAX_ELEMENTS_INDICES=33001]="MAX_ELEMENTS_INDICES",i[i.MAX_TEXTURE_LOD_BIAS=34045]="MAX_TEXTURE_LOD_BIAS",i[i.MAX_FRAGMENT_UNIFORM_COMPONENTS=35657]="MAX_FRAGMENT_UNIFORM_COMPONENTS",i[i.MAX_VERTEX_UNIFORM_COMPONENTS=35658]="MAX_VERTEX_UNIFORM_COMPONENTS",i[i.MAX_ARRAY_TEXTURE_LAYERS=35071]="MAX_ARRAY_TEXTURE_LAYERS",i[i.MIN_PROGRAM_TEXEL_OFFSET=35076]="MIN_PROGRAM_TEXEL_OFFSET",i[i.MAX_PROGRAM_TEXEL_OFFSET=35077]="MAX_PROGRAM_TEXEL_OFFSET",i[i.MAX_VARYING_COMPONENTS=35659]="MAX_VARYING_COMPONENTS",i[i.FRAGMENT_SHADER_DERIVATIVE_HINT=35723]="FRAGMENT_SHADER_DERIVATIVE_HINT",i[i.RASTERIZER_DISCARD=35977]="RASTERIZER_DISCARD",i[i.VERTEX_ARRAY_BINDING=34229]="VERTEX_ARRAY_BINDING",i[i.MAX_VERTEX_OUTPUT_COMPONENTS=37154]="MAX_VERTEX_OUTPUT_COMPONENTS",i[i.MAX_FRAGMENT_INPUT_COMPONENTS=37157]="MAX_FRAGMENT_INPUT_COMPONENTS",i[i.MAX_SERVER_WAIT_TIMEOUT=37137]="MAX_SERVER_WAIT_TIMEOUT",i[i.MAX_ELEMENT_INDEX=36203]="MAX_ELEMENT_INDEX",i[i.RED=6403]="RED",i[i.RGB8=32849]="RGB8",i[i.RGBA8=32856]="RGBA8",i[i.RGB10_A2=32857]="RGB10_A2",i[i.TEXTURE_3D=32879]="TEXTURE_3D",i[i.TEXTURE_WRAP_R=32882]="TEXTURE_WRAP_R",i[i.TEXTURE_MIN_LOD=33082]="TEXTURE_MIN_LOD",i[i.TEXTURE_MAX_LOD=33083]="TEXTURE_MAX_LOD",i[i.TEXTURE_BASE_LEVEL=33084]="TEXTURE_BASE_LEVEL",i[i.TEXTURE_MAX_LEVEL=33085]="TEXTURE_MAX_LEVEL",i[i.TEXTURE_COMPARE_MODE=34892]="TEXTURE_COMPARE_MODE",i[i.TEXTURE_COMPARE_FUNC=34893]="TEXTURE_COMPARE_FUNC",i[i.SRGB=35904]="SRGB",i[i.SRGB8=35905]="SRGB8",i[i.SRGB8_ALPHA8=35907]="SRGB8_ALPHA8",i[i.COMPARE_REF_TO_TEXTURE=34894]="COMPARE_REF_TO_TEXTURE",i[i.RGBA32F=34836]="RGBA32F",i[i.RGB32F=34837]="RGB32F",i[i.RGBA16F=34842]="RGBA16F",i[i.RGB16F=34843]="RGB16F",i[i.TEXTURE_2D_ARRAY=35866]="TEXTURE_2D_ARRAY",i[i.TEXTURE_BINDING_2D_ARRAY=35869]="TEXTURE_BINDING_2D_ARRAY",i[i.R11F_G11F_B10F=35898]="R11F_G11F_B10F",i[i.RGB9_E5=35901]="RGB9_E5",i[i.RGBA32UI=36208]="RGBA32UI",i[i.RGB32UI=36209]="RGB32UI",i[i.RGBA16UI=36214]="RGBA16UI",i[i.RGB16UI=36215]="RGB16UI",i[i.RGBA8UI=36220]="RGBA8UI",i[i.RGB8UI=36221]="RGB8UI",i[i.RGBA32I=36226]="RGBA32I",i[i.RGB32I=36227]="RGB32I",i[i.RGBA16I=36232]="RGBA16I",i[i.RGB16I=36233]="RGB16I",i[i.RGBA8I=36238]="RGBA8I",i[i.RGB8I=36239]="RGB8I",i[i.RED_INTEGER=36244]="RED_INTEGER",i[i.RGB_INTEGER=36248]="RGB_INTEGER",i[i.RGBA_INTEGER=36249]="RGBA_INTEGER",i[i.R8=33321]="R8",i[i.RG8=33323]="RG8",i[i.R16F=33325]="R16F",i[i.R32F=33326]="R32F",i[i.RG16F=33327]="RG16F",i[i.RG32F=33328]="RG32F",i[i.R8I=33329]="R8I",i[i.R8UI=33330]="R8UI",i[i.R16I=33331]="R16I",i[i.R16UI=33332]="R16UI",i[i.R32I=33333]="R32I",i[i.R32UI=33334]="R32UI",i[i.RG8I=33335]="RG8I",i[i.RG8UI=33336]="RG8UI",i[i.RG16I=33337]="RG16I",i[i.RG16UI=33338]="RG16UI",i[i.RG32I=33339]="RG32I",i[i.RG32UI=33340]="RG32UI",i[i.R8_SNORM=36756]="R8_SNORM",i[i.RG8_SNORM=36757]="RG8_SNORM",i[i.RGB8_SNORM=36758]="RGB8_SNORM",i[i.RGBA8_SNORM=36759]="RGBA8_SNORM",i[i.RGB10_A2UI=36975]="RGB10_A2UI",i[i.TEXTURE_IMMUTABLE_FORMAT=37167]="TEXTURE_IMMUTABLE_FORMAT",i[i.TEXTURE_IMMUTABLE_LEVELS=33503]="TEXTURE_IMMUTABLE_LEVELS",i[i.UNSIGNED_INT_2_10_10_10_REV=33640]="UNSIGNED_INT_2_10_10_10_REV",i[i.UNSIGNED_INT_10F_11F_11F_REV=35899]="UNSIGNED_INT_10F_11F_11F_REV",i[i.UNSIGNED_INT_5_9_9_9_REV=35902]="UNSIGNED_INT_5_9_9_9_REV",i[i.FLOAT_32_UNSIGNED_INT_24_8_REV=36269]="FLOAT_32_UNSIGNED_INT_24_8_REV",i[i.UNSIGNED_INT_24_8=34042]="UNSIGNED_INT_24_8",i[i.HALF_FLOAT=5131]="HALF_FLOAT",i[i.RG=33319]="RG",i[i.RG_INTEGER=33320]="RG_INTEGER",i[i.INT_2_10_10_10_REV=36255]="INT_2_10_10_10_REV",i[i.CURRENT_QUERY=34917]="CURRENT_QUERY",i[i.QUERY_RESULT=34918]="QUERY_RESULT",i[i.QUERY_RESULT_AVAILABLE=34919]="QUERY_RESULT_AVAILABLE",i[i.ANY_SAMPLES_PASSED=35887]="ANY_SAMPLES_PASSED",i[i.ANY_SAMPLES_PASSED_CONSERVATIVE=36202]="ANY_SAMPLES_PASSED_CONSERVATIVE",i[i.MAX_DRAW_BUFFERS=34852]="MAX_DRAW_BUFFERS",i[i.DRAW_BUFFER0=34853]="DRAW_BUFFER0",i[i.DRAW_BUFFER1=34854]="DRAW_BUFFER1",i[i.DRAW_BUFFER2=34855]="DRAW_BUFFER2",i[i.DRAW_BUFFER3=34856]="DRAW_BUFFER3",i[i.DRAW_BUFFER4=34857]="DRAW_BUFFER4",i[i.DRAW_BUFFER5=34858]="DRAW_BUFFER5",i[i.DRAW_BUFFER6=34859]="DRAW_BUFFER6",i[i.DRAW_BUFFER7=34860]="DRAW_BUFFER7",i[i.DRAW_BUFFER8=34861]="DRAW_BUFFER8",i[i.DRAW_BUFFER9=34862]="DRAW_BUFFER9",i[i.DRAW_BUFFER10=34863]="DRAW_BUFFER10",i[i.DRAW_BUFFER11=34864]="DRAW_BUFFER11",i[i.DRAW_BUFFER12=34865]="DRAW_BUFFER12",i[i.DRAW_BUFFER13=34866]="DRAW_BUFFER13",i[i.DRAW_BUFFER14=34867]="DRAW_BUFFER14",i[i.DRAW_BUFFER15=34868]="DRAW_BUFFER15",i[i.MAX_COLOR_ATTACHMENTS=36063]="MAX_COLOR_ATTACHMENTS",i[i.COLOR_ATTACHMENT1=36065]="COLOR_ATTACHMENT1",i[i.COLOR_ATTACHMENT2=36066]="COLOR_ATTACHMENT2",i[i.COLOR_ATTACHMENT3=36067]="COLOR_ATTACHMENT3",i[i.COLOR_ATTACHMENT4=36068]="COLOR_ATTACHMENT4",i[i.COLOR_ATTACHMENT5=36069]="COLOR_ATTACHMENT5",i[i.COLOR_ATTACHMENT6=36070]="COLOR_ATTACHMENT6",i[i.COLOR_ATTACHMENT7=36071]="COLOR_ATTACHMENT7",i[i.COLOR_ATTACHMENT8=36072]="COLOR_ATTACHMENT8",i[i.COLOR_ATTACHMENT9=36073]="COLOR_ATTACHMENT9",i[i.COLOR_ATTACHMENT10=36074]="COLOR_ATTACHMENT10",i[i.COLOR_ATTACHMENT11=36075]="COLOR_ATTACHMENT11",i[i.COLOR_ATTACHMENT12=36076]="COLOR_ATTACHMENT12",i[i.COLOR_ATTACHMENT13=36077]="COLOR_ATTACHMENT13",i[i.COLOR_ATTACHMENT14=36078]="COLOR_ATTACHMENT14",i[i.COLOR_ATTACHMENT15=36079]="COLOR_ATTACHMENT15",i[i.SAMPLER_3D=35679]="SAMPLER_3D",i[i.SAMPLER_2D_SHADOW=35682]="SAMPLER_2D_SHADOW",i[i.SAMPLER_2D_ARRAY=36289]="SAMPLER_2D_ARRAY",i[i.SAMPLER_2D_ARRAY_SHADOW=36292]="SAMPLER_2D_ARRAY_SHADOW",i[i.SAMPLER_CUBE_SHADOW=36293]="SAMPLER_CUBE_SHADOW",i[i.INT_SAMPLER_2D=36298]="INT_SAMPLER_2D",i[i.INT_SAMPLER_3D=36299]="INT_SAMPLER_3D",i[i.INT_SAMPLER_CUBE=36300]="INT_SAMPLER_CUBE",i[i.INT_SAMPLER_2D_ARRAY=36303]="INT_SAMPLER_2D_ARRAY",i[i.UNSIGNED_INT_SAMPLER_2D=36306]="UNSIGNED_INT_SAMPLER_2D",i[i.UNSIGNED_INT_SAMPLER_3D=36307]="UNSIGNED_INT_SAMPLER_3D",i[i.UNSIGNED_INT_SAMPLER_CUBE=36308]="UNSIGNED_INT_SAMPLER_CUBE",i[i.UNSIGNED_INT_SAMPLER_2D_ARRAY=36311]="UNSIGNED_INT_SAMPLER_2D_ARRAY",i[i.MAX_SAMPLES=36183]="MAX_SAMPLES",i[i.SAMPLER_BINDING=35097]="SAMPLER_BINDING",i[i.PIXEL_PACK_BUFFER=35051]="PIXEL_PACK_BUFFER",i[i.PIXEL_UNPACK_BUFFER=35052]="PIXEL_UNPACK_BUFFER",i[i.PIXEL_PACK_BUFFER_BINDING=35053]="PIXEL_PACK_BUFFER_BINDING",i[i.PIXEL_UNPACK_BUFFER_BINDING=35055]="PIXEL_UNPACK_BUFFER_BINDING",i[i.COPY_READ_BUFFER=36662]="COPY_READ_BUFFER",i[i.COPY_WRITE_BUFFER=36663]="COPY_WRITE_BUFFER",i[i.COPY_READ_BUFFER_BINDING=36662]="COPY_READ_BUFFER_BINDING",i[i.COPY_WRITE_BUFFER_BINDING=36663]="COPY_WRITE_BUFFER_BINDING",i[i.FLOAT_MAT2x3=35685]="FLOAT_MAT2x3",i[i.FLOAT_MAT2x4=35686]="FLOAT_MAT2x4",i[i.FLOAT_MAT3x2=35687]="FLOAT_MAT3x2",i[i.FLOAT_MAT3x4=35688]="FLOAT_MAT3x4",i[i.FLOAT_MAT4x2=35689]="FLOAT_MAT4x2",i[i.FLOAT_MAT4x3=35690]="FLOAT_MAT4x3",i[i.UNSIGNED_INT_VEC2=36294]="UNSIGNED_INT_VEC2",i[i.UNSIGNED_INT_VEC3=36295]="UNSIGNED_INT_VEC3",i[i.UNSIGNED_INT_VEC4=36296]="UNSIGNED_INT_VEC4",i[i.UNSIGNED_NORMALIZED=35863]="UNSIGNED_NORMALIZED",i[i.SIGNED_NORMALIZED=36764]="SIGNED_NORMALIZED",i[i.VERTEX_ATTRIB_ARRAY_INTEGER=35069]="VERTEX_ATTRIB_ARRAY_INTEGER",i[i.VERTEX_ATTRIB_ARRAY_DIVISOR=35070]="VERTEX_ATTRIB_ARRAY_DIVISOR",i[i.TRANSFORM_FEEDBACK_BUFFER_MODE=35967]="TRANSFORM_FEEDBACK_BUFFER_MODE",i[i.MAX_TRANSFORM_FEEDBACK_SEPARATE_COMPONENTS=35968]="MAX_TRANSFORM_FEEDBACK_SEPARATE_COMPONENTS",i[i.TRANSFORM_FEEDBACK_VARYINGS=35971]="TRANSFORM_FEEDBACK_VARYINGS",i[i.TRANSFORM_FEEDBACK_BUFFER_START=35972]="TRANSFORM_FEEDBACK_BUFFER_START",i[i.TRANSFORM_FEEDBACK_BUFFER_SIZE=35973]="TRANSFORM_FEEDBACK_BUFFER_SIZE",i[i.TRANSFORM_FEEDBACK_PRIMITIVES_WRITTEN=35976]="TRANSFORM_FEEDBACK_PRIMITIVES_WRITTEN",i[i.MAX_TRANSFORM_FEEDBACK_INTERLEAVED_COMPONENTS=35978]="MAX_TRANSFORM_FEEDBACK_INTERLEAVED_COMPONENTS",i[i.MAX_TRANSFORM_FEEDBACK_SEPARATE_ATTRIBS=35979]="MAX_TRANSFORM_FEEDBACK_SEPARATE_ATTRIBS",i[i.INTERLEAVED_ATTRIBS=35980]="INTERLEAVED_ATTRIBS",i[i.SEPARATE_ATTRIBS=35981]="SEPARATE_ATTRIBS",i[i.TRANSFORM_FEEDBACK_BUFFER=35982]="TRANSFORM_FEEDBACK_BUFFER",i[i.TRANSFORM_FEEDBACK_BUFFER_BINDING=35983]="TRANSFORM_FEEDBACK_BUFFER_BINDING",i[i.TRANSFORM_FEEDBACK=36386]="TRANSFORM_FEEDBACK",i[i.TRANSFORM_FEEDBACK_PAUSED=36387]="TRANSFORM_FEEDBACK_PAUSED",i[i.TRANSFORM_FEEDBACK_ACTIVE=36388]="TRANSFORM_FEEDBACK_ACTIVE",i[i.TRANSFORM_FEEDBACK_BINDING=36389]="TRANSFORM_FEEDBACK_BINDING",i[i.FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING=33296]="FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING",i[i.FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE=33297]="FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE",i[i.FRAMEBUFFER_ATTACHMENT_RED_SIZE=33298]="FRAMEBUFFER_ATTACHMENT_RED_SIZE",i[i.FRAMEBUFFER_ATTACHMENT_GREEN_SIZE=33299]="FRAMEBUFFER_ATTACHMENT_GREEN_SIZE",i[i.FRAMEBUFFER_ATTACHMENT_BLUE_SIZE=33300]="FRAMEBUFFER_ATTACHMENT_BLUE_SIZE",i[i.FRAMEBUFFER_ATTACHMENT_ALPHA_SIZE=33301]="FRAMEBUFFER_ATTACHMENT_ALPHA_SIZE",i[i.FRAMEBUFFER_ATTACHMENT_DEPTH_SIZE=33302]="FRAMEBUFFER_ATTACHMENT_DEPTH_SIZE",i[i.FRAMEBUFFER_ATTACHMENT_STENCIL_SIZE=33303]="FRAMEBUFFER_ATTACHMENT_STENCIL_SIZE",i[i.FRAMEBUFFER_DEFAULT=33304]="FRAMEBUFFER_DEFAULT",i[i.DEPTH24_STENCIL8=35056]="DEPTH24_STENCIL8",i[i.DRAW_FRAMEBUFFER_BINDING=36006]="DRAW_FRAMEBUFFER_BINDING",i[i.READ_FRAMEBUFFER_BINDING=36010]="READ_FRAMEBUFFER_BINDING",i[i.RENDERBUFFER_SAMPLES=36011]="RENDERBUFFER_SAMPLES",i[i.FRAMEBUFFER_ATTACHMENT_TEXTURE_LAYER=36052]="FRAMEBUFFER_ATTACHMENT_TEXTURE_LAYER",i[i.FRAMEBUFFER_INCOMPLETE_MULTISAMPLE=36182]="FRAMEBUFFER_INCOMPLETE_MULTISAMPLE",i[i.UNIFORM_BUFFER=35345]="UNIFORM_BUFFER",i[i.UNIFORM_BUFFER_BINDING=35368]="UNIFORM_BUFFER_BINDING",i[i.UNIFORM_BUFFER_START=35369]="UNIFORM_BUFFER_START",i[i.UNIFORM_BUFFER_SIZE=35370]="UNIFORM_BUFFER_SIZE",i[i.MAX_VERTEX_UNIFORM_BLOCKS=35371]="MAX_VERTEX_UNIFORM_BLOCKS",i[i.MAX_FRAGMENT_UNIFORM_BLOCKS=35373]="MAX_FRAGMENT_UNIFORM_BLOCKS",i[i.MAX_COMBINED_UNIFORM_BLOCKS=35374]="MAX_COMBINED_UNIFORM_BLOCKS",i[i.MAX_UNIFORM_BUFFER_BINDINGS=35375]="MAX_UNIFORM_BUFFER_BINDINGS",i[i.MAX_UNIFORM_BLOCK_SIZE=35376]="MAX_UNIFORM_BLOCK_SIZE",i[i.MAX_COMBINED_VERTEX_UNIFORM_COMPONENTS=35377]="MAX_COMBINED_VERTEX_UNIFORM_COMPONENTS",i[i.MAX_COMBINED_FRAGMENT_UNIFORM_COMPONENTS=35379]="MAX_COMBINED_FRAGMENT_UNIFORM_COMPONENTS",i[i.UNIFORM_BUFFER_OFFSET_ALIGNMENT=35380]="UNIFORM_BUFFER_OFFSET_ALIGNMENT",i[i.ACTIVE_UNIFORM_BLOCKS=35382]="ACTIVE_UNIFORM_BLOCKS",i[i.UNIFORM_TYPE=35383]="UNIFORM_TYPE",i[i.UNIFORM_SIZE=35384]="UNIFORM_SIZE",i[i.UNIFORM_BLOCK_INDEX=35386]="UNIFORM_BLOCK_INDEX",i[i.UNIFORM_OFFSET=35387]="UNIFORM_OFFSET",i[i.UNIFORM_ARRAY_STRIDE=35388]="UNIFORM_ARRAY_STRIDE",i[i.UNIFORM_MATRIX_STRIDE=35389]="UNIFORM_MATRIX_STRIDE",i[i.UNIFORM_IS_ROW_MAJOR=35390]="UNIFORM_IS_ROW_MAJOR",i[i.UNIFORM_BLOCK_BINDING=35391]="UNIFORM_BLOCK_BINDING",i[i.UNIFORM_BLOCK_DATA_SIZE=35392]="UNIFORM_BLOCK_DATA_SIZE",i[i.UNIFORM_BLOCK_ACTIVE_UNIFORMS=35394]="UNIFORM_BLOCK_ACTIVE_UNIFORMS",i[i.UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES=35395]="UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES",i[i.UNIFORM_BLOCK_REFERENCED_BY_VERTEX_SHADER=35396]="UNIFORM_BLOCK_REFERENCED_BY_VERTEX_SHADER",i[i.UNIFORM_BLOCK_REFERENCED_BY_FRAGMENT_SHADER=35398]="UNIFORM_BLOCK_REFERENCED_BY_FRAGMENT_SHADER",i[i.OBJECT_TYPE=37138]="OBJECT_TYPE",i[i.SYNC_CONDITION=37139]="SYNC_CONDITION",i[i.SYNC_STATUS=37140]="SYNC_STATUS",i[i.SYNC_FLAGS=37141]="SYNC_FLAGS",i[i.SYNC_FENCE=37142]="SYNC_FENCE",i[i.SYNC_GPU_COMMANDS_COMPLETE=37143]="SYNC_GPU_COMMANDS_COMPLETE",i[i.UNSIGNALED=37144]="UNSIGNALED",i[i.SIGNALED=37145]="SIGNALED",i[i.ALREADY_SIGNALED=37146]="ALREADY_SIGNALED",i[i.TIMEOUT_EXPIRED=37147]="TIMEOUT_EXPIRED",i[i.CONDITION_SATISFIED=37148]="CONDITION_SATISFIED",i[i.WAIT_FAILED=37149]="WAIT_FAILED",i[i.SYNC_FLUSH_COMMANDS_BIT=1]="SYNC_FLUSH_COMMANDS_BIT",i[i.COLOR=6144]="COLOR",i[i.DEPTH=6145]="DEPTH",i[i.STENCIL=6146]="STENCIL",i[i.MIN=32775]="MIN",i[i.MAX=32776]="MAX",i[i.DEPTH_COMPONENT24=33190]="DEPTH_COMPONENT24",i[i.STREAM_READ=35041]="STREAM_READ",i[i.STREAM_COPY=35042]="STREAM_COPY",i[i.STATIC_READ=35045]="STATIC_READ",i[i.STATIC_COPY=35046]="STATIC_COPY",i[i.DYNAMIC_READ=35049]="DYNAMIC_READ",i[i.DYNAMIC_COPY=35050]="DYNAMIC_COPY",i[i.DEPTH_COMPONENT32F=36012]="DEPTH_COMPONENT32F",i[i.DEPTH32F_STENCIL8=36013]="DEPTH32F_STENCIL8",i[i.INVALID_INDEX=4294967295]="INVALID_INDEX",i[i.TIMEOUT_IGNORED=-1]="TIMEOUT_IGNORED",i[i.MAX_CLIENT_WAIT_TIMEOUT_WEBGL=37447]="MAX_CLIENT_WAIT_TIMEOUT_WEBGL",i[i.UNMASKED_VENDOR_WEBGL=37445]="UNMASKED_VENDOR_WEBGL",i[i.UNMASKED_RENDERER_WEBGL=37446]="UNMASKED_RENDERER_WEBGL",i[i.MAX_TEXTURE_MAX_ANISOTROPY_EXT=34047]="MAX_TEXTURE_MAX_ANISOTROPY_EXT",i[i.TEXTURE_MAX_ANISOTROPY_EXT=34046]="TEXTURE_MAX_ANISOTROPY_EXT",i[i.R16_EXT=33322]="R16_EXT",i[i.RG16_EXT=33324]="RG16_EXT",i[i.RGB16_EXT=32852]="RGB16_EXT",i[i.RGBA16_EXT=32859]="RGBA16_EXT",i[i.R16_SNORM_EXT=36760]="R16_SNORM_EXT",i[i.RG16_SNORM_EXT=36761]="RG16_SNORM_EXT",i[i.RGB16_SNORM_EXT=36762]="RGB16_SNORM_EXT",i[i.RGBA16_SNORM_EXT=36763]="RGBA16_SNORM_EXT",i[i.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",i[i.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",i[i.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",i[i.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",i[i.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",i[i.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",i[i.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",i[i.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",i[i.COMPRESSED_RED_RGTC1_EXT=36283]="COMPRESSED_RED_RGTC1_EXT",i[i.COMPRESSED_SIGNED_RED_RGTC1_EXT=36284]="COMPRESSED_SIGNED_RED_RGTC1_EXT",i[i.COMPRESSED_RED_GREEN_RGTC2_EXT=36285]="COMPRESSED_RED_GREEN_RGTC2_EXT",i[i.COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT=36286]="COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT",i[i.COMPRESSED_RGBA_BPTC_UNORM_EXT=36492]="COMPRESSED_RGBA_BPTC_UNORM_EXT",i[i.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT=36493]="COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT",i[i.COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT=36494]="COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT",i[i.COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT=36495]="COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT",i[i.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",i[i.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",i[i.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",i[i.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",i[i.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",i[i.COMPRESSED_RGBA8_ETC2_EAC=37493]="COMPRESSED_RGBA8_ETC2_EAC",i[i.COMPRESSED_SRGB8_ETC2=37494]="COMPRESSED_SRGB8_ETC2",i[i.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37495]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC",i[i.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37496]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",i[i.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37497]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",i[i.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",i[i.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",i[i.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",i[i.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",i[i.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",i[i.COMPRESSED_RGB_ATC_WEBGL=35986]="COMPRESSED_RGB_ATC_WEBGL",i[i.COMPRESSED_RGBA_ATC_EXPLICIT_ALPHA_WEBGL=35986]="COMPRESSED_RGBA_ATC_EXPLICIT_ALPHA_WEBGL",i[i.COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL=34798]="COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL",i[i.COMPRESSED_RGBA_ASTC_4x4_KHR=37808]="COMPRESSED_RGBA_ASTC_4x4_KHR",i[i.COMPRESSED_RGBA_ASTC_5x4_KHR=37809]="COMPRESSED_RGBA_ASTC_5x4_KHR",i[i.COMPRESSED_RGBA_ASTC_5x5_KHR=37810]="COMPRESSED_RGBA_ASTC_5x5_KHR",i[i.COMPRESSED_RGBA_ASTC_6x5_KHR=37811]="COMPRESSED_RGBA_ASTC_6x5_KHR",i[i.COMPRESSED_RGBA_ASTC_6x6_KHR=37812]="COMPRESSED_RGBA_ASTC_6x6_KHR",i[i.COMPRESSED_RGBA_ASTC_8x5_KHR=37813]="COMPRESSED_RGBA_ASTC_8x5_KHR",i[i.COMPRESSED_RGBA_ASTC_8x6_KHR=37814]="COMPRESSED_RGBA_ASTC_8x6_KHR",i[i.COMPRESSED_RGBA_ASTC_8x8_KHR=37815]="COMPRESSED_RGBA_ASTC_8x8_KHR",i[i.COMPRESSED_RGBA_ASTC_10x5_KHR=37816]="COMPRESSED_RGBA_ASTC_10x5_KHR",i[i.COMPRESSED_RGBA_ASTC_10x6_KHR=37817]="COMPRESSED_RGBA_ASTC_10x6_KHR",i[i.COMPRESSED_RGBA_ASTC_10x8_KHR=37818]="COMPRESSED_RGBA_ASTC_10x8_KHR",i[i.COMPRESSED_RGBA_ASTC_10x10_KHR=37819]="COMPRESSED_RGBA_ASTC_10x10_KHR",i[i.COMPRESSED_RGBA_ASTC_12x10_KHR=37820]="COMPRESSED_RGBA_ASTC_12x10_KHR",i[i.COMPRESSED_RGBA_ASTC_12x12_KHR=37821]="COMPRESSED_RGBA_ASTC_12x12_KHR",i[i.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840]="COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR",i[i.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR=37841]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR",i[i.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR=37842]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR",i[i.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR=37843]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR",i[i.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR=37844]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR",i[i.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR=37845]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR",i[i.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR=37846]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR",i[i.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR=37847]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR",i[i.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR=37848]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR",i[i.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR=37849]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR",i[i.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR=37850]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR",i[i.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR=37851]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR",i[i.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR=37852]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR",i[i.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR=37853]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR",i[i.QUERY_COUNTER_BITS_EXT=34916]="QUERY_COUNTER_BITS_EXT",i[i.CURRENT_QUERY_EXT=34917]="CURRENT_QUERY_EXT",i[i.QUERY_RESULT_EXT=34918]="QUERY_RESULT_EXT",i[i.QUERY_RESULT_AVAILABLE_EXT=34919]="QUERY_RESULT_AVAILABLE_EXT",i[i.TIME_ELAPSED_EXT=35007]="TIME_ELAPSED_EXT",i[i.TIMESTAMP_EXT=36392]="TIMESTAMP_EXT",i[i.GPU_DISJOINT_EXT=36795]="GPU_DISJOINT_EXT",i[i.COMPLETION_STATUS_KHR=37297]="COMPLETION_STATUS_KHR",i[i.DEPTH_CLAMP_EXT=34383]="DEPTH_CLAMP_EXT",i[i.FIRST_VERTEX_CONVENTION_WEBGL=36429]="FIRST_VERTEX_CONVENTION_WEBGL",i[i.LAST_VERTEX_CONVENTION_WEBGL=36430]="LAST_VERTEX_CONVENTION_WEBGL",i[i.PROVOKING_VERTEX_WEBL=36431]="PROVOKING_VERTEX_WEBL",i[i.POLYGON_MODE_WEBGL=2880]="POLYGON_MODE_WEBGL",i[i.POLYGON_OFFSET_LINE_WEBGL=10754]="POLYGON_OFFSET_LINE_WEBGL",i[i.LINE_WEBGL=6913]="LINE_WEBGL",i[i.FILL_WEBGL=6914]="FILL_WEBGL",i[i.MAX_CLIP_DISTANCES_WEBGL=3378]="MAX_CLIP_DISTANCES_WEBGL",i[i.MAX_CULL_DISTANCES_WEBGL=33529]="MAX_CULL_DISTANCES_WEBGL",i[i.MAX_COMBINED_CLIP_AND_CULL_DISTANCES_WEBGL=33530]="MAX_COMBINED_CLIP_AND_CULL_DISTANCES_WEBGL",i[i.CLIP_DISTANCE0_WEBGL=12288]="CLIP_DISTANCE0_WEBGL",i[i.CLIP_DISTANCE1_WEBGL=12289]="CLIP_DISTANCE1_WEBGL",i[i.CLIP_DISTANCE2_WEBGL=12290]="CLIP_DISTANCE2_WEBGL",i[i.CLIP_DISTANCE3_WEBGL=12291]="CLIP_DISTANCE3_WEBGL",i[i.CLIP_DISTANCE4_WEBGL=12292]="CLIP_DISTANCE4_WEBGL",i[i.CLIP_DISTANCE5_WEBGL=12293]="CLIP_DISTANCE5_WEBGL",i[i.CLIP_DISTANCE6_WEBGL=12294]="CLIP_DISTANCE6_WEBGL",i[i.CLIP_DISTANCE7_WEBGL=12295]="CLIP_DISTANCE7_WEBGL",i[i.POLYGON_OFFSET_CLAMP_EXT=36379]="POLYGON_OFFSET_CLAMP_EXT",i[i.LOWER_LEFT_EXT=36001]="LOWER_LEFT_EXT",i[i.UPPER_LEFT_EXT=36002]="UPPER_LEFT_EXT",i[i.NEGATIVE_ONE_TO_ONE_EXT=37726]="NEGATIVE_ONE_TO_ONE_EXT",i[i.ZERO_TO_ONE_EXT=37727]="ZERO_TO_ONE_EXT",i[i.CLIP_ORIGIN_EXT=37724]="CLIP_ORIGIN_EXT",i[i.CLIP_DEPTH_MODE_EXT=37725]="CLIP_DEPTH_MODE_EXT",i[i.SRC1_COLOR_WEBGL=35065]="SRC1_COLOR_WEBGL",i[i.SRC1_ALPHA_WEBGL=34185]="SRC1_ALPHA_WEBGL",i[i.ONE_MINUS_SRC1_COLOR_WEBGL=35066]="ONE_MINUS_SRC1_COLOR_WEBGL",i[i.ONE_MINUS_SRC1_ALPHA_WEBGL=35067]="ONE_MINUS_SRC1_ALPHA_WEBGL",i[i.MAX_DUAL_SOURCE_DRAW_BUFFERS_WEBGL=35068]="MAX_DUAL_SOURCE_DRAW_BUFFERS_WEBGL",i[i.MIRROR_CLAMP_TO_EDGE_EXT=34627]="MIRROR_CLAMP_TO_EDGE_EXT"})(lc||(lc={}));const dL={WEBGL_depth_texture:{UNSIGNED_INT_24_8_WEBGL:34042},OES_element_index_uint:{},OES_texture_float:{},OES_texture_half_float:{HALF_FLOAT_OES:5131},EXT_color_buffer_float:{},OES_standard_derivatives:{FRAGMENT_SHADER_DERIVATIVE_HINT_OES:35723},EXT_frag_depth:{},EXT_blend_minmax:{MIN_EXT:32775,MAX_EXT:32776},EXT_shader_texture_lod:{}},fL=i=>({drawBuffersWEBGL(e){return i.drawBuffers(e)},COLOR_ATTACHMENT0_WEBGL:36064,COLOR_ATTACHMENT1_WEBGL:36065,COLOR_ATTACHMENT2_WEBGL:36066,COLOR_ATTACHMENT3_WEBGL:36067}),pL=i=>({VERTEX_ARRAY_BINDING_OES:34229,createVertexArrayOES(){return i.createVertexArray()},deleteVertexArrayOES(e){return i.deleteVertexArray(e)},isVertexArrayOES(e){return i.isVertexArray(e)},bindVertexArrayOES(e){return i.bindVertexArray(e)}}),gL=i=>({VERTEX_ATTRIB_ARRAY_DIVISOR_ANGLE:35070,drawArraysInstancedANGLE(...e){return i.drawArraysInstanced(...e)},drawElementsInstancedANGLE(...e){return i.drawElementsInstanced(...e)},vertexAttribDivisorANGLE(...e){return i.vertexAttribDivisor(...e)}});function mL(i=!0){const e=HTMLCanvasElement.prototype;if(!i&&e.originalGetContext){e.getContext=e.originalGetContext,e.originalGetContext=void 0;return}e.originalGetContext=e.getContext,e.getContext=function(t,r){if(t==="webgl"||t==="experimental-webgl"){const s=this.originalGetContext("webgl2",r);return s instanceof HTMLElement&&_L(s),s}return this.originalGetContext(t,r)}}function _L(i){i.getExtension("EXT_color_buffer_float");const e={...dL,WEBGL_disjoint_timer_query:i.getExtension("EXT_disjoint_timer_query_webgl2"),WEBGL_draw_buffers:fL(i),OES_vertex_array_object:pL(i),ANGLE_instanced_arrays:gL(i)},t=i.getExtension;i.getExtension=function(s){const a=t.call(i,s);return a||(s in e?e[s]:null)};const r=i.getSupportedExtensions;i.getSupportedExtensions=function(){return(r.apply(i)||[])?.concat(Object.keys(e))}}async function Y2(i,e){const t=document.getElementsByTagName("head")[0];if(!t)throw new Error("loadScript");const r=document.createElement("script");return r.setAttribute("type","text/javascript"),r.setAttribute("src",i),new Promise((s,a)=>{r.onload=s,r.onerror=u=>a(new Error(`Unable to load script '${i}': ${u}`)),t.appendChild(r)})}const yL=1;let ks=null,f0=!1;const wy={debugSpectorJS:Qe.get("debug-spectorjs"),debugSpectorJSUrl:"https://cdn.jsdelivr.net/npm/spectorjs@0.9.30/dist/spector.bundle.js",gl:void 0};async function xL(i){if(!globalThis.SPECTOR)try{await Y2(i.debugSpectorJSUrl||wy.debugSpectorJSUrl)}catch(e){Qe.warn(String(e))}}function vL(i){if(i={...wy,...i},!i.debugSpectorJS)return null;if(!ks&&globalThis.SPECTOR&&!globalThis.luma?.spector){Qe.probe(yL,"SPECTOR found and initialized. Start with `luma.spector.displayUI()`")();const{Spector:e}=globalThis.SPECTOR;ks=new e,globalThis.luma&&(globalThis.luma.spector=ks)}if(!ks)return null;if(f0||(f0=!0,ks.spyCanvases(),ks?.onCaptureStarted.add(e=>Qe.info("Spector capture started:",e)()),ks?.onCapture.add(e=>{Qe.info("Spector capture complete:",e)(),ks?.getResultUI(),ks?.resultView.display(),ks?.resultView.addCapture(e)})),i.gl){const e=i.gl,t=e.device;ks?.startCapture(i.gl,500),e.device=t,new Promise(r=>setTimeout(r,2e3)).then(r=>{Qe.info("Spector capture stopped after 2 seconds")(),ks?.stopCapture()})}return ks}const bL="https://unpkg.com/webgl-debug@2.0.1/index.js";function G2(i){return i.luma=i.luma||{},i.luma}async function wL(){Ja()&&!globalThis.WebGLDebugUtils&&(globalThis.global=globalThis.global||globalThis,globalThis.global.module={},await Y2(bL))}function TL(i,e={}){return e.debugWebGL||e.traceWebGL?AL(i,e):SL(i)}function SL(i){const e=G2(i);return e.realContext?e.realContext:i}function AL(i,e){if(!globalThis.WebGLDebugUtils)return Qe.warn("webgl-debug not loaded")(),i;const t=G2(i);if(t.debugContext)return t.debugContext;globalThis.WebGLDebugUtils.init({...lc,...i});const r=globalThis.WebGLDebugUtils.makeDebugContext(i,EL.bind(null,e),IL.bind(null,e));for(const u in lc)!(u in r)&&typeof lc[u]=="number"&&(r[u]=lc[u]);class s{}Object.setPrototypeOf(r,Object.getPrototypeOf(i)),Object.setPrototypeOf(s,r);const a=Object.create(s);return t.realContext=i,t.debugContext=a,a.debug=!0,a}function p0(i,e){e=Array.from(e).map(r=>r===void 0?"undefined":r);let t=globalThis.WebGLDebugUtils.glFunctionArgsToString(i,e);return t=`${t.slice(0,100)}${t.length>100?"...":""}`,`gl.${i}(${t})`}function EL(i,e,t,r){r=Array.from(r).map(l=>l===void 0?"undefined":l);const s=globalThis.WebGLDebugUtils.glEnumToString(e),a=globalThis.WebGLDebugUtils.glFunctionArgsToString(t,r),u=`${s} in gl.${t}(${a})`;Qe.error(u)();debugger}function IL(i,e,t){let r="";Qe.level>=1&&(r=p0(e,t),i.traceWebGL&&Qe.log(1,r)());for(const s of t)if(s===void 0){r=r||p0(e,t);debugger}}const cf=1;class CL extends UC{type="webgl";constructor(){super(),qa.defaultProps={...qa.defaultProps,...wy}}enforceWebGL2(e){mL(e)}isSupported(){return typeof WebGL2RenderingContext<"u"}isDeviceHandle(e){return typeof WebGL2RenderingContext<"u"&&e instanceof WebGL2RenderingContext?!0:(typeof WebGLRenderingContext<"u"&&e instanceof WebGLRenderingContext&&Qe.warn("WebGL1 is not supported",e)(),!1)}async attach(e,t={}){const{WebGLDevice:r}=await Um(async()=>{const{WebGLDevice:a}=await Promise.resolve().then(()=>M0);return{WebGLDevice:a}},void 0);if(e instanceof r)return e;if(e?.device instanceof r)return e.device;if(!PL(e))throw new Error("Invalid WebGL2RenderingContext");const s=t.createCanvasContext===!0?{}:t.createCanvasContext;return new r({...t,_handle:e,createCanvasContext:{canvas:e.canvas,autoResize:!1,...s}})}async create(e={}){const{WebGLDevice:t}=await Um(async()=>{const{WebGLDevice:r}=await Promise.resolve().then(()=>M0);return{WebGLDevice:r}},void 0);Qe.groupCollapsed(cf,"WebGLDevice created")();try{const r=[];(e.debugWebGL||e.debug)&&r.push(wL()),e.debugSpectorJS&&r.push(xL(e));const s=await Promise.allSettled(r);for(const l of s)l.status==="rejected"&&Qe.error(`Failed to initialize debug libraries ${l.reason}`)();const a=new t(e),u=`${a._reused?"Reusing":"Created"} device with WebGL2 ${a.props.debug?"debug ":""}context: ${a.info.vendor}, ${a.info.renderer} for canvas: ${a.canvasContext.id}`;return Qe.probe(cf,u)(),Qe.table(cf,a.info)(),a}finally{Qe.groupEnd(cf)()}}}function PL(i){return typeof WebGL2RenderingContext<"u"&&i instanceof WebGL2RenderingContext?!0:!!(i&&Number.isFinite(i._version))}const vm=new CL,Ty={3042:!1,32773:new Float32Array([0,0,0,0]),32777:32774,34877:32774,32969:1,32968:0,32971:1,32970:0,3106:new Float32Array([0,0,0,0]),3107:[!0,!0,!0,!0],2884:!1,2885:1029,2929:!1,2931:1,2932:513,2928:new Float32Array([0,1]),2930:!0,3024:!0,35725:null,36006:null,36007:null,34229:null,34964:null,2886:2305,33170:4352,2849:1,32823:!1,32824:0,10752:0,32926:!1,32928:!1,32938:1,32939:!1,3089:!1,3088:new Int32Array([0,0,1024,1024]),2960:!1,2961:0,2968:4294967295,36005:4294967295,2962:519,2967:0,2963:4294967295,34816:519,36003:0,36004:4294967295,2964:7680,2965:7680,2966:7680,34817:7680,34818:7680,34819:7680,2978:[0,0,1024,1024],36389:null,36662:null,36663:null,35053:null,35055:null,35723:4352,36010:null,35977:!1,3333:4,3317:4,37440:!1,37441:!1,37443:37444,3330:0,3332:0,3331:0,3314:0,32878:0,3316:0,3315:0,32877:0},nr=(i,e,t)=>e?i.enable(t):i.disable(t),g0=(i,e,t)=>i.hint(t,e),Ds=(i,e,t)=>i.pixelStorei(t,e),m0=(i,e,t)=>{const r=t===36006?36009:36008;return i.bindFramebuffer(r,e)},Wu=(i,e,t)=>{const s={34964:34962,36662:36662,36663:36663,35053:35051,35055:35052}[t];i.bindBuffer(s,e)};function bm(i){return Array.isArray(i)||ArrayBuffer.isView(i)&&!(i instanceof DataView)}const ML={3042:nr,32773:(i,e)=>i.blendColor(...e),32777:"blendEquation",34877:"blendEquation",32969:"blendFunc",32968:"blendFunc",32971:"blendFunc",32970:"blendFunc",3106:(i,e)=>i.clearColor(...e),3107:(i,e)=>i.colorMask(...e),2884:nr,2885:(i,e)=>i.cullFace(e),2929:nr,2931:(i,e)=>i.clearDepth(e),2932:(i,e)=>i.depthFunc(e),2928:(i,e)=>i.depthRange(...e),2930:(i,e)=>i.depthMask(e),3024:nr,35723:g0,35725:(i,e)=>i.useProgram(e),36007:(i,e)=>i.bindRenderbuffer(36161,e),36389:(i,e)=>i.bindTransformFeedback?.(36386,e),34229:(i,e)=>i.bindVertexArray(e),36006:m0,36010:m0,34964:Wu,36662:Wu,36663:Wu,35053:Wu,35055:Wu,2886:(i,e)=>i.frontFace(e),33170:g0,2849:(i,e)=>i.lineWidth(e),32823:nr,32824:"polygonOffset",10752:"polygonOffset",35977:nr,32926:nr,32928:nr,32938:"sampleCoverage",32939:"sampleCoverage",3089:nr,3088:(i,e)=>i.scissor(...e),2960:nr,2961:(i,e)=>i.clearStencil(e),2968:(i,e)=>i.stencilMaskSeparate(1028,e),36005:(i,e)=>i.stencilMaskSeparate(1029,e),2962:"stencilFuncFront",2967:"stencilFuncFront",2963:"stencilFuncFront",34816:"stencilFuncBack",36003:"stencilFuncBack",36004:"stencilFuncBack",2964:"stencilOpFront",2965:"stencilOpFront",2966:"stencilOpFront",34817:"stencilOpBack",34818:"stencilOpBack",34819:"stencilOpBack",2978:(i,e)=>i.viewport(...e),34383:nr,10754:nr,12288:nr,12289:nr,12290:nr,12291:nr,12292:nr,12293:nr,12294:nr,12295:nr,3333:Ds,3317:Ds,37440:Ds,37441:Ds,37443:Ds,3330:Ds,3332:Ds,3331:Ds,3314:Ds,32878:Ds,3316:Ds,3315:Ds,32877:Ds,framebuffer:(i,e)=>{const t=e&&"handle"in e?e.handle:e;return i.bindFramebuffer(36160,t)},blend:(i,e)=>e?i.enable(3042):i.disable(3042),blendColor:(i,e)=>i.blendColor(...e),blendEquation:(i,e)=>{const t=typeof e=="number"?[e,e]:e;i.blendEquationSeparate(...t)},blendFunc:(i,e)=>{const t=e?.length===2?[...e,...e]:e;i.blendFuncSeparate(...t)},clearColor:(i,e)=>i.clearColor(...e),clearDepth:(i,e)=>i.clearDepth(e),clearStencil:(i,e)=>i.clearStencil(e),colorMask:(i,e)=>i.colorMask(...e),cull:(i,e)=>e?i.enable(2884):i.disable(2884),cullFace:(i,e)=>i.cullFace(e),depthTest:(i,e)=>e?i.enable(2929):i.disable(2929),depthFunc:(i,e)=>i.depthFunc(e),depthMask:(i,e)=>i.depthMask(e),depthRange:(i,e)=>i.depthRange(...e),dither:(i,e)=>e?i.enable(3024):i.disable(3024),derivativeHint:(i,e)=>{i.hint(35723,e)},frontFace:(i,e)=>i.frontFace(e),mipmapHint:(i,e)=>i.hint(33170,e),lineWidth:(i,e)=>i.lineWidth(e),polygonOffsetFill:(i,e)=>e?i.enable(32823):i.disable(32823),polygonOffset:(i,e)=>i.polygonOffset(...e),sampleCoverage:(i,e)=>i.sampleCoverage(e[0],e[1]||!1),scissorTest:(i,e)=>e?i.enable(3089):i.disable(3089),scissor:(i,e)=>i.scissor(...e),stencilTest:(i,e)=>e?i.enable(2960):i.disable(2960),stencilMask:(i,e)=>{e=bm(e)?e:[e,e];const[t,r]=e;i.stencilMaskSeparate(1028,t),i.stencilMaskSeparate(1029,r)},stencilFunc:(i,e)=>{e=bm(e)&&e.length===3?[...e,...e]:e;const[t,r,s,a,u,l]=e;i.stencilFuncSeparate(1028,t,r,s),i.stencilFuncSeparate(1029,a,u,l)},stencilOp:(i,e)=>{e=bm(e)&&e.length===3?[...e,...e]:e;const[t,r,s,a,u,l]=e;i.stencilOpSeparate(1028,t,r,s),i.stencilOpSeparate(1029,a,u,l)},viewport:(i,e)=>i.viewport(...e)};function Gi(i,e,t){return e[i]!==void 0?e[i]:t[i]}const RL={blendEquation:(i,e,t)=>i.blendEquationSeparate(Gi(32777,e,t),Gi(34877,e,t)),blendFunc:(i,e,t)=>i.blendFuncSeparate(Gi(32969,e,t),Gi(32968,e,t),Gi(32971,e,t),Gi(32970,e,t)),polygonOffset:(i,e,t)=>i.polygonOffset(Gi(32824,e,t),Gi(10752,e,t)),sampleCoverage:(i,e,t)=>i.sampleCoverage(Gi(32938,e,t),Gi(32939,e,t)),stencilFuncFront:(i,e,t)=>i.stencilFuncSeparate(1028,Gi(2962,e,t),Gi(2967,e,t),Gi(2963,e,t)),stencilFuncBack:(i,e,t)=>i.stencilFuncSeparate(1029,Gi(34816,e,t),Gi(36003,e,t),Gi(36004,e,t)),stencilOpFront:(i,e,t)=>i.stencilOpSeparate(1028,Gi(2964,e,t),Gi(2965,e,t),Gi(2966,e,t)),stencilOpBack:(i,e,t)=>i.stencilOpSeparate(1029,Gi(34817,e,t),Gi(34818,e,t),Gi(34819,e,t))},_0={enable:(i,e)=>i({[e]:!0}),disable:(i,e)=>i({[e]:!1}),pixelStorei:(i,e,t)=>i({[e]:t}),hint:(i,e,t)=>i({[e]:t}),useProgram:(i,e)=>i({35725:e}),bindRenderbuffer:(i,e,t)=>i({36007:t}),bindTransformFeedback:(i,e,t)=>i({36389:t}),bindVertexArray:(i,e)=>i({34229:e}),bindFramebuffer:(i,e,t)=>{switch(e){case 36160:return i({36006:t,36010:t});case 36009:return i({36006:t});case 36008:return i({36010:t});default:return null}},bindBuffer:(i,e,t)=>{const r={34962:[34964],36662:[36662],36663:[36663],35051:[35053],35052:[35055]}[e];return r?i({[r]:t}):{valueChanged:!0}},blendColor:(i,e,t,r,s)=>i({32773:new Float32Array([e,t,r,s])}),blendEquation:(i,e)=>i({32777:e,34877:e}),blendEquationSeparate:(i,e,t)=>i({32777:e,34877:t}),blendFunc:(i,e,t)=>i({32969:e,32968:t,32971:e,32970:t}),blendFuncSeparate:(i,e,t,r,s)=>i({32969:e,32968:t,32971:r,32970:s}),clearColor:(i,e,t,r,s)=>i({3106:new Float32Array([e,t,r,s])}),clearDepth:(i,e)=>i({2931:e}),clearStencil:(i,e)=>i({2961:e}),colorMask:(i,e,t,r,s)=>i({3107:[e,t,r,s]}),cullFace:(i,e)=>i({2885:e}),depthFunc:(i,e)=>i({2932:e}),depthRange:(i,e,t)=>i({2928:new Float32Array([e,t])}),depthMask:(i,e)=>i({2930:e}),frontFace:(i,e)=>i({2886:e}),lineWidth:(i,e)=>i({2849:e}),polygonOffset:(i,e,t)=>i({32824:e,10752:t}),sampleCoverage:(i,e,t)=>i({32938:e,32939:t}),scissor:(i,e,t,r,s)=>i({3088:new Int32Array([e,t,r,s])}),stencilMask:(i,e)=>i({2968:e,36005:e}),stencilMaskSeparate:(i,e,t)=>i({[e===1028?2968:36005]:t}),stencilFunc:(i,e,t,r)=>i({2962:e,2967:t,2963:r,34816:e,36003:t,36004:r}),stencilFuncSeparate:(i,e,t,r,s)=>i({[e===1028?2962:34816]:t,[e===1028?2967:36003]:r,[e===1028?2963:36004]:s}),stencilOp:(i,e,t,r)=>i({2964:e,2965:t,2966:r,34817:e,34818:t,34819:r}),stencilOpSeparate:(i,e,t,r,s)=>i({[e===1028?2964:34817]:t,[e===1028?2965:34818]:r,[e===1028?2966:34819]:s}),viewport:(i,e,t,r,s)=>i({2978:[e,t,r,s]})},bn=(i,e)=>i.isEnabled(e),y0={3042:bn,2884:bn,2929:bn,3024:bn,32823:bn,32926:bn,32928:bn,3089:bn,2960:bn,35977:bn},kL=new Set([34016,36388,36387,35983,35368,34965,35739,35738,3074,34853,34854,34855,34856,34857,34858,34859,34860,34861,34862,34863,34864,34865,34866,34867,34868,35097,32873,35869,32874,34068]);function Dc(i,e){if(OL(e))return;const t={};for(const s in e){const a=Number(s),u=ML[s];u&&(typeof u=="string"?t[u]=!0:u(i,e[s],a))}const r=i.state&&i.state.cache;if(r)for(const s in t){const a=RL[s];a(i,e,r)}}function K2(i,e=Ty){if(typeof e=="number"){const s=e,a=y0[s];return a?a(i,s):i.getParameter(s)}const t=Array.isArray(e)?e:Object.keys(e),r={};for(const s of t){const a=y0[s];r[s]=a?a(i,Number(s)):i.getParameter(Number(s))}return r}function DL(i){Dc(i,Ty)}function OL(i){for(const e in i)return!1;return!0}function LL(i,e){if(i===e)return!0;if(x0(i)&&x0(e)&&i.length===e.length){for(let t=0;t<i.length;++t)if(i[t]!==e[t])return!1;return!0}return!1}function x0(i){return Array.isArray(i)||ArrayBuffer.isView(i)}class Wa{static get(e){return e.state}gl;program=null;stateStack=[];enable=!0;cache=null;log;initialized=!1;constructor(e,t){this.gl=e,this.log=t?.log||(()=>{}),this._updateCache=this._updateCache.bind(this),Object.seal(this)}push(e={}){this.stateStack.push({})}pop(){const e=this.stateStack[this.stateStack.length-1];Dc(this.gl,e),this.stateStack.pop()}trackState(e,t){if(this.cache=t?.copyState?K2(e):Object.assign({},Ty),this.initialized)throw new Error("WebGLStateTracker");this.initialized=!0,this.gl.state=this,BL(e);for(const r in _0){const s=_0[r];FL(e,r,s)}v0(e,"getParameter"),v0(e,"isEnabled")}_updateCache(e){let t=!1,r;const s=this.stateStack.length>0?this.stateStack[this.stateStack.length-1]:null;for(const a in e){const u=e[a],l=this.cache[a];LL(u,l)||(t=!0,r=l,s&&!(a in s)&&(s[a]=l),this.cache[a]=u)}return{valueChanged:t,oldValue:r}}}function v0(i,e){const t=i[e].bind(i);i[e]=function(s){if(s===void 0||kL.has(s))return t(s);const a=Wa.get(i);return s in a.cache||(a.cache[s]=t(s)),a.enable?a.cache[s]:t(s)},Object.defineProperty(i[e],"name",{value:`${e}-from-cache`,configurable:!1})}function FL(i,e,t){if(!i[e])return;const r=i[e].bind(i);i[e]=function(...a){const u=Wa.get(i),{valueChanged:l,oldValue:g}=t(u._updateCache,...a);return l&&r(...a),g},Object.defineProperty(i[e],"name",{value:`${e}-to-cache`,configurable:!1})}function BL(i){const e=i.useProgram.bind(i);i.useProgram=function(r){const s=Wa.get(i);s.program!==r&&(e(r),s.program=r)}}function NL(i,e,t){let r="";const s={preserveDrawingBuffer:!0,...t};let a=null;if(a||=i.getContext("webgl2",s),s.failIfMajorPerformanceCaveat&&(r||="Only software GPU is available. Set `failIfMajorPerformanceCaveat: false` to allow."),!a&&!t.failIfMajorPerformanceCaveat&&(s.failIfMajorPerformanceCaveat=!1,a=i.getContext("webgl2",s),a.luma||={},a.luma.softwareRenderer=!0),a||(a=i.getContext("webgl",{}),a&&(a=null,r||="Your browser only supports WebGL1")),!a)throw r||="Your browser does not support WebGL",new Error(`Failed to create WebGL context: ${r}`);const{onContextLost:u,onContextRestored:l}=e;return i.addEventListener("webglcontextlost",g=>u(g),!1),i.addEventListener("webglcontextrestored",g=>l(g),!1),a.luma||={},a}function Ic(i,e,t){return t[e]===void 0&&(t[e]=i.getExtension(e)||null),t[e]}function zL(i,e){const t=i.getParameter(7936),r=i.getParameter(7937);Ic(i,"WEBGL_debug_renderer_info",e);const s=e.WEBGL_debug_renderer_info,a=i.getParameter(s?s.UNMASKED_VENDOR_WEBGL:7936),u=i.getParameter(s?s.UNMASKED_RENDERER_WEBGL:7937),l=a||t,g=u||r,v=i.getParameter(7938),T=J2(l,g),S=UL(l,g),P=VL(l,g);return{type:"webgl",gpu:T,gpuType:P,gpuBackend:S,vendor:l,renderer:g,version:v,shadingLanguage:"glsl",shadingLanguageVersion:300}}function J2(i,e){return/NVIDIA/i.exec(i)||/NVIDIA/i.exec(e)?"nvidia":/INTEL/i.exec(i)||/INTEL/i.exec(e)?"intel":/Apple/i.exec(i)||/Apple/i.exec(e)?"apple":/AMD/i.exec(i)||/AMD/i.exec(e)||/ATI/i.exec(i)||/ATI/i.exec(e)?"amd":/SwiftShader/i.exec(i)||/SwiftShader/i.exec(e)?"software":"unknown"}function UL(i,e){return/Metal/i.exec(i)||/Metal/i.exec(e)?"metal":/ANGLE/i.exec(i)||/ANGLE/i.exec(e)?"opengl":"unknown"}function VL(i,e){if(/SwiftShader/i.exec(i)||/SwiftShader/i.exec(e))return"cpu";switch(J2(i,e)){case"intel":return"integrated";case"software":return"cpu";case"unknown":return"unknown";default:return"discrete"}}function Q2(i){switch(i){case"uint8":return 5121;case"sint8":return 5120;case"unorm8":return 5121;case"snorm8":return 5120;case"uint16":return 5123;case"sint16":return 5122;case"unorm16":return 5123;case"snorm16":return 5122;case"uint32":return 5125;case"sint32":return 5124;case"float16":return 5131;case"float32":return 5126}throw new Error(String(i))}const fh="WEBGL_compressed_texture_s3tc",ph="WEBGL_compressed_texture_s3tc_srgb",cc="EXT_texture_compression_rgtc",uc="EXT_texture_compression_bptc",jL="WEBGL_compressed_texture_etc",$L="WEBGL_compressed_texture_astc",WL="WEBGL_compressed_texture_etc1",HL="WEBGL_compressed_texture_pvrtc",qL="WEBGL_compressed_texture_atc",b0="EXT_texture_norm16",w0="EXT_render_snorm",XL="EXT_color_buffer_float",Sy={"float32-renderable-webgl":["EXT_color_buffer_float"],"float16-renderable-webgl":["EXT_color_buffer_half_float"],"rgb9e5ufloat-renderable-webgl":["WEBGL_render_shared_exponent"],"snorm8-renderable-webgl":[w0],"norm16-renderable-webgl":[b0],"snorm16-renderable-webgl":[b0,w0],"float32-filterable":["OES_texture_float_linear"],"float16-filterable-webgl":["OES_texture_half_float_linear"],"texture-filterable-anisotropic-webgl":["EXT_texture_filter_anisotropic"],"texture-blend-float-webgl":["EXT_float_blend"],"texture-compression-bc":[fh,ph,cc,uc],"texture-compression-bc5-webgl":[cc],"texture-compression-bc7-webgl":[uc],"texture-compression-etc2":[jL],"texture-compression-astc":[$L],"texture-compression-etc1-webgl":[WL],"texture-compression-pvrtc-webgl":[HL],"texture-compression-atc-webgl":[qL]};function ZL(i){return i in Sy}function YL(i,e,t){return(Sy[e]||[]).every(s=>Ic(i,s,t))}const Ay={r8unorm:{gl:33321,rb:!0},r8snorm:{gl:36756},r8uint:{gl:33330,rb:!0},r8sint:{gl:33329,rb:!0},rg8unorm:{gl:33323,rb:!0},rg8snorm:{gl:36757},rg8uint:{gl:33336,rb:!0},rg8sint:{gl:33335,rb:!0},r16uint:{gl:33332,rb:!0},r16sint:{gl:33331,rb:!0},r16float:{gl:33325,rb:!0},r16unorm:{gl:33322,rb:!0},r16snorm:{gl:36760},"rgba4unorm-webgl":{gl:32854,rb:!0},"rgb565unorm-webgl":{gl:36194,rb:!0},"rgb5a1unorm-webgl":{gl:32855,rb:!0},"rgb8unorm-webgl":{gl:32849},"rgb8snorm-webgl":{gl:36758},rgba8unorm:{gl:32856},"rgba8unorm-srgb":{gl:35907},rgba8snorm:{gl:36759},rgba8uint:{gl:36220},rgba8sint:{gl:36238},bgra8unorm:{},"bgra8unorm-srgb":{},rg16uint:{gl:33338},rg16sint:{gl:33337},rg16float:{gl:33327,rb:!0},rg16unorm:{gl:33324},rg16snorm:{gl:36761},r32uint:{gl:33334,rb:!0},r32sint:{gl:33333,rb:!0},r32float:{gl:33326},rgb9e5ufloat:{gl:35901},rg11b10ufloat:{gl:35898,rb:!0},rgb10a2unorm:{gl:32857,rb:!0},rgb10a2uint:{gl:36975,rb:!0},"rgb16unorm-webgl":{gl:32852},"rgb16snorm-webgl":{gl:36762},rg32uint:{gl:33340,rb:!0},rg32sint:{gl:33339,rb:!0},rg32float:{gl:33328,rb:!0},rgba16uint:{gl:36214,rb:!0},rgba16sint:{gl:36232,rb:!0},rgba16float:{gl:34842},rgba16unorm:{gl:32859,rb:!0},rgba16snorm:{gl:36763},"rgb32float-webgl":{gl:34837,x:XL,dataFormat:6407,types:[5126]},rgba32uint:{gl:36208,rb:!0},rgba32sint:{gl:36226,rb:!0},rgba32float:{gl:34836,rb:!0},stencil8:{gl:36168,rb:!0},depth16unorm:{gl:33189,dataFormat:6402,types:[5123],rb:!0},depth24plus:{gl:33190,dataFormat:6402,types:[5125]},depth32float:{gl:36012,dataFormat:6402,types:[5126],rb:!0},"depth24plus-stencil8":{gl:35056,rb:!0,depthTexture:!0,dataFormat:34041,types:[34042]},"depth32float-stencil8":{gl:36013,dataFormat:34041,types:[36269],rb:!0},"bc1-rgb-unorm-webgl":{gl:33776,x:fh},"bc1-rgb-unorm-srgb-webgl":{gl:35916,x:ph},"bc1-rgba-unorm":{gl:33777,x:fh},"bc1-rgba-unorm-srgb":{gl:35916,x:ph},"bc2-rgba-unorm":{gl:33778,x:fh},"bc2-rgba-unorm-srgb":{gl:35918,x:ph},"bc3-rgba-unorm":{gl:33779,x:fh},"bc3-rgba-unorm-srgb":{gl:35919,x:ph},"bc4-r-unorm":{gl:36283,x:cc},"bc4-r-snorm":{gl:36284,x:cc},"bc5-rg-unorm":{gl:36285,x:cc},"bc5-rg-snorm":{gl:36286,x:cc},"bc6h-rgb-ufloat":{gl:36495,x:uc},"bc6h-rgb-float":{gl:36494,x:uc},"bc7-rgba-unorm":{gl:36492,x:uc},"bc7-rgba-unorm-srgb":{gl:36493,x:uc},"etc2-rgb8unorm":{gl:37492},"etc2-rgb8unorm-srgb":{gl:37494},"etc2-rgb8a1unorm":{gl:37496},"etc2-rgb8a1unorm-srgb":{gl:37497},"etc2-rgba8unorm":{gl:37493},"etc2-rgba8unorm-srgb":{gl:37495},"eac-r11unorm":{gl:37488},"eac-r11snorm":{gl:37489},"eac-rg11unorm":{gl:37490},"eac-rg11snorm":{gl:37491},"astc-4x4-unorm":{gl:37808},"astc-4x4-unorm-srgb":{gl:37840},"astc-5x4-unorm":{gl:37809},"astc-5x4-unorm-srgb":{gl:37841},"astc-5x5-unorm":{gl:37810},"astc-5x5-unorm-srgb":{gl:37842},"astc-6x5-unorm":{gl:37811},"astc-6x5-unorm-srgb":{gl:37843},"astc-6x6-unorm":{gl:37812},"astc-6x6-unorm-srgb":{gl:37844},"astc-8x5-unorm":{gl:37813},"astc-8x5-unorm-srgb":{gl:37845},"astc-8x6-unorm":{gl:37814},"astc-8x6-unorm-srgb":{gl:37846},"astc-8x8-unorm":{gl:37815},"astc-8x8-unorm-srgb":{gl:37847},"astc-10x5-unorm":{gl:37819},"astc-10x5-unorm-srgb":{gl:37851},"astc-10x6-unorm":{gl:37817},"astc-10x6-unorm-srgb":{gl:37849},"astc-10x8-unorm":{gl:37818},"astc-10x8-unorm-srgb":{gl:37850},"astc-10x10-unorm":{gl:37819},"astc-10x10-unorm-srgb":{gl:37851},"astc-12x10-unorm":{gl:37820},"astc-12x10-unorm-srgb":{gl:37852},"astc-12x12-unorm":{gl:37821},"astc-12x12-unorm-srgb":{gl:37853},"pvrtc-rgb4unorm-webgl":{gl:35840},"pvrtc-rgba4unorm-webgl":{gl:35842},"pvrtc-rbg2unorm-webgl":{gl:35841},"pvrtc-rgba2unorm-webgl":{gl:35843},"etc1-rbg-unorm-webgl":{gl:36196},"atc-rgb-unorm-webgl":{gl:35986},"atc-rgba-unorm-webgl":{gl:35986},"atc-rgbai-unorm-webgl":{gl:34798}};function GL(i,e,t){let r=e.create;const s=Ay[e.format];return s?.gl===void 0&&(r=!1),s?.x&&(r=r&&!!Ic(i,s.x,t)),{format:e.format,create:r&&e.create,render:r&&e.render,filter:r&&e.filter,blend:r&&e.blend,store:r&&e.store}}function eT(i){const e=Ay[i],t=QL(i),r=mc.getInfo(i);return r.compressed&&(e.dataFormat=t),{internalFormat:t,format:e?.dataFormat||JL(r.channels,r.integer,r.normalized,t),type:r.dataType?Q2(r.dataType):e?.types?.[0]||5121,compressed:r.compressed||!1}}function KL(i){switch(mc.getInfo(i).attachment){case"depth":return 36096;case"stencil":return 36128;case"depth-stencil":return 33306;default:throw new Error(`Not a depth stencil format: ${i}`)}}function JL(i,e,t,r){if(r===6408||r===6407)return r;switch(i){case"r":return e&&!t?36244:6403;case"rg":return e&&!t?33320:33319;case"rgb":return e&&!t?36248:6407;case"rgba":return e&&!t?36249:6408;case"bgra":throw new Error("bgra pixels not supported by WebGL");default:return 6408}}function QL(i){const t=Ay[i]?.gl;if(t===void 0)throw new Error(`Unsupported texture format ${i}`);return t}const T0={"depth-clip-control":"EXT_depth_clamp","timer-query-webgl":"EXT_disjoint_timer_query_webgl2","compilation-status-async-webgl":"KHR_parallel_shader_compile","polygon-mode-webgl":"WEBGL_polygon_mode","provoking-vertex-webgl":"WEBGL_provoking_vertex","shader-clip-cull-distance-webgl":"WEBGL_clip_cull_distance","shader-noperspective-interpolation-webgl":"NV_shader_noperspective_interpolation","shader-conservative-depth-webgl":"EXT_conservative_depth"};class e4 extends NC{gl;extensions;testedFeatures=new Set;constructor(e,t,r){super([],r),this.gl=e,this.extensions=t,Ic(e,"EXT_color_buffer_float",t)}*[Symbol.iterator](){const e=this.getFeatures();for(const t of e)this.has(t)&&(yield t);return[]}has(e){return this.disabledFeatures?.[e]?!1:(this.testedFeatures.has(e)||(this.testedFeatures.add(e),ZL(e)&&YL(this.gl,e,this.extensions)&&this.features.add(e),this.getWebGLFeature(e)&&this.features.add(e)),this.features.has(e))}initializeFeatures(){const e=this.getFeatures().filter(t=>t!=="polygon-mode-webgl");for(const t of e)this.has(t)}getFeatures(){return[...Object.keys(T0),...Object.keys(Sy)]}getWebGLFeature(e){const t=T0[e];return typeof t=="string"?!!Ic(this.gl,t,this.extensions):!!t}}class t4 extends BC{get maxTextureDimension1D(){return 0}get maxTextureDimension2D(){return this.getParameter(3379)}get maxTextureDimension3D(){return this.getParameter(32883)}get maxTextureArrayLayers(){return this.getParameter(35071)}get maxBindGroups(){return 0}get maxDynamicUniformBuffersPerPipelineLayout(){return 0}get maxDynamicStorageBuffersPerPipelineLayout(){return 0}get maxSampledTexturesPerShaderStage(){return this.getParameter(35660)}get maxSamplersPerShaderStage(){return this.getParameter(35661)}get maxStorageBuffersPerShaderStage(){return 0}get maxStorageTexturesPerShaderStage(){return 0}get maxUniformBuffersPerShaderStage(){return this.getParameter(35375)}get maxUniformBufferBindingSize(){return this.getParameter(35376)}get maxStorageBufferBindingSize(){return 0}get minUniformBufferOffsetAlignment(){return this.getParameter(35380)}get minStorageBufferOffsetAlignment(){return 0}get maxVertexBuffers(){return 16}get maxVertexAttributes(){return this.getParameter(34921)}get maxVertexBufferArrayStride(){return 2048}get maxInterStageShaderVariables(){return this.getParameter(35659)}get maxComputeWorkgroupStorageSize(){return 0}get maxComputeInvocationsPerWorkgroup(){return 0}get maxComputeWorkgroupSizeX(){return 0}get maxComputeWorkgroupSizeY(){return 0}get maxComputeWorkgroupSizeZ(){return 0}get maxComputeWorkgroupsPerDimension(){return 0}gl;limits={};constructor(e){super(),this.gl=e}getParameter(e){return this.limits[e]===void 0&&(this.limits[e]=this.gl.getParameter(e)),this.limits[e]||0}}class Sh extends _p{device;gl;handle;colorAttachments=[];depthStencilAttachment=null;constructor(e,t){super(e,t);const r=t.handle===null;this.device=e,this.gl=e.gl,this.handle=this.props.handle||r?this.props.handle:this.gl.createFramebuffer(),r||(e._setWebGLDebugMetadata(this.handle,this,{spector:this.props}),this.autoCreateAttachmentTextures(),this.updateAttachments())}destroy(){super.destroy(),!this.destroyed&&this.handle!==null&&this.gl.deleteFramebuffer(this.handle)}updateAttachments(){const e=this.gl.bindFramebuffer(36160,this.handle);for(let t=0;t<this.colorAttachments.length;++t){const r=this.colorAttachments[t];if(r){const s=36064+t;this._attachTextureView(s,r)}}if(this.depthStencilAttachment){const t=KL(this.depthStencilAttachment.props.format);this._attachTextureView(t,this.depthStencilAttachment)}if(this.device.props.debug){const t=this.gl.checkFramebufferStatus(36160);if(t!==36053)throw new Error(`Framebuffer ${r4(t)}`)}this.gl.bindFramebuffer(36160,e)}_attachTextureView(e,t){const{gl:r}=this.device,{texture:s}=t,a=t.props.baseMipLevel,u=t.props.baseArrayLayer;switch(r.bindTexture(s.glTarget,s.handle),s.glTarget){case 35866:case 32879:r.framebufferTextureLayer(36160,e,s.handle,a,u);break;case 34067:const l=i4(u);r.framebufferTexture2D(36160,e,l,s.handle,a);break;case 3553:r.framebufferTexture2D(36160,e,3553,s.handle,a);break;default:throw new Error("Illegal texture type")}r.bindTexture(s.glTarget,null)}}function i4(i){return i<34069?i+34069:i}function r4(i){switch(i){case 36053:return"success";case 36054:return"Mismatched attachments";case 36055:return"No attachments";case 36057:return"Height/width mismatch";case 36061:return"Unsupported or split attachments";case 36182:return"Samples mismatch";default:return`${i}`}}class s4 extends Ba{device;handle=null;_framebuffer=null;get[Symbol.toStringTag](){return"WebGLCanvasContext"}constructor(e,t){super(t),this.device=e,this._setAutoCreatedCanvasId(`${this.device.id}-canvas`),this._updateDevice()}getCurrentFramebuffer(){return this._framebuffer=this._framebuffer||new Sh(this.device,{handle:null}),this._framebuffer}_updateDevice(){}}const wm={};function n4(i="id"){wm[i]=wm[i]||1;const e=wm[i]++;return`${i}-${e}`}class Ah extends Oi{device;gl;handle;glTarget;glUsage;glIndexType=5123;byteLength=0;bytesUsed=0;constructor(e,t={}){super(e,t),this.device=e,this.gl=this.device.gl;const r=typeof t=="object"?t.handle:void 0;this.handle=r||this.gl.createBuffer(),e._setWebGLDebugMetadata(this.handle,this,{spector:{...this.props,data:typeof this.props.data}}),this.glTarget=o4(this.props.usage),this.glUsage=a4(this.props.usage),this.glIndexType=this.props.indexType==="uint32"?5125:5123,t.data?this._initWithData(t.data,t.byteOffset,t.byteLength):this._initWithByteLength(t.byteLength||0)}destroy(){!this.destroyed&&this.handle&&(this.removeStats(),this.trackDeallocatedMemory(),this.gl.deleteBuffer(this.handle),this.destroyed=!0,this.handle=null)}_initWithData(e,t=0,r=e.byteLength+t){const s=this.glTarget;this.gl.bindBuffer(s,this.handle),this.gl.bufferData(s,r,this.glUsage),this.gl.bufferSubData(s,t,e),this.gl.bindBuffer(s,null),this.bytesUsed=r,this.byteLength=r,this._setDebugData(e,t,r),this.trackAllocatedMemory(r)}_initWithByteLength(e){let t=e;e===0&&(t=new Float32Array(0));const r=this.glTarget;return this.gl.bindBuffer(r,this.handle),this.gl.bufferData(r,t,this.glUsage),this.gl.bindBuffer(r,null),this.bytesUsed=e,this.byteLength=e,this._setDebugData(null,0,e),this.trackAllocatedMemory(e),this}write(e,t=0){const r=ArrayBuffer.isView(e)?e:new Uint8Array(e),s=36663;this.gl.bindBuffer(s,this.handle),this.gl.bufferSubData(s,t,r),this.gl.bindBuffer(s,null),this._setDebugData(e,t,e.byteLength)}async mapAndWriteAsync(e,t=0,r=this.byteLength-t){const s=new ArrayBuffer(r);await e(s,"copied"),this.write(s,t)}async readAsync(e=0,t){return this.readSyncWebGL(e,t)}async mapAndReadAsync(e,t=0,r){const s=await this.readAsync(t,r);return await e(s.buffer,"copied")}readSyncWebGL(e=0,t){t=t??this.byteLength-e;const r=new Uint8Array(t),s=0;return this.gl.bindBuffer(36662,this.handle),this.gl.getBufferSubData(36662,e,r,s,t),this.gl.bindBuffer(36662,null),this._setDebugData(r,e,t),r}}function o4(i){return i&Oi.INDEX?34963:i&Oi.VERTEX?34962:i&Oi.UNIFORM?35345:34962}function a4(i){return i&Oi.INDEX||i&Oi.VERTEX?35044:i&Oi.UNIFORM?35048:35044}function l4(i){const e=i.split(/\r?\n/),t=[];for(const r of e){if(r.length<=1)continue;const s=r.split(":");if(s.length===2){const[S,P]=s;t.push({message:P.trim(),type:S0(S),lineNum:0,linePos:0});continue}const[a,u,l,...g]=s;let v=parseInt(l,10);isNaN(v)&&(v=0);let T=parseInt(u,10);isNaN(T)&&(T=0),t.push({message:g.join(":").trim(),type:S0(a),lineNum:v,linePos:T})}return t}function S0(i){const e=["warning","error","info"],t=i.toLowerCase();return e.includes(t)?t:"info"}class c4 extends mp{device;handle;constructor(e,t){switch(super(e,t),this.device=e,this.props.stage){case"vertex":this.handle=this.props.handle||this.device.gl.createShader(35633);break;case"fragment":this.handle=this.props.handle||this.device.gl.createShader(35632);break;default:throw new Error(this.props.stage)}e._setWebGLDebugMetadata(this.handle,this,{spector:this.props}),this._compile(this.source)}destroy(){this.handle&&(this.removeStats(),this.device.gl.deleteShader(this.handle),this.destroyed=!0,this.handle.destroyed=!0)}get asyncCompilationStatus(){return this._waitForCompilationComplete().then(()=>(this._getCompilationStatus(),this.compilationStatus))}async getCompilationInfo(){return await this._waitForCompilationComplete(),this.getCompilationInfoSync()}getCompilationInfoSync(){const e=this.device.gl.getShaderInfoLog(this.handle);return e?l4(e):[]}getTranslatedSource(){return this.device.getExtension("WEBGL_debug_shaders").WEBGL_debug_shaders?.getTranslatedShaderSource(this.handle)||null}async _compile(e){e=e.startsWith("#version ")?e:`#version 300 es
${e}`;const{gl:t}=this.device;if(t.shaderSource(this.handle,e),t.compileShader(this.handle),!this.device.props.debug){this.compilationStatus="pending";return}if(!this.device.features.has("compilation-status-async-webgl")){if(this._getCompilationStatus(),this.debugShader(),this.compilationStatus==="error")throw new Error(`GLSL compilation errors in ${this.props.stage} shader ${this.props.id}`);return}Qe.once(1,"Shader compilation is asynchronous")(),await this._waitForCompilationComplete(),Qe.info(2,`Shader ${this.id} - async compilation complete: ${this.compilationStatus}`)(),this._getCompilationStatus(),this.debugShader()}async _waitForCompilationComplete(){const e=async s=>await new Promise(a=>setTimeout(a,s));if(!this.device.features.has("compilation-status-async-webgl")){await e(10);return}const{gl:r}=this.device;for(;;){if(r.getShaderParameter(this.handle,37297))return;await e(10)}}_getCompilationStatus(){this.compilationStatus=this.device.gl.getShaderParameter(this.handle,35713)?"success":"error"}}function u4(i,e,t,r){if(p4(e))return r(i);const s=i;s.pushState();try{return h4(i,e),Dc(s.gl,t),r(i)}finally{s.popState()}}function h4(i,e){const t=i,{gl:r}=t;if(e.cullMode)switch(e.cullMode){case"none":r.disable(2884);break;case"front":r.enable(2884),r.cullFace(1028);break;case"back":r.enable(2884),r.cullFace(1029);break}if(e.frontFace&&r.frontFace(Ha("frontFace",e.frontFace,{ccw:2305,cw:2304})),e.unclippedDepth&&i.features.has("depth-clip-control")&&r.enable(34383),e.depthBias!==void 0&&(r.enable(32823),r.polygonOffset(e.depthBias,e.depthBiasSlopeScale||0)),e.provokingVertex&&i.features.has("provoking-vertex-webgl")){const a=t.getExtension("WEBGL_provoking_vertex").WEBGL_provoking_vertex,u=Ha("provokingVertex",e.provokingVertex,{first:36429,last:36430});a?.provokingVertexWEBGL(u)}if((e.polygonMode||e.polygonOffsetLine)&&i.features.has("polygon-mode-webgl")){if(e.polygonMode){const a=t.getExtension("WEBGL_polygon_mode").WEBGL_polygon_mode,u=Ha("polygonMode",e.polygonMode,{fill:6914,line:6913});a?.polygonModeWEBGL(1028,u),a?.polygonModeWEBGL(1029,u)}e.polygonOffsetLine&&r.enable(10754)}if(i.features.has("shader-clip-cull-distance-webgl")&&(e.clipDistance0&&r.enable(12288),e.clipDistance1&&r.enable(12289),e.clipDistance2&&r.enable(12290),e.clipDistance3&&r.enable(12291),e.clipDistance4&&r.enable(12292),e.clipDistance5&&r.enable(12293),e.clipDistance6&&r.enable(12294),e.clipDistance7&&r.enable(12295)),e.depthWriteEnabled!==void 0&&r.depthMask(f4("depthWriteEnabled",e.depthWriteEnabled)),e.depthCompare&&(e.depthCompare!=="always"?r.enable(2929):r.disable(2929),r.depthFunc(f_("depthCompare",e.depthCompare))),e.stencilWriteMask){const s=e.stencilWriteMask;r.stencilMaskSeparate(1028,s),r.stencilMaskSeparate(1029,s)}if(e.stencilReadMask&&Qe.warn("stencilReadMask not supported under WebGL"),e.stencilCompare){const s=e.stencilReadMask||4294967295,a=f_("depthCompare",e.stencilCompare);e.stencilCompare!=="always"?r.enable(2960):r.disable(2960),r.stencilFuncSeparate(1028,a,0,s),r.stencilFuncSeparate(1029,a,0,s)}if(e.stencilPassOperation&&e.stencilFailOperation&&e.stencilDepthFailOperation){const s=Tm("stencilPassOperation",e.stencilPassOperation),a=Tm("stencilFailOperation",e.stencilFailOperation),u=Tm("stencilDepthFailOperation",e.stencilDepthFailOperation);r.stencilOpSeparate(1028,a,u,s),r.stencilOpSeparate(1029,a,u,s)}switch(e.blend){case!0:r.enable(3042);break;case!1:r.disable(3042);break}if(e.blendColorOperation||e.blendAlphaOperation){const s=A0("blendColorOperation",e.blendColorOperation||"add"),a=A0("blendAlphaOperation",e.blendAlphaOperation||"add");r.blendEquationSeparate(s,a);const u=uf("blendColorSrcFactor",e.blendColorSrcFactor||"one"),l=uf("blendColorDstFactor",e.blendColorDstFactor||"zero"),g=uf("blendAlphaSrcFactor",e.blendAlphaSrcFactor||"one"),v=uf("blendAlphaDstFactor",e.blendAlphaDstFactor||"zero");r.blendFuncSeparate(u,l,g,v)}}function f_(i,e){return Ha(i,e,{never:512,less:513,equal:514,"less-equal":515,greater:516,"not-equal":517,"greater-equal":518,always:519})}function Tm(i,e){return Ha(i,e,{keep:7680,zero:0,replace:7681,invert:5386,"increment-clamp":7682,"decrement-clamp":7683,"increment-wrap":34055,"decrement-wrap":34056})}function A0(i,e){return Ha(i,e,{add:32774,subtract:32778,"reverse-subtract":32779,min:32775,max:32776})}function uf(i,e,t="color"){return Ha(i,e,{one:1,zero:0,src:768,"one-minus-src":769,dst:774,"one-minus-dst":775,"src-alpha":770,"one-minus-src-alpha":771,"dst-alpha":772,"one-minus-dst-alpha":773,"src-alpha-saturated":776,constant:t==="color"?32769:32771,"one-minus-constant":t==="color"?32770:32772,src1:768,"one-minus-src1":769,"src1-alpha":770,"one-minus-src1-alpha":771})}function d4(i,e){return`Illegal parameter ${e} for ${i}`}function Ha(i,e,t){if(!(e in t))throw new Error(d4(i,e));return t[e]}function f4(i,e){return e}function p4(i){let e=!0;for(const t in i){e=!1;break}return e}function tT(i){const e={};return i.addressModeU&&(e[10242]=Sm(i.addressModeU)),i.addressModeV&&(e[10243]=Sm(i.addressModeV)),i.addressModeW&&(e[32882]=Sm(i.addressModeW)),i.magFilter&&(e[10240]=p_(i.magFilter)),(i.minFilter||i.mipmapFilter)&&(e[10241]=g4(i.minFilter||"linear",i.mipmapFilter)),i.lodMinClamp!==void 0&&(e[33082]=i.lodMinClamp),i.lodMaxClamp!==void 0&&(e[33083]=i.lodMaxClamp),i.type==="comparison-sampler"&&(e[34892]=34894),i.compare&&(e[34893]=f_("compare",i.compare)),i.maxAnisotropy&&(e[34046]=i.maxAnisotropy),e}function Sm(i){switch(i){case"clamp-to-edge":return 33071;case"repeat":return 10497;case"mirror-repeat":return 33648}}function p_(i){switch(i){case"nearest":return 9728;case"linear":return 9729}}function g4(i,e="none"){if(!e)return p_(i);switch(e){case"none":return p_(i);case"nearest":switch(i){case"nearest":return 9984;case"linear":return 9985}break;case"linear":switch(i){case"nearest":return 9986;case"linear":return 9987}}}class m4 extends Xa{device;handle;parameters;constructor(e,t){super(e,t),this.device=e,this.parameters=tT(t),this.handle=t.handle||this.device.gl.createSampler(),this._setSamplerParameters(this.parameters)}destroy(){this.handle&&(this.device.gl.deleteSampler(this.handle),this.handle=void 0)}toString(){return`Sampler(${this.id},${JSON.stringify(this.props)})`}_setSamplerParameters(e){for(const[t,r]of Object.entries(e)){const s=Number(t);switch(s){case 33082:case 33083:this.device.gl.samplerParameterf(this.handle,s,r);break;default:this.device.gl.samplerParameteri(this.handle,s,r);break}}}}function Dh(i,e,t){if(_4(e))return t(i);const{nocatch:r=!0}=e,s=Wa.get(i);s.push(),Dc(i,e);let a;if(r)a=t(i),s.pop();else try{a=t(i)}finally{s.pop()}return a}function _4(i){for(const e in i)return!1;return!0}class hc extends gp{device;gl;handle;texture;constructor(e,t){super(e,{...fr.defaultProps,...t}),this.device=e,this.gl=this.device.gl,this.handle=null,this.texture=t.texture}}class Eh extends fr{device;gl;handle;sampler=void 0;view;glTarget;glFormat;glType;glInternalFormat;compressed;_textureUnit=0;constructor(e,t){super(e,t),this.device=e,this.gl=this.device.gl;const r=eT(this.props.format);this.glTarget=y4(this.props.dimension),this.glInternalFormat=r.internalFormat,this.glFormat=r.format,this.glType=r.type,this.compressed=r.compressed,this.handle=this.props.handle||this.gl.createTexture(),this.device._setWebGLDebugMetadata(this.handle,this,{spector:this.props}),this.gl.bindTexture(this.glTarget,this.handle);const{dimension:s,width:a,height:u,depth:l,mipLevels:g,glTarget:v,glInternalFormat:T}=this;switch(s){case"2d":case"cube":this.gl.texStorage2D(v,g,T,a,u);break;case"2d-array":case"3d":this.gl.texStorage3D(v,g,T,a,u,l);break;default:throw new Error(s)}this.gl.bindTexture(this.glTarget,null),this._initializeData(t.data),this.setSampler(this.props.sampler),this.view=new hc(this.device,{...this.props,texture:this}),Object.seal(this)}destroy(){this.handle&&(this.gl.deleteTexture(this.handle),this.removeStats(),this.trackDeallocatedMemory("Texture"),this.destroyed=!0)}createView(e){return new hc(this.device,{...e,texture:this})}setSampler(e={}){super.setSampler(e);const t=tT(this.sampler.props);this._setSamplerParameters(t)}copyImageData(e){const t=this._normalizeCopyImageDataOptions(e),r=t.data,{width:s,height:a,depth:u}=this,{mipLevel:l=0,byteOffset:g=0,x:v=0,y:T=0,z:S=0}=t,{glFormat:P,glType:O,compressed:$}=this,W=E0(this.glTarget,this.dimension,S);let G;if(!this.compressed){const{bytesPerPixel:ae}=this.device.getTextureFormatInfo(this.format);if(ae){if(t.bytesPerRow%ae!==0)throw new Error(`bytesPerRow (${t.bytesPerRow}) must be a multiple of bytesPerPixel (${ae}) for ${this.format}`);G=t.bytesPerRow/ae}}const Q=this.compressed?{}:{...G!==void 0?{3314:G}:{},32878:t.rowsPerImage};this.gl.bindTexture(W,this.handle),Dh(this.gl,Q,()=>{switch(this.dimension){case"2d":case"cube":$?this.gl.compressedTexSubImage2D(W,l,v,T,s,a,P,r,g):this.gl.texSubImage2D(W,l,v,T,s,a,P,O,r,g);break;case"2d-array":case"3d":$?this.gl.compressedTexSubImage3D(W,l,v,T,S,s,a,u,P,r,g):this.gl.texSubImage3D(W,l,v,T,S,s,a,u,P,O,r,g);break;default:}}),this.gl.bindTexture(W,null)}copyExternalImage(e){const t=this._normalizeCopyExternalImageOptions(e);if(t.sourceX||t.sourceY)throw new Error("WebGL does not support sourceX/sourceY)");const{glFormat:r,glType:s}=this,{image:a,depth:u,mipLevel:l,x:g,y:v,z:T,width:S,height:P}=t,O=E0(this.glTarget,this.dimension,u),$=t.flipY?{37440:!0}:{};return this.gl.bindTexture(this.glTarget,this.handle),Dh(this.gl,$,()=>{switch(this.dimension){case"2d":case"cube":this.gl.texSubImage2D(O,l,g,v,S,P,r,s,a);break;case"2d-array":case"3d":this.gl.texSubImage3D(O,l,g,v,T,S,P,u,r,s,a);break;default:}}),this.gl.bindTexture(this.glTarget,null),{width:t.width,height:t.height}}generateMipmapsWebGL(e){if(!(!(this.device.isTextureFormatRenderable(this.props.format)&&this.device.isTextureFormatFilterable(this.props.format))&&(Qe.warn(`${this} is not renderable or filterable, may not be able to generate mipmaps`)(),!e?.force)))try{this.gl.bindTexture(this.glTarget,this.handle),this.gl.generateMipmap(this.glTarget)}catch(r){Qe.warn(`Error generating mipmap for ${this}: ${r.message}`)()}finally{this.gl.bindTexture(this.glTarget,null)}}_setSamplerParameters(e){Qe.log(2,`${this.id} sampler parameters`,this.device.getGLKeys(e))(),this.gl.bindTexture(this.glTarget,this.handle);for(const[t,r]of Object.entries(e)){const s=Number(t),a=r;switch(s){case 33082:case 33083:this.gl.texParameterf(this.glTarget,s,a);break;case 10240:case 10241:this.gl.texParameteri(this.glTarget,s,a);break;case 10242:case 10243:case 32882:this.gl.texParameteri(this.glTarget,s,a);break;case 34046:this.device.features.has("texture-filterable-anisotropic-webgl")&&this.gl.texParameteri(this.glTarget,s,a);break;case 34892:case 34893:this.gl.texParameteri(this.glTarget,s,a);break}}this.gl.bindTexture(this.glTarget,null)}_getActiveUnit(){return this.gl.getParameter(34016)-33984}_bind(e){const{gl:t}=this;return e!==void 0&&(this._textureUnit=e,t.activeTexture(33984+e)),t.bindTexture(this.glTarget,this.handle),e}_unbind(e){const{gl:t}=this;return e!==void 0&&(this._textureUnit=e,t.activeTexture(33984+e)),t.bindTexture(this.glTarget,null),e}}function y4(i){switch(i){case"1d":break;case"2d":return 3553;case"3d":return 32879;case"cube":return 34067;case"2d-array":return 35866}throw new Error(i)}function E0(i,e,t){return e==="cube"?34069+t:i}function x4(i){return T4[i]}function Ey(i){return w4[i]}function v4(i){return!!iT[i]}function b4(i){return iT[i]}const w4={5126:"f32",35664:"vec2<f32>",35665:"vec3<f32>",35666:"vec4<f32>",5124:"i32",35667:"vec2<i32>",35668:"vec3<i32>",35669:"vec4<i32>",5125:"u32",36294:"vec2<u32>",36295:"vec3<u32>",36296:"vec4<u32>",35670:"f32",35671:"vec2<f32>",35672:"vec3<f32>",35673:"vec4<f32>",35674:"mat2x2<f32>",35685:"mat2x3<f32>",35686:"mat2x4<f32>",35687:"mat3x2<f32>",35675:"mat3x3<f32>",35688:"mat3x4<f32>",35689:"mat4x2<f32>",35690:"mat4x3<f32>",35676:"mat4x4<f32>"},iT={35678:{viewDimension:"2d",sampleType:"float"},35680:{viewDimension:"cube",sampleType:"float"},35679:{viewDimension:"3d",sampleType:"float"},35682:{viewDimension:"3d",sampleType:"depth"},36289:{viewDimension:"2d-array",sampleType:"float"},36292:{viewDimension:"2d-array",sampleType:"depth"},36293:{viewDimension:"cube",sampleType:"float"},36298:{viewDimension:"2d",sampleType:"sint"},36299:{viewDimension:"3d",sampleType:"sint"},36300:{viewDimension:"cube",sampleType:"sint"},36303:{viewDimension:"2d-array",sampleType:"uint"},36306:{viewDimension:"2d",sampleType:"uint"},36307:{viewDimension:"3d",sampleType:"uint"},36308:{viewDimension:"cube",sampleType:"uint"},36311:{viewDimension:"2d-array",sampleType:"uint"}},T4={uint8:5121,sint8:5120,unorm8:5121,snorm8:5120,uint16:5123,sint16:5122,unorm16:5123,snorm16:5122,uint32:5125,sint32:5124,float16:5131,float32:5126};function S4(i,e){const t={attributes:[],bindings:[]};t.attributes=A4(i,e);const r=C4(i,e);for(const l of r){const g=l.uniforms.map(v=>({name:v.name,format:v.format,byteOffset:v.byteOffset,byteStride:v.byteStride,arrayLength:v.arrayLength}));t.bindings.push({type:"uniform",name:l.name,group:0,location:l.location,visibility:(l.vertex?1:0)&(l.fragment?2:0),minBindingSize:l.byteLength,uniforms:g})}const s=I4(i,e);let a=0;for(const l of s)if(v4(l.type)){const{viewDimension:g,sampleType:v}=b4(l.type);t.bindings.push({type:"texture",name:l.name,group:0,location:a,viewDimension:g,sampleType:v}),l.textureUnit=a,a+=1}s.length&&(t.uniforms=s);const u=E4(i,e);return u?.length&&(t.varyings=u),t}function A4(i,e){const t=[],r=i.getProgramParameter(e,35721);for(let s=0;s<r;s++){const a=i.getActiveAttrib(e,s);if(!a)throw new Error("activeInfo");const{name:u,type:l}=a,g=i.getAttribLocation(e,u);if(g>=0){const v=Ey(l),T=/instance/i.test(u)?"instance":"vertex";t.push({name:u,location:g,stepMode:T,type:v})}}return t.sort((s,a)=>s.location-a.location),t}function E4(i,e){const t=[],r=i.getProgramParameter(e,35971);for(let s=0;s<r;s++){const a=i.getTransformFeedbackVarying(e,s);if(!a)throw new Error("activeInfo");const{name:u,type:l,size:g}=a,v=Ey(l),{type:T,components:S}=L1(v);t.push({location:s,name:u,type:T,size:g*S})}return t.sort((s,a)=>s.location-a.location),t}function I4(i,e){const t=[],r=i.getProgramParameter(e,35718);for(let s=0;s<r;s++){const a=i.getActiveUniform(e,s);if(!a)throw new Error("activeInfo");const{name:u,size:l,type:g}=a,{name:v,isArray:T}=P4(u);let S=i.getUniformLocation(e,v);const P={location:S,name:v,size:l,type:g,isArray:T};if(t.push(P),P.size>1)for(let O=0;O<P.size;O++){const $=`${v}[${O}]`;S=i.getUniformLocation(e,$);const W={...P,name:$,location:S};t.push(W)}}return t}function C4(i,e){const t=(a,u)=>i.getActiveUniformBlockParameter(e,a,u),r=[],s=i.getProgramParameter(e,35382);for(let a=0;a<s;a++){const u={name:i.getActiveUniformBlockName(e,a)||"",location:t(a,35391),byteLength:t(a,35392),vertex:t(a,35396),fragment:t(a,35398),uniformCount:t(a,35394),uniforms:[]},l=t(a,35395)||[],g=i.getActiveUniforms(e,l,35383),v=i.getActiveUniforms(e,l,35384),T=i.getActiveUniforms(e,l,35387),S=i.getActiveUniforms(e,l,35388);for(let P=0;P<u.uniformCount;++P){const O=i.getActiveUniform(e,l[P]);if(!O)throw new Error("activeInfo");const $=Ey(g[P]);u.uniforms.push({name:O.name,format:$,type:g[P],arrayLength:v[P],byteOffset:T[P],byteStride:S[P]})}r.push(u)}return r.sort((a,u)=>a.location-u.location),r}function P4(i){if(i[i.length-1]!=="]")return{name:i,length:1,isArray:!1};const t=/([^[]*)(\[[0-9]+\])?/.exec(i);if(!t||t.length<2)throw new Error(`Failed to parse GLSL uniform name ${i}`);return{name:t[1],length:t[2]?1:0,isArray:!!t[2]}}function M4(i,e,t,r){const s=i;let a=r;a===!0&&(a=1),a===!1&&(a=0);const u=typeof a=="number"?[a]:a;switch(t){case 35678:case 35680:case 35679:case 35682:case 36289:case 36292:case 36293:case 36298:case 36299:case 36300:case 36303:case 36306:case 36307:case 36308:case 36311:if(typeof r!="number")throw new Error("samplers must be set to integers");return i.uniform1i(e,r);case 5126:return i.uniform1fv(e,u);case 35664:return i.uniform2fv(e,u);case 35665:return i.uniform3fv(e,u);case 35666:return i.uniform4fv(e,u);case 5124:return i.uniform1iv(e,u);case 35667:return i.uniform2iv(e,u);case 35668:return i.uniform3iv(e,u);case 35669:return i.uniform4iv(e,u);case 35670:return i.uniform1iv(e,u);case 35671:return i.uniform2iv(e,u);case 35672:return i.uniform3iv(e,u);case 35673:return i.uniform4iv(e,u);case 5125:return s.uniform1uiv(e,u,1);case 36294:return s.uniform2uiv(e,u,2);case 36295:return s.uniform3uiv(e,u,3);case 36296:return s.uniform4uiv(e,u,4);case 35674:return i.uniformMatrix2fv(e,!1,u);case 35675:return i.uniformMatrix3fv(e,!1,u);case 35676:return i.uniformMatrix4fv(e,!1,u);case 35685:return s.uniformMatrix2x3fv(e,!1,u);case 35686:return s.uniformMatrix2x4fv(e,!1,u);case 35687:return s.uniformMatrix3x2fv(e,!1,u);case 35688:return s.uniformMatrix3x4fv(e,!1,u);case 35689:return s.uniformMatrix4x2fv(e,!1,u);case 35690:return s.uniformMatrix4x3fv(e,!1,u)}throw new Error("Illegal uniform")}function R4(i){switch(i){case"point-list":return 0;case"line-list":return 1;case"line-strip":return 3;case"triangle-list":return 4;case"triangle-strip":return 5;default:throw new Error(i)}}function k4(i){switch(i){case"point-list":return 0;case"line-list":return 1;case"line-strip":return 1;case"triangle-list":return 4;case"triangle-strip":return 4;default:throw new Error(i)}}const I0=4;class D4 extends Va{device;handle;vs;fs;introspectedLayout;uniforms={};bindings={};varyings=null;_uniformCount=0;_uniformSetters={};get[Symbol.toStringTag](){return"WEBGLRenderPipeline"}constructor(e,t){super(e,t),this.device=e,this.handle=this.props.handle||this.device.gl.createProgram(),this.device._setWebGLDebugMetadata(this.handle,this,{spector:{id:this.props.id}}),this.vs=t.vs,this.fs=t.fs;const{varyings:r,bufferMode:s=35981}=t;r&&r.length>0&&(this.varyings=r,this.device.gl.transformFeedbackVaryings(this.handle,r,s)),this._linkShaders(),Qe.time(3,`RenderPipeline ${this.id} - shaderLayout introspection`)(),this.introspectedLayout=S4(this.device.gl,this.handle),Qe.timeEnd(3,`RenderPipeline ${this.id} - shaderLayout introspection`)(),this.shaderLayout=t.shaderLayout?O4(this.introspectedLayout,t.shaderLayout):this.introspectedLayout}destroy(){this.handle&&(this.device.gl.useProgram(null),this.device.gl.deleteProgram(this.handle),this.destroyed=!0,this.handle.destroyed=!0,this.handle=null)}setBindings(e,t){for(const[r,s]of Object.entries(e)){const a=this.shaderLayout.bindings.find(u=>u.name===r)||this.shaderLayout.bindings.find(u=>u.name===`${r}Uniforms`);if(!a){const u=this.shaderLayout.bindings.map(l=>`"${l.name}"`).join(", ");t?.disableWarnings||Qe.warn(`No binding "${r}" in render pipeline "${this.id}", expected one of ${u}`,s)();continue}switch(s||Qe.warn(`Unsetting binding "${r}" in render pipeline "${this.id}"`)(),a.type){case"uniform":if(!(s instanceof Ah)&&!(s.buffer instanceof Ah))throw new Error("buffer value");break;case"texture":if(!(s instanceof hc||s instanceof Eh||s instanceof Sh))throw new Error(`${this} Bad texture binding for ${r}`);break;case"sampler":Qe.warn(`Ignoring sampler ${r}`)();break;default:throw new Error(a.type)}this.bindings[r]=s}}draw(e){const{renderPass:t,parameters:r=this.props.parameters,topology:s=this.props.topology,vertexArray:a,vertexCount:u,instanceCount:l,isInstanced:g=!1,firstVertex:v=0,transformFeedback:T}=e,S=R4(s),P=!!a.indexBuffer,O=a.indexBuffer?.glIndexType;if(this.linkStatus!=="success")return Qe.info(2,`RenderPipeline:${this.id}.draw() aborted - waiting for shader linking`)(),!1;if(!this._areTexturesRenderable())return Qe.info(2,`RenderPipeline:${this.id}.draw() aborted - textures not yet loaded`)(),!1;this.device.gl.useProgram(this.handle),a.bindBeforeRender(t),T&&T.begin(this.props.topology),this._applyBindings(),this._applyUniforms();const $=t;return u4(this.device,r,$.glParameters,()=>{P&&g?this.device.gl.drawElementsInstanced(S,u||0,O,v,l||0):P?this.device.gl.drawElements(S,u||0,O,v):g?this.device.gl.drawArraysInstanced(S,v,u||0,l||0):this.device.gl.drawArrays(S,v,u||0),T&&T.end()}),a.unbindAfterRender(t),!0}async _linkShaders(){const{gl:e}=this.device;if(e.attachShader(this.handle,this.vs.handle),e.attachShader(this.handle,this.fs.handle),Qe.time(I0,`linkProgram for ${this.id}`)(),e.linkProgram(this.handle),Qe.timeEnd(I0,`linkProgram for ${this.id}`)(),Qe.level,!this.device.features.has("compilation-status-async-webgl")){const r=this._getLinkStatus();this._reportLinkStatus(r);return}Qe.once(1,"RenderPipeline linking is asynchronous")(),await this._waitForLinkComplete(),Qe.info(2,`RenderPipeline ${this.id} - async linking complete: ${this.linkStatus}`)();const t=this._getLinkStatus();this._reportLinkStatus(t)}async _reportLinkStatus(e){switch(e){case"success":return;default:const t=e==="link-error"?"Link error":"Validation error";switch(this.vs.compilationStatus){case"error":throw this.vs.debugShader(),new Error(`${this} ${t} during compilation of ${this.vs}`);case"pending":await this.vs.asyncCompilationStatus,this.vs.debugShader();break}switch(this.fs?.compilationStatus){case"error":throw this.fs.debugShader(),new Error(`${this} ${t} during compilation of ${this.fs}`);case"pending":await this.fs.asyncCompilationStatus,this.fs.debugShader();break}const r=this.device.gl.getProgramInfoLog(this.handle);this.device.reportError(new Error(`${t} during ${e}: ${r}`),this)(),this.device.debug()}}_getLinkStatus(){const{gl:e}=this.device;return e.getProgramParameter(this.handle,35714)?(e.validateProgram(this.handle),e.getProgramParameter(this.handle,35715)?(this.linkStatus="success","success"):(this.linkStatus="error","validation-error")):(this.linkStatus="error","link-error")}async _waitForLinkComplete(){const e=async s=>await new Promise(a=>setTimeout(a,s));if(!this.device.features.has("compilation-status-async-webgl")){await e(10);return}const{gl:r}=this.device;for(;;){if(r.getProgramParameter(this.handle,37297))return;await e(10)}}_areTexturesRenderable(){let e=!0;for(const t of this.shaderLayout.bindings)!this.bindings[t.name]&&!this.bindings[t.name.replace(/Uniforms$/,"")]&&(Qe.warn(`Binding ${t.name} not found in ${this.id}`)(),e=!1);return e}_applyBindings(){if(this.linkStatus!=="success")return;const{gl:e}=this.device;e.useProgram(this.handle);let t=0,r=0;for(const s of this.shaderLayout.bindings){const a=this.bindings[s.name]||this.bindings[s.name.replace(/Uniforms$/,"")];if(!a)throw new Error(`No value for binding ${s.name} in ${this.id}`);switch(s.type){case"uniform":const{name:u}=s,l=e.getUniformBlockIndex(this.handle,u);if(l===4294967295)throw new Error(`Invalid uniform block name ${u}`);e.uniformBlockBinding(this.handle,r,l),a instanceof Ah?e.bindBufferBase(35345,r,a.handle):e.bindBufferRange(35345,r,a.buffer.handle,a.offset||0,a.size||a.buffer.byteLength-a.offset),r+=1;break;case"texture":if(!(a instanceof hc||a instanceof Eh||a instanceof Sh))throw new Error("texture");let g;if(a instanceof hc)g=a.texture;else if(a instanceof Eh)g=a;else if(a instanceof Sh&&a.colorAttachments[0]instanceof hc)Qe.warn("Passing framebuffer in texture binding may be deprecated. Use fbo.colorAttachments[0] instead")(),g=a.colorAttachments[0].texture;else throw new Error("No texture");e.activeTexture(33984+t),e.bindTexture(g.glTarget,g.handle),t+=1;break;case"sampler":break;case"storage":case"read-only-storage":throw new Error(`binding type '${s.type}' not supported in WebGL`)}}}_applyUniforms(){for(const e of this.shaderLayout.uniforms||[]){const{name:t,location:r,type:s,textureUnit:a}=e,u=this.uniforms[t]??a;u!==void 0&&M4(this.device.gl,r,s,u)}}}function O4(i,e){const t={...i,attributes:i.attributes.map(r=>({...r}))};for(const r of e?.attributes||[]){const s=t.attributes.find(a=>a.name===r.name);s?(s.type=r.type||s.type,s.stepMode=r.stepMode||s.stepMode):Qe.warn(`shader layout attribute ${r.name} not present in shader`)}return t}class L4 extends Y_{device;handle=null;commands=[];constructor(e){super(e,{}),this.device=e}_executeCommands(e=this.commands){for(const t of e)switch(t.name){case"copy-buffer-to-buffer":F4(this.device,t.options);break;case"copy-buffer-to-texture":B4(this.device,t.options);break;case"copy-texture-to-buffer":N4(this.device,t.options);break;case"copy-texture-to-texture":z4(this.device,t.options);break;default:throw new Error(t.name)}}}function F4(i,e){const t=e.sourceBuffer,r=e.destinationBuffer;i.gl.bindBuffer(36662,t.handle),i.gl.bindBuffer(36663,r.handle),i.gl.copyBufferSubData(36662,36663,e.sourceOffset??0,e.destinationOffset??0,e.size),i.gl.bindBuffer(36662,null),i.gl.bindBuffer(36663,null)}function B4(i,e){throw new Error("Not implemented")}function N4(i,e){const{sourceTexture:t,mipLevel:r=0,aspect:s="all",width:a=e.sourceTexture.width,height:u=e.sourceTexture.height,depthOrArrayLayers:l=0,origin:g=[0,0],destinationBuffer:v,byteOffset:T=0,bytesPerRow:S,rowsPerImage:P}=e;if(s!=="all")throw new Error("aspect not supported in WebGL");if(r!==0||l!==0||S||P)throw new Error("not implemented");const{framebuffer:O,destroyFramebuffer:$}=rT(t);let W;try{const G=v,Q=a||O.width,ae=u||O.height,te=eT(O.colorAttachments[0].texture.props.format),me=te.format,we=te.type;i.gl.bindBuffer(35051,G.handle),W=i.gl.bindFramebuffer(36160,O.handle),i.gl.readPixels(g[0],g[1],Q,ae,me,we,T)}finally{i.gl.bindBuffer(35051,null),W!==void 0&&i.gl.bindFramebuffer(36160,W),$&&O.destroy()}}function z4(i,e){const{sourceTexture:t,destinationMipLevel:r=0,origin:s=[0,0],destinationOrigin:a=[0,0],destinationTexture:u}=e;let{width:l=e.destinationTexture.width,height:g=e.destinationTexture.height}=e;const{framebuffer:v,destroyFramebuffer:T}=rT(t),[S,P]=s,[O,$,W]=a,G=i.gl.bindFramebuffer(36160,v.handle);let Q,ae;if(u instanceof Eh)Q=u,l=Number.isFinite(l)?l:Q.width,g=Number.isFinite(g)?g:Q.height,Q._bind(0),ae=Q.glTarget;else throw new Error("invalid destination");switch(ae){case 3553:case 34067:i.gl.copyTexSubImage2D(ae,r,O,$,S,P,l,g);break;case 35866:case 32879:i.gl.copyTexSubImage3D(ae,r,O,$,W,S,P,l,g);break}Q&&Q._unbind(),i.gl.bindFramebuffer(36160,G),T&&v.destroy()}function rT(i){if(i instanceof fr){const{width:e,height:t,id:r}=i;return{framebuffer:i.device.createFramebuffer({id:`framebuffer-for-${r}`,width:e,height:t,colorAttachments:[i]}),destroyFramebuffer:!0}}return{framebuffer:i,destroyFramebuffer:!1}}const U4=[1,2,4,8];class V4 extends La{device;handle=null;glParameters={};constructor(e,t){super(e,t),this.device=e;let r;if(!t?.parameters?.viewport)if(t?.framebuffer){const{width:a,height:u}=t.framebuffer;r=[0,0,a,u]}else{const[a,u]=e.getDefaultCanvasContext().getDrawingBufferSize();r=[0,0,a,u]}this.device.pushState(),this.setParameters({viewport:r,...this.props.parameters});const s=this.props.framebuffer;if(this.props.framebuffer&&s?.handle){const a=this.props.framebuffer.colorAttachments.map((u,l)=>36064+l);this.device.gl.drawBuffers(a)}else this.device.gl.drawBuffers([1029]);this.clear()}end(){this.device.popState()}pushDebugGroup(e){}popDebugGroup(){}insertDebugMarker(e){}setParameters(e={}){const t={...this.glParameters};t.framebuffer=this.props.framebuffer||null,this.props.depthReadOnly&&(t.depthMask=!this.props.depthReadOnly),t.stencilMask=this.props.stencilReadOnly?0:1,t[35977]=this.props.discard,e.viewport&&(e.viewport.length>=6?(t.viewport=e.viewport.slice(0,4),t.depthRange=[e.viewport[4],e.viewport[5]]):t.viewport=e.viewport),e.scissorRect&&(t.scissorTest=!0,t.scissor=e.scissorRect),e.blendConstant&&(t.blendColor=e.blendConstant),e.stencilReference&&(console.warn("RenderPassParameters.stencilReference not yet implemented in WebGL"),t[2967]=e.stencilReference),"colorMask"in e&&(t.colorMask=U4.map(r=>!!(r&e.colorMask))),this.glParameters=t,Dc(this.device.gl,t)}beginOcclusionQuery(e){this.props.occlusionQuerySet?.beginOcclusionQuery()}endOcclusionQuery(){this.props.occlusionQuerySet?.endOcclusionQuery()}clear(){const e={...this.glParameters};let t=0;this.props.clearColors&&this.props.clearColors.forEach((r,s)=>{r&&this.clearColorBuffer(s,r)}),this.props.clearColor!==!1&&this.props.clearColors===void 0&&(t|=16384,e.clearColor=this.props.clearColor),this.props.clearDepth!==!1&&(t|=256,e.clearDepth=this.props.clearDepth),this.props.clearStencil!==!1&&(t|=1024,e.clearStencil=this.props.clearStencil),t!==0&&Dh(this.device.gl,e,()=>{this.device.gl.clear(t)})}clearColorBuffer(e=0,t=[0,0,0,0]){Dh(this.device.gl,{framebuffer:this.props.framebuffer},()=>{switch(t.constructor){case Int8Array:case Int16Array:case Int32Array:this.device.gl.clearBufferiv(6144,e,t);break;case Uint8Array:case Uint8ClampedArray:case Uint16Array:case Uint32Array:this.device.gl.clearBufferuiv(6144,e,t);break;case Float32Array:this.device.gl.clearBufferfv(6144,e,t);break;default:throw new Error("clearColorBuffer: color must be typed array")}})}}class C0 extends Z_{device;handle=null;commandBuffer;constructor(e,t){super(e,t),this.device=e,this.commandBuffer=new L4(e)}destroy(){}finish(){return this.commandBuffer}beginRenderPass(e){return new V4(this.device,e)}beginComputePass(e){throw new Error("ComputePass not supported in WebGL")}copyBufferToBuffer(e){this.commandBuffer.commands.push({name:"copy-buffer-to-buffer",options:e})}copyBufferToTexture(e){this.commandBuffer.commands.push({name:"copy-buffer-to-texture",options:e})}copyTextureToBuffer(e){this.commandBuffer.commands.push({name:"copy-texture-to-buffer",options:e})}copyTextureToTexture(e){this.commandBuffer.commands.push({name:"copy-texture-to-texture",options:e})}pushDebugGroup(e){}popDebugGroup(){}insertDebugMarker(e){}resolveQuerySet(e,t,r){}}function j4(i){const{target:e,source:t,start:r=0,count:s=1}=i,a=t.length,u=s*a;let l=0;for(let g=r;l<a;l++)e[g++]=t[l];for(;l<u;)l<u-l?(e.copyWithin(r+l,r,r+l),l*=2):(e.copyWithin(r+l,r,r+u-l),l=u);return i.target}class Iy extends G_{get[Symbol.toStringTag](){return"VertexArray"}device;handle;buffer=null;bufferValue=null;static isConstantAttributeZeroSupported(e){return pE()==="Chrome"}constructor(e,t){super(e,t),this.device=e,this.handle=this.device.gl.createVertexArray()}destroy(){super.destroy(),this.buffer&&this.buffer?.destroy(),this.handle&&(this.device.gl.deleteVertexArray(this.handle),this.handle=void 0)}setIndexBuffer(e){const t=e;if(t&&t.glTarget!==34963)throw new Error("Use .setBuffer()");this.device.gl.bindVertexArray(this.handle),this.device.gl.bindBuffer(34963,t?t.handle:null),this.indexBuffer=t,this.device.gl.bindVertexArray(null)}setBuffer(e,t){const r=t;if(r.glTarget===34963)throw new Error("Use .setIndexBuffer()");const{size:s,type:a,stride:u,offset:l,normalized:g,integer:v,divisor:T}=this._getAccessor(e);this.device.gl.bindVertexArray(this.handle),this.device.gl.bindBuffer(34962,r.handle),v?this.device.gl.vertexAttribIPointer(e,s,a,u,l):this.device.gl.vertexAttribPointer(e,s,a,g,u,l),this.device.gl.bindBuffer(34962,null),this.device.gl.enableVertexAttribArray(e),this.device.gl.vertexAttribDivisor(e,T||0),this.attributes[e]=r,this.device.gl.bindVertexArray(null)}setConstantWebGL(e,t){this._enable(e,!1),this.attributes[e]=t}bindBeforeRender(){this.device.gl.bindVertexArray(this.handle),this._applyConstantAttributes()}unbindAfterRender(){this.device.gl.bindVertexArray(null)}_applyConstantAttributes(){for(let e=0;e<this.maxVertexAttributes;++e){const t=this.attributes[e];ArrayBuffer.isView(t)&&this.device.setConstantAttributeWebGL(e,t)}}_getAccessor(e){const t=this.attributeInfos[e];if(!t)throw new Error(`Unknown attribute location ${e}`);const r=Q2(t.bufferDataType);return{size:t.bufferComponents,type:r,stride:t.byteStride,offset:t.byteOffset,normalized:t.normalized,integer:t.integer,divisor:t.stepMode==="instance"?1:0}}_enable(e,t=!0){const s=Iy.isConstantAttributeZeroSupported(this.device)||e!==0;(t||s)&&(e=Number(e),this.device.gl.bindVertexArray(this.handle),t?this.device.gl.enableVertexAttribArray(e):this.device.gl.disableVertexAttribArray(e),this.device.gl.bindVertexArray(null))}getConstantBuffer(e,t){const r=$4(t),s=r.byteLength*e,a=r.length*e;if(this.buffer&&s!==this.buffer.byteLength)throw new Error(`Buffer size is immutable, byte length ${s} !== ${this.buffer.byteLength}.`);let u=!this.buffer;if(this.buffer=this.buffer||this.device.createBuffer({byteLength:s}),u||=!W4(r,this.bufferValue),u){const l=fP(t.constructor,a);j4({target:l,source:r,start:0,count:a}),this.buffer.write(l),this.bufferValue=t}return this.buffer}}function $4(i){return Array.isArray(i)?new Float32Array(i):i}function W4(i,e){if(!i||!e||i.length!==e.length||i.constructor!==e.constructor)return!1;for(let t=0;t<i.length;++t)if(i[t]!==e[t])return!1;return!0}class H4 extends K_{device;gl;handle;layout;buffers={};unusedBuffers={};bindOnUse=!0;_bound=!1;constructor(e,t){super(e,t),this.device=e,this.gl=e.gl,this.handle=this.props.handle||this.gl.createTransformFeedback(),this.layout=this.props.layout,t.buffers&&this.setBuffers(t.buffers),Object.seal(this)}destroy(){this.gl.deleteTransformFeedback(this.handle),super.destroy()}begin(e="point-list"){this.gl.bindTransformFeedback(36386,this.handle),this.bindOnUse&&this._bindBuffers(),this.gl.beginTransformFeedback(k4(e))}end(){this.gl.endTransformFeedback(),this.bindOnUse&&this._unbindBuffers(),this.gl.bindTransformFeedback(36386,null)}setBuffers(e){this.buffers={},this.unusedBuffers={},this.bind(()=>{for(const t in e)this.setBuffer(t,e[t])})}setBuffer(e,t){const r=this._getVaryingIndex(e),{buffer:s,byteLength:a,byteOffset:u}=this._getBufferRange(t);if(r<0){this.unusedBuffers[e]=s,Qe.warn(`${this.id} unusedBuffers varying buffer ${e}`)();return}this.buffers[r]={buffer:s,byteLength:a,byteOffset:u},this.bindOnUse||this._bindBuffer(r,s,u,a)}getBuffer(e){if(P0(e))return this.buffers[e]||null;const t=this._getVaryingIndex(e);return t>=0?this.buffers[t]:null}bind(e=this.handle){if(typeof e!="function")return this.gl.bindTransformFeedback(36386,e),this;let t;return this._bound?t=e():(this.gl.bindTransformFeedback(36386,this.handle),this._bound=!0,t=e(),this._bound=!1,this.gl.bindTransformFeedback(36386,null)),t}unbind(){this.bind(null)}_getBufferRange(e){if(e instanceof Ah)return{buffer:e,byteOffset:0,byteLength:e.byteLength};const{buffer:t,byteOffset:r=0,byteLength:s=e.buffer.byteLength}=e;return{buffer:t,byteOffset:r,byteLength:s}}_getVaryingIndex(e){if(P0(e))return Number(e);for(const t of this.layout.varyings||[])if(e===t.name)return t.location;return-1}_bindBuffers(){for(const e in this.buffers){const{buffer:t,byteLength:r,byteOffset:s}=this._getBufferRange(this.buffers[e]);this._bindBuffer(Number(e),t,s,r)}}_unbindBuffers(){for(const e in this.buffers)this.gl.bindBufferBase(35982,Number(e),null)}_bindBuffer(e,t,r=0,s){const a=t&&t.handle;!a||s===void 0?this.gl.bindBufferBase(35982,e,a):this.gl.bindBufferRange(35982,e,a,r,s)}}function P0(i){return typeof i=="number"?Number.isInteger(i):/^\d+$/.test(i)}class q4 extends J_{device;handle;target=null;_queryPending=!1;_pollingPromise=null;get[Symbol.toStringTag](){return"Query"}constructor(e,t){if(super(e,t),this.device=e,t.count>1)throw new Error("WebGL QuerySet can only have one value");const r=this.device.gl.createQuery();if(!r)throw new Error("WebGL query not supported");this.handle=r,Object.seal(this)}destroy(){this.device.gl.deleteQuery(this.handle)}beginTimestampQuery(){return this._begin(35007)}endTimestampQuery(){this._end()}beginOcclusionQuery(e){return this._begin(e?.conservative?36202:35887)}endOcclusionQuery(){this._end()}beginTransformFeedbackQuery(){return this._begin(35976)}endTransformFeedbackQuery(){this._end()}async resolveQuery(){return[await this.pollQuery()]}_begin(e){this._queryPending||(this.target=e,this.device.gl.beginQuery(this.target,this.handle))}_end(){this._queryPending||this.target&&(this.device.gl.endQuery(this.target),this.target=null,this._queryPending=!0)}isResultAvailable(){if(!this._queryPending)return!1;const e=this.device.gl.getQueryParameter(this.handle,34919);return e&&(this._queryPending=!1),e}isTimerDisjoint(){return this.device.gl.getParameter(36795)}getResult(){return this.device.gl.getQueryParameter(this.handle,34918)}getTimerMilliseconds(){return this.getResult()/1e6}pollQuery(e=Number.POSITIVE_INFINITY){if(this._pollingPromise)return this._pollingPromise;let t=0;return this._pollingPromise=new Promise((r,s)=>{const a=()=>{this.isResultAvailable()?(r(this.getResult()),this._pollingPromise=null):t++>e?(s("Timed out"),this._pollingPromise=null):requestAnimationFrame(a)};requestAnimationFrame(a)}),this._pollingPromise}}function sT(i){switch(i){case 6406:case 33326:case 6403:case 36244:return 1;case 33339:case 33340:case 33328:case 33320:case 33319:return 2;case 6407:case 36248:case 34837:return 3;case 6408:case 36249:case 34836:return 4;default:return 0}}function X4(i){switch(i){case 5121:return 1;case 33635:case 32819:case 32820:return 2;case 5126:return 4;default:return 0}}function Z4(i){return Y4[i]}const Y4={5124:"sint32",5125:"uint32",5122:"sint16",5123:"uint16",5120:"sint8",5121:"uint8",5126:"float32",5131:"float16",33635:"uint16",32819:"uint16",32820:"uint16",33640:"uint32",35899:"uint32",35902:"uint32",34042:"uint32",36269:"uint32"};function G4(i,e){const{sourceX:t=0,sourceY:r=0,sourceAttachment:s=0}=e||{};let{target:a=null,sourceWidth:u,sourceHeight:l,sourceDepth:g,sourceFormat:v,sourceType:T}=e||{};const{framebuffer:S,deleteFramebuffer:P}=nT(i),{gl:O,handle:$}=S;u||=S.width,l||=S.height;const W=S.colorAttachments[s]?.texture;if(!W)throw new Error(`Invalid framebuffer attachment ${s}`);g=W?.depth||1,v||=W?.glFormat||6408,T||=W?.glType||5121,a=Q4(a,T,v,u,l);const G=W_(a);T=T||x4(G);const Q=O.bindFramebuffer(36160,$);return O.readBuffer(36064+s),O.readPixels(t,r,u,l,v,T,a),O.readBuffer(36064),O.bindFramebuffer(36160,Q||null),P&&S.destroy(),a}function K4(i,e){const{target:t,sourceX:r=0,sourceY:s=0,sourceFormat:a=6408,targetByteOffset:u=0}=e||{};let{sourceWidth:l,sourceHeight:g,sourceType:v}=e||{};const{framebuffer:T,deleteFramebuffer:S}=nT(i);l=l||T.width,g=g||T.height;const P=T;v=v||5121;let O=t;if(!O){const W=sT(a),G=X4(v),Q=u+l*g*W*G;O=P.device.createBuffer({byteLength:Q})}const $=i.device.createCommandEncoder();return $.copyTextureToBuffer({sourceTexture:i,width:l,height:g,origin:[r,s],destinationBuffer:O,byteOffset:u}),$.destroy(),S&&T.destroy(),O}function nT(i){return i instanceof _p?{framebuffer:i,deleteFramebuffer:!1}:{framebuffer:J4(i),deleteFramebuffer:!0}}function J4(i,e){const{device:t,width:r,height:s,id:a}=i;return t.createFramebuffer({...e,id:`framebuffer-for-${a}`,width:r,height:s,colorAttachments:[i]})}function Q4(i,e,t,r,s,a){if(i)return i;e||=5121;const u=Z4(e),l=H_(u),g=sT(t);return new l(r*s*g)}class g_ extends qa{type="webgl";handle;features;limits;info;canvasContext;preferredColorFormat="rgba8unorm";preferredDepthFormat="depth24plus";commandEncoder;lost;_resolveContextLost;gl;_constants;_extensions={};_polyfilled=!1;spectorJS;get[Symbol.toStringTag](){return"WebGLDevice"}toString(){return`${this[Symbol.toStringTag]}(${this.id})`}isVertexFormatSupported(e){switch(e){case"unorm8x4-bgra":return!1;default:return!0}}constructor(e){super({...e,id:e.id||n4("webgl-device")});const t=qa._getCanvasContextProps(e);if(!t)throw new Error("WebGLDevice requires props.createCanvasContext to be set");let r=t.canvas?.gl?.device;if(r)throw new Error(`WebGL context already attached to device ${r.id}`);this.canvasContext=new s4(this,t),this.lost=new Promise(T=>{this._resolveContextLost=T});const s={...e.webgl};t.alphaMode==="premultiplied"&&(s.premultipliedAlpha=!0),e.powerPreference!==void 0&&(s.powerPreference=e.powerPreference);const u=this.props._handle||NL(this.canvasContext.canvas,{onContextLost:T=>this._resolveContextLost?.({reason:"destroyed",message:"Entered sleep mode, or too many apps or browser tabs are using the GPU."}),onContextRestored:T=>console.log("WebGL context restored")},s);if(!u)throw new Error("WebGL context creation failed");if(r=u.device,r){if(e._reuseDevices)return Qe.log(1,`Not creating a new Device, instead returning a reference to Device ${r.id} already attached to WebGL context`,r)(),r._reused=!0,r;throw new Error(`WebGL context already attached to device ${r.id}`)}this.handle=u,this.gl=u,this.spectorJS=vL({...this.props,gl:this.handle}),this.gl.device=this,this.gl._version=2,this.info=zL(this.gl,this._extensions),this.limits=new t4(this.gl),this.features=new e4(this.gl,this._extensions,this.props._disabledFeatures),this.props._initializeFeatures&&this.features.initializeFeatures(),new Wa(this.gl,{log:(...T)=>Qe.log(1,...T)()}).trackState(this.gl,{copyState:!1});const g=e.debugWebGL||e.debug,v=e.debugWebGL;g&&(this.gl=TL(this.gl,{debugWebGL:g,traceWebGL:v}),Qe.warn("WebGL debug mode activated. Performance reduced.")(),e.debugWebGL&&(Qe.level=Math.max(Qe.level,1))),this.commandEncoder=new C0(this,{id:`${this}-command-encoder`})}destroy(){!this.props._reuseDevices&&!this._reused&&delete this.gl.device}get isLost(){return this.gl.isContextLost()}getTextureByteAlignment(){return 4}createCanvasContext(e){throw new Error("WebGL only supports a single canvas")}createBuffer(e){const t=this._normalizeBufferProps(e);return new Ah(this,t)}createTexture(e){return new Eh(this,e)}createExternalTexture(e){throw new Error("createExternalTexture() not implemented")}createSampler(e){return new m4(this,e)}createShader(e){return new c4(this,e)}createFramebuffer(e){return new Sh(this,e)}createVertexArray(e){return new Iy(this,e)}createTransformFeedback(e){return new H4(this,e)}createQuerySet(e){return new q4(this,e)}createRenderPipeline(e){return new D4(this,e)}createComputePipeline(e){throw new Error("ComputePipeline not supported in WebGL")}createCommandEncoder(e={}){return new C0(this,e)}submit(e){e||(e=this.commandEncoder.finish(),this.commandEncoder.destroy(),this.commandEncoder=this.createCommandEncoder({id:`${this.id}-default-encoder`})),e._executeCommands()}readPixelsToArrayWebGL(e,t){return G4(e,t)}readPixelsToBufferWebGL(e,t){return K4(e,t)}setParametersWebGL(e){Dc(this.gl,e)}getParametersWebGL(e){return K2(this.gl,e)}withParametersWebGL(e,t){return Dh(this.gl,e,t)}resetWebGL(){Qe.warn("WebGLDevice.resetWebGL is deprecated, use only for debugging")(),DL(this.gl)}_getDeviceSpecificTextureFormatCapabilities(e){return GL(this.gl,e,this._extensions)}loseDevice(){let e=!1;const r=this.getExtension("WEBGL_lose_context").WEBGL_lose_context;return r&&(e=!0,r.loseContext()),this._resolveContextLost?.({reason:"destroyed",message:"Application triggered context loss"}),e}pushState(){Wa.get(this.gl).push()}popState(){Wa.get(this.gl).pop()}getGLKey(e,t){const r=Number(e);for(const s in this.gl)if(this.gl[s]===r)return`GL.${s}`;return t?.emptyIfUnknown?"":String(e)}getGLKeys(e){const t={emptyIfUnknown:!0};return Object.entries(e).reduce((r,[s,a])=>(r[`${s}:${this.getGLKey(s,t)}`]=`${a}:${this.getGLKey(a,t)}`,r),{})}setConstantAttributeWebGL(e,t){const r=this.limits.maxVertexAttributes;this._constants=this._constants||new Array(r).fill(null);const s=this._constants[e];switch(s&&rF(s,t)&&Qe.info(1,`setConstantAttributeWebGL(${e}) could have been skipped, value unchanged`)(),this._constants[e]=t,t.constructor){case Float32Array:eF(this,e,t);break;case Int32Array:tF(this,e,t);break;case Uint32Array:iF(this,e,t);break;default:throw new Error("constant")}}getExtension(e){return Ic(this.gl,e,this._extensions),this._extensions}_setWebGLDebugMetadata(e,t,r){e.luma=t;const s={props:r.spector,id:r.spector.id};e.__SPECTOR_Metadata=s}}function eF(i,e,t){switch(t.length){case 1:i.gl.vertexAttrib1fv(e,t);break;case 2:i.gl.vertexAttrib2fv(e,t);break;case 3:i.gl.vertexAttrib3fv(e,t);break;case 4:i.gl.vertexAttrib4fv(e,t);break}}function tF(i,e,t){i.gl.vertexAttribI4iv(e,t)}function iF(i,e,t){i.gl.vertexAttribI4uiv(e,t)}function rF(i,e){if(!i||!e||i.length!==e.length||i.constructor!==e.constructor)return!1;for(let t=0;t<i.length;++t)if(i[t]!==e[t])return!1;return!0}const M0=Object.freeze(Object.defineProperty({__proto__:null,WebGLDevice:g_},Symbol.toStringTag,{value:"Module"}));function Vo(){}const sF=({isDragging:i})=>i?"grabbing":"grab",oT={id:"",width:"100%",height:"100%",style:null,viewState:null,initialViewState:null,pickingRadius:0,layerFilter:null,parameters:{},parent:null,device:null,deviceProps:{},gl:null,canvas:null,layers:[],effects:[],views:null,controller:null,useDevicePixels:!0,touchAction:"none",eventRecognizerOptions:{},_framebuffer:null,_animate:!1,_pickable:!0,_typedArrayManagerProps:{},_customRender:null,widgets:[],onDeviceInitialized:Vo,onWebGLInitialized:Vo,onResize:Vo,onViewStateChange:Vo,onInteractionStateChange:Vo,onBeforeRender:Vo,onAfterRender:Vo,onLoad:Vo,onError:i=>ni.error(i.message,i.cause)(),onHover:null,onClick:null,onDragStart:null,onDrag:null,onDragEnd:null,_onMetrics:null,getCursor:sF,getTooltip:null,debug:!1,drawPickingColors:!1};class Cy{constructor(e){this.width=0,this.height=0,this.userData={},this.device=null,this.canvas=null,this.viewManager=null,this.layerManager=null,this.effectManager=null,this.deckRenderer=null,this.deckPicker=null,this.eventManager=null,this.widgetManager=null,this.tooltip=null,this.animationLoop=null,this.cursorState={isHovering:!1,isDragging:!1},this.stats=new zh({id:"deck.gl"}),this.metrics={fps:0,setPropsTime:0,updateAttributesTime:0,framesRedrawn:0,pickTime:0,pickCount:0,gpuTime:0,gpuTimePerFrame:0,cpuTime:0,cpuTimePerFrame:0,bufferMemory:0,textureMemory:0,renderbufferMemory:0,gpuMemory:0},this._metricsCounter=0,this._needsRedraw="Initial render",this._pickRequest={mode:"hover",x:-1,y:-1,radius:0,event:null},this._lastPointerDownInfo=null,this._onPointerMove=r=>{const{_pickRequest:s}=this;if(r.type==="pointerleave")s.x=-1,s.y=-1,s.radius=0;else{if(r.leftButton||r.rightButton)return;{const a=r.offsetCenter;if(!a)return;s.x=a.x,s.y=a.y,s.radius=this.props.pickingRadius}}this.layerManager&&(this.layerManager.context.mousePosition={x:s.x,y:s.y}),s.event=r},this._onEvent=r=>{const s=n_[r.type],a=r.offsetCenter;if(!s||!a||!this.layerManager)return;const u=this.layerManager.getLayers(),l=this.deckPicker.getLastPickedObject({x:a.x,y:a.y,layers:u,viewports:this.getViewports(a)},this._lastPointerDownInfo),{layer:g}=l,v=g&&(g[s]||g.props[s]),T=this.props[s];let S=!1;v&&(S=v.call(g,l,r)),S||(T?.(l,r),this.widgetManager.onEvent(l,r))},this._onPointerDown=r=>{if(this.device?.type==="webgpu")return;const s=r.offsetCenter,a=this._pick("pickObject","pickObject Time",{x:s.x,y:s.y,radius:this.props.pickingRadius});this._lastPointerDownInfo=a.result[0]||a.emptyInfo},this.props={...oT,...e},e=this.props,e.viewState&&e.initialViewState&&ni.warn("View state tracking is disabled. Use either `initialViewState` for auto update or `viewState` for manual update.")(),this.viewState=this.props.initialViewState,e.device&&(this.device=e.device);let t=this.device;if(!t&&e.gl){e.gl instanceof WebGLRenderingContext&&ni.error("WebGL1 context not supported.")();const r=this.props.deviceProps?.onResize;t=vm.attach(e.gl,{...this.props.deviceProps,onResize:(s,a)=>{const{width:u,height:l}=s.canvas;s.drawingBufferWidth=u,s.drawingBufferHeight=l,this._needsRedraw="Canvas resized",r?.(s,a)}})}t||(t=this._createDevice(e)),this.animationLoop=this._createAnimationLoop(t,e),this.setProps(e),e._typedArrayManagerProps&&Tc.setOptions(e._typedArrayManagerProps),this.animationLoop.start()}finalize(){this.animationLoop?.stop(),this.animationLoop?.destroy(),this.animationLoop=null,this._lastPointerDownInfo=null,this.layerManager?.finalize(),this.layerManager=null,this.viewManager?.finalize(),this.viewManager=null,this.effectManager?.finalize(),this.effectManager=null,this.deckRenderer?.finalize(),this.deckRenderer=null,this.deckPicker?.finalize(),this.deckPicker=null,this.eventManager?.destroy(),this.eventManager=null,this.widgetManager?.finalize(),this.widgetManager=null,!this.props.canvas&&!this.props.device&&!this.props.gl&&this.canvas&&(this.canvas.parentElement?.removeChild(this.canvas),this.canvas=null)}setProps(e){this.stats.get("setProps Time").timeStart(),"onLayerHover"in e&&ni.removed("onLayerHover","onHover")(),"onLayerClick"in e&&ni.removed("onLayerClick","onClick")(),e.initialViewState&&!Zs(this.props.initialViewState,e.initialViewState,3)&&(this.viewState=e.initialViewState),Object.assign(this.props,e),this._setCanvasSize(this.props);const t=Object.create(this.props);Object.assign(t,{views:this._getViews(),width:this.width,height:this.height,viewState:this._getViewState()}),e.device&&e.device.id!==this.device?.id&&(this.animationLoop?.stop(),this.canvas!==e.device.canvasContext?.canvas&&(this.canvas?.remove(),this.eventManager?.destroy(),this.canvas=null),ni.log(`recreating animation loop for new device! id=${e.device.id}`)(),this.animationLoop=this._createAnimationLoop(e.device,e),this.animationLoop.start()),this.animationLoop?.setProps(t),e.useDevicePixels!==void 0&&this.device?.canvasContext&&this.device.canvasContext.setProps({useDevicePixels:e.useDevicePixels}),this.layerManager&&(this.viewManager.setProps(t),this.layerManager.activateViewport(this.getViewports()[0]),this.layerManager.setProps(t),this.effectManager.setProps(t),this.deckRenderer.setProps(t),this.deckPicker.setProps(t),this.widgetManager.setProps(t)),this.stats.get("setProps Time").timeEnd()}needsRedraw(e={clearRedrawFlags:!1}){if(!this.layerManager)return!1;if(this.props._animate)return"Deck._animate";let t=this._needsRedraw;e.clearRedrawFlags&&(this._needsRedraw=!1);const r=this.viewManager.needsRedraw(e),s=this.layerManager.needsRedraw(e),a=this.effectManager.needsRedraw(e),u=this.deckRenderer.needsRedraw(e);return t=t||r||s||a||u,t}redraw(e){if(!this.layerManager)return;let t=this.needsRedraw({clearRedrawFlags:!0});t=e||t,t&&(this.stats.get("Redraw Count").incrementCount(),this.props._customRender?this.props._customRender(t):this._drawLayers(t))}get isInitialized(){return this.viewManager!==null}getViews(){return Pr(this.viewManager),this.viewManager.views}getViewports(e){return Pr(this.viewManager),this.viewManager.getViewports(e)}getCanvas(){return this.canvas}pickObject(e){const t=this._pick("pickObject","pickObject Time",e).result;return t.length?t[0]:null}pickMultipleObjects(e){return e.depth=e.depth||10,this._pick("pickObject","pickMultipleObjects Time",e).result}pickObjects(e){return this._pick("pickObjects","pickObjects Time",e)}_addResources(e,t=!1){for(const r in e)this.layerManager.resourceManager.add({resourceId:r,data:e[r],forceUpdate:t})}_removeResources(e){for(const t of e)this.layerManager.resourceManager.remove(t)}_addDefaultEffect(e){this.effectManager.addDefaultEffect(e)}_addDefaultShaderModule(e){this.layerManager.addDefaultShaderModule(e)}_removeDefaultShaderModule(e){this.layerManager?.removeDefaultShaderModule(e)}_pick(e,t,r){Pr(this.deckPicker);const{stats:s}=this;s.get("Pick Count").incrementCount(),s.get(t).timeStart();const a=this.deckPicker[e]({layers:this.layerManager.getLayers(r),views:this.viewManager.getViews(),viewports:this.getViewports(r),onViewportActive:this.layerManager.activateViewport,effects:this.effectManager.getEffects(),...r});return s.get(t).timeEnd(),a}_createCanvas(e){let t=e.canvas;return typeof t=="string"&&(t=document.getElementById(t),Pr(t)),t||(t=document.createElement("canvas"),t.id=e.id||"deckgl-overlay",e.width&&typeof e.width=="number"&&(t.width=e.width),e.height&&typeof e.height=="number"&&(t.height=e.height),(e.parent||document.body).appendChild(t)),Object.assign(t.style,e.style),t}_setCanvasSize(e){if(!this.canvas)return;const{width:t,height:r}=e;if(t||t===0){const s=Number.isFinite(t)?`${t}px`:t;this.canvas.style.width=s}if(r||r===0){const s=Number.isFinite(r)?`${r}px`:r;this.canvas.style.position=e.style?.position||"absolute",this.canvas.style.height=s}}_updateCanvasSize(){const{canvas:e}=this;if(!e)return;const t=e.clientWidth??e.width,r=e.clientHeight??e.height;(t!==this.width||r!==this.height)&&(this.width=t,this.height=r,this.viewManager?.setProps({width:t,height:r}),this.layerManager?.activateViewport(this.getViewports()[0]),this.props.onResize({width:t,height:r}))}_createAnimationLoop(e,t){const{gl:r,onError:s}=t;return new yy({device:e,autoResizeDrawingBuffer:!r,autoResizeViewport:!1,onInitialize:a=>this._setDevice(a.device),onRender:this._onRenderFrame.bind(this),onError:s})}_createDevice(e){const t=this.props.deviceProps?.createCanvasContext,r=typeof t=="object"?t:void 0,s={adapters:[],_cacheShaders:!0,_cachePipelines:!0,...e.deviceProps};s.adapters.includes(vm)||s.adapters.push(vm);const a={alphaMode:this.props.deviceProps?.type==="webgpu"?"premultiplied":void 0},u=this.props.deviceProps?.onResize;return Zm.createDevice({_reuseDevices:!0,type:"webgl",...s,createCanvasContext:{...a,...r,canvas:this._createCanvas(e),useDevicePixels:this.props.useDevicePixels,autoResize:!0},onResize:(l,g)=>{this._needsRedraw="Canvas resized",u?.(l,g)}})}_getViewState(){return this.props.viewState||this.viewState}_getViews(){const{views:e}=this.props,t=Array.isArray(e)?e:e?[e]:[new X2({id:"default-view"})];return t.length&&this.props.controller&&(t[0].props.controller=this.props.controller),t}_onContextLost(){const{onError:e}=this.props;this.animationLoop&&e&&e(new Error("WebGL context is lost"))}_pickAndCallback(){if(this.device?.type==="webgpu")return;const{_pickRequest:e}=this;if(e.event){const{result:t,emptyInfo:r}=this._pick("pickObject","pickObject Time",e);this.cursorState.isHovering=t.length>0;let s=r,a=!1;for(const u of t)s=u,a=u.layer?.onHover(u,e.event)||a;a||(this.props.onHover?.(s,e.event),this.widgetManager.onHover(s,e.event)),e.event=null}}_updateCursor(){const e=this.props.parent||this.canvas;e&&(e.style.cursor=this.props.getCursor(this.cursorState))}_setDevice(e){if(this.device=e,!this.animationLoop)return;this.canvas||(this.canvas=this.device.canvasContext?.canvas,!this.canvas.isConnected&&this.props.parent&&this.props.parent.insertBefore(this.canvas,this.props.parent.firstChild)),this.device.type==="webgl"&&this.device.setParametersWebGL({blend:!0,blendFunc:[770,771,1,771],polygonOffsetFill:!0,depthTest:!0,depthFunc:515}),this.props.onDeviceInitialized(this.device),this.device.type==="webgl"&&this.props.onWebGLInitialized(this.device.gl);const t=new j2;t.play(),this.animationLoop.attachTimeline(t),this.eventManager=new Uk(this.props.parent||this.canvas,{touchAction:this.props.touchAction,recognizers:Object.keys(qb).map(s=>{const[a,u,l,g]=qb[s],v=this.props.eventRecognizerOptions?.[s],T={...u,...v,event:s};return{recognizer:new a(T),recognizeWith:l,requestFailure:g}}),events:{pointerdown:this._onPointerDown,pointermove:this._onPointerMove,pointerleave:this._onPointerMove}});for(const s in n_)this.eventManager.on(s,this._onEvent);this.viewManager=new NO({timeline:t,eventManager:this.eventManager,onViewStateChange:this._onViewStateChange.bind(this),onInteractionStateChange:this._onInteractionStateChange.bind(this),views:this._getViews(),viewState:this._getViewState(),width:this.width,height:this.height});const r=this.viewManager.getViewports()[0];this.layerManager=new BO(this.device,{deck:this,stats:this.stats,viewport:r,timeline:t}),this.effectManager=new eL({deck:this,device:this.device}),this.deckRenderer=new rL(this.device),this.deckPicker=new oL(this.device),this.widgetManager=new cL({deck:this,parentElement:this.canvas?.parentElement}),this.widgetManager.addDefault(new Z2),this.setProps(this.props),this._updateCanvasSize(),this.props.onLoad()}_drawLayers(e,t){const{device:r,gl:s}=this.layerManager.context;this.props.onBeforeRender({device:r,gl:s});const a={target:this.props._framebuffer,layers:this.layerManager.getLayers(),viewports:this.viewManager.getViewports(),onViewportActive:this.layerManager.activateViewport,views:this.viewManager.getViews(),pass:"screen",effects:this.effectManager.getEffects(),...t};this.deckRenderer?.renderLayers(a),a.pass==="screen"&&this.widgetManager.onRedraw({viewports:a.viewports,layers:a.layers}),this.props.onAfterRender({device:r,gl:s})}_onRenderFrame(){this._getFrameStats(),this._metricsCounter++%60===0&&(this._getMetrics(),this.stats.reset(),ni.table(4,this.metrics)(),this.props._onMetrics&&this.props._onMetrics(this.metrics)),this._updateCanvasSize(),this._updateCursor(),this.layerManager.updateLayers(),this.device?.type!=="webgpu"&&this._pickAndCallback(),this.redraw(),this.viewManager&&this.viewManager.updateViewStates()}_onViewStateChange(e){const t=this.props.onViewStateChange(e)||e.viewState;this.viewState&&(this.viewState={...this.viewState,[e.viewId]:t},this.props.viewState||this.viewManager&&this.viewManager.setProps({viewState:this.viewState}))}_onInteractionStateChange(e){this.cursorState.isDragging=e.isDragging||!1,this.props.onInteractionStateChange(e)}_getFrameStats(){const{stats:e}=this;e.get("frameRate").timeEnd(),e.get("frameRate").timeStart();const t=this.animationLoop.stats;e.get("GPU Time").addTime(t.get("GPU Time").lastTiming),e.get("CPU Time").addTime(t.get("CPU Time").lastTiming)}_getMetrics(){const{metrics:e,stats:t}=this;e.fps=t.get("frameRate").getHz(),e.setPropsTime=t.get("setProps Time").time,e.updateAttributesTime=t.get("Update Attributes").time,e.framesRedrawn=t.get("Redraw Count").count,e.pickTime=t.get("pickObject Time").time+t.get("pickMultipleObjects Time").time+t.get("pickObjects Time").time,e.pickCount=t.get("Pick Count").count,e.gpuTime=t.get("GPU Time").time,e.cpuTime=t.get("CPU Time").time,e.gpuTimePerFrame=t.get("GPU Time").getAverageTime(),e.cpuTimePerFrame=t.get("CPU Time").getAverageTime();const r=Zm.stats.get("Memory Usage");e.bufferMemory=r.get("Buffer Memory").count,e.textureMemory=r.get("Texture Memory").count,e.renderbufferMemory=r.get("Renderbuffer Memory").count,e.gpuMemory=r.get("GPU Memory").count}}Cy.defaultProps=oT;Cy.VERSION=jI;function nF(i){switch(i){case"float64":return Float64Array;case"uint8":case"unorm8":return Uint8ClampedArray;default:return H_(i)}}const oF=W_;function hf(i,e,t){const r=t==="webgpu"&&e.type==="uint8"?"unorm8":e.type;return{attribute:i,format:e.size>1?`${r}x${e.size}`:e.type,byteOffset:e.offset||0}}function Na(i){return i.stride||i.size*i.bytesPerElement}function aF(i,e){return i.type===e.type&&i.size===e.size&&Na(i)===Na(e)&&(i.offset||0)===(e.offset||0)}function m_(i,e){e.offset&&ni.removed("shaderAttribute.offset","vertexOffset, elementOffset")();const t=Na(i),r=e.vertexOffset!==void 0?e.vertexOffset:i.vertexOffset||0,s=e.elementOffset||0,a=r*t+s*i.bytesPerElement+(i.offset||0);return{...e,offset:a,stride:t}}function lF(i,e){const t=m_(i,e);return{high:t,low:{...t,offset:t.offset+i.size*4}}}class cF{constructor(e,t,r){this._buffer=null,this.device=e,this.id=t.id||"",this.size=t.size||1;const s=t.logicalType||t.type,a=s==="float64";let{defaultValue:u}=t;u=Number.isFinite(u)?[u]:u||new Array(this.size).fill(0);let l;a?l="float32":!s&&t.isIndexed?l="uint32":l=s||"float32";let g=nF(s||l);this.doublePrecision=a,a&&t.fp64===!1&&(g=Float32Array),this.value=null,this.settings={...t,defaultType:g,defaultValue:u,logicalType:s,type:l,normalized:l.includes("norm"),size:this.size,bytesPerElement:g.BYTES_PER_ELEMENT},this.state={...r,externalBuffer:null,bufferAccessor:this.settings,allocatedValue:null,numInstances:0,bounds:null,constant:!1}}get isConstant(){return this.state.constant}get buffer(){return this._buffer}get byteOffset(){const e=this.getAccessor();return e.vertexOffset?e.vertexOffset*Na(e):0}get numInstances(){return this.state.numInstances}set numInstances(e){this.state.numInstances=e}delete(){this._buffer&&(this._buffer.delete(),this._buffer=null),Tc.release(this.state.allocatedValue)}getBuffer(){return this.state.constant?null:this.state.externalBuffer||this._buffer}getValue(e=this.id,t=null){const r={};if(this.state.constant){const s=this.value;if(t){const a=m_(this.getAccessor(),t),u=a.offset/s.BYTES_PER_ELEMENT,l=a.size||this.size;r[e]=s.subarray(u,u+l)}else r[e]=s}else r[e]=this.getBuffer();return this.doublePrecision&&(this.value instanceof Float64Array?r[`${e}64Low`]=r[e]:r[`${e}64Low`]=new Float32Array(this.size)),r}_getBufferLayout(e=this.id,t=null){const r=this.getAccessor(),s=[],a={name:this.id,byteStride:Na(r),attributes:s};if(this.doublePrecision){const u=lF(r,t||{});s.push(hf(e,{...r,...u.high},this.device.type),hf(`${e}64Low`,{...r,...u.low},this.device.type))}else if(t){const u=m_(r,t);s.push(hf(e,{...r,...u},this.device.type))}else s.push(hf(e,r,this.device.type));return a}setAccessor(e){this.state.bufferAccessor=e}getAccessor(){return this.state.bufferAccessor}getBounds(){if(this.state.bounds)return this.state.bounds;let e=null;if(this.state.constant&&this.value){const t=Array.from(this.value);e=[t,t]}else{const{value:t,numInstances:r,size:s}=this,a=r*s;if(t&&a&&t.length>=a){const u=new Array(s).fill(1/0),l=new Array(s).fill(-1/0);for(let g=0;g<a;)for(let v=0;v<s;v++){const T=t[g++];T<u[v]&&(u[v]=T),T>l[v]&&(l[v]=T)}e=[u,l]}}return this.state.bounds=e,e}setData(e){const{state:t}=this;let r;ArrayBuffer.isView(e)?r={value:e}:e instanceof Oi?r={buffer:e}:r=e;const s={...this.settings,...r};if(ArrayBuffer.isView(r.value)){if(!r.type)if(this.doublePrecision&&r.value instanceof Float64Array)s.type="float32";else{const u=oF(r.value);s.type=s.normalized?u.replace("int","norm"):u}s.bytesPerElement=r.value.BYTES_PER_ELEMENT,s.stride=Na(s)}if(t.bounds=null,r.constant){let a=r.value;if(a=this._normalizeValue(a,[],0),this.settings.normalized&&(a=this.normalizeConstant(a)),!(!t.constant||!this._areValuesEqual(a,this.value)))return!1;t.externalBuffer=null,t.constant=!0,this.value=ArrayBuffer.isView(a)?a:new Float32Array(a)}else if(r.buffer){const a=r.buffer;t.externalBuffer=a,t.constant=!1,this.value=r.value||null}else if(r.value){this._checkExternalBuffer(r);let a=r.value;t.externalBuffer=null,t.constant=!1,this.value=a;let{buffer:u}=this;const l=Na(s),g=(s.vertexOffset||0)*l;if(this.doublePrecision&&a instanceof Float64Array&&(a=pm(a,s)),this.settings.isIndexed){const T=this.settings.defaultType;a.constructor!==T&&(a=new T(a))}const v=a.byteLength+g+l*2;(!u||u.byteLength<v)&&(u=this._createBuffer(v)),u.write(a,g)}return this.setAccessor(s),!0}updateSubBuffer(e={}){this.state.bounds=null;const t=this.value,{startOffset:r=0,endOffset:s}=e;this.buffer.write(this.doublePrecision&&t instanceof Float64Array?pm(t,{size:this.size,startIndex:r,endIndex:s}):t.subarray(r,s),r*t.BYTES_PER_ELEMENT+this.byteOffset)}allocate(e,t=!1){const{state:r}=this,s=r.allocatedValue,a=Tc.allocate(s,e+1,{size:this.size,type:this.settings.defaultType,copy:t});this.value=a;const{byteOffset:u}=this;let{buffer:l}=this;return(!l||l.byteLength<a.byteLength+u)&&(l=this._createBuffer(a.byteLength+u),t&&s&&l.write(s instanceof Float64Array?pm(s,this):s,u)),r.allocatedValue=a,r.constant=!1,r.externalBuffer=null,this.setAccessor(this.settings),!0}_checkExternalBuffer(e){const{value:t}=e;if(!ArrayBuffer.isView(t))throw new Error(`Attribute ${this.id} value is not TypedArray`);const r=this.settings.defaultType;let s=!1;if(this.doublePrecision&&(s=t.BYTES_PER_ELEMENT<4),s)throw new Error(`Attribute ${this.id} does not support ${t.constructor.name}`);!(t instanceof r)&&this.settings.normalized&&!("normalized"in e)&&ni.warn(`Attribute ${this.id} is normalized`)()}normalizeConstant(e){switch(this.settings.type){case"snorm8":return new Float32Array(e).map(t=>(t+128)/255*2-1);case"snorm16":return new Float32Array(e).map(t=>(t+32768)/65535*2-1);case"unorm8":return new Float32Array(e).map(t=>t/255);case"unorm16":return new Float32Array(e).map(t=>t/65535);default:return e}}_normalizeValue(e,t,r){const{defaultValue:s,size:a}=this.settings;if(Number.isFinite(e))return t[r]=e,t;if(!e){let u=a;for(;--u>=0;)t[r+u]=s[u];return t}switch(a){case 4:t[r+3]=Number.isFinite(e[3])?e[3]:s[3];case 3:t[r+2]=Number.isFinite(e[2])?e[2]:s[2];case 2:t[r+1]=Number.isFinite(e[1])?e[1]:s[1];case 1:t[r+0]=Number.isFinite(e[0])?e[0]:s[0];break;default:let u=a;for(;--u>=0;)t[r+u]=Number.isFinite(e[u])?e[u]:s[u]}return t}_areValuesEqual(e,t){if(!e||!t)return!1;const{size:r}=this;for(let s=0;s<r;s++)if(e[s]!==t[s])return!1;return!0}_createBuffer(e){this._buffer&&this._buffer.destroy();const{isIndexed:t,type:r}=this.settings;return this._buffer=this.device.createBuffer({...this._buffer?.props,id:this.id,usage:(t?Oi.INDEX:Oi.VERTEX)|Oi.COPY_DST,indexType:t?r:void 0,byteLength:e}),this._buffer}}const R0=[],k0=[];function bp(i,e=0,t=1/0){let r=R0;const s={index:-1,data:i,target:[]};return i?typeof i[Symbol.iterator]=="function"?r=i:i.length>0&&(k0.length=i.length,r=k0):r=R0,(e>0||Number.isFinite(t))&&(r=(Array.isArray(r)?r:Array.from(r)).slice(e,t),s.index=e-1),{iterable:r,objectInfo:s}}function aT(i){return i&&i[Symbol.asyncIterator]}function lT(i,e){const{size:t,stride:r,offset:s,startIndices:a,nested:u}=e,l=i.BYTES_PER_ELEMENT,g=r?r/l:t,v=s?s/l:0,T=Math.floor((i.length-v)/g);return(S,{index:P,target:O})=>{if(!a){const Q=P*g+v;for(let ae=0;ae<t;ae++)O[ae]=i[Q+ae];return O}const $=a[P],W=a[P+1]||T;let G;if(u){G=new Array(W-$);for(let Q=$;Q<W;Q++){const ae=Q*g+v;O=new Array(t);for(let te=0;te<t;te++)O[te]=i[ae+te];G[Q-$]=O}}else if(g===t)G=i.subarray($*t+v,W*t+v);else{G=new i.constructor((W-$)*t);let Q=0;for(let ae=$;ae<W;ae++){const te=ae*g+v;for(let me=0;me<t;me++)G[Q++]=i[te+me]}}return G}}const uF=[],Bf=[[0,1/0]];function hF(i,e){if(i===Bf||(e[0]<0&&(e[0]=0),e[0]>=e[1]))return i;const t=[],r=i.length;let s=0;for(let a=0;a<r;a++){const u=i[a];u[1]<e[0]?(t.push(u),s=a+1):u[0]>e[1]?t.push(u):e=[Math.min(u[0],e[0]),Math.max(u[1],e[1])]}return t.splice(s,0,e),t}const dF={interpolation:{duration:0,easing:i=>i},spring:{stiffness:.05,damping:.5}};function cT(i,e){if(!i)return null;Number.isFinite(i)&&(i={type:"interpolation",duration:i});const t=i.type||"interpolation";return{...dF[t],...e,...i,type:t}}class uT extends cF{constructor(e,t){super(e,t,{startIndices:null,lastExternalBuffer:null,binaryValue:null,binaryAccessor:null,needsUpdate:!0,needsRedraw:!1,layoutChanged:!1,updateRanges:Bf}),this.constant=!1,this.settings.update=t.update||(t.accessor?this._autoUpdater:void 0),Object.seal(this.settings),Object.seal(this.state),this._validateAttributeUpdaters()}get startIndices(){return this.state.startIndices}set startIndices(e){this.state.startIndices=e}needsUpdate(){return this.state.needsUpdate}needsRedraw({clearChangedFlags:e=!1}={}){const t=this.state.needsRedraw;return this.state.needsRedraw=t&&!e,t}layoutChanged(){return this.state.layoutChanged}setAccessor(e){var t;(t=this.state).layoutChanged||(t.layoutChanged=!aF(e,this.getAccessor())),super.setAccessor(e)}getUpdateTriggers(){const{accessor:e}=this.settings;return[this.id].concat(typeof e!="function"&&e||[])}supportsTransition(){return!!this.settings.transition}getTransitionSetting(e){if(!e||!this.supportsTransition())return null;const{accessor:t}=this.settings,r=this.settings.transition,s=Array.isArray(t)?e[t.find(a=>e[a])]:e[t];return cT(s,r)}setNeedsUpdate(e=this.id,t){if(this.state.needsUpdate=this.state.needsUpdate||e,this.setNeedsRedraw(e),t){const{startRow:r=0,endRow:s=1/0}=t;this.state.updateRanges=hF(this.state.updateRanges,[r,s])}else this.state.updateRanges=Bf}clearNeedsUpdate(){this.state.needsUpdate=!1,this.state.updateRanges=uF}setNeedsRedraw(e=this.id){this.state.needsRedraw=this.state.needsRedraw||e}allocate(e){const{state:t,settings:r}=this;return r.noAlloc?!1:r.update?(super.allocate(e,t.updateRanges!==Bf),!0):!1}updateBuffer({numInstances:e,data:t,props:r,context:s}){if(!this.needsUpdate())return!1;const{state:{updateRanges:a},settings:{update:u,noAlloc:l}}=this;let g=!0;if(u){for(const[v,T]of a)u.call(s,this,{data:t,startRow:v,endRow:T,props:r,numInstances:e});if(this.value)if(this.constant||!this.buffer||this.buffer.byteLength<this.value.byteLength+this.byteOffset)this.setData({value:this.value,constant:this.constant}),this.constant=!1;else for(const[v,T]of a){const S=Number.isFinite(v)?this.getVertexOffset(v):0,P=Number.isFinite(T)?this.getVertexOffset(T):l||!Number.isFinite(e)?this.value.length:e*this.size;super.updateSubBuffer({startOffset:S,endOffset:P})}this._checkAttributeArray()}else g=!1;return this.clearNeedsUpdate(),this.setNeedsRedraw(),g}setConstantValue(e,t){const r=this.device.type==="webgpu";if(r||t===void 0||typeof t=="function"){if(r&&typeof t!="function"){const u=this._normalizeValue(t,[],0);this._areValuesEqual(u,this.value)||this.setNeedsUpdate("WebGPU constant updated")}return!1}const s=this.settings.transform&&e?this.settings.transform.call(e,t):t;return this.setData({constant:!0,value:s})&&this.setNeedsRedraw(),this.clearNeedsUpdate(),!0}setExternalBuffer(e){const{state:t}=this;return e?(this.clearNeedsUpdate(),t.lastExternalBuffer===e||(t.lastExternalBuffer=e,this.setNeedsRedraw(),this.setData(e)),!0):(t.lastExternalBuffer=null,!1)}setBinaryValue(e,t=null){const{state:r,settings:s}=this;if(!e)return r.binaryValue=null,r.binaryAccessor=null,!1;if(s.noAlloc)return!1;if(r.binaryValue===e)return this.clearNeedsUpdate(),!0;if(r.binaryValue=e,this.setNeedsRedraw(),s.transform||t!==this.startIndices){ArrayBuffer.isView(e)&&(e={value:e});const u=e;Pr(ArrayBuffer.isView(u.value),`invalid ${s.accessor}`);const l=!!u.size&&u.size!==this.size;return r.binaryAccessor=lT(u.value,{size:u.size||this.size,stride:u.stride,offset:u.offset,startIndices:t,nested:l}),!1}return this.clearNeedsUpdate(),this.setData(e),!0}getVertexOffset(e){const{startIndices:t}=this;return(t?e<t.length?t[e]:this.numInstances:e)*this.size}getValue(){const e=this.settings.shaderAttributes,t=super.getValue();if(!e)return t;for(const r in e)Object.assign(t,super.getValue(r,e[r]));return t}getBufferLayout(e){this.state.layoutChanged=!1;const t=this.settings.shaderAttributes,r=super._getBufferLayout(),{stepMode:s}=this.settings;if(s==="dynamic"?r.stepMode=e?e.isInstanced?"instance":"vertex":"instance":r.stepMode=s??"vertex",!t)return r;for(const a in t){const u=super._getBufferLayout(a,t[a]);r.attributes.push(...u.attributes)}return r}_autoUpdater(e,{data:t,startRow:r,endRow:s,props:a,numInstances:u}){if(e.constant&&this.context.device.type!=="webgpu")return;const{settings:l,state:g,value:v,size:T,startIndices:S}=e,{accessor:P,transform:O}=l;let $=g.binaryAccessor||(typeof P=="function"?P:a[P]);typeof $!="function"&&typeof P=="string"&&($=()=>a[P]),Pr(typeof $=="function",`accessor "${P}" is not a function`);let W=e.getVertexOffset(r);const{iterable:G,objectInfo:Q}=bp(t,r,s);for(const ae of G){Q.index++;let te=$(ae,Q);if(O&&(te=O.call(this,te)),S){const me=(Q.index<S.length-1?S[Q.index+1]:u)-S[Q.index];if(te&&Array.isArray(te[0])){let we=W;for(const Oe of te)e._normalizeValue(Oe,v,we),we+=T}else te&&te.length>T?v.set(te,W):(e._normalizeValue(te,Q.target,0),kO({target:v,source:Q.target,start:W,count:me}));W+=me*T}else e._normalizeValue(te,v,W),W+=T}}_validateAttributeUpdaters(){const{settings:e}=this;if(!(e.noAlloc||typeof e.update=="function"))throw new Error(`Attribute ${this.id} missing update or accessor`)}_checkAttributeArray(){const{value:e}=this,t=Math.min(4,this.size);if(e&&e.length>=t){let r=!0;switch(t){case 4:r=r&&Number.isFinite(e[3]);case 3:r=r&&Number.isFinite(e[2]);case 2:r=r&&Number.isFinite(e[1]);case 1:r=r&&Number.isFinite(e[0]);break;default:r=!1}if(!r)throw new Error(`Illegal attribute generated for ${this.id}`)}}}function Am(i){const{source:e,target:t,start:r=0,size:s,getData:a}=i,u=i.end||t.length,l=e.length,g=u-r;if(l>g){t.set(e.subarray(0,g),r);return}if(t.set(e,r),!a)return;let v=l;for(;v<g;){const T=a(v,e);for(let S=0;S<s;S++)t[r+v]=T[S]||0,v++}}function fF({source:i,target:e,size:t,getData:r,sourceStartIndices:s,targetStartIndices:a}){if(!s||!a)return Am({source:i,target:e,size:t,getData:r}),e;let u=0,l=0;const g=r&&((T,S)=>r(T+l,S)),v=Math.min(s.length,a.length);for(let T=1;T<v;T++){const S=s[T]*t,P=a[T]*t;Am({source:i.subarray(u,S),target:e,start:l,end:P,size:t,getData:g}),u=S,l=P}return l<e.length&&Am({source:[],target:e,start:l,size:t,getData:g}),e}function pF(i){const{device:e,settings:t,value:r}=i,s=new uT(e,t);return s.setData({value:r instanceof Float64Array?new Float64Array(0):new Float32Array(0),normalized:t.normalized}),s}function hT(i){switch(i){case 1:return"float";case 2:return"vec2";case 3:return"vec3";case 4:return"vec4";default:throw new Error(`No defined attribute type for size "${i}"`)}}function dT(i){switch(i){case 1:return"float32";case 2:return"float32x2";case 3:return"float32x3";case 4:return"float32x4";default:throw new Error("invalid type size")}}function fT(i){i.push(i.shift())}function gF(i,e){const{doublePrecision:t,settings:r,value:s,size:a}=i,u=t&&s instanceof Float64Array?2:1;let l=0;const{shaderAttributes:g}=i.settings;if(g)for(const v of Object.values(g))l=Math.max(l,v.vertexOffset??0);return(r.noAlloc?s.length:(e+l)*a)*u}function pT({device:i,source:e,target:t}){return(!t||t.byteLength<e.byteLength)&&(t?.destroy(),t=i.createBuffer({byteLength:e.byteLength,usage:e.usage})),t}function gT({device:i,buffer:e,attribute:t,fromLength:r,toLength:s,fromStartIndices:a,getData:u=l=>l}){const l=t.doublePrecision&&t.value instanceof Float64Array?2:1,g=t.size*l,v=t.byteOffset,T=t.settings.bytesPerElement<4?v/t.settings.bytesPerElement*4:v,S=t.startIndices,P=a&&S,O=t.isConstant;if(!P&&e&&r>=s)return e;const $=t.value instanceof Float64Array?Float32Array:t.value.constructor,W=O?t.value:new $(t.getBuffer().readSyncWebGL(v,s*$.BYTES_PER_ELEMENT).buffer);if(t.settings.normalized&&!O){const te=u;u=(me,we)=>t.normalizeConstant(te(me,we))}const G=O?(te,me)=>u(W,me):(te,me)=>u(W.subarray(te+v,te+v+g),me),Q=e?new Float32Array(e.readSyncWebGL(T,r*4).buffer):new Float32Array(0),ae=new Float32Array(s);return fF({source:Q,target:ae,sourceStartIndices:a,targetStartIndices:S,size:g,getData:G}),(!e||e.byteLength<ae.byteLength+T)&&(e?.destroy(),e=i.createBuffer({byteLength:ae.byteLength+T,usage:35050})),e.write(ae,T),e}class mT{constructor({device:e,attribute:t,timeline:r}){this.buffers=[],this.currentLength=0,this.device=e,this.transition=new vp(r),this.attribute=t,this.attributeInTransition=pF(t),this.currentStartIndices=t.startIndices}get inProgress(){return this.transition.inProgress}start(e,t,r=1/0){this.settings=e,this.currentStartIndices=this.attribute.startIndices,this.currentLength=gF(this.attribute,t),this.transition.start({...e,duration:r})}update(){const e=this.transition.update();return e&&this.onUpdate(),e}setBuffer(e){this.attributeInTransition.setData({buffer:e,normalized:this.attribute.settings.normalized,value:this.attributeInTransition.value})}cancel(){this.transition.cancel()}delete(){this.cancel();for(const e of this.buffers)e.destroy();this.buffers.length=0}}class mF extends mT{constructor({device:e,attribute:t,timeline:r}){super({device:e,attribute:t,timeline:r}),this.type="interpolation",this.transform=vF(e,t)}start(e,t){const r=this.currentLength,s=this.currentStartIndices;if(super.start(e,t,e.duration),e.duration<=0){this.transition.cancel();return}const{buffers:a,attribute:u}=this;fT(a),a[0]=gT({device:this.device,buffer:a[0],attribute:u,fromLength:r,toLength:this.currentLength,fromStartIndices:s,getData:e.enter}),a[1]=pT({device:this.device,source:a[0],target:a[1]}),this.setBuffer(a[1]);const{transform:l}=this,g=l.model;let v=Math.floor(this.currentLength/u.size);_T(u)&&(v/=2),g.setVertexCount(v),u.isConstant?(g.setAttributes({aFrom:a[0]}),g.setConstantAttributes({aTo:u.value})):g.setAttributes({aFrom:a[0],aTo:u.getBuffer()}),l.transformFeedback.setBuffers({vCurrent:a[1]})}onUpdate(){const{duration:e,easing:t}=this.settings,{time:r}=this.transition;let s=r/e;t&&(s=t(s));const{model:a}=this.transform,u={time:s};a.shaderInputs.setProps({interpolation:u}),this.transform.run({discard:!0})}delete(){super.delete(),this.transform.destroy()}}const _F=`uniform interpolationUniforms {
  float time;
} interpolation;
`,D0={name:"interpolation",vs:_F,uniformTypes:{time:"f32"}},yF=`#version 300 es
#define SHADER_NAME interpolation-transition-vertex-shader

in ATTRIBUTE_TYPE aFrom;
in ATTRIBUTE_TYPE aTo;
out ATTRIBUTE_TYPE vCurrent;

void main(void) {
  vCurrent = mix(aFrom, aTo, interpolation.time);
  gl_Position = vec4(0.0);
}
`,xF=`#version 300 es
#define SHADER_NAME interpolation-transition-vertex-shader

in ATTRIBUTE_TYPE aFrom;
in ATTRIBUTE_TYPE aFrom64Low;
in ATTRIBUTE_TYPE aTo;
in ATTRIBUTE_TYPE aTo64Low;
out ATTRIBUTE_TYPE vCurrent;
out ATTRIBUTE_TYPE vCurrent64Low;

vec2 mix_fp64(vec2 a, vec2 b, float x) {
  vec2 range = sub_fp64(b, a);
  return sum_fp64(a, mul_fp64(range, vec2(x, 0.0)));
}

void main(void) {
  for (int i=0; i<ATTRIBUTE_SIZE; i++) {
    vec2 value = mix_fp64(vec2(aFrom[i], aFrom64Low[i]), vec2(aTo[i], aTo64Low[i]), interpolation.time);
    vCurrent[i] = value.x;
    vCurrent64Low[i] = value.y;
  }
  gl_Position = vec4(0.0);
}
`;function _T(i){return i.doublePrecision&&i.value instanceof Float64Array}function vF(i,e){const t=e.size,r=hT(t),s=dT(t),a=e.getBufferLayout();return _T(e)?new Sc(i,{vs:xF,bufferLayout:[{name:"aFrom",byteStride:8*t,attributes:[{attribute:"aFrom",format:s,byteOffset:0},{attribute:"aFrom64Low",format:s,byteOffset:4*t}]},{name:"aTo",byteStride:8*t,attributes:[{attribute:"aTo",format:s,byteOffset:0},{attribute:"aTo64Low",format:s,byteOffset:4*t}]}],modules:[IR,D0],defines:{ATTRIBUTE_TYPE:r,ATTRIBUTE_SIZE:t},moduleSettings:{},varyings:["vCurrent","vCurrent64Low"],bufferMode:35980,disableWarnings:!0}):new Sc(i,{vs:yF,bufferLayout:[{name:"aFrom",format:s},{name:"aTo",format:a.attributes[0].format}],modules:[D0],defines:{ATTRIBUTE_TYPE:r},varyings:["vCurrent"],disableWarnings:!0})}class bF extends mT{constructor({device:e,attribute:t,timeline:r}){super({device:e,attribute:t,timeline:r}),this.type="spring",this.texture=IF(e),this.framebuffer=CF(e,this.texture),this.transform=EF(e,t)}start(e,t){const r=this.currentLength,s=this.currentStartIndices;super.start(e,t);const{buffers:a,attribute:u}=this;for(let g=0;g<2;g++)a[g]=gT({device:this.device,buffer:a[g],attribute:u,fromLength:r,toLength:this.currentLength,fromStartIndices:s,getData:e.enter});a[2]=pT({device:this.device,source:a[0],target:a[2]}),this.setBuffer(a[1]);const{model:l}=this.transform;l.setVertexCount(Math.floor(this.currentLength/u.size)),u.isConstant?l.setConstantAttributes({aTo:u.value}):l.setAttributes({aTo:u.getBuffer()})}onUpdate(){const{buffers:e,transform:t,framebuffer:r,transition:s}=this,a=this.settings;t.model.setAttributes({aPrev:e[0],aCur:e[1]}),t.transformFeedback.setBuffers({vNext:e[2]});const u={stiffness:a.stiffness,damping:a.damping};t.model.shaderInputs.setProps({spring:u}),t.run({framebuffer:r,discard:!1,parameters:{viewport:[0,0,1,1]},clearColor:[0,0,0,0]}),fT(e),this.setBuffer(e[1]),this.device.readPixelsToArrayWebGL(r)[0]>0||s.end()}delete(){super.delete(),this.transform.destroy(),this.texture.destroy(),this.framebuffer.destroy()}}const wF=`uniform springUniforms {
  float damping;
  float stiffness;
} spring;
`,TF={name:"spring",vs:wF,uniformTypes:{damping:"f32",stiffness:"f32"}},SF=`#version 300 es
#define SHADER_NAME spring-transition-vertex-shader

#define EPSILON 0.00001

in ATTRIBUTE_TYPE aPrev;
in ATTRIBUTE_TYPE aCur;
in ATTRIBUTE_TYPE aTo;
out ATTRIBUTE_TYPE vNext;
out float vIsTransitioningFlag;

ATTRIBUTE_TYPE getNextValue(ATTRIBUTE_TYPE cur, ATTRIBUTE_TYPE prev, ATTRIBUTE_TYPE dest) {
  ATTRIBUTE_TYPE velocity = cur - prev;
  ATTRIBUTE_TYPE delta = dest - cur;
  ATTRIBUTE_TYPE force = delta * spring.stiffness;
  ATTRIBUTE_TYPE resistance = velocity * spring.damping;
  return force - resistance + velocity + cur;
}

void main(void) {
  bool isTransitioning = length(aCur - aPrev) > EPSILON || length(aTo - aCur) > EPSILON;
  vIsTransitioningFlag = isTransitioning ? 1.0 : 0.0;

  vNext = getNextValue(aCur, aPrev, aTo);
  gl_Position = vec4(0, 0, 0, 1);
  gl_PointSize = 100.0;
}
`,AF=`#version 300 es
#define SHADER_NAME spring-transition-is-transitioning-fragment-shader

in float vIsTransitioningFlag;

out vec4 fragColor;

void main(void) {
  if (vIsTransitioningFlag == 0.0) {
    discard;
  }
  fragColor = vec4(1.0);
}`;function EF(i,e){const t=hT(e.size),r=dT(e.size);return new Sc(i,{vs:SF,fs:AF,bufferLayout:[{name:"aPrev",format:r},{name:"aCur",format:r},{name:"aTo",format:e.getBufferLayout().attributes[0].format}],varyings:["vNext"],modules:[TF],defines:{ATTRIBUTE_TYPE:t},parameters:{depthCompare:"always",blendColorOperation:"max",blendColorSrcFactor:"one",blendColorDstFactor:"one",blendAlphaOperation:"max",blendAlphaSrcFactor:"one",blendAlphaDstFactor:"one"}})}function IF(i){return i.createTexture({data:new Uint8Array(4),format:"rgba8unorm",width:1,height:1})}function CF(i,e){return i.createFramebuffer({id:"spring-transition-is-transitioning-framebuffer",width:1,height:1,colorAttachments:[e]})}const PF={interpolation:mF,spring:bF};class MF{constructor(e,{id:t,timeline:r}){if(!e)throw new Error("AttributeTransitionManager is constructed without device");this.id=t,this.device=e,this.timeline=r,this.transitions={},this.needsRedraw=!1,this.numInstances=1}finalize(){for(const e in this.transitions)this._removeTransition(e)}update({attributes:e,transitions:t,numInstances:r}){this.numInstances=r||1;for(const s in e){const a=e[s],u=a.getTransitionSetting(t);u&&this._updateAttribute(s,a,u)}for(const s in this.transitions){const a=e[s];(!a||!a.getTransitionSetting(t))&&this._removeTransition(s)}}hasAttribute(e){const t=this.transitions[e];return t&&t.inProgress}getAttributes(){const e={};for(const t in this.transitions){const r=this.transitions[t];r.inProgress&&(e[t]=r.attributeInTransition)}return e}run(){if(this.numInstances===0)return!1;for(const t in this.transitions)this.transitions[t].update()&&(this.needsRedraw=!0);const e=this.needsRedraw;return this.needsRedraw=!1,e}_removeTransition(e){this.transitions[e].delete(),delete this.transitions[e]}_updateAttribute(e,t,r){const s=this.transitions[e];let a=!s||s.type!==r.type;if(a){s&&this._removeTransition(e);const u=PF[r.type];u?this.transitions[e]=new u({attribute:t,timeline:this.timeline,device:this.device}):(ni.error(`unsupported transition type '${r.type}'`)(),a=!1)}(a||t.needsRedraw())&&(this.needsRedraw=!0,this.transitions[e].start(r,this.numInstances))}}const O0="attributeManager.invalidate",RF="attributeManager.updateStart",kF="attributeManager.updateEnd",DF="attribute.updateStart",OF="attribute.allocate",LF="attribute.updateEnd";class FF{constructor(e,{id:t="attribute-manager",stats:r,timeline:s}={}){this.mergeBoundsMemoized=jh(KD),this.id=t,this.device=e,this.attributes={},this.updateTriggers={},this.needsRedraw=!0,this.userData={},this.stats=r,this.attributeTransitionManager=new MF(e,{id:`${t}-transitions`,timeline:s}),Object.seal(this)}finalize(){for(const e in this.attributes)this.attributes[e].delete();this.attributeTransitionManager.finalize()}getNeedsRedraw(e={clearRedrawFlags:!1}){const t=this.needsRedraw;return this.needsRedraw=this.needsRedraw&&!e.clearRedrawFlags,t&&this.id}setNeedsRedraw(){this.needsRedraw=!0}add(e){this._add(e)}addInstanced(e){this._add(e,{stepMode:"instance"})}remove(e){for(const t of e)this.attributes[t]!==void 0&&(this.attributes[t].delete(),delete this.attributes[t])}invalidate(e,t){const r=this._invalidateTrigger(e,t);Hr(O0,this,e,r)}invalidateAll(e){for(const t in this.attributes)this.attributes[t].setNeedsUpdate(t,e);Hr(O0,this,"all")}update({data:e,numInstances:t,startIndices:r=null,transitions:s,props:a={},buffers:u={},context:l={}}){let g=!1;Hr(RF,this),this.stats&&this.stats.get("Update Attributes").timeStart();for(const v in this.attributes){const T=this.attributes[v],S=T.settings.accessor;T.startIndices=r,T.numInstances=t,a[v]&&ni.removed(`props.${v}`,`data.attributes.${v}`)(),T.setExternalBuffer(u[v])||T.setBinaryValue(typeof S=="string"?u[S]:void 0,e.startIndices)||typeof S=="string"&&!u[S]&&T.setConstantValue(l,a[S])||T.needsUpdate()&&(g=!0,this._updateAttribute({attribute:T,numInstances:t,data:e,props:a,context:l})),this.needsRedraw=this.needsRedraw||T.needsRedraw()}g&&Hr(kF,this,t),this.stats&&this.stats.get("Update Attributes").timeEnd(),this.attributeTransitionManager.update({attributes:this.attributes,numInstances:t,transitions:s})}updateTransition(){const{attributeTransitionManager:e}=this,t=e.run();return this.needsRedraw=this.needsRedraw||t,t}getAttributes(){return{...this.attributes,...this.attributeTransitionManager.getAttributes()}}getBounds(e){const t=e.map(r=>this.attributes[r]?.getBounds());return this.mergeBoundsMemoized(t)}getChangedAttributes(e={clearChangedFlags:!1}){const{attributes:t,attributeTransitionManager:r}=this,s={...r.getAttributes()};for(const a in t){const u=t[a];u.needsRedraw(e)&&!r.hasAttribute(a)&&(s[a]=u)}return s}getBufferLayouts(e){return Object.values(this.getAttributes()).map(t=>t.getBufferLayout(e))}_add(e,t){for(const r in e){const s=e[r],a={...s,id:r,size:s.isIndexed&&1||s.size||1,...t};this.attributes[r]=new uT(this.device,a)}this._mapUpdateTriggersToAttributes()}_mapUpdateTriggersToAttributes(){const e={};for(const t in this.attributes)this.attributes[t].getUpdateTriggers().forEach(s=>{e[s]||(e[s]=[]),e[s].push(t)});this.updateTriggers=e}_invalidateTrigger(e,t){const{attributes:r,updateTriggers:s}=this,a=s[e];return a&&a.forEach(u=>{const l=r[u];l&&l.setNeedsUpdate(l.id,t)}),a}_updateAttribute(e){const{attribute:t,numInstances:r}=e;if(Hr(DF,t),t.constant){t.setConstantValue(e.context,t.value);return}t.allocate(r)&&Hr(OF,t,r),t.updateBuffer(e)&&(this.needsRedraw=!0,Hr(LF,t,r))}}class BF extends vp{get value(){return this._value}_onUpdate(){const{time:e,settings:{fromValue:t,toValue:r,duration:s,easing:a}}=this,u=a(e/s);this._value=ja(t,r,u)}}const L0=1e-5;function F0(i,e,t,r,s){const a=e-i,l=(t-e)*s,g=-a*r;return l+g+a+e}function NF(i,e,t,r,s){if(Array.isArray(t)){const a=[];for(let u=0;u<t.length;u++)a[u]=F0(i[u],e[u],t[u],r,s);return a}return F0(i,e,t,r,s)}function B0(i,e){if(Array.isArray(i)){let t=0;for(let r=0;r<i.length;r++){const s=i[r]-e[r];t+=s*s}return Math.sqrt(t)}return Math.abs(i-e)}class zF extends vp{get value(){return this._currValue}_onUpdate(){const{fromValue:e,toValue:t,damping:r,stiffness:s}=this.settings,{_prevValue:a=e,_currValue:u=e}=this;let l=NF(a,u,t,r,s);const g=B0(l,t),v=B0(l,u);g<L0&&v<L0&&(l=t,this.end()),this._prevValue=u,this._currValue=l}}const UF={interpolation:BF,spring:zF};class VF{constructor(e){this.transitions=new Map,this.timeline=e}get active(){return this.transitions.size>0}add(e,t,r,s){const{transitions:a}=this;if(a.has(e)){const g=a.get(e),{value:v=g.settings.fromValue}=g;t=v,this.remove(e)}if(s=cT(s),!s)return;const u=UF[s.type];if(!u){ni.error(`unsupported transition type '${s.type}'`)();return}const l=new u(this.timeline);l.start({...s,fromValue:t,toValue:r}),a.set(e,l)}remove(e){const{transitions:t}=this;t.has(e)&&(t.get(e).cancel(),t.delete(e))}update(){const e={};for(const[t,r]of this.transitions)r.update(),e[t]=r.value,r.inProgress||this.remove(t);return e}clear(){for(const e of this.transitions.keys())this.remove(e)}}function jF(i){const e=i[ea];for(const t in e){const r=e[t],{validate:s}=r;if(s&&!s(i[t],r))throw new Error(`Invalid prop ${t}: ${i[t]}`)}}function $F(i,e){const t=yT({newProps:i,oldProps:e,propTypes:i[ea],ignoreProps:{data:null,updateTriggers:null,extensions:null,transitions:null}}),r=HF(i,e);let s=!1;return r||(s=qF(i,e)),{dataChanged:r,propsChanged:t,updateTriggersChanged:s,extensionsChanged:XF(i,e),transitionsChanged:WF(i,e)}}function WF(i,e){if(!i.transitions)return!1;const t={},r=i[ea];let s=!1;for(const a in i.transitions){const u=r[a],l=u&&u.type;(l==="number"||l==="color"||l==="array")&&__(i[a],e[a],u)&&(t[a]=!0,s=!0)}return s?t:!1}function yT({newProps:i,oldProps:e,ignoreProps:t={},propTypes:r={},triggerName:s="props"}){if(e===i)return!1;if(typeof i!="object"||i===null)return`${s} changed shallowly`;if(typeof e!="object"||e===null)return`${s} changed shallowly`;for(const a of Object.keys(i))if(!(a in t)){if(!(a in e))return`${s}.${a} added`;const u=__(i[a],e[a],r[a]);if(u)return`${s}.${a} ${u}`}for(const a of Object.keys(e))if(!(a in t)){if(!(a in i))return`${s}.${a} dropped`;if(!Object.hasOwnProperty.call(i,a)){const u=__(i[a],e[a],r[a]);if(u)return`${s}.${a} ${u}`}}return!1}function __(i,e,t){let r=t&&t.equal;return r&&!r(i,e,t)||!r&&(r=i&&e&&i.equals,r&&!r.call(i,e))?"changed deeply":!r&&e!==i?"changed shallowly":null}function HF(i,e){if(e===null)return"oldProps is null, initial diff";let t=!1;const{dataComparator:r,_dataDiff:s}=i;return r?r(i.data,e.data)||(t="Data comparator detected a change"):i.data!==e.data&&(t="A new data container was supplied"),t&&s&&(t=s(i.data,e.data)||t),t}function qF(i,e){if(e===null)return{all:!0};if("all"in i.updateTriggers&&N0(i,e,"all"))return{all:!0};const t={};let r=!1;for(const s in i.updateTriggers)s!=="all"&&N0(i,e,s)&&(t[s]=!0,r=!0);return r?t:!1}function XF(i,e){if(e===null)return!0;const t=e.extensions,{extensions:r}=i;if(r===t)return!1;if(!t||!r||r.length!==t.length)return!0;for(let s=0;s<r.length;s++)if(!r[s].equals(t[s]))return!0;return!1}function N0(i,e,t){let r=i.updateTriggers[t];r=r??{};let s=e.updateTriggers[t];return s=s??{},yT({oldProps:s,newProps:r,triggerName:t})}const ZF="count(): argument not an object",YF="count(): argument not a container";function GF(i){if(!JF(i))throw new Error(ZF);if(typeof i.count=="function")return i.count();if(Number.isFinite(i.size))return i.size;if(Number.isFinite(i.length))return i.length;if(KF(i))return Object.keys(i).length;throw new Error(YF)}function KF(i){return i!==null&&typeof i=="object"&&i.constructor===Object}function JF(i){return i!==null&&typeof i=="object"}function z0(i,e){if(!e)return i;const t={...i,...e};if("defines"in e&&(t.defines={...i.defines,...e.defines}),"modules"in e&&(t.modules=(i.modules||[]).concat(e.modules),e.modules.some(r=>r.name==="project64"))){const r=t.modules.findIndex(s=>s.name==="project32");r>=0&&t.modules.splice(r,1)}if("inject"in e)if(!i.inject)t.inject=e.inject;else{const r={...i.inject};for(const s in e.inject)r[s]=(r[s]||"")+e.inject[s];t.inject=r}return t}const QF={minFilter:"linear",mipmapFilter:"linear",magFilter:"linear",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge"},y_={};function eB(i,e,t,r){if(t instanceof fr)return t;t.constructor&&t.constructor.name!=="Object"&&(t={data:t});let s=null;t.compressed&&(s={minFilter:"linear",mipmapFilter:t.data.length>1?"nearest":"linear"});const{width:a,height:u}=t.data,l=e.createTexture({...t,sampler:{...QF,...s,...r},mipLevels:e.getMipLevelCount(a,u)});return l.generateMipmapsWebGL(),y_[l.id]=i,l}function tB(i,e){!e||!(e instanceof fr)||y_[e.id]===i&&(e.delete(),delete y_[e.id])}const iB={boolean:{validate(i,e){return!0},equal(i,e,t){return!!i==!!e}},number:{validate(i,e){return Number.isFinite(i)&&(!("max"in e)||i<=e.max)&&(!("min"in e)||i>=e.min)}},color:{validate(i,e){return e.optional&&!i||x_(i)&&(i.length===3||i.length===4)},equal(i,e,t){return Zs(i,e,1)}},accessor:{validate(i,e){const t=cp(i);return t==="function"||t===cp(e.value)},equal(i,e,t){return typeof e=="function"?!0:Zs(i,e,1)}},array:{validate(i,e){return e.optional&&!i||x_(i)},equal(i,e,t){const{compare:r}=t,s=Number.isInteger(r)?r:r?1:0;return r?Zs(i,e,s):i===e}},object:{equal(i,e,t){if(t.ignore)return!0;const{compare:r}=t,s=Number.isInteger(r)?r:r?1:0;return r?Zs(i,e,s):i===e}},function:{validate(i,e){return e.optional&&!i||typeof i=="function"},equal(i,e,t){return!t.compare&&t.ignore!==!1||i===e}},data:{transform:(i,e,t)=>{if(!i)return i;const{dataTransform:r}=t.props;return r?r(i):typeof i.shape=="string"&&i.shape.endsWith("-table")&&Array.isArray(i.data)?i.data:i}},image:{transform:(i,e,t)=>{const r=t.context;return!r||!r.device?null:eB(t.id,r.device,i,{...e.parameters,...t.props.textureParameters})},release:(i,e,t)=>{tB(t.id,i)}}};function rB(i){const e={},t={},r={};for(const[s,a]of Object.entries(i)){const u=a?.deprecatedFor;if(u)r[s]=Array.isArray(u)?u:[u];else{const l=sB(s,a);e[s]=l,t[s]=l.value}}return{propTypes:e,defaultProps:t,deprecatedProps:r}}function sB(i,e){switch(cp(e)){case"object":return Hu(i,e);case"array":return Hu(i,{type:"array",value:e,compare:!1});case"boolean":return Hu(i,{type:"boolean",value:e});case"number":return Hu(i,{type:"number",value:e});case"function":return Hu(i,{type:"function",value:e,compare:!0});default:return{name:i,type:"unknown",value:e}}}function Hu(i,e){return"type"in e?{name:i,...iB[e.type],...e}:"value"in e?{name:i,type:cp(e.value),...e}:{name:i,type:"object",value:e}}function x_(i){return Array.isArray(i)||ArrayBuffer.isView(i)}function cp(i){return x_(i)?"array":i===null?"null":typeof i}function nB(i,e){let t;for(let a=e.length-1;a>=0;a--){const u=e[a];"extensions"in u&&(t=u.extensions)}const r=v_(i.constructor,t),s=Object.create(r);s[lp]=i,s[Ka]={},s[Go]={};for(let a=0;a<e.length;++a){const u=e[a];for(const l in u)s[l]=u[l]}return Object.freeze(s),s}const oB="_mergedDefaultProps";function v_(i,e){if(!(i instanceof wp.constructor))return{};let t=oB;if(e)for(const s of e){const a=s.constructor;a&&(t+=`:${a.extensionName||a.name}`)}const r=xT(i,t);return r||(i[t]=aB(i,e||[]))}function aB(i,e){if(!i.prototype)return null;const r=Object.getPrototypeOf(i),s=v_(r),a=xT(i,"defaultProps")||{},u=rB(a),l=Object.assign(Object.create(null),s,u.defaultProps),g=Object.assign(Object.create(null),s?.[ea],u.propTypes),v=Object.assign(Object.create(null),s?.[xm],u.deprecatedProps);for(const T of e){const S=v_(T.constructor);S&&(Object.assign(l,S),Object.assign(g,S[ea]),Object.assign(v,S[xm]))}return lB(l,i),uB(l,g),cB(l,v),l[ea]=g,l[xm]=v,e.length===0&&!Py(i,"_propTypes")&&(i._propTypes=g),l}function lB(i,e){const t=dB(e);Object.defineProperties(i,{id:{writable:!0,value:t}})}function cB(i,e){for(const t in e)Object.defineProperty(i,t,{enumerable:!1,set(r){const s=`${this.id}: ${t}`;for(const a of e[t])Py(this,a)||(this[a]=r);ni.deprecated(s,e[t].join("/"))()}})}function uB(i,e){const t={},r={};for(const s in e){const a=e[s],{name:u,value:l}=a;a.async&&(t[u]=l,r[u]=hB(u))}i[yc]=t,i[Ka]={},Object.defineProperties(i,r)}function hB(i){return{enumerable:!0,set(e){typeof e=="string"||e instanceof Promise||aT(e)?this[Ka][i]=e:this[Go][i]=e},get(){if(this[Go]){if(i in this[Go])return this[Go][i]||this[yc][i];if(i in this[Ka]){const e=this[lp]&&this[lp].internalState;if(e&&e.hasAsyncProp(i))return e.getAsyncProp(i)||this[yc][i]}}return this[yc][i]}}}function Py(i,e){return Object.prototype.hasOwnProperty.call(i,e)}function xT(i,e){return Py(i,e)&&i[e]}function dB(i){const e=i.componentName;return e||ni.warn(`${i.name}.componentName not specified`)(),e||i.name}let fB=0;class wp{constructor(...e){this.props=nB(this,e),this.id=this.props.id,this.count=fB++}clone(e){const{props:t}=this,r={};for(const s in t[yc])s in t[Go]?r[s]=t[Go][s]:s in t[Ka]&&(r[s]=t[Ka][s]);return new this.constructor({...t,...r,...e})}}wp.componentName="Component";wp.defaultProps={};const pB=Object.freeze({});class gB{constructor(e){this.component=e,this.asyncProps={},this.onAsyncPropUpdated=()=>{},this.oldProps=null,this.oldAsyncProps=null}finalize(){for(const e in this.asyncProps){const t=this.asyncProps[e];t&&t.type&&t.type.release&&t.type.release(t.resolvedValue,t.type,this.component)}this.asyncProps={},this.component=null,this.resetOldProps()}getOldProps(){return this.oldAsyncProps||this.oldProps||pB}resetOldProps(){this.oldAsyncProps=null,this.oldProps=this.component?this.component.props:null}hasAsyncProp(e){return e in this.asyncProps}getAsyncProp(e){const t=this.asyncProps[e];return t&&t.resolvedValue}isAsyncPropLoading(e){if(e){const t=this.asyncProps[e];return!!(t&&t.pendingLoadCount>0&&t.pendingLoadCount!==t.resolvedLoadCount)}for(const t in this.asyncProps)if(this.isAsyncPropLoading(t))return!0;return!1}reloadAsyncProp(e,t){this._watchPromise(e,Promise.resolve(t))}setAsyncProps(e){this.component=e[lp]||this.component;const t=e[Go]||{},r=e[Ka]||e,s=e[yc]||{};for(const a in t){const u=t[a];this._createAsyncPropData(a,s[a]),this._updateAsyncProp(a,u),t[a]=this.getAsyncProp(a)}for(const a in r){const u=r[a];this._createAsyncPropData(a,s[a]),this._updateAsyncProp(a,u)}}_fetch(e,t){return null}_onResolve(e,t){}_onError(e,t){}_updateAsyncProp(e,t){if(this._didAsyncInputValueChange(e,t)){if(typeof t=="string"&&(t=this._fetch(e,t)),t instanceof Promise){this._watchPromise(e,t);return}if(aT(t)){this._resolveAsyncIterable(e,t);return}this._setPropValue(e,t)}}_freezeAsyncOldProps(){if(!this.oldAsyncProps&&this.oldProps){this.oldAsyncProps=Object.create(this.oldProps);for(const e in this.asyncProps)Object.defineProperty(this.oldAsyncProps,e,{enumerable:!0,value:this.oldProps[e]})}}_didAsyncInputValueChange(e,t){const r=this.asyncProps[e];return t===r.resolvedValue||t===r.lastValue?!1:(r.lastValue=t,!0)}_setPropValue(e,t){this._freezeAsyncOldProps();const r=this.asyncProps[e];r&&(t=this._postProcessValue(r,t),r.resolvedValue=t,r.pendingLoadCount++,r.resolvedLoadCount=r.pendingLoadCount)}_setAsyncPropValue(e,t,r){const s=this.asyncProps[e];s&&r>=s.resolvedLoadCount&&t!==void 0&&(this._freezeAsyncOldProps(),s.resolvedValue=t,s.resolvedLoadCount=r,this.onAsyncPropUpdated(e,t))}_watchPromise(e,t){const r=this.asyncProps[e];if(r){r.pendingLoadCount++;const s=r.pendingLoadCount;t.then(a=>{this.component&&(a=this._postProcessValue(r,a),this._setAsyncPropValue(e,a,s),this._onResolve(e,a))}).catch(a=>{this._onError(e,a)})}}async _resolveAsyncIterable(e,t){if(e!=="data"){this._setPropValue(e,t);return}const r=this.asyncProps[e];if(!r)return;r.pendingLoadCount++;const s=r.pendingLoadCount;let a=[],u=0;for await(const l of t){if(!this.component)return;const{dataTransform:g}=this.component.props;g?a=g(l,a):a=a.concat(l),Object.defineProperty(a,"__diff",{enumerable:!1,value:[{startRow:u,endRow:a.length}]}),u=a.length,this._setAsyncPropValue(e,a,s)}this._onResolve(e,a)}_postProcessValue(e,t){const r=e.type;return r&&this.component&&(r.release&&r.release(e.resolvedValue,r,this.component),r.transform)?r.transform(t,r,this.component):t}_createAsyncPropData(e,t){if(!this.asyncProps[e]){const s=this.component&&this.component.props[ea];this.asyncProps[e]={type:s&&s[e],lastValue:null,resolvedValue:t,pendingLoadCount:0,resolvedLoadCount:0}}}}class mB extends gB{constructor({attributeManager:e,layer:t}){super(t),this.attributeManager=e,this.needsRedraw=!0,this.needsUpdate=!0,this.subLayers=null,this.usesPickingColorCache=!1}get layer(){return this.component}_fetch(e,t){const r=this.layer,s=r?.props.fetch;return s?s(t,{propName:e,layer:r}):super._fetch(e,t)}_onResolve(e,t){const r=this.layer;if(r){const s=r.props.onDataLoad;e==="data"&&s&&s(t,{propName:e,layer:r})}}_onError(e,t){const r=this.layer;r&&r.raiseError(t,`loading ${e} of ${this.layer}`)}}const _B="layer.changeFlag",yB="layer.initialize",xB="layer.update",vB="layer.finalize",bB="layer.matched",U0=2**24-1,wB=Object.freeze([]),TB=jh(({oldViewport:i,viewport:e})=>i.equals(e));let nn=new Uint8ClampedArray(0);const SB={data:{type:"data",value:wB,async:!0},dataComparator:{type:"function",value:null,optional:!0},_dataDiff:{type:"function",value:i=>i&&i.__diff,optional:!0},dataTransform:{type:"function",value:null,optional:!0},onDataLoad:{type:"function",value:null,optional:!0},onError:{type:"function",value:null,optional:!0},fetch:{type:"function",value:(i,{propName:e,layer:t,loaders:r,loadOptions:s,signal:a})=>{const{resourceManager:u}=t.context;s=s||t.getLoadOptions(),r=r||t.props.loaders,a&&(s={...s,fetch:{...s?.fetch,signal:a}});let l=u.contains(i);return!l&&!s&&(u.add({resourceId:i,data:Zf(i,r),persistent:!1}),l=!0),l?u.subscribe({resourceId:i,onChange:g=>t.internalState?.reloadAsyncProp(e,g),consumerId:t.id,requestId:e}):Zf(i,r,s)}},updateTriggers:{},visible:!0,pickable:!1,opacity:{type:"number",min:0,max:1,value:1},operation:"draw",onHover:{type:"function",value:null,optional:!0},onClick:{type:"function",value:null,optional:!0},onDragStart:{type:"function",value:null,optional:!0},onDrag:{type:"function",value:null,optional:!0},onDragEnd:{type:"function",value:null,optional:!0},coordinateSystem:li.DEFAULT,coordinateOrigin:{type:"array",value:[0,0,0],compare:!0},modelMatrix:{type:"array",value:null,compare:!0,optional:!0},wrapLongitude:!1,positionFormat:"XYZ",colorFormat:"RGBA",parameters:{type:"object",value:{},optional:!0,compare:2},loadOptions:{type:"object",value:null,optional:!0,ignore:!0},transitions:null,extensions:[],loaders:{type:"array",value:[],optional:!0,ignore:!0},getPolygonOffset:{type:"function",value:({layerIndex:i})=>[0,-i*100]},highlightedObjectIndex:null,autoHighlight:!1,highlightColor:{type:"accessor",value:[0,0,128,128]}};class Cn extends wp{constructor(){super(...arguments),this.internalState=null,this.lifecycle=sc.NO_STATE,this.parent=null}static get componentName(){return Object.prototype.hasOwnProperty.call(this,"layerName")?this.layerName:""}get root(){let e=this;for(;e.parent;)e=e.parent;return e}toString(){return`${this.constructor.layerName||this.constructor.name}({id: '${this.props.id}'})`}project(e){Pr(this.internalState);const t=this.internalState.viewport||this.context.viewport,r=V2(e,{viewport:t,modelMatrix:this.props.modelMatrix,coordinateOrigin:this.props.coordinateOrigin,coordinateSystem:this.props.coordinateSystem}),[s,a,u]=B2(r,t.pixelProjectionMatrix);return e.length===2?[s,a]:[s,a,u]}unproject(e){return Pr(this.internalState),(this.internalState.viewport||this.context.viewport).unproject(e)}projectPosition(e,t){Pr(this.internalState);const r=this.internalState.viewport||this.context.viewport;return rO(e,{viewport:r,modelMatrix:this.props.modelMatrix,coordinateOrigin:this.props.coordinateOrigin,coordinateSystem:this.props.coordinateSystem,...t})}get isComposite(){return!1}get isDrawable(){return!0}setState(e){this.setChangeFlags({stateChanged:!0}),Object.assign(this.state,e),this.setNeedsRedraw()}setNeedsRedraw(){this.internalState&&(this.internalState.needsRedraw=!0)}setNeedsUpdate(){this.internalState&&(this.context.layerManager.setNeedsUpdate(String(this)),this.internalState.needsUpdate=!0)}get isLoaded(){return this.internalState?!this.internalState.isAsyncPropLoading():!1}get wrapLongitude(){return this.props.wrapLongitude}isPickable(){return this.props.pickable&&this.props.visible}getModels(){const e=this.state;return e&&(e.models||e.model&&[e.model])||[]}setShaderModuleProps(...e){for(const t of this.getModels())t.shaderInputs.setProps(...e)}getAttributeManager(){return this.internalState&&this.internalState.attributeManager}getCurrentLayer(){return this.internalState&&this.internalState.layer}getLoadOptions(){return this.props.loadOptions}use64bitPositions(){const{coordinateSystem:e}=this.props;return e===li.DEFAULT||e===li.LNGLAT||e===li.CARTESIAN}onHover(e,t){return this.props.onHover&&this.props.onHover(e,t)||!1}onClick(e,t){return this.props.onClick&&this.props.onClick(e,t)||!1}nullPickingColor(){return[0,0,0]}encodePickingColor(e,t=[]){return t[0]=e+1&255,t[1]=e+1>>8&255,t[2]=e+1>>8>>8&255,t}decodePickingColor(e){Pr(e instanceof Uint8Array);const[t,r,s]=e;return t+r*256+s*65536-1}getNumInstances(){return Number.isFinite(this.props.numInstances)?this.props.numInstances:this.state&&this.state.numInstances!==void 0?this.state.numInstances:GF(this.props.data)}getStartIndices(){return this.props.startIndices?this.props.startIndices:this.state&&this.state.startIndices?this.state.startIndices:null}getBounds(){return this.getAttributeManager()?.getBounds(["positions","instancePositions"])}getShaders(e){e=z0(e,{disableWarnings:!0,modules:this.context.defaultShaderModules});for(const t of this.props.extensions)e=z0(e,t.getShaders.call(this,t));return e}shouldUpdateState(e){return e.changeFlags.propsOrDataChanged}updateState(e){const t=this.getAttributeManager(),{dataChanged:r}=e.changeFlags;if(r&&t)if(Array.isArray(r))for(const s of r)t.invalidateAll(s);else t.invalidateAll();if(t){const{props:s}=e,a=this.internalState.hasPickingBuffer,u=Number.isInteger(s.highlightedObjectIndex)||s.pickable||s.extensions.some(l=>l.getNeedsPickingBuffer.call(this,l));if(a!==u){this.internalState.hasPickingBuffer=u;const{pickingColors:l,instancePickingColors:g}=t.attributes,v=l||g;v&&(u&&v.constant&&(v.constant=!1,t.invalidate(v.id)),!v.value&&!u&&(v.constant=!0,v.value=[0,0,0]))}}}finalizeState(e){for(const r of this.getModels())r.destroy();const t=this.getAttributeManager();t&&t.finalize(),this.context&&this.context.resourceManager.unsubscribe({consumerId:this.id}),this.internalState&&(this.internalState.uniformTransitions.clear(),this.internalState.finalize())}draw(e){for(const t of this.getModels())t.draw(e.renderPass)}getPickingInfo({info:e,mode:t,sourceLayer:r}){const{index:s}=e;return s>=0&&Array.isArray(this.props.data)&&(e.object=this.props.data[s]),e}raiseError(e,t){t&&(e=new Error(`${t}: ${e.message}`,{cause:e})),this.props.onError?.(e)||this.context?.onError?.(e,this)}getNeedsRedraw(e={clearRedrawFlags:!1}){return this._getNeedsRedraw(e)}needsUpdate(){return this.internalState?this.internalState.needsUpdate||this.hasUniformTransition()||this.shouldUpdateState(this._getUpdateParams()):!1}hasUniformTransition(){return this.internalState?.uniformTransitions.active||!1}activateViewport(e){if(!this.internalState)return;const t=this.internalState.viewport;this.internalState.viewport=e,(!t||!TB({oldViewport:t,viewport:e}))&&(this.setChangeFlags({viewportChanged:!0}),this.isComposite?this.needsUpdate()&&this.setNeedsUpdate():this._update())}invalidateAttribute(e="all"){const t=this.getAttributeManager();t&&(e==="all"?t.invalidateAll():t.invalidate(e))}updateAttributes(e){let t=!1;for(const r in e)e[r].layoutChanged()&&(t=!0);for(const r of this.getModels())this._setModelAttributes(r,e,t)}_updateAttributes(){const e=this.getAttributeManager();if(!e)return;const t=this.props,r=this.getNumInstances(),s=this.getStartIndices();e.update({data:t.data,numInstances:r,startIndices:s,props:t,transitions:t.transitions,buffers:t.data.attributes,context:this});const a=e.getChangedAttributes({clearChangedFlags:!0});this.updateAttributes(a)}_updateAttributeTransition(){const e=this.getAttributeManager();e&&e.updateTransition()}_updateUniformTransition(){const{uniformTransitions:e}=this.internalState;if(e.active){const t=e.update(),r=Object.create(this.props);for(const s in t)Object.defineProperty(r,s,{value:t[s]});return r}return this.props}calculateInstancePickingColors(e,{numInstances:t}){if(e.constant)return;const r=Math.floor(nn.length/4);if(this.internalState.usesPickingColorCache=!0,r<t){t>U0&&ni.warn("Layer has too many data objects. Picking might not be able to distinguish all objects.")(),nn=Tc.allocate(nn,t,{size:4,copy:!0,maxCount:Math.max(t,U0)});const s=Math.floor(nn.length/4),a=[0,0,0];for(let u=r;u<s;u++)this.encodePickingColor(u,a),nn[u*4+0]=a[0],nn[u*4+1]=a[1],nn[u*4+2]=a[2],nn[u*4+3]=0}e.value=nn.subarray(0,t*4)}_setModelAttributes(e,t,r=!1){if(!Object.keys(t).length)return;if(r){const l=this.getAttributeManager();e.setBufferLayout(l.getBufferLayouts(e)),t=l.getAttributes()}const s=e.userData?.excludeAttributes||{},a={},u={};for(const l in t){if(s[l])continue;const g=t[l].getValue();for(const v in g){const T=g[v];T instanceof Oi?t[l].settings.isIndexed?e.setIndexBuffer(T):a[v]=T:T&&(u[v]=T)}}e.setAttributes(a),e.setConstantAttributes(u)}disablePickingIndex(e){const t=this.props.data;if(!("attributes"in t)){this._disablePickingIndex(e);return}const{pickingColors:r,instancePickingColors:s}=this.getAttributeManager().attributes,a=r||s,u=a&&t.attributes&&t.attributes[a.id];if(u&&u.value){const l=u.value,g=this.encodePickingColor(e);for(let v=0;v<t.length;v++){const T=a.getVertexOffset(v);l[T]===g[0]&&l[T+1]===g[1]&&l[T+2]===g[2]&&this._disablePickingIndex(v)}}else this._disablePickingIndex(e)}_disablePickingIndex(e){const{pickingColors:t,instancePickingColors:r}=this.getAttributeManager().attributes,s=t||r;if(!s)return;const a=s.getVertexOffset(e),u=s.getVertexOffset(e+1);s.buffer.write(new Uint8Array(u-a),a)}restorePickingColors(){const{pickingColors:e,instancePickingColors:t}=this.getAttributeManager().attributes,r=e||t;r&&(this.internalState.usesPickingColorCache&&r.value.buffer!==nn.buffer&&(r.value=nn.subarray(0,r.value.length)),r.updateSubBuffer({startOffset:0}))}_initialize(){Pr(!this.internalState),Pr(Number.isFinite(this.props.coordinateSystem)),Hr(yB,this);const e=this._getAttributeManager();e&&e.addInstanced({instancePickingColors:{type:"uint8",size:4,noAlloc:!0,update:this.calculateInstancePickingColors}}),this.internalState=new mB({attributeManager:e,layer:this}),this._clearChangeFlags(),this.state={},Object.defineProperty(this.state,"attributeManager",{get:()=>(ni.deprecated("layer.state.attributeManager","layer.getAttributeManager()")(),e)}),this.internalState.uniformTransitions=new VF(this.context.timeline),this.internalState.onAsyncPropUpdated=this._onAsyncPropUpdated.bind(this),this.internalState.setAsyncProps(this.props),this.initializeState(this.context);for(const t of this.props.extensions)t.initializeState.call(this,this.context,t);this.setChangeFlags({dataChanged:"init",propsChanged:"init",viewportChanged:!0,extensionsChanged:!0}),this._update()}_transferState(e){Hr(bB,this,this===e);const{state:t,internalState:r}=e;this!==e&&(this.internalState=r,this.state=t,this.internalState.setAsyncProps(this.props),this._diffProps(this.props,this.internalState.getOldProps()))}_update(){const e=this.needsUpdate();if(Hr(xB,this,e),!e)return;const t=this.props,r=this.context,s=this.internalState,a=r.viewport,u=this._updateUniformTransition();s.propsInTransition=u,r.viewport=s.viewport||a,this.props=u;try{const l=this._getUpdateParams(),g=this.getModels();if(r.device)this.updateState(l);else try{this.updateState(l)}catch{}for(const T of this.props.extensions)T.updateState.call(this,l,T);this.setNeedsRedraw(),this._updateAttributes();const v=this.getModels()[0]!==g[0];this._postUpdate(l,v)}finally{r.viewport=a,this.props=t,this._clearChangeFlags(),s.needsUpdate=!1,s.resetOldProps()}}_finalize(){Hr(vB,this),this.finalizeState(this.context);for(const e of this.props.extensions)e.finalizeState.call(this,this.context,e)}_drawLayer({renderPass:e,shaderModuleProps:t=null,uniforms:r={},parameters:s={}}){this._updateAttributeTransition();const a=this.props,u=this.context;this.props=this.internalState.propsInTransition||a;try{t&&this.setShaderModuleProps(t);const{getPolygonOffset:l}=this.props,g=l&&l(r)||[0,0];u.device instanceof g_&&u.device.setParametersWebGL({polygonOffset:g});for(const v of this.getModels())v.device.type==="webgpu"?v.setParameters({...v.parameters,...s}):v.setParameters(s);if(u.device instanceof g_)u.device.withParametersWebGL(s,()=>{const v={renderPass:e,shaderModuleProps:t,uniforms:r,parameters:s,context:u};for(const T of this.props.extensions)T.draw.call(this,v,T);this.draw(v)});else{const v={renderPass:e,shaderModuleProps:t,uniforms:r,parameters:s,context:u};for(const T of this.props.extensions)T.draw.call(this,v,T);this.draw(v)}}finally{this.props=a}}getChangeFlags(){return this.internalState?.changeFlags}setChangeFlags(e){if(!this.internalState)return;const{changeFlags:t}=this.internalState;for(const s in e)if(e[s]){let a=!1;switch(s){case"dataChanged":const u=e[s],l=t[s];u&&Array.isArray(l)&&(t.dataChanged=Array.isArray(u)?l.concat(u):u,a=!0);default:t[s]||(t[s]=e[s],a=!0)}a&&Hr(_B,this,s,e)}const r=!!(t.dataChanged||t.updateTriggersChanged||t.propsChanged||t.extensionsChanged);t.propsOrDataChanged=r,t.somethingChanged=r||t.viewportChanged||t.stateChanged}_clearChangeFlags(){this.internalState.changeFlags={dataChanged:!1,propsChanged:!1,updateTriggersChanged:!1,viewportChanged:!1,stateChanged:!1,extensionsChanged:!1,propsOrDataChanged:!1,somethingChanged:!1}}_diffProps(e,t){const r=$F(e,t);if(r.updateTriggersChanged)for(const s in r.updateTriggersChanged)r.updateTriggersChanged[s]&&this.invalidateAttribute(s);if(r.transitionsChanged)for(const s in r.transitionsChanged)this.internalState.uniformTransitions.add(s,t[s],e[s],e.transitions?.[s]);return this.setChangeFlags(r)}validateProps(){jF(this.props)}updateAutoHighlight(e){this.props.autoHighlight&&!Number.isInteger(this.props.highlightedObjectIndex)&&this._updateAutoHighlight(e)}_updateAutoHighlight(e){const t={highlightedObjectColor:e.picked?e.color:null},{highlightColor:r}=this.props;e.picked&&typeof r=="function"&&(t.highlightColor=r(e)),this.setShaderModuleProps({picking:t}),this.setNeedsRedraw()}_getAttributeManager(){const e=this.context;return new FF(e.device,{id:this.props.id,stats:e.stats,timeline:e.timeline})}_postUpdate(e,t){const{props:r,oldProps:s}=e,a=this.state.model;a?.isInstanced&&a.setInstanceCount(this.getNumInstances());const{autoHighlight:u,highlightedObjectIndex:l,highlightColor:g}=r;if(t||s.autoHighlight!==u||s.highlightedObjectIndex!==l||s.highlightColor!==g){const v={};Array.isArray(g)&&(v.highlightColor=g),(t||s.autoHighlight!==u||l!==s.highlightedObjectIndex)&&(v.highlightedObjectColor=Number.isFinite(l)&&l>=0?this.encodePickingColor(l):null),this.setShaderModuleProps({picking:v})}}_getUpdateParams(){return{props:this.props,oldProps:this.internalState.getOldProps(),context:this.context,changeFlags:this.internalState.changeFlags}}_getNeedsRedraw(e){if(!this.internalState)return!1;let t=!1;t=t||this.internalState.needsRedraw&&this.id;const r=this.getAttributeManager(),s=r?r.getNeedsRedraw(e):!1;if(t=t||s,t)for(const a of this.props.extensions)a.onNeedsRedraw.call(this,a);return this.internalState.needsRedraw=this.internalState.needsRedraw&&!e.clearRedrawFlags,t}_onAsyncPropUpdated(){this._diffProps(this.props,this.internalState.getOldProps()),this.setNeedsUpdate()}}Cn.defaultProps=SB;Cn.layerName="Layer";const AB="compositeLayer.renderLayers";class Tp extends Cn{get isComposite(){return!0}get isDrawable(){return!1}get isLoaded(){return super.isLoaded&&this.getSubLayers().every(e=>e.isLoaded)}getSubLayers(){return this.internalState&&this.internalState.subLayers||[]}initializeState(e){}setState(e){super.setState(e),this.setNeedsUpdate()}getPickingInfo({info:e}){const{object:t}=e;return t&&t.__source&&t.__source.parent&&t.__source.parent.id===this.id&&(e.object=t.__source.object,e.index=t.__source.index),e}filterSubLayer(e){return!0}shouldRenderSubLayer(e,t){return t&&t.length}getSubLayerClass(e,t){const{_subLayerProps:r}=this.props;return r&&r[e]&&r[e].type||t}getSubLayerRow(e,t,r){return e.__source={parent:this,object:t,index:r},e}getSubLayerAccessor(e){if(typeof e=="function"){const t={index:-1,data:this.props.data,target:[]};return(r,s)=>r&&r.__source?(t.index=r.__source.index,e(r.__source.object,t)):e(r,s)}return e}getSubLayerProps(e={}){const{opacity:t,pickable:r,visible:s,parameters:a,getPolygonOffset:u,highlightedObjectIndex:l,autoHighlight:g,highlightColor:v,coordinateSystem:T,coordinateOrigin:S,wrapLongitude:P,positionFormat:O,modelMatrix:$,extensions:W,fetch:G,operation:Q,_subLayerProps:ae}=this.props,te={id:"",updateTriggers:{},opacity:t,pickable:r,visible:s,parameters:a,getPolygonOffset:u,highlightedObjectIndex:l,autoHighlight:g,highlightColor:v,coordinateSystem:T,coordinateOrigin:S,wrapLongitude:P,positionFormat:O,modelMatrix:$,extensions:W,fetch:G,operation:Q},me=ae&&e.id&&ae[e.id],we=me&&me.updateTriggers,Oe=e.id||"sublayer";if(me){const Je=this.props[ea],it=e.type?e.type._propTypes:{};for(const He in me){const ht=it[He]||Je[He];ht&&ht.type==="accessor"&&(me[He]=this.getSubLayerAccessor(me[He]))}}Object.assign(te,e,me),te.id=`${this.props.id}-${Oe}`,te.updateTriggers={all:this.props.updateTriggers?.all,...e.updateTriggers,...we};for(const Je of W){const it=Je.getSubLayerProps.call(this,Je);it&&Object.assign(te,it,{updateTriggers:Object.assign(te.updateTriggers,it.updateTriggers)})}return te}_updateAutoHighlight(e){for(const t of this.getSubLayers())t.updateAutoHighlight(e)}_getAttributeManager(){return null}_postUpdate(e,t){let r=this.internalState.subLayers;const s=!r||this.needsUpdate();if(s){const a=this.renderLayers();r=xp(a,Boolean),this.internalState.subLayers=r}Hr(AB,this,s,r);for(const a of r)a.parent=this}}Tp.layerName="CompositeLayer";const df=Math.PI/180,V0=180/Math.PI,Nf=6370972,dc=256;function EB(){const i=dc/Nf,e=Math.PI/180*dc;return{unitsPerMeter:[i,i,i],unitsPerMeter2:[0,0,0],metersPerUnit:[1/i,1/i,1/i],unitsPerDegree:[e,e,i],unitsPerDegree2:[0,0,0],degreesPerUnit:[1/e,1/e,1/i]}}class IB extends kc{constructor(e={}){const{longitude:t=0,zoom:r=0,nearZMultiplier:s=.5,farZMultiplier:a=1,resolution:u=10}=e;let{latitude:l=0,height:g,altitude:v=1.5,fovy:T}=e;l=Math.max(Math.min(l,ac),-ac),g=g||1,T?v=gy(T):T=kh(v);const S=1/Math.PI/Math.cos(l*Math.PI/180),P=Math.pow(2,r)*S,O=e.nearZ??s,$=e.farZ??(v+dc*2*P/g)*a,W=new Mr().lookAt({eye:[0,-v,0],up:[0,0,1]});W.rotateX(l*df),W.rotateZ(-t*df),W.scale(P/g),super({...e,height:g,viewMatrix:W,longitude:t,latitude:l,zoom:r,distanceScales:EB(),fovy:T,focalDistance:v,near:O,far:$}),this.scale=P,this.latitude=l,this.longitude=t,this.resolution=u}get projectionMode(){return Bs.GLOBE}getDistanceScales(){return this.distanceScales}getBounds(e={}){const t={targetZ:e.z||0},r=this.unproject([0,this.height/2],t),s=this.unproject([this.width/2,0],t),a=this.unproject([this.width,this.height/2],t),u=this.unproject([this.width/2,this.height],t);return a[0]<this.longitude&&(a[0]+=360),r[0]>this.longitude&&(r[0]-=360),[Math.min(r[0],a[0],s[0],u[0]),Math.min(r[1],a[1],s[1],u[1]),Math.max(r[0],a[0],s[0],u[0]),Math.max(r[1],a[1],s[1],u[1])]}unproject(e,{topLeft:t=!0,targetZ:r}={}){const[s,a,u]=e,l=t?a:this.height-a,{pixelUnprojectionMatrix:g}=this;let v;if(Number.isFinite(u))v=Em(g,[s,l,u,1]);else{const O=Em(g,[s,l,-1,1]),$=Em(g,[s,l,1,1]),W=((r||0)/Nf+1)*dc,G=om(p2([],O,$)),Q=om(O),ae=om($),me=4*((4*Q*ae-(G-Q-ae)**2)/16)/G,we=Math.sqrt(Q-me),Oe=Math.sqrt(Math.max(0,W*W-me)),Je=(we-Oe)/Math.sqrt(G);v=mM([],O,$,Je)}const[T,S,P]=this.unprojectPosition(v);return Number.isFinite(u)?[T,S,P]:Number.isFinite(r)?[T,S,r]:[T,S]}projectPosition(e){const[t,r,s=0]=e,a=t*df,u=r*df,l=Math.cos(u),g=(s/Nf+1)*dc;return[Math.sin(a)*l*g,-Math.cos(a)*l*g,Math.sin(u)*g]}unprojectPosition(e){const[t,r,s]=e,a=g2(e),u=Math.asin(s/a),g=Math.atan2(t,-r)*V0,v=u*V0,T=(a/dc-1)*Nf;return[g,v,T]}projectFlat(e){return e}unprojectFlat(e){return e}panByPosition(e,t){const r=this.unproject(t);return{longitude:e[0]-r[0]+this.longitude,latitude:e[1]-r[1]+this.latitude}}}function Em(i,e){const t=Pc([],e,i);return dy(t,t,1/t[3]),t}class vT{constructor(e){this.indexStarts=[0],this.vertexStarts=[0],this.vertexCount=0,this.instanceCount=0;const{attributes:t={}}=e;this.typedArrayManager=Tc,this.attributes={},this._attributeDefs=t,this.opts=e,this.updateGeometry(e)}updateGeometry(e){Object.assign(this.opts,e);const{data:t,buffers:r={},getGeometry:s,geometryBuffer:a,positionFormat:u,dataChanged:l,normalize:g=!0}=this.opts;if(this.data=t,this.getGeometry=s,this.positionSize=a&&a.size||(u==="XY"?2:3),this.buffers=r,this.normalize=g,a&&(Pr(t.startIndices),this.getGeometry=this.getGeometryFromBuffer(a),g||(r.vertexPositions=a)),this.geometryBuffer=r.vertexPositions,Array.isArray(l))for(const v of l)this._rebuildGeometry(v);else this._rebuildGeometry()}updatePartialGeometry({startRow:e,endRow:t}){this._rebuildGeometry({startRow:e,endRow:t})}getGeometryFromBuffer(e){const t=e.value||e;return ArrayBuffer.isView(t)?lT(t,{size:this.positionSize,offset:e.offset,stride:e.stride,startIndices:this.data.startIndices}):null}_allocate(e,t){const{attributes:r,buffers:s,_attributeDefs:a,typedArrayManager:u}=this;for(const l in a)if(l in s)u.release(r[l]),r[l]=null;else{const g=a[l];g.copy=t,r[l]=u.allocate(r[l],e,g)}}_forEachGeometry(e,t,r){const{data:s,getGeometry:a}=this,{iterable:u,objectInfo:l}=bp(s,t,r);for(const g of u){l.index++;const v=a?a(g,l):null;e(v,l.index)}}_rebuildGeometry(e){if(!this.data)return;let{indexStarts:t,vertexStarts:r,instanceCount:s}=this;const{data:a,geometryBuffer:u}=this,{startRow:l=0,endRow:g=1/0}=e||{},v={};if(e||(t=[0],r=[0]),this.normalize||!u)this._forEachGeometry((S,P)=>{const O=S&&this.normalizeGeometry(S);v[P]=O,r[P+1]=r[P]+(O?this.getGeometrySize(O):0)},l,g),s=r[r.length-1];else if(r=a.startIndices,s=r[a.length]||0,ArrayBuffer.isView(u))s=s||u.length/this.positionSize;else if(u instanceof Oi){const S=this.positionSize*4;s=s||u.byteLength/S}else if(u.buffer){const S=u.stride||this.positionSize*4;s=s||u.buffer.byteLength/S}else if(u.value){const S=u.value,P=u.stride/S.BYTES_PER_ELEMENT||this.positionSize;s=s||S.length/P}this._allocate(s,!!e),this.indexStarts=t,this.vertexStarts=r,this.instanceCount=s;const T={};this._forEachGeometry((S,P)=>{const O=v[P]||S;T.vertexStart=r[P],T.indexStart=t[P];const $=P<r.length-1?r[P+1]:s;T.geometrySize=$-r[P],T.geometryIndex=P,this.updateGeometryAttributes(O,T)},l,g),this.vertexCount=t[t.length-1]}}const CB=typeof window<"u"?je.useLayoutEffect:je.useEffect;function up(i,e){for(;i;){if(i===e)return!0;i=Object.getPrototypeOf(i)}return!1}const PB={position:"absolute",zIndex:-1};function bT(i,e){if(typeof i=="function")return i(e);if(Array.isArray(i))return i.map(t=>bT(t,e));if(Sp(i)){if(MB(i))return e.style=PB,je.cloneElement(i,e);if(RB(i))return je.cloneElement(i,e)}return i}function Sp(i){return i&&typeof i=="object"&&"type"in i||!1}function MB(i){return i.props?.mapStyle}function RB(i){const e=i.type;return e&&e.deckGLViewProps}function b_(i){if(typeof i=="function")return je.createElement(Ec,{},i);if(Array.isArray(i))return i.map(b_);if(Sp(i)){if(i.type===je.Fragment)return b_(i.props.children);if(up(i.type,Ec))return i}return i}function kB({children:i,layers:e=[],views:t=null}){const r=[],s=[],a={};return je.Children.forEach(b_(i),u=>{if(Sp(u)){const l=u.type;if(up(l,Cn)){const g=DB(l,u.props);s.push(g)}else r.push(u);if(up(l,Ec)&&l!==Ec&&u.props.id){const g=new l(u.props);a[g.id]=g}}else u&&r.push(u)}),Object.keys(a).length>0&&(Array.isArray(t)?t.forEach(u=>{a[u.id]=u}):t&&(a[t.id]=t),t=Object.values(a)),e=s.length>0?[...s,...e]:e,{layers:e,children:r,views:t}}function DB(i,e){const t={},r=i.defaultProps||{};for(const s in e)r[s]!==e[s]&&(t[s]=e[s]);return new i(t)}const OB=je.createContext();function LB({children:i,deck:e,ContextProvider:t=OB.Provider}){const{viewManager:r}=e||{};if(!r||!r.views.length)return[];const s={},a=r.views[0].id;for(const u of i){let l=a,g=u;Sp(u)&&up(u.type,Ec)&&(l=u.props.id||a,g=u.props.children);const v=r.getViewport(l),T=r.getViewState(l);if(v){T.padding=v.padding;const{x:S,y:P,width:O,height:$}=v;g=bT(g,{x:S,y:P,width:O,height:$,viewport:v,viewState:T}),s[l]||(s[l]={viewport:v,children:[]}),s[l].children.push(g)}}return Object.keys(s).map(u=>{const{viewport:l,children:g}=s[u],{x:v,y:T,width:S,height:P}=l,O={position:"absolute",left:v,top:T,width:S,height:P},$=`view-${u}`,W=je.createElement("div",{key:$,id:$,style:O},...g),G={deck:e,viewport:l,container:e.canvas.offsetParent,eventManager:e.eventManager,onViewStateChange:ae=>{ae.viewId=u,e._onViewStateChange(ae)},widgets:[]},Q=`view-${u}-context`;return je.createElement(t,{key:Q,value:G},W)})}const FB={mixBlendMode:null};function BB({width:i,height:e,style:t}){const r={position:"absolute",zIndex:0,left:0,top:0,width:i,height:e},s={left:0,top:0};if(t)for(const a in t)a in FB?s[a]=t[a]:r[a]=t[a];return{containerStyle:r,canvasStyle:s}}function NB(i){return{get deck(){return i.deck},pickObject:e=>i.deck.pickObject(e),pickMultipleObjects:e=>i.deck.pickMultipleObjects(e),pickObjects:e=>i.deck.pickObjects(e)}}function wT(i){i.redrawReason&&(i.deck._drawLayers(i.redrawReason),i.redrawReason=null)}function zB(i,e,t){const r=new e({...t,_customRender:t.deviceProps?.adapters?.[0]?.type==="webgpu"?void 0:s=>{i.redrawReason=s;const a=r.getViewports();i.lastRenderedViewports!==a?i.forceUpdate():wT(i)}});return r}function UB(i,e){const[t,r]=je.useState(0),a=je.useRef({control:null,version:t,forceUpdate:()=>r(we=>we+1)}).current,u=je.useRef(null),l=je.useRef(null),g=je.useMemo(()=>kB(i),[i.layers,i.views,i.children]);let v=!0;const T=we=>v&&i.viewState?(a.viewStateUpdateRequested=we,null):(a.viewStateUpdateRequested=null,i.onViewStateChange?.(we)),S=we=>{v?a.interactionStateUpdateRequested=we:(a.interactionStateUpdateRequested=null,i.onInteractionStateChange?.(we))},P=je.useMemo(()=>{const we={widgets:[],...i,style:null,width:"100%",height:"100%",parent:u.current,canvas:l.current,layers:g.layers,views:g.views,onViewStateChange:T,onInteractionStateChange:S};return delete we._customRender,a.deck&&a.deck.setProps(we),we},[i]);je.useEffect(()=>{const we=i.Deck||Cy;return a.deck=zB(a,we,{...P,parent:u.current,canvas:l.current}),()=>a.deck?.finalize()},[]),CB(()=>{wT(a);const{viewStateUpdateRequested:we,interactionStateUpdateRequested:Oe}=a;we&&T(we),Oe&&S(Oe),a.deck?.isInitialized&&a.deck.redraw("Initial render")}),je.useImperativeHandle(e,()=>NB(a),[]);const O=a.deck&&a.deck.isInitialized?a.deck.getViewports():void 0,{ContextProvider:$,width:W="100%",height:G="100%",id:Q,style:ae}=i,{containerStyle:te,canvasStyle:me}=je.useMemo(()=>BB({width:W,height:G,style:ae}),[W,G,ae]);if(!a.viewStateUpdateRequested&&a.lastRenderedViewports===O||a.version!==t){a.lastRenderedViewports=O,a.version=t;const we=LB({children:g.children,deck:a.deck,ContextProvider:$}),Oe=je.createElement("canvas",{key:"canvas",id:Q||"deckgl-overlay",ref:l,style:me});a.control=je.createElement("div",{id:`${Q||"deckgl"}-wrapper`,ref:u,style:te},[Oe,we])}return v=!1,a.control}const VB=je.forwardRef(UB),jB=je.createContext(null);function $B(i,e){const t=Array.isArray(i)?i[0]:i?i.x:0,r=Array.isArray(i)?i[1]:i?i.y:0,s=Array.isArray(e)?e[0]:e?e.x:0,a=Array.isArray(e)?e[1]:e?e.y:0;return t===s&&r===a}function Sn(i,e){if(i===e)return!0;if(!i||!e)return!1;if(Array.isArray(i)){if(!Array.isArray(e)||i.length!==e.length)return!1;for(let t=0;t<i.length;t++)if(!Sn(i[t],e[t]))return!1;return!0}else if(Array.isArray(e))return!1;if(typeof i=="object"&&typeof e=="object"){const t=Object.keys(i),r=Object.keys(e);if(t.length!==r.length)return!1;for(const s of t)if(!e.hasOwnProperty(s)||!Sn(i[s],e[s]))return!1;return!0}return!1}function j0(i){return{longitude:i.center.lng,latitude:i.center.lat,zoom:i.zoom,pitch:i.pitch,bearing:i.bearing,padding:i.padding}}function $0(i,e){const t=e.viewState||e,r={};if("longitude"in t&&"latitude"in t&&(t.longitude!==i.center.lng||t.latitude!==i.center.lat)){const s=i.center.constructor;r.center=new s(t.longitude,t.latitude)}return"zoom"in t&&t.zoom!==i.zoom&&(r.zoom=t.zoom),"bearing"in t&&t.bearing!==i.bearing&&(r.bearing=t.bearing),"pitch"in t&&t.pitch!==i.pitch&&(r.pitch=t.pitch),t.padding&&i.padding&&!Sn(t.padding,i.padding)&&(r.padding=t.padding),r}const WB=["type","source","source-layer","minzoom","maxzoom","filter","layout"];function W0(i){if(!i)return null;if(typeof i=="string"||("toJS"in i&&(i=i.toJS()),!i.layers))return i;const e={};for(const r of i.layers)e[r.id]=r;const t=i.layers.map(r=>{let s=null;"interactive"in r&&(s=Object.assign({},r),delete s.interactive);const a=e[r.ref];if(a){s=s||Object.assign({},r),delete s.ref;for(const u of WB)u in a&&(s[u]=a[u])}return s||r});return{...i,layers:t}}const H0={version:8,sources:{},layers:[]},q0={mousedown:"onMouseDown",mouseup:"onMouseUp",mouseover:"onMouseOver",mousemove:"onMouseMove",click:"onClick",dblclick:"onDblClick",mouseenter:"onMouseEnter",mouseleave:"onMouseLeave",mouseout:"onMouseOut",contextmenu:"onContextMenu",touchstart:"onTouchStart",touchend:"onTouchEnd",touchmove:"onTouchMove",touchcancel:"onTouchCancel"},X0={movestart:"onMoveStart",move:"onMove",moveend:"onMoveEnd",dragstart:"onDragStart",drag:"onDrag",dragend:"onDragEnd",zoomstart:"onZoomStart",zoom:"onZoom",zoomend:"onZoomEnd",rotatestart:"onRotateStart",rotate:"onRotate",rotateend:"onRotateEnd",pitchstart:"onPitchStart",pitch:"onPitch",pitchend:"onPitchEnd"},Z0={wheel:"onWheel",boxzoomstart:"onBoxZoomStart",boxzoomend:"onBoxZoomEnd",boxzoomcancel:"onBoxZoomCancel",resize:"onResize",load:"onLoad",render:"onRender",idle:"onIdle",remove:"onRemove",data:"onData",styledata:"onStyleData",sourcedata:"onSourceData",error:"onError"},HB=["minZoom","maxZoom","minPitch","maxPitch","maxBounds","projection","renderWorldCopies"],qB=["scrollZoom","boxZoom","dragRotate","dragPan","keyboard","doubleClickZoom","touchZoomRotate","touchPitch"];class Cc{constructor(e,t,r){this._map=null,this._internalUpdate=!1,this._hoveredFeatures=null,this._propsedCameraUpdate=null,this._styleComponents={},this._onEvent=s=>{const a=this.props[Z0[s.type]];a?a(s):s.type==="error"&&console.error(s.error)},this._onCameraEvent=s=>{if(this._internalUpdate)return;s.viewState=this._propsedCameraUpdate||j0(this._map.transform);const a=this.props[X0[s.type]];a&&a(s)},this._onCameraUpdate=s=>this._internalUpdate?s:(this._propsedCameraUpdate=j0(s),$0(s,this.props)),this._onPointerEvent=s=>{(s.type==="mousemove"||s.type==="mouseout")&&this._updateHover(s);const a=this.props[q0[s.type]];a&&(this.props.interactiveLayerIds&&s.type!=="mouseover"&&s.type!=="mouseout"&&(s.features=this._hoveredFeatures||this._queryRenderedFeatures(s.point)),a(s),delete s.features)},this._MapClass=e,this.props=t,this._initialize(r)}get map(){return this._map}setProps(e){const t=this.props;this.props=e;const r=this._updateSettings(e,t),s=this._updateSize(e),a=this._updateViewState(e);this._updateStyle(e,t),this._updateStyleComponents(e),this._updateHandlers(e,t),(r||s||a&&!this._map.isMoving())&&this.redraw()}static reuse(e,t){const r=Cc.savedMaps.pop();if(!r)return null;const s=r.map,a=s.getContainer();for(t.className=a.className;a.childNodes.length>0;)t.appendChild(a.childNodes[0]);s._container=t;const u=s._resizeObserver;u&&(u.disconnect(),u.observe(t)),r.setProps({...e,styleDiffing:!1}),s.resize();const{initialViewState:l}=e;return l&&(l.bounds?s.fitBounds(l.bounds,{...l.fitBoundsOptions,duration:0}):r._updateViewState(l)),s.isStyleLoaded()?s.fire("load"):s.once("style.load",()=>s.fire("load")),s._update(),r}_initialize(e){const{props:t}=this,{mapStyle:r=H0}=t,s={...t,...t.initialViewState,container:e,style:W0(r)},a=s.initialViewState||s.viewState||s;if(Object.assign(s,{center:[a.longitude||0,a.latitude||0],zoom:a.zoom||0,pitch:a.pitch||0,bearing:a.bearing||0}),t.gl){const l=HTMLCanvasElement.prototype.getContext;HTMLCanvasElement.prototype.getContext=()=>(HTMLCanvasElement.prototype.getContext=l,t.gl)}const u=new this._MapClass(s);a.padding&&u.setPadding(a.padding),t.cursor&&(u.getCanvas().style.cursor=t.cursor),u.transformCameraUpdate=this._onCameraUpdate,u.on("style.load",()=>{this._styleComponents={light:u.getLight(),sky:u.getSky(),projection:u.getProjection?.(),terrain:u.getTerrain()},this._updateStyleComponents(this.props)}),u.on("sourcedata",()=>{this._updateStyleComponents(this.props)});for(const l in q0)u.on(l,this._onPointerEvent);for(const l in X0)u.on(l,this._onCameraEvent);for(const l in Z0)u.on(l,this._onEvent);this._map=u}recycle(){this.map.getContainer().querySelector("[mapboxgl-children]")?.remove(),Cc.savedMaps.push(this)}destroy(){this._map.remove()}redraw(){const e=this._map;e.style&&(e._frame&&(e._frame.cancel(),e._frame=null),e._render())}_updateSize(e){const{viewState:t}=e;if(t){const r=this._map;if(t.width!==r.transform.width||t.height!==r.transform.height)return r.resize(),!0}return!1}_updateViewState(e){const t=this._map,r=t.transform;if(!t.isMoving()){const a=$0(r,e);if(Object.keys(a).length>0)return this._internalUpdate=!0,t.jumpTo(a),this._internalUpdate=!1,!0}return!1}_updateSettings(e,t){const r=this._map;let s=!1;for(const a of HB)a in e&&!Sn(e[a],t[a])&&(s=!0,r[`set${a[0].toUpperCase()}${a.slice(1)}`]?.call(r,e[a]));return s}_updateStyle(e,t){if(e.cursor!==t.cursor&&(this._map.getCanvas().style.cursor=e.cursor||""),e.mapStyle!==t.mapStyle){const{mapStyle:r=H0,styleDiffing:s=!0}=e,a={diff:s};"localIdeographFontFamily"in e&&(a.localIdeographFontFamily=e.localIdeographFontFamily),this._map.setStyle(W0(r),a)}}_updateStyleComponents({light:e,projection:t,sky:r,terrain:s}){const a=this._map,u=this._styleComponents;a.style._loaded&&(e&&!Sn(e,u.light)&&(u.light=e,a.setLight(e)),t&&!Sn(t,u.projection)&&t!==u.projection?.type&&(u.projection=typeof t=="string"?{type:t}:t,a.setProjection?.(u.projection)),r&&!Sn(r,u.sky)&&(u.sky=r,a.setSky(r)),s!==void 0&&!Sn(s,u.terrain)&&(!s||a.getSource(s.source))&&(u.terrain=s,a.setTerrain(s)))}_updateHandlers(e,t){const r=this._map;for(const s of qB){const a=e[s]??!0,u=t[s]??!0;Sn(a,u)||(a?r[s].enable(a):r[s].disable())}}_queryRenderedFeatures(e){const t=this._map,{interactiveLayerIds:r=[]}=this.props;try{return t.queryRenderedFeatures(e,{layers:r.filter(t.getLayer.bind(t))})}catch{return[]}}_updateHover(e){const{props:t}=this;if(t.interactiveLayerIds&&(t.onMouseMove||t.onMouseEnter||t.onMouseLeave)){const s=e.type,a=this._hoveredFeatures?.length>0,u=this._queryRenderedFeatures(e.point),l=u.length>0;!l&&a&&(e.type="mouseleave",this._onPointerEvent(e)),this._hoveredFeatures=u,l&&!a&&(e.type="mouseenter",this._onPointerEvent(e)),e.type=s}else this._hoveredFeatures=null}}Cc.savedMaps=[];const XB=["setMaxBounds","setMinZoom","setMaxZoom","setMinPitch","setMaxPitch","setRenderWorldCopies","setProjection","setStyle","addSource","removeSource","addLayer","removeLayer","setLayerZoomRange","setFilter","setPaintProperty","setLayoutProperty","setLight","setTerrain","setFog","remove"];function ZB(i){if(!i)return null;const e=i.map,t={getMap:()=>e};for(const r of YB(e))!(r in t)&&!XB.includes(r)&&(t[r]=e[r].bind(e));return t}function YB(i){const e=new Set;let t=i;for(;t;){for(const r of Object.getOwnPropertyNames(t))r[0]!=="_"&&typeof i[r]=="function"&&r!=="fire"&&r!=="setEventedParent"&&e.add(r);t=Object.getPrototypeOf(t)}return Array.from(e)}const GB=typeof document<"u"?je.useLayoutEffect:je.useEffect;function KB(i,e){const{RTLTextPlugin:t,maxParallelImageRequests:r,workerCount:s,workerUrl:a}=e;if(t&&i.getRTLTextPluginStatus&&i.getRTLTextPluginStatus()==="unavailable"){const{pluginUrl:u,lazy:l=!0}=typeof t=="string"?{pluginUrl:t}:t;i.setRTLTextPlugin(u,g=>{g&&console.error(g)},l)}r!==void 0&&i.setMaxParallelImageRequests(r),s!==void 0&&i.setWorkerCount(s),a!==void 0&&i.setWorkerUrl(a)}const Ap=je.createContext(null);function JB(i,e){const t=je.useContext(jB),[r,s]=je.useState(null),a=je.useRef(),{current:u}=je.useRef({mapLib:null,map:null});je.useEffect(()=>{const v=i.mapLib;let T=!0,S;return Promise.resolve(v||Um(()=>Promise.resolve().then(()=>X5),void 0)).then(P=>{if(!T)return;if(!P)throw new Error("Invalid mapLib");const O="Map"in P?P:P.default;if(!O.Map)throw new Error("Invalid mapLib");KB(O,i),i.reuseMaps&&(S=Cc.reuse(i,a.current)),S||(S=new Cc(O.Map,i,a.current)),u.map=ZB(S),u.mapLib=O,s(S),t?.onMapMount(u.map,i.id)}).catch(P=>{const{onError:O}=i;O?O({type:"error",target:null,originalEvent:null,error:P}):console.error(P)}),()=>{T=!1,S&&(t?.onMapUnmount(i.id),i.reuseMaps?S.recycle():S.destroy())}},[]),GB(()=>{r&&r.setProps(i)}),je.useImperativeHandle(e,()=>u.map,[r]);const l=je.useMemo(()=>({position:"relative",width:"100%",height:"100%",...i.style}),[i.style]),g={height:"100%"};return je.createElement("div",{id:i.id,ref:a,style:l},r&&je.createElement(Ap.Provider,{value:u},je.createElement("div",{"mapboxgl-children":"",style:g},i.children)))}const QB=je.forwardRef(JB),eN=/box|flex|grid|column|lineHeight|fontWeight|opacity|order|tabSize|zIndex/;function so(i,e){if(!i||!e)return;const t=i.style;for(const r in e){const s=e[r];Number.isFinite(s)&&!eN.test(r)?t[r]=`${s}px`:t[r]=s}}function TT(i,e){if(i===e)return null;const t=Y0(i),r=Y0(e),s=[];for(const a of r)t.has(a)||s.push(a);for(const a of t)r.has(a)||s.push(a);return s.length===0?null:s}function Y0(i){return new Set(i?i.trim().split(/\s+/):[])}je.memo(je.forwardRef((i,e)=>{const{map:t,mapLib:r}=je.useContext(Ap),s=je.useRef({props:i}),a=je.useMemo(()=>{let Q=!1;je.Children.forEach(i.children,me=>{me&&(Q=!0)});const ae={...i,element:Q?document.createElement("div"):void 0},te=new r.Marker(ae);return te.setLngLat([i.longitude,i.latitude]),te.getElement().addEventListener("click",me=>{s.current.props.onClick?.({type:"click",target:te,originalEvent:me})}),te.on("dragstart",me=>{const we=me;we.lngLat=a.getLngLat(),s.current.props.onDragStart?.(we)}),te.on("drag",me=>{const we=me;we.lngLat=a.getLngLat(),s.current.props.onDrag?.(we)}),te.on("dragend",me=>{const we=me;we.lngLat=a.getLngLat(),s.current.props.onDragEnd?.(we)}),te},[]);je.useEffect(()=>(a.addTo(t.getMap()),()=>{a.remove()}),[]);const{longitude:u,latitude:l,offset:g,style:v,draggable:T=!1,popup:S=null,rotation:P=0,rotationAlignment:O="auto",pitchAlignment:$="auto"}=i;je.useEffect(()=>{so(a.getElement(),v)},[v]),je.useImperativeHandle(e,()=>a,[]);const W=s.current.props;(a.getLngLat().lng!==u||a.getLngLat().lat!==l)&&a.setLngLat([u,l]),g&&!$B(a.getOffset(),g)&&a.setOffset(g),a.isDraggable()!==T&&a.setDraggable(T),a.getRotation()!==P&&a.setRotation(P),a.getRotationAlignment()!==O&&a.setRotationAlignment(O),a.getPitchAlignment()!==$&&a.setPitchAlignment($),a.getPopup()!==S&&a.setPopup(S);const G=TT(W.className,i.className);if(G)for(const Q of G)a.toggleClassName(Q);return s.current.props=i,Jw.createPortal(i.children,a.getElement())}));const tN=je.memo(je.forwardRef((i,e)=>{const{map:t,mapLib:r}=je.useContext(Ap),s=je.useMemo(()=>document.createElement("div"),[]),a=je.useRef({props:i}),u=je.useMemo(()=>{const l={...i},g=new r.Popup(l);return g.setLngLat([i.longitude,i.latitude]),g.once("open",v=>{a.current.props.onOpen?.(v)}),g},[]);if(je.useEffect(()=>{const l=g=>{a.current.props.onClose?.(g)};return u.on("close",l),u.setDOMContent(s).addTo(t.getMap()),()=>{u.off("close",l),u.isOpen()&&u.remove()}},[]),je.useEffect(()=>{so(u.getElement(),i.style)},[i.style]),je.useImperativeHandle(e,()=>u,[]),u.isOpen()){const l=a.current.props;(u.getLngLat().lng!==i.longitude||u.getLngLat().lat!==i.latitude)&&u.setLngLat([i.longitude,i.latitude]),i.offset&&!Sn(l.offset,i.offset)&&u.setOffset(i.offset),(l.anchor!==i.anchor||l.maxWidth!==i.maxWidth)&&(u.options.anchor=i.anchor,u.setMaxWidth(i.maxWidth));const g=TT(l.className,i.className);if(g)for(const v of g)u.toggleClassName(v);a.current.props=i}return Jw.createPortal(i.children,s)}));function tl(i,e,t,r){const s=je.useContext(Ap),a=je.useMemo(()=>i(s),[]);return je.useEffect(()=>{const u=e,l=null,g=typeof e=="function"?e:null,{map:v}=s;return v.hasControl(a)||(v.addControl(a,u?.position),l&&l(s)),()=>{g&&g(s),v.hasControl(a)&&v.removeControl(a)}},[]),a}function iN(i){const e=tl(({mapLib:t})=>new t.AttributionControl(i),{position:i.position});return je.useEffect(()=>{so(e._container,i.style)},[i.style]),null}je.memo(iN);function rN(i){const e=tl(({mapLib:t})=>new t.FullscreenControl({container:i.containerId&&document.getElementById(i.containerId)}),{position:i.position});return je.useEffect(()=>{so(e._controlContainer,i.style)},[i.style]),null}je.memo(rN);function sN(i,e){const t=je.useRef({props:i}),r=tl(({mapLib:s})=>{const a=new s.GeolocateControl(i),u=a._setupUI;return a._setupUI=()=>{a._container.hasChildNodes()||u()},a.on("geolocate",l=>{t.current.props.onGeolocate?.(l)}),a.on("error",l=>{t.current.props.onError?.(l)}),a.on("outofmaxbounds",l=>{t.current.props.onOutOfMaxBounds?.(l)}),a.on("trackuserlocationstart",l=>{t.current.props.onTrackUserLocationStart?.(l)}),a.on("trackuserlocationend",l=>{t.current.props.onTrackUserLocationEnd?.(l)}),a},{position:i.position});return t.current.props=i,je.useImperativeHandle(e,()=>r,[]),je.useEffect(()=>{so(r._container,i.style)},[i.style]),null}je.memo(je.forwardRef(sN));function nN(i){const e=tl(({mapLib:t})=>new t.NavigationControl(i),{position:i.position});return je.useEffect(()=>{so(e._container,i.style)},[i.style]),null}je.memo(nN);function oN(i){const e=tl(({mapLib:a})=>new a.ScaleControl(i),{position:i.position}),t=je.useRef(i),r=t.current;t.current=i;const{style:s}=i;return i.maxWidth!==void 0&&i.maxWidth!==r.maxWidth&&(e.options.maxWidth=i.maxWidth),i.unit!==void 0&&i.unit!==r.unit&&e.setUnit(i.unit),je.useEffect(()=>{so(e._container,s)},[s]),null}je.memo(oN);function aN(i){const e=tl(({mapLib:t})=>new t.TerrainControl(i),{position:i.position});return je.useEffect(()=>{so(e._container,i.style)},[i.style]),null}je.memo(aN);function lN(i){const e=tl(({mapLib:t})=>new t.LogoControl(i),{position:i.position});return je.useEffect(()=>{so(e._container,i.style)},[i.style]),null}je.memo(lN);const cN=i=>{je.useEffect(()=>{if(typeof window>"u")return;let e=null,t=0;const r=10,s=u=>{if(!u||u==="none")return!0;const l=u.match(/^matrix\(([^)]+)\)$/);if(l){const v=l[1].split(",").map(T=>Number.parseFloat(T.trim()));if(v.length===6){const[T,S,P,O,$,W]=v;return Math.abs(T-1)<.001&&Math.abs(O-1)<.001&&Math.abs(S)<.001&&Math.abs(P)<.001&&Math.abs($)<.001&&Math.abs(W)<.001}}const g=u.match(/^matrix3d\(([^)]+)\)$/);if(g){const v=g[1].split(",").map(T=>Number.parseFloat(T.trim()));if(v.length===16){const T=(P,O)=>Math.abs(v[P]-O)<.001,S=P=>Math.abs(v[P])<.001;return T(0,1)&&T(5,1)&&T(10,1)&&T(15,1)&&[1,2,3,4,6,7,8,9,11,12,13,14].every(S)}}return!1},a=()=>{const u=i.current?.deck?.getCanvas?.();if(!u){t+=1,t<r&&(e=window.requestAnimationFrame(a));return}u.style.pointerEvents="auto",u.style.touchAction="none",u.style.zIndex="1",u.style.position||(u.style.position="absolute");const l=u.parentElement;l&&(l.style.pointerEvents="auto");let g=u;for(;g;){const v=window.getComputedStyle(g);if(v.pointerEvents==="none"){console.warn("[MiniMap] pointer-events: none on DeckGL ancestor may block picking.",g);break}if(!s(v.transform)){console.warn("[MiniMap] CSS transform on DeckGL ancestor can offset picking.",g);break}g=g.parentElement}};return a(),()=>{e!==null&&window.cancelAnimationFrame(e)}},[])},G0=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array],Im=1,qu=8;class My{static from(e){if(!(e instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[t,r]=new Uint8Array(e,0,2);if(t!==219)throw new Error("Data does not appear to be in a KDBush format.");const s=r>>4;if(s!==Im)throw new Error(`Got v${s} data when expected v${Im}.`);const a=G0[r&15];if(!a)throw new Error("Unrecognized array type.");const[u]=new Uint16Array(e,2,1),[l]=new Uint32Array(e,4,1);return new My(l,u,a,e)}constructor(e,t=64,r=Float64Array,s){if(isNaN(e)||e<0)throw new Error(`Unpexpected numItems value: ${e}.`);this.numItems=+e,this.nodeSize=Math.min(Math.max(+t,2),65535),this.ArrayType=r,this.IndexArrayType=e<65536?Uint16Array:Uint32Array;const a=G0.indexOf(this.ArrayType),u=e*2*this.ArrayType.BYTES_PER_ELEMENT,l=e*this.IndexArrayType.BYTES_PER_ELEMENT,g=(8-l%8)%8;if(a<0)throw new Error(`Unexpected typed array class: ${r}.`);s&&s instanceof ArrayBuffer?(this.data=s,this.ids=new this.IndexArrayType(this.data,qu,e),this.coords=new this.ArrayType(this.data,qu+l+g,e*2),this._pos=e*2,this._finished=!0):(this.data=new ArrayBuffer(qu+u+l+g),this.ids=new this.IndexArrayType(this.data,qu,e),this.coords=new this.ArrayType(this.data,qu+l+g,e*2),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,(Im<<4)+a]),new Uint16Array(this.data,2,1)[0]=t,new Uint32Array(this.data,4,1)[0]=e)}add(e,t){const r=this._pos>>1;return this.ids[r]=r,this.coords[this._pos++]=e,this.coords[this._pos++]=t,r}finish(){const e=this._pos>>1;if(e!==this.numItems)throw new Error(`Added ${e} items when expected ${this.numItems}.`);return w_(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(e,t,r,s){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:a,coords:u,nodeSize:l}=this,g=[0,a.length-1,0],v=[];for(;g.length;){const T=g.pop()||0,S=g.pop()||0,P=g.pop()||0;if(S-P<=l){for(let G=P;G<=S;G++){const Q=u[2*G],ae=u[2*G+1];Q>=e&&Q<=r&&ae>=t&&ae<=s&&v.push(a[G])}continue}const O=P+S>>1,$=u[2*O],W=u[2*O+1];$>=e&&$<=r&&W>=t&&W<=s&&v.push(a[O]),(T===0?e<=$:t<=W)&&(g.push(P),g.push(O-1),g.push(1-T)),(T===0?r>=$:s>=W)&&(g.push(O+1),g.push(S),g.push(1-T))}return v}within(e,t,r){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:s,coords:a,nodeSize:u}=this,l=[0,s.length-1,0],g=[],v=r*r;for(;l.length;){const T=l.pop()||0,S=l.pop()||0,P=l.pop()||0;if(S-P<=u){for(let G=P;G<=S;G++)K0(a[2*G],a[2*G+1],e,t)<=v&&g.push(s[G]);continue}const O=P+S>>1,$=a[2*O],W=a[2*O+1];K0($,W,e,t)<=v&&g.push(s[O]),(T===0?e-r<=$:t-r<=W)&&(l.push(P),l.push(O-1),l.push(1-T)),(T===0?e+r>=$:t+r>=W)&&(l.push(O+1),l.push(S),l.push(1-T))}return g}}function w_(i,e,t,r,s,a){if(s-r<=t)return;const u=r+s>>1;ST(i,e,u,r,s,a),w_(i,e,t,r,u-1,1-a),w_(i,e,t,u+1,s,1-a)}function ST(i,e,t,r,s,a){for(;s>r;){if(s-r>600){const v=s-r+1,T=t-r+1,S=Math.log(v),P=.5*Math.exp(2*S/3),O=.5*Math.sqrt(S*P*(v-P)/v)*(T-v/2<0?-1:1),$=Math.max(r,Math.floor(t-T*P/v+O)),W=Math.min(s,Math.floor(t+(v-T)*P/v+O));ST(i,e,t,$,W,a)}const u=e[2*t+a];let l=r,g=s;for(Xu(i,e,r,t),e[2*s+a]>u&&Xu(i,e,r,s);l<g;){for(Xu(i,e,l,g),l++,g--;e[2*l+a]<u;)l++;for(;e[2*g+a]>u;)g--}e[2*r+a]===u?Xu(i,e,r,g):(g++,Xu(i,e,g,s)),g<=t&&(r=g+1),t<=g&&(s=g-1)}}function Xu(i,e,t,r){Cm(i,t,r),Cm(e,2*t,2*r),Cm(e,2*t+1,2*r+1)}function Cm(i,e,t){const r=i[e];i[e]=i[t],i[t]=r}function K0(i,e,t,r){const s=i-t,a=e-r;return s*s+a*a}const uN={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:i=>i},J0=Math.fround||(i=>(e=>(i[0]=+e,i[0])))(new Float32Array(1)),Da=2,qo=3,Pm=4,Wo=5,AT=6;class hN{constructor(e){this.options=Object.assign(Object.create(uN),e),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(e){const{log:t,minZoom:r,maxZoom:s}=this.options;t&&console.time("total time");const a=`prepare ${e.length} points`;t&&console.time(a),this.points=e;const u=[];for(let g=0;g<e.length;g++){const v=e[g];if(!v.geometry)continue;const[T,S]=v.geometry.coordinates,P=J0(ff(T)),O=J0(pf(S));u.push(P,O,1/0,g,-1,1),this.options.reduce&&u.push(0)}let l=this.trees[s+1]=this._createTree(u);t&&console.timeEnd(a);for(let g=s;g>=r;g--){const v=+Date.now();l=this.trees[g]=this._createTree(this._cluster(l,g)),t&&console.log("z%d: %d clusters in %dms",g,l.numItems,+Date.now()-v)}return t&&console.timeEnd("total time"),this}getClusters(e,t){let r=((e[0]+180)%360+360)%360-180;const s=Math.max(-90,Math.min(90,e[1]));let a=e[2]===180?180:((e[2]+180)%360+360)%360-180;const u=Math.max(-90,Math.min(90,e[3]));if(e[2]-e[0]>=360)r=-180,a=180;else if(r>a){const S=this.getClusters([r,s,180,u],t),P=this.getClusters([-180,s,a,u],t);return S.concat(P)}const l=this.trees[this._limitZoom(t)],g=l.range(ff(r),pf(u),ff(a),pf(s)),v=l.data,T=[];for(const S of g){const P=this.stride*S;T.push(v[P+Wo]>1?Q0(v,P,this.clusterProps):this.points[v[P+qo]])}return T}getChildren(e){const t=this._getOriginId(e),r=this._getOriginZoom(e),s="No cluster with the specified id.",a=this.trees[r];if(!a)throw new Error(s);const u=a.data;if(t*this.stride>=u.length)throw new Error(s);const l=this.options.radius/(this.options.extent*Math.pow(2,r-1)),g=u[t*this.stride],v=u[t*this.stride+1],T=a.within(g,v,l),S=[];for(const P of T){const O=P*this.stride;u[O+Pm]===e&&S.push(u[O+Wo]>1?Q0(u,O,this.clusterProps):this.points[u[O+qo]])}if(S.length===0)throw new Error(s);return S}getLeaves(e,t,r){t=t||10,r=r||0;const s=[];return this._appendLeaves(s,e,t,r,0),s}getTile(e,t,r){const s=this.trees[this._limitZoom(e)],a=Math.pow(2,e),{extent:u,radius:l}=this.options,g=l/u,v=(r-g)/a,T=(r+1+g)/a,S={features:[]};return this._addTileFeatures(s.range((t-g)/a,v,(t+1+g)/a,T),s.data,t,r,a,S),t===0&&this._addTileFeatures(s.range(1-g/a,v,1,T),s.data,a,r,a,S),t===a-1&&this._addTileFeatures(s.range(0,v,g/a,T),s.data,-1,r,a,S),S.features.length?S:null}getClusterExpansionZoom(e){let t=this._getOriginZoom(e)-1;for(;t<=this.options.maxZoom;){const r=this.getChildren(e);if(t++,r.length!==1)break;e=r[0].properties.cluster_id}return t}_appendLeaves(e,t,r,s,a){const u=this.getChildren(t);for(const l of u){const g=l.properties;if(g&&g.cluster?a+g.point_count<=s?a+=g.point_count:a=this._appendLeaves(e,g.cluster_id,r,s,a):a<s?a++:e.push(l),e.length===r)break}return a}_createTree(e){const t=new My(e.length/this.stride|0,this.options.nodeSize,Float32Array);for(let r=0;r<e.length;r+=this.stride)t.add(e[r],e[r+1]);return t.finish(),t.data=e,t}_addTileFeatures(e,t,r,s,a,u){for(const l of e){const g=l*this.stride,v=t[g+Wo]>1;let T,S,P;if(v)T=ET(t,g,this.clusterProps),S=t[g],P=t[g+1];else{const W=this.points[t[g+qo]];T=W.properties;const[G,Q]=W.geometry.coordinates;S=ff(G),P=pf(Q)}const O={type:1,geometry:[[Math.round(this.options.extent*(S*a-r)),Math.round(this.options.extent*(P*a-s))]],tags:T};let $;v||this.options.generateId?$=t[g+qo]:$=this.points[t[g+qo]].id,$!==void 0&&(O.id=$),u.features.push(O)}}_limitZoom(e){return Math.max(this.options.minZoom,Math.min(Math.floor(+e),this.options.maxZoom+1))}_cluster(e,t){const{radius:r,extent:s,reduce:a,minPoints:u}=this.options,l=r/(s*Math.pow(2,t)),g=e.data,v=[],T=this.stride;for(let S=0;S<g.length;S+=T){if(g[S+Da]<=t)continue;g[S+Da]=t;const P=g[S],O=g[S+1],$=e.within(g[S],g[S+1],l),W=g[S+Wo];let G=W;for(const Q of $){const ae=Q*T;g[ae+Da]>t&&(G+=g[ae+Wo])}if(G>W&&G>=u){let Q=P*W,ae=O*W,te,me=-1;const we=((S/T|0)<<5)+(t+1)+this.points.length;for(const Oe of $){const Je=Oe*T;if(g[Je+Da]<=t)continue;g[Je+Da]=t;const it=g[Je+Wo];Q+=g[Je]*it,ae+=g[Je+1]*it,g[Je+Pm]=we,a&&(te||(te=this._map(g,S,!0),me=this.clusterProps.length,this.clusterProps.push(te)),a(te,this._map(g,Je)))}g[S+Pm]=we,v.push(Q/G,ae/G,1/0,we,-1,G),a&&v.push(me)}else{for(let Q=0;Q<T;Q++)v.push(g[S+Q]);if(G>1)for(const Q of $){const ae=Q*T;if(!(g[ae+Da]<=t)){g[ae+Da]=t;for(let te=0;te<T;te++)v.push(g[ae+te])}}}}return v}_getOriginId(e){return e-this.points.length>>5}_getOriginZoom(e){return(e-this.points.length)%32}_map(e,t,r){if(e[t+Wo]>1){const u=this.clusterProps[e[t+AT]];return r?Object.assign({},u):u}const s=this.points[e[t+qo]].properties,a=this.options.map(s);return r&&a===s?Object.assign({},a):a}}function Q0(i,e,t){return{type:"Feature",id:i[e+qo],properties:ET(i,e,t),geometry:{type:"Point",coordinates:[dN(i[e]),fN(i[e+1])]}}}function ET(i,e,t){const r=i[e+Wo],s=r>=1e4?`${Math.round(r/1e3)}k`:r>=1e3?`${Math.round(r/100)/10}k`:r,a=i[e+AT],u=a===-1?{}:Object.assign({},t[a]);return Object.assign(u,{cluster:!0,cluster_id:i[e+qo],point_count:r,point_count_abbreviated:s})}function ff(i){return i/360+.5}function pf(i){const e=Math.sin(i*Math.PI/180),t=.5-.25*Math.log((1+e)/(1-e))/Math.PI;return t<0?0:t>1?1:t}function dN(i){return(i-.5)*360}function fN(i){const e=(180-i*360)*Math.PI/180;return 360*Math.atan(Math.exp(e))/Math.PI-90}const pN=`<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
  <g transform="translate(1,0)">
    <!-- Toit plus large et arrondi -->
    <polygon points="0,8 9,1 18,8" />

    <!-- Corps de la maison -->
    <rect x="3" y="8" width="12" height="10" rx="2" />

    <!-- Porte centre -->
    <rect x="8" y="12" width="4" height="6" rx="1" />
  </g>
</svg>
`,gN=`<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
  <g transform="translate(0,3)">
    <polygon points="0,14 8,0 12,6 16,2 20,14" />
  </g>
</svg>
`,mN=`<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
  <!-- Contour de l'il (profil trs ouvert) -->
  <path d="M3,4
           Q11,1 18,10
           Q11,19 3,16
           Q7,10 3,4 Z"
        fill="none" stroke="black" stroke-width="2" stroke-linecap="round" />

  <!-- Iris (verticale) -->
  <ellipse cx="7" cy="10" rx="2" ry="5" fill="black" />

  <!-- Reflet -->
  <ellipse cx="6.5" cy="8" rx="0.7" ry="1.4" fill="white" />
</svg>
`,_N="https://data.geopf.fr/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=GEOGRAPHICALGRIDSYSTEMS.PLANIGNV2&STYLE=normal&FORMAT=image/png&TILEMATRIXSET=PM&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}",yN="https://data.geopf.fr/private/wmts?apikey=ign_scan_ws&SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=GEOGRAPHICALGRIDSYSTEMS.MAPS.SCAN25TOUR&STYLE=normal&TILEMATRIXSET=PM_6_16&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&FORMAT=image/jpeg",ew="https://cloudflare-worker.ncsdecoopman.workers.dev",xN="https://tiles.openfreemap.org/styles/liberty",vN="https://tiles.openstreetmap.us/raster/hillshade/{z}/{x}/{y}.jpg",bN="Hillshade  Mapbox",wN="https://data.geopf.fr/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=GEOGRAPHICALGRIDSYSTEMS.SLOPES.MOUNTAIN&STYLE=normal&TILEMATRIXSET=PM&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&FORMAT=image/png",IT=" IGN  Cartes de pentes montagne (RGE ALTI)",TN="https://tiles.opensnowmap.org/pistes/{z}/{x}/{y}.png",CT=" OpenStreetMap contributors (ODbL) | OpenSnowMap (CC-BY-SA)",gh=11,PT={test:{id:"test",name:"Base",toggleLabel:"Base",type:"vector",url:"",styleUrl:xN,attributionLabel:"OpenFreeMap  OpenMapTiles Data from OpenStreetMap",minZoom:5,maxZoom:22,overlayUrl:vN,overlayOpacity:1,overlayAttributionLabel:bN,overlayMaxZoom:12,overlayMode:"map",showPeaks:!0,peaksMinZoom:10},ign:{id:"ign",name:"Plan IGN",toggleLabel:"IGN",url:_N,attributionLabel:" Goplateforme",minZoom:5,maxZoom:22,type:"raster"},scan25tour:{id:"scan25tour",name:"Topographie IGN",toggleLabel:"Topo",url:yN,attributionLabel:" IGN - SCAN25 Tour",minZoom:6,maxZoom:16,type:"raster"}},za=96,gf=za/2,SN=i=>i.trim().replace(/<svg\b([^>]*)>/i,(t,r)=>`<svg${String(r).replace(/\s(width|height)="[^"]*"/gi,"")} width="${za}" height="${za}">`),zf=i=>`data:image/svg+xml;charset=utf-8,${encodeURIComponent(SN(i))}`,AN={station:zf(pN),condition:zf(gN),webcam:zf(mN)},EN="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTI4IiBoZWlnaHQ9IjEyOCIgdmlld0JveD0iMCAwIDEyOCAxMjgiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGRlZnM+PGZpbHRlciBpZD0iZjEiIHg9Ii0yMCUiIHk9Ii0yMCUiIHdpZHRoPSIxNDAlIiBoZWlnaHQ9IjE0MCUiPjxmZUdhdXNzaWFuQmx1ciBpbj0iU291cmNlQWxwaGEiIHN0ZERldmlhdGlvbj0iNCIvPjxmZU9mZnNldCBkeD0iMCIgZHk9IjQiIHJlc3VsdD0ib2Zmc2V0Ymx1ciIvPjxmZUNvbXBvbmVudFRyYW5zZmVyPjxmZUZ1bmNBIHR5cGU9ImxpbmVhciIgc2xvcGU9IjAuMyIvPjwvZmVDb21wb25lbnRUcmFuc2Zlcj48ZmVNZXJnZT48ZmVNZXJnZU5vZGUvPjxmZU1lcmdlTm9kZSBpbj0iU291cmNlR3JhcGhpYyIvPjwvZmVNZXJnZT48L2ZpbHRlcj48L2RlZnM+PHJlY3QgeD0iOCIgeT0iOCIgd2lkdGg9IjExMiIgaGVpZ2h0PSIxMTIiIHJ4PSIyMCIgZmlsbD0id2hpdGUiIHN0cm9rZT0iIzBmMTcyYSIgc3Ryb2tlLXdpZHRoPSI4IiBmaWx0ZXI9InVybCgjZjEpIi8+PC9zdmc+",IN="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTI4IiBoZWlnaHQ9IjEyOCIgdmlld0JveD0iMCAwIDEyOCAxMjgiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iNjQiIGN5PSI2NCIgcj0iNjAiIGZpbGw9IiMwZjE3MmEiIHN0cm9rZT0id2hpdGUiIHN0cm9rZS13aWR0aD0iOCIgLz48L3N2Zz4=",CN=zf('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><rect width="128" height="128" fill="white"/></svg>'),PN=57,MN=72,RN=({stations:i,conditions:e,webcams:t,viewState:r})=>{const s=je.useMemo(()=>{const u=new hN({radius:70,maxZoom:17,map:g=>{const v=g.kind==="condition"&&g.data?.entries?.length||1;return{[g.kind]:v}},reduce:(g,v)=>{g.station=(g.station||0)+(v.station||0),g.condition=(g.condition||0)+(v.condition||0),g.webcam=(g.webcam||0)+(v.webcam||0)}}),l=[...i.map(g=>({type:"Feature",properties:{kind:"station",data:g},geometry:{type:"Point",coordinates:[g.lon,g.lat]}})),...e.map(g=>({type:"Feature",properties:{kind:"condition",data:g},geometry:{type:"Point",coordinates:[g.lon,g.lat]}})),...t.map(g=>({type:"Feature",properties:{kind:"webcam",data:g},geometry:{type:"Point",coordinates:[g.lon,g.lat]}}))];return u.load(l),u},[i,e,t]);return{clusters:je.useMemo(()=>{const u=[-180,-85,180,85],l=Math.floor(r.zoom||gh),g=s.getClusters(u,l),v=[];return g.forEach(T=>{if(!T.properties.cluster){v.push(T);return}const S=[];T.properties.station&&S.push("station"),T.properties.condition&&S.push("condition"),T.properties.webcam&&S.push("webcam");const P=S.length*31+(S.length-1)*10;S.forEach((O,$)=>{const W=-P/2+$*41+15.5;v.push({...T,id:`${T.id}-${O}`,properties:{...T.properties,kind:O,count:T.properties[O],xOffset:W}})})}),v},[s,r.zoom]),clusterIndex:s}},kN=new Uint32Array([0,2,1,0,3,2]),DN=new Float32Array([0,1,0,0,1,0,1,1]);function ON(i,e){if(!e)return LN(i);const t=Math.max(Math.abs(i[0][0]-i[3][0]),Math.abs(i[1][0]-i[2][0])),r=Math.max(Math.abs(i[1][1]-i[0][1]),Math.abs(i[2][1]-i[3][1])),s=Math.ceil(t/e)+1,a=Math.ceil(r/e)+1,u=(s-1)*(a-1)*6,l=new Uint32Array(u),g=new Float32Array(s*a*2),v=new Float64Array(s*a*3);let T=0,S=0;for(let P=0;P<s;P++){const O=P/(s-1);for(let $=0;$<a;$++){const W=$/(a-1),G=FN(i,O,W);v[T*3+0]=G[0],v[T*3+1]=G[1],v[T*3+2]=G[2]||0,g[T*2+0]=O,g[T*2+1]=1-W,P>0&&$>0&&(l[S++]=T-a,l[S++]=T-a-1,l[S++]=T-1,l[S++]=T-a,l[S++]=T-1,l[S++]=T),T++}}return{vertexCount:u,positions:v,indices:l,texCoords:g}}function LN(i){const e=new Float64Array(12);for(let t=0;t<i.length;t++)e[t*3+0]=i[t][0],e[t*3+1]=i[t][1],e[t*3+2]=i[t][2]||0;return{vertexCount:6,positions:e,indices:kN,texCoords:DN}}function FN(i,e,t){return ja(ja(i[0],i[1],t),ja(i[3],i[2],t),e)}const tw=`uniform bitmapUniforms {
  vec4 bounds;
  float coordinateConversion;
  float desaturate;
  vec3 tintColor;
  vec4 transparentColor;
} bitmap;
`,BN={name:"bitmap",vs:tw,fs:tw,uniformTypes:{bounds:"vec4<f32>",coordinateConversion:"f32",desaturate:"f32",tintColor:"vec3<f32>",transparentColor:"vec4<f32>"}},NN=`#version 300 es
#define SHADER_NAME bitmap-layer-vertex-shader

in vec2 texCoords;
in vec3 positions;
in vec3 positions64Low;

out vec2 vTexCoord;
out vec2 vTexPos;

const vec3 pickingColor = vec3(1.0, 0.0, 0.0);

void main(void) {
  geometry.worldPosition = positions;
  geometry.uv = texCoords;
  geometry.pickingColor = pickingColor;

  gl_Position = project_position_to_clipspace(positions, positions64Low, vec3(0.0), geometry.position);
  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);

  vTexCoord = texCoords;

  if (bitmap.coordinateConversion < -0.5) {
    vTexPos = geometry.position.xy + project.commonOrigin.xy;
  } else if (bitmap.coordinateConversion > 0.5) {
    vTexPos = geometry.worldPosition.xy;
  }

  vec4 color = vec4(0.0);
  DECKGL_FILTER_COLOR(color, geometry);
}
`,zN=`
vec3 packUVsIntoRGB(vec2 uv) {
  // Extract the top 8 bits. We want values to be truncated down so we can add a fraction
  vec2 uv8bit = floor(uv * 256.);

  // Calculate the normalized remainders of u and v parts that do not fit into 8 bits
  // Scale and clamp to 0-1 range
  vec2 uvFraction = fract(uv * 256.);
  vec2 uvFraction4bit = floor(uvFraction * 16.);

  // Remainder can be encoded in blue channel, encode as 4 bits for pixel coordinates
  float fractions = uvFraction4bit.x + uvFraction4bit.y * 16.;

  return vec3(uv8bit, fractions) / 255.;
}
`,UN=`#version 300 es
#define SHADER_NAME bitmap-layer-fragment-shader

#ifdef GL_ES
precision highp float;
#endif

uniform sampler2D bitmapTexture;

in vec2 vTexCoord;
in vec2 vTexPos;

out vec4 fragColor;

/* projection utils */
const float TILE_SIZE = 512.0;
const float PI = 3.1415926536;
const float WORLD_SCALE = TILE_SIZE / PI / 2.0;

// from degrees to Web Mercator
vec2 lnglat_to_mercator(vec2 lnglat) {
  float x = lnglat.x;
  float y = clamp(lnglat.y, -89.9, 89.9);
  return vec2(
    radians(x) + PI,
    PI + log(tan(PI * 0.25 + radians(y) * 0.5))
  ) * WORLD_SCALE;
}

// from Web Mercator to degrees
vec2 mercator_to_lnglat(vec2 xy) {
  xy /= WORLD_SCALE;
  return degrees(vec2(
    xy.x - PI,
    atan(exp(xy.y - PI)) * 2.0 - PI * 0.5
  ));
}
/* End projection utils */

// apply desaturation
vec3 color_desaturate(vec3 color) {
  float luminance = (color.r + color.g + color.b) * 0.333333333;
  return mix(color, vec3(luminance), bitmap.desaturate);
}

// apply tint
vec3 color_tint(vec3 color) {
  return color * bitmap.tintColor;
}

// blend with background color
vec4 apply_opacity(vec3 color, float alpha) {
  if (bitmap.transparentColor.a == 0.0) {
    return vec4(color, alpha);
  }
  float blendedAlpha = alpha + bitmap.transparentColor.a * (1.0 - alpha);
  float highLightRatio = alpha / blendedAlpha;
  vec3 blendedRGB = mix(bitmap.transparentColor.rgb, color, highLightRatio);
  return vec4(blendedRGB, blendedAlpha);
}

vec2 getUV(vec2 pos) {
  return vec2(
    (pos.x - bitmap.bounds[0]) / (bitmap.bounds[2] - bitmap.bounds[0]),
    (pos.y - bitmap.bounds[3]) / (bitmap.bounds[1] - bitmap.bounds[3])
  );
}

${zN}

void main(void) {
  vec2 uv = vTexCoord;
  if (bitmap.coordinateConversion < -0.5) {
    vec2 lnglat = mercator_to_lnglat(vTexPos);
    uv = getUV(lnglat);
  } else if (bitmap.coordinateConversion > 0.5) {
    vec2 commonPos = lnglat_to_mercator(vTexPos);
    uv = getUV(commonPos);
  }
  vec4 bitmapColor = texture(bitmapTexture, uv);

  fragColor = apply_opacity(color_tint(color_desaturate(bitmapColor.rgb)), bitmapColor.a * layer.opacity);

  geometry.uv = uv;
  DECKGL_FILTER_COLOR(fragColor, geometry);

  if (bool(picking.isActive) && !bool(picking.isAttribute)) {
    // Since instance information is not used, we can use picking color for pixel index
    fragColor.rgb = packUVsIntoRGB(uv);
  }
}
`,VN={image:{type:"image",value:null,async:!0},bounds:{type:"array",value:[1,0,0,1],compare:!0},_imageCoordinateSystem:li.DEFAULT,desaturate:{type:"number",min:0,max:1,value:0},transparentColor:{type:"color",value:[0,0,0,0]},tintColor:{type:"color",value:[255,255,255]},textureParameters:{type:"object",ignore:!0,value:null}};class Ry extends Cn{getShaders(){return super.getShaders({vs:NN,fs:UN,modules:[Mc,Rc,BN]})}initializeState(){const e=this.getAttributeManager();e.remove(["instancePickingColors"]);const t=!0;e.add({indices:{size:1,isIndexed:!0,update:r=>r.value=this.state.mesh.indices,noAlloc:t},positions:{size:3,type:"float64",fp64:this.use64bitPositions(),update:r=>r.value=this.state.mesh.positions,noAlloc:t},texCoords:{size:2,update:r=>r.value=this.state.mesh.texCoords,noAlloc:t}})}updateState({props:e,oldProps:t,changeFlags:r}){const s=this.getAttributeManager();if(r.extensionsChanged&&(this.state.model?.destroy(),this.state.model=this._getModel(),s.invalidateAll()),e.bounds!==t.bounds){const a=this.state.mesh,u=this._createMesh();this.state.model.setVertexCount(u.vertexCount);for(const l in u)a&&a[l]!==u[l]&&s.invalidate(l);this.setState({mesh:u,...this._getCoordinateUniforms()})}else e._imageCoordinateSystem!==t._imageCoordinateSystem&&this.setState(this._getCoordinateUniforms())}getPickingInfo(e){const{image:t}=this.props,r=e.info;if(!r.color||!t)return r.bitmap=null,r;const{width:s,height:a}=t;r.index=0;const u=jN(r.color);return r.bitmap={size:{width:s,height:a},uv:u,pixel:[Math.floor(u[0]*s),Math.floor(u[1]*a)]},r}disablePickingIndex(){this.setState({disablePicking:!0})}restorePickingColors(){this.setState({disablePicking:!1})}_updateAutoHighlight(e){super._updateAutoHighlight({...e,color:this.encodePickingColor(0)})}_createMesh(){const{bounds:e}=this.props;let t=e;return iw(e)&&(t=[[e[0],e[1]],[e[0],e[3]],[e[2],e[3]],[e[2],e[1]]]),ON(t,this.context.viewport.resolution)}_getModel(){return new Ks(this.context.device,{...this.getShaders(),id:this.props.id,bufferLayout:this.getAttributeManager().getBufferLayouts(),topology:"triangle-list",isInstanced:!1})}draw(e){const{shaderModuleProps:t}=e,{model:r,coordinateConversion:s,bounds:a,disablePicking:u}=this.state,{image:l,desaturate:g,transparentColor:v,tintColor:T}=this.props;if(!(t.picking.isActive&&u)&&l&&r){const S={bitmapTexture:l,bounds:a,coordinateConversion:s,desaturate:g,tintColor:T.slice(0,3).map(P=>P/255),transparentColor:v.map(P=>P/255)};r.shaderInputs.setProps({bitmap:S}),r.draw(this.context.renderPass)}}_getCoordinateUniforms(){const{LNGLAT:e,CARTESIAN:t,DEFAULT:r}=li;let{_imageCoordinateSystem:s}=this.props;if(s!==r){const{bounds:a}=this.props;if(!iw(a))throw new Error("_imageCoordinateSystem only supports rectangular bounds");const u=this.context.viewport.resolution?e:t;if(s=s===e?e:t,s===e&&u===t)return{coordinateConversion:-1,bounds:a};if(s===t&&u===e){const l=ia([a[0],a[1]]),g=ia([a[2],a[3]]);return{coordinateConversion:1,bounds:[l[0],l[1],g[0],g[1]]}}}return{coordinateConversion:0,bounds:[0,0,0,0]}}}Ry.layerName="BitmapLayer";Ry.defaultProps=VN;function jN(i){const[e,t,r]=i,s=(r&240)/256,a=(r&15)/16;return[(e+a)/256,(t+s)/256]}function iw(i){return Number.isFinite(i[0])}const rw=`uniform iconUniforms {
  float sizeScale;
  vec2 iconsTextureDim;
  float sizeBasis;
  float sizeMinPixels;
  float sizeMaxPixels;
  bool billboard;
  highp int sizeUnits;
  float alphaCutoff;
} icon;
`,$N={name:"icon",vs:rw,fs:rw,uniformTypes:{sizeScale:"f32",iconsTextureDim:"vec2<f32>",sizeBasis:"f32",sizeMinPixels:"f32",sizeMaxPixels:"f32",billboard:"f32",sizeUnits:"i32",alphaCutoff:"f32"}},WN=`#version 300 es
#define SHADER_NAME icon-layer-vertex-shader
in vec2 positions;
in vec3 instancePositions;
in vec3 instancePositions64Low;
in float instanceSizes;
in float instanceAngles;
in vec4 instanceColors;
in vec3 instancePickingColors;
in vec4 instanceIconFrames;
in float instanceColorModes;
in vec2 instanceOffsets;
in vec2 instancePixelOffset;
out float vColorMode;
out vec4 vColor;
out vec2 vTextureCoords;
out vec2 uv;
vec2 rotate_by_angle(vec2 vertex, float angle) {
float angle_radian = angle * PI / 180.0;
float cos_angle = cos(angle_radian);
float sin_angle = sin(angle_radian);
mat2 rotationMatrix = mat2(cos_angle, -sin_angle, sin_angle, cos_angle);
return rotationMatrix * vertex;
}
void main(void) {
geometry.worldPosition = instancePositions;
geometry.uv = positions;
geometry.pickingColor = instancePickingColors;
uv = positions;
vec2 iconSize = instanceIconFrames.zw;
float sizePixels = clamp(
project_size_to_pixel(instanceSizes * icon.sizeScale, icon.sizeUnits),
icon.sizeMinPixels, icon.sizeMaxPixels
);
float iconConstraint = icon.sizeBasis == 0.0 ? iconSize.x : iconSize.y;
float instanceScale = iconConstraint == 0.0 ? 0.0 : sizePixels / iconConstraint;
vec2 pixelOffset = positions / 2.0 * iconSize + instanceOffsets;
pixelOffset = rotate_by_angle(pixelOffset, instanceAngles) * instanceScale;
pixelOffset += instancePixelOffset;
pixelOffset.y *= -1.0;
if (icon.billboard)  {
gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, vec3(0.0), geometry.position);
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
vec3 offset = vec3(pixelOffset, 0.0);
DECKGL_FILTER_SIZE(offset, geometry);
gl_Position.xy += project_pixel_size_to_clipspace(offset.xy);
} else {
vec3 offset_common = vec3(project_pixel_size(pixelOffset), 0.0);
DECKGL_FILTER_SIZE(offset_common, geometry);
gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset_common, geometry.position);
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
}
vTextureCoords = mix(
instanceIconFrames.xy,
instanceIconFrames.xy + iconSize,
(positions.xy + 1.0) / 2.0
) / icon.iconsTextureDim;
vColor = instanceColors;
DECKGL_FILTER_COLOR(vColor, geometry);
vColorMode = instanceColorModes;
}
`,HN=`#version 300 es
#define SHADER_NAME icon-layer-fragment-shader
precision highp float;
uniform sampler2D iconsTexture;
in float vColorMode;
in vec4 vColor;
in vec2 vTextureCoords;
in vec2 uv;
out vec4 fragColor;
void main(void) {
geometry.uv = uv;
vec4 texColor = texture(iconsTexture, vTextureCoords);
vec3 color = mix(texColor.rgb, vColor.rgb, vColorMode);
float a = texColor.a * layer.opacity * vColor.a;
if (a < icon.alphaCutoff) {
discard;
}
fragColor = vec4(color, a);
DECKGL_FILTER_COLOR(fragColor, geometry);
}
`,qN=1024,XN=4,sw=()=>{},nw={minFilter:"linear",mipmapFilter:"linear",magFilter:"linear",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge"},ZN={x:0,y:0,width:0,height:0};function YN(i){return Math.pow(2,Math.ceil(Math.log2(i)))}function GN(i,e,t,r){const s=Math.min(t/e.width,r/e.height),a=Math.floor(e.width*s),u=Math.floor(e.height*s);return s===1?{image:e,width:a,height:u}:(i.canvas.height=u,i.canvas.width=a,i.clearRect(0,0,a,u),i.drawImage(e,0,0,e.width,e.height,0,0,a,u),{image:i.canvas,width:a,height:u})}function Oh(i){return i&&(i.id||i.url)}function KN(i,e,t,r){const{width:s,height:a,device:u}=i,l=u.createTexture({format:"rgba8unorm",width:e,height:t,sampler:r,mipLevels:u.getMipLevelCount(e,t)}),g=u.createCommandEncoder();return g.copyTextureToTexture({sourceTexture:i,destinationTexture:l,width:s,height:a}),g.finish(),l.generateMipmapsWebGL(),i.destroy(),l}function ow(i,e,t){for(let r=0;r<e.length;r++){const{icon:s,xOffset:a}=e[r],u=Oh(s);i[u]={...s,x:a,y:t}}}function JN({icons:i,buffer:e,mapping:t={},xOffset:r=0,yOffset:s=0,rowHeight:a=0,canvasWidth:u}){let l=[];for(let g=0;g<i.length;g++){const v=i[g],T=Oh(v);if(!t[T]){const{height:S,width:P}=v;r+P+e>u&&(ow(t,l,s),r=0,s=a+s+e,a=0,l=[]),l.push({icon:v,xOffset:r}),r=r+P+e,a=Math.max(a,S)}}return l.length>0&&ow(t,l,s),{mapping:t,rowHeight:a,xOffset:r,yOffset:s,canvasWidth:u,canvasHeight:YN(a+s+e)}}function QN(i,e,t){if(!i||!e)return null;t=t||{};const r={},{iterable:s,objectInfo:a}=bp(i);for(const u of s){a.index++;const l=e(u,a),g=Oh(l);if(!l)throw new Error("Icon is missing.");if(!l.url)throw new Error("Icon url is missing.");!r[g]&&(!t[g]||l.url!==t[g].url)&&(r[g]={...l,source:u,sourceIndex:a.index})}return r}class ez{constructor(e,{onUpdate:t=sw,onError:r=sw}){this._loadOptions=null,this._texture=null,this._externalTexture=null,this._mapping={},this._samplerParameters=null,this._pendingCount=0,this._autoPacking=!1,this._xOffset=0,this._yOffset=0,this._rowHeight=0,this._buffer=XN,this._canvasWidth=qN,this._canvasHeight=0,this._canvas=null,this.device=e,this.onUpdate=t,this.onError=r}finalize(){this._texture?.delete()}getTexture(){return this._texture||this._externalTexture}getIconMapping(e){const t=this._autoPacking?Oh(e):e;return this._mapping[t]||ZN}setProps({loadOptions:e,autoPacking:t,iconAtlas:r,iconMapping:s,textureParameters:a}){e&&(this._loadOptions=e),t!==void 0&&(this._autoPacking=t),s&&(this._mapping=s),r&&(this._texture?.delete(),this._texture=null,this._externalTexture=r),a&&(this._samplerParameters=a)}get isLoaded(){return this._pendingCount===0}packIcons(e,t){if(!this._autoPacking||typeof document>"u")return;const r=Object.values(QN(e,t,this._mapping)||{});if(r.length>0){const{mapping:s,xOffset:a,yOffset:u,rowHeight:l,canvasHeight:g}=JN({icons:r,buffer:this._buffer,canvasWidth:this._canvasWidth,mapping:this._mapping,rowHeight:this._rowHeight,xOffset:this._xOffset,yOffset:this._yOffset});this._rowHeight=l,this._mapping=s,this._xOffset=a,this._yOffset=u,this._canvasHeight=g,this._texture||(this._texture=this.device.createTexture({format:"rgba8unorm",data:null,width:this._canvasWidth,height:this._canvasHeight,sampler:this._samplerParameters||nw,mipLevels:this.device.getMipLevelCount(this._canvasWidth,this._canvasHeight)})),this._texture.height!==this._canvasHeight&&(this._texture=KN(this._texture,this._canvasWidth,this._canvasHeight,this._samplerParameters||nw)),this.onUpdate(),this._canvas=this._canvas||document.createElement("canvas"),this._loadIcons(r),this._texture?.generateMipmapsWebGL()}}_loadIcons(e){const t=this._canvas.getContext("2d",{willReadFrequently:!0});for(const r of e)this._pendingCount++,Zf(r.url,this._loadOptions).then(s=>{const a=Oh(r),u=this._mapping[a],{x:l,y:g,width:v,height:T}=u,{image:S,width:P,height:O}=GN(t,s,v,T);this._texture?.copyExternalImage({image:S,x:l+(v-P)/2,y:g+(T-O)/2,width:P,height:O}),u.width=P,u.height=O,this._texture?.generateMipmapsWebGL(),this.onUpdate()}).catch(s=>{this.onError({url:r.url,source:r.source,sourceIndex:r.sourceIndex,loadOptions:this._loadOptions,error:s})}).finally(()=>{this._pendingCount--})}}const MT=[0,0,0,255],tz={iconAtlas:{type:"image",value:null,async:!0},iconMapping:{type:"object",value:{},async:!0},sizeScale:{type:"number",value:1,min:0},billboard:!0,sizeUnits:"pixels",sizeBasis:"height",sizeMinPixels:{type:"number",min:0,value:0},sizeMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},alphaCutoff:{type:"number",value:.05,min:0,max:1},getPosition:{type:"accessor",value:i=>i.position},getIcon:{type:"accessor",value:i=>i.icon},getColor:{type:"accessor",value:MT},getSize:{type:"accessor",value:1},getAngle:{type:"accessor",value:0},getPixelOffset:{type:"accessor",value:[0,0]},onIconError:{type:"function",value:null,optional:!0},textureParameters:{type:"object",ignore:!0,value:null}};class Ko extends Cn{getShaders(){return super.getShaders({vs:WN,fs:HN,modules:[Mc,Rc,$N]})}initializeState(){this.state={iconManager:new ez(this.context.device,{onUpdate:this._onUpdate.bind(this),onError:this._onError.bind(this)})},this.getAttributeManager().addInstanced({instancePositions:{size:3,type:"float64",fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceSizes:{size:1,transition:!0,accessor:"getSize",defaultValue:1},instanceOffsets:{size:2,accessor:"getIcon",transform:this.getInstanceOffset},instanceIconFrames:{size:4,accessor:"getIcon",transform:this.getInstanceIconFrame},instanceColorModes:{size:1,type:"uint8",accessor:"getIcon",transform:this.getInstanceColorMode},instanceColors:{size:this.props.colorFormat.length,type:"unorm8",transition:!0,accessor:"getColor",defaultValue:MT},instanceAngles:{size:1,transition:!0,accessor:"getAngle"},instancePixelOffset:{size:2,transition:!0,accessor:"getPixelOffset"}})}updateState(e){super.updateState(e);const{props:t,oldProps:r,changeFlags:s}=e,a=this.getAttributeManager(),{iconAtlas:u,iconMapping:l,data:g,getIcon:v,textureParameters:T}=t,{iconManager:S}=this.state;if(typeof u=="string")return;const P=u||this.internalState.isAsyncPropLoading("iconAtlas");S.setProps({loadOptions:t.loadOptions,autoPacking:!P,iconAtlas:u,iconMapping:P?l:null,textureParameters:T}),P?r.iconMapping!==t.iconMapping&&a.invalidate("getIcon"):(s.dataChanged||s.updateTriggersChanged&&(s.updateTriggersChanged.all||s.updateTriggersChanged.getIcon))&&S.packIcons(g,v),s.extensionsChanged&&(this.state.model?.destroy(),this.state.model=this._getModel(),a.invalidateAll())}get isLoaded(){return super.isLoaded&&this.state.iconManager.isLoaded}finalizeState(e){super.finalizeState(e),this.state.iconManager.finalize()}draw({uniforms:e}){const{sizeScale:t,sizeBasis:r,sizeMinPixels:s,sizeMaxPixels:a,sizeUnits:u,billboard:l,alphaCutoff:g}=this.props,{iconManager:v}=this.state,T=v.getTexture();if(T){const S=this.state.model,P={iconsTexture:T,iconsTextureDim:[T.width,T.height],sizeUnits:to[u],sizeScale:t,sizeBasis:r==="height"?1:0,sizeMinPixels:s,sizeMaxPixels:a,billboard:l,alphaCutoff:g};S.shaderInputs.setProps({icon:P}),S.draw(this.context.renderPass)}}_getModel(){const e=[-1,-1,1,-1,-1,1,1,1];return new Ks(this.context.device,{...this.getShaders(),id:this.props.id,bufferLayout:this.getAttributeManager().getBufferLayouts(),geometry:new Ac({topology:"triangle-strip",attributes:{positions:{size:2,value:new Float32Array(e)}}}),isInstanced:!0})}_onUpdate(){this.setNeedsRedraw()}_onError(e){const t=this.getCurrentLayer()?.props.onIconError;t?t(e):ni.error(e.error.message)()}getInstanceOffset(e){const{width:t,height:r,anchorX:s=t/2,anchorY:a=r/2}=this.state.iconManager.getIconMapping(e);return[t/2-s,r/2-a]}getInstanceColorMode(e){return this.state.iconManager.getIconMapping(e).mask?1:0}getInstanceIconFrame(e){const{x:t,y:r,width:s,height:a}=this.state.iconManager.getIconMapping(e);return[t,r,s,a]}}Ko.defaultProps=tz;Ko.layerName="IconLayer";const aw=`uniform scatterplotUniforms {
  float radiusScale;
  float radiusMinPixels;
  float radiusMaxPixels;
  float lineWidthScale;
  float lineWidthMinPixels;
  float lineWidthMaxPixels;
  float stroked;
  float filled;
  bool antialiasing;
  bool billboard;
  highp int radiusUnits;
  highp int lineWidthUnits;
} scatterplot;
`,iz={name:"scatterplot",vs:aw,fs:aw,source:"",uniformTypes:{radiusScale:"f32",radiusMinPixels:"f32",radiusMaxPixels:"f32",lineWidthScale:"f32",lineWidthMinPixels:"f32",lineWidthMaxPixels:"f32",stroked:"f32",filled:"f32",antialiasing:"f32",billboard:"f32",radiusUnits:"i32",lineWidthUnits:"i32"}},rz=`#version 300 es
#define SHADER_NAME scatterplot-layer-vertex-shader
in vec3 positions;
in vec3 instancePositions;
in vec3 instancePositions64Low;
in float instanceRadius;
in float instanceLineWidths;
in vec4 instanceFillColors;
in vec4 instanceLineColors;
in vec3 instancePickingColors;
out vec4 vFillColor;
out vec4 vLineColor;
out vec2 unitPosition;
out float innerUnitRadius;
out float outerRadiusPixels;
void main(void) {
geometry.worldPosition = instancePositions;
outerRadiusPixels = clamp(
project_size_to_pixel(scatterplot.radiusScale * instanceRadius, scatterplot.radiusUnits),
scatterplot.radiusMinPixels, scatterplot.radiusMaxPixels
);
float lineWidthPixels = clamp(
project_size_to_pixel(scatterplot.lineWidthScale * instanceLineWidths, scatterplot.lineWidthUnits),
scatterplot.lineWidthMinPixels, scatterplot.lineWidthMaxPixels
);
outerRadiusPixels += scatterplot.stroked * lineWidthPixels / 2.0;
float edgePadding = scatterplot.antialiasing ? (outerRadiusPixels + SMOOTH_EDGE_RADIUS) / outerRadiusPixels : 1.0;
unitPosition = edgePadding * positions.xy;
geometry.uv = unitPosition;
geometry.pickingColor = instancePickingColors;
innerUnitRadius = 1.0 - scatterplot.stroked * lineWidthPixels / outerRadiusPixels;
if (scatterplot.billboard) {
gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, vec3(0.0), geometry.position);
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
vec3 offset = edgePadding * positions * outerRadiusPixels;
DECKGL_FILTER_SIZE(offset, geometry);
gl_Position.xy += project_pixel_size_to_clipspace(offset.xy);
} else {
vec3 offset = edgePadding * positions * project_pixel_size(outerRadiusPixels);
DECKGL_FILTER_SIZE(offset, geometry);
gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset, geometry.position);
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
}
vFillColor = vec4(instanceFillColors.rgb, instanceFillColors.a * layer.opacity);
DECKGL_FILTER_COLOR(vFillColor, geometry);
vLineColor = vec4(instanceLineColors.rgb, instanceLineColors.a * layer.opacity);
DECKGL_FILTER_COLOR(vLineColor, geometry);
}
`,sz=`#version 300 es
#define SHADER_NAME scatterplot-layer-fragment-shader
precision highp float;
in vec4 vFillColor;
in vec4 vLineColor;
in vec2 unitPosition;
in float innerUnitRadius;
in float outerRadiusPixels;
out vec4 fragColor;
void main(void) {
geometry.uv = unitPosition;
float distToCenter = length(unitPosition) * outerRadiusPixels;
float inCircle = scatterplot.antialiasing ?
smoothedge(distToCenter, outerRadiusPixels) :
step(distToCenter, outerRadiusPixels);
if (inCircle == 0.0) {
discard;
}
if (scatterplot.stroked > 0.5) {
float isLine = scatterplot.antialiasing ?
smoothedge(innerUnitRadius * outerRadiusPixels, distToCenter) :
step(innerUnitRadius * outerRadiusPixels, distToCenter);
if (scatterplot.filled > 0.5) {
fragColor = mix(vFillColor, vLineColor, isLine);
} else {
if (isLine == 0.0) {
discard;
}
fragColor = vec4(vLineColor.rgb, vLineColor.a * isLine);
}
} else if (scatterplot.filled < 0.5) {
discard;
} else {
fragColor = vFillColor;
}
fragColor.a *= inCircle;
DECKGL_FILTER_COLOR(fragColor, geometry);
}
`,nz=`// Main shaders

struct ScatterplotUniforms {
  radiusScale: f32,
  radiusMinPixels: f32,
  radiusMaxPixels: f32,
  lineWidthScale: f32,
  lineWidthMinPixels: f32,
  lineWidthMaxPixels: f32,
  stroked: f32,
  filled: i32,
  antialiasing: i32,
  billboard: i32,
  radiusUnits: i32,
  lineWidthUnits: i32,
};

struct ConstantAttributeUniforms {
 instancePositions: vec3<f32>,
 instancePositions64Low: vec3<f32>,
 instanceRadius: f32,
 instanceLineWidths: f32,
 instanceFillColors: vec4<f32>,
 instanceLineColors: vec4<f32>,
 instancePickingColors: vec3<f32>,

 instancePositionsConstant: i32,
 instancePositions64LowConstant: i32,
 instanceRadiusConstant: i32,
 instanceLineWidthsConstant: i32,
 instanceFillColorsConstant: i32,
 instanceLineColorsConstant: i32,
 instancePickingColorsConstant: i32
};

@group(0) @binding(2) var<uniform> scatterplot: ScatterplotUniforms;

struct ConstantAttributes {
  instancePositions: vec3<f32>,
  instancePositions64Low: vec3<f32>,
  instanceRadius: f32,
  instanceLineWidths: f32,
  instanceFillColors: vec4<f32>,
  instanceLineColors: vec4<f32>,
  instancePickingColors: vec3<f32>
};

const constants = ConstantAttributes(
  vec3<f32>(0.0),
  vec3<f32>(0.0),
  0.0,
  0.0,
  vec4<f32>(0.0, 0.0, 0.0, 1.0),
  vec4<f32>(0.0, 0.0, 0.0, 1.0),
  vec3<f32>(0.0)
);

struct Attributes {
  @builtin(instance_index) instanceIndex : u32,
  @builtin(vertex_index) vertexIndex : u32,
  @location(0) positions: vec3<f32>,
  @location(1) instancePositions: vec3<f32>,
  @location(2) instancePositions64Low: vec3<f32>,
  @location(3) instanceRadius: f32,
  @location(4) instanceLineWidths: f32,
  @location(5) instanceFillColors: vec4<f32>,
  @location(6) instanceLineColors: vec4<f32>,
  @location(7) instancePickingColors: vec3<f32>
};

struct Varyings {
  @builtin(position) position: vec4<f32>,
  @location(0) vFillColor: vec4<f32>,
  @location(1) vLineColor: vec4<f32>,
  @location(2) unitPosition: vec2<f32>,
  @location(3) innerUnitRadius: f32,
  @location(4) outerRadiusPixels: f32,
};

@vertex
fn vertexMain(attributes: Attributes) -> Varyings {
  var varyings: Varyings;

  // Draw an inline geometry constant array clip space triangle to verify that rendering works.
  // var positions = array<vec2<f32>, 3>(vec2(0.0, 0.5), vec2(-0.5, -0.5), vec2(0.5, -0.5));
  // if (attributes.instanceIndex == 0) {
  //   varyings.position = vec4<f32>(positions[attributes.vertexIndex], 0.0, 1.0);
  //   return varyings;
  // }

  // var geometry: Geometry;
  // geometry.worldPosition = instancePositions;

  // Multiply out radius and clamp to limits
  varyings.outerRadiusPixels = clamp(
    project_unit_size_to_pixel(scatterplot.radiusScale * attributes.instanceRadius, scatterplot.radiusUnits),
    scatterplot.radiusMinPixels, scatterplot.radiusMaxPixels
  );

  // Multiply out line width and clamp to limits
  let lineWidthPixels = clamp(
    project_unit_size_to_pixel(scatterplot.lineWidthScale * attributes.instanceLineWidths, scatterplot.lineWidthUnits),
    scatterplot.lineWidthMinPixels, scatterplot.lineWidthMaxPixels
  );

  // outer radius needs to offset by half stroke width
  varyings.outerRadiusPixels += scatterplot.stroked * lineWidthPixels / 2.0;
  // Expand geometry to accommodate edge smoothing
  let edgePadding = select(
    (varyings.outerRadiusPixels + SMOOTH_EDGE_RADIUS) / varyings.outerRadiusPixels,
    1.0,
    scatterplot.antialiasing != 0
  );

  // position on the containing square in [-1, 1] space
  varyings.unitPosition = edgePadding * attributes.positions.xy;
  geometry.uv = varyings.unitPosition;
  geometry.pickingColor = attributes.instancePickingColors;

  varyings.innerUnitRadius = 1.0 - scatterplot.stroked * lineWidthPixels / varyings.outerRadiusPixels;

  if (scatterplot.billboard != 0) {
    varyings.position = project_position_to_clipspace(attributes.instancePositions, attributes.instancePositions64Low, vec3<f32>(0.0)); // TODO , geometry.position);
    // DECKGL_FILTER_GL_POSITION(varyings.position, geometry);
    let offset = attributes.positions; // * edgePadding * varyings.outerRadiusPixels;
    // DECKGL_FILTER_SIZE(offset, geometry);
    let clipPixels = project_pixel_size_to_clipspace(offset.xy);
    varyings.position.x = clipPixels.x;
    varyings.position.y = clipPixels.y;
  } else {
    let offset = edgePadding * attributes.positions * project_pixel_size_float(varyings.outerRadiusPixels);
    // DECKGL_FILTER_SIZE(offset, geometry);
    varyings.position = project_position_to_clipspace(attributes.instancePositions, attributes.instancePositions64Low, offset); // TODO , geometry.position);
    // DECKGL_FILTER_GL_POSITION(varyings.position, geometry);
  }

  // Apply opacity to instance color, or return instance picking color
  varyings.vFillColor = vec4<f32>(attributes.instanceFillColors.rgb, attributes.instanceFillColors.a * color.opacity);
  // DECKGL_FILTER_COLOR(varyings.vFillColor, geometry);
  varyings.vLineColor = vec4<f32>(attributes.instanceLineColors.rgb, attributes.instanceLineColors.a * color.opacity);
  // DECKGL_FILTER_COLOR(varyings.vLineColor, geometry);

  return varyings;
}

@fragment
fn fragmentMain(varyings: Varyings) -> @location(0) vec4<f32> {
  // var geometry: Geometry;
  // geometry.uv = unitPosition;

  let distToCenter = length(varyings.unitPosition) * varyings.outerRadiusPixels;
  let inCircle = select(
    smoothedge(distToCenter, varyings.outerRadiusPixels),
    step(distToCenter, varyings.outerRadiusPixels),
    scatterplot.antialiasing != 0
  );

  if (inCircle == 0.0) {
    discard;
  }

  var fragColor: vec4<f32>;

  if (scatterplot.stroked != 0) {
    let isLine = select(
      smoothedge(varyings.innerUnitRadius * varyings.outerRadiusPixels, distToCenter),
      step(varyings.innerUnitRadius * varyings.outerRadiusPixels, distToCenter),
      scatterplot.antialiasing != 0
    );

    if (scatterplot.filled != 0) {
      fragColor = mix(varyings.vFillColor, varyings.vLineColor, isLine);
    } else {
      if (isLine == 0.0) {
        discard;
      }
      fragColor = vec4<f32>(varyings.vLineColor.rgb, varyings.vLineColor.a * isLine);
    }
  } else if (scatterplot.filled == 0) {
    discard;
  } else {
    fragColor = varyings.vFillColor;
  }

  fragColor.a *= inCircle;
  // DECKGL_FILTER_COLOR(fragColor, geometry);

  // Apply premultiplied alpha as required by transparent canvas
  fragColor = deckgl_premultiplied_alpha(fragColor);

  return fragColor;
  // return vec4<f32>(0, 0, 1, 1);
}
`,lw=[0,0,0,255],oz={radiusUnits:"meters",radiusScale:{type:"number",min:0,value:1},radiusMinPixels:{type:"number",min:0,value:0},radiusMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},lineWidthUnits:"meters",lineWidthScale:{type:"number",min:0,value:1},lineWidthMinPixels:{type:"number",min:0,value:0},lineWidthMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},stroked:!1,filled:!0,billboard:!1,antialiasing:!0,getPosition:{type:"accessor",value:i=>i.position},getRadius:{type:"accessor",value:1},getFillColor:{type:"accessor",value:lw},getLineColor:{type:"accessor",value:lw},getLineWidth:{type:"accessor",value:1},strokeWidth:{deprecatedFor:"getLineWidth"},outline:{deprecatedFor:"stroked"},getColor:{deprecatedFor:["getFillColor","getLineColor"]}};class Lh extends Cn{getShaders(){return super.getShaders({vs:rz,fs:sz,source:nz,modules:[Mc,$R,Rc,iz]})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:3,type:"float64",fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceRadius:{size:1,transition:!0,accessor:"getRadius",defaultValue:1},instanceFillColors:{size:this.props.colorFormat.length,transition:!0,type:"unorm8",accessor:"getFillColor",defaultValue:[0,0,0,255]},instanceLineColors:{size:this.props.colorFormat.length,transition:!0,type:"unorm8",accessor:"getLineColor",defaultValue:[0,0,0,255]},instanceLineWidths:{size:1,transition:!0,accessor:"getLineWidth",defaultValue:1}})}updateState(e){super.updateState(e),e.changeFlags.extensionsChanged&&(this.state.model?.destroy(),this.state.model=this._getModel(),this.getAttributeManager().invalidateAll())}draw({uniforms:e}){const{radiusUnits:t,radiusScale:r,radiusMinPixels:s,radiusMaxPixels:a,stroked:u,filled:l,billboard:g,antialiasing:v,lineWidthUnits:T,lineWidthScale:S,lineWidthMinPixels:P,lineWidthMaxPixels:O}=this.props,$={stroked:u,filled:l,billboard:g,antialiasing:v,radiusUnits:to[t],radiusScale:r,radiusMinPixels:s,radiusMaxPixels:a,lineWidthUnits:to[T],lineWidthScale:S,lineWidthMinPixels:P,lineWidthMaxPixels:O},W=this.state.model;W.shaderInputs.setProps({scatterplot:$}),this.context.device.type==="webgpu"&&(W.instanceCount=this.props.data.length),W.draw(this.context.renderPass)}_getModel(){const e=this.context.device.type==="webgpu"?{depthWriteEnabled:!0,depthCompare:"less-equal"}:void 0,t=[-1,-1,0,1,-1,0,-1,1,0,1,1,0];return new Ks(this.context.device,{...this.getShaders(),id:this.props.id,bufferLayout:this.getAttributeManager().getBufferLayouts(),geometry:new Ac({topology:"triangle-strip",attributes:{positions:{size:3,value:new Float32Array(t)}}}),isInstanced:!0,parameters:e})}}Lh.defaultProps=oz;Lh.layerName="ScatterplotLayer";const RT={CLOCKWISE:1,COUNTER_CLOCKWISE:-1};function kT(i,e,t={}){return az(i,t)!==e?(cz(i,t),!0):!1}function az(i,e={}){return Math.sign(lz(i,e))}const cw={x:0,y:1,z:2};function lz(i,e={}){const{start:t=0,end:r=i.length,plane:s="xy"}=e,a=e.size||2;let u=0;const l=cw[s[0]],g=cw[s[1]];for(let v=t,T=r-a;v<r;v+=a)u+=(i[v+l]-i[T+l])*(i[v+g]+i[T+g]),T=v;return u/2}function cz(i,e){const{start:t=0,end:r=i.length,size:s=2}=e,a=(r-t)/s,u=Math.floor(a/2);for(let l=0;l<u;++l){const g=t+l*s,v=t+(a-1-l)*s;for(let T=0;T<s;++T){const S=i[g+T];i[g+T]=i[v+T],i[v+T]=S}}}function cn(i,e){const t=e.length,r=i.length;if(r>0){let s=!0;for(let a=0;a<t;a++)if(i[r-t+a]!==e[a]){s=!1;break}if(s)return!1}for(let s=0;s<t;s++)i[r+s]=e[s];return!0}function T_(i,e){const t=e.length;for(let r=0;r<t;r++)i[r]=e[r]}function Fh(i,e,t,r,s=[]){const a=r+e*t;for(let u=0;u<t;u++)s[u]=i[a+u];return s}function S_(i,e,t,r,s=[]){let a,u;if(t&8)a=(r[3]-i[1])/(e[1]-i[1]),u=3;else if(t&4)a=(r[1]-i[1])/(e[1]-i[1]),u=1;else if(t&2)a=(r[2]-i[0])/(e[0]-i[0]),u=2;else if(t&1)a=(r[0]-i[0])/(e[0]-i[0]),u=0;else return null;for(let l=0;l<i.length;l++)s[l]=(u&1)===l?r[u]:a*(e[l]-i[l])+i[l];return s}function Uf(i,e){let t=0;return i[0]<e[0]?t|=1:i[0]>e[2]&&(t|=2),i[1]<e[1]?t|=4:i[1]>e[3]&&(t|=8),t}function DT(i,e){const{size:t=2,broken:r=!1,gridResolution:s=10,gridOffset:a=[0,0],startIndex:u=0,endIndex:l=i.length}=e||{},g=(l-u)/t;let v=[];const T=[v],S=Fh(i,0,t,u);let P,O;const $=LT(S,s,a,[]),W=[];cn(v,S);for(let G=1;G<g;G++){for(P=Fh(i,G,t,u,P),O=Uf(P,$);O;){S_(S,P,O,$,W);const Q=Uf(W,$);Q&&(S_(S,W,Q,$,W),O=Q),cn(v,W),T_(S,W),hz($,s,O),r&&v.length>t&&(v=[],T.push(v),cn(v,S)),O=Uf(P,$)}cn(v,P),T_(S,P)}return r?T:T[0]}const uw=0,uz=1;function OT(i,e=null,t){if(!i.length)return[];const{size:r=2,gridResolution:s=10,gridOffset:a=[0,0],edgeTypes:u=!1}=t||{},l=[],g=[{pos:i,types:u?new Array(i.length/r).fill(uz):null,holes:e||[]}],v=[[],[]];let T=[];for(;g.length;){const{pos:S,types:P,holes:O}=g.shift();dz(S,r,O[0]||S.length,v),T=LT(v[0],s,a,T);const $=Uf(v[1],T);if($){let W=hw(S,P,r,0,O[0]||S.length,T,$);const G={pos:W[0].pos,types:W[0].types,holes:[]},Q={pos:W[1].pos,types:W[1].types,holes:[]};g.push(G,Q);for(let ae=0;ae<O.length;ae++)W=hw(S,P,r,O[ae],O[ae+1]||S.length,T,$),W[0]&&(G.holes.push(G.pos.length),G.pos=mf(G.pos,W[0].pos),u&&(G.types=mf(G.types,W[0].types))),W[1]&&(Q.holes.push(Q.pos.length),Q.pos=mf(Q.pos,W[1].pos),u&&(Q.types=mf(Q.types,W[1].types)))}else{const W={positions:S};u&&(W.edgeTypes=P),O.length&&(W.holeIndices=O),l.push(W)}}return l}function hw(i,e,t,r,s,a,u){const l=(s-r)/t,g=[],v=[],T=[],S=[],P=[];let O,$,W;const G=Fh(i,l-1,t,r);let Q=Math.sign(u&8?G[1]-a[3]:G[0]-a[2]),ae=e&&e[l-1],te=0,me=0;for(let we=0;we<l;we++)O=Fh(i,we,t,r,O),$=Math.sign(u&8?O[1]-a[3]:O[0]-a[2]),W=e&&e[r/t+we],$&&Q&&Q!==$&&(S_(G,O,u,a,P),cn(g,P)&&T.push(ae),cn(v,P)&&S.push(ae)),$<=0?(cn(g,O)&&T.push(W),te-=$):T.length&&(T[T.length-1]=uw),$>=0?(cn(v,O)&&S.push(W),me+=$):S.length&&(S[S.length-1]=uw),T_(G,O),Q=$,ae=W;return[te?{pos:g,types:e&&T}:null,me?{pos:v,types:e&&S}:null]}function LT(i,e,t,r){const s=Math.floor((i[0]-t[0])/e)*e+t[0],a=Math.floor((i[1]-t[1])/e)*e+t[1];return r[0]=s,r[1]=a,r[2]=s+e,r[3]=a+e,r}function hz(i,e,t){t&8?(i[1]+=e,i[3]+=e):t&4?(i[1]-=e,i[3]-=e):t&2?(i[0]+=e,i[2]+=e):t&1&&(i[0]-=e,i[2]-=e)}function dz(i,e,t,r){let s=1/0,a=-1/0,u=1/0,l=-1/0;for(let g=0;g<t;g+=e){const v=i[g],T=i[g+1];s=v<s?v:s,a=v>a?v:a,u=T<u?T:u,l=T>l?T:l}return r[0][0]=s,r[0][1]=u,r[1][0]=a,r[1][1]=l,r}function mf(i,e){for(let t=0;t<e.length;t++)i.push(e[t]);return i}const fz=85.051129;function pz(i,e){const{size:t=2,startIndex:r=0,endIndex:s=i.length,normalize:a=!0}=e||{},u=i.slice(r,s);FT(u,t,0,s-r);const l=DT(u,{size:t,broken:!0,gridResolution:360,gridOffset:[-180,-180]});if(a)for(const g of l)BT(g,t);return l}function gz(i,e=null,t){const{size:r=2,normalize:s=!0,edgeTypes:a=!1}=t||{};e=e||[];const u=[],l=[];let g=0,v=0;for(let S=0;S<=e.length;S++){const P=e[S]||i.length,O=v,$=mz(i,r,g,P);for(let W=$;W<P;W++)u[v++]=i[W];for(let W=g;W<$;W++)u[v++]=i[W];FT(u,r,O,v),_z(u,r,O,v,t?.maxLatitude),g=P,l[S]=v}l.pop();const T=OT(u,l,{size:r,gridResolution:360,gridOffset:[-180,-180],edgeTypes:a});if(s)for(const S of T)BT(S.positions,r);return T}function mz(i,e,t,r){let s=-1,a=-1;for(let u=t+1;u<r;u+=e){const l=Math.abs(i[u]);l>s&&(s=l,a=u-1)}return a}function _z(i,e,t,r,s=fz){const a=i[t],u=i[r-e];if(Math.abs(a-u)>180){const l=Fh(i,0,e,t);l[0]+=Math.round((u-a)/360)*360,cn(i,l),l[1]=Math.sign(l[1])*s,cn(i,l),l[0]=a,cn(i,l)}}function FT(i,e,t,r){let s=i[0],a;for(let u=t;u<r;u+=e){a=i[u];const l=a-s;(l>180||l<-180)&&(a-=Math.round(l/360)*360),i[u]=s=a}}function BT(i,e){let t;const r=i.length/e;for(let a=0;a<r&&(t=i[a*e],(t+180)%360===0);a++);const s=-Math.round(t/360)*360;if(s!==0)for(let a=0;a<r;a++)i[a*e]+=s}function yz(i,e,t,r){let s;if(Array.isArray(i[0])){const a=i.length*e;s=new Array(a);for(let u=0;u<i.length;u++)for(let l=0;l<e;l++)s[u*e+l]=i[u][l]||0}else s=i;return t?DT(s,{size:e,gridResolution:t}):r?pz(s,{size:e}):s}const xz=1,vz=2,Mm=4;class bz extends vT{constructor(e){super({...e,attributes:{positions:{size:3,padding:18,initialize:!0,type:e.fp64?Float64Array:Float32Array},segmentTypes:{size:1,type:Uint8ClampedArray}}})}get(e){return this.attributes[e]}getGeometryFromBuffer(e){return this.normalize?super.getGeometryFromBuffer(e):null}normalizeGeometry(e){return this.normalize?yz(e,this.positionSize,this.opts.resolution,this.opts.wrapLongitude):e}getGeometrySize(e){if(dw(e)){let r=0;for(const s of e)r+=this.getGeometrySize(s);return r}const t=this.getPathLength(e);return t<2?0:this.isClosed(e)?t<3?0:t+2:t}updateGeometryAttributes(e,t){if(t.geometrySize!==0)if(e&&dw(e))for(const r of e){const s=this.getGeometrySize(r);t.geometrySize=s,this.updateGeometryAttributes(r,t),t.vertexStart+=s}else this._updateSegmentTypes(e,t),this._updatePositions(e,t)}_updateSegmentTypes(e,t){const r=this.attributes.segmentTypes,s=e?this.isClosed(e):!1,{vertexStart:a,geometrySize:u}=t;r.fill(0,a,a+u),s?(r[a]=Mm,r[a+u-2]=Mm):(r[a]+=xz,r[a+u-2]+=vz),r[a+u-1]=Mm}_updatePositions(e,t){const{positions:r}=this.attributes;if(!r||!e)return;const{vertexStart:s,geometrySize:a}=t,u=new Array(3);for(let l=s,g=0;g<a;l++,g++)this.getPointOnPath(e,g,u),r[l*3]=u[0],r[l*3+1]=u[1],r[l*3+2]=u[2]}getPathLength(e){return e.length/this.positionSize}getPointOnPath(e,t,r=[]){const{positionSize:s}=this;t*s>=e.length&&(t+=1-e.length/s);const a=t*s;return r[0]=e[a],r[1]=e[a+1],r[2]=s===3&&e[a+2]||0,r}isClosed(e){if(!this.normalize)return!!this.opts.loop;const{positionSize:t}=this,r=e.length-t;return e[0]===e[r]&&e[1]===e[r+1]&&(t===2||e[2]===e[r+2])}}function dw(i){return Array.isArray(i[0])}const fw=`uniform pathUniforms {
  float widthScale;
  float widthMinPixels;
  float widthMaxPixels;
  float jointType;
  float capType;
  float miterLimit;
  bool billboard;
  highp int widthUnits;
} path;
`,wz={name:"path",vs:fw,fs:fw,uniformTypes:{widthScale:"f32",widthMinPixels:"f32",widthMaxPixels:"f32",jointType:"f32",capType:"f32",miterLimit:"f32",billboard:"f32",widthUnits:"i32"}},Tz=`#version 300 es
#define SHADER_NAME path-layer-vertex-shader
in vec2 positions;
in float instanceTypes;
in vec3 instanceStartPositions;
in vec3 instanceEndPositions;
in vec3 instanceLeftPositions;
in vec3 instanceRightPositions;
in vec3 instanceLeftPositions64Low;
in vec3 instanceStartPositions64Low;
in vec3 instanceEndPositions64Low;
in vec3 instanceRightPositions64Low;
in float instanceStrokeWidths;
in vec4 instanceColors;
in vec3 instancePickingColors;
uniform float opacity;
out vec4 vColor;
out vec2 vCornerOffset;
out float vMiterLength;
out vec2 vPathPosition;
out float vPathLength;
out float vJointType;
const float EPSILON = 0.001;
const vec3 ZERO_OFFSET = vec3(0.0);
float flipIfTrue(bool flag) {
return -(float(flag) * 2. - 1.);
}
vec3 getLineJoinOffset(
vec3 prevPoint, vec3 currPoint, vec3 nextPoint,
vec2 width
) {
bool isEnd = positions.x > 0.0;
float sideOfPath = positions.y;
float isJoint = float(sideOfPath == 0.0);
vec3 deltaA3 = (currPoint - prevPoint);
vec3 deltaB3 = (nextPoint - currPoint);
mat3 rotationMatrix;
bool needsRotation = !path.billboard && project_needs_rotation(currPoint, rotationMatrix);
if (needsRotation) {
deltaA3 = deltaA3 * rotationMatrix;
deltaB3 = deltaB3 * rotationMatrix;
}
vec2 deltaA = deltaA3.xy / width;
vec2 deltaB = deltaB3.xy / width;
float lenA = length(deltaA);
float lenB = length(deltaB);
vec2 dirA = lenA > 0. ? normalize(deltaA) : vec2(0.0, 0.0);
vec2 dirB = lenB > 0. ? normalize(deltaB) : vec2(0.0, 0.0);
vec2 perpA = vec2(-dirA.y, dirA.x);
vec2 perpB = vec2(-dirB.y, dirB.x);
vec2 tangent = dirA + dirB;
tangent = length(tangent) > 0. ? normalize(tangent) : perpA;
vec2 miterVec = vec2(-tangent.y, tangent.x);
vec2 dir = isEnd ? dirA : dirB;
vec2 perp = isEnd ? perpA : perpB;
float L = isEnd ? lenA : lenB;
float sinHalfA = abs(dot(miterVec, perp));
float cosHalfA = abs(dot(dirA, miterVec));
float turnDirection = flipIfTrue(dirA.x * dirB.y >= dirA.y * dirB.x);
float cornerPosition = sideOfPath * turnDirection;
float miterSize = 1.0 / max(sinHalfA, EPSILON);
miterSize = mix(
min(miterSize, max(lenA, lenB) / max(cosHalfA, EPSILON)),
miterSize,
step(0.0, cornerPosition)
);
vec2 offsetVec = mix(miterVec * miterSize, perp, step(0.5, cornerPosition))
* (sideOfPath + isJoint * turnDirection);
bool isStartCap = lenA == 0.0 || (!isEnd && (instanceTypes == 1.0 || instanceTypes == 3.0));
bool isEndCap = lenB == 0.0 || (isEnd && (instanceTypes == 2.0 || instanceTypes == 3.0));
bool isCap = isStartCap || isEndCap;
if (isCap) {
offsetVec = mix(perp * sideOfPath, dir * path.capType * 4.0 * flipIfTrue(isStartCap), isJoint);
vJointType = path.capType;
} else {
vJointType = path.jointType;
}
vPathLength = L;
vCornerOffset = offsetVec;
vMiterLength = dot(vCornerOffset, miterVec * turnDirection);
vMiterLength = isCap ? isJoint : vMiterLength;
vec2 offsetFromStartOfPath = vCornerOffset + deltaA * float(isEnd);
vPathPosition = vec2(
dot(offsetFromStartOfPath, perp),
dot(offsetFromStartOfPath, dir)
);
geometry.uv = vPathPosition;
float isValid = step(instanceTypes, 3.5);
vec3 offset = vec3(offsetVec * width * isValid, 0.0);
if (needsRotation) {
offset = rotationMatrix * offset;
}
return offset;
}
void clipLine(inout vec4 position, vec4 refPosition) {
if (position.w < EPSILON) {
float r = (EPSILON - refPosition.w) / (position.w - refPosition.w);
position = refPosition + (position - refPosition) * r;
}
}
void main() {
geometry.pickingColor = instancePickingColors;
vColor = vec4(instanceColors.rgb, instanceColors.a * layer.opacity);
float isEnd = positions.x;
vec3 prevPosition = mix(instanceLeftPositions, instanceStartPositions, isEnd);
vec3 prevPosition64Low = mix(instanceLeftPositions64Low, instanceStartPositions64Low, isEnd);
vec3 currPosition = mix(instanceStartPositions, instanceEndPositions, isEnd);
vec3 currPosition64Low = mix(instanceStartPositions64Low, instanceEndPositions64Low, isEnd);
vec3 nextPosition = mix(instanceEndPositions, instanceRightPositions, isEnd);
vec3 nextPosition64Low = mix(instanceEndPositions64Low, instanceRightPositions64Low, isEnd);
geometry.worldPosition = currPosition;
vec2 widthPixels = vec2(clamp(
project_size_to_pixel(instanceStrokeWidths * path.widthScale, path.widthUnits),
path.widthMinPixels, path.widthMaxPixels) / 2.0);
vec3 width;
if (path.billboard) {
vec4 prevPositionScreen = project_position_to_clipspace(prevPosition, prevPosition64Low, ZERO_OFFSET);
vec4 currPositionScreen = project_position_to_clipspace(currPosition, currPosition64Low, ZERO_OFFSET, geometry.position);
vec4 nextPositionScreen = project_position_to_clipspace(nextPosition, nextPosition64Low, ZERO_OFFSET);
clipLine(prevPositionScreen, currPositionScreen);
clipLine(nextPositionScreen, currPositionScreen);
clipLine(currPositionScreen, mix(nextPositionScreen, prevPositionScreen, isEnd));
width = vec3(widthPixels, 0.0);
DECKGL_FILTER_SIZE(width, geometry);
vec3 offset = getLineJoinOffset(
prevPositionScreen.xyz / prevPositionScreen.w,
currPositionScreen.xyz / currPositionScreen.w,
nextPositionScreen.xyz / nextPositionScreen.w,
project_pixel_size_to_clipspace(width.xy)
);
DECKGL_FILTER_GL_POSITION(currPositionScreen, geometry);
gl_Position = vec4(currPositionScreen.xyz + offset * currPositionScreen.w, currPositionScreen.w);
} else {
prevPosition = project_position(prevPosition, prevPosition64Low);
currPosition = project_position(currPosition, currPosition64Low);
nextPosition = project_position(nextPosition, nextPosition64Low);
width = vec3(project_pixel_size(widthPixels), 0.0);
DECKGL_FILTER_SIZE(width, geometry);
vec3 offset = getLineJoinOffset(prevPosition, currPosition, nextPosition, width.xy);
geometry.position = vec4(currPosition + offset, 1.0);
gl_Position = project_common_position_to_clipspace(geometry.position);
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
}
DECKGL_FILTER_COLOR(vColor, geometry);
}
`,Sz=`#version 300 es
#define SHADER_NAME path-layer-fragment-shader
precision highp float;
in vec4 vColor;
in vec2 vCornerOffset;
in float vMiterLength;
in vec2 vPathPosition;
in float vPathLength;
in float vJointType;
out vec4 fragColor;
void main(void) {
geometry.uv = vPathPosition;
if (vPathPosition.y < 0.0 || vPathPosition.y > vPathLength) {
if (vJointType > 0.5 && length(vCornerOffset) > 1.0) {
discard;
}
if (vJointType < 0.5 && vMiterLength > path.miterLimit + 1.0) {
discard;
}
}
fragColor = vColor;
DECKGL_FILTER_COLOR(fragColor, geometry);
}
`,NT=[0,0,0,255],Az={widthUnits:"meters",widthScale:{type:"number",min:0,value:1},widthMinPixels:{type:"number",min:0,value:0},widthMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},jointRounded:!1,capRounded:!1,miterLimit:{type:"number",min:0,value:4},billboard:!1,_pathType:null,getPath:{type:"accessor",value:i=>i.path},getColor:{type:"accessor",value:NT},getWidth:{type:"accessor",value:1},rounded:{deprecatedFor:["jointRounded","capRounded"]}},Rm={enter:(i,e)=>e.length?e.subarray(e.length-i.length):i};class ky extends Cn{getShaders(){return super.getShaders({vs:Tz,fs:Sz,modules:[Mc,Rc,wz]})}get wrapLongitude(){return!1}getBounds(){return this.getAttributeManager()?.getBounds(["vertexPositions"])}initializeState(){this.getAttributeManager().addInstanced({vertexPositions:{size:3,vertexOffset:1,type:"float64",fp64:this.use64bitPositions(),transition:Rm,accessor:"getPath",update:this.calculatePositions,noAlloc:!0,shaderAttributes:{instanceLeftPositions:{vertexOffset:0},instanceStartPositions:{vertexOffset:1},instanceEndPositions:{vertexOffset:2},instanceRightPositions:{vertexOffset:3}}},instanceTypes:{size:1,type:"uint8",update:this.calculateSegmentTypes,noAlloc:!0},instanceStrokeWidths:{size:1,accessor:"getWidth",transition:Rm,defaultValue:1},instanceColors:{size:this.props.colorFormat.length,type:"unorm8",accessor:"getColor",transition:Rm,defaultValue:NT},instancePickingColors:{size:4,type:"uint8",accessor:(r,{index:s,target:a})=>this.encodePickingColor(r&&r.__source?r.__source.index:s,a)}}),this.setState({pathTesselator:new bz({fp64:this.use64bitPositions()})})}updateState(e){super.updateState(e);const{props:t,changeFlags:r}=e,s=this.getAttributeManager();if(r.dataChanged||r.updateTriggersChanged&&(r.updateTriggersChanged.all||r.updateTriggersChanged.getPath)){const{pathTesselator:u}=this.state,l=t.data.attributes||{};u.updateGeometry({data:t.data,geometryBuffer:l.getPath,buffers:l,normalize:!t._pathType,loop:t._pathType==="loop",getGeometry:t.getPath,positionFormat:t.positionFormat,wrapLongitude:t.wrapLongitude,resolution:this.context.viewport.resolution,dataChanged:r.dataChanged}),this.setState({numInstances:u.instanceCount,startIndices:u.vertexStarts}),r.dataChanged||s.invalidateAll()}r.extensionsChanged&&(this.state.model?.destroy(),this.state.model=this._getModel(),s.invalidateAll())}getPickingInfo(e){const t=super.getPickingInfo(e),{index:r}=t,s=this.props.data;return s[0]&&s[0].__source&&(t.object=s.find(a=>a.__source.index===r)),t}disablePickingIndex(e){const t=this.props.data;if(t[0]&&t[0].__source)for(let r=0;r<t.length;r++)t[r].__source.index===e&&this._disablePickingIndex(r);else super.disablePickingIndex(e)}draw({uniforms:e}){const{jointRounded:t,capRounded:r,billboard:s,miterLimit:a,widthUnits:u,widthScale:l,widthMinPixels:g,widthMaxPixels:v}=this.props,T=this.state.model,S={jointType:Number(t),capType:Number(r),billboard:s,widthUnits:to[u],widthScale:l,miterLimit:a,widthMinPixels:g,widthMaxPixels:v};T.shaderInputs.setProps({path:S}),T.draw(this.context.renderPass)}_getModel(){const e=[0,1,2,1,4,2,1,3,4,3,5,4],t=[0,0,0,-1,0,1,1,-1,1,1,1,0];return new Ks(this.context.device,{...this.getShaders(),id:this.props.id,bufferLayout:this.getAttributeManager().getBufferLayouts(),geometry:new Ac({topology:"triangle-list",attributes:{indices:new Uint16Array(e),positions:{value:new Float32Array(t),size:2}}}),isInstanced:!0})}calculatePositions(e){const{pathTesselator:t}=this.state;e.startIndices=t.vertexStarts,e.value=t.get("positions")}calculateSegmentTypes(e){const{pathTesselator:t}=this.state;e.startIndices=t.vertexStarts,e.value=t.get("segmentTypes")}}ky.defaultProps=Az;ky.layerName="PathLayer";var _f={exports:{}},pw;function Ez(){if(pw)return _f.exports;pw=1,_f.exports=i,_f.exports.default=i;function i(ie,ge,ce){ce=ce||2;var ke=ge&&ge.length,Be=ke?ge[0]*ce:ie.length,Ve=e(ie,0,Be,ce,!0),We=[];if(!Ve||Ve.next===Ve.prev)return We;var tt,wt,_t,$t,kt,Bt,Kt;if(ke&&(Ve=g(ie,ge,Ve,ce)),ie.length>80*ce){tt=_t=ie[0],wt=$t=ie[1];for(var Et=ce;Et<Be;Et+=ce)kt=ie[Et],Bt=ie[Et+1],kt<tt&&(tt=kt),Bt<wt&&(wt=Bt),kt>_t&&(_t=kt),Bt>$t&&($t=Bt);Kt=Math.max(_t-tt,$t-wt),Kt=Kt!==0?32767/Kt:0}return r(Ve,We,ce,tt,wt,Kt,0),We}function e(ie,ge,ce,ke,Be){var Ve,We;if(Be===ve(ie,ge,ce,ke)>0)for(Ve=ge;Ve<ce;Ve+=ke)We=ft(Ve,ie[Ve],ie[Ve+1],We);else for(Ve=ce-ke;Ve>=ge;Ve-=ke)We=ft(Ve,ie[Ve],ie[Ve+1],We);return We&&me(We,We.next)&&(Ke(We),We=We.next),We}function t(ie,ge){if(!ie)return ie;ge||(ge=ie);var ce=ie,ke;do if(ke=!1,!ce.steiner&&(me(ce,ce.next)||te(ce.prev,ce,ce.next)===0)){if(Ke(ce),ce=ge=ce.prev,ce===ce.next)break;ke=!0}else ce=ce.next;while(ke||ce!==ge);return ge}function r(ie,ge,ce,ke,Be,Ve,We){if(ie){!We&&Ve&&O(ie,ke,Be,Ve);for(var tt=ie,wt,_t;ie.prev!==ie.next;){if(wt=ie.prev,_t=ie.next,Ve?a(ie,ke,Be,Ve):s(ie)){ge.push(wt.i/ce|0),ge.push(ie.i/ce|0),ge.push(_t.i/ce|0),Ke(ie),ie=_t.next,tt=_t.next;continue}if(ie=_t,ie===tt){We?We===1?(ie=u(t(ie),ge,ce),r(ie,ge,ce,ke,Be,Ve,2)):We===2&&l(ie,ge,ce,ke,Be,Ve):r(t(ie),ge,ce,ke,Be,Ve,1);break}}}}function s(ie){var ge=ie.prev,ce=ie,ke=ie.next;if(te(ge,ce,ke)>=0)return!1;for(var Be=ge.x,Ve=ce.x,We=ke.x,tt=ge.y,wt=ce.y,_t=ke.y,$t=Be<Ve?Be<We?Be:We:Ve<We?Ve:We,kt=tt<wt?tt<_t?tt:_t:wt<_t?wt:_t,Bt=Be>Ve?Be>We?Be:We:Ve>We?Ve:We,Kt=tt>wt?tt>_t?tt:_t:wt>_t?wt:_t,Et=ke.next;Et!==ge;){if(Et.x>=$t&&Et.x<=Bt&&Et.y>=kt&&Et.y<=Kt&&Q(Be,tt,Ve,wt,We,_t,Et.x,Et.y)&&te(Et.prev,Et,Et.next)>=0)return!1;Et=Et.next}return!0}function a(ie,ge,ce,ke){var Be=ie.prev,Ve=ie,We=ie.next;if(te(Be,Ve,We)>=0)return!1;for(var tt=Be.x,wt=Ve.x,_t=We.x,$t=Be.y,kt=Ve.y,Bt=We.y,Kt=tt<wt?tt<_t?tt:_t:wt<_t?wt:_t,Et=$t<kt?$t<Bt?$t:Bt:kt<Bt?kt:Bt,Li=tt>wt?tt>_t?tt:_t:wt>_t?wt:_t,bi=$t>kt?$t>Bt?$t:Bt:kt>Bt?kt:Bt,Ri=W(Kt,Et,ge,ce,ke),Fi=W(Li,bi,ge,ce,ke),Lt=ie.prevZ,Ce=ie.nextZ;Lt&&Lt.z>=Ri&&Ce&&Ce.z<=Fi;){if(Lt.x>=Kt&&Lt.x<=Li&&Lt.y>=Et&&Lt.y<=bi&&Lt!==Be&&Lt!==We&&Q(tt,$t,wt,kt,_t,Bt,Lt.x,Lt.y)&&te(Lt.prev,Lt,Lt.next)>=0||(Lt=Lt.prevZ,Ce.x>=Kt&&Ce.x<=Li&&Ce.y>=Et&&Ce.y<=bi&&Ce!==Be&&Ce!==We&&Q(tt,$t,wt,kt,_t,Bt,Ce.x,Ce.y)&&te(Ce.prev,Ce,Ce.next)>=0))return!1;Ce=Ce.nextZ}for(;Lt&&Lt.z>=Ri;){if(Lt.x>=Kt&&Lt.x<=Li&&Lt.y>=Et&&Lt.y<=bi&&Lt!==Be&&Lt!==We&&Q(tt,$t,wt,kt,_t,Bt,Lt.x,Lt.y)&&te(Lt.prev,Lt,Lt.next)>=0)return!1;Lt=Lt.prevZ}for(;Ce&&Ce.z<=Fi;){if(Ce.x>=Kt&&Ce.x<=Li&&Ce.y>=Et&&Ce.y<=bi&&Ce!==Be&&Ce!==We&&Q(tt,$t,wt,kt,_t,Bt,Ce.x,Ce.y)&&te(Ce.prev,Ce,Ce.next)>=0)return!1;Ce=Ce.nextZ}return!0}function u(ie,ge,ce){var ke=ie;do{var Be=ke.prev,Ve=ke.next.next;!me(Be,Ve)&&we(Be,ke,ke.next,Ve)&&He(Be,Ve)&&He(Ve,Be)&&(ge.push(Be.i/ce|0),ge.push(ke.i/ce|0),ge.push(Ve.i/ce|0),Ke(ke),Ke(ke.next),ke=ie=Ve),ke=ke.next}while(ke!==ie);return t(ke)}function l(ie,ge,ce,ke,Be,Ve){var We=ie;do{for(var tt=We.next.next;tt!==We.prev;){if(We.i!==tt.i&&ae(We,tt)){var wt=Ye(We,tt);We=t(We,We.next),wt=t(wt,wt.next),r(We,ge,ce,ke,Be,Ve,0),r(wt,ge,ce,ke,Be,Ve,0);return}tt=tt.next}We=We.next}while(We!==ie)}function g(ie,ge,ce,ke){var Be=[],Ve,We,tt,wt,_t;for(Ve=0,We=ge.length;Ve<We;Ve++)tt=ge[Ve]*ke,wt=Ve<We-1?ge[Ve+1]*ke:ie.length,_t=e(ie,tt,wt,ke,!1),_t===_t.next&&(_t.steiner=!0),Be.push(G(_t));for(Be.sort(v),Ve=0;Ve<Be.length;Ve++)ce=T(Be[Ve],ce);return ce}function v(ie,ge){return ie.x-ge.x}function T(ie,ge){var ce=S(ie,ge);if(!ce)return ge;var ke=Ye(ce,ie);return t(ke,ke.next),t(ce,ce.next)}function S(ie,ge){var ce=ge,ke=ie.x,Be=ie.y,Ve=-1/0,We;do{if(Be<=ce.y&&Be>=ce.next.y&&ce.next.y!==ce.y){var tt=ce.x+(Be-ce.y)*(ce.next.x-ce.x)/(ce.next.y-ce.y);if(tt<=ke&&tt>Ve&&(Ve=tt,We=ce.x<ce.next.x?ce:ce.next,tt===ke))return We}ce=ce.next}while(ce!==ge);if(!We)return null;var wt=We,_t=We.x,$t=We.y,kt=1/0,Bt;ce=We;do ke>=ce.x&&ce.x>=_t&&ke!==ce.x&&Q(Be<$t?ke:Ve,Be,_t,$t,Be<$t?Ve:ke,Be,ce.x,ce.y)&&(Bt=Math.abs(Be-ce.y)/(ke-ce.x),He(ce,ie)&&(Bt<kt||Bt===kt&&(ce.x>We.x||ce.x===We.x&&P(We,ce)))&&(We=ce,kt=Bt)),ce=ce.next;while(ce!==wt);return We}function P(ie,ge){return te(ie.prev,ie,ge.prev)<0&&te(ge.next,ie,ie.next)<0}function O(ie,ge,ce,ke){var Be=ie;do Be.z===0&&(Be.z=W(Be.x,Be.y,ge,ce,ke)),Be.prevZ=Be.prev,Be.nextZ=Be.next,Be=Be.next;while(Be!==ie);Be.prevZ.nextZ=null,Be.prevZ=null,$(Be)}function $(ie){var ge,ce,ke,Be,Ve,We,tt,wt,_t=1;do{for(ce=ie,ie=null,Ve=null,We=0;ce;){for(We++,ke=ce,tt=0,ge=0;ge<_t&&(tt++,ke=ke.nextZ,!!ke);ge++);for(wt=_t;tt>0||wt>0&&ke;)tt!==0&&(wt===0||!ke||ce.z<=ke.z)?(Be=ce,ce=ce.nextZ,tt--):(Be=ke,ke=ke.nextZ,wt--),Ve?Ve.nextZ=Be:ie=Be,Be.prevZ=Ve,Ve=Be;ce=ke}Ve.nextZ=null,_t*=2}while(We>1);return ie}function W(ie,ge,ce,ke,Be){return ie=(ie-ce)*Be|0,ge=(ge-ke)*Be|0,ie=(ie|ie<<8)&16711935,ie=(ie|ie<<4)&252645135,ie=(ie|ie<<2)&858993459,ie=(ie|ie<<1)&1431655765,ge=(ge|ge<<8)&16711935,ge=(ge|ge<<4)&252645135,ge=(ge|ge<<2)&858993459,ge=(ge|ge<<1)&1431655765,ie|ge<<1}function G(ie){var ge=ie,ce=ie;do(ge.x<ce.x||ge.x===ce.x&&ge.y<ce.y)&&(ce=ge),ge=ge.next;while(ge!==ie);return ce}function Q(ie,ge,ce,ke,Be,Ve,We,tt){return(Be-We)*(ge-tt)>=(ie-We)*(Ve-tt)&&(ie-We)*(ke-tt)>=(ce-We)*(ge-tt)&&(ce-We)*(Ve-tt)>=(Be-We)*(ke-tt)}function ae(ie,ge){return ie.next.i!==ge.i&&ie.prev.i!==ge.i&&!it(ie,ge)&&(He(ie,ge)&&He(ge,ie)&&ht(ie,ge)&&(te(ie.prev,ie,ge.prev)||te(ie,ge.prev,ge))||me(ie,ge)&&te(ie.prev,ie,ie.next)>0&&te(ge.prev,ge,ge.next)>0)}function te(ie,ge,ce){return(ge.y-ie.y)*(ce.x-ge.x)-(ge.x-ie.x)*(ce.y-ge.y)}function me(ie,ge){return ie.x===ge.x&&ie.y===ge.y}function we(ie,ge,ce,ke){var Be=Je(te(ie,ge,ce)),Ve=Je(te(ie,ge,ke)),We=Je(te(ce,ke,ie)),tt=Je(te(ce,ke,ge));return!!(Be!==Ve&&We!==tt||Be===0&&Oe(ie,ce,ge)||Ve===0&&Oe(ie,ke,ge)||We===0&&Oe(ce,ie,ke)||tt===0&&Oe(ce,ge,ke))}function Oe(ie,ge,ce){return ge.x<=Math.max(ie.x,ce.x)&&ge.x>=Math.min(ie.x,ce.x)&&ge.y<=Math.max(ie.y,ce.y)&&ge.y>=Math.min(ie.y,ce.y)}function Je(ie){return ie>0?1:ie<0?-1:0}function it(ie,ge){var ce=ie;do{if(ce.i!==ie.i&&ce.next.i!==ie.i&&ce.i!==ge.i&&ce.next.i!==ge.i&&we(ce,ce.next,ie,ge))return!0;ce=ce.next}while(ce!==ie);return!1}function He(ie,ge){return te(ie.prev,ie,ie.next)<0?te(ie,ge,ie.next)>=0&&te(ie,ie.prev,ge)>=0:te(ie,ge,ie.prev)<0||te(ie,ie.next,ge)<0}function ht(ie,ge){var ce=ie,ke=!1,Be=(ie.x+ge.x)/2,Ve=(ie.y+ge.y)/2;do ce.y>Ve!=ce.next.y>Ve&&ce.next.y!==ce.y&&Be<(ce.next.x-ce.x)*(Ve-ce.y)/(ce.next.y-ce.y)+ce.x&&(ke=!ke),ce=ce.next;while(ce!==ie);return ke}function Ye(ie,ge){var ce=new Ze(ie.i,ie.x,ie.y),ke=new Ze(ge.i,ge.x,ge.y),Be=ie.next,Ve=ge.prev;return ie.next=ge,ge.prev=ie,ce.next=Be,Be.prev=ce,ke.next=ce,ce.prev=ke,Ve.next=ke,ke.prev=Ve,ke}function ft(ie,ge,ce,ke){var Be=new Ze(ie,ge,ce);return ke?(Be.next=ke.next,Be.prev=ke,ke.next.prev=Be,ke.next=Be):(Be.prev=Be,Be.next=Be),Be}function Ke(ie){ie.next.prev=ie.prev,ie.prev.next=ie.next,ie.prevZ&&(ie.prevZ.nextZ=ie.nextZ),ie.nextZ&&(ie.nextZ.prevZ=ie.prevZ)}function Ze(ie,ge,ce){this.i=ie,this.x=ge,this.y=ce,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}i.deviation=function(ie,ge,ce,ke){var Be=ge&&ge.length,Ve=Be?ge[0]*ce:ie.length,We=Math.abs(ve(ie,0,Ve,ce));if(Be)for(var tt=0,wt=ge.length;tt<wt;tt++){var _t=ge[tt]*ce,$t=tt<wt-1?ge[tt+1]*ce:ie.length;We-=Math.abs(ve(ie,_t,$t,ce))}var kt=0;for(tt=0;tt<ke.length;tt+=3){var Bt=ke[tt]*ce,Kt=ke[tt+1]*ce,Et=ke[tt+2]*ce;kt+=Math.abs((ie[Bt]-ie[Et])*(ie[Kt+1]-ie[Bt+1])-(ie[Bt]-ie[Kt])*(ie[Et+1]-ie[Bt+1]))}return We===0&&kt===0?0:Math.abs((kt-We)/We)};function ve(ie,ge,ce,ke){for(var Be=0,Ve=ge,We=ce-ke;Ve<ce;Ve+=ke)Be+=(ie[We]-ie[Ve])*(ie[Ve+1]+ie[We+1]),We=Ve;return Be}return i.flatten=function(ie){for(var ge=ie[0][0].length,ce={vertices:[],holes:[],dimensions:ge},ke=0,Be=0;Be<ie.length;Be++){for(var Ve=0;Ve<ie[Be].length;Ve++)for(var We=0;We<ge;We++)ce.vertices.push(ie[Be][Ve][We]);Be>0&&(ke+=ie[Be-1].length,ce.holes.push(ke))}return ce},_f.exports}var Iz=Ez();const Cz=Qw(Iz),yf=RT.CLOCKWISE,gw=RT.COUNTER_CLOCKWISE,Jo={};function Pz(i){if(i=i&&i.positions||i,!Array.isArray(i)&&!ArrayBuffer.isView(i))throw new Error("invalid polygon")}function mh(i){return"positions"in i?i.positions:i}function Vf(i){return"holeIndices"in i?i.holeIndices:null}function Mz(i){return Array.isArray(i[0])}function Rz(i){return i.length>=1&&i[0].length>=2&&Number.isFinite(i[0][0])}function kz(i){const e=i[0],t=i[i.length-1];return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}function Dz(i,e,t,r){for(let s=0;s<e;s++)if(i[t+s]!==i[r-e+s])return!1;return!0}function mw(i,e,t,r,s){let a=e;const u=t.length;for(let l=0;l<u;l++)for(let g=0;g<r;g++)i[a++]=t[l][g]||0;if(!kz(t))for(let l=0;l<r;l++)i[a++]=t[0][l]||0;return Jo.start=e,Jo.end=a,Jo.size=r,kT(i,s,Jo),a}function _w(i,e,t,r,s=0,a,u){a=a||t.length;const l=a-s;if(l<=0)return e;let g=e;for(let v=0;v<l;v++)i[g++]=t[s+v];if(!Dz(t,r,s,a))for(let v=0;v<r;v++)i[g++]=t[s+v];return Jo.start=e,Jo.end=g,Jo.size=r,kT(i,u,Jo),g}function Oz(i,e){Pz(i);const t=[],r=[];if("positions"in i){const{positions:s,holeIndices:a}=i;if(a){let u=0;for(let l=0;l<=a.length;l++)u=_w(t,u,s,e,a[l-1],a[l],l===0?yf:gw),r.push(u);return r.pop(),{positions:t,holeIndices:r}}i=s}if(!Mz(i))return _w(t,0,i,e,0,t.length,yf),t;if(!Rz(i)){let s=0;for(const[a,u]of i.entries())s=mw(t,s,u,e,a===0?yf:gw),r.push(s);return r.pop(),{positions:t,holeIndices:r}}return mw(t,0,i,e,yf),t}function km(i,e,t){const r=i.length/3;let s=0;for(let a=0;a<r;a++){const u=(a+1)%r;s+=i[a*3+e]*i[u*3+t],s-=i[u*3+e]*i[a*3+t]}return Math.abs(s/2)}function yw(i,e,t,r){const s=i.length/3;for(let a=0;a<s;a++){const u=a*3,l=i[u+0],g=i[u+1],v=i[u+2];i[u+e]=l,i[u+t]=g,i[u+r]=v}}function Lz(i,e,t,r){let s=Vf(i);s&&(s=s.map(l=>l/e));let a=mh(i);const u=r&&e===3;if(t){const l=a.length;a=a.slice();const g=[];for(let v=0;v<l;v+=e){g[0]=a[v],g[1]=a[v+1],u&&(g[2]=a[v+2]);const T=t(g);a[v]=T[0],a[v+1]=T[1],u&&(a[v+2]=T[2])}}if(u){const l=km(a,0,1),g=km(a,0,2),v=km(a,1,2);if(!l&&!g&&!v)return[];l>g&&l>v||(g>v?(t||(a=a.slice()),yw(a,0,2,1)):(t||(a=a.slice()),yw(a,2,0,1)))}return Cz(a,s,e)}class Fz extends vT{constructor(e){const{fp64:t,IndexType:r=Uint32Array}=e;super({...e,attributes:{positions:{size:3,type:t?Float64Array:Float32Array},vertexValid:{type:Uint16Array,size:1},indices:{type:r,size:1}}})}get(e){const{attributes:t}=this;return e==="indices"?t.indices&&t.indices.subarray(0,this.vertexCount):t[e]}updateGeometry(e){super.updateGeometry(e);const t=this.buffers.indices;if(t)this.vertexCount=(t.value||t).length;else if(this.data&&!this.getGeometry)throw new Error("missing indices buffer")}normalizeGeometry(e){if(this.normalize){const t=Oz(e,this.positionSize);return this.opts.resolution?OT(mh(t),Vf(t),{size:this.positionSize,gridResolution:this.opts.resolution,edgeTypes:!0}):this.opts.wrapLongitude?gz(mh(t),Vf(t),{size:this.positionSize,maxLatitude:86,edgeTypes:!0}):t}return e}getGeometrySize(e){if(xw(e)){let t=0;for(const r of e)t+=this.getGeometrySize(r);return t}return mh(e).length/this.positionSize}getGeometryFromBuffer(e){return this.normalize||!this.buffers.indices?super.getGeometryFromBuffer(e):null}updateGeometryAttributes(e,t){if(e&&xw(e))for(const r of e){const s=this.getGeometrySize(r);t.geometrySize=s,this.updateGeometryAttributes(r,t),t.vertexStart+=s,t.indexStart=this.indexStarts[t.geometryIndex+1]}else{const r=e;this._updateIndices(r,t),this._updatePositions(r,t),this._updateVertexValid(r,t)}}_updateIndices(e,{geometryIndex:t,vertexStart:r,indexStart:s}){const{attributes:a,indexStarts:u,typedArrayManager:l}=this;let g=a.indices;if(!g||!e)return;let v=s;const T=Lz(e,this.positionSize,this.opts.preproject,this.opts.full3d);g=l.allocate(g,s+T.length,{copy:!0});for(let S=0;S<T.length;S++)g[v++]=T[S]+r;u[t+1]=s+T.length,a.indices=g}_updatePositions(e,{vertexStart:t,geometrySize:r}){const{attributes:{positions:s},positionSize:a}=this;if(!s||!e)return;const u=mh(e);for(let l=t,g=0;g<r;l++,g++){const v=u[g*a],T=u[g*a+1],S=a>2?u[g*a+2]:0;s[l*3]=v,s[l*3+1]=T,s[l*3+2]=S}}_updateVertexValid(e,{vertexStart:t,geometrySize:r}){const{positionSize:s}=this,a=this.attributes.vertexValid,u=e&&Vf(e);if(e&&e.edgeTypes?a.set(e.edgeTypes,t):a.fill(1,t,t+r),u)for(let l=0;l<u.length;l++)a[t+u[l]/s-1]=0;a[t+r-1]=0}}function xw(i){return Array.isArray(i)&&i.length>0&&!Number.isFinite(i[0])}const vw=`uniform solidPolygonUniforms {
  bool extruded;
  bool isWireframe;
  float elevationScale;
} solidPolygon;
`,Bz={name:"solidPolygon",vs:vw,fs:vw,uniformTypes:{extruded:"f32",isWireframe:"f32",elevationScale:"f32"}},zT=`in vec4 fillColors;
in vec4 lineColors;
in vec3 pickingColors;
out vec4 vColor;
struct PolygonProps {
vec3 positions;
vec3 positions64Low;
vec3 normal;
float elevations;
};
vec3 project_offset_normal(vec3 vector) {
if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT ||
project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT_OFFSETS) {
return normalize(vector * project.commonUnitsPerWorldUnit);
}
return project_normal(vector);
}
void calculatePosition(PolygonProps props) {
vec3 pos = props.positions;
vec3 pos64Low = props.positions64Low;
vec3 normal = props.normal;
vec4 colors = solidPolygon.isWireframe ? lineColors : fillColors;
geometry.worldPosition = props.positions;
geometry.pickingColor = pickingColors;
if (solidPolygon.extruded) {
pos.z += props.elevations * solidPolygon.elevationScale;
}
gl_Position = project_position_to_clipspace(pos, pos64Low, vec3(0.), geometry.position);
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
if (solidPolygon.extruded) {
#ifdef IS_SIDE_VERTEX
normal = project_offset_normal(normal);
#else
normal = project_normal(normal);
#endif
geometry.normal = normal;
vec3 lightColor = lighting_getLightColor(colors.rgb, project.cameraPosition, geometry.position.xyz, geometry.normal);
vColor = vec4(lightColor, colors.a * layer.opacity);
} else {
vColor = vec4(colors.rgb, colors.a * layer.opacity);
}
DECKGL_FILTER_COLOR(vColor, geometry);
}
`,Nz=`#version 300 es
#define SHADER_NAME solid-polygon-layer-vertex-shader
in vec3 vertexPositions;
in vec3 vertexPositions64Low;
in float elevations;
${zT}
void main(void) {
PolygonProps props;
props.positions = vertexPositions;
props.positions64Low = vertexPositions64Low;
props.elevations = elevations;
props.normal = vec3(0.0, 0.0, 1.0);
calculatePosition(props);
}
`,zz=`#version 300 es
#define SHADER_NAME solid-polygon-layer-vertex-shader-side
#define IS_SIDE_VERTEX
in vec2 positions;
in vec3 vertexPositions;
in vec3 nextVertexPositions;
in vec3 vertexPositions64Low;
in vec3 nextVertexPositions64Low;
in float elevations;
in float instanceVertexValid;
${zT}
void main(void) {
if(instanceVertexValid < 0.5){
gl_Position = vec4(0.);
return;
}
PolygonProps props;
vec3 pos;
vec3 pos64Low;
vec3 nextPos;
vec3 nextPos64Low;
#if RING_WINDING_ORDER_CW == 1
pos = vertexPositions;
pos64Low = vertexPositions64Low;
nextPos = nextVertexPositions;
nextPos64Low = nextVertexPositions64Low;
#else
pos = nextVertexPositions;
pos64Low = nextVertexPositions64Low;
nextPos = vertexPositions;
nextPos64Low = vertexPositions64Low;
#endif
props.positions = mix(pos, nextPos, positions.x);
props.positions64Low = mix(pos64Low, nextPos64Low, positions.x);
props.normal = vec3(
pos.y - nextPos.y + (pos64Low.y - nextPos64Low.y),
nextPos.x - pos.x + (nextPos64Low.x - pos64Low.x),
0.0);
props.elevations = elevations * positions.y;
calculatePosition(props);
}
`,Uz=`#version 300 es
#define SHADER_NAME solid-polygon-layer-fragment-shader
precision highp float;
in vec4 vColor;
out vec4 fragColor;
void main(void) {
fragColor = vColor;
geometry.uv = vec2(0.);
DECKGL_FILTER_COLOR(fragColor, geometry);
}
`,hp=[0,0,0,255],Vz={filled:!0,extruded:!1,wireframe:!1,_normalize:!0,_windingOrder:"CW",_full3d:!1,elevationScale:{type:"number",min:0,value:1},getPolygon:{type:"accessor",value:i=>i.polygon},getElevation:{type:"accessor",value:1e3},getFillColor:{type:"accessor",value:hp},getLineColor:{type:"accessor",value:hp},material:!0},xf={enter:(i,e)=>e.length?e.subarray(e.length-i.length):i};class Dy extends Cn{getShaders(e){return super.getShaders({vs:e==="top"?Nz:zz,fs:Uz,defines:{RING_WINDING_ORDER_CW:!this.props._normalize&&this.props._windingOrder==="CCW"?0:1},modules:[Mc,T2,Rc,Bz]})}get wrapLongitude(){return!1}getBounds(){return this.getAttributeManager()?.getBounds(["vertexPositions"])}initializeState(){const{viewport:e}=this.context;let{coordinateSystem:t}=this.props;const{_full3d:r}=this.props;e.isGeospatial&&t===li.DEFAULT&&(t=li.LNGLAT);let s;t===li.LNGLAT&&(r?s=e.projectPosition.bind(e):s=e.projectFlat.bind(e)),this.setState({numInstances:0,polygonTesselator:new Fz({preproject:s,fp64:this.use64bitPositions(),IndexType:Uint32Array})});const a=this.getAttributeManager(),u=!0;a.remove(["instancePickingColors"]),a.add({indices:{size:1,isIndexed:!0,update:this.calculateIndices,noAlloc:u},vertexPositions:{size:3,type:"float64",stepMode:"dynamic",fp64:this.use64bitPositions(),transition:xf,accessor:"getPolygon",update:this.calculatePositions,noAlloc:u,shaderAttributes:{nextVertexPositions:{vertexOffset:1}}},instanceVertexValid:{size:1,type:"uint16",stepMode:"instance",update:this.calculateVertexValid,noAlloc:u},elevations:{size:1,stepMode:"dynamic",transition:xf,accessor:"getElevation"},fillColors:{size:this.props.colorFormat.length,type:"unorm8",stepMode:"dynamic",transition:xf,accessor:"getFillColor",defaultValue:hp},lineColors:{size:this.props.colorFormat.length,type:"unorm8",stepMode:"dynamic",transition:xf,accessor:"getLineColor",defaultValue:hp},pickingColors:{size:4,type:"uint8",stepMode:"dynamic",accessor:(l,{index:g,target:v})=>this.encodePickingColor(l&&l.__source?l.__source.index:g,v)}})}getPickingInfo(e){const t=super.getPickingInfo(e),{index:r}=t,s=this.props.data;return s[0]&&s[0].__source&&(t.object=s.find(a=>a.__source.index===r)),t}disablePickingIndex(e){const t=this.props.data;if(t[0]&&t[0].__source)for(let r=0;r<t.length;r++)t[r].__source.index===e&&this._disablePickingIndex(r);else super.disablePickingIndex(e)}draw({uniforms:e}){const{extruded:t,filled:r,wireframe:s,elevationScale:a}=this.props,{topModel:u,sideModel:l,wireframeModel:g,polygonTesselator:v}=this.state,T={extruded:!!t,elevationScale:a,isWireframe:!1};g&&s&&(g.setInstanceCount(v.instanceCount-1),g.shaderInputs.setProps({solidPolygon:{...T,isWireframe:!0}}),g.draw(this.context.renderPass)),l&&r&&(l.setInstanceCount(v.instanceCount-1),l.shaderInputs.setProps({solidPolygon:T}),l.draw(this.context.renderPass)),u&&r&&(u.setVertexCount(v.vertexCount),u.shaderInputs.setProps({solidPolygon:T}),u.draw(this.context.renderPass))}updateState(e){super.updateState(e),this.updateGeometry(e);const{props:t,oldProps:r,changeFlags:s}=e,a=this.getAttributeManager();(s.extensionsChanged||t.filled!==r.filled||t.extruded!==r.extruded)&&(this.state.models?.forEach(l=>l.destroy()),this.setState(this._getModels()),a.invalidateAll())}updateGeometry({props:e,oldProps:t,changeFlags:r}){if(r.dataChanged||r.updateTriggersChanged&&(r.updateTriggersChanged.all||r.updateTriggersChanged.getPolygon)){const{polygonTesselator:a}=this.state,u=e.data.attributes||{};a.updateGeometry({data:e.data,normalize:e._normalize,geometryBuffer:u.getPolygon,buffers:u,getGeometry:e.getPolygon,positionFormat:e.positionFormat,wrapLongitude:e.wrapLongitude,resolution:this.context.viewport.resolution,fp64:this.use64bitPositions(),dataChanged:r.dataChanged,full3d:e._full3d}),this.setState({numInstances:a.instanceCount,startIndices:a.vertexStarts}),r.dataChanged||this.getAttributeManager().invalidateAll()}}_getModels(){const{id:e,filled:t,extruded:r}=this.props;let s,a,u;if(t){const l=this.getShaders("top");l.defines.NON_INSTANCED_MODEL=1;const g=this.getAttributeManager().getBufferLayouts({isInstanced:!1});s=new Ks(this.context.device,{...l,id:`${e}-top`,topology:"triangle-list",bufferLayout:g,isIndexed:!0,userData:{excludeAttributes:{instanceVertexValid:!0}}})}if(r){const l=this.getAttributeManager().getBufferLayouts({isInstanced:!0});a=new Ks(this.context.device,{...this.getShaders("side"),id:`${e}-side`,bufferLayout:l,geometry:new Ac({topology:"triangle-strip",attributes:{positions:{size:2,value:new Float32Array([1,0,0,0,1,1,0,1])}}}),isInstanced:!0,userData:{excludeAttributes:{indices:!0}}}),u=new Ks(this.context.device,{...this.getShaders("side"),id:`${e}-wireframe`,bufferLayout:l,geometry:new Ac({topology:"line-strip",attributes:{positions:{size:2,value:new Float32Array([1,0,0,0,0,1,1,1])}}}),isInstanced:!0,userData:{excludeAttributes:{indices:!0}}})}return{models:[a,u,s].filter(Boolean),topModel:s,sideModel:a,wireframeModel:u}}calculateIndices(e){const{polygonTesselator:t}=this.state;e.startIndices=t.indexStarts,e.value=t.get("indices")}calculatePositions(e){const{polygonTesselator:t}=this.state;e.startIndices=t.vertexStarts,e.value=t.get("positions")}calculateVertexValid(e){e.value=this.state.polygonTesselator.get("vertexValid")}}Dy.defaultProps=Vz;Dy.layerName="SolidPolygonLayer";function jz({data:i,getIndex:e,dataRange:t,replace:r}){const{startRow:s=0,endRow:a=1/0}=t,u=i.length;let l=u,g=u;for(let P=0;P<u;P++){const O=e(i[P]);if(l>P&&O>=s&&(l=P),O>=a){g=P;break}}let v=l;const S=g-l!==r.length?i.slice(g):void 0;for(let P=0;P<r.length;P++)i[v++]=r[P];if(S){for(let P=0;P<S.length;P++)i[v++]=S[P];i.length=v}return{startRow:l,endRow:l+r.length}}function $z(i,e){if(!i)return null;const t="startIndices"in i?i.startIndices[e]:e,r=i.featureIds.value[t];return t!==-1?Wz(i,r,t):null}function Wz(i,e,t){const r={properties:{...i.properties[e]}};for(const s in i.numericProps)r.properties[s]=i.numericProps[s].value[t];return r}function Hz(i,e){const t={points:null,lines:null,polygons:null};for(const r in t){const s=i[r].globalFeatureIds.value;t[r]=new Uint8ClampedArray(s.length*4);const a=[];for(let u=0;u<s.length;u++)e(s[u],a),t[r][u*4+0]=a[0],t[r][u*4+1]=a[1],t[r][u*4+2]=a[2],t[r][u*4+3]=255}return t}const bw=`uniform sdfUniforms {
  float gamma;
  bool enabled;
  float buffer;
  float outlineBuffer;
  vec4 outlineColor;
} sdf;
`,qz={name:"sdf",vs:bw,fs:bw,uniformTypes:{gamma:"f32",enabled:"f32",buffer:"f32",outlineBuffer:"f32",outlineColor:"vec4<f32>"}},Xz=`#version 300 es
#define SHADER_NAME multi-icon-layer-fragment-shader
precision highp float;
uniform sampler2D iconsTexture;
in vec4 vColor;
in vec2 vTextureCoords;
in vec2 uv;
out vec4 fragColor;
void main(void) {
geometry.uv = uv;
if (!bool(picking.isActive)) {
float alpha = texture(iconsTexture, vTextureCoords).a;
vec4 color = vColor;
if (sdf.enabled) {
float distance = alpha;
alpha = smoothstep(sdf.buffer - sdf.gamma, sdf.buffer + sdf.gamma, distance);
if (sdf.outlineBuffer > 0.0) {
float inFill = alpha;
float inBorder = smoothstep(sdf.outlineBuffer - sdf.gamma, sdf.outlineBuffer + sdf.gamma, distance);
color = mix(sdf.outlineColor, vColor, inFill);
alpha = inBorder;
}
}
float a = alpha * color.a;
if (a < icon.alphaCutoff) {
discard;
}
fragColor = vec4(color.rgb, a * layer.opacity);
}
DECKGL_FILTER_COLOR(fragColor, geometry);
}
`,Dm=192/256,ww=[],Zz={getIconOffsets:{type:"accessor",value:i=>i.offsets},alphaCutoff:.001,smoothing:.1,outlineWidth:0,outlineColor:{type:"color",value:[0,0,0,255]}};class Oy extends Ko{getShaders(){const e=super.getShaders();return{...e,modules:[...e.modules,qz],fs:Xz}}initializeState(){super.initializeState(),this.getAttributeManager().addInstanced({instanceOffsets:{size:2,accessor:"getIconOffsets"},instancePickingColors:{type:"uint8",size:3,accessor:(t,{index:r,target:s})=>this.encodePickingColor(r,s)}})}updateState(e){super.updateState(e);const{props:t,oldProps:r}=e;let{outlineColor:s}=t;s!==r.outlineColor&&(s=s.map(a=>a/255),s[3]=Number.isFinite(s[3])?s[3]:1,this.setState({outlineColor:s})),!t.sdf&&t.outlineWidth&&ni.warn(`${this.id}: fontSettings.sdf is required to render outline`)()}draw(e){const{sdf:t,smoothing:r,outlineWidth:s}=this.props,{outlineColor:a}=this.state,u=s?Math.max(r,Dm*(1-s)):-1,l=this.state.model,g={buffer:Dm,outlineBuffer:u,gamma:r,enabled:!!t,outlineColor:a};if(l.shaderInputs.setProps({sdf:g}),super.draw(e),t&&s){const{iconManager:v}=this.state;v.getTexture()&&(l.shaderInputs.setProps({sdf:{...g,outlineBuffer:Dm}}),l.draw(this.context.renderPass))}}getInstanceOffset(e){return e?Array.from(e).flatMap(t=>super.getInstanceOffset(t)):ww}getInstanceColorMode(e){return 1}getInstanceIconFrame(e){return e?Array.from(e).flatMap(t=>super.getInstanceIconFrame(t)):ww}}Oy.defaultProps=Zz;Oy.layerName="MultiIconLayer";const Ih=1e20;class Yz{constructor({fontSize:e=24,buffer:t=3,radius:r=8,cutoff:s=.25,fontFamily:a="sans-serif",fontWeight:u="normal",fontStyle:l="normal",lang:g=null}={}){this.buffer=t,this.cutoff=s,this.radius=r,this.lang=g;const v=this.size=e+t*4,T=this._createCanvas(v),S=this.ctx=T.getContext("2d",{willReadFrequently:!0});S.font=`${l} ${u} ${e}px ${a}`,S.textBaseline="alphabetic",S.textAlign="left",S.fillStyle="black",this.gridOuter=new Float64Array(v*v),this.gridInner=new Float64Array(v*v),this.f=new Float64Array(v),this.z=new Float64Array(v+1),this.v=new Uint16Array(v)}_createCanvas(e){const t=document.createElement("canvas");return t.width=t.height=e,t}draw(e){const{width:t,actualBoundingBoxAscent:r,actualBoundingBoxDescent:s,actualBoundingBoxLeft:a,actualBoundingBoxRight:u}=this.ctx.measureText(e),l=Math.ceil(r),g=0,v=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(u-a))),T=Math.min(this.size-this.buffer,l+Math.ceil(s)),S=v+2*this.buffer,P=T+2*this.buffer,O=Math.max(S*P,0),$=new Uint8ClampedArray(O),W={data:$,width:S,height:P,glyphWidth:v,glyphHeight:T,glyphTop:l,glyphLeft:g,glyphAdvance:t};if(v===0||T===0)return W;const{ctx:G,buffer:Q,gridInner:ae,gridOuter:te}=this;this.lang&&(G.lang=this.lang),G.clearRect(Q,Q,v,T),G.fillText(e,Q,Q+l);const me=G.getImageData(Q,Q,v,T);te.fill(Ih,0,O),ae.fill(0,0,O);for(let we=0;we<T;we++)for(let Oe=0;Oe<v;Oe++){const Je=me.data[4*(we*v+Oe)+3]/255;if(Je===0)continue;const it=(we+Q)*S+Oe+Q;if(Je===1)te[it]=0,ae[it]=Ih;else{const He=.5-Je;te[it]=He>0?He*He:0,ae[it]=He<0?He*He:0}}Tw(te,0,0,S,P,S,this.f,this.v,this.z),Tw(ae,Q,Q,v,T,S,this.f,this.v,this.z);for(let we=0;we<O;we++){const Oe=Math.sqrt(te[we])-Math.sqrt(ae[we]);$[we]=Math.round(255-255*(Oe/this.radius+this.cutoff))}return W}}function Tw(i,e,t,r,s,a,u,l,g){for(let v=e;v<e+r;v++)Sw(i,t*a+v,a,s,u,l,g);for(let v=t;v<t+s;v++)Sw(i,v*a+e,1,r,u,l,g)}function Sw(i,e,t,r,s,a,u){a[0]=0,u[0]=-Ih,u[1]=Ih,s[0]=i[e];for(let l=1,g=0,v=0;l<r;l++){s[l]=i[e+l*t];const T=l*l;do{const S=a[g];v=(s[l]-s[S]+T-S*S)/(l-S)/2}while(v<=u[g]&&--g>-1);g++,a[g]=l,u[g]=v,u[g+1]=Ih}for(let l=0,g=0;l<r;l++){for(;u[g+1]<l;)g++;const v=a[g],T=l-v;i[e+l*t]=s[v]+T*T}}const Gz=32,Kz=[];function Jz(i){return Math.pow(2,Math.ceil(Math.log2(i)))}function Qz({characterSet:i,getFontWidth:e,fontHeight:t,buffer:r,maxCanvasWidth:s,mapping:a={},xOffset:u=0,yOffset:l=0}){let g=0,v=u;const T=t+r*2;for(const S of i)if(!a[S]){const P=e(S);v+P+r*2>s&&(v=0,g++),a[S]={x:v+r,y:l+g*T+r,width:P,height:T,layoutWidth:P,layoutHeight:t},v+=P+r*2}return{mapping:a,xOffset:v,yOffset:l+g*T,canvasHeight:Jz(l+(g+1)*T)}}function UT(i,e,t,r){let s=0;for(let a=e;a<t;a++){const u=i[a];s+=r[u]?.layoutWidth||0}return s}function VT(i,e,t,r,s,a){let u=e,l=0;for(let g=e;g<t;g++){const v=UT(i,g,g+1,s);l+v>r&&(u<g&&a.push(g),u=g,l=0),l+=v}return l}function e6(i,e,t,r,s,a){let u=e,l=e,g=e,v=0;for(let T=e;T<t;T++)if((i[T]===" "||i[T+1]===" "||T+1===t)&&(g=T+1),g>l){let S=UT(i,l,g,s);v+S>r&&(u<l&&(a.push(l),u=l,v=0),S>r&&(S=VT(i,l,g,r,s,a),u=a[a.length-1])),l=g,v+=S}return v}function t6(i,e,t,r,s=0,a){a===void 0&&(a=i.length);const u=[];return e==="break-all"?VT(i,s,a,t,r,u):e6(i,s,a,t,r,u),u}function i6(i,e,t,r,s,a){let u=0,l=0;for(let g=e;g<t;g++){const v=i[g],T=r[v];T?(l||(l=T.layoutHeight),s[g]=u+T.layoutWidth/2,u+=T.layoutWidth):(ni.warn(`Missing character: ${v} (${v.codePointAt(0)})`)(),s[g]=u,u+=Gz)}a[0]=u,a[1]=l}function r6(i,e,t,r,s){const a=Array.from(i),u=a.length,l=new Array(u),g=new Array(u),v=new Array(u),T=(t==="break-word"||t==="break-all")&&isFinite(r)&&r>0,S=[0,0],P=[0,0];let O=0,$=0,W=0;for(let G=0;G<=u;G++){const Q=a[G];if((Q===`
`||G===u)&&(W=G),W>$){const ae=T?t6(a,t,r,s,$,W):Kz;for(let te=0;te<=ae.length;te++){const me=te===0?$:ae[te-1],we=te<ae.length?ae[te]:W;i6(a,me,we,s,l,P);for(let Oe=me;Oe<we;Oe++){const Je=a[Oe],it=s[Je]?.layoutOffsetY||0;g[Oe]=O+P[1]/2+it,v[Oe]=P[0]}O=O+P[1]*e,S[0]=Math.max(S[0],P[0])}$=W}Q===`
`&&(l[$]=0,g[$]=0,v[$]=0,$++)}return S[1]=O,{x:l,y:g,rowWidth:v,size:S}}function s6({value:i,length:e,stride:t,offset:r,startIndices:s,characterSet:a}){const u=i.BYTES_PER_ELEMENT,l=t?t/u:1,g=r?r/u:0,v=s[e]||Math.ceil((i.length-g)/l),T=a&&new Set,S=new Array(e);let P=i;if(l>1||g>0){const O=i.constructor;P=new O(v);for(let $=0;$<v;$++)P[$]=i[$*l+g]}for(let O=0;O<e;O++){const $=s[O],W=s[O+1]||v,G=P.subarray($,W);S[O]=String.fromCodePoint.apply(null,G),T&&G.forEach(T.add,T)}if(T)for(const O of T)a.add(String.fromCodePoint(O));return{texts:S,characterCount:v}}class jT{constructor(e=5){this._cache={},this._order=[],this.limit=e}get(e){const t=this._cache[e];return t&&(this._deleteOrder(e),this._appendOrder(e)),t}set(e,t){this._cache[e]?(this.delete(e),this._cache[e]=t,this._appendOrder(e)):(Object.keys(this._cache).length===this.limit&&this.delete(this._order[0]),this._cache[e]=t,this._appendOrder(e))}delete(e){this._cache[e]&&(delete this._cache[e],this._deleteOrder(e))}_deleteOrder(e){const t=this._order.indexOf(e);t>=0&&this._order.splice(t,1)}_appendOrder(e){this._order.push(e)}}function n6(){const i=[];for(let e=32;e<128;e++)i.push(String.fromCharCode(e));return i}const xc={fontFamily:"Monaco, monospace",fontWeight:"normal",characterSet:n6(),fontSize:64,buffer:4,sdf:!1,cutoff:.25,radius:12,smoothing:.1},Aw=1024,Ew=.9,Iw=1.2,$T=3;let dp=new jT($T);function o6(i,e){let t;typeof e=="string"?t=new Set(Array.from(e)):t=new Set(e);const r=dp.get(i);if(!r)return t;for(const s in r.mapping)t.has(s)&&t.delete(s);return t}function a6(i,e){for(let t=0;t<i.length;t++)e.data[4*t+3]=i[t]}function Cw(i,e,t,r){i.font=`${r} ${t}px ${e}`,i.fillStyle="#000",i.textBaseline="alphabetic",i.textAlign="left"}function l6(i){ni.assert(Number.isFinite(i)&&i>=$T,"Invalid cache limit"),dp=new jT(i)}class c6{constructor(){this.props={...xc}}get atlas(){return this._atlas}get mapping(){return this._atlas&&this._atlas.mapping}get scale(){const{fontSize:e,buffer:t}=this.props;return(e*Iw+t*2)/e}setProps(e={}){Object.assign(this.props,e),this._key=this._getKey();const t=o6(this._key,this.props.characterSet),r=dp.get(this._key);if(r&&t.size===0){this._atlas!==r&&(this._atlas=r);return}const s=this._generateFontAtlas(t,r);this._atlas=s,dp.set(this._key,s)}_generateFontAtlas(e,t){const{fontFamily:r,fontWeight:s,fontSize:a,buffer:u,sdf:l,radius:g,cutoff:v}=this.props;let T=t&&t.data;T||(T=document.createElement("canvas"),T.width=Aw);const S=T.getContext("2d",{willReadFrequently:!0});Cw(S,r,a,s);const{mapping:P,canvasHeight:O,xOffset:$,yOffset:W}=Qz({getFontWidth:G=>S.measureText(G).width,fontHeight:a*Iw,buffer:u,characterSet:e,maxCanvasWidth:Aw,...t&&{mapping:t.mapping,xOffset:t.xOffset,yOffset:t.yOffset}});if(T.height!==O){const G=S.getImageData(0,0,T.width,T.height);T.height=O,S.putImageData(G,0,0)}if(Cw(S,r,a,s),l){const G=new Yz({fontSize:a,buffer:u,radius:g,cutoff:v,fontFamily:r,fontWeight:`${s}`});for(const Q of e){const{data:ae,width:te,height:me,glyphTop:we}=G.draw(Q);P[Q].width=te,P[Q].layoutOffsetY=a*Ew-we;const Oe=S.createImageData(te,me);a6(ae,Oe),S.putImageData(Oe,P[Q].x,P[Q].y)}}else for(const G of e)S.fillText(G,P[G].x,P[G].y+u+a*Ew);return{xOffset:$,yOffset:W,mapping:P,data:T,width:T.width,height:T.height}}_getKey(){const{fontFamily:e,fontWeight:t,fontSize:r,buffer:s,sdf:a,radius:u,cutoff:l}=this.props;return a?`${e} ${t} ${r} ${s} ${u} ${l}`:`${e} ${t} ${r} ${s}`}}const Pw=`uniform textBackgroundUniforms {
  bool billboard;
  float sizeScale;
  float sizeMinPixels;
  float sizeMaxPixels;
  vec4 borderRadius;
  vec4 padding;
  highp int sizeUnits;
  bool stroked;
} textBackground;
`,u6={name:"textBackground",vs:Pw,fs:Pw,uniformTypes:{billboard:"f32",sizeScale:"f32",sizeMinPixels:"f32",sizeMaxPixels:"f32",borderRadius:"vec4<f32>",padding:"vec4<f32>",sizeUnits:"i32",stroked:"f32"}},h6=`#version 300 es
#define SHADER_NAME text-background-layer-vertex-shader
in vec2 positions;
in vec3 instancePositions;
in vec3 instancePositions64Low;
in vec4 instanceRects;
in float instanceSizes;
in float instanceAngles;
in vec2 instancePixelOffsets;
in float instanceLineWidths;
in vec4 instanceFillColors;
in vec4 instanceLineColors;
in vec3 instancePickingColors;
out vec4 vFillColor;
out vec4 vLineColor;
out float vLineWidth;
out vec2 uv;
out vec2 dimensions;
vec2 rotate_by_angle(vec2 vertex, float angle) {
float angle_radian = radians(angle);
float cos_angle = cos(angle_radian);
float sin_angle = sin(angle_radian);
mat2 rotationMatrix = mat2(cos_angle, -sin_angle, sin_angle, cos_angle);
return rotationMatrix * vertex;
}
void main(void) {
geometry.worldPosition = instancePositions;
geometry.uv = positions;
geometry.pickingColor = instancePickingColors;
uv = positions;
vLineWidth = instanceLineWidths;
float sizePixels = clamp(
project_size_to_pixel(instanceSizes * textBackground.sizeScale, textBackground.sizeUnits),
textBackground.sizeMinPixels, textBackground.sizeMaxPixels
);
dimensions = instanceRects.zw * sizePixels + textBackground.padding.xy + textBackground.padding.zw;
vec2 pixelOffset = (positions * instanceRects.zw + instanceRects.xy) * sizePixels + mix(-textBackground.padding.xy, textBackground.padding.zw, positions);
pixelOffset = rotate_by_angle(pixelOffset, instanceAngles);
pixelOffset += instancePixelOffsets;
pixelOffset.y *= -1.0;
if (textBackground.billboard)  {
gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, vec3(0.0), geometry.position);
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
vec3 offset = vec3(pixelOffset, 0.0);
DECKGL_FILTER_SIZE(offset, geometry);
gl_Position.xy += project_pixel_size_to_clipspace(offset.xy);
} else {
vec3 offset_common = vec3(project_pixel_size(pixelOffset), 0.0);
DECKGL_FILTER_SIZE(offset_common, geometry);
gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset_common, geometry.position);
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
}
vFillColor = vec4(instanceFillColors.rgb, instanceFillColors.a * layer.opacity);
DECKGL_FILTER_COLOR(vFillColor, geometry);
vLineColor = vec4(instanceLineColors.rgb, instanceLineColors.a * layer.opacity);
DECKGL_FILTER_COLOR(vLineColor, geometry);
}
`,d6=`#version 300 es
#define SHADER_NAME text-background-layer-fragment-shader
precision highp float;
in vec4 vFillColor;
in vec4 vLineColor;
in float vLineWidth;
in vec2 uv;
in vec2 dimensions;
out vec4 fragColor;
float round_rect(vec2 p, vec2 size, vec4 radii) {
vec2 pixelPositionCB = (p - 0.5) * size;
vec2 sizeCB = size * 0.5;
float maxBorderRadius = min(size.x, size.y) * 0.5;
vec4 borderRadius = vec4(min(radii, maxBorderRadius));
borderRadius.xy =
(pixelPositionCB.x > 0.0) ? borderRadius.xy : borderRadius.zw;
borderRadius.x = (pixelPositionCB.y > 0.0) ? borderRadius.x : borderRadius.y;
vec2 q = abs(pixelPositionCB) - sizeCB + borderRadius.x;
return -(min(max(q.x, q.y), 0.0) + length(max(q, 0.0)) - borderRadius.x);
}
float rect(vec2 p, vec2 size) {
vec2 pixelPosition = p * size;
return min(min(pixelPosition.x, size.x - pixelPosition.x),
min(pixelPosition.y, size.y - pixelPosition.y));
}
vec4 get_stroked_fragColor(float dist) {
float isBorder = smoothedge(dist, vLineWidth);
return mix(vFillColor, vLineColor, isBorder);
}
void main(void) {
geometry.uv = uv;
if (textBackground.borderRadius != vec4(0.0)) {
float distToEdge = round_rect(uv, dimensions, textBackground.borderRadius);
if (textBackground.stroked) {
fragColor = get_stroked_fragColor(distToEdge);
} else {
fragColor = vFillColor;
}
float shapeAlpha = smoothedge(-distToEdge, 0.0);
fragColor.a *= shapeAlpha;
} else {
if (textBackground.stroked) {
float distToEdge = rect(uv, dimensions);
fragColor = get_stroked_fragColor(distToEdge);
} else {
fragColor = vFillColor;
}
}
DECKGL_FILTER_COLOR(fragColor, geometry);
}
`,f6={billboard:!0,sizeScale:1,sizeUnits:"pixels",sizeMinPixels:0,sizeMaxPixels:Number.MAX_SAFE_INTEGER,borderRadius:{type:"object",value:0},padding:{type:"array",value:[0,0,0,0]},getPosition:{type:"accessor",value:i=>i.position},getSize:{type:"accessor",value:1},getAngle:{type:"accessor",value:0},getPixelOffset:{type:"accessor",value:[0,0]},getBoundingRect:{type:"accessor",value:[0,0,0,0]},getFillColor:{type:"accessor",value:[0,0,0,255]},getLineColor:{type:"accessor",value:[0,0,0,255]},getLineWidth:{type:"accessor",value:1}};class Ly extends Cn{getShaders(){return super.getShaders({vs:h6,fs:d6,modules:[Mc,Rc,u6]})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:3,type:"float64",fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceSizes:{size:1,transition:!0,accessor:"getSize",defaultValue:1},instanceAngles:{size:1,transition:!0,accessor:"getAngle"},instanceRects:{size:4,accessor:"getBoundingRect"},instancePixelOffsets:{size:2,transition:!0,accessor:"getPixelOffset"},instanceFillColors:{size:4,transition:!0,type:"unorm8",accessor:"getFillColor",defaultValue:[0,0,0,255]},instanceLineColors:{size:4,transition:!0,type:"unorm8",accessor:"getLineColor",defaultValue:[0,0,0,255]},instanceLineWidths:{size:1,transition:!0,accessor:"getLineWidth",defaultValue:1}})}updateState(e){super.updateState(e);const{changeFlags:t}=e;t.extensionsChanged&&(this.state.model?.destroy(),this.state.model=this._getModel(),this.getAttributeManager().invalidateAll())}draw({uniforms:e}){const{billboard:t,sizeScale:r,sizeUnits:s,sizeMinPixels:a,sizeMaxPixels:u,getLineWidth:l}=this.props;let{padding:g,borderRadius:v}=this.props;g.length<4&&(g=[g[0],g[1],g[0],g[1]]),Array.isArray(v)||(v=[v,v,v,v]);const T=this.state.model,S={billboard:t,stroked:!!l,borderRadius:v,padding:g,sizeUnits:to[s],sizeScale:r,sizeMinPixels:a,sizeMaxPixels:u};T.shaderInputs.setProps({textBackground:S}),T.draw(this.context.renderPass)}_getModel(){const e=[0,0,1,0,0,1,1,1];return new Ks(this.context.device,{...this.getShaders(),id:this.props.id,bufferLayout:this.getAttributeManager().getBufferLayouts(),geometry:new Ac({topology:"triangle-strip",vertexCount:4,attributes:{positions:{size:2,value:new Float32Array(e)}}}),isInstanced:!0})}}Ly.defaultProps=f6;Ly.layerName="TextBackgroundLayer";const Mw={start:1,middle:0,end:-1},Rw={top:1,center:0,bottom:-1},Om=[0,0,0,255],p6=1,g6={billboard:!0,sizeScale:1,sizeUnits:"pixels",sizeMinPixels:0,sizeMaxPixels:Number.MAX_SAFE_INTEGER,background:!1,getBackgroundColor:{type:"accessor",value:[255,255,255,255]},getBorderColor:{type:"accessor",value:Om},getBorderWidth:{type:"accessor",value:0},backgroundBorderRadius:{type:"object",value:0},backgroundPadding:{type:"array",value:[0,0,0,0]},characterSet:{type:"object",value:xc.characterSet},fontFamily:xc.fontFamily,fontWeight:xc.fontWeight,lineHeight:p6,outlineWidth:{type:"number",value:0,min:0},outlineColor:{type:"color",value:Om},fontSettings:{type:"object",value:{},compare:1},wordBreak:"break-word",maxWidth:{type:"number",value:-1},getText:{type:"accessor",value:i=>i.text},getPosition:{type:"accessor",value:i=>i.position},getColor:{type:"accessor",value:Om},getSize:{type:"accessor",value:32},getAngle:{type:"accessor",value:0},getTextAnchor:{type:"accessor",value:"middle"},getAlignmentBaseline:{type:"accessor",value:"center"},getPixelOffset:{type:"accessor",value:[0,0]},backgroundColor:{deprecatedFor:["background","getBackgroundColor"]}};class Ep extends Tp{constructor(){super(...arguments),this.getBoundingRect=(e,t)=>{let{size:[r,s]}=this.transformParagraph(e,t);const{fontSize:a}=this.state.fontAtlasManager.props;r/=a,s/=a;const{getTextAnchor:u,getAlignmentBaseline:l}=this.props,g=Mw[typeof u=="function"?u(e,t):u],v=Rw[typeof l=="function"?l(e,t):l];return[(g-1)*r/2,(v-1)*s/2,r,s]},this.getIconOffsets=(e,t)=>{const{getTextAnchor:r,getAlignmentBaseline:s}=this.props,{x:a,y:u,rowWidth:l,size:[g,v]}=this.transformParagraph(e,t),T=Mw[typeof r=="function"?r(e,t):r],S=Rw[typeof s=="function"?s(e,t):s],P=a.length,O=new Array(P*2);let $=0;for(let W=0;W<P;W++){const G=(1-T)*(g-l[W])/2;O[$++]=(T-1)*g/2+G+a[W],O[$++]=(S-1)*v/2+u[W]}return O}}initializeState(){this.state={styleVersion:0,fontAtlasManager:new c6},this.props.maxWidth>0&&ni.once(1,"v8.9 breaking change: TextLayer maxWidth is now relative to text size")()}updateState(e){const{props:t,oldProps:r,changeFlags:s}=e;(s.dataChanged||s.updateTriggersChanged&&(s.updateTriggersChanged.all||s.updateTriggersChanged.getText))&&this._updateText(),(this._updateFontAtlas()||t.lineHeight!==r.lineHeight||t.wordBreak!==r.wordBreak||t.maxWidth!==r.maxWidth)&&this.setState({styleVersion:this.state.styleVersion+1})}getPickingInfo({info:e}){return e.object=e.index>=0?this.props.data[e.index]:null,e}_updateFontAtlas(){const{fontSettings:e,fontFamily:t,fontWeight:r}=this.props,{fontAtlasManager:s,characterSet:a}=this.state,u={...e,characterSet:a,fontFamily:t,fontWeight:r};if(!s.mapping)return s.setProps(u),!0;for(const l in u)if(u[l]!==s.props[l])return s.setProps(u),!0;return!1}_updateText(){const{data:e,characterSet:t}=this.props,r=e.attributes?.getText;let{getText:s}=this.props,a=e.startIndices,u;const l=t==="auto"&&new Set;if(r&&a){const{texts:g,characterCount:v}=s6({...ArrayBuffer.isView(r)?{value:r}:r,length:e.length,startIndices:a,characterSet:l});u=v,s=(T,{index:S})=>g[S]}else{const{iterable:g,objectInfo:v}=bp(e);a=[0],u=0;for(const T of g){v.index++;const S=Array.from(s(T,v)||"");l&&S.forEach(l.add,l),u+=S.length,a.push(u)}}this.setState({getText:s,startIndices:a,numInstances:u,characterSet:l||t})}transformParagraph(e,t){const{fontAtlasManager:r}=this.state,s=r.mapping,a=this.state.getText,{wordBreak:u,lineHeight:l,maxWidth:g}=this.props,v=a(e,t)||"";return r6(v,l,u,g*r.props.fontSize,s)}renderLayers(){const{startIndices:e,numInstances:t,getText:r,fontAtlasManager:{scale:s,atlas:a,mapping:u},styleVersion:l}=this.state,{data:g,_dataDiff:v,getPosition:T,getColor:S,getSize:P,getAngle:O,getPixelOffset:$,getBackgroundColor:W,getBorderColor:G,getBorderWidth:Q,backgroundBorderRadius:ae,backgroundPadding:te,background:me,billboard:we,fontSettings:Oe,outlineWidth:Je,outlineColor:it,sizeScale:He,sizeUnits:ht,sizeMinPixels:Ye,sizeMaxPixels:ft,transitions:Ke,updateTriggers:Ze}=this.props,ve=this.getSubLayerClass("characters",Oy),ie=this.getSubLayerClass("background",Ly);return[me&&new ie({getFillColor:W,getLineColor:G,getLineWidth:Q,borderRadius:ae,padding:te,getPosition:T,getSize:P,getAngle:O,getPixelOffset:$,billboard:we,sizeScale:He,sizeUnits:ht,sizeMinPixels:Ye,sizeMaxPixels:ft,transitions:Ke&&{getPosition:Ke.getPosition,getAngle:Ke.getAngle,getSize:Ke.getSize,getFillColor:Ke.getBackgroundColor,getLineColor:Ke.getBorderColor,getLineWidth:Ke.getBorderWidth,getPixelOffset:Ke.getPixelOffset}},this.getSubLayerProps({id:"background",updateTriggers:{getPosition:Ze.getPosition,getAngle:Ze.getAngle,getSize:Ze.getSize,getFillColor:Ze.getBackgroundColor,getLineColor:Ze.getBorderColor,getLineWidth:Ze.getBorderWidth,getPixelOffset:Ze.getPixelOffset,getBoundingRect:{getText:Ze.getText,getTextAnchor:Ze.getTextAnchor,getAlignmentBaseline:Ze.getAlignmentBaseline,styleVersion:l}}}),{data:g.attributes&&g.attributes.background?{length:g.length,attributes:g.attributes.background}:g,_dataDiff:v,autoHighlight:!1,getBoundingRect:this.getBoundingRect}),new ve({sdf:Oe.sdf,smoothing:Number.isFinite(Oe.smoothing)?Oe.smoothing:xc.smoothing,outlineWidth:Je/(Oe.radius||xc.radius),outlineColor:it,iconAtlas:a,iconMapping:u,getPosition:T,getColor:S,getSize:P,getAngle:O,getPixelOffset:$,billboard:we,sizeScale:He*s,sizeUnits:ht,sizeMinPixels:Ye*s,sizeMaxPixels:ft*s,transitions:Ke&&{getPosition:Ke.getPosition,getAngle:Ke.getAngle,getColor:Ke.getColor,getSize:Ke.getSize,getPixelOffset:Ke.getPixelOffset}},this.getSubLayerProps({id:"characters",updateTriggers:{all:Ze.getText,getPosition:Ze.getPosition,getAngle:Ze.getAngle,getColor:Ze.getColor,getSize:Ze.getSize,getPixelOffset:Ze.getPixelOffset,getIconOffsets:{getTextAnchor:Ze.getTextAnchor,getAlignmentBaseline:Ze.getAlignmentBaseline,styleVersion:l}}}),{data:g,_dataDiff:v,startIndices:e,numInstances:t,getIconOffsets:this.getIconOffsets,getIcon:r})]}static set fontAtlasCacheLimit(e){l6(e)}}Ep.defaultProps=g6;Ep.layerName="TextLayer";const jf={circle:{type:Lh,props:{filled:"filled",stroked:"stroked",lineWidthMaxPixels:"lineWidthMaxPixels",lineWidthMinPixels:"lineWidthMinPixels",lineWidthScale:"lineWidthScale",lineWidthUnits:"lineWidthUnits",pointRadiusMaxPixels:"radiusMaxPixels",pointRadiusMinPixels:"radiusMinPixels",pointRadiusScale:"radiusScale",pointRadiusUnits:"radiusUnits",pointAntialiasing:"antialiasing",pointBillboard:"billboard",getFillColor:"getFillColor",getLineColor:"getLineColor",getLineWidth:"getLineWidth",getPointRadius:"getRadius"}},icon:{type:Ko,props:{iconAtlas:"iconAtlas",iconMapping:"iconMapping",iconSizeMaxPixels:"sizeMaxPixels",iconSizeMinPixels:"sizeMinPixels",iconSizeScale:"sizeScale",iconSizeUnits:"sizeUnits",iconAlphaCutoff:"alphaCutoff",iconBillboard:"billboard",getIcon:"getIcon",getIconAngle:"getAngle",getIconColor:"getColor",getIconPixelOffset:"getPixelOffset",getIconSize:"getSize"}},text:{type:Ep,props:{textSizeMaxPixels:"sizeMaxPixels",textSizeMinPixels:"sizeMinPixels",textSizeScale:"sizeScale",textSizeUnits:"sizeUnits",textBackground:"background",textBackgroundPadding:"backgroundPadding",textFontFamily:"fontFamily",textFontWeight:"fontWeight",textLineHeight:"lineHeight",textMaxWidth:"maxWidth",textOutlineColor:"outlineColor",textOutlineWidth:"outlineWidth",textWordBreak:"wordBreak",textCharacterSet:"characterSet",textBillboard:"billboard",textFontSettings:"fontSettings",getText:"getText",getTextAngle:"getAngle",getTextColor:"getColor",getTextPixelOffset:"getPixelOffset",getTextSize:"getSize",getTextAnchor:"getTextAnchor",getTextAlignmentBaseline:"getAlignmentBaseline",getTextBackgroundColor:"getBackgroundColor",getTextBorderColor:"getBorderColor",getTextBorderWidth:"getBorderWidth"}}},$f={type:ky,props:{lineWidthUnits:"widthUnits",lineWidthScale:"widthScale",lineWidthMinPixels:"widthMinPixels",lineWidthMaxPixels:"widthMaxPixels",lineJointRounded:"jointRounded",lineCapRounded:"capRounded",lineMiterLimit:"miterLimit",lineBillboard:"billboard",getLineColor:"getColor",getLineWidth:"getWidth"}},A_={type:Dy,props:{extruded:"extruded",filled:"filled",wireframe:"wireframe",elevationScale:"elevationScale",material:"material",_full3d:"_full3d",getElevation:"getElevation",getFillColor:"getFillColor",getLineColor:"getLineColor"}};function Zu({type:i,props:e}){const t={};for(const r in e)t[r]=i.defaultProps[e[r]];return t}function Lm(i,e){const{transitions:t,updateTriggers:r}=i.props,s={updateTriggers:{},transitions:t&&{getPosition:t.geometry}};for(const a in e){const u=e[a];let l=i.props[a];a.startsWith("get")&&(l=i.getSubLayerAccessor(l),s.updateTriggers[u]=r[a],t&&(s.transitions[u]=t[a])),s[u]=l}return s}function m6(i){if(Array.isArray(i))return i;switch(ni.assert(i.type,"GeoJSON does not have type"),i.type){case"Feature":return[i];case"FeatureCollection":return ni.assert(Array.isArray(i.features),"GeoJSON does not have features array"),i.features;default:return[{geometry:i}]}}function kw(i,e,t={}){const r={pointFeatures:[],lineFeatures:[],polygonFeatures:[],polygonOutlineFeatures:[]},{startRow:s=0,endRow:a=i.length}=t;for(let u=s;u<a;u++){const l=i[u],{geometry:g}=l;if(g)if(g.type==="GeometryCollection"){ni.assert(Array.isArray(g.geometries),"GeoJSON does not have geometries array");const{geometries:v}=g;for(let T=0;T<v.length;T++){const S=v[T];Dw(S,r,e,l,u)}}else Dw(g,r,e,l,u)}return r}function Dw(i,e,t,r,s){const{type:a,coordinates:u}=i,{pointFeatures:l,lineFeatures:g,polygonFeatures:v,polygonOutlineFeatures:T}=e;if(!y6(a,u)){ni.warn(`${a} coordinates are malformed`)();return}switch(a){case"Point":l.push(t({geometry:i},r,s));break;case"MultiPoint":u.forEach(S=>{l.push(t({geometry:{type:"Point",coordinates:S}},r,s))});break;case"LineString":g.push(t({geometry:i},r,s));break;case"MultiLineString":u.forEach(S=>{g.push(t({geometry:{type:"LineString",coordinates:S}},r,s))});break;case"Polygon":v.push(t({geometry:i},r,s)),u.forEach(S=>{T.push(t({geometry:{type:"LineString",coordinates:S}},r,s))});break;case"MultiPolygon":u.forEach(S=>{v.push(t({geometry:{type:"Polygon",coordinates:S}},r,s)),S.forEach(P=>{T.push(t({geometry:{type:"LineString",coordinates:P}},r,s))})});break}}const _6={Point:1,MultiPoint:2,LineString:2,MultiLineString:3,Polygon:3,MultiPolygon:4};function y6(i,e){let t=_6[i];for(ni.assert(t,`Unknown GeoJSON type ${i}`);e&&--t>0;)e=e[0];return e&&Number.isFinite(e[0])}function WT(){return{points:{},lines:{},polygons:{},polygonsOutline:{}}}function vf(i){return i.geometry.coordinates}function x6(i,e){const t=WT(),{pointFeatures:r,lineFeatures:s,polygonFeatures:a,polygonOutlineFeatures:u}=i;return t.points.data=r,t.points._dataDiff=e.pointFeatures&&(()=>e.pointFeatures),t.points.getPosition=vf,t.lines.data=s,t.lines._dataDiff=e.lineFeatures&&(()=>e.lineFeatures),t.lines.getPath=vf,t.polygons.data=a,t.polygons._dataDiff=e.polygonFeatures&&(()=>e.polygonFeatures),t.polygons.getPolygon=vf,t.polygonsOutline.data=u,t.polygonsOutline._dataDiff=e.polygonOutlineFeatures&&(()=>e.polygonOutlineFeatures),t.polygonsOutline.getPath=vf,t}function v6(i,e){const t=WT(),{points:r,lines:s,polygons:a}=i,u=Hz(i,e);t.points.data={length:r.positions.value.length/r.positions.size,attributes:{...r.attributes,getPosition:r.positions,instancePickingColors:{size:4,value:u.points}},properties:r.properties,numericProps:r.numericProps,featureIds:r.featureIds},t.lines.data={length:s.pathIndices.value.length-1,startIndices:s.pathIndices.value,attributes:{...s.attributes,getPath:s.positions,instancePickingColors:{size:4,value:u.lines}},properties:s.properties,numericProps:s.numericProps,featureIds:s.featureIds},t.lines._pathType="open";const l=a.positions.value.length/a.positions.size,g=Array(l).fill(1);for(const v of a.primitivePolygonIndices.value)g[v-1]=0;return t.polygons.data={length:a.polygonIndices.value.length-1,startIndices:a.polygonIndices.value,attributes:{...a.attributes,getPolygon:a.positions,instanceVertexValid:{size:1,value:new Uint16Array(g)},pickingColors:{size:4,value:u.polygons}},properties:a.properties,numericProps:a.numericProps,featureIds:a.featureIds},t.polygons._normalize=!1,a.triangles&&(t.polygons.data.attributes.indices=a.triangles.value),t.polygonsOutline.data={length:a.primitivePolygonIndices.value.length-1,startIndices:a.primitivePolygonIndices.value,attributes:{...a.attributes,getPath:a.positions,instancePickingColors:{size:4,value:u.polygons}},properties:a.properties,numericProps:a.numericProps,featureIds:a.featureIds},t.polygonsOutline._pathType="open",t}const b6=["points","linestrings","polygons"],w6={...Zu(jf.circle),...Zu(jf.icon),...Zu(jf.text),...Zu($f),...Zu(A_),stroked:!0,filled:!0,extruded:!1,wireframe:!1,_full3d:!1,iconAtlas:{type:"object",value:null},iconMapping:{type:"object",value:{}},getIcon:{type:"accessor",value:i=>i.properties.icon},getText:{type:"accessor",value:i=>i.properties.text},pointType:"circle",getRadius:{deprecatedFor:"getPointRadius"}};class Fy extends Tp{initializeState(){this.state={layerProps:{},features:{},featuresDiff:{}}}updateState({props:e,changeFlags:t}){if(!t.dataChanged)return;const{data:r}=this.props,s=r&&"points"in r&&"polygons"in r&&"lines"in r;this.setState({binary:s}),s?this._updateStateBinary({props:e,changeFlags:t}):this._updateStateJSON({props:e,changeFlags:t})}_updateStateBinary({props:e,changeFlags:t}){const r=v6(e.data,this.encodePickingColor);this.setState({layerProps:r})}_updateStateJSON({props:e,changeFlags:t}){const r=m6(e.data),s=this.getSubLayerRow.bind(this);let a={};const u={};if(Array.isArray(t.dataChanged)){const g=this.state.features;for(const v in g)a[v]=g[v].slice(),u[v]=[];for(const v of t.dataChanged){const T=kw(r,s,v);for(const S in g)u[S].push(jz({data:a[S],getIndex:P=>P.__source.index,dataRange:v,replace:T[S]}))}}else a=kw(r,s);const l=x6(a,u);this.setState({features:a,featuresDiff:u,layerProps:l})}getPickingInfo(e){const t=super.getPickingInfo(e),{index:r,sourceLayer:s}=t;return t.featureType=b6.find(a=>s.id.startsWith(`${this.id}-${a}-`)),r>=0&&s.id.startsWith(`${this.id}-points-text`)&&this.state.binary&&(t.index=this.props.data.points.globalFeatureIds.value[r]),t}_updateAutoHighlight(e){const t=`${this.id}-points-`,r=e.featureType==="points";for(const s of this.getSubLayers())s.id.startsWith(t)===r&&s.updateAutoHighlight(e)}_renderPolygonLayer(){const{extruded:e,wireframe:t}=this.props,{layerProps:r}=this.state,s="polygons-fill",a=this.shouldRenderSubLayer(s,r.polygons?.data)&&this.getSubLayerClass(s,A_.type);if(a){const u=Lm(this,A_.props),l=e&&t;return l||delete u.getLineColor,u.updateTriggers.lineColors=l,new a(u,this.getSubLayerProps({id:s,updateTriggers:u.updateTriggers}),r.polygons)}return null}_renderLineLayers(){const{extruded:e,stroked:t}=this.props,{layerProps:r}=this.state,s="polygons-stroke",a="linestrings",u=!e&&t&&this.shouldRenderSubLayer(s,r.polygonsOutline?.data)&&this.getSubLayerClass(s,$f.type),l=this.shouldRenderSubLayer(a,r.lines?.data)&&this.getSubLayerClass(a,$f.type);if(u||l){const g=Lm(this,$f.props);return[u&&new u(g,this.getSubLayerProps({id:s,updateTriggers:g.updateTriggers}),r.polygonsOutline),l&&new l(g,this.getSubLayerProps({id:a,updateTriggers:g.updateTriggers}),r.lines)]}return null}_renderPointLayers(){const{pointType:e}=this.props,{layerProps:t,binary:r}=this.state;let{highlightedObjectIndex:s}=this.props;!r&&Number.isFinite(s)&&(s=t.points.data.findIndex(l=>l.__source.index===s));const a=new Set(e.split("+")),u=[];for(const l of a){const g=`points-${l}`,v=jf[l],T=v&&this.shouldRenderSubLayer(g,t.points?.data)&&this.getSubLayerClass(g,v.type);if(T){const S=Lm(this,v.props);let P=t.points;if(l==="text"&&r){const{instancePickingColors:O,...$}=P.data.attributes;P={...P,data:{...P.data,attributes:$}}}u.push(new T(S,this.getSubLayerProps({id:g,updateTriggers:S.updateTriggers,highlightedObjectIndex:s}),P))}}return u}renderLayers(){const{extruded:e}=this.props,t=this._renderPolygonLayer(),r=this._renderLineLayers(),s=this._renderPointLayers();return[!e&&t,r,s,e&&t]}getSubLayerAccessor(e){const{binary:t}=this.state;return!t||typeof e!="function"?super.getSubLayerAccessor(e):(r,s)=>{const{data:a,index:u}=s,l=$z(a,u);return e(l,s)}}}Fy.layerName="GeoJsonLayer";Fy.defaultProps=w6;class T6{constructor(e){this.index=e,this.isVisible=!1,this.isSelected=!1,this.parent=null,this.children=[],this.content=null,this._loader=void 0,this._abortController=null,this._loaderId=0,this._isLoaded=!1,this._isCancelled=!1,this._needsReload=!1}get bbox(){return this._bbox}set bbox(e){this._bbox||(this._bbox=e,"west"in e?this.boundingBox=[[e.west,e.south],[e.east,e.north]]:this.boundingBox=[[e.left,e.top],[e.right,e.bottom]])}get data(){return this.isLoading&&this._loader?this._loader.then(()=>this.data):this.content}get isLoaded(){return this._isLoaded&&!this._needsReload}get isLoading(){return!!this._loader&&!this._isCancelled}get needsReload(){return this._needsReload||this._isCancelled}get byteLength(){const e=this.content?this.content.byteLength:0;return Number.isFinite(e)||console.error("byteLength not defined in tile data"),e}async _loadData({getData:e,requestScheduler:t,onLoad:r,onError:s}){const{index:a,id:u,bbox:l,userData:g,zoom:v}=this,T=this._loaderId;this._abortController=new AbortController;const{signal:S}=this._abortController,P=await t.scheduleRequest(this,W=>W.isSelected?1:-1);if(!P){this._isCancelled=!0;return}if(this._isCancelled){P.done();return}let O=null,$;try{O=await e({index:a,id:u,bbox:l,userData:g,zoom:v,signal:S})}catch(W){$=W||!0}finally{P.done()}if(T===this._loaderId){if(this._loader=void 0,this.content=O,this._isCancelled&&!O){this._isLoaded=!1;return}this._isLoaded=!0,this._isCancelled=!1,$?s($,this):r(this)}}loadData(e){return this._isLoaded=!1,this._isCancelled=!1,this._needsReload=!1,this._loaderId++,this._loader=this._loadData(e),this._loader}setNeedsReload(){this.isLoading&&(this.abort(),this._loader=void 0),this._needsReload=!0}abort(){this.isLoaded||(this._isCancelled=!0,this._abortController?.abort())}}const qr={OUTSIDE:-1,INTERSECTING:0,INSIDE:1},Ow=new Mt,S6=new Mt;class By{constructor(e=[0,0,0],t=[0,0,0],r){r=r||Ow.copy(e).add(t).scale(.5),this.center=new Mt(r),this.halfDiagonal=new Mt(t).subtract(this.center),this.minimum=new Mt(e),this.maximum=new Mt(t)}clone(){return new By(this.minimum,this.maximum,this.center)}equals(e){return this===e||!!e&&this.minimum.equals(e.minimum)&&this.maximum.equals(e.maximum)}transform(e){return this.center.transformAsPoint(e),this.halfDiagonal.transform(e),this.minimum.transform(e),this.maximum.transform(e),this}intersectPlane(e){const{halfDiagonal:t}=this,r=S6.from(e.normal),s=t.x*Math.abs(r.x)+t.y*Math.abs(r.y)+t.z*Math.abs(r.z),a=this.center.dot(r)+e.distance;return a-s>0?qr.INSIDE:a+s<0?qr.OUTSIDE:qr.INTERSECTING}distanceTo(e){return Math.sqrt(this.distanceSquaredTo(e))}distanceSquaredTo(e){const t=Ow.from(e).subtract(this.center),{halfDiagonal:r}=this;let s=0,a;return a=Math.abs(t.x)-r.x,a>0&&(s+=a*a),a=Math.abs(t.y)-r.y,a>0&&(s+=a*a),a=Math.abs(t.z)-r.z,a>0&&(s+=a*a),s}}const Yu=new Mt,Lw=new Mt;class Ny{constructor(e=[0,0,0],t=0){this.radius=-0,this.center=new Mt,this.fromCenterRadius(e,t)}fromCenterRadius(e,t){return this.center.from(e),this.radius=t,this}fromCornerPoints(e,t){return t=Yu.from(t),this.center=new Mt().from(e).add(t).scale(.5),this.radius=this.center.distance(t),this}equals(e){return this===e||!!e&&this.center.equals(e.center)&&this.radius===e.radius}clone(){return new Ny(this.center,this.radius)}union(e){const t=this.center,r=this.radius,s=e.center,a=e.radius,u=Yu.copy(s).subtract(t),l=u.magnitude();if(r>=l+a)return this.clone();if(a>=l+r)return e.clone();const g=(r+l+a)*.5;return Lw.copy(u).scale((-r+g)/l).add(t),this.center.copy(Lw),this.radius=g,this}expand(e){const r=Yu.from(e).subtract(this.center).magnitude();return r>this.radius&&(this.radius=r),this}transform(e){this.center.transform(e);const t=FM(Yu,e);return this.radius=Math.max(t[0],Math.max(t[1],t[2]))*this.radius,this}distanceSquaredTo(e){const t=this.distanceTo(e);return t*t}distanceTo(e){const r=Yu.from(e).subtract(this.center);return Math.max(0,r.len()-this.radius)}intersectPlane(e){const t=this.center,r=this.radius,a=e.normal.dot(t)+e.distance;return a<-r?qr.OUTSIDE:a<r?qr.INTERSECTING:qr.INSIDE}}const A6=new Mt,E6=new Mt,bf=new Mt,wf=new Mt,Tf=new Mt,I6=new Mt,C6=new Mt,Yn={COLUMN0ROW0:0,COLUMN0ROW1:1,COLUMN0ROW2:2,COLUMN1ROW0:3,COLUMN1ROW1:4,COLUMN1ROW2:5,COLUMN2ROW0:6,COLUMN2ROW1:7,COLUMN2ROW2:8};class zy{constructor(e=[0,0,0],t=[0,0,0,0,0,0,0,0,0]){this.center=new Mt().from(e),this.halfAxes=new Rr(t)}get halfSize(){const e=this.halfAxes.getColumn(0),t=this.halfAxes.getColumn(1),r=this.halfAxes.getColumn(2);return[new Mt(e).len(),new Mt(t).len(),new Mt(r).len()]}get quaternion(){const e=this.halfAxes.getColumn(0),t=this.halfAxes.getColumn(1),r=this.halfAxes.getColumn(2),s=new Mt(e).normalize(),a=new Mt(t).normalize(),u=new Mt(r).normalize();return new Cb().fromMatrix3(new Rr([...s,...a,...u]))}fromCenterHalfSizeQuaternion(e,t,r){const s=new Cb(r),a=new Rr().fromQuaternion(s);return a[0]=a[0]*t[0],a[1]=a[1]*t[0],a[2]=a[2]*t[0],a[3]=a[3]*t[1],a[4]=a[4]*t[1],a[5]=a[5]*t[1],a[6]=a[6]*t[2],a[7]=a[7]*t[2],a[8]=a[8]*t[2],this.center=new Mt().from(e),this.halfAxes=a,this}clone(){return new zy(this.center,this.halfAxes)}equals(e){return this===e||!!e&&this.center.equals(e.center)&&this.halfAxes.equals(e.halfAxes)}getBoundingSphere(e=new Ny){const t=this.halfAxes,r=t.getColumn(0,bf),s=t.getColumn(1,wf),a=t.getColumn(2,Tf),u=A6.copy(r).add(s).add(a);return e.center.copy(this.center),e.radius=u.magnitude(),e}intersectPlane(e){const t=this.center,r=e.normal,s=this.halfAxes,a=r.x,u=r.y,l=r.z,g=Math.abs(a*s[Yn.COLUMN0ROW0]+u*s[Yn.COLUMN0ROW1]+l*s[Yn.COLUMN0ROW2])+Math.abs(a*s[Yn.COLUMN1ROW0]+u*s[Yn.COLUMN1ROW1]+l*s[Yn.COLUMN1ROW2])+Math.abs(a*s[Yn.COLUMN2ROW0]+u*s[Yn.COLUMN2ROW1]+l*s[Yn.COLUMN2ROW2]),v=r.dot(t)+e.distance;return v<=-g?qr.OUTSIDE:v>=g?qr.INSIDE:qr.INTERSECTING}distanceTo(e){return Math.sqrt(this.distanceSquaredTo(e))}distanceSquaredTo(e){const t=E6.from(e).subtract(this.center),r=this.halfAxes,s=r.getColumn(0,bf),a=r.getColumn(1,wf),u=r.getColumn(2,Tf),l=s.magnitude(),g=a.magnitude(),v=u.magnitude();s.normalize(),a.normalize(),u.normalize();let T=0,S;return S=Math.abs(t.dot(s))-l,S>0&&(T+=S*S),S=Math.abs(t.dot(a))-g,S>0&&(T+=S*S),S=Math.abs(t.dot(u))-v,S>0&&(T+=S*S),T}computePlaneDistances(e,t,r=[-0,-0]){let s=Number.POSITIVE_INFINITY,a=Number.NEGATIVE_INFINITY;const u=this.center,l=this.halfAxes,g=l.getColumn(0,bf),v=l.getColumn(1,wf),T=l.getColumn(2,Tf),S=I6.copy(g).add(v).add(T).add(u),P=C6.copy(S).subtract(e);let O=t.dot(P);return s=Math.min(O,s),a=Math.max(O,a),S.copy(u).add(g).add(v).subtract(T),P.copy(S).subtract(e),O=t.dot(P),s=Math.min(O,s),a=Math.max(O,a),S.copy(u).add(g).subtract(v).add(T),P.copy(S).subtract(e),O=t.dot(P),s=Math.min(O,s),a=Math.max(O,a),S.copy(u).add(g).subtract(v).subtract(T),P.copy(S).subtract(e),O=t.dot(P),s=Math.min(O,s),a=Math.max(O,a),u.copy(S).subtract(g).add(v).add(T),P.copy(S).subtract(e),O=t.dot(P),s=Math.min(O,s),a=Math.max(O,a),u.copy(S).subtract(g).add(v).subtract(T),P.copy(S).subtract(e),O=t.dot(P),s=Math.min(O,s),a=Math.max(O,a),u.copy(S).subtract(g).subtract(v).add(T),P.copy(S).subtract(e),O=t.dot(P),s=Math.min(O,s),a=Math.max(O,a),u.copy(S).subtract(g).subtract(v).subtract(T),P.copy(S).subtract(e),O=t.dot(P),s=Math.min(O,s),a=Math.max(O,a),r[0]=s,r[1]=a,r}transform(e){this.center.transformAsPoint(e);const t=this.halfAxes.getColumn(0,bf);t.transformAsPoint(e);const r=this.halfAxes.getColumn(1,wf);r.transformAsPoint(e);const s=this.halfAxes.getColumn(2,Tf);return s.transformAsPoint(e),this.halfAxes=new Rr([...t,...r,...s]),this}getTransform(){throw new Error("not implemented")}}const Fw=new Mt,Bw=new Mt;class Bh{constructor(e=[0,0,1],t=0){this.normal=new Mt,this.distance=-0,this.fromNormalDistance(e,t)}fromNormalDistance(e,t){return Mh(Number.isFinite(t)),this.normal.from(e).normalize(),this.distance=t,this}fromPointNormal(e,t){e=Fw.from(e),this.normal.from(t).normalize();const r=-this.normal.dot(e);return this.distance=r,this}fromCoefficients(e,t,r,s){return this.normal.set(e,t,r),Mh(eo(this.normal.len(),1)),this.distance=s,this}clone(){return new Bh(this.normal,this.distance)}equals(e){return eo(this.distance,e.distance)&&eo(this.normal,e.normal)}getPointDistance(e){return this.normal.dot(e)+this.distance}transform(e){const t=Bw.copy(this.normal).transformAsVector(e).normalize(),r=this.normal.scale(-this.distance).transform(e);return this.fromPointNormal(r,t)}projectPointOntoPlane(e,t=[0,0,0]){const r=Fw.from(e),s=this.getPointDistance(r),a=Bw.copy(this.normal).scale(s);return r.subtract(a).to(t)}}const Nw=[new Mt([1,0,0]),new Mt([0,1,0]),new Mt([0,0,1])],zw=new Mt,P6=new Mt;class Qn{constructor(e=[]){this.planes=e}fromBoundingSphere(e){this.planes.length=2*Nw.length;const t=e.center,r=e.radius;let s=0;for(const a of Nw){let u=this.planes[s],l=this.planes[s+1];u||(u=this.planes[s]=new Bh),l||(l=this.planes[s+1]=new Bh);const g=zw.copy(a).scale(-r).add(t);u.fromPointNormal(g,a);const v=zw.copy(a).scale(r).add(t),T=P6.copy(a).negate();l.fromPointNormal(v,T),s+=2}return this}computeVisibility(e){let t=qr.INSIDE;for(const r of this.planes)switch(e.intersectPlane(r)){case qr.OUTSIDE:return qr.OUTSIDE;case qr.INTERSECTING:t=qr.INTERSECTING;break}return t}computeVisibilityWithPlaneMask(e,t){if(Mh(Number.isFinite(t),"parentPlaneMask is required."),t===Qn.MASK_OUTSIDE||t===Qn.MASK_INSIDE)return t;let r=Qn.MASK_INSIDE;const s=this.planes;for(let a=0;a<this.planes.length;++a){const u=a<31?1<<a:0;if(a<31&&(t&u)===0)continue;const l=s[a],g=e.intersectPlane(l);if(g===qr.OUTSIDE)return Qn.MASK_OUTSIDE;g===qr.INTERSECTING&&(r|=u)}return r}}Qn.MASK_OUTSIDE=4294967295;Qn.MASK_INSIDE=0;Qn.MASK_INDETERMINATE=2147483647;new Mt;new Mt;new Mt;new Mt;new Mt;new Mt;new Mt;new Mt;new Mt;new Mt;new Mt;new Mt;new Mt;new Mt;new Mt;new Mt;new Mt;const wn=new Rr,M6=new Rr,R6=new Rr,Sf=new Rr,Uw=new Rr;function k6(i,e={}){const t=vR,r=10;let s=0,a=0;const u=M6,l=R6;u.identity(),l.copy(i);const g=t*D6(l);for(;a<r&&O6(l)>g;)L6(l,Sf),Uw.copy(Sf).transpose(),l.multiplyRight(Sf),l.multiplyLeft(Uw),u.multiplyRight(Sf),++s>2&&(++a,s=0);return e.unitary=u.toTarget(e.unitary),e.diagonal=l.toTarget(e.diagonal),e}function D6(i){let e=0;for(let t=0;t<9;++t){const r=i[t];e+=r*r}return Math.sqrt(e)}const E_=[1,0,0],I_=[2,2,1];function O6(i){let e=0;for(let t=0;t<3;++t){const r=i[wn.getElementIndex(I_[t],E_[t])];e+=2*r*r}return Math.sqrt(e)}function L6(i,e){const t=xR;let r=0,s=1;for(let v=0;v<3;++v){const T=Math.abs(i[wn.getElementIndex(I_[v],E_[v])]);T>r&&(s=v,r=T)}const a=E_[s],u=I_[s];let l=1,g=0;if(Math.abs(i[wn.getElementIndex(u,a)])>t){const v=i[wn.getElementIndex(u,u)],T=i[wn.getElementIndex(a,a)],S=i[wn.getElementIndex(u,a)],P=(v-T)/2/S;let O;P<0?O=-1/(-P+Math.sqrt(1+P*P)):O=1/(P+Math.sqrt(1+P*P)),l=1/Math.sqrt(1+O*O),g=O*l}return Rr.IDENTITY.to(e),e[wn.getElementIndex(a,a)]=e[wn.getElementIndex(u,u)]=l,e[wn.getElementIndex(u,a)]=g,e[wn.getElementIndex(a,u)]=-g,e}const jo=new Mt,F6=new Mt,B6=new Mt,N6=new Mt,z6=new Mt,U6=new Rr,V6={diagonal:new Rr,unitary:new Rr};function j6(i,e=new zy){if(!i||i.length===0)return e.halfAxes=new Rr([0,0,0,0,0,0,0,0,0]),e.center=new Mt,e;const t=i.length,r=new Mt(0,0,0);for(const He of i)r.add(He);const s=1/t;r.multiplyByScalar(s);let a=0,u=0,l=0,g=0,v=0,T=0;for(const He of i){const ht=jo.copy(He).subtract(r);a+=ht.x*ht.x,u+=ht.x*ht.y,l+=ht.x*ht.z,g+=ht.y*ht.y,v+=ht.y*ht.z,T+=ht.z*ht.z}a*=s,u*=s,l*=s,g*=s,v*=s,T*=s;const S=U6;S[0]=a,S[1]=u,S[2]=l,S[3]=u,S[4]=g,S[5]=v,S[6]=l,S[7]=v,S[8]=T;const{unitary:P}=k6(S,V6),O=e.halfAxes.copy(P);let $=O.getColumn(0,B6),W=O.getColumn(1,N6),G=O.getColumn(2,z6),Q=-Number.MAX_VALUE,ae=-Number.MAX_VALUE,te=-Number.MAX_VALUE,me=Number.MAX_VALUE,we=Number.MAX_VALUE,Oe=Number.MAX_VALUE;for(const He of i)jo.copy(He),Q=Math.max(jo.dot($),Q),ae=Math.max(jo.dot(W),ae),te=Math.max(jo.dot(G),te),me=Math.min(jo.dot($),me),we=Math.min(jo.dot(W),we),Oe=Math.min(jo.dot(G),Oe);$=$.multiplyByScalar(.5*(me+Q)),W=W.multiplyByScalar(.5*(we+ae)),G=G.multiplyByScalar(.5*(Oe+te)),e.center.copy($).add(W).add(G);const Je=F6.set(Q-me,ae-we,te-Oe).multiplyByScalar(.5),it=new Rr([Je[0],0,0,0,Je[1],0,0,0,Je[2]]);return e.halfAxes.multiplyRight(it),e}const fc=512,Vw=3,HT=[[.5,.5],[0,0],[0,1],[1,0],[1,1]],qT=HT.concat([[0,.5],[.5,0],[1,.5],[.5,1]]),$6=qT.concat([[.25,.5],[.75,.5]]);class pc{constructor(e,t,r){this.x=e,this.y=t,this.z=r}get children(){if(!this._children){const e=this.x*2,t=this.y*2,r=this.z+1;this._children=[new pc(e,t,r),new pc(e,t+1,r),new pc(e+1,t,r),new pc(e+1,t+1,r)]}return this._children}update(e){const{viewport:t,cullingVolume:r,elevationBounds:s,minZ:a,maxZ:u,bounds:l,offset:g,project:v}=e,T=this.getBoundingVolume(s,g,v);if(l&&!this.insideBounds(l)||r.computeVisibility(T)<0)return!1;if(!this.childVisible){let{z:P}=this;if(P<u&&P>=a){const O=T.distanceTo(t.cameraPosition)*t.scale/t.height;P+=Math.floor(Math.log2(O))}if(P>=u)return this.selected=!0,!0}this.selected=!1,this.childVisible=!0;for(const P of this.children)P.update(e);return!0}getSelected(e=[]){if(this.selected&&e.push(this),this._children)for(const t of this._children)t.getSelected(e);return e}insideBounds([e,t,r,s]){const a=Math.pow(2,this.z),u=fc/a;return this.x*u<r&&this.y*u<s&&(this.x+1)*u>e&&(this.y+1)*u>t}getBoundingVolume(e,t,r){if(r){const g=this.z<1?$6:this.z<2?qT:HT,v=[];for(const T of g){const S=P_(this.x+T[0],this.y+T[1],this.z);S[2]=e[0],v.push(r(S)),e[0]!==e[1]&&(S[2]=e[1],v.push(r(S)))}return j6(v)}const s=Math.pow(2,this.z),a=fc/s,u=this.x*a+t*fc,l=fc-(this.y+1)*a;return new By([u,l,e[0]],[u+a,l+a,e[1]])}}function W6(i,e,t,r){const s=i instanceof IB&&i.resolution?i.projectPosition:null,a=Object.values(i.getFrustumPlanes()).map(({normal:O,distance:$})=>new Bh(O.clone().negate(),$)),u=new Qn(a),l=i.distanceScales.unitsPerMeter[2],g=t&&t[0]*l||0,v=t&&t[1]*l||0,T=i instanceof ra&&i.pitch<=60?e:0;if(r){const[O,$,W,G]=r,Q=ia([O,G]),ae=ia([W,$]);r=[Q[0],fc-Q[1],ae[0],fc-ae[1]]}const S=new pc(0,0,0),P={viewport:i,project:s,cullingVolume:u,elevationBounds:[g,v],minZ:T,maxZ:e,bounds:r,offset:0};if(S.update(P),i instanceof ra&&i.subViewports&&i.subViewports.length>1){for(P.offset=-1;S.update(P)&&!(--P.offset<-Vw););for(P.offset=1;S.update(P)&&!(++P.offset>Vw););}return S.getSelected()}const ro=512,H6=[-1/0,-1/0,1/0,1/0],q6={equal:(i,e)=>{if(i===e)return!0;if(!Array.isArray(i)||!Array.isArray(e))return!1;const t=i.length;if(t!==e.length)return!1;for(let r=0;r<t;r++)if(i[r]!==e[r])return!1;return!0}};function Uy(i,e){const t=[e.transformAsPoint([i[0],i[1]]),e.transformAsPoint([i[2],i[1]]),e.transformAsPoint([i[0],i[3]]),e.transformAsPoint([i[2],i[3]])];return[Math.min(...t.map(s=>s[0])),Math.min(...t.map(s=>s[1])),Math.max(...t.map(s=>s[0])),Math.max(...t.map(s=>s[1]))]}function X6(i){return Math.abs(i.split("").reduce((e,t)=>(e<<5)-e+t.charCodeAt(0)|0,0))}function Z6(i,e){if(!i||!i.length)return null;const{index:t,id:r}=e;if(Array.isArray(i)){const a=X6(r)%i.length;i=i[a]}let s=i;for(const a of Object.keys(t)){const u=new RegExp(`{${a}}`,"g");s=s.replace(u,String(t[a]))}return Number.isInteger(t.y)&&Number.isInteger(t.z)&&(s=s.replace(/\{-y\}/g,String(Math.pow(2,t.z)-t.y-1))),s}function Y6(i,e,t){let r;return r=i.getBounds(),i.isGeospatial?[Math.max(r[0],t[0]),Math.max(r[1],t[1]),Math.min(r[2],t[2]),Math.min(r[3],t[3])]:[Math.max(Math.min(r[0],t[2]),t[0]),Math.max(Math.min(r[1],t[3]),t[1]),Math.min(Math.max(r[2],t[0]),t[2]),Math.min(Math.max(r[3],t[1]),t[3])]}function G6({viewport:i,z:e,cullRect:t}){return(i.subViewports||[i]).map(s=>C_(s,e||0,t))}function C_(i,e,t){if(!Array.isArray(e)){const a=t.x-i.x,u=t.y-i.y,{width:l,height:g}=t,v={targetZ:e},T=i.unproject([a,u],v),S=i.unproject([a+l,u],v),P=i.unproject([a,u+g],v),O=i.unproject([a+l,u+g],v);return[Math.min(T[0],S[0],P[0],O[0]),Math.min(T[1],S[1],P[1],O[1]),Math.max(T[0],S[0],P[0],O[0]),Math.max(T[1],S[1],P[1],O[1])]}const r=C_(i,e[0],t),s=C_(i,e[1],t);return[Math.min(r[0],s[0]),Math.min(r[1],s[1]),Math.max(r[2],s[2]),Math.max(r[3],s[3])]}function K6(i,e,t){return t?Uy(i,t).map(s=>s*e/ro):i.map(r=>r*e/ro)}function Vy(i,e){return Math.pow(2,i)*ro/e}function P_(i,e,t){const r=Vy(t,ro),s=i/r*360-180,a=Math.PI-2*Math.PI*e/r,u=180/Math.PI*Math.atan(.5*(Math.exp(a)-Math.exp(-a)));return[s,u]}function jw(i,e,t,r){const s=Vy(t,r);return[i/s*ro,e/s*ro]}function J6(i,e,t,r,s=ro){if(i.isGeospatial){const[v,T]=P_(e,t,r),[S,P]=P_(e+1,t+1,r);return{west:v,north:T,east:S,south:P}}const[a,u]=jw(e,t,r,s),[l,g]=jw(e+1,t+1,r,s);return{left:a,top:u,right:l,bottom:g}}function Q6(i,e,t,r,s){const a=Y6(i,null,r),u=Vy(e,t),[l,g,v,T]=K6(a,u,s),S=[];for(let P=Math.floor(l);P<v;P++)for(let O=Math.floor(g);O<T;O++)S.push({x:P,y:O,z:e});return S}function e5({viewport:i,maxZoom:e,minZoom:t,zRange:r,extent:s,tileSize:a=ro,modelMatrix:u,modelMatrixInverse:l,zoomOffset:g=0}){let v=i.isGeospatial?Math.round(i.zoom+Math.log2(ro/a))+g:Math.ceil(i.zoom)+g;if(typeof t=="number"&&Number.isFinite(t)&&v<t){if(!s)return[];v=t}typeof e=="number"&&Number.isFinite(e)&&v>e&&(v=e);let T=s;return u&&l&&s&&!i.isGeospatial&&(T=Uy(s,u)),i.isGeospatial?W6(i,v,r,s):Q6(i,v,a,T||H6,l)}function t5(i){let e={},t;return r=>{for(const s in r)if(!i5(r[s],e[s])){t=i(r),e=r;break}return t}}function i5(i,e){if(i===e)return!0;if(Array.isArray(i)){const t=i.length;if(!e||e.length!==t)return!1;for(let r=0;r<t;r++)if(i[r]!==e[r])return!1;return!0}return!1}const $w=1,Ip=2,r5="never",s5="no-overlap",jy="best-available",n5=5,o5={[jy]:c5,[s5]:u5,[r5]:()=>{}},a5={extent:null,tileSize:512,maxZoom:null,minZoom:null,maxCacheSize:null,maxCacheByteSize:null,refinementStrategy:"best-available",zRange:null,maxRequests:6,debounceTime:0,zoomOffset:0,onTileLoad:()=>{},onTileUnload:()=>{},onTileError:()=>{}};class l5{constructor(e){this._getCullBounds=t5(G6),this.opts={...a5,...e},this.setOptions(this.opts),this.onTileLoad=t=>{this.opts.onTileLoad?.(t),this.opts.maxCacheByteSize!==null&&(this._cacheByteSize+=t.byteLength,this._resizeCache())},this._requestScheduler=new e3({throttleRequests:this.opts.maxRequests>0||this.opts.debounceTime>0,maxRequests:this.opts.maxRequests,debounceTime:this.opts.debounceTime}),this._cache=new Map,this._tiles=[],this._dirty=!1,this._cacheByteSize=0,this._viewport=null,this._zRange=null,this._selectedTiles=null,this._frameNumber=0,this._modelMatrix=new Mr,this._modelMatrixInverse=new Mr}get tiles(){return this._tiles}get selectedTiles(){return this._selectedTiles}get isLoaded(){return this._selectedTiles!==null&&this._selectedTiles.every(e=>e.isLoaded)}get needsReload(){return this._selectedTiles!==null&&this._selectedTiles.some(e=>e.needsReload)}setOptions(e){Object.assign(this.opts,e),Number.isFinite(e.maxZoom)&&(this._maxZoom=Math.floor(e.maxZoom)),Number.isFinite(e.minZoom)&&(this._minZoom=Math.ceil(e.minZoom))}finalize(){for(const e of this._cache.values())e.isLoading&&e.abort();this._cache.clear(),this._tiles=[],this._selectedTiles=null}reloadAll(){for(const e of this._cache.keys()){const t=this._cache.get(e);!this._selectedTiles||!this._selectedTiles.includes(t)?this._cache.delete(e):t.setNeedsReload()}}update(e,{zRange:t,modelMatrix:r}={zRange:null,modelMatrix:null}){const s=r?new Mr(r):new Mr,a=!s.equals(this._modelMatrix);if(!this._viewport||!e.equals(this._viewport)||!eo(this._zRange,t)||a){a&&(this._modelMatrixInverse=s.clone().invert(),this._modelMatrix=s),this._viewport=e,this._zRange=t;const l=this.getTileIndices({viewport:e,maxZoom:this._maxZoom,minZoom:this._minZoom,zRange:t,modelMatrix:this._modelMatrix,modelMatrixInverse:this._modelMatrixInverse});this._selectedTiles=l.map(g=>this._getTile(g,!0)),this._dirty&&this._rebuildTree()}else this.needsReload&&(this._selectedTiles=this._selectedTiles.map(l=>this._getTile(l.index,!0)));const u=this.updateTileStates();return this._pruneRequests(),this._dirty&&this._resizeCache(),u&&this._frameNumber++,this._frameNumber}isTileVisible(e,t,r){if(!e.isVisible)return!1;if(t&&this._viewport){const s=this._getCullBounds({viewport:this._viewport,z:this._zRange,cullRect:t});let{bbox:a}=e;for(const[u,l,g,v]of s){let T;if("west"in a)T=a.west<g&&a.east>u&&a.south<v&&a.north>l;else{if(r&&!Mr.IDENTITY.equals(r)){const[O,$,W,G]=Uy([a.left,a.top,a.right,a.bottom],r);a={left:O,top:$,right:W,bottom:G}}const S=Math.min(a.top,a.bottom),P=Math.max(a.top,a.bottom);T=a.left<g&&a.right>u&&S<v&&P>l}if(T)return!0}return!1}return!0}getTileIndices({viewport:e,maxZoom:t,minZoom:r,zRange:s,modelMatrix:a,modelMatrixInverse:u}){const{tileSize:l,extent:g,zoomOffset:v}=this.opts;return e5({viewport:e,maxZoom:t,minZoom:r,zRange:s,tileSize:l,extent:g,modelMatrix:a,modelMatrixInverse:u,zoomOffset:v})}getTileId(e){return`${e.x}-${e.y}-${e.z}`}getTileZoom(e){return e.z}getTileMetadata(e){const{tileSize:t}=this.opts;return{bbox:J6(this._viewport,e.x,e.y,e.z,t)}}getParentIndex(e){const t=Math.floor(e.x/2),r=Math.floor(e.y/2),s=e.z-1;return{x:t,y:r,z:s}}updateTileStates(){const e=this.opts.refinementStrategy||jy,t=new Array(this._cache.size);let r=0;for(const s of this._cache.values())t[r++]=s.isVisible,s.isSelected=!1,s.isVisible=!1;for(const s of this._selectedTiles)s.isSelected=!0,s.isVisible=!0;(typeof e=="function"?e:o5[e])(Array.from(this._cache.values())),r=0;for(const s of this._cache.values())if(t[r++]!==s.isVisible)return!0;return!1}_pruneRequests(){const{maxRequests:e=0}=this.opts,t=[];let r=0;for(const s of this._cache.values())s.isLoading&&(r++,!s.isSelected&&!s.isVisible&&t.push(s));for(;e>0&&r>e&&t.length>0;)t.shift().abort(),r--}_rebuildTree(){const{_cache:e}=this;for(const t of e.values())t.parent=null,t.children&&(t.children.length=0);for(const t of e.values()){const r=this._getNearestAncestor(t);t.parent=r,r?.children&&r.children.push(t)}}_resizeCache(){const{_cache:e,opts:t}=this,r=t.maxCacheSize??(t.maxCacheByteSize!==null?1/0:n5*this.selectedTiles.length),s=t.maxCacheByteSize??1/0;if(e.size>r||this._cacheByteSize>s){for(const[u,l]of e)if(!l.isVisible&&!l.isSelected&&(this._cacheByteSize-=t.maxCacheByteSize!==null?l.byteLength:0,e.delete(u),this.opts.onTileUnload?.(l)),e.size<=r&&this._cacheByteSize<=s)break;this._rebuildTree(),this._dirty=!0}this._dirty&&(this._tiles=Array.from(this._cache.values()).sort((u,l)=>u.zoom-l.zoom),this._dirty=!1)}_getTile(e,t){const r=this.getTileId(e);let s=this._cache.get(r),a=!1;return!s&&t?(s=new T6(e),Object.assign(s,this.getTileMetadata(s.index)),Object.assign(s,{id:r,zoom:this.getTileZoom(s.index)}),a=!0,this._cache.set(r,s),this._dirty=!0):s&&s.needsReload&&(a=!0),s&&a&&s.loadData({getData:this.opts.getTileData,requestScheduler:this._requestScheduler,onLoad:this.onTileLoad,onError:this.opts.onTileError}),s}_getNearestAncestor(e){const{_minZoom:t=0}=this;let r=e.index;for(;this.getTileZoom(r)>t;){r=this.getParentIndex(r);const s=this._getTile(r);if(s)return s}return null}}function c5(i){for(const e of i)e.state=0;for(const e of i)e.isSelected&&!XT(e)&&$y(e);for(const e of i)e.isVisible=!!(e.state&Ip)}function u5(i){for(const t of i)t.state=0;for(const t of i)t.isSelected&&XT(t);const e=Array.from(i).sort((t,r)=>t.zoom-r.zoom);for(const t of e)if(t.isVisible=!!(t.state&Ip),t.children&&(t.isVisible||t.state&$w))for(const r of t.children)r.state=$w;else t.isSelected&&$y(t)}function XT(i){let e=i;for(;e;){if(e.isLoaded||e.content)return e.state|=Ip,!0;e=e.parent}return!1}function $y(i){for(const e of i.children)e.isLoaded||e.content?e.state|=Ip:$y(e)}const h5={TilesetClass:l5,data:{type:"data",value:[]},dataComparator:q6.equal,renderSubLayers:{type:"function",value:i=>new Fy(i)},getTileData:{type:"function",optional:!0,value:null},onViewportLoad:{type:"function",optional:!0,value:null},onTileLoad:{type:"function",value:i=>{}},onTileUnload:{type:"function",value:i=>{}},onTileError:{type:"function",value:i=>console.error(i)},extent:{type:"array",optional:!0,value:null,compare:!0},tileSize:512,maxZoom:null,minZoom:0,maxCacheSize:null,maxCacheByteSize:null,refinementStrategy:jy,zRange:null,maxRequests:6,debounceTime:0,zoomOffset:0};class Wy extends Tp{initializeState(){this.state={tileset:null,isLoaded:!1}}finalizeState(){this.state?.tileset?.finalize()}get isLoaded(){return!!this.state?.tileset?.selectedTiles?.every(e=>e.isLoaded&&e.layers&&e.layers.every(t=>t.isLoaded))}shouldUpdateState({changeFlags:e}){return e.somethingChanged}updateState({changeFlags:e}){let{tileset:t}=this.state;const r=e.propsOrDataChanged||e.updateTriggersChanged,s=e.dataChanged||e.updateTriggersChanged&&(e.updateTriggersChanged.all||e.updateTriggersChanged.getTileData);t?r&&(t.setOptions(this._getTilesetOptions()),s?t.reloadAll():t.tiles.forEach(a=>{a.layers=null})):(t=new this.props.TilesetClass(this._getTilesetOptions()),this.setState({tileset:t})),this._updateTileset()}_getTilesetOptions(){const{tileSize:e,maxCacheSize:t,maxCacheByteSize:r,refinementStrategy:s,extent:a,maxZoom:u,minZoom:l,maxRequests:g,debounceTime:v,zoomOffset:T}=this.props;return{maxCacheSize:t,maxCacheByteSize:r,maxZoom:u,minZoom:l,tileSize:e,refinementStrategy:s,extent:a,maxRequests:g,debounceTime:v,zoomOffset:T,getTileData:this.getTileData.bind(this),onTileLoad:this._onTileLoad.bind(this),onTileError:this._onTileError.bind(this),onTileUnload:this._onTileUnload.bind(this)}}_updateTileset(){const e=this.state.tileset,{zRange:t,modelMatrix:r}=this.props,s=e.update(this.context.viewport,{zRange:t,modelMatrix:r}),{isLoaded:a}=e,u=this.state.isLoaded!==a,l=this.state.frameNumber!==s;a&&(u||l)&&this._onViewportLoad(),l&&this.setState({frameNumber:s}),this.state.isLoaded=a}_onViewportLoad(){const{tileset:e}=this.state,{onViewportLoad:t}=this.props;t&&t(e.selectedTiles)}_onTileLoad(e){this.props.onTileLoad(e),e.layers=null,this.setNeedsUpdate()}_onTileError(e,t){this.props.onTileError(e),t.layers=null,this.setNeedsUpdate()}_onTileUnload(e){this.props.onTileUnload(e)}getTileData(e){const{data:t,getTileData:r,fetch:s}=this.props,{signal:a}=e;return e.url=typeof t=="string"||Array.isArray(t)?Z6(t,e):null,r?r(e):s&&e.url?s(e.url,{propName:"data",layer:this,signal:a}):null}renderSubLayers(e){return this.props.renderSubLayers(e)}getSubLayerPropsByTile(e){return null}getPickingInfo(e){const t=e.sourceLayer,r=t.props.tile,s=e.info;return s.picked&&(s.tile=r),s.sourceTile=r,s.sourceTileSubLayer=t,s}_updateAutoHighlight(e){e.sourceTileSubLayer.updateAutoHighlight(e)}renderLayers(){return this.state.tileset.tiles.map(e=>{const t=this.getSubLayerPropsByTile(e);if(!(!e.isLoaded&&!e.content))if(e.layers)t&&e.layers[0]&&Object.keys(t).some(r=>e.layers[0].props[r]!==t[r])&&(e.layers=e.layers.map(r=>r.clone(t)));else{const r=this.renderSubLayers({...this.props,...this.getSubLayerProps({id:e.id,updateTriggers:this.props.updateTriggers}),data:e.content,_offset:0,tile:e});e.layers=xp(r,Boolean).map(s=>s.clone({tile:e,...t}))}return e.layers})}filterSubLayer({layer:e,cullRect:t}){const{tile:r}=e.props,{modelMatrix:s}=this.props;return this.state.tileset.isTileVisible(r,t,s?new Mr(s):null)}}Wy.defaultProps=h5;Wy.layerName="TileLayer";const d5=({clusters:i,activeBaseLayer:e,showReference:t,radiusKm:r,lat:s,lon:a,markerHitSize:u})=>je.useMemo(()=>{const l=[];return e.overlayUrl&&e.overlayMode!=="map"&&l.push(new Wy({id:`base-overlay-${e.id??"unknown"}`,data:e.overlayUrl,minZoom:0,maxZoom:e.overlayMaxZoom??22,tileSize:256,opacity:e.overlayOpacity||1,renderSubLayers:g=>{const{bbox:{west:v,south:T,east:S,north:P}}=g.tile;return new Ry(g,{data:void 0,image:g.data,bounds:[v,T,S,P],parameters:{depthTest:!1}})}})),t&&r&&l.push(new Lh({id:"radius-circle",data:[{position:[a,s]}],getPosition:g=>g.position,getRadius:r*1e3,radiusUnits:"meters",getFillColor:[239,68,68,30],getLineColor:[239,68,68,150],lineWidthMinPixels:2,stroked:!0,filled:!0,parameters:{depthTest:!1}})),t&&l.push(new Lh({id:"center-dot",data:[{position:[a,s]}],getPosition:g=>g.position,getRadius:300,radiusUnits:"meters",getFillColor:[239,68,68,255],lineWidthMinPixels:2,stroked:!1,filled:!0,parameters:{depthTest:!1}})),l.push(new Ko({id:"icon-backgrounds",data:i,getPosition:g=>g.geometry.coordinates,getIcon:()=>({url:EN,width:128,height:128,anchorY:64,anchorX:64}),getSize:35,getPixelOffset:g=>[g.properties.xOffset||0,0],pickable:!1,parameters:{depthTest:!1}})),l.push(new Ko({id:"icons",data:i,getPosition:g=>g.geometry.coordinates,getIcon:g=>{const v=g.properties.kind;return{url:AN[v],width:za,height:za,anchorY:gf,anchorX:gf,mask:!1}},getSize:25,getPixelOffset:g=>[g.properties.xOffset||0,0],pickable:!1,parameters:{depthTest:!1},getColor:[255,255,255,255]})),l.push(new Ko({id:"cluster-pastilles",data:i.filter(g=>g.properties.cluster),getPosition:g=>g.geometry.coordinates,getIcon:()=>({url:IN,width:128,height:128,anchorY:64,anchorX:64}),getSize:18,getPixelOffset:g=>[g.properties.xOffset+11,11],parameters:{depthTest:!1},pickable:!1})),l.push(new Ep({id:"cluster-numbers",data:i.filter(g=>g.properties.cluster),getPosition:g=>g.geometry.coordinates,getText:g=>String(g.properties.count||1),getSize:11,getPixelOffset:g=>[g.properties.xOffset+11,11],parameters:{depthTest:!1},getColor:[255,255,255],fontWeight:800,fontFamily:"system-ui, sans-serif",getTextAnchor:"middle",getAlignmentBaseline:"center",pickable:!1})),l.push(new Ko({id:"marker-hit-areas",data:i,getPosition:g=>g.geometry.coordinates,getIcon:()=>({url:CN,width:za,height:za,anchorY:gf,anchorX:gf,mask:!0}),getSize:u,getPixelOffset:g=>[g.properties.xOffset||0,0],getColor:[0,0,0,0],opacity:0,alphaCutoff:0,pickable:!0,parameters:{depthTest:!1,depthMask:!1}})),l},[i,e,t,r,s,a,u]);var Fs=Uint8Array,gc=Uint16Array,f5=Int32Array,ZT=new Fs([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),YT=new Fs([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),p5=new Fs([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),GT=function(i,e){for(var t=new gc(31),r=0;r<31;++r)t[r]=e+=1<<i[r-1];for(var s=new f5(t[30]),r=1;r<30;++r)for(var a=t[r];a<t[r+1];++a)s[a]=a-t[r]<<5|r;return{b:t,r:s}},KT=GT(ZT,2),JT=KT.b,g5=KT.r;JT[28]=258,g5[258]=28;var m5=GT(YT,0),_5=m5.b,M_=new gc(32768);for(var zi=0;zi<32768;++zi){var $o=(zi&43690)>>1|(zi&21845)<<1;$o=($o&52428)>>2|($o&13107)<<2,$o=($o&61680)>>4|($o&3855)<<4,M_[zi]=(($o&65280)>>8|($o&255)<<8)>>1}var Ch=(function(i,e,t){for(var r=i.length,s=0,a=new gc(e);s<r;++s)i[s]&&++a[i[s]-1];var u=new gc(e);for(s=1;s<e;++s)u[s]=u[s-1]+a[s-1]<<1;var l;if(t){l=new gc(1<<e);var g=15-e;for(s=0;s<r;++s)if(i[s])for(var v=s<<4|i[s],T=e-i[s],S=u[i[s]-1]++<<T,P=S|(1<<T)-1;S<=P;++S)l[M_[S]>>g]=v}else for(l=new gc(r),s=0;s<r;++s)i[s]&&(l[s]=M_[u[i[s]-1]++]>>15-i[s]);return l}),Wh=new Fs(288);for(var zi=0;zi<144;++zi)Wh[zi]=8;for(var zi=144;zi<256;++zi)Wh[zi]=9;for(var zi=256;zi<280;++zi)Wh[zi]=7;for(var zi=280;zi<288;++zi)Wh[zi]=8;var QT=new Fs(32);for(var zi=0;zi<32;++zi)QT[zi]=5;var y5=Ch(Wh,9,1),x5=Ch(QT,5,1),Fm=function(i){for(var e=i[0],t=1;t<i.length;++t)i[t]>e&&(e=i[t]);return e},on=function(i,e,t){var r=e/8|0;return(i[r]|i[r+1]<<8)>>(e&7)&t},Bm=function(i,e){var t=e/8|0;return(i[t]|i[t+1]<<8|i[t+2]<<16)>>(e&7)},v5=function(i){return(i+7)/8|0},b5=function(i,e,t){return(t==null||t>i.length)&&(t=i.length),new Fs(i.subarray(e,t))},w5=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],Os=function(i,e,t){var r=new Error(e||w5[i]);if(r.code=i,Error.captureStackTrace&&Error.captureStackTrace(r,Os),!t)throw r;return r},Hy=function(i,e,t,r){var s=i.length,a=0;if(!s||e.f&&!e.l)return t||new Fs(0);var u=!t,l=u||e.i!=2,g=e.i;u&&(t=new Fs(s*3));var v=function(Li){var bi=t.length;if(Li>bi){var Ri=new Fs(Math.max(bi*2,Li));Ri.set(t),t=Ri}},T=e.f||0,S=e.p||0,P=e.b||0,O=e.l,$=e.d,W=e.m,G=e.n,Q=s*8;do{if(!O){T=on(i,S,1);var ae=on(i,S+1,3);if(S+=3,ae)if(ae==1)O=y5,$=x5,W=9,G=5;else if(ae==2){var Oe=on(i,S,31)+257,Je=on(i,S+10,15)+4,it=Oe+on(i,S+5,31)+1;S+=14;for(var He=new Fs(it),ht=new Fs(19),Ye=0;Ye<Je;++Ye)ht[p5[Ye]]=on(i,S+Ye*3,7);S+=Je*3;for(var ft=Fm(ht),Ke=(1<<ft)-1,Ze=Ch(ht,ft,1),Ye=0;Ye<it;){var ve=Ze[on(i,S,Ke)];S+=ve&15;var te=ve>>4;if(te<16)He[Ye++]=te;else{var ie=0,ge=0;for(te==16?(ge=3+on(i,S,3),S+=2,ie=He[Ye-1]):te==17?(ge=3+on(i,S,7),S+=3):te==18&&(ge=11+on(i,S,127),S+=7);ge--;)He[Ye++]=ie}}var ce=He.subarray(0,Oe),ke=He.subarray(Oe);W=Fm(ce),G=Fm(ke),O=Ch(ce,W,1),$=Ch(ke,G,1)}else Os(1);else{var te=v5(S)+4,me=i[te-4]|i[te-3]<<8,we=te+me;if(we>s){g&&Os(0);break}l&&v(P+me),t.set(i.subarray(te,we),P),e.b=P+=me,e.p=S=we*8,e.f=T;continue}if(S>Q){g&&Os(0);break}}l&&v(P+131072);for(var Be=(1<<W)-1,Ve=(1<<G)-1,We=S;;We=S){var ie=O[Bm(i,S)&Be],tt=ie>>4;if(S+=ie&15,S>Q){g&&Os(0);break}if(ie||Os(2),tt<256)t[P++]=tt;else if(tt==256){We=S,O=null;break}else{var wt=tt-254;if(tt>264){var Ye=tt-257,_t=ZT[Ye];wt=on(i,S,(1<<_t)-1)+JT[Ye],S+=_t}var $t=$[Bm(i,S)&Ve],kt=$t>>4;$t||Os(3),S+=$t&15;var ke=_5[kt];if(kt>3){var _t=YT[kt];ke+=Bm(i,S)&(1<<_t)-1,S+=_t}if(S>Q){g&&Os(0);break}l&&v(P+131072);var Bt=P+wt;if(P<ke){var Kt=a-ke,Et=Math.min(ke,Bt);for(Kt+P<0&&Os(3);P<Et;++P)t[P]=r[Kt+P]}for(;P<Bt;++P)t[P]=t[P-ke]}}e.l=O,e.p=We,e.b=P,e.f=T,O&&(T=1,e.m=W,e.d=$,e.n=G)}while(!T);return P!=t.length&&u?b5(t,0,P):t.subarray(0,P)},T5=new Fs(0),S5=function(i){(i[0]!=31||i[1]!=139||i[2]!=8)&&Os(6,"invalid gzip data");var e=i[3],t=10;e&4&&(t+=(i[10]|i[11]<<8)+2);for(var r=(e>>3&1)+(e>>4&1);r>0;r-=!i[t++]);return t+(e&2)},A5=function(i){var e=i.length;return(i[e-4]|i[e-3]<<8|i[e-2]<<16|i[e-1]<<24)>>>0},E5=function(i,e){return((i[0]&15)!=8||i[0]>>4>7||(i[0]<<8|i[1])%31)&&Os(6,"invalid zlib data"),(i[1]>>5&1)==1&&Os(6,"invalid zlib data: "+(i[1]&32?"need":"unexpected")+" dictionary"),(i[1]>>3&4)+2};function I5(i,e){return Hy(i,{i:2},e,e)}function C5(i,e){var t=S5(i);return t+8>i.length&&Os(6,"invalid gzip data"),Hy(i.subarray(t,-8),{i:2},new Fs(A5(i)),e)}function P5(i,e){return Hy(i.subarray(E5(i),-4),{i:2},e,e)}function M5(i,e){return i[0]==31&&i[1]==139&&i[2]==8?C5(i,e):(i[0]&15)!=8||i[0]>>4>7||(i[0]<<8|i[1])%31?I5(i,e):P5(i,e)}var R5=typeof TextDecoder<"u"&&new TextDecoder,k5=0;try{R5.decode(T5,{stream:!0}),k5=1}catch{}var D5=Object.defineProperty,O5=Math.pow,Pi=(i,e)=>D5(i,"name",{value:e,configurable:!0}),Tr=(i,e,t)=>new Promise((r,s)=>{var a=g=>{try{l(t.next(g))}catch(v){s(v)}},u=g=>{try{l(t.throw(g))}catch(v){s(v)}},l=g=>g.done?r(g.value):Promise.resolve(g.value).then(a,u);l((t=t.apply(i,e)).next())});Pi((i,e)=>{let t=!1,r="",s=L.GridLayer.extend({createTile:Pi((a,u)=>{let l=document.createElement("img"),g=new AbortController,v=g.signal;return l.cancel=()=>{g.abort()},t||(i.getHeader().then(T=>{T.tileType===1?console.error("Error: archive contains MVT vector tiles, but leafletRasterLayer is for displaying raster tiles. See https://github.com/protomaps/PMTiles/tree/main/js for details."):T.tileType===2?r="image/png":T.tileType===3?r="image/jpeg":T.tileType===4?r="image/webp":T.tileType===5&&(r="image/avif")}),t=!0),i.getZxy(a.z,a.x,a.y,v).then(T=>{if(T){let S=new Blob([T.data],{type:r}),P=window.URL.createObjectURL(S);l.src=P}else l.style.display="none";l.cancel=void 0,u(void 0,l)}).catch(T=>{if(T.name!=="AbortError")throw T}),l},"createTile"),_removeTile:Pi(function(a){let u=this._tiles[a];u&&(u.el.cancel&&u.el.cancel(),u.el.width=0,u.el.height=0,u.el.deleted=!0,L.DomUtil.remove(u.el),delete this._tiles[a],this.fire("tileunload",{tile:u.el,coords:this._keyToTileCoords(a)}))},"_removeTile")});return new s(e)},"leafletRasterLayer");var L5=Pi(i=>(e,t)=>{if(t instanceof AbortController)return i(e,t);let r=new AbortController;return i(e,r).then(s=>t(void 0,s.data,s.cacheControl||"",s.expires||""),s=>t(s)).catch(s=>t(s)),{cancel:Pi(()=>r.abort(),"cancel")}},"v3compat"),eS=class{constructor(e){this.tilev4=Pi((t,r)=>Tr(this,null,function*(){if(t.type==="json"){let O=t.url.substr(10),$=this.tiles.get(O);if($||($=new k_(O),this.tiles.set(O,$)),this.metadata){let G=yield $.getTileJson(t.url);return r.signal.throwIfAborted(),{data:G}}let W=yield $.getHeader();return r.signal.throwIfAborted(),(W.minLon>=W.maxLon||W.minLat>=W.maxLat)&&console.error(`Bounds of PMTiles archive ${W.minLon},${W.minLat},${W.maxLon},${W.maxLat} are not valid.`),{data:{tiles:[`${t.url}/{z}/{x}/{y}`],minzoom:W.minZoom,maxzoom:W.maxZoom,bounds:[W.minLon,W.minLat,W.maxLon,W.maxLat]}}}let s=new RegExp(/pmtiles:\/\/(.+)\/(\d+)\/(\d+)\/(\d+)/),a=t.url.match(s);if(!a)throw new Error("Invalid PMTiles protocol URL");let u=a[1],l=this.tiles.get(u);l||(l=new k_(u),this.tiles.set(u,l));let g=a[2],v=a[3],T=a[4],S=yield l.getHeader(),P=yield l?.getZxy(+g,+v,+T,r.signal);if(r.signal.throwIfAborted(),P)return{data:new Uint8Array(P.data),cacheControl:P.cacheControl,expires:P.expires};if(S.tileType===1){if(this.errorOnMissingTile)throw new Error("Tile not found.");return{data:new Uint8Array}}return{data:null}}),"tilev4"),this.tile=L5(this.tilev4),this.tiles=new Map,this.metadata=e?.metadata||!1,this.errorOnMissingTile=e?.errorOnMissingTile||!1}add(e){this.tiles.set(e.source.getKey(),e)}get(e){return this.tiles.get(e)}};Pi(eS,"Protocol");var F5=eS;function tS(i,e){return(e>>>0)*4294967296+(i>>>0)}Pi(tS,"toNum");function iS(i,e){let t=e.buf,r=t[e.pos++],s=(r&112)>>4;if(r<128||(r=t[e.pos++],s|=(r&127)<<3,r<128)||(r=t[e.pos++],s|=(r&127)<<10,r<128)||(r=t[e.pos++],s|=(r&127)<<17,r<128)||(r=t[e.pos++],s|=(r&127)<<24,r<128)||(r=t[e.pos++],s|=(r&1)<<31,r<128))return tS(i,s);throw new Error("Expected varint not more than 10 bytes")}Pi(iS,"readVarintRemainder");function nc(i){let e=i.buf,t=e[i.pos++],r=t&127;return t<128||(t=e[i.pos++],r|=(t&127)<<7,t<128)||(t=e[i.pos++],r|=(t&127)<<14,t<128)||(t=e[i.pos++],r|=(t&127)<<21,t<128)?r:(t=e[i.pos],r|=(t&15)<<28,iS(r,i))}Pi(nc,"readVarint");function qy(i,e,t,r,s){return s===0?r!==0?[i-1-t,i-1-e]:[t,e]:[e,t]}Pi(qy,"rotate");function rS(i,e,t){if(i>26)throw new Error("Tile zoom level exceeds max safe number limit (26)");if(e>=1<<i||t>=1<<i)throw new Error("tile x/y outside zoom level bounds");let r=((1<<i)*(1<<i)-1)/3,s=i-1,[a,u]=[e,t];for(let l=1<<s;l>0;l>>=1){let g=a&l,v=u&l;r+=(3*g^v)*(1<<s),[a,u]=qy(l,a,u,g,v),s--}return r}Pi(rS,"zxyToTileId");function sS(i){let e=3*i+1;return e<4294967296?31-Math.clz32(e):63-Math.clz32(e/4294967296)}Pi(sS,"tileIdToZ");function B5(i){let e=sS(i)>>1;if(e>26)throw new Error("Tile zoom level exceeds max safe number limit (26)");let t=((1<<e)*(1<<e)-1)/3,r=i-t,s=0,a=0,u=1<<e;for(let l=1;l<u;l<<=1){let g=l&r/2,v=l&(r^g);[s,a]=qy(l,s,a,g,v),r=r/2,s+=g,a+=v}return[e,s,a]}Pi(B5,"tileIdToZxy");var N5=(i=>(i[i.Unknown=0]="Unknown",i[i.None=1]="None",i[i.Gzip=2]="Gzip",i[i.Brotli=3]="Brotli",i[i.Zstd=4]="Zstd",i))(N5||{});function Cp(i,e){return Tr(this,null,function*(){if(e===1||e===0)return i;if(e===2){if(typeof globalThis.DecompressionStream>"u")return M5(new Uint8Array(i));let t=new Response(i).body;if(!t)throw new Error("Failed to read response stream");let r=t.pipeThrough(new globalThis.DecompressionStream("gzip"));return new Response(r).arrayBuffer()}throw new Error("Compression method not supported")})}Pi(Cp,"defaultDecompress");var z5=(i=>(i[i.Unknown=0]="Unknown",i[i.Mvt=1]="Mvt",i[i.Png=2]="Png",i[i.Jpeg=3]="Jpeg",i[i.Webp=4]="Webp",i[i.Avif=5]="Avif",i))(z5||{});function nS(i){return i===1?".mvt":i===2?".png":i===3?".jpg":i===4?".webp":i===5?".avif":""}Pi(nS,"tileTypeExt");var U5=127;function oS(i,e){let t=0,r=i.length-1;for(;t<=r;){let s=r+t>>1,a=e-i[s].tileId;if(a>0)t=s+1;else if(a<0)r=s-1;else return i[s]}return r>=0&&(i[r].runLength===0||e-i[r].tileId<i[r].runLength)?i[r]:null}Pi(oS,"findTile");var V5=class{constructor(e){this.file=e}getKey(){return this.file.name}getBytes(e,t){return Tr(this,null,function*(){return{data:yield this.file.slice(e,e+t).arrayBuffer()}})}};Pi(V5,"FileSource");var aS=class{constructor(e,t=new Headers){var r,s;this.url=e,this.customHeaders=t,this.mustReload=!1;let a="";"navigator"in globalThis&&(a=(s=(r=globalThis.navigator)==null?void 0:r.userAgent)!=null?s:"");let u=a.indexOf("Windows")>-1,l=/Chrome|Chromium|Edg|OPR|Brave/.test(a);this.chromeWindowsNoCache=!1,u&&l&&(this.chromeWindowsNoCache=!0)}getKey(){return this.url}setHeaders(e){this.customHeaders=e}getBytes(e,t,r,s){return Tr(this,null,function*(){let a,u;r?u=r:(a=new AbortController,u=a.signal);let l=new Headers(this.customHeaders);l.set("range",`bytes=${e}-${e+t-1}`);let g;this.mustReload?g="reload":this.chromeWindowsNoCache&&(g="no-store");let v=yield fetch(this.url,{signal:u,cache:g,headers:l});if(e===0&&v.status===416){let P=v.headers.get("Content-Range");if(!P||!P.startsWith("bytes */"))throw new Error("Missing content-length on 416 response");let O=+P.substr(8);v=yield fetch(this.url,{signal:u,cache:"reload",headers:{range:`bytes=0-${O-1}`}})}let T=v.headers.get("Etag");if(T!=null&&T.startsWith("W/")&&(T=null),v.status===416||s&&T&&T!==s)throw this.mustReload=!0,new R_(`Server returned non-matching ETag ${s} after one retry. Check browser extensions and servers for issues that may affect correct ETag headers.`);if(v.status>=300)throw new Error(`Bad response code: ${v.status}`);let S=v.headers.get("Content-Length");if(v.status===200&&(!S||+S>t))throw a&&a.abort(),new Error("Server returned no content-length header or content-length exceeding request. Check that your storage backend supports HTTP Byte Serving.");return{data:yield v.arrayBuffer(),etag:T||void 0,cacheControl:v.headers.get("Cache-Control")||void 0,expires:v.headers.get("Expires")||void 0}})}};Pi(aS,"FetchSource");var j5=aS;function Xs(i,e){let t=i.getUint32(e+4,!0),r=i.getUint32(e+0,!0);return t*O5(2,32)+r}Pi(Xs,"getUint64");function lS(i,e){let t=new DataView(i),r=t.getUint8(7);if(r>3)throw new Error(`Archive is spec version ${r} but this library supports up to spec version 3`);return{specVersion:r,rootDirectoryOffset:Xs(t,8),rootDirectoryLength:Xs(t,16),jsonMetadataOffset:Xs(t,24),jsonMetadataLength:Xs(t,32),leafDirectoryOffset:Xs(t,40),leafDirectoryLength:Xs(t,48),tileDataOffset:Xs(t,56),tileDataLength:Xs(t,64),numAddressedTiles:Xs(t,72),numTileEntries:Xs(t,80),numTileContents:Xs(t,88),clustered:t.getUint8(96)===1,internalCompression:t.getUint8(97),tileCompression:t.getUint8(98),tileType:t.getUint8(99),minZoom:t.getUint8(100),maxZoom:t.getUint8(101),minLon:t.getInt32(102,!0)/1e7,minLat:t.getInt32(106,!0)/1e7,maxLon:t.getInt32(110,!0)/1e7,maxLat:t.getInt32(114,!0)/1e7,centerZoom:t.getUint8(118),centerLon:t.getInt32(119,!0)/1e7,centerLat:t.getInt32(123,!0)/1e7,etag:e}}Pi(lS,"bytesToHeader");function Xy(i){let e={buf:new Uint8Array(i),pos:0},t=nc(e),r=[],s=0;for(let a=0;a<t;a++){let u=nc(e);r.push({tileId:s+u,offset:0,length:0,runLength:1}),s+=u}for(let a=0;a<t;a++)r[a].runLength=nc(e);for(let a=0;a<t;a++)r[a].length=nc(e);for(let a=0;a<t;a++){let u=nc(e);u===0&&a>0?r[a].offset=r[a-1].offset+r[a-1].length:r[a].offset=u-1}return r}Pi(Xy,"deserializeIndex");var cS=class extends Error{};Pi(cS,"EtagMismatch");var R_=cS;function Zy(i,e){return Tr(this,null,function*(){let t=yield i.getBytes(0,16384);if(new DataView(t.data).getUint16(0,!0)!==19792)throw new Error("Wrong magic number for PMTiles archive");let r=t.data.slice(0,U5),s=lS(r,t.etag),a=t.data.slice(s.rootDirectoryOffset,s.rootDirectoryOffset+s.rootDirectoryLength),u=`${i.getKey()}|${s.etag||""}|${s.rootDirectoryOffset}|${s.rootDirectoryLength}`,l=Xy(yield e(a,s.internalCompression));return[s,[u,l.length,l]]})}Pi(Zy,"getHeaderAndRoot");function Yy(i,e,t,r,s){return Tr(this,null,function*(){let a=yield i.getBytes(t,r,void 0,s.etag),u=yield e(a.data,s.internalCompression),l=Xy(u);if(l.length===0)throw new Error("Empty directory is invalid");return l})}Pi(Yy,"getDirectory");var $5=class{constructor(e=100,t=!0,r=Cp){this.cache=new Map,this.maxCacheEntries=e,this.counter=1,this.decompress=r}getHeader(e){return Tr(this,null,function*(){let t=e.getKey(),r=this.cache.get(t);if(r)return r.lastUsed=this.counter++,r.data;let s=yield Zy(e,this.decompress);return s[1]&&this.cache.set(s[1][0],{lastUsed:this.counter++,data:s[1][2]}),this.cache.set(t,{lastUsed:this.counter++,data:s[0]}),this.prune(),s[0]})}getDirectory(e,t,r,s){return Tr(this,null,function*(){let a=`${e.getKey()}|${s.etag||""}|${t}|${r}`,u=this.cache.get(a);if(u)return u.lastUsed=this.counter++,u.data;let l=yield Yy(e,this.decompress,t,r,s);return this.cache.set(a,{lastUsed:this.counter++,data:l}),this.prune(),l})}prune(){if(this.cache.size>this.maxCacheEntries){let e=1/0,t;this.cache.forEach((r,s)=>{r.lastUsed<e&&(e=r.lastUsed,t=s)}),t&&this.cache.delete(t)}}invalidate(e){return Tr(this,null,function*(){this.cache.delete(e.getKey())})}};Pi($5,"ResolvedValueCache");var uS=class{constructor(e=100,t=!0,r=Cp){this.cache=new Map,this.invalidations=new Map,this.maxCacheEntries=e,this.counter=1,this.decompress=r}getHeader(e){return Tr(this,null,function*(){let t=e.getKey(),r=this.cache.get(t);if(r)return r.lastUsed=this.counter++,yield r.data;let s=new Promise((a,u)=>{Zy(e,this.decompress).then(l=>{l[1]&&this.cache.set(l[1][0],{lastUsed:this.counter++,data:Promise.resolve(l[1][2])}),a(l[0]),this.prune()}).catch(l=>{u(l)})});return this.cache.set(t,{lastUsed:this.counter++,data:s}),s})}getDirectory(e,t,r,s){return Tr(this,null,function*(){let a=`${e.getKey()}|${s.etag||""}|${t}|${r}`,u=this.cache.get(a);if(u)return u.lastUsed=this.counter++,yield u.data;let l=new Promise((g,v)=>{Yy(e,this.decompress,t,r,s).then(T=>{g(T),this.prune()}).catch(T=>{v(T)})});return this.cache.set(a,{lastUsed:this.counter++,data:l}),l})}prune(){if(this.cache.size>=this.maxCacheEntries){let e=1/0,t;this.cache.forEach((r,s)=>{r.lastUsed<e&&(e=r.lastUsed,t=s)}),t&&this.cache.delete(t)}}invalidate(e){return Tr(this,null,function*(){let t=e.getKey();if(this.invalidations.get(t))return yield this.invalidations.get(t);this.cache.delete(e.getKey());let r=new Promise((s,a)=>{this.getHeader(e).then(u=>{s(),this.invalidations.delete(t)}).catch(u=>{a(u)})});this.invalidations.set(t,r)})}};Pi(uS,"SharedPromiseCache");var W5=uS,hS=class{constructor(e,t,r){typeof e=="string"?this.source=new j5(e):this.source=e,r?this.decompress=r:this.decompress=Cp,t?this.cache=t:this.cache=new W5}getHeader(){return Tr(this,null,function*(){return yield this.cache.getHeader(this.source)})}getZxyAttempt(e,t,r,s){return Tr(this,null,function*(){let a=rS(e,t,r),u=yield this.cache.getHeader(this.source);if(e<u.minZoom||e>u.maxZoom)return;let l=u.rootDirectoryOffset,g=u.rootDirectoryLength;for(let v=0;v<=3;v++){let T=yield this.cache.getDirectory(this.source,l,g,u),S=oS(T,a);if(S){if(S.runLength>0){let P=yield this.source.getBytes(u.tileDataOffset+S.offset,S.length,s,u.etag);return{data:yield this.decompress(P.data,u.tileCompression),cacheControl:P.cacheControl,expires:P.expires}}l=u.leafDirectoryOffset+S.offset,g=S.length}else return}throw new Error("Maximum directory depth exceeded")})}getZxy(e,t,r,s){return Tr(this,null,function*(){try{return yield this.getZxyAttempt(e,t,r,s)}catch(a){if(a instanceof R_)return this.cache.invalidate(this.source),yield this.getZxyAttempt(e,t,r,s);throw a}})}getMetadataAttempt(){return Tr(this,null,function*(){let e=yield this.cache.getHeader(this.source),t=yield this.source.getBytes(e.jsonMetadataOffset,e.jsonMetadataLength,void 0,e.etag),r=yield this.decompress(t.data,e.internalCompression),s=new TextDecoder("utf-8");return JSON.parse(s.decode(r))})}getMetadata(){return Tr(this,null,function*(){try{return yield this.getMetadataAttempt()}catch(e){if(e instanceof R_)return this.cache.invalidate(this.source),yield this.getMetadataAttempt();throw e}})}getTileJson(e){return Tr(this,null,function*(){let t=yield this.getHeader(),r=yield this.getMetadata(),s=nS(t.tileType);return{tilejson:"3.0.0",scheme:"xyz",tiles:[`${e}/{z}/{x}/{y}${s}`],vector_layers:r.vector_layers,attribution:r.attribution,description:r.description,name:r.name,version:r.version,bounds:[t.minLon,t.minLat,t.maxLon,t.maxLat],center:[t.centerLon,t.centerLat,t.centerZoom],minzoom:t.minZoom,maxzoom:t.maxZoom}})}};Pi(hS,"PMTiles");var k_=hS,Wf={exports:{}};/**
 * MapLibre GL JS
 * @license 3-Clause BSD. Full text of license: https://github.com/maplibre/maplibre-gl-js/blob/v4.7.1/LICENSE.txt
 */var H5=Wf.exports,Ww;function q5(){return Ww||(Ww=1,(function(i,e){(function(t,r){i.exports=r()})(H5,(function(){var t={},r={};function s(u,l,g){if(r[u]=g,u==="index"){var v="var sharedModule = {}; ("+r.shared+")(sharedModule); ("+r.worker+")(sharedModule);",T={};return r.shared(T),r.index(t,T),typeof window<"u"&&t.setWorkerUrl(window.URL.createObjectURL(new Blob([v],{type:"text/javascript"}))),t}}s("shared",["exports"],(function(u){function l(c,o,h,f){return new(h||(h=Promise))((function(_,b){function w(R){try{I(f.next(R))}catch(k){b(k)}}function A(R){try{I(f.throw(R))}catch(k){b(k)}}function I(R){var k;R.done?_(R.value):(k=R.value,k instanceof h?k:new h((function(F){F(k)}))).then(w,A)}I((f=f.apply(c,o||[])).next())}))}function g(c){return c&&c.__esModule&&Object.prototype.hasOwnProperty.call(c,"default")?c.default:c}typeof SuppressedError=="function"&&SuppressedError;var v=T;function T(c,o){this.x=c,this.y=o}T.prototype={clone:function(){return new T(this.x,this.y)},add:function(c){return this.clone()._add(c)},sub:function(c){return this.clone()._sub(c)},multByPoint:function(c){return this.clone()._multByPoint(c)},divByPoint:function(c){return this.clone()._divByPoint(c)},mult:function(c){return this.clone()._mult(c)},div:function(c){return this.clone()._div(c)},rotate:function(c){return this.clone()._rotate(c)},rotateAround:function(c,o){return this.clone()._rotateAround(c,o)},matMult:function(c){return this.clone()._matMult(c)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(c){return this.x===c.x&&this.y===c.y},dist:function(c){return Math.sqrt(this.distSqr(c))},distSqr:function(c){var o=c.x-this.x,h=c.y-this.y;return o*o+h*h},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(c){return Math.atan2(this.y-c.y,this.x-c.x)},angleWith:function(c){return this.angleWithSep(c.x,c.y)},angleWithSep:function(c,o){return Math.atan2(this.x*o-this.y*c,this.x*c+this.y*o)},_matMult:function(c){var o=c[2]*this.x+c[3]*this.y;return this.x=c[0]*this.x+c[1]*this.y,this.y=o,this},_add:function(c){return this.x+=c.x,this.y+=c.y,this},_sub:function(c){return this.x-=c.x,this.y-=c.y,this},_mult:function(c){return this.x*=c,this.y*=c,this},_div:function(c){return this.x/=c,this.y/=c,this},_multByPoint:function(c){return this.x*=c.x,this.y*=c.y,this},_divByPoint:function(c){return this.x/=c.x,this.y/=c.y,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var c=this.y;return this.y=this.x,this.x=-c,this},_rotate:function(c){var o=Math.cos(c),h=Math.sin(c),f=h*this.x+o*this.y;return this.x=o*this.x-h*this.y,this.y=f,this},_rotateAround:function(c,o){var h=Math.cos(c),f=Math.sin(c),_=o.y+f*(this.x-o.x)+h*(this.y-o.y);return this.x=o.x+h*(this.x-o.x)-f*(this.y-o.y),this.y=_,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},T.convert=function(c){return c instanceof T?c:Array.isArray(c)?new T(c[0],c[1]):c};var S=g(v),P=O;function O(c,o,h,f){this.cx=3*c,this.bx=3*(h-c)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*o,this.by=3*(f-o)-this.cy,this.ay=1-this.cy-this.by,this.p1x=c,this.p1y=o,this.p2x=h,this.p2y=f}O.prototype={sampleCurveX:function(c){return((this.ax*c+this.bx)*c+this.cx)*c},sampleCurveY:function(c){return((this.ay*c+this.by)*c+this.cy)*c},sampleCurveDerivativeX:function(c){return(3*this.ax*c+2*this.bx)*c+this.cx},solveCurveX:function(c,o){if(o===void 0&&(o=1e-6),c<0)return 0;if(c>1)return 1;for(var h=c,f=0;f<8;f++){var _=this.sampleCurveX(h)-c;if(Math.abs(_)<o)return h;var b=this.sampleCurveDerivativeX(h);if(Math.abs(b)<1e-6)break;h-=_/b}var w=0,A=1;for(h=c,f=0;f<20&&(_=this.sampleCurveX(h),!(Math.abs(_-c)<o));f++)c>_?w=h:A=h,h=.5*(A-w)+w;return h},solve:function(c,o){return this.sampleCurveY(this.solveCurveX(c,o))}};var $=g(P);let W,G;function Q(){return W==null&&(W=typeof OffscreenCanvas<"u"&&new OffscreenCanvas(1,1).getContext("2d")&&typeof createImageBitmap=="function"),W}function ae(){if(G==null&&(G=!1,Q())){const o=new OffscreenCanvas(5,5).getContext("2d",{willReadFrequently:!0});if(o){for(let f=0;f<25;f++){const _=4*f;o.fillStyle=`rgb(${_},${_+1},${_+2})`,o.fillRect(f%5,Math.floor(f/5),1,1)}const h=o.getImageData(0,0,5,5).data;for(let f=0;f<100;f++)if(f%4!=3&&h[f]!==f){G=!0;break}}}return G||!1}function te(c,o,h,f){const _=new $(c,o,h,f);return b=>_.solve(b)}const me=te(.25,.1,.25,1);function we(c,o,h){return Math.min(h,Math.max(o,c))}function Oe(c,o,h){const f=h-o,_=((c-o)%f+f)%f+o;return _===o?h:_}function Je(c,...o){for(const h of o)for(const f in h)c[f]=h[f];return c}let it=1;function He(c,o,h){const f={};for(const _ in c)f[_]=o.call(this,c[_],_,c);return f}function ht(c,o,h){const f={};for(const _ in c)o.call(this,c[_],_,c)&&(f[_]=c[_]);return f}function Ye(c){return Array.isArray(c)?c.map(Ye):typeof c=="object"&&c?He(c,Ye):c}const ft={};function Ke(c){ft[c]||(typeof console<"u"&&console.warn(c),ft[c]=!0)}function Ze(c,o,h){return(h.y-c.y)*(o.x-c.x)>(o.y-c.y)*(h.x-c.x)}function ve(c){return typeof WorkerGlobalScope<"u"&&c!==void 0&&c instanceof WorkerGlobalScope}let ie=null;function ge(c){return typeof ImageBitmap<"u"&&c instanceof ImageBitmap}const ce="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";function ke(c,o,h,f,_){return l(this,void 0,void 0,(function*(){if(typeof VideoFrame>"u")throw new Error("VideoFrame not supported");const b=new VideoFrame(c,{timestamp:0});try{const w=b?.format;if(!w||!w.startsWith("BGR")&&!w.startsWith("RGB"))throw new Error(`Unrecognized format ${w}`);const A=w.startsWith("BGR"),I=new Uint8ClampedArray(f*_*4);if(yield b.copyTo(I,(function(R,k,F,V,j){const X=4*Math.max(-k,0),Z=(Math.max(0,F)-F)*V*4+X,se=4*V,ue=Math.max(0,k),Me=Math.max(0,F);return{rect:{x:ue,y:Me,width:Math.min(R.width,k+V)-ue,height:Math.min(R.height,F+j)-Me},layout:[{offset:Z,stride:se}]}})(c,o,h,f,_)),A)for(let R=0;R<I.length;R+=4){const k=I[R];I[R]=I[R+2],I[R+2]=k}return I}finally{b.close()}}))}let Be,Ve;const We="AbortError";function tt(){return new Error(We)}const wt={MAX_PARALLEL_IMAGE_REQUESTS:16,MAX_PARALLEL_IMAGE_REQUESTS_PER_FRAME:8,MAX_TILE_CACHE_ZOOM_LEVELS:5,REGISTERED_PROTOCOLS:{},WORKER_URL:""};function _t(c){return wt.REGISTERED_PROTOCOLS[c.substring(0,c.indexOf("://"))]}const $t="global-dispatcher";class kt extends Error{constructor(o,h,f,_){super(`AJAXError: ${h} (${o}): ${f}`),this.status=o,this.statusText=h,this.url=f,this.body=_}}const Bt=()=>ve(self)?self.worker&&self.worker.referrer:(window.location.protocol==="blob:"?window.parent:window).location.href,Kt=function(c,o){if(/:\/\//.test(c.url)&&!/^https?:|^file:/.test(c.url)){const f=_t(c.url);if(f)return f(c,o);if(ve(self)&&self.worker&&self.worker.actor)return self.worker.actor.sendAsync({type:"GR",data:c,targetMapId:$t},o)}if(!(/^file:/.test(h=c.url)||/^file:/.test(Bt())&&!/^\w+:/.test(h))){if(fetch&&Request&&AbortController&&Object.prototype.hasOwnProperty.call(Request.prototype,"signal"))return(function(f,_){return l(this,void 0,void 0,(function*(){const b=new Request(f.url,{method:f.method||"GET",body:f.body,credentials:f.credentials,headers:f.headers,cache:f.cache,referrer:Bt(),signal:_.signal});f.type!=="json"||b.headers.has("Accept")||b.headers.set("Accept","application/json");const w=yield fetch(b);if(!w.ok){const R=yield w.blob();throw new kt(w.status,w.statusText,f.url,R)}let A;A=f.type==="arrayBuffer"||f.type==="image"?w.arrayBuffer():f.type==="json"?w.json():w.text();const I=yield A;if(_.signal.aborted)throw tt();return{data:I,cacheControl:w.headers.get("Cache-Control"),expires:w.headers.get("Expires")}}))})(c,o);if(ve(self)&&self.worker&&self.worker.actor)return self.worker.actor.sendAsync({type:"GR",data:c,mustQueue:!0,targetMapId:$t},o)}var h;return(function(f,_){return new Promise(((b,w)=>{var A;const I=new XMLHttpRequest;I.open(f.method||"GET",f.url,!0),f.type!=="arrayBuffer"&&f.type!=="image"||(I.responseType="arraybuffer");for(const R in f.headers)I.setRequestHeader(R,f.headers[R]);f.type==="json"&&(I.responseType="text",!((A=f.headers)===null||A===void 0)&&A.Accept||I.setRequestHeader("Accept","application/json")),I.withCredentials=f.credentials==="include",I.onerror=()=>{w(new Error(I.statusText))},I.onload=()=>{if(!_.signal.aborted)if((I.status>=200&&I.status<300||I.status===0)&&I.response!==null){let R=I.response;if(f.type==="json")try{R=JSON.parse(I.response)}catch(k){return void w(k)}b({data:R,cacheControl:I.getResponseHeader("Cache-Control"),expires:I.getResponseHeader("Expires")})}else{const R=new Blob([I.response],{type:I.getResponseHeader("Content-Type")});w(new kt(I.status,I.statusText,f.url,R))}},_.signal.addEventListener("abort",(()=>{I.abort(),w(tt())})),I.send(f.body)}))})(c,o)};function Et(c){if(!c||c.indexOf("://")<=0||c.indexOf("data:image/")===0||c.indexOf("blob:")===0)return!0;const o=new URL(c),h=window.location;return o.protocol===h.protocol&&o.host===h.host}function Li(c,o,h){h[c]&&h[c].indexOf(o)!==-1||(h[c]=h[c]||[],h[c].push(o))}function bi(c,o,h){if(h&&h[c]){const f=h[c].indexOf(o);f!==-1&&h[c].splice(f,1)}}class Ri{constructor(o,h={}){Je(this,h),this.type=o}}class Fi extends Ri{constructor(o,h={}){super("error",Je({error:o},h))}}class Lt{on(o,h){return this._listeners=this._listeners||{},Li(o,h,this._listeners),this}off(o,h){return bi(o,h,this._listeners),bi(o,h,this._oneTimeListeners),this}once(o,h){return h?(this._oneTimeListeners=this._oneTimeListeners||{},Li(o,h,this._oneTimeListeners),this):new Promise((f=>this.once(o,f)))}fire(o,h){typeof o=="string"&&(o=new Ri(o,h||{}));const f=o.type;if(this.listens(f)){o.target=this;const _=this._listeners&&this._listeners[f]?this._listeners[f].slice():[];for(const A of _)A.call(this,o);const b=this._oneTimeListeners&&this._oneTimeListeners[f]?this._oneTimeListeners[f].slice():[];for(const A of b)bi(f,A,this._oneTimeListeners),A.call(this,o);const w=this._eventedParent;w&&(Je(o,typeof this._eventedParentData=="function"?this._eventedParentData():this._eventedParentData),w.fire(o))}else o instanceof Fi&&console.error(o.error);return this}listens(o){return this._listeners&&this._listeners[o]&&this._listeners[o].length>0||this._oneTimeListeners&&this._oneTimeListeners[o]&&this._oneTimeListeners[o].length>0||this._eventedParent&&this._eventedParent.listens(o)}setEventedParent(o,h){return this._eventedParent=o,this._eventedParentData=h,this}}var Ce={$version:8,$root:{version:{required:!0,type:"enum",values:[8]},name:{type:"string"},metadata:{type:"*"},center:{type:"array",value:"number"},zoom:{type:"number"},bearing:{type:"number",default:0,period:360,units:"degrees"},pitch:{type:"number",default:0,units:"degrees"},light:{type:"light"},sky:{type:"sky"},projection:{type:"projection"},terrain:{type:"terrain"},sources:{required:!0,type:"sources"},sprite:{type:"sprite"},glyphs:{type:"string"},transition:{type:"transition"},layers:{required:!0,type:"array",value:"layer"}},sources:{"*":{type:"source"}},source:["source_vector","source_raster","source_raster_dem","source_geojson","source_video","source_image"],source_vector:{type:{required:!0,type:"enum",values:{vector:{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},scheme:{type:"enum",values:{xyz:{},tms:{}},default:"xyz"},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},attribution:{type:"string"},promoteId:{type:"promoteId"},volatile:{type:"boolean",default:!1},"*":{type:"*"}},source_raster:{type:{required:!0,type:"enum",values:{raster:{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},tileSize:{type:"number",default:512,units:"pixels"},scheme:{type:"enum",values:{xyz:{},tms:{}},default:"xyz"},attribution:{type:"string"},volatile:{type:"boolean",default:!1},"*":{type:"*"}},source_raster_dem:{type:{required:!0,type:"enum",values:{"raster-dem":{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},tileSize:{type:"number",default:512,units:"pixels"},attribution:{type:"string"},encoding:{type:"enum",values:{terrarium:{},mapbox:{},custom:{}},default:"mapbox"},redFactor:{type:"number",default:1},blueFactor:{type:"number",default:1},greenFactor:{type:"number",default:1},baseShift:{type:"number",default:0},volatile:{type:"boolean",default:!1},"*":{type:"*"}},source_geojson:{type:{required:!0,type:"enum",values:{geojson:{}}},data:{required:!0,type:"*"},maxzoom:{type:"number",default:18},attribution:{type:"string"},buffer:{type:"number",default:128,maximum:512,minimum:0},filter:{type:"*"},tolerance:{type:"number",default:.375},cluster:{type:"boolean",default:!1},clusterRadius:{type:"number",default:50,minimum:0},clusterMaxZoom:{type:"number"},clusterMinPoints:{type:"number"},clusterProperties:{type:"*"},lineMetrics:{type:"boolean",default:!1},generateId:{type:"boolean",default:!1},promoteId:{type:"promoteId"}},source_video:{type:{required:!0,type:"enum",values:{video:{}}},urls:{required:!0,type:"array",value:"string"},coordinates:{required:!0,type:"array",length:4,value:{type:"array",length:2,value:"number"}}},source_image:{type:{required:!0,type:"enum",values:{image:{}}},url:{required:!0,type:"string"},coordinates:{required:!0,type:"array",length:4,value:{type:"array",length:2,value:"number"}}},layer:{id:{type:"string",required:!0},type:{type:"enum",values:{fill:{},line:{},symbol:{},circle:{},heatmap:{},"fill-extrusion":{},raster:{},hillshade:{},background:{}},required:!0},metadata:{type:"*"},source:{type:"string"},"source-layer":{type:"string"},minzoom:{type:"number",minimum:0,maximum:24},maxzoom:{type:"number",minimum:0,maximum:24},filter:{type:"filter"},layout:{type:"layout"},paint:{type:"paint"}},layout:["layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_symbol","layout_raster","layout_hillshade","layout_background"],layout_background:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_fill:{"fill-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_circle:{"circle-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_heatmap:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},"layout_fill-extrusion":{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_line:{"line-cap":{type:"enum",values:{butt:{},round:{},square:{}},default:"butt",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"line-join":{type:"enum",values:{bevel:{},round:{},miter:{}},default:"miter",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{type:"number",default:2,requires:[{"line-join":"miter"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-round-limit":{type:"number",default:1.05,requires:[{"line-join":"round"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_symbol:{"symbol-placement":{type:"enum",values:{point:{},line:{},"line-center":{}},default:"point",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"symbol-spacing":{type:"number",default:250,minimum:1,units:"pixels",requires:[{"symbol-placement":"line"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"symbol-avoid-edges":{type:"boolean",default:!1,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"symbol-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{type:"enum",values:{auto:{},"viewport-y":{},source:{}},default:"auto",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-allow-overlap":{type:"boolean",default:!1,requires:["icon-image",{"!":"icon-overlap"}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-overlap":{type:"enum",values:{never:{},always:{},cooperative:{}},requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-ignore-placement":{type:"boolean",default:!1,requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-optional":{type:"boolean",default:!1,requires:["icon-image","text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-rotation-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-size":{type:"number",default:1,minimum:0,units:"factor of the original icon size",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit":{type:"enum",values:{none:{},width:{},height:{},both:{}},default:"none",requires:["icon-image","text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-text-fit-padding":{type:"array",value:"number",length:4,default:[0,0,0,0],units:"pixels",requires:["icon-image","text-field",{"icon-text-fit":["both","width","height"]}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"icon-image":{type:"resolvedImage",tokens:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{type:"number",default:0,period:360,units:"degrees",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{type:"padding",default:[2],units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-keep-upright":{type:"boolean",default:!1,requires:["icon-image",{"icon-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-offset":{type:"array",value:"number",length:2,default:[0,0],requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{type:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},default:"center",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-pitch-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-rotation-alignment":{type:"enum",values:{map:{},viewport:{},"viewport-glyph":{},auto:{}},default:"auto",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-field":{type:"formatted",default:"",tokens:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-font":{type:"array",value:"string",default:["Open Sans Regular","Arial Unicode MS Regular"],requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-size":{type:"number",default:16,minimum:0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-max-width":{type:"number",default:10,minimum:0,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{type:"number",default:1.2,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-letter-spacing":{type:"number",default:0,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-justify":{type:"enum",values:{auto:{},left:{},center:{},right:{}},default:"center",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{type:"number",units:"ems",default:0,requires:["text-field"],"property-type":"data-driven",expression:{interpolated:!0,parameters:["zoom","feature"]}},"text-variable-anchor":{type:"array",value:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-variable-anchor-offset":{type:"variableAnchorOffsetCollection",requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-anchor":{type:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},default:"center",requires:["text-field",{"!":"text-variable-anchor"}],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{type:"number",default:45,units:"degrees",requires:["text-field",{"symbol-placement":["line","line-center"]}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-writing-mode":{type:"array",value:"enum",values:{horizontal:{},vertical:{}},requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-rotate":{type:"number",default:0,period:360,units:"degrees",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-padding":{type:"number",default:2,minimum:0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-keep-upright":{type:"boolean",default:!0,requires:["text-field",{"text-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-transform":{type:"enum",values:{none:{},uppercase:{},lowercase:{}},default:"none",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-offset":{type:"array",value:"number",units:"ems",length:2,default:[0,0],requires:["text-field",{"!":"text-radial-offset"}],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{type:"boolean",default:!1,requires:["text-field",{"!":"text-overlap"}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-overlap":{type:"enum",values:{never:{},always:{},cooperative:{}},requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-ignore-placement":{type:"boolean",default:!1,requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-optional":{type:"boolean",default:!1,requires:["text-field","icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_raster:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_hillshade:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},filter:{type:"array",value:"*"},filter_operator:{type:"enum",values:{"==":{},"!=":{},">":{},">=":{},"<":{},"<=":{},in:{},"!in":{},all:{},any:{},none:{},has:{},"!has":{}}},geometry_type:{type:"enum",values:{Point:{},LineString:{},Polygon:{}}},function:{expression:{type:"expression"},stops:{type:"array",value:"function_stop"},base:{type:"number",default:1,minimum:0},property:{type:"string",default:"$zoom"},type:{type:"enum",values:{identity:{},exponential:{},interval:{},categorical:{}},default:"exponential"},colorSpace:{type:"enum",values:{rgb:{},lab:{},hcl:{}},default:"rgb"},default:{type:"*",required:!1}},function_stop:{type:"array",minimum:0,maximum:24,value:["number","color"],length:2},expression:{type:"array",value:"*",minimum:1},light:{anchor:{type:"enum",default:"viewport",values:{map:{},viewport:{}},"property-type":"data-constant",transition:!1,expression:{interpolated:!1,parameters:["zoom"]}},position:{type:"array",default:[1.15,210,30],length:3,value:"number","property-type":"data-constant",transition:!0,expression:{interpolated:!0,parameters:["zoom"]}},color:{type:"color","property-type":"data-constant",default:"#ffffff",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},intensity:{type:"number","property-type":"data-constant",default:.5,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0}},sky:{"sky-color":{type:"color","property-type":"data-constant",default:"#88C6FC",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"horizon-color":{type:"color","property-type":"data-constant",default:"#ffffff",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"fog-color":{type:"color","property-type":"data-constant",default:"#ffffff",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"fog-ground-blend":{type:"number","property-type":"data-constant",default:.5,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"horizon-fog-blend":{type:"number","property-type":"data-constant",default:.8,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"sky-horizon-blend":{type:"number","property-type":"data-constant",default:.8,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"atmosphere-blend":{type:"number","property-type":"data-constant",default:.8,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0}},terrain:{source:{type:"string",required:!0},exaggeration:{type:"number",minimum:0,default:1}},projection:{type:{type:"enum",default:"mercator",values:{mercator:{},globe:{}}}},paint:["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_symbol","paint_raster","paint_hillshade","paint_background"],paint_fill:{"fill-antialias":{type:"boolean",default:!0,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"fill-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-outline-color":{type:"color",transition:!0,requires:[{"!":"fill-pattern"},{"fill-antialias":!0}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["fill-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"fill-extrusion-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["fill-extrusion-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"},"fill-extrusion-height":{type:"number",default:0,minimum:0,units:"meters",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{type:"number",default:0,minimum:0,units:"meters",transition:!0,requires:["fill-extrusion-height"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-vertical-gradient":{type:"boolean",default:!0,transition:!1,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"}},paint_line:{"line-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"line-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["line-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"line-width":{type:"number",default:1,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-gap-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-offset":{type:"number",default:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-dasharray":{type:"array",value:"number",minimum:0,transition:!0,units:"line widths",requires:[{"!":"line-pattern"}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"cross-faded"},"line-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"},"line-gradient":{type:"color",transition:!1,requires:[{"!":"line-dasharray"},{"!":"line-pattern"},{source:"geojson",has:{lineMetrics:!0}}],expression:{interpolated:!0,parameters:["line-progress"]},"property-type":"color-ramp"}},paint_circle:{"circle-radius":{type:"number",default:5,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-blur":{type:"number",default:0,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"circle-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["circle-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-pitch-scale":{type:"enum",values:{map:{},viewport:{}},default:"map",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-pitch-alignment":{type:"enum",values:{map:{},viewport:{}},default:"viewport",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-stroke-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"}},paint_heatmap:{"heatmap-radius":{type:"number",default:30,minimum:1,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-weight":{type:"number",default:1,minimum:0,transition:!1,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-intensity":{type:"number",default:1,minimum:0,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"heatmap-color":{type:"color",default:["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",.1,"royalblue",.3,"cyan",.5,"lime",.7,"yellow",1,"red"],transition:!1,expression:{interpolated:!0,parameters:["heatmap-density"]},"property-type":"color-ramp"},"heatmap-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},paint_symbol:{"icon-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-color":{type:"color",default:"#000000",transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-color":{type:"color",default:"rgba(0, 0, 0, 0)",transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"icon-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["icon-image","icon-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-color":{type:"color",default:"#000000",transition:!0,overridable:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-color":{type:"color",default:"rgba(0, 0, 0, 0)",transition:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["text-field","text-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"}},paint_raster:{"raster-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-hue-rotate":{type:"number",default:0,period:360,transition:!0,units:"degrees",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-brightness-min":{type:"number",default:0,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-brightness-max":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-saturation":{type:"number",default:0,minimum:-1,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-contrast":{type:"number",default:0,minimum:-1,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-resampling":{type:"enum",values:{linear:{},nearest:{}},default:"linear",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"raster-fade-duration":{type:"number",default:300,minimum:0,transition:!1,units:"milliseconds",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},paint_hillshade:{"hillshade-illumination-direction":{type:"number",default:335,minimum:0,maximum:359,transition:!1,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-illumination-anchor":{type:"enum",values:{map:{},viewport:{}},default:"viewport",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-exaggeration":{type:"number",default:.5,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-shadow-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-highlight-color":{type:"color",default:"#FFFFFF",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-accent-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},paint_background:{"background-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"background-pattern"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"background-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"cross-faded"},"background-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},transition:{duration:{type:"number",default:300,minimum:0,units:"milliseconds"},delay:{type:"number",default:0,minimum:0,units:"milliseconds"}},"property-type":{"data-driven":{type:"property-type"},"cross-faded":{type:"property-type"},"cross-faded-data-driven":{type:"property-type"},"color-ramp":{type:"property-type"},"data-constant":{type:"property-type"},constant:{type:"property-type"}},promoteId:{"*":{type:"string"}}};const ns=["type","source","source-layer","minzoom","maxzoom","filter","layout"];function os(c,o){const h={};for(const f in c)f!=="ref"&&(h[f]=c[f]);return ns.forEach((f=>{f in o&&(h[f]=o[f])})),h}function ii(c,o){if(Array.isArray(c)){if(!Array.isArray(o)||c.length!==o.length)return!1;for(let h=0;h<c.length;h++)if(!ii(c[h],o[h]))return!1;return!0}if(typeof c=="object"&&c!==null&&o!==null){if(typeof o!="object"||Object.keys(c).length!==Object.keys(o).length)return!1;for(const h in c)if(!ii(c[h],o[h]))return!1;return!0}return c===o}function wi(c,o){c.push(o)}function qi(c,o,h){wi(h,{command:"addSource",args:[c,o[c]]})}function Ns(c,o,h){wi(o,{command:"removeSource",args:[c]}),h[c]=!0}function _s(c,o,h,f){Ns(c,h,f),qi(c,o,h)}function zs(c,o,h){let f;for(f in c[h])if(Object.prototype.hasOwnProperty.call(c[h],f)&&f!=="data"&&!ii(c[h][f],o[h][f]))return!1;for(f in o[h])if(Object.prototype.hasOwnProperty.call(o[h],f)&&f!=="data"&&!ii(c[h][f],o[h][f]))return!1;return!0}function kr(c,o,h,f,_,b){c=c||{},o=o||{};for(const w in c)Object.prototype.hasOwnProperty.call(c,w)&&(ii(c[w],o[w])||h.push({command:b,args:[f,w,o[w],_]}));for(const w in o)Object.prototype.hasOwnProperty.call(o,w)&&!Object.prototype.hasOwnProperty.call(c,w)&&(ii(c[w],o[w])||h.push({command:b,args:[f,w,o[w],_]}))}function Pn(c){return c.id}function Mn(c,o){return c[o.id]=o,c}class st{constructor(o,h,f,_){this.message=(o?`${o}: `:"")+f,_&&(this.identifier=_),h!=null&&h.__line__&&(this.line=h.__line__)}}function Xr(c,...o){for(const h of o)for(const f in h)c[f]=h[f];return c}class er extends Error{constructor(o,h){super(h),this.message=h,this.key=o}}class Dr{constructor(o,h=[]){this.parent=o,this.bindings={};for(const[f,_]of h)this.bindings[f]=_}concat(o){return new Dr(this,o)}get(o){if(this.bindings[o])return this.bindings[o];if(this.parent)return this.parent.get(o);throw new Error(`${o} not found in scope.`)}has(o){return!!this.bindings[o]||!!this.parent&&this.parent.has(o)}}const ys={kind:"null"},ot={kind:"number"},qt={kind:"string"},Nt={kind:"boolean"},Ji={kind:"color"},Zr={kind:"object"},zt={kind:"value"},Yr={kind:"collator"},xs={kind:"formatted"},Us={kind:"padding"},as={kind:"resolvedImage"},le={kind:"variableAnchorOffsetCollection"};function B(c,o){return{kind:"array",itemType:c,N:o}}function U(c){if(c.kind==="array"){const o=U(c.itemType);return typeof c.N=="number"?`array<${o}, ${c.N}>`:c.itemType.kind==="value"?"array":`array<${o}>`}return c.kind}const q=[ys,ot,qt,Nt,Ji,xs,Zr,B(zt),Us,as,le];function ee(c,o){if(o.kind==="error")return null;if(c.kind==="array"){if(o.kind==="array"&&(o.N===0&&o.itemType.kind==="value"||!ee(c.itemType,o.itemType))&&(typeof c.N!="number"||c.N===o.N))return null}else{if(c.kind===o.kind)return null;if(c.kind==="value"){for(const h of q)if(!ee(h,o))return null}}return`Expected ${U(c)} but found ${U(o)} instead.`}function pe(c,o){return o.some((h=>h.kind===c.kind))}function ye(c,o){return o.some((h=>h==="null"?c===null:h==="array"?Array.isArray(c):h==="object"?c&&!Array.isArray(c)&&typeof c=="object":h===typeof c))}function Te(c,o){return c.kind==="array"&&o.kind==="array"?c.itemType.kind===o.itemType.kind&&typeof c.N=="number":c.kind===o.kind}const de=.96422,ze=.82521,qe=4/29,Ne=6/29,nt=3*Ne*Ne,Rt=Ne*Ne*Ne,Dt=Math.PI/180,ri=180/Math.PI;function Ht(c){return(c%=360)<0&&(c+=360),c}function si([c,o,h,f]){let _,b;const w=Xi((.2225045*(c=Jt(c))+.7168786*(o=Jt(o))+.0606169*(h=Jt(h)))/1);c===o&&o===h?_=b=w:(_=Xi((.4360747*c+.3850649*o+.1430804*h)/de),b=Xi((.0139322*c+.0971045*o+.7141733*h)/ze));const A=116*w-16;return[A<0?0:A,500*(_-w),200*(w-b),f]}function Jt(c){return c<=.04045?c/12.92:Math.pow((c+.055)/1.055,2.4)}function Xi(c){return c>Rt?Math.pow(c,1/3):c/nt+qe}function Bi([c,o,h,f]){let _=(c+16)/116,b=isNaN(o)?_:_+o/500,w=isNaN(h)?_:_-h/200;return _=1*hi(_),b=de*hi(b),w=ze*hi(w),[Zt(3.1338561*b-1.6168667*_-.4906146*w),Zt(-.9787684*b+1.9161415*_+.033454*w),Zt(.0719453*b-.2289914*_+1.4052427*w),f]}function Zt(c){return(c=c<=.00304?12.92*c:1.055*Math.pow(c,1/2.4)-.055)<0?0:c>1?1:c}function hi(c){return c>Ne?c*c*c:nt*(c-qe)}function ki(c){return parseInt(c.padEnd(2,c),16)/255}function tr(c,o){return lr(o?c/100:c,0,1)}function lr(c,o,h){return Math.min(Math.max(o,c),h)}function Sr(c){return!c.some(Number.isNaN)}const no={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]};class di{constructor(o,h,f,_=1,b=!0){this.r=o,this.g=h,this.b=f,this.a=_,b||(this.r*=_,this.g*=_,this.b*=_,_||this.overwriteGetter("rgb",[o,h,f,_]))}static parse(o){if(o instanceof di)return o;if(typeof o!="string")return;const h=(function(f){if((f=f.toLowerCase().trim())==="transparent")return[0,0,0,0];const _=no[f];if(_){const[w,A,I]=_;return[w/255,A/255,I/255,1]}if(f.startsWith("#")&&/^#(?:[0-9a-f]{3,4}|[0-9a-f]{6}|[0-9a-f]{8})$/.test(f)){const w=f.length<6?1:2;let A=1;return[ki(f.slice(A,A+=w)),ki(f.slice(A,A+=w)),ki(f.slice(A,A+=w)),ki(f.slice(A,A+w)||"ff")]}if(f.startsWith("rgb")){const w=f.match(/^rgba?\(\s*([\de.+-]+)(%)?(?:\s+|\s*(,)\s*)([\de.+-]+)(%)?(?:\s+|\s*(,)\s*)([\de.+-]+)(%)?(?:\s*([,\/])\s*([\de.+-]+)(%)?)?\s*\)$/);if(w){const[A,I,R,k,F,V,j,X,Z,se,ue,Me]=w,xe=[k||" ",j||" ",se].join("");if(xe==="  "||xe==="  /"||xe===",,"||xe===",,,"){const Ee=[R,V,Z].join(""),Ue=Ee==="%%%"?100:Ee===""?255:0;if(Ue){const et=[lr(+I/Ue,0,1),lr(+F/Ue,0,1),lr(+X/Ue,0,1),ue?tr(+ue,Me):1];if(Sr(et))return et}}return}}const b=f.match(/^hsla?\(\s*([\de.+-]+)(?:deg)?(?:\s+|\s*(,)\s*)([\de.+-]+)%(?:\s+|\s*(,)\s*)([\de.+-]+)%(?:\s*([,\/])\s*([\de.+-]+)(%)?)?\s*\)$/);if(b){const[w,A,I,R,k,F,V,j,X]=b,Z=[I||" ",k||" ",V].join("");if(Z==="  "||Z==="  /"||Z===",,"||Z===",,,"){const se=[+A,lr(+R,0,100),lr(+F,0,100),j?tr(+j,X):1];if(Sr(se))return(function([ue,Me,xe,Ee]){function Ue(et){const mt=(et+ue/30)%12,Ot=Me*Math.min(xe,1-xe);return xe-Ot*Math.max(-1,Math.min(mt-3,9-mt,1))}return ue=Ht(ue),Me/=100,xe/=100,[Ue(0),Ue(8),Ue(4),Ee]})(se)}}})(o);return h?new di(...h,!1):void 0}get rgb(){const{r:o,g:h,b:f,a:_}=this,b=_||1/0;return this.overwriteGetter("rgb",[o/b,h/b,f/b,_])}get hcl(){return this.overwriteGetter("hcl",(function(o){const[h,f,_,b]=si(o),w=Math.sqrt(f*f+_*_);return[Math.round(1e4*w)?Ht(Math.atan2(_,f)*ri):NaN,w,h,b]})(this.rgb))}get lab(){return this.overwriteGetter("lab",si(this.rgb))}overwriteGetter(o,h){return Object.defineProperty(this,o,{value:h}),h}toString(){const[o,h,f,_]=this.rgb;return`rgba(${[o,h,f].map((b=>Math.round(255*b))).join(",")},${_})`}}di.black=new di(0,0,0,1),di.white=new di(1,1,1,1),di.transparent=new di(0,0,0,0),di.red=new di(1,0,0,1);class Oc{constructor(o,h,f){this.sensitivity=o?h?"variant":"case":h?"accent":"base",this.locale=f,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(o,h){return this.collator.compare(o,h)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class Lc{constructor(o,h,f,_,b){this.text=o,this.image=h,this.scale=f,this.fontStack=_,this.textColor=b}}class Gr{constructor(o){this.sections=o}static fromString(o){return new Gr([new Lc(o,null,null,null,null)])}isEmpty(){return this.sections.length===0||!this.sections.some((o=>o.text.length!==0||o.image&&o.image.name.length!==0))}static factory(o){return o instanceof Gr?o:Gr.fromString(o)}toString(){return this.sections.length===0?"":this.sections.map((o=>o.text)).join("")}}class Kr{constructor(o){this.values=o.slice()}static parse(o){if(o instanceof Kr)return o;if(typeof o=="number")return new Kr([o,o,o,o]);if(Array.isArray(o)&&!(o.length<1||o.length>4)){for(const h of o)if(typeof h!="number")return;switch(o.length){case 1:o=[o[0],o[0],o[0],o[0]];break;case 2:o=[o[0],o[1],o[0],o[1]];break;case 3:o=[o[0],o[1],o[2],o[1]]}return new Kr(o)}}toString(){return JSON.stringify(this.values)}}const Pp=new Set(["center","left","right","top","bottom","top-left","top-right","bottom-left","bottom-right"]);class ls{constructor(o){this.values=o.slice()}static parse(o){if(o instanceof ls)return o;if(Array.isArray(o)&&!(o.length<1)&&o.length%2==0){for(let h=0;h<o.length;h+=2){const f=o[h],_=o[h+1];if(typeof f!="string"||!Pp.has(f)||!Array.isArray(_)||_.length!==2||typeof _[0]!="number"||typeof _[1]!="number")return}return new ls(o)}}toString(){return JSON.stringify(this.values)}}class Jr{constructor(o){this.name=o.name,this.available=o.available}toString(){return this.name}static fromString(o){return o?new Jr({name:o,available:!1}):null}}function oo(c,o,h,f){return typeof c=="number"&&c>=0&&c<=255&&typeof o=="number"&&o>=0&&o<=255&&typeof h=="number"&&h>=0&&h<=255?f===void 0||typeof f=="number"&&f>=0&&f<=1?null:`Invalid rgba value [${[c,o,h,f].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${(typeof f=="number"?[c,o,h,f]:[c,o,h]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function Rn(c){if(c===null||typeof c=="string"||typeof c=="boolean"||typeof c=="number"||c instanceof di||c instanceof Oc||c instanceof Gr||c instanceof Kr||c instanceof ls||c instanceof Jr)return!0;if(Array.isArray(c)){for(const o of c)if(!Rn(o))return!1;return!0}if(typeof c=="object"){for(const o in c)if(!Rn(c[o]))return!1;return!0}return!1}function Zi(c){if(c===null)return ys;if(typeof c=="string")return qt;if(typeof c=="boolean")return Nt;if(typeof c=="number")return ot;if(c instanceof di)return Ji;if(c instanceof Oc)return Yr;if(c instanceof Gr)return xs;if(c instanceof Kr)return Us;if(c instanceof ls)return le;if(c instanceof Jr)return as;if(Array.isArray(c)){const o=c.length;let h;for(const f of c){const _=Zi(f);if(h){if(h===_)continue;h=zt;break}h=_}return B(h||zt,o)}return Zr}function sa(c){const o=typeof c;return c===null?"":o==="string"||o==="number"||o==="boolean"?String(c):c instanceof di||c instanceof Gr||c instanceof Kr||c instanceof ls||c instanceof Jr?c.toString():JSON.stringify(c)}class vs{constructor(o,h){this.type=o,this.value=h}static parse(o,h){if(o.length!==2)return h.error(`'literal' expression requires exactly one argument, but found ${o.length-1} instead.`);if(!Rn(o[1]))return h.error("invalid value");const f=o[1];let _=Zi(f);const b=h.expectedType;return _.kind!=="array"||_.N!==0||!b||b.kind!=="array"||typeof b.N=="number"&&b.N!==0||(_=b),new vs(_,f)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}}class Wi{constructor(o){this.name="ExpressionEvaluationError",this.message=o}toJSON(){return this.message}}const il={string:qt,number:ot,boolean:Nt,object:Zr};class bs{constructor(o,h){this.type=o,this.args=h}static parse(o,h){if(o.length<2)return h.error("Expected at least one argument.");let f,_=1;const b=o[0];if(b==="array"){let A,I;if(o.length>2){const R=o[1];if(typeof R!="string"||!(R in il)||R==="object")return h.error('The item type argument of "array" must be one of string, number, boolean',1);A=il[R],_++}else A=zt;if(o.length>3){if(o[2]!==null&&(typeof o[2]!="number"||o[2]<0||o[2]!==Math.floor(o[2])))return h.error('The length argument to "array" must be a positive integer literal',2);I=o[2],_++}f=B(A,I)}else{if(!il[b])throw new Error(`Types doesn't contain name = ${b}`);f=il[b]}const w=[];for(;_<o.length;_++){const A=h.parse(o[_],_,zt);if(!A)return null;w.push(A)}return new bs(f,w)}evaluate(o){for(let h=0;h<this.args.length;h++){const f=this.args[h].evaluate(o);if(!ee(this.type,Zi(f)))return f;if(h===this.args.length-1)throw new Wi(`Expected value to be of type ${U(this.type)}, but found ${U(Zi(f))} instead.`)}throw new Error}eachChild(o){this.args.forEach(o)}outputDefined(){return this.args.every((o=>o.outputDefined()))}}const Fc={"to-boolean":Nt,"to-color":Ji,"to-number":ot,"to-string":qt};class ws{constructor(o,h){this.type=o,this.args=h}static parse(o,h){if(o.length<2)return h.error("Expected at least one argument.");const f=o[0];if(!Fc[f])throw new Error(`Can't parse ${f} as it is not part of the known types`);if((f==="to-boolean"||f==="to-string")&&o.length!==2)return h.error("Expected one argument.");const _=Fc[f],b=[];for(let w=1;w<o.length;w++){const A=h.parse(o[w],w,zt);if(!A)return null;b.push(A)}return new ws(_,b)}evaluate(o){switch(this.type.kind){case"boolean":return!!this.args[0].evaluate(o);case"color":{let h,f;for(const _ of this.args){if(h=_.evaluate(o),f=null,h instanceof di)return h;if(typeof h=="string"){const b=o.parseColor(h);if(b)return b}else if(Array.isArray(h)&&(f=h.length<3||h.length>4?`Invalid rbga value ${JSON.stringify(h)}: expected an array containing either three or four numeric values.`:oo(h[0],h[1],h[2],h[3]),!f))return new di(h[0]/255,h[1]/255,h[2]/255,h[3])}throw new Wi(f||`Could not parse color from value '${typeof h=="string"?h:JSON.stringify(h)}'`)}case"padding":{let h;for(const f of this.args){h=f.evaluate(o);const _=Kr.parse(h);if(_)return _}throw new Wi(`Could not parse padding from value '${typeof h=="string"?h:JSON.stringify(h)}'`)}case"variableAnchorOffsetCollection":{let h;for(const f of this.args){h=f.evaluate(o);const _=ls.parse(h);if(_)return _}throw new Wi(`Could not parse variableAnchorOffsetCollection from value '${typeof h=="string"?h:JSON.stringify(h)}'`)}case"number":{let h=null;for(const f of this.args){if(h=f.evaluate(o),h===null)return 0;const _=Number(h);if(!isNaN(_))return _}throw new Wi(`Could not convert ${JSON.stringify(h)} to number.`)}case"formatted":return Gr.fromString(sa(this.args[0].evaluate(o)));case"resolvedImage":return Jr.fromString(sa(this.args[0].evaluate(o)));default:return sa(this.args[0].evaluate(o))}}eachChild(o){this.args.forEach(o)}outputDefined(){return this.args.every((o=>o.outputDefined()))}}const Mp=["Unknown","Point","LineString","Polygon"];class rl{constructor(){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null}id(){return this.feature&&"id"in this.feature?this.feature.id:null}geometryType(){return this.feature?typeof this.feature.type=="number"?Mp[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}parseColor(o){let h=this._parseColorCache[o];return h||(h=this._parseColorCache[o]=di.parse(o)),h}}class kn{constructor(o,h,f=[],_,b=new Dr,w=[]){this.registry=o,this.path=f,this.key=f.map((A=>`[${A}]`)).join(""),this.scope=b,this.errors=w,this.expectedType=_,this._isConstant=h}parse(o,h,f,_,b={}){return h?this.concat(h,f,_)._parse(o,b):this._parse(o,b)}_parse(o,h){function f(_,b,w){return w==="assert"?new bs(b,[_]):w==="coerce"?new ws(b,[_]):_}if(o!==null&&typeof o!="string"&&typeof o!="boolean"&&typeof o!="number"||(o=["literal",o]),Array.isArray(o)){if(o.length===0)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const _=o[0];if(typeof _!="string")return this.error(`Expression name must be a string, but found ${typeof _} instead. If you wanted a literal array, use ["literal", [...]].`,0),null;const b=this.registry[_];if(b){let w=b.parse(o,this);if(!w)return null;if(this.expectedType){const A=this.expectedType,I=w.type;if(A.kind!=="string"&&A.kind!=="number"&&A.kind!=="boolean"&&A.kind!=="object"&&A.kind!=="array"||I.kind!=="value")if(A.kind!=="color"&&A.kind!=="formatted"&&A.kind!=="resolvedImage"||I.kind!=="value"&&I.kind!=="string")if(A.kind!=="padding"||I.kind!=="value"&&I.kind!=="number"&&I.kind!=="array")if(A.kind!=="variableAnchorOffsetCollection"||I.kind!=="value"&&I.kind!=="array"){if(this.checkSubtype(A,I))return null}else w=f(w,A,h.typeAnnotation||"coerce");else w=f(w,A,h.typeAnnotation||"coerce");else w=f(w,A,h.typeAnnotation||"coerce");else w=f(w,A,h.typeAnnotation||"assert")}if(!(w instanceof vs)&&w.type.kind!=="resolvedImage"&&this._isConstant(w)){const A=new rl;try{w=new vs(w.type,w.evaluate(A))}catch(I){return this.error(I.message),null}}return w}return this.error(`Unknown expression "${_}". If you wanted a literal array, use ["literal", [...]].`,0)}return this.error(o===void 0?"'undefined' value invalid. Use null instead.":typeof o=="object"?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof o} instead.`)}concat(o,h,f){const _=typeof o=="number"?this.path.concat(o):this.path,b=f?this.scope.concat(f):this.scope;return new kn(this.registry,this._isConstant,_,h||null,b,this.errors)}error(o,...h){const f=`${this.key}${h.map((_=>`[${_}]`)).join("")}`;this.errors.push(new er(f,o))}checkSubtype(o,h){const f=ee(o,h);return f&&this.error(f),f}}class dn{constructor(o,h){this.type=h.type,this.bindings=[].concat(o),this.result=h}evaluate(o){return this.result.evaluate(o)}eachChild(o){for(const h of this.bindings)o(h[1]);o(this.result)}static parse(o,h){if(o.length<4)return h.error(`Expected at least 3 arguments, but found ${o.length-1} instead.`);const f=[];for(let b=1;b<o.length-1;b+=2){const w=o[b];if(typeof w!="string")return h.error(`Expected string, but found ${typeof w} instead.`,b);if(/[^a-zA-Z0-9_]/.test(w))return h.error("Variable names must contain only alphanumeric characters or '_'.",b);const A=h.parse(o[b+1],b+1);if(!A)return null;f.push([w,A])}const _=h.parse(o[o.length-1],o.length-1,h.expectedType,f);return _?new dn(f,_):null}outputDefined(){return this.result.outputDefined()}}class ci{constructor(o,h){this.type=h.type,this.name=o,this.boundExpression=h}static parse(o,h){if(o.length!==2||typeof o[1]!="string")return h.error("'var' expression requires exactly one string literal argument.");const f=o[1];return h.scope.has(f)?new ci(f,h.scope.get(f)):h.error(`Unknown variable "${f}". Make sure "${f}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(o){return this.boundExpression.evaluate(o)}eachChild(){}outputDefined(){return!1}}class Bc{constructor(o,h,f){this.type=o,this.index=h,this.input=f}static parse(o,h){if(o.length!==3)return h.error(`Expected 2 arguments, but found ${o.length-1} instead.`);const f=h.parse(o[1],1,ot),_=h.parse(o[2],2,B(h.expectedType||zt));return f&&_?new Bc(_.type.itemType,f,_):null}evaluate(o){const h=this.index.evaluate(o),f=this.input.evaluate(o);if(h<0)throw new Wi(`Array index out of bounds: ${h} < 0.`);if(h>=f.length)throw new Wi(`Array index out of bounds: ${h} > ${f.length-1}.`);if(h!==Math.floor(h))throw new Wi(`Array index must be an integer, but found ${h} instead.`);return f[h]}eachChild(o){o(this.index),o(this.input)}outputDefined(){return!1}}class Nc{constructor(o,h){this.type=Nt,this.needle=o,this.haystack=h}static parse(o,h){if(o.length!==3)return h.error(`Expected 2 arguments, but found ${o.length-1} instead.`);const f=h.parse(o[1],1,zt),_=h.parse(o[2],2,zt);return f&&_?pe(f.type,[Nt,qt,ot,ys,zt])?new Nc(f,_):h.error(`Expected first argument to be of type boolean, string, number or null, but found ${U(f.type)} instead`):null}evaluate(o){const h=this.needle.evaluate(o),f=this.haystack.evaluate(o);if(!f)return!1;if(!ye(h,["boolean","string","number","null"]))throw new Wi(`Expected first argument to be of type boolean, string, number or null, but found ${U(Zi(h))} instead.`);if(!ye(f,["string","array"]))throw new Wi(`Expected second argument to be of type array or string, but found ${U(Zi(f))} instead.`);return f.indexOf(h)>=0}eachChild(o){o(this.needle),o(this.haystack)}outputDefined(){return!0}}class ao{constructor(o,h,f){this.type=ot,this.needle=o,this.haystack=h,this.fromIndex=f}static parse(o,h){if(o.length<=2||o.length>=5)return h.error(`Expected 3 or 4 arguments, but found ${o.length-1} instead.`);const f=h.parse(o[1],1,zt),_=h.parse(o[2],2,zt);if(!f||!_)return null;if(!pe(f.type,[Nt,qt,ot,ys,zt]))return h.error(`Expected first argument to be of type boolean, string, number or null, but found ${U(f.type)} instead`);if(o.length===4){const b=h.parse(o[3],3,ot);return b?new ao(f,_,b):null}return new ao(f,_)}evaluate(o){const h=this.needle.evaluate(o),f=this.haystack.evaluate(o);if(!ye(h,["boolean","string","number","null"]))throw new Wi(`Expected first argument to be of type boolean, string, number or null, but found ${U(Zi(h))} instead.`);let _;if(this.fromIndex&&(_=this.fromIndex.evaluate(o)),ye(f,["string"])){const b=f.indexOf(h,_);return b===-1?-1:[...f.slice(0,b)].length}if(ye(f,["array"]))return f.indexOf(h,_);throw new Wi(`Expected second argument to be of type array or string, but found ${U(Zi(f))} instead.`)}eachChild(o){o(this.needle),o(this.haystack),this.fromIndex&&o(this.fromIndex)}outputDefined(){return!1}}class zc{constructor(o,h,f,_,b,w){this.inputType=o,this.type=h,this.input=f,this.cases=_,this.outputs=b,this.otherwise=w}static parse(o,h){if(o.length<5)return h.error(`Expected at least 4 arguments, but found only ${o.length-1}.`);if(o.length%2!=1)return h.error("Expected an even number of arguments.");let f,_;h.expectedType&&h.expectedType.kind!=="value"&&(_=h.expectedType);const b={},w=[];for(let R=2;R<o.length-1;R+=2){let k=o[R];const F=o[R+1];Array.isArray(k)||(k=[k]);const V=h.concat(R);if(k.length===0)return V.error("Expected at least one branch label.");for(const X of k){if(typeof X!="number"&&typeof X!="string")return V.error("Branch labels must be numbers or strings.");if(typeof X=="number"&&Math.abs(X)>Number.MAX_SAFE_INTEGER)return V.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if(typeof X=="number"&&Math.floor(X)!==X)return V.error("Numeric branch labels must be integer values.");if(f){if(V.checkSubtype(f,Zi(X)))return null}else f=Zi(X);if(b[String(X)]!==void 0)return V.error("Branch labels must be unique.");b[String(X)]=w.length}const j=h.parse(F,R,_);if(!j)return null;_=_||j.type,w.push(j)}const A=h.parse(o[1],1,zt);if(!A)return null;const I=h.parse(o[o.length-1],o.length-1,_);return I?A.type.kind!=="value"&&h.concat(1).checkSubtype(f,A.type)?null:new zc(f,_,A,b,w,I):null}evaluate(o){const h=this.input.evaluate(o);return(Zi(h)===this.inputType&&this.outputs[this.cases[h]]||this.otherwise).evaluate(o)}eachChild(o){o(this.input),this.outputs.forEach(o),o(this.otherwise)}outputDefined(){return this.outputs.every((o=>o.outputDefined()))&&this.otherwise.outputDefined()}}class sl{constructor(o,h,f){this.type=o,this.branches=h,this.otherwise=f}static parse(o,h){if(o.length<4)return h.error(`Expected at least 3 arguments, but found only ${o.length-1}.`);if(o.length%2!=0)return h.error("Expected an odd number of arguments.");let f;h.expectedType&&h.expectedType.kind!=="value"&&(f=h.expectedType);const _=[];for(let w=1;w<o.length-1;w+=2){const A=h.parse(o[w],w,Nt);if(!A)return null;const I=h.parse(o[w+1],w+1,f);if(!I)return null;_.push([A,I]),f=f||I.type}const b=h.parse(o[o.length-1],o.length-1,f);if(!b)return null;if(!f)throw new Error("Can't infer output type");return new sl(f,_,b)}evaluate(o){for(const[h,f]of this.branches)if(h.evaluate(o))return f.evaluate(o);return this.otherwise.evaluate(o)}eachChild(o){for(const[h,f]of this.branches)o(h),o(f);o(this.otherwise)}outputDefined(){return this.branches.every((([o,h])=>h.outputDefined()))&&this.otherwise.outputDefined()}}class na{constructor(o,h,f,_){this.type=o,this.input=h,this.beginIndex=f,this.endIndex=_}static parse(o,h){if(o.length<=2||o.length>=5)return h.error(`Expected 3 or 4 arguments, but found ${o.length-1} instead.`);const f=h.parse(o[1],1,zt),_=h.parse(o[2],2,ot);if(!f||!_)return null;if(!pe(f.type,[B(zt),qt,zt]))return h.error(`Expected first argument to be of type array or string, but found ${U(f.type)} instead`);if(o.length===4){const b=h.parse(o[3],3,ot);return b?new na(f.type,f,_,b):null}return new na(f.type,f,_)}evaluate(o){const h=this.input.evaluate(o),f=this.beginIndex.evaluate(o);let _;if(this.endIndex&&(_=this.endIndex.evaluate(o)),ye(h,["string"]))return[...h].slice(f,_).join("");if(ye(h,["array"]))return h.slice(f,_);throw new Wi(`Expected first argument to be of type array or string, but found ${U(Zi(h))} instead.`)}eachChild(o){o(this.input),o(this.beginIndex),this.endIndex&&o(this.endIndex)}outputDefined(){return!1}}function nl(c,o){const h=c.length-1;let f,_,b=0,w=h,A=0;for(;b<=w;)if(A=Math.floor((b+w)/2),f=c[A],_=c[A+1],f<=o){if(A===h||o<_)return A;b=A+1}else{if(!(f>o))throw new Wi("Input is not a number.");w=A-1}return 0}class lo{constructor(o,h,f){this.type=o,this.input=h,this.labels=[],this.outputs=[];for(const[_,b]of f)this.labels.push(_),this.outputs.push(b)}static parse(o,h){if(o.length-1<4)return h.error(`Expected at least 4 arguments, but found only ${o.length-1}.`);if((o.length-1)%2!=0)return h.error("Expected an even number of arguments.");const f=h.parse(o[1],1,ot);if(!f)return null;const _=[];let b=null;h.expectedType&&h.expectedType.kind!=="value"&&(b=h.expectedType);for(let w=1;w<o.length;w+=2){const A=w===1?-1/0:o[w],I=o[w+1],R=w,k=w+1;if(typeof A!="number")return h.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',R);if(_.length&&_[_.length-1][0]>=A)return h.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',R);const F=h.parse(I,k,b);if(!F)return null;b=b||F.type,_.push([A,F])}return new lo(b,f,_)}evaluate(o){const h=this.labels,f=this.outputs;if(h.length===1)return f[0].evaluate(o);const _=this.input.evaluate(o);if(_<=h[0])return f[0].evaluate(o);const b=h.length;return _>=h[b-1]?f[b-1].evaluate(o):f[nl(h,_)].evaluate(o)}eachChild(o){o(this.input);for(const h of this.outputs)o(h)}outputDefined(){return this.outputs.every((o=>o.outputDefined()))}}function Hh(c){return c&&c.__esModule&&Object.prototype.hasOwnProperty.call(c,"default")?c.default:c}var Rp=qh;function qh(c,o,h,f){this.cx=3*c,this.bx=3*(h-c)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*o,this.by=3*(f-o)-this.cy,this.ay=1-this.cy-this.by,this.p1x=c,this.p1y=o,this.p2x=h,this.p2y=f}qh.prototype={sampleCurveX:function(c){return((this.ax*c+this.bx)*c+this.cx)*c},sampleCurveY:function(c){return((this.ay*c+this.by)*c+this.cy)*c},sampleCurveDerivativeX:function(c){return(3*this.ax*c+2*this.bx)*c+this.cx},solveCurveX:function(c,o){if(o===void 0&&(o=1e-6),c<0)return 0;if(c>1)return 1;for(var h=c,f=0;f<8;f++){var _=this.sampleCurveX(h)-c;if(Math.abs(_)<o)return h;var b=this.sampleCurveDerivativeX(h);if(Math.abs(b)<1e-6)break;h-=_/b}var w=0,A=1;for(h=c,f=0;f<20&&(_=this.sampleCurveX(h),!(Math.abs(_-c)<o));f++)c>_?w=h:A=h,h=.5*(A-w)+w;return h},solve:function(c,o){return this.sampleCurveY(this.solveCurveX(c,o))}};var kp=Hh(Rp);function Dn(c,o,h){return c+h*(o-c)}function oa(c,o,h){return c.map(((f,_)=>Dn(f,o[_],h)))}const Or={number:Dn,color:function(c,o,h,f="rgb"){switch(f){case"rgb":{const[_,b,w,A]=oa(c.rgb,o.rgb,h);return new di(_,b,w,A,!1)}case"hcl":{const[_,b,w,A]=c.hcl,[I,R,k,F]=o.hcl;let V,j;if(isNaN(_)||isNaN(I))isNaN(_)?isNaN(I)?V=NaN:(V=I,w!==1&&w!==0||(j=R)):(V=_,k!==1&&k!==0||(j=b));else{let Me=I-_;I>_&&Me>180?Me-=360:I<_&&_-I>180&&(Me+=360),V=_+h*Me}const[X,Z,se,ue]=(function([Me,xe,Ee,Ue]){return Me=isNaN(Me)?0:Me*Dt,Bi([Ee,Math.cos(Me)*xe,Math.sin(Me)*xe,Ue])})([V,j??Dn(b,R,h),Dn(w,k,h),Dn(A,F,h)]);return new di(X,Z,se,ue,!1)}case"lab":{const[_,b,w,A]=Bi(oa(c.lab,o.lab,h));return new di(_,b,w,A,!1)}}},array:oa,padding:function(c,o,h){return new Kr(oa(c.values,o.values,h))},variableAnchorOffsetCollection:function(c,o,h){const f=c.values,_=o.values;if(f.length!==_.length)throw new Wi(`Cannot interpolate values of different length. from: ${c.toString()}, to: ${o.toString()}`);const b=[];for(let w=0;w<f.length;w+=2){if(f[w]!==_[w])throw new Wi(`Cannot interpolate values containing mismatched anchors. from[${w}]: ${f[w]}, to[${w}]: ${_[w]}`);b.push(f[w]);const[A,I]=f[w+1],[R,k]=_[w+1];b.push([Dn(A,R,h),Dn(I,k,h)])}return new ls(b)}};class Lr{constructor(o,h,f,_,b){this.type=o,this.operator=h,this.interpolation=f,this.input=_,this.labels=[],this.outputs=[];for(const[w,A]of b)this.labels.push(w),this.outputs.push(A)}static interpolationFactor(o,h,f,_){let b=0;if(o.name==="exponential")b=ol(h,o.base,f,_);else if(o.name==="linear")b=ol(h,1,f,_);else if(o.name==="cubic-bezier"){const w=o.controlPoints;b=new kp(w[0],w[1],w[2],w[3]).solve(ol(h,1,f,_))}return b}static parse(o,h){let[f,_,b,...w]=o;if(!Array.isArray(_)||_.length===0)return h.error("Expected an interpolation type expression.",1);if(_[0]==="linear")_={name:"linear"};else if(_[0]==="exponential"){const R=_[1];if(typeof R!="number")return h.error("Exponential interpolation requires a numeric base.",1,1);_={name:"exponential",base:R}}else{if(_[0]!=="cubic-bezier")return h.error(`Unknown interpolation type ${String(_[0])}`,1,0);{const R=_.slice(1);if(R.length!==4||R.some((k=>typeof k!="number"||k<0||k>1)))return h.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);_={name:"cubic-bezier",controlPoints:R}}}if(o.length-1<4)return h.error(`Expected at least 4 arguments, but found only ${o.length-1}.`);if((o.length-1)%2!=0)return h.error("Expected an even number of arguments.");if(b=h.parse(b,2,ot),!b)return null;const A=[];let I=null;f==="interpolate-hcl"||f==="interpolate-lab"?I=Ji:h.expectedType&&h.expectedType.kind!=="value"&&(I=h.expectedType);for(let R=0;R<w.length;R+=2){const k=w[R],F=w[R+1],V=R+3,j=R+4;if(typeof k!="number")return h.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',V);if(A.length&&A[A.length-1][0]>=k)return h.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',V);const X=h.parse(F,j,I);if(!X)return null;I=I||X.type,A.push([k,X])}return Te(I,ot)||Te(I,Ji)||Te(I,Us)||Te(I,le)||Te(I,B(ot))?new Lr(I,f,_,b,A):h.error(`Type ${U(I)} is not interpolatable.`)}evaluate(o){const h=this.labels,f=this.outputs;if(h.length===1)return f[0].evaluate(o);const _=this.input.evaluate(o);if(_<=h[0])return f[0].evaluate(o);const b=h.length;if(_>=h[b-1])return f[b-1].evaluate(o);const w=nl(h,_),A=Lr.interpolationFactor(this.interpolation,_,h[w],h[w+1]),I=f[w].evaluate(o),R=f[w+1].evaluate(o);switch(this.operator){case"interpolate":return Or[this.type.kind](I,R,A);case"interpolate-hcl":return Or.color(I,R,A,"hcl");case"interpolate-lab":return Or.color(I,R,A,"lab")}}eachChild(o){o(this.input);for(const h of this.outputs)o(h)}outputDefined(){return this.outputs.every((o=>o.outputDefined()))}}function ol(c,o,h,f){const _=f-h,b=c-h;return _===0?0:o===1?b/_:(Math.pow(o,b)-1)/(Math.pow(o,_)-1)}class al{constructor(o,h){this.type=o,this.args=h}static parse(o,h){if(o.length<2)return h.error("Expectected at least one argument.");let f=null;const _=h.expectedType;_&&_.kind!=="value"&&(f=_);const b=[];for(const A of o.slice(1)){const I=h.parse(A,1+b.length,f,void 0,{typeAnnotation:"omit"});if(!I)return null;f=f||I.type,b.push(I)}if(!f)throw new Error("No output type");const w=_&&b.some((A=>ee(_,A.type)));return new al(w?zt:f,b)}evaluate(o){let h,f=null,_=0;for(const b of this.args)if(_++,f=b.evaluate(o),f&&f instanceof Jr&&!f.available&&(h||(h=f.name),f=null,_===this.args.length&&(f=h)),f!==null)break;return f}eachChild(o){this.args.forEach(o)}outputDefined(){return this.args.every((o=>o.outputDefined()))}}function ll(c,o){return c==="=="||c==="!="?o.kind==="boolean"||o.kind==="string"||o.kind==="number"||o.kind==="null"||o.kind==="value":o.kind==="string"||o.kind==="number"||o.kind==="value"}function Xh(c,o,h,f){return f.compare(o,h)===0}function co(c,o,h){const f=c!=="=="&&c!=="!=";return class dS{constructor(b,w,A){this.type=Nt,this.lhs=b,this.rhs=w,this.collator=A,this.hasUntypedArgument=b.type.kind==="value"||w.type.kind==="value"}static parse(b,w){if(b.length!==3&&b.length!==4)return w.error("Expected two or three arguments.");const A=b[0];let I=w.parse(b[1],1,zt);if(!I)return null;if(!ll(A,I.type))return w.concat(1).error(`"${A}" comparisons are not supported for type '${U(I.type)}'.`);let R=w.parse(b[2],2,zt);if(!R)return null;if(!ll(A,R.type))return w.concat(2).error(`"${A}" comparisons are not supported for type '${U(R.type)}'.`);if(I.type.kind!==R.type.kind&&I.type.kind!=="value"&&R.type.kind!=="value")return w.error(`Cannot compare types '${U(I.type)}' and '${U(R.type)}'.`);f&&(I.type.kind==="value"&&R.type.kind!=="value"?I=new bs(R.type,[I]):I.type.kind!=="value"&&R.type.kind==="value"&&(R=new bs(I.type,[R])));let k=null;if(b.length===4){if(I.type.kind!=="string"&&R.type.kind!=="string"&&I.type.kind!=="value"&&R.type.kind!=="value")return w.error("Cannot use collator to compare non-string types.");if(k=w.parse(b[3],3,Yr),!k)return null}return new dS(I,R,k)}evaluate(b){const w=this.lhs.evaluate(b),A=this.rhs.evaluate(b);if(f&&this.hasUntypedArgument){const I=Zi(w),R=Zi(A);if(I.kind!==R.kind||I.kind!=="string"&&I.kind!=="number")throw new Wi(`Expected arguments for "${c}" to be (string, string) or (number, number), but found (${I.kind}, ${R.kind}) instead.`)}if(this.collator&&!f&&this.hasUntypedArgument){const I=Zi(w),R=Zi(A);if(I.kind!=="string"||R.kind!=="string")return o(b,w,A)}return this.collator?h(b,w,A,this.collator.evaluate(b)):o(b,w,A)}eachChild(b){b(this.lhs),b(this.rhs),this.collator&&b(this.collator)}outputDefined(){return!0}}}const Dp=co("==",(function(c,o,h){return o===h}),Xh),Zh=co("!=",(function(c,o,h){return o!==h}),(function(c,o,h,f){return!Xh(0,o,h,f)})),Yh=co("<",(function(c,o,h){return o<h}),(function(c,o,h,f){return f.compare(o,h)<0})),Op=co(">",(function(c,o,h){return o>h}),(function(c,o,h,f){return f.compare(o,h)>0})),Lp=co("<=",(function(c,o,h){return o<=h}),(function(c,o,h,f){return f.compare(o,h)<=0})),Gh=co(">=",(function(c,o,h){return o>=h}),(function(c,o,h,f){return f.compare(o,h)>=0}));class aa{constructor(o,h,f){this.type=Yr,this.locale=f,this.caseSensitive=o,this.diacriticSensitive=h}static parse(o,h){if(o.length!==2)return h.error("Expected one argument.");const f=o[1];if(typeof f!="object"||Array.isArray(f))return h.error("Collator options argument must be an object.");const _=h.parse(f["case-sensitive"]!==void 0&&f["case-sensitive"],1,Nt);if(!_)return null;const b=h.parse(f["diacritic-sensitive"]!==void 0&&f["diacritic-sensitive"],1,Nt);if(!b)return null;let w=null;return f.locale&&(w=h.parse(f.locale,1,qt),!w)?null:new aa(_,b,w)}evaluate(o){return new Oc(this.caseSensitive.evaluate(o),this.diacriticSensitive.evaluate(o),this.locale?this.locale.evaluate(o):null)}eachChild(o){o(this.caseSensitive),o(this.diacriticSensitive),this.locale&&o(this.locale)}outputDefined(){return!1}}class Uc{constructor(o,h,f,_,b){this.type=qt,this.number=o,this.locale=h,this.currency=f,this.minFractionDigits=_,this.maxFractionDigits=b}static parse(o,h){if(o.length!==3)return h.error("Expected two arguments.");const f=h.parse(o[1],1,ot);if(!f)return null;const _=o[2];if(typeof _!="object"||Array.isArray(_))return h.error("NumberFormat options argument must be an object.");let b=null;if(_.locale&&(b=h.parse(_.locale,1,qt),!b))return null;let w=null;if(_.currency&&(w=h.parse(_.currency,1,qt),!w))return null;let A=null;if(_["min-fraction-digits"]&&(A=h.parse(_["min-fraction-digits"],1,ot),!A))return null;let I=null;return _["max-fraction-digits"]&&(I=h.parse(_["max-fraction-digits"],1,ot),!I)?null:new Uc(f,b,w,A,I)}evaluate(o){return new Intl.NumberFormat(this.locale?this.locale.evaluate(o):[],{style:this.currency?"currency":"decimal",currency:this.currency?this.currency.evaluate(o):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(o):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(o):void 0}).format(this.number.evaluate(o))}eachChild(o){o(this.number),this.locale&&o(this.locale),this.currency&&o(this.currency),this.minFractionDigits&&o(this.minFractionDigits),this.maxFractionDigits&&o(this.maxFractionDigits)}outputDefined(){return!1}}class cl{constructor(o){this.type=xs,this.sections=o}static parse(o,h){if(o.length<2)return h.error("Expected at least one argument.");const f=o[1];if(!Array.isArray(f)&&typeof f=="object")return h.error("First argument must be an image or text section.");const _=[];let b=!1;for(let w=1;w<=o.length-1;++w){const A=o[w];if(b&&typeof A=="object"&&!Array.isArray(A)){b=!1;let I=null;if(A["font-scale"]&&(I=h.parse(A["font-scale"],1,ot),!I))return null;let R=null;if(A["text-font"]&&(R=h.parse(A["text-font"],1,B(qt)),!R))return null;let k=null;if(A["text-color"]&&(k=h.parse(A["text-color"],1,Ji),!k))return null;const F=_[_.length-1];F.scale=I,F.font=R,F.textColor=k}else{const I=h.parse(o[w],1,zt);if(!I)return null;const R=I.type.kind;if(R!=="string"&&R!=="value"&&R!=="null"&&R!=="resolvedImage")return h.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");b=!0,_.push({content:I,scale:null,font:null,textColor:null})}}return new cl(_)}evaluate(o){return new Gr(this.sections.map((h=>{const f=h.content.evaluate(o);return Zi(f)===as?new Lc("",f,null,null,null):new Lc(sa(f),null,h.scale?h.scale.evaluate(o):null,h.font?h.font.evaluate(o).join(","):null,h.textColor?h.textColor.evaluate(o):null)})))}eachChild(o){for(const h of this.sections)o(h.content),h.scale&&o(h.scale),h.font&&o(h.font),h.textColor&&o(h.textColor)}outputDefined(){return!1}}class Vc{constructor(o){this.type=as,this.input=o}static parse(o,h){if(o.length!==2)return h.error("Expected two arguments.");const f=h.parse(o[1],1,qt);return f?new Vc(f):h.error("No image name provided.")}evaluate(o){const h=this.input.evaluate(o),f=Jr.fromString(h);return f&&o.availableImages&&(f.available=o.availableImages.indexOf(h)>-1),f}eachChild(o){o(this.input)}outputDefined(){return!1}}class jc{constructor(o){this.type=ot,this.input=o}static parse(o,h){if(o.length!==2)return h.error(`Expected 1 argument, but found ${o.length-1} instead.`);const f=h.parse(o[1],1);return f?f.type.kind!=="array"&&f.type.kind!=="string"&&f.type.kind!=="value"?h.error(`Expected argument of type string or array, but found ${U(f.type)} instead.`):new jc(f):null}evaluate(o){const h=this.input.evaluate(o);if(typeof h=="string")return[...h].length;if(Array.isArray(h))return h.length;throw new Wi(`Expected value to be of type string or array, but found ${U(Zi(h))} instead.`)}eachChild(o){o(this.input)}outputDefined(){return!1}}const Vs=8192;function Fp(c,o){const h=(180+c[0])/360,f=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+c[1]*Math.PI/360)))/360,_=Math.pow(2,o.z);return[Math.round(h*_*Vs),Math.round(f*_*Vs)]}function $c(c,o){const h=Math.pow(2,o.z);return[(_=(c[0]/Vs+o.x)/h,360*_-180),(f=(c[1]/Vs+o.y)/h,360/Math.PI*Math.atan(Math.exp((180-360*f)*Math.PI/180))-90)];var f,_}function On(c,o){c[0]=Math.min(c[0],o[0]),c[1]=Math.min(c[1],o[1]),c[2]=Math.max(c[2],o[0]),c[3]=Math.max(c[3],o[1])}function fn(c,o){return!(c[0]<=o[0]||c[2]>=o[2]||c[1]<=o[1]||c[3]>=o[3])}function ui(c,o,h){const f=c[0]-o[0],_=c[1]-o[1],b=c[0]-h[0],w=c[1]-h[1];return f*w-b*_==0&&f*b<=0&&_*w<=0}function ul(c,o,h,f){return(_=[f[0]-h[0],f[1]-h[1]])[0]*(b=[o[0]-c[0],o[1]-c[1]])[1]-_[1]*b[0]!=0&&!(!Jh(c,o,h,f)||!Jh(h,f,c,o));var _,b}function Bp(c,o,h){for(const f of h)for(let _=0;_<f.length-1;++_)if(ul(c,o,f[_],f[_+1]))return!0;return!1}function uo(c,o,h=!1){let f=!1;for(const A of o)for(let I=0;I<A.length-1;I++){if(ui(c,A[I],A[I+1]))return h;(b=A[I])[1]>(_=c)[1]!=(w=A[I+1])[1]>_[1]&&_[0]<(w[0]-b[0])*(_[1]-b[1])/(w[1]-b[1])+b[0]&&(f=!f)}var _,b,w;return f}function Np(c,o){for(const h of o)if(uo(c,h))return!0;return!1}function Kh(c,o){for(const h of c)if(!uo(h,o))return!1;for(let h=0;h<c.length-1;++h)if(Bp(c[h],c[h+1],o))return!1;return!0}function zp(c,o){for(const h of o)if(Kh(c,h))return!0;return!1}function Jh(c,o,h,f){const _=f[0]-h[0],b=f[1]-h[1],w=(c[0]-h[0])*b-_*(c[1]-h[1]),A=(o[0]-h[0])*b-_*(o[1]-h[1]);return w>0&&A<0||w<0&&A>0}function Wc(c,o,h){const f=[];for(let _=0;_<c.length;_++){const b=[];for(let w=0;w<c[_].length;w++){const A=Fp(c[_][w],h);On(o,A),b.push(A)}f.push(b)}return f}function Qh(c,o,h){const f=[];for(let _=0;_<c.length;_++){const b=Wc(c[_],o,h);f.push(b)}return f}function ed(c,o,h,f){if(c[0]<h[0]||c[0]>h[2]){const _=.5*f;let b=c[0]-h[0]>_?-f:h[0]-c[0]>_?f:0;b===0&&(b=c[0]-h[2]>_?-f:h[2]-c[0]>_?f:0),c[0]+=b}On(o,c)}function td(c,o,h,f){const _=Math.pow(2,f.z)*Vs,b=[f.x*Vs,f.y*Vs],w=[];for(const A of c)for(const I of A){const R=[I.x+b[0],I.y+b[1]];ed(R,o,h,_),w.push(R)}return w}function id(c,o,h,f){const _=Math.pow(2,f.z)*Vs,b=[f.x*Vs,f.y*Vs],w=[];for(const I of c){const R=[];for(const k of I){const F=[k.x+b[0],k.y+b[1]];On(o,F),R.push(F)}w.push(R)}if(o[2]-o[0]<=_/2){(A=o)[0]=A[1]=1/0,A[2]=A[3]=-1/0;for(const I of w)for(const R of I)ed(R,o,h,_)}var A;return w}class Ln{constructor(o,h){this.type=Nt,this.geojson=o,this.geometries=h}static parse(o,h){if(o.length!==2)return h.error(`'within' expression requires exactly one argument, but found ${o.length-1} instead.`);if(Rn(o[1])){const f=o[1];if(f.type==="FeatureCollection"){const _=[];for(const b of f.features){const{type:w,coordinates:A}=b.geometry;w==="Polygon"&&_.push(A),w==="MultiPolygon"&&_.push(...A)}if(_.length)return new Ln(f,{type:"MultiPolygon",coordinates:_})}else if(f.type==="Feature"){const _=f.geometry.type;if(_==="Polygon"||_==="MultiPolygon")return new Ln(f,f.geometry)}else if(f.type==="Polygon"||f.type==="MultiPolygon")return new Ln(f,f)}return h.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(o){if(o.geometry()!=null&&o.canonicalID()!=null){if(o.geometryType()==="Point")return(function(h,f){const _=[1/0,1/0,-1/0,-1/0],b=[1/0,1/0,-1/0,-1/0],w=h.canonicalID();if(f.type==="Polygon"){const A=Wc(f.coordinates,b,w),I=td(h.geometry(),_,b,w);if(!fn(_,b))return!1;for(const R of I)if(!uo(R,A))return!1}if(f.type==="MultiPolygon"){const A=Qh(f.coordinates,b,w),I=td(h.geometry(),_,b,w);if(!fn(_,b))return!1;for(const R of I)if(!Np(R,A))return!1}return!0})(o,this.geometries);if(o.geometryType()==="LineString")return(function(h,f){const _=[1/0,1/0,-1/0,-1/0],b=[1/0,1/0,-1/0,-1/0],w=h.canonicalID();if(f.type==="Polygon"){const A=Wc(f.coordinates,b,w),I=id(h.geometry(),_,b,w);if(!fn(_,b))return!1;for(const R of I)if(!Kh(R,A))return!1}if(f.type==="MultiPolygon"){const A=Qh(f.coordinates,b,w),I=id(h.geometry(),_,b,w);if(!fn(_,b))return!1;for(const R of I)if(!zp(R,A))return!1}return!0})(o,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}}let rd=class{constructor(c=[],o=((h,f)=>h<f?-1:h>f?1:0)){if(this.data=c,this.length=this.data.length,this.compare=o,this.length>0)for(let h=(this.length>>1)-1;h>=0;h--)this._down(h)}push(c){this.data.push(c),this._up(this.length++)}pop(){if(this.length===0)return;const c=this.data[0],o=this.data.pop();return--this.length>0&&(this.data[0]=o,this._down(0)),c}peek(){return this.data[0]}_up(c){const{data:o,compare:h}=this,f=o[c];for(;c>0;){const _=c-1>>1,b=o[_];if(h(f,b)>=0)break;o[c]=b,c=_}o[c]=f}_down(c){const{data:o,compare:h}=this,f=this.length>>1,_=o[c];for(;c<f;){let b=1+(c<<1);const w=b+1;if(w<this.length&&h(o[w],o[b])<0&&(b=w),h(o[b],_)>=0)break;o[c]=o[b],c=b}o[c]=_}};function Up(c,o,h,f,_){sd(c,o,h,f||c.length-1,_||Vp)}function sd(c,o,h,f,_){for(;f>h;){if(f-h>600){var b=f-h+1,w=o-h+1,A=Math.log(b),I=.5*Math.exp(2*A/3),R=.5*Math.sqrt(A*I*(b-I)/b)*(w-b/2<0?-1:1);sd(c,o,Math.max(h,Math.floor(o-w*I/b+R)),Math.min(f,Math.floor(o+(b-w)*I/b+R)),_)}var k=c[o],F=h,V=f;for(la(c,h,o),_(c[f],k)>0&&la(c,h,f);F<V;){for(la(c,F,V),F++,V--;_(c[F],k)<0;)F++;for(;_(c[V],k)>0;)V--}_(c[h],k)===0?la(c,h,V):la(c,++V,f),V<=o&&(h=V+1),o<=V&&(f=V-1)}}function la(c,o,h){var f=c[o];c[o]=c[h],c[h]=f}function Vp(c,o){return c<o?-1:c>o?1:0}function hl(c,o){if(c.length<=1)return[c];const h=[];let f,_;for(const b of c){const w=$p(b);w!==0&&(b.area=Math.abs(w),_===void 0&&(_=w<0),_===w<0?(f&&h.push(f),f=[b]):f.push(b))}if(f&&h.push(f),o>1)for(let b=0;b<h.length;b++)h[b].length<=o||(Up(h[b],o,1,h[b].length-1,jp),h[b]=h[b].slice(0,o));return h}function jp(c,o){return o.area-c.area}function $p(c){let o=0;for(let h,f,_=0,b=c.length,w=b-1;_<b;w=_++)h=c[_],f=c[w],o+=(f.x-h.x)*(h.y+f.y);return o}const nd=1/298.257223563,od=nd*(2-nd),ad=Math.PI/180;class Hc{constructor(o){const h=6378.137*ad*1e3,f=Math.cos(o*ad),_=1/(1-od*(1-f*f)),b=Math.sqrt(_);this.kx=h*b*f,this.ky=h*b*_*(1-od)}distance(o,h){const f=this.wrap(o[0]-h[0])*this.kx,_=(o[1]-h[1])*this.ky;return Math.sqrt(f*f+_*_)}pointOnLine(o,h){let f,_,b,w,A=1/0;for(let I=0;I<o.length-1;I++){let R=o[I][0],k=o[I][1],F=this.wrap(o[I+1][0]-R)*this.kx,V=(o[I+1][1]-k)*this.ky,j=0;F===0&&V===0||(j=(this.wrap(h[0]-R)*this.kx*F+(h[1]-k)*this.ky*V)/(F*F+V*V),j>1?(R=o[I+1][0],k=o[I+1][1]):j>0&&(R+=F/this.kx*j,k+=V/this.ky*j)),F=this.wrap(h[0]-R)*this.kx,V=(h[1]-k)*this.ky;const X=F*F+V*V;X<A&&(A=X,f=R,_=k,b=I,w=j)}return{point:[f,_],index:b,t:Math.max(0,Math.min(1,w))}}wrap(o){for(;o<-180;)o+=360;for(;o>180;)o-=360;return o}}function ld(c,o){return o[0]-c[0]}function dl(c){return c[1]-c[0]+1}function Qs(c,o){return c[1]>=c[0]&&c[1]<o}function qc(c,o){if(c[0]>c[1])return[null,null];const h=dl(c);if(o){if(h===2)return[c,null];const _=Math.floor(h/2);return[[c[0],c[0]+_],[c[0]+_,c[1]]]}if(h===1)return[c,null];const f=Math.floor(h/2)-1;return[[c[0],c[0]+f],[c[0]+f+1,c[1]]]}function Xc(c,o){if(!Qs(o,c.length))return[1/0,1/0,-1/0,-1/0];const h=[1/0,1/0,-1/0,-1/0];for(let f=o[0];f<=o[1];++f)On(h,c[f]);return h}function Zc(c){const o=[1/0,1/0,-1/0,-1/0];for(const h of c)for(const f of h)On(o,f);return o}function fl(c){return c[0]!==-1/0&&c[1]!==-1/0&&c[2]!==1/0&&c[3]!==1/0}function Yc(c,o,h){if(!fl(c)||!fl(o))return NaN;let f=0,_=0;return c[2]<o[0]&&(f=o[0]-c[2]),c[0]>o[2]&&(f=c[0]-o[2]),c[1]>o[3]&&(_=c[1]-o[3]),c[3]<o[1]&&(_=o[1]-c[3]),h.distance([0,0],[f,_])}function Fn(c,o,h){const f=h.pointOnLine(o,c);return h.distance(c,f.point)}function Gc(c,o,h,f,_){const b=Math.min(Fn(c,[h,f],_),Fn(o,[h,f],_)),w=Math.min(Fn(h,[c,o],_),Fn(f,[c,o],_));return Math.min(b,w)}function Wp(c,o,h,f,_){if(!Qs(o,c.length)||!Qs(f,h.length))return 1/0;let b=1/0;for(let w=o[0];w<o[1];++w){const A=c[w],I=c[w+1];for(let R=f[0];R<f[1];++R){const k=h[R],F=h[R+1];if(ul(A,I,k,F))return 0;b=Math.min(b,Gc(A,I,k,F,_))}}return b}function Ui(c,o,h,f,_){if(!Qs(o,c.length)||!Qs(f,h.length))return NaN;let b=1/0;for(let w=o[0];w<=o[1];++w)for(let A=f[0];A<=f[1];++A)if(b=Math.min(b,_.distance(c[w],h[A])),b===0)return b;return b}function Hp(c,o,h){if(uo(c,o,!0))return 0;let f=1/0;for(const _ of o){const b=_[0],w=_[_.length-1];if(b!==w&&(f=Math.min(f,Fn(c,[w,b],h)),f===0))return f;const A=h.pointOnLine(_,c);if(f=Math.min(f,h.distance(c,A.point)),f===0)return f}return f}function Yt(c,o,h,f){if(!Qs(o,c.length))return NaN;for(let b=o[0];b<=o[1];++b)if(uo(c[b],h,!0))return 0;let _=1/0;for(let b=o[0];b<o[1];++b){const w=c[b],A=c[b+1];for(const I of h)for(let R=0,k=I.length,F=k-1;R<k;F=R++){const V=I[F],j=I[R];if(ul(w,A,V,j))return 0;_=Math.min(_,Gc(w,A,V,j,f))}}return _}function pl(c,o){for(const h of c)for(const f of h)if(uo(f,o,!0))return!0;return!1}function xi(c,o,h,f=1/0){const _=Zc(c),b=Zc(o);if(f!==1/0&&Yc(_,b,h)>=f)return f;if(fn(_,b)){if(pl(c,o))return 0}else if(pl(o,c))return 0;let w=1/0;for(const A of c)for(let I=0,R=A.length,k=R-1;I<R;k=I++){const F=A[k],V=A[I];for(const j of o)for(let X=0,Z=j.length,se=Z-1;X<Z;se=X++){const ue=j[se],Me=j[X];if(ul(F,V,ue,Me))return 0;w=Math.min(w,Gc(F,V,ue,Me,h))}}return w}function fi(c,o,h,f,_,b){if(!b)return;const w=Yc(Xc(f,b),_,h);w<o&&c.push([w,b,[0,0]])}function Bn(c,o,h,f,_,b,w){if(!b||!w)return;const A=Yc(Xc(f,b),Xc(_,w),h);A<o&&c.push([A,b,w])}function ca(c,o,h,f,_=1/0){let b=Math.min(f.distance(c[0],h[0][0]),_);if(b===0)return b;const w=new rd([[0,[0,c.length-1],[0,0]]],ld),A=Zc(h);for(;w.length>0;){const I=w.pop();if(I[0]>=b)continue;const R=I[1],k=o?50:100;if(dl(R)<=k){if(!Qs(R,c.length))return NaN;if(o){const F=Yt(c,R,h,f);if(isNaN(F)||F===0)return F;b=Math.min(b,F)}else for(let F=R[0];F<=R[1];++F){const V=Hp(c[F],h,f);if(b=Math.min(b,V),b===0)return 0}}else{const F=qc(R,o);fi(w,b,f,c,A,F[0]),fi(w,b,f,c,A,F[1])}}return b}function ua(c,o,h,f,_,b=1/0){let w=Math.min(b,_.distance(c[0],h[0]));if(w===0)return w;const A=new rd([[0,[0,c.length-1],[0,h.length-1]]],ld);for(;A.length>0;){const I=A.pop();if(I[0]>=w)continue;const R=I[1],k=I[2],F=o?50:100,V=f?50:100;if(dl(R)<=F&&dl(k)<=V){if(!Qs(R,c.length)&&Qs(k,h.length))return NaN;let j;if(o&&f)j=Wp(c,R,h,k,_),w=Math.min(w,j);else if(o&&!f){const X=c.slice(R[0],R[1]+1);for(let Z=k[0];Z<=k[1];++Z)if(j=Fn(h[Z],X,_),w=Math.min(w,j),w===0)return w}else if(!o&&f){const X=h.slice(k[0],k[1]+1);for(let Z=R[0];Z<=R[1];++Z)if(j=Fn(c[Z],X,_),w=Math.min(w,j),w===0)return w}else j=Ui(c,R,h,k,_),w=Math.min(w,j)}else{const j=qc(R,o),X=qc(k,f);Bn(A,w,_,c,h,j[0],X[0]),Bn(A,w,_,c,h,j[0],X[1]),Bn(A,w,_,c,h,j[1],X[0]),Bn(A,w,_,c,h,j[1],X[1])}}return w}function Kc(c){return c.type==="MultiPolygon"?c.coordinates.map((o=>({type:"Polygon",coordinates:o}))):c.type==="MultiLineString"?c.coordinates.map((o=>({type:"LineString",coordinates:o}))):c.type==="MultiPoint"?c.coordinates.map((o=>({type:"Point",coordinates:o}))):[c]}class Nn{constructor(o,h){this.type=ot,this.geojson=o,this.geometries=h}static parse(o,h){if(o.length!==2)return h.error(`'distance' expression requires exactly one argument, but found ${o.length-1} instead.`);if(Rn(o[1])){const f=o[1];if(f.type==="FeatureCollection")return new Nn(f,f.features.map((_=>Kc(_.geometry))).flat());if(f.type==="Feature")return new Nn(f,Kc(f.geometry));if("type"in f&&"coordinates"in f)return new Nn(f,Kc(f))}return h.error("'distance' expression requires valid geojson object that contains polygon geometry type.")}evaluate(o){if(o.geometry()!=null&&o.canonicalID()!=null){if(o.geometryType()==="Point")return(function(h,f){const _=h.geometry(),b=_.flat().map((I=>$c([I.x,I.y],h.canonical)));if(_.length===0)return NaN;const w=new Hc(b[0][1]);let A=1/0;for(const I of f){switch(I.type){case"Point":A=Math.min(A,ua(b,!1,[I.coordinates],!1,w,A));break;case"LineString":A=Math.min(A,ua(b,!1,I.coordinates,!0,w,A));break;case"Polygon":A=Math.min(A,ca(b,!1,I.coordinates,w,A))}if(A===0)return A}return A})(o,this.geometries);if(o.geometryType()==="LineString")return(function(h,f){const _=h.geometry(),b=_.flat().map((I=>$c([I.x,I.y],h.canonical)));if(_.length===0)return NaN;const w=new Hc(b[0][1]);let A=1/0;for(const I of f){switch(I.type){case"Point":A=Math.min(A,ua(b,!0,[I.coordinates],!1,w,A));break;case"LineString":A=Math.min(A,ua(b,!0,I.coordinates,!0,w,A));break;case"Polygon":A=Math.min(A,ca(b,!0,I.coordinates,w,A))}if(A===0)return A}return A})(o,this.geometries);if(o.geometryType()==="Polygon")return(function(h,f){const _=h.geometry();if(_.length===0||_[0].length===0)return NaN;const b=hl(_,0).map((I=>I.map((R=>R.map((k=>$c([k.x,k.y],h.canonical))))))),w=new Hc(b[0][0][0][1]);let A=1/0;for(const I of f)for(const R of b){switch(I.type){case"Point":A=Math.min(A,ca([I.coordinates],!1,R,w,A));break;case"LineString":A=Math.min(A,ca(I.coordinates,!0,R,w,A));break;case"Polygon":A=Math.min(A,xi(R,I.coordinates,w,A))}if(A===0)return A}return A})(o,this.geometries)}return NaN}eachChild(){}outputDefined(){return!0}}const ho={"==":Dp,"!=":Zh,">":Op,"<":Yh,">=":Gh,"<=":Lp,array:bs,at:Bc,boolean:bs,case:sl,coalesce:al,collator:aa,format:cl,image:Vc,in:Nc,"index-of":ao,interpolate:Lr,"interpolate-hcl":Lr,"interpolate-lab":Lr,length:jc,let:dn,literal:vs,match:zc,number:bs,"number-format":Uc,object:bs,slice:na,step:lo,string:bs,"to-boolean":ws,"to-color":ws,"to-number":ws,"to-string":ws,var:ci,within:Ln,distance:Nn};class cs{constructor(o,h,f,_){this.name=o,this.type=h,this._evaluate=f,this.args=_}evaluate(o){return this._evaluate(o,this.args)}eachChild(o){this.args.forEach(o)}outputDefined(){return!1}static parse(o,h){const f=o[0],_=cs.definitions[f];if(!_)return h.error(`Unknown expression "${f}". If you wanted a literal array, use ["literal", [...]].`,0);const b=Array.isArray(_)?_[0]:_.type,w=Array.isArray(_)?[[_[1],_[2]]]:_.overloads,A=w.filter((([R])=>!Array.isArray(R)||R.length===o.length-1));let I=null;for(const[R,k]of A){I=new kn(h.registry,ha,h.path,null,h.scope);const F=[];let V=!1;for(let j=1;j<o.length;j++){const X=o[j],Z=Array.isArray(R)?R[j-1]:R.type,se=I.parse(X,1+F.length,Z);if(!se){V=!0;break}F.push(se)}if(!V)if(Array.isArray(R)&&R.length!==F.length)I.error(`Expected ${R.length} arguments, but found ${F.length} instead.`);else{for(let j=0;j<F.length;j++){const X=Array.isArray(R)?R[j]:R.type,Z=F[j];I.concat(j+1).checkSubtype(X,Z.type)}if(I.errors.length===0)return new cs(f,b,k,F)}}if(A.length===1)h.errors.push(...I.errors);else{const R=(A.length?A:w).map((([F])=>{return V=F,Array.isArray(V)?`(${V.map(U).join(", ")})`:`(${U(V.type)}...)`;var V})).join(" | "),k=[];for(let F=1;F<o.length;F++){const V=h.parse(o[F],1+k.length);if(!V)return null;k.push(U(V.type))}h.error(`Expected arguments of type ${R}, but found (${k.join(", ")}) instead.`)}return null}static register(o,h){cs.definitions=h;for(const f in h)o[f]=cs}}function Jc(c,[o,h,f,_]){o=o.evaluate(c),h=h.evaluate(c),f=f.evaluate(c);const b=_?_.evaluate(c):1,w=oo(o,h,f,b);if(w)throw new Wi(w);return new di(o/255,h/255,f/255,b,!1)}function Qc(c,o){return c in o}function eu(c,o){const h=o[c];return h===void 0?null:h}function zn(c){return{type:c}}function ha(c){if(c instanceof ci)return ha(c.boundExpression);if(c instanceof cs&&c.name==="error"||c instanceof aa||c instanceof Ln||c instanceof Nn)return!1;const o=c instanceof ws||c instanceof bs;let h=!0;return c.eachChild((f=>{h=o?h&&ha(f):h&&f instanceof vs})),!!h&&da(c)&&fa(c,["zoom","heatmap-density","line-progress","accumulated","is-supported-script"])}function da(c){if(c instanceof cs&&(c.name==="get"&&c.args.length===1||c.name==="feature-state"||c.name==="has"&&c.args.length===1||c.name==="properties"||c.name==="geometry-type"||c.name==="id"||/^filter-/.test(c.name))||c instanceof Ln||c instanceof Nn)return!1;let o=!0;return c.eachChild((h=>{o&&!da(h)&&(o=!1)})),o}function fo(c){if(c instanceof cs&&c.name==="feature-state")return!1;let o=!0;return c.eachChild((h=>{o&&!fo(h)&&(o=!1)})),o}function fa(c,o){if(c instanceof cs&&o.indexOf(c.name)>=0)return!1;let h=!0;return c.eachChild((f=>{h&&!fa(f,o)&&(h=!1)})),h}function gl(c){return{result:"success",value:c}}function po(c){return{result:"error",value:c}}function go(c){return c["property-type"]==="data-driven"||c["property-type"]==="cross-faded-data-driven"}function cd(c){return!!c.expression&&c.expression.parameters.indexOf("zoom")>-1}function tu(c){return!!c.expression&&c.expression.interpolated}function oi(c){return c instanceof Number?"number":c instanceof String?"string":c instanceof Boolean?"boolean":Array.isArray(c)?"array":c===null?"null":typeof c}function ml(c){return typeof c=="object"&&c!==null&&!Array.isArray(c)}function qp(c){return c}function ud(c,o){const h=o.type==="color",f=c.stops&&typeof c.stops[0][0]=="object",_=f||!(f||c.property!==void 0),b=c.type||(tu(o)?"exponential":"interval");if(h||o.type==="padding"){const k=h?di.parse:Kr.parse;(c=Xr({},c)).stops&&(c.stops=c.stops.map((F=>[F[0],k(F[1])]))),c.default=k(c.default?c.default:o.default)}if(c.colorSpace&&(w=c.colorSpace)!=="rgb"&&w!=="hcl"&&w!=="lab")throw new Error(`Unknown color space: "${c.colorSpace}"`);var w;let A,I,R;if(b==="exponential")A=dd;else if(b==="interval")A=_l;else if(b==="categorical"){A=hd,I=Object.create(null);for(const k of c.stops)I[k[0]]=k[1];R=typeof c.stops[0][0]}else{if(b!=="identity")throw new Error(`Unknown function type "${b}"`);A=fd}if(f){const k={},F=[];for(let X=0;X<c.stops.length;X++){const Z=c.stops[X],se=Z[0].zoom;k[se]===void 0&&(k[se]={zoom:se,type:c.type,property:c.property,default:c.default,stops:[]},F.push(se)),k[se].stops.push([Z[0].value,Z[1]])}const V=[];for(const X of F)V.push([k[X].zoom,ud(k[X],o)]);const j={name:"linear"};return{kind:"composite",interpolationType:j,interpolationFactor:Lr.interpolationFactor.bind(void 0,j),zoomStops:V.map((X=>X[0])),evaluate:({zoom:X},Z)=>dd({stops:V,base:c.base},o,X).evaluate(X,Z)}}if(_){const k=b==="exponential"?{name:"exponential",base:c.base!==void 0?c.base:1}:null;return{kind:"camera",interpolationType:k,interpolationFactor:Lr.interpolationFactor.bind(void 0,k),zoomStops:c.stops.map((F=>F[0])),evaluate:({zoom:F})=>A(c,o,F,I,R)}}return{kind:"source",evaluate(k,F){const V=F&&F.properties?F.properties[c.property]:void 0;return V===void 0?mo(c.default,o.default):A(c,o,V,I,R)}}}function mo(c,o,h){return c!==void 0?c:o!==void 0?o:h!==void 0?h:void 0}function hd(c,o,h,f,_){return mo(typeof h===_?f[h]:void 0,c.default,o.default)}function _l(c,o,h){if(oi(h)!=="number")return mo(c.default,o.default);const f=c.stops.length;if(f===1||h<=c.stops[0][0])return c.stops[0][1];if(h>=c.stops[f-1][0])return c.stops[f-1][1];const _=nl(c.stops.map((b=>b[0])),h);return c.stops[_][1]}function dd(c,o,h){const f=c.base!==void 0?c.base:1;if(oi(h)!=="number")return mo(c.default,o.default);const _=c.stops.length;if(_===1||h<=c.stops[0][0])return c.stops[0][1];if(h>=c.stops[_-1][0])return c.stops[_-1][1];const b=nl(c.stops.map((k=>k[0])),h),w=(function(k,F,V,j){const X=j-V,Z=k-V;return X===0?0:F===1?Z/X:(Math.pow(F,Z)-1)/(Math.pow(F,X)-1)})(h,f,c.stops[b][0],c.stops[b+1][0]),A=c.stops[b][1],I=c.stops[b+1][1],R=Or[o.type]||qp;return typeof A.evaluate=="function"?{evaluate(...k){const F=A.evaluate.apply(void 0,k),V=I.evaluate.apply(void 0,k);if(F!==void 0&&V!==void 0)return R(F,V,w,c.colorSpace)}}:R(A,I,w,c.colorSpace)}function fd(c,o,h){switch(o.type){case"color":h=di.parse(h);break;case"formatted":h=Gr.fromString(h.toString());break;case"resolvedImage":h=Jr.fromString(h.toString());break;case"padding":h=Kr.parse(h);break;default:oi(h)===o.type||o.type==="enum"&&o.values[h]||(h=void 0)}return mo(h,c.default,o.default)}cs.register(ho,{error:[{kind:"error"},[qt],(c,[o])=>{throw new Wi(o.evaluate(c))}],typeof:[qt,[zt],(c,[o])=>U(Zi(o.evaluate(c)))],"to-rgba":[B(ot,4),[Ji],(c,[o])=>{const[h,f,_,b]=o.evaluate(c).rgb;return[255*h,255*f,255*_,b]}],rgb:[Ji,[ot,ot,ot],Jc],rgba:[Ji,[ot,ot,ot,ot],Jc],has:{type:Nt,overloads:[[[qt],(c,[o])=>Qc(o.evaluate(c),c.properties())],[[qt,Zr],(c,[o,h])=>Qc(o.evaluate(c),h.evaluate(c))]]},get:{type:zt,overloads:[[[qt],(c,[o])=>eu(o.evaluate(c),c.properties())],[[qt,Zr],(c,[o,h])=>eu(o.evaluate(c),h.evaluate(c))]]},"feature-state":[zt,[qt],(c,[o])=>eu(o.evaluate(c),c.featureState||{})],properties:[Zr,[],c=>c.properties()],"geometry-type":[qt,[],c=>c.geometryType()],id:[zt,[],c=>c.id()],zoom:[ot,[],c=>c.globals.zoom],"heatmap-density":[ot,[],c=>c.globals.heatmapDensity||0],"line-progress":[ot,[],c=>c.globals.lineProgress||0],accumulated:[zt,[],c=>c.globals.accumulated===void 0?null:c.globals.accumulated],"+":[ot,zn(ot),(c,o)=>{let h=0;for(const f of o)h+=f.evaluate(c);return h}],"*":[ot,zn(ot),(c,o)=>{let h=1;for(const f of o)h*=f.evaluate(c);return h}],"-":{type:ot,overloads:[[[ot,ot],(c,[o,h])=>o.evaluate(c)-h.evaluate(c)],[[ot],(c,[o])=>-o.evaluate(c)]]},"/":[ot,[ot,ot],(c,[o,h])=>o.evaluate(c)/h.evaluate(c)],"%":[ot,[ot,ot],(c,[o,h])=>o.evaluate(c)%h.evaluate(c)],ln2:[ot,[],()=>Math.LN2],pi:[ot,[],()=>Math.PI],e:[ot,[],()=>Math.E],"^":[ot,[ot,ot],(c,[o,h])=>Math.pow(o.evaluate(c),h.evaluate(c))],sqrt:[ot,[ot],(c,[o])=>Math.sqrt(o.evaluate(c))],log10:[ot,[ot],(c,[o])=>Math.log(o.evaluate(c))/Math.LN10],ln:[ot,[ot],(c,[o])=>Math.log(o.evaluate(c))],log2:[ot,[ot],(c,[o])=>Math.log(o.evaluate(c))/Math.LN2],sin:[ot,[ot],(c,[o])=>Math.sin(o.evaluate(c))],cos:[ot,[ot],(c,[o])=>Math.cos(o.evaluate(c))],tan:[ot,[ot],(c,[o])=>Math.tan(o.evaluate(c))],asin:[ot,[ot],(c,[o])=>Math.asin(o.evaluate(c))],acos:[ot,[ot],(c,[o])=>Math.acos(o.evaluate(c))],atan:[ot,[ot],(c,[o])=>Math.atan(o.evaluate(c))],min:[ot,zn(ot),(c,o)=>Math.min(...o.map((h=>h.evaluate(c))))],max:[ot,zn(ot),(c,o)=>Math.max(...o.map((h=>h.evaluate(c))))],abs:[ot,[ot],(c,[o])=>Math.abs(o.evaluate(c))],round:[ot,[ot],(c,[o])=>{const h=o.evaluate(c);return h<0?-Math.round(-h):Math.round(h)}],floor:[ot,[ot],(c,[o])=>Math.floor(o.evaluate(c))],ceil:[ot,[ot],(c,[o])=>Math.ceil(o.evaluate(c))],"filter-==":[Nt,[qt,zt],(c,[o,h])=>c.properties()[o.value]===h.value],"filter-id-==":[Nt,[zt],(c,[o])=>c.id()===o.value],"filter-type-==":[Nt,[qt],(c,[o])=>c.geometryType()===o.value],"filter-<":[Nt,[qt,zt],(c,[o,h])=>{const f=c.properties()[o.value],_=h.value;return typeof f==typeof _&&f<_}],"filter-id-<":[Nt,[zt],(c,[o])=>{const h=c.id(),f=o.value;return typeof h==typeof f&&h<f}],"filter->":[Nt,[qt,zt],(c,[o,h])=>{const f=c.properties()[o.value],_=h.value;return typeof f==typeof _&&f>_}],"filter-id->":[Nt,[zt],(c,[o])=>{const h=c.id(),f=o.value;return typeof h==typeof f&&h>f}],"filter-<=":[Nt,[qt,zt],(c,[o,h])=>{const f=c.properties()[o.value],_=h.value;return typeof f==typeof _&&f<=_}],"filter-id-<=":[Nt,[zt],(c,[o])=>{const h=c.id(),f=o.value;return typeof h==typeof f&&h<=f}],"filter->=":[Nt,[qt,zt],(c,[o,h])=>{const f=c.properties()[o.value],_=h.value;return typeof f==typeof _&&f>=_}],"filter-id->=":[Nt,[zt],(c,[o])=>{const h=c.id(),f=o.value;return typeof h==typeof f&&h>=f}],"filter-has":[Nt,[zt],(c,[o])=>o.value in c.properties()],"filter-has-id":[Nt,[],c=>c.id()!==null&&c.id()!==void 0],"filter-type-in":[Nt,[B(qt)],(c,[o])=>o.value.indexOf(c.geometryType())>=0],"filter-id-in":[Nt,[B(zt)],(c,[o])=>o.value.indexOf(c.id())>=0],"filter-in-small":[Nt,[qt,B(zt)],(c,[o,h])=>h.value.indexOf(c.properties()[o.value])>=0],"filter-in-large":[Nt,[qt,B(zt)],(c,[o,h])=>(function(f,_,b,w){for(;b<=w;){const A=b+w>>1;if(_[A]===f)return!0;_[A]>f?w=A-1:b=A+1}return!1})(c.properties()[o.value],h.value,0,h.value.length-1)],all:{type:Nt,overloads:[[[Nt,Nt],(c,[o,h])=>o.evaluate(c)&&h.evaluate(c)],[zn(Nt),(c,o)=>{for(const h of o)if(!h.evaluate(c))return!1;return!0}]]},any:{type:Nt,overloads:[[[Nt,Nt],(c,[o,h])=>o.evaluate(c)||h.evaluate(c)],[zn(Nt),(c,o)=>{for(const h of o)if(h.evaluate(c))return!0;return!1}]]},"!":[Nt,[Nt],(c,[o])=>!o.evaluate(c)],"is-supported-script":[Nt,[qt],(c,[o])=>{const h=c.globals&&c.globals.isSupportedScript;return!h||h(o.evaluate(c))}],upcase:[qt,[qt],(c,[o])=>o.evaluate(c).toUpperCase()],downcase:[qt,[qt],(c,[o])=>o.evaluate(c).toLowerCase()],concat:[qt,zn(zt),(c,o)=>o.map((h=>sa(h.evaluate(c)))).join("")],"resolved-locale":[qt,[Yr],(c,[o])=>o.evaluate(c).resolvedLocale()]});class yl{constructor(o,h){var f;this.expression=o,this._warningHistory={},this._evaluator=new rl,this._defaultValue=h?(f=h).type==="color"&&ml(f.default)?new di(0,0,0,0):f.type==="color"?di.parse(f.default)||null:f.type==="padding"?Kr.parse(f.default)||null:f.type==="variableAnchorOffsetCollection"?ls.parse(f.default)||null:f.default===void 0?null:f.default:null,this._enumValues=h&&h.type==="enum"?h.values:null}evaluateWithoutErrorHandling(o,h,f,_,b,w){return this._evaluator.globals=o,this._evaluator.feature=h,this._evaluator.featureState=f,this._evaluator.canonical=_,this._evaluator.availableImages=b||null,this._evaluator.formattedSection=w,this.expression.evaluate(this._evaluator)}evaluate(o,h,f,_,b,w){this._evaluator.globals=o,this._evaluator.feature=h||null,this._evaluator.featureState=f||null,this._evaluator.canonical=_,this._evaluator.availableImages=b||null,this._evaluator.formattedSection=w||null;try{const A=this.expression.evaluate(this._evaluator);if(A==null||typeof A=="number"&&A!=A)return this._defaultValue;if(this._enumValues&&!(A in this._enumValues))throw new Wi(`Expected value to be one of ${Object.keys(this._enumValues).map((I=>JSON.stringify(I))).join(", ")}, but found ${JSON.stringify(A)} instead.`);return A}catch(A){return this._warningHistory[A.message]||(this._warningHistory[A.message]=!0,typeof console<"u"&&console.warn(A.message)),this._defaultValue}}}function xl(c){return Array.isArray(c)&&c.length>0&&typeof c[0]=="string"&&c[0]in ho}function _o(c,o){const h=new kn(ho,ha,[],o?(function(_){const b={color:Ji,string:qt,number:ot,enum:qt,boolean:Nt,formatted:xs,padding:Us,resolvedImage:as,variableAnchorOffsetCollection:le};return _.type==="array"?B(b[_.value]||zt,_.length):b[_.type]})(o):void 0),f=h.parse(c,void 0,void 0,void 0,o&&o.type==="string"?{typeAnnotation:"coerce"}:void 0);return f?gl(new yl(f,o)):po(h.errors)}class yo{constructor(o,h){this.kind=o,this._styleExpression=h,this.isStateDependent=o!=="constant"&&!fo(h.expression)}evaluateWithoutErrorHandling(o,h,f,_,b,w){return this._styleExpression.evaluateWithoutErrorHandling(o,h,f,_,b,w)}evaluate(o,h,f,_,b,w){return this._styleExpression.evaluate(o,h,f,_,b,w)}}class xo{constructor(o,h,f,_){this.kind=o,this.zoomStops=f,this._styleExpression=h,this.isStateDependent=o!=="camera"&&!fo(h.expression),this.interpolationType=_}evaluateWithoutErrorHandling(o,h,f,_,b,w){return this._styleExpression.evaluateWithoutErrorHandling(o,h,f,_,b,w)}evaluate(o,h,f,_,b,w){return this._styleExpression.evaluate(o,h,f,_,b,w)}interpolationFactor(o,h,f){return this.interpolationType?Lr.interpolationFactor(this.interpolationType,o,h,f):0}}function iu(c,o){const h=_o(c,o);if(h.result==="error")return h;const f=h.value.expression,_=da(f);if(!_&&!go(o))return po([new er("","data expressions not supported")]);const b=fa(f,["zoom"]);if(!b&&!cd(o))return po([new er("","zoom expressions not supported")]);const w=pa(f);return w||b?w instanceof er?po([w]):w instanceof Lr&&!tu(o)?po([new er("",'"interpolate" expressions cannot be used with this property')]):gl(w?new xo(_?"camera":"composite",h.value,w.labels,w instanceof Lr?w.interpolation:void 0):new yo(_?"constant":"source",h.value)):po([new er("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.')])}class vo{constructor(o,h){this._parameters=o,this._specification=h,Xr(this,ud(this._parameters,this._specification))}static deserialize(o){return new vo(o._parameters,o._specification)}static serialize(o){return{_parameters:o._parameters,_specification:o._specification}}}function pa(c){let o=null;if(c instanceof dn)o=pa(c.result);else if(c instanceof al){for(const h of c.args)if(o=pa(h),o)break}else(c instanceof lo||c instanceof Lr)&&c.input instanceof cs&&c.input.name==="zoom"&&(o=c);return o instanceof er||c.eachChild((h=>{const f=pa(h);f instanceof er?o=f:!o&&f?o=new er("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.'):o&&f&&o!==f&&(o=new er("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))})),o}function vl(c){if(c===!0||c===!1)return!0;if(!Array.isArray(c)||c.length===0)return!1;switch(c[0]){case"has":return c.length>=2&&c[1]!=="$id"&&c[1]!=="$type";case"in":return c.length>=3&&(typeof c[1]!="string"||Array.isArray(c[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return c.length!==3||Array.isArray(c[1])||Array.isArray(c[2]);case"any":case"all":for(const o of c.slice(1))if(!vl(o)&&typeof o!="boolean")return!1;return!0;default:return!0}}const bl={type:"boolean",default:!1,transition:!1,"property-type":"data-driven",expression:{interpolated:!1,parameters:["zoom","feature"]}};function ru(c){if(c==null)return{filter:()=>!0,needGeometry:!1};vl(c)||(c=wl(c));const o=_o(c,bl);if(o.result==="error")throw new Error(o.value.map((h=>`${h.key}: ${h.message}`)).join(", "));return{filter:(h,f,_)=>o.value.evaluate(h,f,{},_),needGeometry:pd(c)}}function Xp(c,o){return c<o?-1:c>o?1:0}function pd(c){if(!Array.isArray(c))return!1;if(c[0]==="within"||c[0]==="distance")return!0;for(let o=1;o<c.length;o++)if(pd(c[o]))return!0;return!1}function wl(c){if(!c)return!0;const o=c[0];return c.length<=1?o!=="any":o==="=="?su(c[1],c[2],"=="):o==="!="?pr(su(c[1],c[2],"==")):o==="<"||o===">"||o==="<="||o===">="?su(c[1],c[2],o):o==="any"?(h=c.slice(1),["any"].concat(h.map(wl))):o==="all"?["all"].concat(c.slice(1).map(wl)):o==="none"?["all"].concat(c.slice(1).map(wl).map(pr)):o==="in"?ga(c[1],c.slice(2)):o==="!in"?pr(ga(c[1],c.slice(2))):o==="has"?ma(c[1]):o!=="!has"||pr(ma(c[1]));var h}function su(c,o,h){switch(c){case"$type":return[`filter-type-${h}`,o];case"$id":return[`filter-id-${h}`,o];default:return[`filter-${h}`,c,o]}}function ga(c,o){if(o.length===0)return!1;switch(c){case"$type":return["filter-type-in",["literal",o]];case"$id":return["filter-id-in",["literal",o]];default:return o.length>200&&!o.some((h=>typeof h!=typeof o[0]))?["filter-in-large",c,["literal",o.sort(Xp)]]:["filter-in-small",c,["literal",o]]}}function ma(c){switch(c){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",c]}}function pr(c){return["!",c]}function Un(c){const o=typeof c;if(o==="number"||o==="boolean"||o==="string"||c==null)return JSON.stringify(c);if(Array.isArray(c)){let _="[";for(const b of c)_+=`${Un(b)},`;return`${_}]`}const h=Object.keys(c).sort();let f="{";for(let _=0;_<h.length;_++)f+=`${JSON.stringify(h[_])}:${Un(c[h[_]])},`;return`${f}}`}function gd(c){let o="";for(const h of ns)o+=`/${Un(c[h])}`;return o}function md(c){const o=c.value;return o?[new st(c.key,o,"constants have been deprecated as of v8")]:[]}function Vi(c){return c instanceof Number||c instanceof String||c instanceof Boolean?c.valueOf():c}function Ts(c){if(Array.isArray(c))return c.map(Ts);if(c instanceof Object&&!(c instanceof Number||c instanceof String||c instanceof Boolean)){const o={};for(const h in c)o[h]=Ts(c[h]);return o}return Vi(c)}function Qr(c){const o=c.key,h=c.value,f=c.valueSpec||{},_=c.objectElementValidators||{},b=c.style,w=c.styleSpec,A=c.validateSpec;let I=[];const R=oi(h);if(R!=="object")return[new st(o,h,`object expected, ${R} found`)];for(const k in h){const F=k.split(".")[0],V=f[F]||f["*"];let j;if(_[F])j=_[F];else if(f[F])j=A;else if(_["*"])j=_["*"];else{if(!f["*"]){I.push(new st(o,h[k],`unknown property "${k}"`));continue}j=A}I=I.concat(j({key:(o&&`${o}.`)+k,value:h[k],valueSpec:V,style:b,styleSpec:w,object:h,objectKey:k,validateSpec:A},h))}for(const k in f)_[k]||f[k].required&&f[k].default===void 0&&h[k]===void 0&&I.push(new st(o,h,`missing required property "${k}"`));return I}function _a(c){const o=c.value,h=c.valueSpec,f=c.style,_=c.styleSpec,b=c.key,w=c.arrayElementValidator||c.validateSpec;if(oi(o)!=="array")return[new st(b,o,`array expected, ${oi(o)} found`)];if(h.length&&o.length!==h.length)return[new st(b,o,`array length ${h.length} expected, length ${o.length} found`)];if(h["min-length"]&&o.length<h["min-length"])return[new st(b,o,`array length at least ${h["min-length"]} expected, length ${o.length} found`)];let A={type:h.value,values:h.values};_.$version<7&&(A.function=h.function),oi(h.value)==="object"&&(A=h.value);let I=[];for(let R=0;R<o.length;R++)I=I.concat(w({array:o,arrayIndex:R,value:o[R],valueSpec:A,validateSpec:c.validateSpec,style:f,styleSpec:_,key:`${b}[${R}]`}));return I}function nu(c){const o=c.key,h=c.value,f=c.valueSpec;let _=oi(h);return _==="number"&&h!=h&&(_="NaN"),_!=="number"?[new st(o,h,`number expected, ${_} found`)]:"minimum"in f&&h<f.minimum?[new st(o,h,`${h} is less than the minimum value ${f.minimum}`)]:"maximum"in f&&h>f.maximum?[new st(o,h,`${h} is greater than the maximum value ${f.maximum}`)]:[]}function Tl(c){const o=c.valueSpec,h=Vi(c.value.type);let f,_,b,w={};const A=h!=="categorical"&&c.value.property===void 0,I=!A,R=oi(c.value.stops)==="array"&&oi(c.value.stops[0])==="array"&&oi(c.value.stops[0][0])==="object",k=Qr({key:c.key,value:c.value,valueSpec:c.styleSpec.function,validateSpec:c.validateSpec,style:c.style,styleSpec:c.styleSpec,objectElementValidators:{stops:function(j){if(h==="identity")return[new st(j.key,j.value,'identity function may not have a "stops" property')];let X=[];const Z=j.value;return X=X.concat(_a({key:j.key,value:Z,valueSpec:j.valueSpec,validateSpec:j.validateSpec,style:j.style,styleSpec:j.styleSpec,arrayElementValidator:F})),oi(Z)==="array"&&Z.length===0&&X.push(new st(j.key,Z,"array must have at least one stop")),X},default:function(j){return j.validateSpec({key:j.key,value:j.value,valueSpec:o,validateSpec:j.validateSpec,style:j.style,styleSpec:j.styleSpec})}}});return h==="identity"&&A&&k.push(new st(c.key,c.value,'missing required property "property"')),h==="identity"||c.value.stops||k.push(new st(c.key,c.value,'missing required property "stops"')),h==="exponential"&&c.valueSpec.expression&&!tu(c.valueSpec)&&k.push(new st(c.key,c.value,"exponential functions not supported")),c.styleSpec.$version>=8&&(I&&!go(c.valueSpec)?k.push(new st(c.key,c.value,"property functions not supported")):A&&!cd(c.valueSpec)&&k.push(new st(c.key,c.value,"zoom functions not supported"))),h!=="categorical"&&!R||c.value.property!==void 0||k.push(new st(c.key,c.value,'"property" property is required')),k;function F(j){let X=[];const Z=j.value,se=j.key;if(oi(Z)!=="array")return[new st(se,Z,`array expected, ${oi(Z)} found`)];if(Z.length!==2)return[new st(se,Z,`array length 2 expected, length ${Z.length} found`)];if(R){if(oi(Z[0])!=="object")return[new st(se,Z,`object expected, ${oi(Z[0])} found`)];if(Z[0].zoom===void 0)return[new st(se,Z,"object stop key must have zoom")];if(Z[0].value===void 0)return[new st(se,Z,"object stop key must have value")];if(b&&b>Vi(Z[0].zoom))return[new st(se,Z[0].zoom,"stop zoom values must appear in ascending order")];Vi(Z[0].zoom)!==b&&(b=Vi(Z[0].zoom),_=void 0,w={}),X=X.concat(Qr({key:`${se}[0]`,value:Z[0],valueSpec:{zoom:{}},validateSpec:j.validateSpec,style:j.style,styleSpec:j.styleSpec,objectElementValidators:{zoom:nu,value:V}}))}else X=X.concat(V({key:`${se}[0]`,value:Z[0],validateSpec:j.validateSpec,style:j.style,styleSpec:j.styleSpec},Z));return xl(Ts(Z[1]))?X.concat([new st(`${se}[1]`,Z[1],"expressions are not allowed in function stops.")]):X.concat(j.validateSpec({key:`${se}[1]`,value:Z[1],valueSpec:o,validateSpec:j.validateSpec,style:j.style,styleSpec:j.styleSpec}))}function V(j,X){const Z=oi(j.value),se=Vi(j.value),ue=j.value!==null?j.value:X;if(f){if(Z!==f)return[new st(j.key,ue,`${Z} stop domain type must match previous stop domain type ${f}`)]}else f=Z;if(Z!=="number"&&Z!=="string"&&Z!=="boolean")return[new st(j.key,ue,"stop domain value must be a number, string, or boolean")];if(Z!=="number"&&h!=="categorical"){let Me=`number expected, ${Z} found`;return go(o)&&h===void 0&&(Me+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new st(j.key,ue,Me)]}return h!=="categorical"||Z!=="number"||isFinite(se)&&Math.floor(se)===se?h!=="categorical"&&Z==="number"&&_!==void 0&&se<_?[new st(j.key,ue,"stop domain values must appear in ascending order")]:(_=se,h==="categorical"&&se in w?[new st(j.key,ue,"stop domain values must be unique")]:(w[se]=!0,[])):[new st(j.key,ue,`integer expected, found ${se}`)]}}function bo(c){const o=(c.expressionContext==="property"?iu:_o)(Ts(c.value),c.valueSpec);if(o.result==="error")return o.value.map((f=>new st(`${c.key}${f.key}`,c.value,f.message)));const h=o.value.expression||o.value._styleExpression.expression;if(c.expressionContext==="property"&&c.propertyKey==="text-font"&&!h.outputDefined())return[new st(c.key,c.value,`Invalid data expression for "${c.propertyKey}". Output values must be contained as literals within the expression.`)];if(c.expressionContext==="property"&&c.propertyType==="layout"&&!fo(h))return[new st(c.key,c.value,'"feature-state" data expressions are not supported with layout properties.')];if(c.expressionContext==="filter"&&!fo(h))return[new st(c.key,c.value,'"feature-state" data expressions are not supported with filters.')];if(c.expressionContext&&c.expressionContext.indexOf("cluster")===0){if(!fa(h,["zoom","feature-state"]))return[new st(c.key,c.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if(c.expressionContext==="cluster-initial"&&!da(h))return[new st(c.key,c.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function en(c){const o=c.key,h=c.value,f=c.valueSpec,_=[];return Array.isArray(f.values)?f.values.indexOf(Vi(h))===-1&&_.push(new st(o,h,`expected one of [${f.values.join(", ")}], ${JSON.stringify(h)} found`)):Object.keys(f.values).indexOf(Vi(h))===-1&&_.push(new st(o,h,`expected one of [${Object.keys(f.values).join(", ")}], ${JSON.stringify(h)} found`)),_}function ou(c){return vl(Ts(c.value))?bo(Xr({},c,{expressionContext:"filter",valueSpec:{value:"boolean"}})):Sl(c)}function Sl(c){const o=c.value,h=c.key;if(oi(o)!=="array")return[new st(h,o,`array expected, ${oi(o)} found`)];const f=c.styleSpec;let _,b=[];if(o.length<1)return[new st(h,o,"filter array must have at least 1 element")];switch(b=b.concat(en({key:`${h}[0]`,value:o[0],valueSpec:f.filter_operator,style:c.style,styleSpec:c.styleSpec})),Vi(o[0])){case"<":case"<=":case">":case">=":o.length>=2&&Vi(o[1])==="$type"&&b.push(new st(h,o,`"$type" cannot be use with operator "${o[0]}"`));case"==":case"!=":o.length!==3&&b.push(new st(h,o,`filter array for operator "${o[0]}" must have 3 elements`));case"in":case"!in":o.length>=2&&(_=oi(o[1]),_!=="string"&&b.push(new st(`${h}[1]`,o[1],`string expected, ${_} found`)));for(let w=2;w<o.length;w++)_=oi(o[w]),Vi(o[1])==="$type"?b=b.concat(en({key:`${h}[${w}]`,value:o[w],valueSpec:f.geometry_type,style:c.style,styleSpec:c.styleSpec})):_!=="string"&&_!=="number"&&_!=="boolean"&&b.push(new st(`${h}[${w}]`,o[w],`string, number, or boolean expected, ${_} found`));break;case"any":case"all":case"none":for(let w=1;w<o.length;w++)b=b.concat(Sl({key:`${h}[${w}]`,value:o[w],style:c.style,styleSpec:c.styleSpec}));break;case"has":case"!has":_=oi(o[1]),o.length!==2?b.push(new st(h,o,`filter array for "${o[0]}" operator must have 2 elements`)):_!=="string"&&b.push(new st(`${h}[1]`,o[1],`string expected, ${_} found`))}return b}function au(c,o){const h=c.key,f=c.validateSpec,_=c.style,b=c.styleSpec,w=c.value,A=c.objectKey,I=b[`${o}_${c.layerType}`];if(!I)return[];const R=A.match(/^(.*)-transition$/);if(o==="paint"&&R&&I[R[1]]&&I[R[1]].transition)return f({key:h,value:w,valueSpec:b.transition,style:_,styleSpec:b});const k=c.valueSpec||I[A];if(!k)return[new st(h,w,`unknown property "${A}"`)];let F;if(oi(w)==="string"&&go(k)&&!k.tokens&&(F=/^{([^}]+)}$/.exec(w)))return[new st(h,w,`"${A}" does not support interpolation syntax
Use an identity property function instead: \`{ "type": "identity", "property": ${JSON.stringify(F[1])} }\`.`)];const V=[];return c.layerType==="symbol"&&(A==="text-field"&&_&&!_.glyphs&&V.push(new st(h,w,'use of "text-field" requires a style "glyphs" property')),A==="text-font"&&ml(Ts(w))&&Vi(w.type)==="identity"&&V.push(new st(h,w,'"text-font" does not support identity functions'))),V.concat(f({key:c.key,value:w,valueSpec:k,style:_,styleSpec:b,expressionContext:"property",propertyType:o,propertyKey:A}))}function Al(c){return au(c,"paint")}function lu(c){return au(c,"layout")}function cu(c){let o=[];const h=c.value,f=c.key,_=c.style,b=c.styleSpec;h.type||h.ref||o.push(new st(f,h,'either "type" or "ref" is required'));let w=Vi(h.type);const A=Vi(h.ref);if(h.id){const I=Vi(h.id);for(let R=0;R<c.arrayIndex;R++){const k=_.layers[R];Vi(k.id)===I&&o.push(new st(f,h.id,`duplicate layer id "${h.id}", previously used at line ${k.id.__line__}`))}}if("ref"in h){let I;["type","source","source-layer","filter","layout"].forEach((R=>{R in h&&o.push(new st(f,h[R],`"${R}" is prohibited for ref layers`))})),_.layers.forEach((R=>{Vi(R.id)===A&&(I=R)})),I?I.ref?o.push(new st(f,h.ref,"ref cannot reference another ref layer")):w=Vi(I.type):o.push(new st(f,h.ref,`ref layer "${A}" not found`))}else if(w!=="background")if(h.source){const I=_.sources&&_.sources[h.source],R=I&&Vi(I.type);I?R==="vector"&&w==="raster"?o.push(new st(f,h.source,`layer "${h.id}" requires a raster source`)):R!=="raster-dem"&&w==="hillshade"?o.push(new st(f,h.source,`layer "${h.id}" requires a raster-dem source`)):R==="raster"&&w!=="raster"?o.push(new st(f,h.source,`layer "${h.id}" requires a vector source`)):R!=="vector"||h["source-layer"]?R==="raster-dem"&&w!=="hillshade"?o.push(new st(f,h.source,"raster-dem source can only be used with layer type 'hillshade'.")):w!=="line"||!h.paint||!h.paint["line-gradient"]||R==="geojson"&&I.lineMetrics||o.push(new st(f,h,`layer "${h.id}" specifies a line-gradient, which requires a GeoJSON source with \`lineMetrics\` enabled.`)):o.push(new st(f,h,`layer "${h.id}" must specify a "source-layer"`)):o.push(new st(f,h.source,`source "${h.source}" not found`))}else o.push(new st(f,h,'missing required property "source"'));return o=o.concat(Qr({key:f,value:h,valueSpec:b.layer,style:c.style,styleSpec:c.styleSpec,validateSpec:c.validateSpec,objectElementValidators:{"*":()=>[],type:()=>c.validateSpec({key:`${f}.type`,value:h.type,valueSpec:b.layer.type,style:c.style,styleSpec:c.styleSpec,validateSpec:c.validateSpec,object:h,objectKey:"type"}),filter:ou,layout:I=>Qr({layer:h,key:I.key,value:I.value,style:I.style,styleSpec:I.styleSpec,validateSpec:I.validateSpec,objectElementValidators:{"*":R=>lu(Xr({layerType:w},R))}}),paint:I=>Qr({layer:h,key:I.key,value:I.value,style:I.style,styleSpec:I.styleSpec,validateSpec:I.validateSpec,objectElementValidators:{"*":R=>Al(Xr({layerType:w},R))}})}})),o}function Vn(c){const o=c.value,h=c.key,f=oi(o);return f!=="string"?[new st(h,o,`string expected, ${f} found`)]:[]}const El={promoteId:function({key:c,value:o}){if(oi(o)==="string")return Vn({key:c,value:o});{const h=[];for(const f in o)h.push(...Vn({key:`${c}.${f}`,value:o[f]}));return h}}};function ya(c){const o=c.value,h=c.key,f=c.styleSpec,_=c.style,b=c.validateSpec;if(!o.type)return[new st(h,o,'"type" is required')];const w=Vi(o.type);let A;switch(w){case"vector":case"raster":return A=Qr({key:h,value:o,valueSpec:f[`source_${w.replace("-","_")}`],style:c.style,styleSpec:f,objectElementValidators:El,validateSpec:b}),A;case"raster-dem":return A=(function(I){var R;const k=(R=I.sourceName)!==null&&R!==void 0?R:"",F=I.value,V=I.styleSpec,j=V.source_raster_dem,X=I.style;let Z=[];const se=oi(F);if(F===void 0)return Z;if(se!=="object")return Z.push(new st("source_raster_dem",F,`object expected, ${se} found`)),Z;const ue=Vi(F.encoding)==="custom",Me=["redFactor","greenFactor","blueFactor","baseShift"],xe=I.value.encoding?`"${I.value.encoding}"`:"Default";for(const Ee in F)!ue&&Me.includes(Ee)?Z.push(new st(Ee,F[Ee],`In "${k}": "${Ee}" is only valid when "encoding" is set to "custom". ${xe} encoding found`)):j[Ee]?Z=Z.concat(I.validateSpec({key:Ee,value:F[Ee],valueSpec:j[Ee],validateSpec:I.validateSpec,style:X,styleSpec:V})):Z.push(new st(Ee,F[Ee],`unknown property "${Ee}"`));return Z})({sourceName:h,value:o,style:c.style,styleSpec:f,validateSpec:b}),A;case"geojson":if(A=Qr({key:h,value:o,valueSpec:f.source_geojson,style:_,styleSpec:f,validateSpec:b,objectElementValidators:El}),o.cluster)for(const I in o.clusterProperties){const[R,k]=o.clusterProperties[I],F=typeof R=="string"?[R,["accumulated"],["get",I]]:R;A.push(...bo({key:`${h}.${I}.map`,value:k,expressionContext:"cluster-map"})),A.push(...bo({key:`${h}.${I}.reduce`,value:F,expressionContext:"cluster-reduce"}))}return A;case"video":return Qr({key:h,value:o,valueSpec:f.source_video,style:_,validateSpec:b,styleSpec:f});case"image":return Qr({key:h,value:o,valueSpec:f.source_image,style:_,validateSpec:b,styleSpec:f});case"canvas":return[new st(h,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return en({key:`${h}.type`,value:o.type,valueSpec:{values:["vector","raster","raster-dem","geojson","video","image"]}})}}function uu(c){const o=c.value,h=c.styleSpec,f=h.light,_=c.style;let b=[];const w=oi(o);if(o===void 0)return b;if(w!=="object")return b=b.concat([new st("light",o,`object expected, ${w} found`)]),b;for(const A in o){const I=A.match(/^(.*)-transition$/);b=b.concat(I&&f[I[1]]&&f[I[1]].transition?c.validateSpec({key:A,value:o[A],valueSpec:h.transition,validateSpec:c.validateSpec,style:_,styleSpec:h}):f[A]?c.validateSpec({key:A,value:o[A],valueSpec:f[A],validateSpec:c.validateSpec,style:_,styleSpec:h}):[new st(A,o[A],`unknown property "${A}"`)])}return b}function hu(c){const o=c.value,h=c.styleSpec,f=h.sky,_=c.style,b=oi(o);if(o===void 0)return[];if(b!=="object")return[new st("sky",o,`object expected, ${b} found`)];let w=[];for(const A in o)w=w.concat(f[A]?c.validateSpec({key:A,value:o[A],valueSpec:f[A],style:_,styleSpec:h}):[new st(A,o[A],`unknown property "${A}"`)]);return w}function du(c){const o=c.value,h=c.styleSpec,f=h.terrain,_=c.style;let b=[];const w=oi(o);if(o===void 0)return b;if(w!=="object")return b=b.concat([new st("terrain",o,`object expected, ${w} found`)]),b;for(const A in o)b=b.concat(f[A]?c.validateSpec({key:A,value:o[A],valueSpec:f[A],validateSpec:c.validateSpec,style:_,styleSpec:h}):[new st(A,o[A],`unknown property "${A}"`)]);return b}function fu(c){let o=[];const h=c.value,f=c.key;if(Array.isArray(h)){const _=[],b=[];for(const w in h)h[w].id&&_.includes(h[w].id)&&o.push(new st(f,h,`all the sprites' ids must be unique, but ${h[w].id} is duplicated`)),_.push(h[w].id),h[w].url&&b.includes(h[w].url)&&o.push(new st(f,h,`all the sprites' URLs must be unique, but ${h[w].url} is duplicated`)),b.push(h[w].url),o=o.concat(Qr({key:`${f}[${w}]`,value:h[w],valueSpec:{id:{type:"string",required:!0},url:{type:"string",required:!0}},validateSpec:c.validateSpec}));return o}return Vn({key:f,value:h})}const Il={"*":()=>[],array:_a,boolean:function(c){const o=c.value,h=c.key,f=oi(o);return f!=="boolean"?[new st(h,o,`boolean expected, ${f} found`)]:[]},number:nu,color:function(c){const o=c.key,h=c.value,f=oi(h);return f!=="string"?[new st(o,h,`color expected, ${f} found`)]:di.parse(String(h))?[]:[new st(o,h,`color expected, "${h}" found`)]},constants:md,enum:en,filter:ou,function:Tl,layer:cu,object:Qr,source:ya,light:uu,sky:hu,terrain:du,projection:function(c){const o=c.value,h=c.styleSpec,f=h.projection,_=c.style,b=oi(o);if(o===void 0)return[];if(b!=="object")return[new st("projection",o,`object expected, ${b} found`)];let w=[];for(const A in o)w=w.concat(f[A]?c.validateSpec({key:A,value:o[A],valueSpec:f[A],style:_,styleSpec:h}):[new st(A,o[A],`unknown property "${A}"`)]);return w},string:Vn,formatted:function(c){return Vn(c).length===0?[]:bo(c)},resolvedImage:function(c){return Vn(c).length===0?[]:bo(c)},padding:function(c){const o=c.key,h=c.value;if(oi(h)==="array"){if(h.length<1||h.length>4)return[new st(o,h,`padding requires 1 to 4 values; ${h.length} values found`)];const f={type:"number"};let _=[];for(let b=0;b<h.length;b++)_=_.concat(c.validateSpec({key:`${o}[${b}]`,value:h[b],validateSpec:c.validateSpec,valueSpec:f}));return _}return nu({key:o,value:h,valueSpec:{}})},variableAnchorOffsetCollection:function(c){const o=c.key,h=c.value,f=oi(h),_=c.styleSpec;if(f!=="array"||h.length<1||h.length%2!=0)return[new st(o,h,"variableAnchorOffsetCollection requires a non-empty array of even length")];let b=[];for(let w=0;w<h.length;w+=2)b=b.concat(en({key:`${o}[${w}]`,value:h[w],valueSpec:_.layout_symbol["text-anchor"]})),b=b.concat(_a({key:`${o}[${w+1}]`,value:h[w+1],valueSpec:{length:2,value:"number"},validateSpec:c.validateSpec,style:c.style,styleSpec:_}));return b},sprite:fu};function xa(c){const o=c.value,h=c.valueSpec,f=c.styleSpec;return c.validateSpec=xa,h.expression&&ml(Vi(o))?Tl(c):h.expression&&xl(Ts(o))?bo(c):h.type&&Il[h.type]?Il[h.type](c):Qr(Xr({},c,{valueSpec:h.type?f[h.type]:h}))}function _d(c){const o=c.value,h=c.key,f=Vn(c);return f.length||(o.indexOf("{fontstack}")===-1&&f.push(new st(h,o,'"glyphs" url must include a "{fontstack}" token')),o.indexOf("{range}")===-1&&f.push(new st(h,o,'"glyphs" url must include a "{range}" token'))),f}function us(c,o=Ce){let h=[];return h=h.concat(xa({key:"",value:c,valueSpec:o.$root,styleSpec:o,style:c,validateSpec:xa,objectElementValidators:{glyphs:_d,"*":()=>[]}})),c.constants&&(h=h.concat(md({key:"constants",value:c.constants}))),pu(h)}function js(c){return function(o){return c({...o,validateSpec:xa})}}function pu(c){return[].concat(c).sort(((o,h)=>o.line-h.line))}function Ss(c){return function(...o){return pu(c.apply(this,o))}}us.source=Ss(js(ya)),us.sprite=Ss(js(fu)),us.glyphs=Ss(js(_d)),us.light=Ss(js(uu)),us.sky=Ss(js(hu)),us.terrain=Ss(js(du)),us.layer=Ss(js(cu)),us.filter=Ss(js(ou)),us.paintProperty=Ss(js(Al)),us.layoutProperty=Ss(js(lu));const jn=us,Zp=jn.light,Yp=jn.sky,yd=jn.paintProperty,xd=jn.layoutProperty;function gu(c,o){let h=!1;if(o&&o.length)for(const f of o)c.fire(new Fi(new Error(f.message))),h=!0;return h}class wo{constructor(o,h,f){const _=this.cells=[];if(o instanceof ArrayBuffer){this.arrayBuffer=o;const w=new Int32Array(this.arrayBuffer);o=w[0],this.d=(h=w[1])+2*(f=w[2]);for(let I=0;I<this.d*this.d;I++){const R=w[3+I],k=w[3+I+1];_.push(R===k?null:w.subarray(R,k))}const A=w[3+_.length+1];this.keys=w.subarray(w[3+_.length],A),this.bboxes=w.subarray(A),this.insert=this._insertReadonly}else{this.d=h+2*f;for(let w=0;w<this.d*this.d;w++)_.push([]);this.keys=[],this.bboxes=[]}this.n=h,this.extent=o,this.padding=f,this.scale=h/o,this.uid=0;const b=f/h*o;this.min=-b,this.max=o+b}insert(o,h,f,_,b){this._forEachCell(h,f,_,b,this._insertCell,this.uid++,void 0,void 0),this.keys.push(o),this.bboxes.push(h),this.bboxes.push(f),this.bboxes.push(_),this.bboxes.push(b)}_insertReadonly(){throw new Error("Cannot insert into a GridIndex created from an ArrayBuffer.")}_insertCell(o,h,f,_,b,w){this.cells[b].push(w)}query(o,h,f,_,b){const w=this.min,A=this.max;if(o<=w&&h<=w&&A<=f&&A<=_&&!b)return Array.prototype.slice.call(this.keys);{const I=[];return this._forEachCell(o,h,f,_,this._queryCell,I,{},b),I}}_queryCell(o,h,f,_,b,w,A,I){const R=this.cells[b];if(R!==null){const k=this.keys,F=this.bboxes;for(let V=0;V<R.length;V++){const j=R[V];if(A[j]===void 0){const X=4*j;(I?I(F[X+0],F[X+1],F[X+2],F[X+3]):o<=F[X+2]&&h<=F[X+3]&&f>=F[X+0]&&_>=F[X+1])?(A[j]=!0,w.push(k[j])):A[j]=!1}}}}_forEachCell(o,h,f,_,b,w,A,I){const R=this._convertToCellCoord(o),k=this._convertToCellCoord(h),F=this._convertToCellCoord(f),V=this._convertToCellCoord(_);for(let j=R;j<=F;j++)for(let X=k;X<=V;X++){const Z=this.d*X+j;if((!I||I(this._convertFromCellCoord(j),this._convertFromCellCoord(X),this._convertFromCellCoord(j+1),this._convertFromCellCoord(X+1)))&&b.call(this,o,h,f,_,Z,w,A,I))return}}_convertFromCellCoord(o){return(o-this.padding)/this.scale}_convertToCellCoord(o){return Math.max(0,Math.min(this.d-1,Math.floor(o*this.scale)+this.padding))}toArrayBuffer(){if(this.arrayBuffer)return this.arrayBuffer;const o=this.cells,h=3+this.cells.length+1+1;let f=0;for(let w=0;w<this.cells.length;w++)f+=this.cells[w].length;const _=new Int32Array(h+f+this.keys.length+this.bboxes.length);_[0]=this.extent,_[1]=this.n,_[2]=this.padding;let b=h;for(let w=0;w<o.length;w++){const A=o[w];_[3+w]=b,_.set(A,b),b+=A.length}return _[3+o.length]=b,_.set(this.keys,b),b+=this.keys.length,_[3+o.length+1]=b,_.set(this.bboxes,b),b+=this.bboxes.length,_.buffer}static serialize(o,h){const f=o.toArrayBuffer();return h&&h.push(f),{buffer:f}}static deserialize(o){return new wo(o.buffer)}}const hs={};function vt(c,o,h={}){if(hs[c])throw new Error(`${c} is already registered.`);Object.defineProperty(o,"_classRegistryKey",{value:c,writeable:!1}),hs[c]={klass:o,omit:h.omit||[],shallow:h.shallow||[]}}vt("Object",Object),vt("TransferableGridIndex",wo),vt("Color",di),vt("Error",Error),vt("AJAXError",kt),vt("ResolvedImage",Jr),vt("StylePropertyFunction",vo),vt("StyleExpression",yl,{omit:["_evaluator"]}),vt("ZoomDependentExpression",xo),vt("ZoomConstantExpression",yo),vt("CompoundExpression",cs,{omit:["_evaluate"]});for(const c in ho)ho[c]._classRegistryKey||vt(`Expression_${c}`,ho[c]);function Cl(c){return c&&typeof ArrayBuffer<"u"&&(c instanceof ArrayBuffer||c.constructor&&c.constructor.name==="ArrayBuffer")}function mu(c){return c.$name||c.constructor._classRegistryKey}function vd(c){return!(function(o){if(o===null||typeof o!="object")return!1;const h=mu(o);return!(!h||h==="Object")})(c)&&(c==null||typeof c=="boolean"||typeof c=="number"||typeof c=="string"||c instanceof Boolean||c instanceof Number||c instanceof String||c instanceof Date||c instanceof RegExp||c instanceof Blob||c instanceof Error||Cl(c)||ge(c)||ArrayBuffer.isView(c)||c instanceof ImageData)}function To(c,o){if(vd(c))return(Cl(c)||ge(c))&&o&&o.push(c),ArrayBuffer.isView(c)&&o&&o.push(c.buffer),c instanceof ImageData&&o&&o.push(c.data.buffer),c;if(Array.isArray(c)){const b=[];for(const w of c)b.push(To(w,o));return b}if(typeof c!="object")throw new Error("can't serialize object of type "+typeof c);const h=mu(c);if(!h)throw new Error(`can't serialize object of unregistered class ${c.constructor.name}`);if(!hs[h])throw new Error(`${h} is not registered.`);const{klass:f}=hs[h],_=f.serialize?f.serialize(c,o):{};if(f.serialize){if(o&&_===o[o.length-1])throw new Error("statically serialized object won't survive transfer of $name property")}else{for(const b in c){if(!c.hasOwnProperty(b)||hs[h].omit.indexOf(b)>=0)continue;const w=c[b];_[b]=hs[h].shallow.indexOf(b)>=0?w:To(w,o)}c instanceof Error&&(_.message=c.message)}if(_.$name)throw new Error("$name property is reserved for worker serialization logic.");return h!=="Object"&&(_.$name=h),_}function So(c){if(vd(c))return c;if(Array.isArray(c))return c.map(So);if(typeof c!="object")throw new Error("can't deserialize object of type "+typeof c);const o=mu(c)||"Object";if(!hs[o])throw new Error(`can't deserialize unregistered class ${o}`);const{klass:h}=hs[o];if(!h)throw new Error(`can't deserialize unregistered class ${o}`);if(h.deserialize)return h.deserialize(c);const f=Object.create(h.prototype);for(const _ of Object.keys(c)){if(_==="$name")continue;const b=c[_];f[_]=hs[o].shallow.indexOf(_)>=0?b:So(b)}return f}class _u{constructor(){this.first=!0}update(o,h){const f=Math.floor(o);return this.first?(this.first=!1,this.lastIntegerZoom=f,this.lastIntegerZoomTime=0,this.lastZoom=o,this.lastFloorZoom=f,!0):(this.lastFloorZoom>f?(this.lastIntegerZoom=f+1,this.lastIntegerZoomTime=h):this.lastFloorZoom<f&&(this.lastIntegerZoom=f,this.lastIntegerZoomTime=h),o!==this.lastZoom&&(this.lastZoom=o,this.lastFloorZoom=f,!0))}}const ei={"Latin-1 Supplement":c=>c>=128&&c<=255,"Hangul Jamo":c=>c>=4352&&c<=4607,Khmer:c=>c>=6016&&c<=6143,"General Punctuation":c=>c>=8192&&c<=8303,"Letterlike Symbols":c=>c>=8448&&c<=8527,"Number Forms":c=>c>=8528&&c<=8591,"Miscellaneous Technical":c=>c>=8960&&c<=9215,"Control Pictures":c=>c>=9216&&c<=9279,"Optical Character Recognition":c=>c>=9280&&c<=9311,"Enclosed Alphanumerics":c=>c>=9312&&c<=9471,"Geometric Shapes":c=>c>=9632&&c<=9727,"Miscellaneous Symbols":c=>c>=9728&&c<=9983,"Miscellaneous Symbols and Arrows":c=>c>=11008&&c<=11263,"Ideographic Description Characters":c=>c>=12272&&c<=12287,"CJK Symbols and Punctuation":c=>c>=12288&&c<=12351,Katakana:c=>c>=12448&&c<=12543,Kanbun:c=>c>=12688&&c<=12703,"CJK Strokes":c=>c>=12736&&c<=12783,"Enclosed CJK Letters and Months":c=>c>=12800&&c<=13055,"CJK Compatibility":c=>c>=13056&&c<=13311,"Yijing Hexagram Symbols":c=>c>=19904&&c<=19967,"Private Use Area":c=>c>=57344&&c<=63743,"Vertical Forms":c=>c>=65040&&c<=65055,"CJK Compatibility Forms":c=>c>=65072&&c<=65103,"Small Form Variants":c=>c>=65104&&c<=65135,"Halfwidth and Fullwidth Forms":c=>c>=65280&&c<=65519};function yu(c){for(const o of c)if(vu(o.charCodeAt(0)))return!0;return!1}function Gp(c){for(const o of c)if(!Ao(o.charCodeAt(0)))return!1;return!0}function xu(c){const o=c.map((h=>{try{return new RegExp(`\\p{sc=${h}}`,"u").source}catch{return null}})).filter((h=>h));return new RegExp(o.join("|"),"u")}const Kp=xu(["Arab","Dupl","Mong","Ougr","Syrc"]);function Ao(c){return!Kp.test(String.fromCodePoint(c))}const bd=xu(["Bopo","Hani","Hira","Kana","Kits","Nshu","Tang","Yiii"]);function vu(c){return!(c!==746&&c!==747&&(c<4352||!(ei["CJK Compatibility Forms"](c)&&!(c>=65097&&c<=65103)||ei["CJK Compatibility"](c)||ei["CJK Strokes"](c)||!(!ei["CJK Symbols and Punctuation"](c)||c>=12296&&c<=12305||c>=12308&&c<=12319||c===12336)||ei["Enclosed CJK Letters and Months"](c)||ei["Ideographic Description Characters"](c)||ei.Kanbun(c)||ei.Katakana(c)&&c!==12540||!(!ei["Halfwidth and Fullwidth Forms"](c)||c===65288||c===65289||c===65293||c>=65306&&c<=65310||c===65339||c===65341||c===65343||c>=65371&&c<=65503||c===65507||c>=65512&&c<=65519)||!(!ei["Small Form Variants"](c)||c>=65112&&c<=65118||c>=65123&&c<=65126)||ei["Vertical Forms"](c)||ei["Yijing Hexagram Symbols"](c)||/\p{sc=Cans}/u.test(String.fromCodePoint(c))||/\p{sc=Hang}/u.test(String.fromCodePoint(c))||bd.test(String.fromCodePoint(c)))))}function wd(c){return!(vu(c)||(function(o){return!!(ei["Latin-1 Supplement"](o)&&(o===167||o===169||o===174||o===177||o===188||o===189||o===190||o===215||o===247)||ei["General Punctuation"](o)&&(o===8214||o===8224||o===8225||o===8240||o===8241||o===8251||o===8252||o===8258||o===8263||o===8264||o===8265||o===8273)||ei["Letterlike Symbols"](o)||ei["Number Forms"](o)||ei["Miscellaneous Technical"](o)&&(o>=8960&&o<=8967||o>=8972&&o<=8991||o>=8996&&o<=9e3||o===9003||o>=9085&&o<=9114||o>=9150&&o<=9165||o===9167||o>=9169&&o<=9179||o>=9186&&o<=9215)||ei["Control Pictures"](o)&&o!==9251||ei["Optical Character Recognition"](o)||ei["Enclosed Alphanumerics"](o)||ei["Geometric Shapes"](o)||ei["Miscellaneous Symbols"](o)&&!(o>=9754&&o<=9759)||ei["Miscellaneous Symbols and Arrows"](o)&&(o>=11026&&o<=11055||o>=11088&&o<=11097||o>=11192&&o<=11243)||ei["CJK Symbols and Punctuation"](o)||ei.Katakana(o)||ei["Private Use Area"](o)||ei["CJK Compatibility Forms"](o)||ei["Small Form Variants"](o)||ei["Halfwidth and Fullwidth Forms"](o)||o===8734||o===8756||o===8757||o>=9984&&o<=10087||o>=10102&&o<=10131||o===65532||o===65533)})(c))}const Jp=xu(["Adlm","Arab","Armi","Avst","Chrs","Cprt","Egyp","Elym","Gara","Hatr","Hebr","Hung","Khar","Lydi","Mand","Mani","Mend","Merc","Mero","Narb","Nbat","Nkoo","Orkh","Palm","Phli","Phlp","Phnx","Prti","Rohg","Samr","Sarb","Sogo","Syrc","Thaa","Todr","Yezi"]);function bu(c){return Jp.test(String.fromCodePoint(c))}function Qp(c,o){return!(!o&&bu(c)||c>=2304&&c<=3583||c>=3840&&c<=4255||ei.Khmer(c))}function eg(c){for(const o of c)if(bu(o.charCodeAt(0)))return!0;return!1}const es=new class{constructor(){this.applyArabicShaping=null,this.processBidirectionalText=null,this.processStyledBidirectionalText=null,this.pluginStatus="unavailable",this.pluginURL=null}setState(c){this.pluginStatus=c.pluginStatus,this.pluginURL=c.pluginURL}getState(){return{pluginStatus:this.pluginStatus,pluginURL:this.pluginURL}}setMethods(c){this.applyArabicShaping=c.applyArabicShaping,this.processBidirectionalText=c.processBidirectionalText,this.processStyledBidirectionalText=c.processStyledBidirectionalText}isParsed(){return this.applyArabicShaping!=null&&this.processBidirectionalText!=null&&this.processStyledBidirectionalText!=null}getPluginURL(){return this.pluginURL}getRTLTextPluginStatus(){return this.pluginStatus}};class Ti{constructor(o,h){this.zoom=o,h?(this.now=h.now,this.fadeDuration=h.fadeDuration,this.zoomHistory=h.zoomHistory,this.transition=h.transition):(this.now=0,this.fadeDuration=0,this.zoomHistory=new _u,this.transition={})}isSupportedScript(o){return(function(h,f){for(const _ of h)if(!Qp(_.charCodeAt(0),f))return!1;return!0})(o,es.getRTLTextPluginStatus()==="loaded")}crossFadingFactor(){return this.fadeDuration===0?1:Math.min((this.now-this.zoomHistory.lastIntegerZoomTime)/this.fadeDuration,1)}getCrossfadeParameters(){const o=this.zoom,h=o-Math.floor(o),f=this.crossFadingFactor();return o>this.zoomHistory.lastIntegerZoom?{fromScale:2,toScale:1,t:h+(1-h)*f}:{fromScale:.5,toScale:1,t:1-(1-f)*h}}}class Eo{constructor(o,h){this.property=o,this.value=h,this.expression=(function(f,_){if(ml(f))return new vo(f,_);if(xl(f)){const b=iu(f,_);if(b.result==="error")throw new Error(b.value.map((w=>`${w.key}: ${w.message}`)).join(", "));return b.value}{let b=f;return _.type==="color"&&typeof f=="string"?b=di.parse(f):_.type!=="padding"||typeof f!="number"&&!Array.isArray(f)?_.type==="variableAnchorOffsetCollection"&&Array.isArray(f)&&(b=ls.parse(f)):b=Kr.parse(f),{kind:"constant",evaluate:()=>b}}})(h===void 0?o.specification.default:h,o.specification)}isDataDriven(){return this.expression.kind==="source"||this.expression.kind==="composite"}possiblyEvaluate(o,h,f){return this.property.possiblyEvaluate(this,o,h,f)}}class Pl{constructor(o){this.property=o,this.value=new Eo(o,void 0)}transitioned(o,h){return new Td(this.property,this.value,h,Je({},o.transition,this.transition),o.now)}untransitioned(){return new Td(this.property,this.value,null,{},0)}}class Ml{constructor(o){this._properties=o,this._values=Object.create(o.defaultTransitionablePropertyValues)}getValue(o){return Ye(this._values[o].value.value)}setValue(o,h){Object.prototype.hasOwnProperty.call(this._values,o)||(this._values[o]=new Pl(this._values[o].property)),this._values[o].value=new Eo(this._values[o].property,h===null?void 0:Ye(h))}getTransition(o){return Ye(this._values[o].transition)}setTransition(o,h){Object.prototype.hasOwnProperty.call(this._values,o)||(this._values[o]=new Pl(this._values[o].property)),this._values[o].transition=Ye(h)||void 0}serialize(){const o={};for(const h of Object.keys(this._values)){const f=this.getValue(h);f!==void 0&&(o[h]=f);const _=this.getTransition(h);_!==void 0&&(o[`${h}-transition`]=_)}return o}transitioned(o,h){const f=new va(this._properties);for(const _ of Object.keys(this._values))f._values[_]=this._values[_].transitioned(o,h._values[_]);return f}untransitioned(){const o=new va(this._properties);for(const h of Object.keys(this._values))o._values[h]=this._values[h].untransitioned();return o}}class Td{constructor(o,h,f,_,b){this.property=o,this.value=h,this.begin=b+_.delay||0,this.end=this.begin+_.duration||0,o.specification.transition&&(_.delay||_.duration)&&(this.prior=f)}possiblyEvaluate(o,h,f){const _=o.now||0,b=this.value.possiblyEvaluate(o,h,f),w=this.prior;if(w){if(_>this.end)return this.prior=null,b;if(this.value.isDataDriven())return this.prior=null,b;if(_<this.begin)return w.possiblyEvaluate(o,h,f);{const A=(_-this.begin)/(this.end-this.begin);return this.property.interpolate(w.possiblyEvaluate(o,h,f),b,(function(I){if(I<=0)return 0;if(I>=1)return 1;const R=I*I,k=R*I;return 4*(I<.5?k:3*(I-R)+k-.75)})(A))}}return b}}class va{constructor(o){this._properties=o,this._values=Object.create(o.defaultTransitioningPropertyValues)}possiblyEvaluate(o,h,f){const _=new wa(this._properties);for(const b of Object.keys(this._values))_._values[b]=this._values[b].possiblyEvaluate(o,h,f);return _}hasTransition(){for(const o of Object.keys(this._values))if(this._values[o].prior)return!0;return!1}}class ba{constructor(o){this._properties=o,this._values=Object.create(o.defaultPropertyValues)}hasValue(o){return this._values[o].value!==void 0}getValue(o){return Ye(this._values[o].value)}setValue(o,h){this._values[o]=new Eo(this._values[o].property,h===null?void 0:Ye(h))}serialize(){const o={};for(const h of Object.keys(this._values)){const f=this.getValue(h);f!==void 0&&(o[h]=f)}return o}possiblyEvaluate(o,h,f){const _=new wa(this._properties);for(const b of Object.keys(this._values))_._values[b]=this._values[b].possiblyEvaluate(o,h,f);return _}}class $s{constructor(o,h,f){this.property=o,this.value=h,this.parameters=f}isConstant(){return this.value.kind==="constant"}constantOr(o){return this.value.kind==="constant"?this.value.value:o}evaluate(o,h,f,_){return this.property.evaluate(this.value,this.parameters,o,h,f,_)}}class wa{constructor(o){this._properties=o,this._values=Object.create(o.defaultPossiblyEvaluatedValues)}get(o){return this._values[o]}}class St{constructor(o){this.specification=o}possiblyEvaluate(o,h){if(o.isDataDriven())throw new Error("Value should not be data driven");return o.expression.evaluate(h)}interpolate(o,h,f){const _=Or[this.specification.type];return _?_(o,h,f):o}}class Ft{constructor(o,h){this.specification=o,this.overrides=h}possiblyEvaluate(o,h,f,_){return new $s(this,o.expression.kind==="constant"||o.expression.kind==="camera"?{kind:"constant",value:o.expression.evaluate(h,null,{},f,_)}:o.expression,h)}interpolate(o,h,f){if(o.value.kind!=="constant"||h.value.kind!=="constant")return o;if(o.value.value===void 0||h.value.value===void 0)return new $s(this,{kind:"constant",value:void 0},o.parameters);const _=Or[this.specification.type];if(_){const b=_(o.value.value,h.value.value,f);return new $s(this,{kind:"constant",value:b},o.parameters)}return o}evaluate(o,h,f,_,b,w){return o.kind==="constant"?o.value:o.evaluate(h,f,_,b,w)}}class Rl extends Ft{possiblyEvaluate(o,h,f,_){if(o.value===void 0)return new $s(this,{kind:"constant",value:void 0},h);if(o.expression.kind==="constant"){const b=o.expression.evaluate(h,null,{},f,_),w=o.property.specification.type==="resolvedImage"&&typeof b!="string"?b.name:b,A=this._calculate(w,w,w,h);return new $s(this,{kind:"constant",value:A},h)}if(o.expression.kind==="camera"){const b=this._calculate(o.expression.evaluate({zoom:h.zoom-1}),o.expression.evaluate({zoom:h.zoom}),o.expression.evaluate({zoom:h.zoom+1}),h);return new $s(this,{kind:"constant",value:b},h)}return new $s(this,o.expression,h)}evaluate(o,h,f,_,b,w){if(o.kind==="source"){const A=o.evaluate(h,f,_,b,w);return this._calculate(A,A,A,h)}return o.kind==="composite"?this._calculate(o.evaluate({zoom:Math.floor(h.zoom)-1},f,_),o.evaluate({zoom:Math.floor(h.zoom)},f,_),o.evaluate({zoom:Math.floor(h.zoom)+1},f,_),h):o.value}_calculate(o,h,f,_){return _.zoom>_.zoomHistory.lastIntegerZoom?{from:o,to:h}:{from:f,to:h}}interpolate(o){return o}}class kl{constructor(o){this.specification=o}possiblyEvaluate(o,h,f,_){if(o.value!==void 0){if(o.expression.kind==="constant"){const b=o.expression.evaluate(h,null,{},f,_);return this._calculate(b,b,b,h)}return this._calculate(o.expression.evaluate(new Ti(Math.floor(h.zoom-1),h)),o.expression.evaluate(new Ti(Math.floor(h.zoom),h)),o.expression.evaluate(new Ti(Math.floor(h.zoom+1),h)),h)}}_calculate(o,h,f,_){return _.zoom>_.zoomHistory.lastIntegerZoom?{from:o,to:h}:{from:f,to:h}}interpolate(o){return o}}class wu{constructor(o){this.specification=o}possiblyEvaluate(o,h,f,_){return!!o.expression.evaluate(h,null,{},f,_)}interpolate(){return!1}}class x{constructor(o){this.properties=o,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];for(const h in o){const f=o[h];f.specification.overridable&&this.overridableProperties.push(h);const _=this.defaultPropertyValues[h]=new Eo(f,void 0),b=this.defaultTransitionablePropertyValues[h]=new Pl(f);this.defaultTransitioningPropertyValues[h]=b.untransitioned(),this.defaultPossiblyEvaluatedValues[h]=_.possiblyEvaluate({})}}}vt("DataDrivenProperty",Ft),vt("DataConstantProperty",St),vt("CrossFadedDataDrivenProperty",Rl),vt("CrossFadedProperty",kl),vt("ColorRampProperty",wu);const n="-transition";class d extends Lt{constructor(o,h){if(super(),this.id=o.id,this.type=o.type,this._featureFilter={filter:()=>!0,needGeometry:!1},o.type!=="custom"&&(this.metadata=o.metadata,this.minzoom=o.minzoom,this.maxzoom=o.maxzoom,o.type!=="background"&&(this.source=o.source,this.sourceLayer=o["source-layer"],this.filter=o.filter),h.layout&&(this._unevaluatedLayout=new ba(h.layout)),h.paint)){this._transitionablePaint=new Ml(h.paint);for(const f in o.paint)this.setPaintProperty(f,o.paint[f],{validate:!1});for(const f in o.layout)this.setLayoutProperty(f,o.layout[f],{validate:!1});this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new wa(h.paint)}}getCrossfadeParameters(){return this._crossfadeParameters}getLayoutProperty(o){return o==="visibility"?this.visibility:this._unevaluatedLayout.getValue(o)}setLayoutProperty(o,h,f={}){h!=null&&this._validate(xd,`layers.${this.id}.layout.${o}`,o,h,f)||(o!=="visibility"?this._unevaluatedLayout.setValue(o,h):this.visibility=h)}getPaintProperty(o){return o.endsWith(n)?this._transitionablePaint.getTransition(o.slice(0,-11)):this._transitionablePaint.getValue(o)}setPaintProperty(o,h,f={}){if(h!=null&&this._validate(yd,`layers.${this.id}.paint.${o}`,o,h,f))return!1;if(o.endsWith(n))return this._transitionablePaint.setTransition(o.slice(0,-11),h||void 0),!1;{const _=this._transitionablePaint._values[o],b=_.property.specification["property-type"]==="cross-faded-data-driven",w=_.value.isDataDriven(),A=_.value;this._transitionablePaint.setValue(o,h),this._handleSpecialPaintPropertyUpdate(o);const I=this._transitionablePaint._values[o].value;return I.isDataDriven()||w||b||this._handleOverridablePaintPropertyUpdate(o,A,I)}}_handleSpecialPaintPropertyUpdate(o){}_handleOverridablePaintPropertyUpdate(o,h,f){return!1}isHidden(o){return!!(this.minzoom&&o<this.minzoom)||!!(this.maxzoom&&o>=this.maxzoom)||this.visibility==="none"}updateTransitions(o){this._transitioningPaint=this._transitionablePaint.transitioned(o,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(o,h){o.getCrossfadeParameters&&(this._crossfadeParameters=o.getCrossfadeParameters()),this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(o,void 0,h)),this.paint=this._transitioningPaint.possiblyEvaluate(o,void 0,h)}serialize(){const o={id:this.id,type:this.type,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()};return this.visibility&&(o.layout=o.layout||{},o.layout.visibility=this.visibility),ht(o,((h,f)=>!(h===void 0||f==="layout"&&!Object.keys(h).length||f==="paint"&&!Object.keys(h).length)))}_validate(o,h,f,_,b={}){return(!b||b.validate!==!1)&&gu(this,o.call(jn,{key:h,layerType:this.type,objectKey:f,value:_,styleSpec:Ce,style:{glyphs:!0,sprite:!0}}))}is3D(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}resize(){}isStateDependent(){for(const o in this.paint._values){const h=this.paint.get(o);if(h instanceof $s&&go(h.property.specification)&&(h.value.kind==="source"||h.value.kind==="composite")&&h.value.isStateDependent)return!0}return!1}}const p={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class m{constructor(o,h){this._structArray=o,this._pos1=h*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class y{constructor(){this.isTransferred=!1,this.capacity=-1,this.resize(0)}static serialize(o,h){return o._trim(),h&&(o.isTransferred=!0,h.push(o.arrayBuffer)),{length:o.length,arrayBuffer:o.arrayBuffer}}static deserialize(o){const h=Object.create(this.prototype);return h.arrayBuffer=o.arrayBuffer,h.length=o.length,h.capacity=o.arrayBuffer.byteLength/h.bytesPerElement,h._refreshViews(),h}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(o){this.reserve(o),this.length=o}reserve(o){if(o>this.capacity){this.capacity=Math.max(o,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const h=this.uint8;this._refreshViews(),h&&this.uint8.set(h)}}_refreshViews(){throw new Error("_refreshViews() must be implemented by each concrete StructArray layout")}}function E(c,o=1){let h=0,f=0;return{members:c.map((_=>{const b=p[_.type].BYTES_PER_ELEMENT,w=h=C(h,Math.max(o,b)),A=_.components||1;return f=Math.max(f,b),h+=b*A,{name:_.name,type:_.type,components:A,offset:w}})),size:C(h,Math.max(f,o)),alignment:o}}function C(c,o){return Math.ceil(c/o)*o}class M extends y{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(o,h){const f=this.length;return this.resize(f+1),this.emplace(f,o,h)}emplace(o,h,f){const _=2*o;return this.int16[_+0]=h,this.int16[_+1]=f,o}}M.prototype.bytesPerElement=4,vt("StructArrayLayout2i4",M);class D extends y{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(o,h,f){const _=this.length;return this.resize(_+1),this.emplace(_,o,h,f)}emplace(o,h,f,_){const b=3*o;return this.int16[b+0]=h,this.int16[b+1]=f,this.int16[b+2]=_,o}}D.prototype.bytesPerElement=6,vt("StructArrayLayout3i6",D);class N extends y{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(o,h,f,_){const b=this.length;return this.resize(b+1),this.emplace(b,o,h,f,_)}emplace(o,h,f,_,b){const w=4*o;return this.int16[w+0]=h,this.int16[w+1]=f,this.int16[w+2]=_,this.int16[w+3]=b,o}}N.prototype.bytesPerElement=8,vt("StructArrayLayout4i8",N);class z extends y{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(o,h,f,_,b,w){const A=this.length;return this.resize(A+1),this.emplace(A,o,h,f,_,b,w)}emplace(o,h,f,_,b,w,A){const I=6*o;return this.int16[I+0]=h,this.int16[I+1]=f,this.int16[I+2]=_,this.int16[I+3]=b,this.int16[I+4]=w,this.int16[I+5]=A,o}}z.prototype.bytesPerElement=12,vt("StructArrayLayout2i4i12",z);class H extends y{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(o,h,f,_,b,w){const A=this.length;return this.resize(A+1),this.emplace(A,o,h,f,_,b,w)}emplace(o,h,f,_,b,w,A){const I=4*o,R=8*o;return this.int16[I+0]=h,this.int16[I+1]=f,this.uint8[R+4]=_,this.uint8[R+5]=b,this.uint8[R+6]=w,this.uint8[R+7]=A,o}}H.prototype.bytesPerElement=8,vt("StructArrayLayout2i4ub8",H);class Y extends y{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(o,h){const f=this.length;return this.resize(f+1),this.emplace(f,o,h)}emplace(o,h,f){const _=2*o;return this.float32[_+0]=h,this.float32[_+1]=f,o}}Y.prototype.bytesPerElement=8,vt("StructArrayLayout2f8",Y);class K extends y{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(o,h,f,_,b,w,A,I,R,k){const F=this.length;return this.resize(F+1),this.emplace(F,o,h,f,_,b,w,A,I,R,k)}emplace(o,h,f,_,b,w,A,I,R,k,F){const V=10*o;return this.uint16[V+0]=h,this.uint16[V+1]=f,this.uint16[V+2]=_,this.uint16[V+3]=b,this.uint16[V+4]=w,this.uint16[V+5]=A,this.uint16[V+6]=I,this.uint16[V+7]=R,this.uint16[V+8]=k,this.uint16[V+9]=F,o}}K.prototype.bytesPerElement=20,vt("StructArrayLayout10ui20",K);class oe extends y{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(o,h,f,_,b,w,A,I,R,k,F,V){const j=this.length;return this.resize(j+1),this.emplace(j,o,h,f,_,b,w,A,I,R,k,F,V)}emplace(o,h,f,_,b,w,A,I,R,k,F,V,j){const X=12*o;return this.int16[X+0]=h,this.int16[X+1]=f,this.int16[X+2]=_,this.int16[X+3]=b,this.uint16[X+4]=w,this.uint16[X+5]=A,this.uint16[X+6]=I,this.uint16[X+7]=R,this.int16[X+8]=k,this.int16[X+9]=F,this.int16[X+10]=V,this.int16[X+11]=j,o}}oe.prototype.bytesPerElement=24,vt("StructArrayLayout4i4ui4i24",oe);class he extends y{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(o,h,f){const _=this.length;return this.resize(_+1),this.emplace(_,o,h,f)}emplace(o,h,f,_){const b=3*o;return this.float32[b+0]=h,this.float32[b+1]=f,this.float32[b+2]=_,o}}he.prototype.bytesPerElement=12,vt("StructArrayLayout3f12",he);class fe extends y{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(o){const h=this.length;return this.resize(h+1),this.emplace(h,o)}emplace(o,h){return this.uint32[1*o+0]=h,o}}fe.prototype.bytesPerElement=4,vt("StructArrayLayout1ul4",fe);class _e extends y{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(o,h,f,_,b,w,A,I,R){const k=this.length;return this.resize(k+1),this.emplace(k,o,h,f,_,b,w,A,I,R)}emplace(o,h,f,_,b,w,A,I,R,k){const F=10*o,V=5*o;return this.int16[F+0]=h,this.int16[F+1]=f,this.int16[F+2]=_,this.int16[F+3]=b,this.int16[F+4]=w,this.int16[F+5]=A,this.uint32[V+3]=I,this.uint16[F+8]=R,this.uint16[F+9]=k,o}}_e.prototype.bytesPerElement=20,vt("StructArrayLayout6i1ul2ui20",_e);class re extends y{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(o,h,f,_,b,w){const A=this.length;return this.resize(A+1),this.emplace(A,o,h,f,_,b,w)}emplace(o,h,f,_,b,w,A){const I=6*o;return this.int16[I+0]=h,this.int16[I+1]=f,this.int16[I+2]=_,this.int16[I+3]=b,this.int16[I+4]=w,this.int16[I+5]=A,o}}re.prototype.bytesPerElement=12,vt("StructArrayLayout2i2i2i12",re);class be extends y{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(o,h,f,_,b){const w=this.length;return this.resize(w+1),this.emplace(w,o,h,f,_,b)}emplace(o,h,f,_,b,w){const A=4*o,I=8*o;return this.float32[A+0]=h,this.float32[A+1]=f,this.float32[A+2]=_,this.int16[I+6]=b,this.int16[I+7]=w,o}}be.prototype.bytesPerElement=16,vt("StructArrayLayout2f1f2i16",be);class Se extends y{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(o,h,f,_,b,w){const A=this.length;return this.resize(A+1),this.emplace(A,o,h,f,_,b,w)}emplace(o,h,f,_,b,w,A){const I=16*o,R=4*o,k=8*o;return this.uint8[I+0]=h,this.uint8[I+1]=f,this.float32[R+1]=_,this.float32[R+2]=b,this.int16[k+6]=w,this.int16[k+7]=A,o}}Se.prototype.bytesPerElement=16,vt("StructArrayLayout2ub2f2i16",Se);class De extends y{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(o,h,f){const _=this.length;return this.resize(_+1),this.emplace(_,o,h,f)}emplace(o,h,f,_){const b=3*o;return this.uint16[b+0]=h,this.uint16[b+1]=f,this.uint16[b+2]=_,o}}De.prototype.bytesPerElement=6,vt("StructArrayLayout3ui6",De);class Xe extends y{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(o,h,f,_,b,w,A,I,R,k,F,V,j,X,Z,se,ue){const Me=this.length;return this.resize(Me+1),this.emplace(Me,o,h,f,_,b,w,A,I,R,k,F,V,j,X,Z,se,ue)}emplace(o,h,f,_,b,w,A,I,R,k,F,V,j,X,Z,se,ue,Me){const xe=24*o,Ee=12*o,Ue=48*o;return this.int16[xe+0]=h,this.int16[xe+1]=f,this.uint16[xe+2]=_,this.uint16[xe+3]=b,this.uint32[Ee+2]=w,this.uint32[Ee+3]=A,this.uint32[Ee+4]=I,this.uint16[xe+10]=R,this.uint16[xe+11]=k,this.uint16[xe+12]=F,this.float32[Ee+7]=V,this.float32[Ee+8]=j,this.uint8[Ue+36]=X,this.uint8[Ue+37]=Z,this.uint8[Ue+38]=se,this.uint32[Ee+10]=ue,this.int16[xe+22]=Me,o}}Xe.prototype.bytesPerElement=48,vt("StructArrayLayout2i2ui3ul3ui2f3ub1ul1i48",Xe);class rt extends y{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(o,h,f,_,b,w,A,I,R,k,F,V,j,X,Z,se,ue,Me,xe,Ee,Ue,et,mt,Ot,pt,ut,Ct,Tt){const xt=this.length;return this.resize(xt+1),this.emplace(xt,o,h,f,_,b,w,A,I,R,k,F,V,j,X,Z,se,ue,Me,xe,Ee,Ue,et,mt,Ot,pt,ut,Ct,Tt)}emplace(o,h,f,_,b,w,A,I,R,k,F,V,j,X,Z,se,ue,Me,xe,Ee,Ue,et,mt,Ot,pt,ut,Ct,Tt,xt){const $e=32*o,Pt=16*o;return this.int16[$e+0]=h,this.int16[$e+1]=f,this.int16[$e+2]=_,this.int16[$e+3]=b,this.int16[$e+4]=w,this.int16[$e+5]=A,this.int16[$e+6]=I,this.int16[$e+7]=R,this.uint16[$e+8]=k,this.uint16[$e+9]=F,this.uint16[$e+10]=V,this.uint16[$e+11]=j,this.uint16[$e+12]=X,this.uint16[$e+13]=Z,this.uint16[$e+14]=se,this.uint16[$e+15]=ue,this.uint16[$e+16]=Me,this.uint16[$e+17]=xe,this.uint16[$e+18]=Ee,this.uint16[$e+19]=Ue,this.uint16[$e+20]=et,this.uint16[$e+21]=mt,this.uint16[$e+22]=Ot,this.uint32[Pt+12]=pt,this.float32[Pt+13]=ut,this.float32[Pt+14]=Ct,this.uint16[$e+30]=Tt,this.uint16[$e+31]=xt,o}}rt.prototype.bytesPerElement=64,vt("StructArrayLayout8i15ui1ul2f2ui64",rt);class dt extends y{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(o){const h=this.length;return this.resize(h+1),this.emplace(h,o)}emplace(o,h){return this.float32[1*o+0]=h,o}}dt.prototype.bytesPerElement=4,vt("StructArrayLayout1f4",dt);class yt extends y{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(o,h,f){const _=this.length;return this.resize(_+1),this.emplace(_,o,h,f)}emplace(o,h,f,_){const b=3*o;return this.uint16[6*o+0]=h,this.float32[b+1]=f,this.float32[b+2]=_,o}}yt.prototype.bytesPerElement=12,vt("StructArrayLayout1ui2f12",yt);class lt extends y{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(o,h,f){const _=this.length;return this.resize(_+1),this.emplace(_,o,h,f)}emplace(o,h,f,_){const b=4*o;return this.uint32[2*o+0]=h,this.uint16[b+2]=f,this.uint16[b+3]=_,o}}lt.prototype.bytesPerElement=8,vt("StructArrayLayout1ul2ui8",lt);class at extends y{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(o,h){const f=this.length;return this.resize(f+1),this.emplace(f,o,h)}emplace(o,h,f){const _=2*o;return this.uint16[_+0]=h,this.uint16[_+1]=f,o}}at.prototype.bytesPerElement=4,vt("StructArrayLayout2ui4",at);class At extends y{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(o){const h=this.length;return this.resize(h+1),this.emplace(h,o)}emplace(o,h){return this.uint16[1*o+0]=h,o}}At.prototype.bytesPerElement=2,vt("StructArrayLayout1ui2",At);class jt extends y{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(o,h,f,_){const b=this.length;return this.resize(b+1),this.emplace(b,o,h,f,_)}emplace(o,h,f,_,b){const w=4*o;return this.float32[w+0]=h,this.float32[w+1]=f,this.float32[w+2]=_,this.float32[w+3]=b,o}}jt.prototype.bytesPerElement=16,vt("StructArrayLayout4f16",jt);class ct extends m{get anchorPointX(){return this._structArray.int16[this._pos2+0]}get anchorPointY(){return this._structArray.int16[this._pos2+1]}get x1(){return this._structArray.int16[this._pos2+2]}get y1(){return this._structArray.int16[this._pos2+3]}get x2(){return this._structArray.int16[this._pos2+4]}get y2(){return this._structArray.int16[this._pos2+5]}get featureIndex(){return this._structArray.uint32[this._pos4+3]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+8]}get bucketIndex(){return this._structArray.uint16[this._pos2+9]}get anchorPoint(){return new S(this.anchorPointX,this.anchorPointY)}}ct.prototype.size=20;class gt extends _e{get(o){return new ct(this,o)}}vt("CollisionBoxArray",gt);class Ut extends m{get anchorX(){return this._structArray.int16[this._pos2+0]}get anchorY(){return this._structArray.int16[this._pos2+1]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+2]}get numGlyphs(){return this._structArray.uint16[this._pos2+3]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+2]}get lineStartIndex(){return this._structArray.uint32[this._pos4+3]}get lineLength(){return this._structArray.uint32[this._pos4+4]}get segment(){return this._structArray.uint16[this._pos2+10]}get lowerSize(){return this._structArray.uint16[this._pos2+11]}get upperSize(){return this._structArray.uint16[this._pos2+12]}get lineOffsetX(){return this._structArray.float32[this._pos4+7]}get lineOffsetY(){return this._structArray.float32[this._pos4+8]}get writingMode(){return this._structArray.uint8[this._pos1+36]}get placedOrientation(){return this._structArray.uint8[this._pos1+37]}set placedOrientation(o){this._structArray.uint8[this._pos1+37]=o}get hidden(){return this._structArray.uint8[this._pos1+38]}set hidden(o){this._structArray.uint8[this._pos1+38]=o}get crossTileID(){return this._structArray.uint32[this._pos4+10]}set crossTileID(o){this._structArray.uint32[this._pos4+10]=o}get associatedIconIndex(){return this._structArray.int16[this._pos2+22]}}Ut.prototype.size=48;class Si extends Xe{get(o){return new Ut(this,o)}}vt("PlacedSymbolArray",Si);class Xt extends m{get anchorX(){return this._structArray.int16[this._pos2+0]}get anchorY(){return this._structArray.int16[this._pos2+1]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+2]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+3]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+4]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+5]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+6]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+7]}get key(){return this._structArray.uint16[this._pos2+8]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+9]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+10]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+11]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+12]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+13]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+14]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+15]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+16]}get featureIndex(){return this._structArray.uint16[this._pos2+17]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+18]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+19]}get numIconVertices(){return this._structArray.uint16[this._pos2+20]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+21]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+22]}get crossTileID(){return this._structArray.uint32[this._pos4+12]}set crossTileID(o){this._structArray.uint32[this._pos4+12]=o}get textBoxScale(){return this._structArray.float32[this._pos4+13]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+14]}get textAnchorOffsetStartIndex(){return this._structArray.uint16[this._pos2+30]}get textAnchorOffsetEndIndex(){return this._structArray.uint16[this._pos2+31]}}Xt.prototype.size=64;class Qt extends rt{get(o){return new Xt(this,o)}}vt("SymbolInstanceArray",Qt);class Ai extends dt{getoffsetX(o){return this.float32[1*o+0]}}vt("GlyphOffsetArray",Ai);class gr extends D{getx(o){return this.int16[3*o+0]}gety(o){return this.int16[3*o+1]}gettileUnitDistanceFromAnchor(o){return this.int16[3*o+2]}}vt("SymbolLineVertexArray",gr);class As extends m{get textAnchor(){return this._structArray.uint16[this._pos2+0]}get textOffset0(){return this._structArray.float32[this._pos4+1]}get textOffset1(){return this._structArray.float32[this._pos4+2]}}As.prototype.size=12;class Ei extends yt{get(o){return new As(this,o)}}vt("TextAnchorOffsetArray",Ei);class Fr extends m{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}}Fr.prototype.size=8;class Ar extends lt{get(o){return new Fr(this,o)}}vt("FeatureIndexArray",Ar);class mr extends M{}class Er extends M{}class Ws extends M{}class Io extends z{}class Dl extends H{}class Co extends Y{}class ds extends K{}class Ol extends oe{}class Tu extends he{}class fs extends fe{}class ps extends re{}class pn extends Se{}class Es extends De{}class cr extends at{}const _r=E([{name:"a_pos",components:2,type:"Int16"}],4),{members:ts}=_r;class ti{constructor(o=[]){this.segments=o}prepareSegment(o,h,f,_){let b=this.segments[this.segments.length-1];return o>ti.MAX_VERTEX_ARRAY_LENGTH&&Ke(`Max vertices per segment is ${ti.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${o}`),(!b||b.vertexLength+o>ti.MAX_VERTEX_ARRAY_LENGTH||b.sortKey!==_)&&(b={vertexOffset:h.length,primitiveOffset:f.length,vertexLength:0,primitiveLength:0},_!==void 0&&(b.sortKey=_),this.segments.push(b)),b}get(){return this.segments}destroy(){for(const o of this.segments)for(const h in o.vaos)o.vaos[h].destroy()}static simpleSegment(o,h,f,_){return new ti([{vertexOffset:o,primitiveOffset:h,vertexLength:f,primitiveLength:_,vaos:{},sortKey:0}])}}function $n(c,o){return 256*(c=we(Math.floor(c),0,255))+we(Math.floor(o),0,255)}ti.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,vt("SegmentVector",ti);const Po=E([{name:"a_pattern_from",components:4,type:"Uint16"},{name:"a_pattern_to",components:4,type:"Uint16"},{name:"a_pixel_ratio_from",components:1,type:"Uint16"},{name:"a_pixel_ratio_to",components:1,type:"Uint16"}]);var Mo={exports:{}},Sd={exports:{}};Sd.exports=function(c,o){var h,f,_,b,w,A,I,R;for(f=c.length-(h=3&c.length),_=o,w=3432918353,A=461845907,R=0;R<f;)I=255&c.charCodeAt(R)|(255&c.charCodeAt(++R))<<8|(255&c.charCodeAt(++R))<<16|(255&c.charCodeAt(++R))<<24,++R,_=27492+(65535&(b=5*(65535&(_=(_^=I=(65535&(I=(I=(65535&I)*w+(((I>>>16)*w&65535)<<16)&4294967295)<<15|I>>>17))*A+(((I>>>16)*A&65535)<<16)&4294967295)<<13|_>>>19))+((5*(_>>>16)&65535)<<16)&4294967295))+((58964+(b>>>16)&65535)<<16);switch(I=0,h){case 3:I^=(255&c.charCodeAt(R+2))<<16;case 2:I^=(255&c.charCodeAt(R+1))<<8;case 1:_^=I=(65535&(I=(I=(65535&(I^=255&c.charCodeAt(R)))*w+(((I>>>16)*w&65535)<<16)&4294967295)<<15|I>>>17))*A+(((I>>>16)*A&65535)<<16)&4294967295}return _^=c.length,_=2246822507*(65535&(_^=_>>>16))+((2246822507*(_>>>16)&65535)<<16)&4294967295,_=3266489909*(65535&(_^=_>>>13))+((3266489909*(_>>>16)&65535)<<16)&4294967295,(_^=_>>>16)>>>0};var tg=Sd.exports,Ad={exports:{}};Ad.exports=function(c,o){for(var h,f=c.length,_=o^f,b=0;f>=4;)h=1540483477*(65535&(h=255&c.charCodeAt(b)|(255&c.charCodeAt(++b))<<8|(255&c.charCodeAt(++b))<<16|(255&c.charCodeAt(++b))<<24))+((1540483477*(h>>>16)&65535)<<16),_=1540483477*(65535&_)+((1540483477*(_>>>16)&65535)<<16)^(h=1540483477*(65535&(h^=h>>>24))+((1540483477*(h>>>16)&65535)<<16)),f-=4,++b;switch(f){case 3:_^=(255&c.charCodeAt(b+2))<<16;case 2:_^=(255&c.charCodeAt(b+1))<<8;case 1:_=1540483477*(65535&(_^=255&c.charCodeAt(b)))+((1540483477*(_>>>16)&65535)<<16)}return _=1540483477*(65535&(_^=_>>>13))+((1540483477*(_>>>16)&65535)<<16),(_^=_>>>15)>>>0};var gn=tg,Ed=Ad.exports;Mo.exports=gn,Mo.exports.murmur3=gn,Mo.exports.murmur2=Ed;var Ll=g(Mo.exports);class Ta{constructor(){this.ids=[],this.positions=[],this.indexed=!1}add(o,h,f,_){this.ids.push(Fl(o)),this.positions.push(h,f,_)}getPositions(o){if(!this.indexed)throw new Error("Trying to get index, but feature positions are not indexed");const h=Fl(o);let f=0,_=this.ids.length-1;for(;f<_;){const w=f+_>>1;this.ids[w]>=h?_=w:f=w+1}const b=[];for(;this.ids[f]===h;)b.push({index:this.positions[3*f],start:this.positions[3*f+1],end:this.positions[3*f+2]}),f++;return b}static serialize(o,h){const f=new Float64Array(o.ids),_=new Uint32Array(o.positions);return Bl(f,_,0,f.length-1),h&&h.push(f.buffer,_.buffer),{ids:f,positions:_}}static deserialize(o){const h=new Ta;return h.ids=o.ids,h.positions=o.positions,h.indexed=!0,h}}function Fl(c){const o=+c;return!isNaN(o)&&o<=Number.MAX_SAFE_INTEGER?o:Ll(String(c))}function Bl(c,o,h,f){for(;h<f;){const _=c[h+f>>1];let b=h-1,w=f+1;for(;;){do b++;while(c[b]<_);do w--;while(c[w]>_);if(b>=w)break;Ro(c,b,w),Ro(o,3*b,3*w),Ro(o,3*b+1,3*w+1),Ro(o,3*b+2,3*w+2)}w-h<f-w?(Bl(c,o,h,w),h=w+1):(Bl(c,o,w+1,f),f=w)}}function Ro(c,o,h){const f=c[o];c[o]=c[h],c[h]=f}vt("FeaturePositionMap",Ta);class Sa{constructor(o,h){this.gl=o.gl,this.location=h}}class Id extends Sa{constructor(o,h){super(o,h),this.current=0}set(o){this.current!==o&&(this.current=o,this.gl.uniform1f(this.location,o))}}class Gy extends Sa{constructor(o,h){super(o,h),this.current=[0,0,0,0]}set(o){o[0]===this.current[0]&&o[1]===this.current[1]&&o[2]===this.current[2]&&o[3]===this.current[3]||(this.current=o,this.gl.uniform4f(this.location,o[0],o[1],o[2],o[3]))}}class Ky extends Sa{constructor(o,h){super(o,h),this.current=di.transparent}set(o){o.r===this.current.r&&o.g===this.current.g&&o.b===this.current.b&&o.a===this.current.a||(this.current=o,this.gl.uniform4f(this.location,o.r,o.g,o.b,o.a))}}const pS=new Float32Array(16);function ig(c){return[$n(255*c.r,255*c.g),$n(255*c.b,255*c.a)]}class Su{constructor(o,h,f){this.value=o,this.uniformNames=h.map((_=>`u_${_}`)),this.type=f}setUniform(o,h,f){o.set(f.constantOr(this.value))}getBinding(o,h,f){return this.type==="color"?new Ky(o,h):new Id(o,h)}}class Nl{constructor(o,h){this.uniformNames=h.map((f=>`u_${f}`)),this.patternFrom=null,this.patternTo=null,this.pixelRatioFrom=1,this.pixelRatioTo=1}setConstantPatternPositions(o,h){this.pixelRatioFrom=h.pixelRatio,this.pixelRatioTo=o.pixelRatio,this.patternFrom=h.tlbr,this.patternTo=o.tlbr}setUniform(o,h,f,_){const b=_==="u_pattern_to"?this.patternTo:_==="u_pattern_from"?this.patternFrom:_==="u_pixel_ratio_to"?this.pixelRatioTo:_==="u_pixel_ratio_from"?this.pixelRatioFrom:null;b&&o.set(b)}getBinding(o,h,f){return f.substr(0,9)==="u_pattern"?new Gy(o,h):new Id(o,h)}}class Wn{constructor(o,h,f,_){this.expression=o,this.type=f,this.maxValue=0,this.paintVertexAttributes=h.map((b=>({name:`a_${b}`,type:"Float32",components:f==="color"?2:1,offset:0}))),this.paintVertexArray=new _}populatePaintArray(o,h,f,_,b){const w=this.paintVertexArray.length,A=this.expression.evaluate(new Ti(0),h,{},_,[],b);this.paintVertexArray.resize(o),this._setPaintValue(w,o,A)}updatePaintArray(o,h,f,_){const b=this.expression.evaluate({zoom:0},f,_);this._setPaintValue(o,h,b)}_setPaintValue(o,h,f){if(this.type==="color"){const _=ig(f);for(let b=o;b<h;b++)this.paintVertexArray.emplace(b,_[0],_[1])}else{for(let _=o;_<h;_++)this.paintVertexArray.emplace(_,f);this.maxValue=Math.max(this.maxValue,Math.abs(f))}}upload(o){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=o.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class tn{constructor(o,h,f,_,b,w){this.expression=o,this.uniformNames=h.map((A=>`u_${A}_t`)),this.type=f,this.useIntegerZoom=_,this.zoom=b,this.maxValue=0,this.paintVertexAttributes=h.map((A=>({name:`a_${A}`,type:"Float32",components:f==="color"?4:2,offset:0}))),this.paintVertexArray=new w}populatePaintArray(o,h,f,_,b){const w=this.expression.evaluate(new Ti(this.zoom),h,{},_,[],b),A=this.expression.evaluate(new Ti(this.zoom+1),h,{},_,[],b),I=this.paintVertexArray.length;this.paintVertexArray.resize(o),this._setPaintValue(I,o,w,A)}updatePaintArray(o,h,f,_){const b=this.expression.evaluate({zoom:this.zoom},f,_),w=this.expression.evaluate({zoom:this.zoom+1},f,_);this._setPaintValue(o,h,b,w)}_setPaintValue(o,h,f,_){if(this.type==="color"){const b=ig(f),w=ig(_);for(let A=o;A<h;A++)this.paintVertexArray.emplace(A,b[0],b[1],w[0],w[1])}else{for(let b=o;b<h;b++)this.paintVertexArray.emplace(b,f,_);this.maxValue=Math.max(this.maxValue,Math.abs(f),Math.abs(_))}}upload(o){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=o.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(o,h){const f=this.useIntegerZoom?Math.floor(h.zoom):h.zoom,_=we(this.expression.interpolationFactor(f,this.zoom,this.zoom+1),0,1);o.set(_)}getBinding(o,h,f){return new Id(o,h)}}class ko{constructor(o,h,f,_,b,w){this.expression=o,this.type=h,this.useIntegerZoom=f,this.zoom=_,this.layerId=w,this.zoomInPaintVertexArray=new b,this.zoomOutPaintVertexArray=new b}populatePaintArray(o,h,f){const _=this.zoomInPaintVertexArray.length;this.zoomInPaintVertexArray.resize(o),this.zoomOutPaintVertexArray.resize(o),this._setPaintValues(_,o,h.patterns&&h.patterns[this.layerId],f)}updatePaintArray(o,h,f,_,b){this._setPaintValues(o,h,f.patterns&&f.patterns[this.layerId],b)}_setPaintValues(o,h,f,_){if(!_||!f)return;const{min:b,mid:w,max:A}=f,I=_[b],R=_[w],k=_[A];if(I&&R&&k)for(let F=o;F<h;F++)this.zoomInPaintVertexArray.emplace(F,R.tl[0],R.tl[1],R.br[0],R.br[1],I.tl[0],I.tl[1],I.br[0],I.br[1],R.pixelRatio,I.pixelRatio),this.zoomOutPaintVertexArray.emplace(F,R.tl[0],R.tl[1],R.br[0],R.br[1],k.tl[0],k.tl[1],k.br[0],k.br[1],R.pixelRatio,k.pixelRatio)}upload(o){this.zoomInPaintVertexArray&&this.zoomInPaintVertexArray.arrayBuffer&&this.zoomOutPaintVertexArray&&this.zoomOutPaintVertexArray.arrayBuffer&&(this.zoomInPaintVertexBuffer=o.createVertexBuffer(this.zoomInPaintVertexArray,Po.members,this.expression.isStateDependent),this.zoomOutPaintVertexBuffer=o.createVertexBuffer(this.zoomOutPaintVertexArray,Po.members,this.expression.isStateDependent))}destroy(){this.zoomOutPaintVertexBuffer&&this.zoomOutPaintVertexBuffer.destroy(),this.zoomInPaintVertexBuffer&&this.zoomInPaintVertexBuffer.destroy()}}class Jy{constructor(o,h,f){this.binders={},this._buffers=[];const _=[];for(const b in o.paint._values){if(!f(b))continue;const w=o.paint.get(b);if(!(w instanceof $s&&go(w.property.specification)))continue;const A=gS(b,o.type),I=w.value,R=w.property.specification.type,k=w.property.useIntegerZoom,F=w.property.specification["property-type"],V=F==="cross-faded"||F==="cross-faded-data-driven";if(I.kind==="constant")this.binders[b]=V?new Nl(I.value,A):new Su(I.value,A,R),_.push(`/u_${b}`);else if(I.kind==="source"||V){const j=Qy(b,R,"source");this.binders[b]=V?new ko(I,R,k,h,j,o.id):new Wn(I,A,R,j),_.push(`/a_${b}`)}else{const j=Qy(b,R,"composite");this.binders[b]=new tn(I,A,R,k,h,j),_.push(`/z_${b}`)}}this.cacheKey=_.sort().join("")}getMaxValue(o){const h=this.binders[o];return h instanceof Wn||h instanceof tn?h.maxValue:0}populatePaintArrays(o,h,f,_,b){for(const w in this.binders){const A=this.binders[w];(A instanceof Wn||A instanceof tn||A instanceof ko)&&A.populatePaintArray(o,h,f,_,b)}}setConstantPatternPositions(o,h){for(const f in this.binders){const _=this.binders[f];_ instanceof Nl&&_.setConstantPatternPositions(o,h)}}updatePaintArrays(o,h,f,_,b){let w=!1;for(const A in o){const I=h.getPositions(A);for(const R of I){const k=f.feature(R.index);for(const F in this.binders){const V=this.binders[F];if((V instanceof Wn||V instanceof tn||V instanceof ko)&&V.expression.isStateDependent===!0){const j=_.paint.get(F);V.expression=j.value,V.updatePaintArray(R.start,R.end,k,o[A],b),w=!0}}}}return w}defines(){const o=[];for(const h in this.binders){const f=this.binders[h];(f instanceof Su||f instanceof Nl)&&o.push(...f.uniformNames.map((_=>`#define HAS_UNIFORM_${_}`)))}return o}getBinderAttributes(){const o=[];for(const h in this.binders){const f=this.binders[h];if(f instanceof Wn||f instanceof tn)for(let _=0;_<f.paintVertexAttributes.length;_++)o.push(f.paintVertexAttributes[_].name);else if(f instanceof ko)for(let _=0;_<Po.members.length;_++)o.push(Po.members[_].name)}return o}getBinderUniforms(){const o=[];for(const h in this.binders){const f=this.binders[h];if(f instanceof Su||f instanceof Nl||f instanceof tn)for(const _ of f.uniformNames)o.push(_)}return o}getPaintVertexBuffers(){return this._buffers}getUniforms(o,h){const f=[];for(const _ in this.binders){const b=this.binders[_];if(b instanceof Su||b instanceof Nl||b instanceof tn){for(const w of b.uniformNames)if(h[w]){const A=b.getBinding(o,h[w],w);f.push({name:w,property:_,binding:A})}}}return f}setUniforms(o,h,f,_){for(const{name:b,property:w,binding:A}of h)this.binders[w].setUniform(A,_,f.get(w),b)}updatePaintBuffers(o){this._buffers=[];for(const h in this.binders){const f=this.binders[h];if(o&&f instanceof ko){const _=o.fromScale===2?f.zoomInPaintVertexBuffer:f.zoomOutPaintVertexBuffer;_&&this._buffers.push(_)}else(f instanceof Wn||f instanceof tn)&&f.paintVertexBuffer&&this._buffers.push(f.paintVertexBuffer)}}upload(o){for(const h in this.binders){const f=this.binders[h];(f instanceof Wn||f instanceof tn||f instanceof ko)&&f.upload(o)}this.updatePaintBuffers()}destroy(){for(const o in this.binders){const h=this.binders[o];(h instanceof Wn||h instanceof tn||h instanceof ko)&&h.destroy()}}}class Aa{constructor(o,h,f=(()=>!0)){this.programConfigurations={};for(const _ of o)this.programConfigurations[_.id]=new Jy(_,h,f);this.needsUpload=!1,this._featureMap=new Ta,this._bufferOffset=0}populatePaintArrays(o,h,f,_,b,w){for(const A in this.programConfigurations)this.programConfigurations[A].populatePaintArrays(o,h,_,b,w);h.id!==void 0&&this._featureMap.add(h.id,f,this._bufferOffset,o),this._bufferOffset=o,this.needsUpload=!0}updatePaintArrays(o,h,f,_){for(const b of f)this.needsUpload=this.programConfigurations[b.id].updatePaintArrays(o,this._featureMap,h,b,_)||this.needsUpload}get(o){return this.programConfigurations[o]}upload(o){if(this.needsUpload){for(const h in this.programConfigurations)this.programConfigurations[h].upload(o);this.needsUpload=!1}}destroy(){for(const o in this.programConfigurations)this.programConfigurations[o].destroy()}}function gS(c,o){return{"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"line-gap-width":["gapwidth"],"line-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"fill-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"fill-extrusion-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"]}[c]||[c.replace(`${o}-`,"").replace(/-/g,"_")]}function Qy(c,o,h){const f={color:{source:Y,composite:jt},number:{source:dt,composite:Y}},_=(function(b){return{"line-pattern":{source:ds,composite:ds},"fill-pattern":{source:ds,composite:ds},"fill-extrusion-pattern":{source:ds,composite:ds}}[b]})(c);return _&&_[h]||f[o][h]}vt("ConstantBinder",Su),vt("CrossFadedConstantBinder",Nl),vt("SourceExpressionBinder",Wn),vt("CrossFadedCompositeBinder",ko),vt("CompositeExpressionBinder",tn),vt("ProgramConfiguration",Jy,{omit:["_buffers"]}),vt("ProgramConfigurationSet",Aa);const Yi=8192,rg=Math.pow(2,14)-1,ex=-rg-1;function Ea(c){const o=Yi/c.extent,h=c.loadGeometry();for(let f=0;f<h.length;f++){const _=h[f];for(let b=0;b<_.length;b++){const w=_[b],A=Math.round(w.x*o),I=Math.round(w.y*o);w.x=we(A,ex,rg),w.y=we(I,ex,rg),(A<w.x||A>w.x+1||I<w.y||I>w.y+1)&&Ke("Geometry exceeds allowed extent, reduce your vector tile buffer size")}}return h}function Ia(c,o){return{type:c.type,id:c.id,properties:c.properties,geometry:o?Ea(c):[]}}function Cd(c,o,h,f,_){c.emplaceBack(2*o+(f+1)/2,2*h+(_+1)/2)}class sg{constructor(o){this.zoom=o.zoom,this.overscaling=o.overscaling,this.layers=o.layers,this.layerIds=this.layers.map((h=>h.id)),this.index=o.index,this.hasPattern=!1,this.layoutVertexArray=new Er,this.indexArray=new Es,this.segments=new ti,this.programConfigurations=new Aa(o.layers,o.zoom),this.stateDependentLayerIds=this.layers.filter((h=>h.isStateDependent())).map((h=>h.id))}populate(o,h,f){const _=this.layers[0],b=[];let w=null,A=!1;_.type==="circle"&&(w=_.layout.get("circle-sort-key"),A=!w.isConstant());for(const{feature:I,id:R,index:k,sourceLayerIndex:F}of o){const V=this.layers[0]._featureFilter.needGeometry,j=Ia(I,V);if(!this.layers[0]._featureFilter.filter(new Ti(this.zoom),j,f))continue;const X=A?w.evaluate(j,{},f):void 0,Z={id:R,properties:I.properties,type:I.type,sourceLayerIndex:F,index:k,geometry:V?j.geometry:Ea(I),patterns:{},sortKey:X};b.push(Z)}A&&b.sort(((I,R)=>I.sortKey-R.sortKey));for(const I of b){const{geometry:R,index:k,sourceLayerIndex:F}=I,V=o[k].feature;this.addFeature(I,R,k,f),h.featureIndex.insert(V,R,k,F,this.index)}}update(o,h,f){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(o,h,this.stateDependentLayers,f)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(o){this.uploaded||(this.layoutVertexBuffer=o.createVertexBuffer(this.layoutVertexArray,ts),this.indexBuffer=o.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(o),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(o,h,f,_){for(const b of h)for(const w of b){const A=w.x,I=w.y;if(A<0||A>=Yi||I<0||I>=Yi)continue;const R=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,o.sortKey),k=R.vertexLength;Cd(this.layoutVertexArray,A,I,-1,-1),Cd(this.layoutVertexArray,A,I,1,-1),Cd(this.layoutVertexArray,A,I,1,1),Cd(this.layoutVertexArray,A,I,-1,1),this.indexArray.emplaceBack(k,k+1,k+2),this.indexArray.emplaceBack(k,k+3,k+2),R.vertexLength+=4,R.primitiveLength+=2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,o,f,{},_)}}function tx(c,o){for(let h=0;h<c.length;h++)if(zl(o,c[h]))return!0;for(let h=0;h<o.length;h++)if(zl(c,o[h]))return!0;return!!ng(c,o)}function mS(c,o,h){return!!zl(c,o)||!!og(o,c,h)}function ix(c,o){if(c.length===1)return sx(o,c[0]);for(let h=0;h<o.length;h++){const f=o[h];for(let _=0;_<f.length;_++)if(zl(c,f[_]))return!0}for(let h=0;h<c.length;h++)if(sx(o,c[h]))return!0;for(let h=0;h<o.length;h++)if(ng(c,o[h]))return!0;return!1}function _S(c,o,h){if(c.length>1){if(ng(c,o))return!0;for(let f=0;f<o.length;f++)if(og(o[f],c,h))return!0}for(let f=0;f<c.length;f++)if(og(c[f],o,h))return!0;return!1}function ng(c,o){if(c.length===0||o.length===0)return!1;for(let h=0;h<c.length-1;h++){const f=c[h],_=c[h+1];for(let b=0;b<o.length-1;b++)if(yS(f,_,o[b],o[b+1]))return!0}return!1}function yS(c,o,h,f){return Ze(c,h,f)!==Ze(o,h,f)&&Ze(c,o,h)!==Ze(c,o,f)}function og(c,o,h){const f=h*h;if(o.length===1)return c.distSqr(o[0])<f;for(let _=1;_<o.length;_++)if(rx(c,o[_-1],o[_])<f)return!0;return!1}function rx(c,o,h){const f=o.distSqr(h);if(f===0)return c.distSqr(o);const _=((c.x-o.x)*(h.x-o.x)+(c.y-o.y)*(h.y-o.y))/f;return c.distSqr(_<0?o:_>1?h:h.sub(o)._mult(_)._add(o))}function sx(c,o){let h,f,_,b=!1;for(let w=0;w<c.length;w++){h=c[w];for(let A=0,I=h.length-1;A<h.length;I=A++)f=h[A],_=h[I],f.y>o.y!=_.y>o.y&&o.x<(_.x-f.x)*(o.y-f.y)/(_.y-f.y)+f.x&&(b=!b)}return b}function zl(c,o){let h=!1;for(let f=0,_=c.length-1;f<c.length;_=f++){const b=c[f],w=c[_];b.y>o.y!=w.y>o.y&&o.x<(w.x-b.x)*(o.y-b.y)/(w.y-b.y)+b.x&&(h=!h)}return h}function xS(c,o,h){const f=h[0],_=h[2];if(c.x<f.x&&o.x<f.x||c.x>_.x&&o.x>_.x||c.y<f.y&&o.y<f.y||c.y>_.y&&o.y>_.y)return!1;const b=Ze(c,o,h[0]);return b!==Ze(c,o,h[1])||b!==Ze(c,o,h[2])||b!==Ze(c,o,h[3])}function Au(c,o,h){const f=o.paint.get(c).value;return f.kind==="constant"?f.value:h.programConfigurations.get(o.id).getMaxValue(c)}function Pd(c){return Math.sqrt(c[0]*c[0]+c[1]*c[1])}function Md(c,o,h,f,_){if(!o[0]&&!o[1])return c;const b=S.convert(o)._mult(_);h==="viewport"&&b._rotate(-f);const w=[];for(let A=0;A<c.length;A++)w.push(c[A].sub(b));return w}let nx,ox;vt("CircleBucket",sg,{omit:["layers"]});var vS={get paint(){return ox=ox||new x({"circle-radius":new Ft(Ce.paint_circle["circle-radius"]),"circle-color":new Ft(Ce.paint_circle["circle-color"]),"circle-blur":new Ft(Ce.paint_circle["circle-blur"]),"circle-opacity":new Ft(Ce.paint_circle["circle-opacity"]),"circle-translate":new St(Ce.paint_circle["circle-translate"]),"circle-translate-anchor":new St(Ce.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new St(Ce.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new St(Ce.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new Ft(Ce.paint_circle["circle-stroke-width"]),"circle-stroke-color":new Ft(Ce.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new Ft(Ce.paint_circle["circle-stroke-opacity"])})},get layout(){return nx=nx||new x({"circle-sort-key":new Ft(Ce.layout_circle["circle-sort-key"])})}},Br=1e-6,Ul=typeof Float32Array<"u"?Float32Array:Array;function ag(c){return c[0]=1,c[1]=0,c[2]=0,c[3]=0,c[4]=0,c[5]=1,c[6]=0,c[7]=0,c[8]=0,c[9]=0,c[10]=1,c[11]=0,c[12]=0,c[13]=0,c[14]=0,c[15]=1,c}function ax(c,o,h){var f=o[0],_=o[1],b=o[2],w=o[3],A=o[4],I=o[5],R=o[6],k=o[7],F=o[8],V=o[9],j=o[10],X=o[11],Z=o[12],se=o[13],ue=o[14],Me=o[15],xe=h[0],Ee=h[1],Ue=h[2],et=h[3];return c[0]=xe*f+Ee*A+Ue*F+et*Z,c[1]=xe*_+Ee*I+Ue*V+et*se,c[2]=xe*b+Ee*R+Ue*j+et*ue,c[3]=xe*w+Ee*k+Ue*X+et*Me,c[4]=(xe=h[4])*f+(Ee=h[5])*A+(Ue=h[6])*F+(et=h[7])*Z,c[5]=xe*_+Ee*I+Ue*V+et*se,c[6]=xe*b+Ee*R+Ue*j+et*ue,c[7]=xe*w+Ee*k+Ue*X+et*Me,c[8]=(xe=h[8])*f+(Ee=h[9])*A+(Ue=h[10])*F+(et=h[11])*Z,c[9]=xe*_+Ee*I+Ue*V+et*se,c[10]=xe*b+Ee*R+Ue*j+et*ue,c[11]=xe*w+Ee*k+Ue*X+et*Me,c[12]=(xe=h[12])*f+(Ee=h[13])*A+(Ue=h[14])*F+(et=h[15])*Z,c[13]=xe*_+Ee*I+Ue*V+et*se,c[14]=xe*b+Ee*R+Ue*j+et*ue,c[15]=xe*w+Ee*k+Ue*X+et*Me,c}Math.hypot||(Math.hypot=function(){for(var c=0,o=arguments.length;o--;)c+=arguments[o]*arguments[o];return Math.sqrt(c)});var Eu,bS=ax;function Rd(c,o,h){var f=o[0],_=o[1],b=o[2],w=o[3];return c[0]=h[0]*f+h[4]*_+h[8]*b+h[12]*w,c[1]=h[1]*f+h[5]*_+h[9]*b+h[13]*w,c[2]=h[2]*f+h[6]*_+h[10]*b+h[14]*w,c[3]=h[3]*f+h[7]*_+h[11]*b+h[15]*w,c}Eu=new Ul(4),Ul!=Float32Array&&(Eu[0]=0,Eu[1]=0,Eu[2]=0,Eu[3]=0);class wS extends d{constructor(o){super(o,vS)}createBucket(o){return new sg(o)}queryRadius(o){const h=o;return Au("circle-radius",this,h)+Au("circle-stroke-width",this,h)+Pd(this.paint.get("circle-translate"))}queryIntersectsFeature(o,h,f,_,b,w,A,I){const R=Md(o,this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),w.angle,A),k=this.paint.get("circle-radius").evaluate(h,f)+this.paint.get("circle-stroke-width").evaluate(h,f),F=this.paint.get("circle-pitch-alignment")==="map",V=F?R:(function(X,Z){return X.map((se=>lx(se,Z)))})(R,I),j=F?k*A:k;for(const X of _)for(const Z of X){const se=F?Z:lx(Z,I);let ue=j;const Me=Rd([],[Z.x,Z.y,0,1],I);if(this.paint.get("circle-pitch-scale")==="viewport"&&this.paint.get("circle-pitch-alignment")==="map"?ue*=Me[3]/w.cameraToCenterDistance:this.paint.get("circle-pitch-scale")==="map"&&this.paint.get("circle-pitch-alignment")==="viewport"&&(ue*=w.cameraToCenterDistance/Me[3]),mS(V,se,ue))return!0}return!1}}function lx(c,o){const h=Rd([],[c.x,c.y,0,1],o);return new S(h[0]/h[3],h[1]/h[3])}class cx extends sg{}let ux;vt("HeatmapBucket",cx,{omit:["layers"]});var TS={get paint(){return ux=ux||new x({"heatmap-radius":new Ft(Ce.paint_heatmap["heatmap-radius"]),"heatmap-weight":new Ft(Ce.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new St(Ce.paint_heatmap["heatmap-intensity"]),"heatmap-color":new wu(Ce.paint_heatmap["heatmap-color"]),"heatmap-opacity":new St(Ce.paint_heatmap["heatmap-opacity"])})}};function lg(c,{width:o,height:h},f,_){if(_){if(_ instanceof Uint8ClampedArray)_=new Uint8Array(_.buffer);else if(_.length!==o*h*f)throw new RangeError(`mismatched image size. expected: ${_.length} but got: ${o*h*f}`)}else _=new Uint8Array(o*h*f);return c.width=o,c.height=h,c.data=_,c}function hx(c,{width:o,height:h},f){if(o===c.width&&h===c.height)return;const _=lg({},{width:o,height:h},f);cg(c,_,{x:0,y:0},{x:0,y:0},{width:Math.min(c.width,o),height:Math.min(c.height,h)},f),c.width=o,c.height=h,c.data=_.data}function cg(c,o,h,f,_,b){if(_.width===0||_.height===0)return o;if(_.width>c.width||_.height>c.height||h.x>c.width-_.width||h.y>c.height-_.height)throw new RangeError("out of range source coordinates for image copy");if(_.width>o.width||_.height>o.height||f.x>o.width-_.width||f.y>o.height-_.height)throw new RangeError("out of range destination coordinates for image copy");const w=c.data,A=o.data;if(w===A)throw new Error("srcData equals dstData, so image is already copied");for(let I=0;I<_.height;I++){const R=((h.y+I)*c.width+h.x)*b,k=((f.y+I)*o.width+f.x)*b;for(let F=0;F<_.width*b;F++)A[k+F]=w[R+F]}return o}class Iu{constructor(o,h){lg(this,o,1,h)}resize(o){hx(this,o,1)}clone(){return new Iu({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(o,h,f,_,b){cg(o,h,f,_,b,1)}}class Is{constructor(o,h){lg(this,o,4,h)}resize(o){hx(this,o,4)}replace(o,h){h?this.data.set(o):this.data=o instanceof Uint8ClampedArray?new Uint8Array(o.buffer):o}clone(){return new Is({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(o,h,f,_,b){cg(o,h,f,_,b,4)}}function dx(c){const o={},h=c.resolution||256,f=c.clips?c.clips.length:1,_=c.image||new Is({width:h,height:f});if(Math.log(h)/Math.LN2%1!=0)throw new Error(`width is not a power of 2 - ${h}`);const b=(w,A,I)=>{o[c.evaluationKey]=I;const R=c.expression.evaluate(o);_.data[w+A+0]=Math.floor(255*R.r/R.a),_.data[w+A+1]=Math.floor(255*R.g/R.a),_.data[w+A+2]=Math.floor(255*R.b/R.a),_.data[w+A+3]=Math.floor(255*R.a)};if(c.clips)for(let w=0,A=0;w<f;++w,A+=4*h)for(let I=0,R=0;I<h;I++,R+=4){const k=I/(h-1),{start:F,end:V}=c.clips[w];b(A,R,F*(1-k)+V*k)}else for(let w=0,A=0;w<h;w++,A+=4)b(0,A,w/(h-1));return _}vt("AlphaImage",Iu),vt("RGBAImage",Is);const ug="big-fb";class SS extends d{createBucket(o){return new cx(o)}constructor(o){super(o,TS),this.heatmapFbos=new Map,this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(o){o==="heatmap-color"&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=dx({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbos.has(ug)&&this.heatmapFbos.delete(ug)}queryRadius(){return 0}queryIntersectsFeature(){return!1}hasOffscreenPass(){return this.paint.get("heatmap-opacity")!==0&&this.visibility!=="none"}}let fx;var AS={get paint(){return fx=fx||new x({"hillshade-illumination-direction":new St(Ce.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new St(Ce.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new St(Ce.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new St(Ce.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new St(Ce.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new St(Ce.paint_hillshade["hillshade-accent-color"])})}};class ES extends d{constructor(o){super(o,AS)}hasOffscreenPass(){return this.paint.get("hillshade-exaggeration")!==0&&this.visibility!=="none"}}const IS=E([{name:"a_pos",components:2,type:"Int16"}],4),{members:CS}=IS;function px(c,o,h=2){const f=o&&o.length,_=f?o[0]*h:c.length;let b=gx(c,0,_,h,!0);const w=[];if(!b||b.next===b.prev)return w;let A,I,R;if(f&&(b=(function(k,F,V,j){const X=[];for(let Z=0,se=F.length;Z<se;Z++){const ue=gx(k,F[Z]*j,Z<se-1?F[Z+1]*j:k.length,j,!1);ue===ue.next&&(ue.steiner=!0),X.push(FS(ue))}X.sort(DS);for(let Z=0;Z<X.length;Z++)V=OS(X[Z],V);return V})(c,o,b,h)),c.length>80*h){A=1/0,I=1/0;let k=-1/0,F=-1/0;for(let V=h;V<_;V+=h){const j=c[V],X=c[V+1];j<A&&(A=j),X<I&&(I=X),j>k&&(k=j),X>F&&(F=X)}R=Math.max(k-A,F-I),R=R!==0?32767/R:0}return Cu(b,w,h,A,I,R,0),w}function gx(c,o,h,f,_){let b;if(_===(function(w,A,I,R){let k=0;for(let F=A,V=I-R;F<I;F+=R)k+=(w[V]-w[F])*(w[F+1]+w[V+1]),V=F;return k})(c,o,h,f)>0)for(let w=o;w<h;w+=f)b=yx(w/f|0,c[w],c[w+1],b);else for(let w=h-f;w>=o;w-=f)b=yx(w/f|0,c[w],c[w+1],b);return b&&kd(b,b.next)&&(Mu(b),b=b.next),b}function Ca(c,o){if(!c)return c;o||(o=c);let h,f=c;do if(h=!1,f.steiner||!kd(f,f.next)&&Hi(f.prev,f,f.next)!==0)f=f.next;else{if(Mu(f),f=o=f.prev,f===f.next)break;h=!0}while(h||f!==o);return o}function Cu(c,o,h,f,_,b,w){if(!c)return;!w&&b&&(function(I,R,k,F){let V=I;do V.z===0&&(V.z=hg(V.x,V.y,R,k,F)),V.prevZ=V.prev,V.nextZ=V.next,V=V.next;while(V!==I);V.prevZ.nextZ=null,V.prevZ=null,(function(j){let X,Z=1;do{let se,ue=j;j=null;let Me=null;for(X=0;ue;){X++;let xe=ue,Ee=0;for(let et=0;et<Z&&(Ee++,xe=xe.nextZ,xe);et++);let Ue=Z;for(;Ee>0||Ue>0&&xe;)Ee!==0&&(Ue===0||!xe||ue.z<=xe.z)?(se=ue,ue=ue.nextZ,Ee--):(se=xe,xe=xe.nextZ,Ue--),Me?Me.nextZ=se:j=se,se.prevZ=Me,Me=se;ue=xe}Me.nextZ=null,Z*=2}while(X>1)})(V)})(c,f,_,b);let A=c;for(;c.prev!==c.next;){const I=c.prev,R=c.next;if(b?MS(c,f,_,b):PS(c))o.push(I.i,c.i,R.i),Mu(c),c=R.next,A=R.next;else if((c=R)===A){w?w===1?Cu(c=RS(Ca(c),o),o,h,f,_,b,2):w===2&&kS(c,o,h,f,_,b):Cu(Ca(c),o,h,f,_,b,1);break}}}function PS(c){const o=c.prev,h=c,f=c.next;if(Hi(o,h,f)>=0)return!1;const _=o.x,b=h.x,w=f.x,A=o.y,I=h.y,R=f.y,k=_<b?_<w?_:w:b<w?b:w,F=A<I?A<R?A:R:I<R?I:R,V=_>b?_>w?_:w:b>w?b:w,j=A>I?A>R?A:R:I>R?I:R;let X=f.next;for(;X!==o;){if(X.x>=k&&X.x<=V&&X.y>=F&&X.y<=j&&Vl(_,A,b,I,w,R,X.x,X.y)&&Hi(X.prev,X,X.next)>=0)return!1;X=X.next}return!0}function MS(c,o,h,f){const _=c.prev,b=c,w=c.next;if(Hi(_,b,w)>=0)return!1;const A=_.x,I=b.x,R=w.x,k=_.y,F=b.y,V=w.y,j=A<I?A<R?A:R:I<R?I:R,X=k<F?k<V?k:V:F<V?F:V,Z=A>I?A>R?A:R:I>R?I:R,se=k>F?k>V?k:V:F>V?F:V,ue=hg(j,X,o,h,f),Me=hg(Z,se,o,h,f);let xe=c.prevZ,Ee=c.nextZ;for(;xe&&xe.z>=ue&&Ee&&Ee.z<=Me;){if(xe.x>=j&&xe.x<=Z&&xe.y>=X&&xe.y<=se&&xe!==_&&xe!==w&&Vl(A,k,I,F,R,V,xe.x,xe.y)&&Hi(xe.prev,xe,xe.next)>=0||(xe=xe.prevZ,Ee.x>=j&&Ee.x<=Z&&Ee.y>=X&&Ee.y<=se&&Ee!==_&&Ee!==w&&Vl(A,k,I,F,R,V,Ee.x,Ee.y)&&Hi(Ee.prev,Ee,Ee.next)>=0))return!1;Ee=Ee.nextZ}for(;xe&&xe.z>=ue;){if(xe.x>=j&&xe.x<=Z&&xe.y>=X&&xe.y<=se&&xe!==_&&xe!==w&&Vl(A,k,I,F,R,V,xe.x,xe.y)&&Hi(xe.prev,xe,xe.next)>=0)return!1;xe=xe.prevZ}for(;Ee&&Ee.z<=Me;){if(Ee.x>=j&&Ee.x<=Z&&Ee.y>=X&&Ee.y<=se&&Ee!==_&&Ee!==w&&Vl(A,k,I,F,R,V,Ee.x,Ee.y)&&Hi(Ee.prev,Ee,Ee.next)>=0)return!1;Ee=Ee.nextZ}return!0}function RS(c,o){let h=c;do{const f=h.prev,_=h.next.next;!kd(f,_)&&mx(f,h,h.next,_)&&Pu(f,_)&&Pu(_,f)&&(o.push(f.i,h.i,_.i),Mu(h),Mu(h.next),h=c=_),h=h.next}while(h!==c);return Ca(h)}function kS(c,o,h,f,_,b){let w=c;do{let A=w.next.next;for(;A!==w.prev;){if(w.i!==A.i&&BS(w,A)){let I=_x(w,A);return w=Ca(w,w.next),I=Ca(I,I.next),Cu(w,o,h,f,_,b,0),void Cu(I,o,h,f,_,b,0)}A=A.next}w=w.next}while(w!==c)}function DS(c,o){return c.x-o.x}function OS(c,o){const h=(function(_,b){let w=b;const A=_.x,I=_.y;let R,k=-1/0;do{if(I<=w.y&&I>=w.next.y&&w.next.y!==w.y){const Z=w.x+(I-w.y)*(w.next.x-w.x)/(w.next.y-w.y);if(Z<=A&&Z>k&&(k=Z,R=w.x<w.next.x?w:w.next,Z===A))return R}w=w.next}while(w!==b);if(!R)return null;const F=R,V=R.x,j=R.y;let X=1/0;w=R;do{if(A>=w.x&&w.x>=V&&A!==w.x&&Vl(I<j?A:k,I,V,j,I<j?k:A,I,w.x,w.y)){const Z=Math.abs(I-w.y)/(A-w.x);Pu(w,_)&&(Z<X||Z===X&&(w.x>R.x||w.x===R.x&&LS(R,w)))&&(R=w,X=Z)}w=w.next}while(w!==F);return R})(c,o);if(!h)return o;const f=_x(h,c);return Ca(f,f.next),Ca(h,h.next)}function LS(c,o){return Hi(c.prev,c,o.prev)<0&&Hi(o.next,c,c.next)<0}function hg(c,o,h,f,_){return(c=1431655765&((c=858993459&((c=252645135&((c=16711935&((c=(c-h)*_|0)|c<<8))|c<<4))|c<<2))|c<<1))|(o=1431655765&((o=858993459&((o=252645135&((o=16711935&((o=(o-f)*_|0)|o<<8))|o<<4))|o<<2))|o<<1))<<1}function FS(c){let o=c,h=c;do(o.x<h.x||o.x===h.x&&o.y<h.y)&&(h=o),o=o.next;while(o!==c);return h}function Vl(c,o,h,f,_,b,w,A){return(_-w)*(o-A)>=(c-w)*(b-A)&&(c-w)*(f-A)>=(h-w)*(o-A)&&(h-w)*(b-A)>=(_-w)*(f-A)}function BS(c,o){return c.next.i!==o.i&&c.prev.i!==o.i&&!(function(h,f){let _=h;do{if(_.i!==h.i&&_.next.i!==h.i&&_.i!==f.i&&_.next.i!==f.i&&mx(_,_.next,h,f))return!0;_=_.next}while(_!==h);return!1})(c,o)&&(Pu(c,o)&&Pu(o,c)&&(function(h,f){let _=h,b=!1;const w=(h.x+f.x)/2,A=(h.y+f.y)/2;do _.y>A!=_.next.y>A&&_.next.y!==_.y&&w<(_.next.x-_.x)*(A-_.y)/(_.next.y-_.y)+_.x&&(b=!b),_=_.next;while(_!==h);return b})(c,o)&&(Hi(c.prev,c,o.prev)||Hi(c,o.prev,o))||kd(c,o)&&Hi(c.prev,c,c.next)>0&&Hi(o.prev,o,o.next)>0)}function Hi(c,o,h){return(o.y-c.y)*(h.x-o.x)-(o.x-c.x)*(h.y-o.y)}function kd(c,o){return c.x===o.x&&c.y===o.y}function mx(c,o,h,f){const _=Od(Hi(c,o,h)),b=Od(Hi(c,o,f)),w=Od(Hi(h,f,c)),A=Od(Hi(h,f,o));return _!==b&&w!==A||!(_!==0||!Dd(c,h,o))||!(b!==0||!Dd(c,f,o))||!(w!==0||!Dd(h,c,f))||!(A!==0||!Dd(h,o,f))}function Dd(c,o,h){return o.x<=Math.max(c.x,h.x)&&o.x>=Math.min(c.x,h.x)&&o.y<=Math.max(c.y,h.y)&&o.y>=Math.min(c.y,h.y)}function Od(c){return c>0?1:c<0?-1:0}function Pu(c,o){return Hi(c.prev,c,c.next)<0?Hi(c,o,c.next)>=0&&Hi(c,c.prev,o)>=0:Hi(c,o,c.prev)<0||Hi(c,c.next,o)<0}function _x(c,o){const h=dg(c.i,c.x,c.y),f=dg(o.i,o.x,o.y),_=c.next,b=o.prev;return c.next=o,o.prev=c,h.next=_,_.prev=h,f.next=h,h.prev=f,b.next=f,f.prev=b,f}function yx(c,o,h,f){const _=dg(c,o,h);return f?(_.next=f.next,_.prev=f,f.next.prev=_,f.next=_):(_.prev=_,_.next=_),_}function Mu(c){c.next.prev=c.prev,c.prev.next=c.next,c.prevZ&&(c.prevZ.nextZ=c.nextZ),c.nextZ&&(c.nextZ.prevZ=c.prevZ)}function dg(c,o,h){return{i:c,x:o,y:h,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function fg(c,o,h){const f=h.patternDependencies;let _=!1;for(const b of o){const w=b.paint.get(`${c}-pattern`);w.isConstant()||(_=!0);const A=w.constantOr(null);A&&(_=!0,f[A.to]=!0,f[A.from]=!0)}return _}function pg(c,o,h,f,_){const b=_.patternDependencies;for(const w of o){const A=w.paint.get(`${c}-pattern`).value;if(A.kind!=="constant"){let I=A.evaluate({zoom:f-1},h,{},_.availableImages),R=A.evaluate({zoom:f},h,{},_.availableImages),k=A.evaluate({zoom:f+1},h,{},_.availableImages);I=I&&I.name?I.name:I,R=R&&R.name?R.name:R,k=k&&k.name?k.name:k,b[I]=!0,b[R]=!0,b[k]=!0,h.patterns[w.id]={min:I,mid:R,max:k}}}return h}class gg{constructor(o){this.zoom=o.zoom,this.overscaling=o.overscaling,this.layers=o.layers,this.layerIds=this.layers.map((h=>h.id)),this.index=o.index,this.hasPattern=!1,this.patternFeatures=[],this.layoutVertexArray=new Ws,this.indexArray=new Es,this.indexArray2=new cr,this.programConfigurations=new Aa(o.layers,o.zoom),this.segments=new ti,this.segments2=new ti,this.stateDependentLayerIds=this.layers.filter((h=>h.isStateDependent())).map((h=>h.id))}populate(o,h,f){this.hasPattern=fg("fill",this.layers,h);const _=this.layers[0].layout.get("fill-sort-key"),b=!_.isConstant(),w=[];for(const{feature:A,id:I,index:R,sourceLayerIndex:k}of o){const F=this.layers[0]._featureFilter.needGeometry,V=Ia(A,F);if(!this.layers[0]._featureFilter.filter(new Ti(this.zoom),V,f))continue;const j=b?_.evaluate(V,{},f,h.availableImages):void 0,X={id:I,properties:A.properties,type:A.type,sourceLayerIndex:k,index:R,geometry:F?V.geometry:Ea(A),patterns:{},sortKey:j};w.push(X)}b&&w.sort(((A,I)=>A.sortKey-I.sortKey));for(const A of w){const{geometry:I,index:R,sourceLayerIndex:k}=A;if(this.hasPattern){const F=pg("fill",this.layers,A,this.zoom,h);this.patternFeatures.push(F)}else this.addFeature(A,I,R,f,{});h.featureIndex.insert(o[R].feature,I,R,k,this.index)}}update(o,h,f){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(o,h,this.stateDependentLayers,f)}addFeatures(o,h,f){for(const _ of this.patternFeatures)this.addFeature(_,_.geometry,_.index,h,f)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(o){this.uploaded||(this.layoutVertexBuffer=o.createVertexBuffer(this.layoutVertexArray,CS),this.indexBuffer=o.createIndexBuffer(this.indexArray),this.indexBuffer2=o.createIndexBuffer(this.indexArray2)),this.programConfigurations.upload(o),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.indexBuffer2.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.segments2.destroy())}addFeature(o,h,f,_,b){for(const w of hl(h,500)){let A=0;for(const j of w)A+=j.length;const I=this.segments.prepareSegment(A,this.layoutVertexArray,this.indexArray),R=I.vertexLength,k=[],F=[];for(const j of w){if(j.length===0)continue;j!==w[0]&&F.push(k.length/2);const X=this.segments2.prepareSegment(j.length,this.layoutVertexArray,this.indexArray2),Z=X.vertexLength;this.layoutVertexArray.emplaceBack(j[0].x,j[0].y),this.indexArray2.emplaceBack(Z+j.length-1,Z),k.push(j[0].x),k.push(j[0].y);for(let se=1;se<j.length;se++)this.layoutVertexArray.emplaceBack(j[se].x,j[se].y),this.indexArray2.emplaceBack(Z+se-1,Z+se),k.push(j[se].x),k.push(j[se].y);X.vertexLength+=j.length,X.primitiveLength+=j.length}const V=px(k,F);for(let j=0;j<V.length;j+=3)this.indexArray.emplaceBack(R+V[j],R+V[j+1],R+V[j+2]);I.vertexLength+=A,I.primitiveLength+=V.length/3}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,o,f,b,_)}}let xx,vx;vt("FillBucket",gg,{omit:["layers","patternFeatures"]});var NS={get paint(){return vx=vx||new x({"fill-antialias":new St(Ce.paint_fill["fill-antialias"]),"fill-opacity":new Ft(Ce.paint_fill["fill-opacity"]),"fill-color":new Ft(Ce.paint_fill["fill-color"]),"fill-outline-color":new Ft(Ce.paint_fill["fill-outline-color"]),"fill-translate":new St(Ce.paint_fill["fill-translate"]),"fill-translate-anchor":new St(Ce.paint_fill["fill-translate-anchor"]),"fill-pattern":new Rl(Ce.paint_fill["fill-pattern"])})},get layout(){return xx=xx||new x({"fill-sort-key":new Ft(Ce.layout_fill["fill-sort-key"])})}};class zS extends d{constructor(o){super(o,NS)}recalculate(o,h){super.recalculate(o,h);const f=this.paint._values["fill-outline-color"];f.value.kind==="constant"&&f.value.value===void 0&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(o){return new gg(o)}queryRadius(){return Pd(this.paint.get("fill-translate"))}queryIntersectsFeature(o,h,f,_,b,w,A){return ix(Md(o,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),w.angle,A),_)}isTileClipped(){return!0}}const US=E([{name:"a_pos",components:2,type:"Int16"},{name:"a_normal_ed",components:4,type:"Int16"}],4),VS=E([{name:"a_centroid",components:2,type:"Int16"}],4),{members:jS}=US;var Do={},$S=v,bx=jl;function jl(c,o,h,f,_){this.properties={},this.extent=h,this.type=0,this._pbf=c,this._geometry=-1,this._keys=f,this._values=_,c.readFields(WS,this,o)}function WS(c,o,h){c==1?o.id=h.readVarint():c==2?(function(f,_){for(var b=f.readVarint()+f.pos;f.pos<b;){var w=_._keys[f.readVarint()],A=_._values[f.readVarint()];_.properties[w]=A}})(h,o):c==3?o.type=h.readVarint():c==4&&(o._geometry=h.pos)}function HS(c){for(var o,h,f=0,_=0,b=c.length,w=b-1;_<b;w=_++)f+=((h=c[w]).x-(o=c[_]).x)*(o.y+h.y);return f}jl.types=["Unknown","Point","LineString","Polygon"],jl.prototype.loadGeometry=function(){var c=this._pbf;c.pos=this._geometry;for(var o,h=c.readVarint()+c.pos,f=1,_=0,b=0,w=0,A=[];c.pos<h;){if(_<=0){var I=c.readVarint();f=7&I,_=I>>3}if(_--,f===1||f===2)b+=c.readSVarint(),w+=c.readSVarint(),f===1&&(o&&A.push(o),o=[]),o.push(new $S(b,w));else{if(f!==7)throw new Error("unknown command "+f);o&&o.push(o[0].clone())}}return o&&A.push(o),A},jl.prototype.bbox=function(){var c=this._pbf;c.pos=this._geometry;for(var o=c.readVarint()+c.pos,h=1,f=0,_=0,b=0,w=1/0,A=-1/0,I=1/0,R=-1/0;c.pos<o;){if(f<=0){var k=c.readVarint();h=7&k,f=k>>3}if(f--,h===1||h===2)(_+=c.readSVarint())<w&&(w=_),_>A&&(A=_),(b+=c.readSVarint())<I&&(I=b),b>R&&(R=b);else if(h!==7)throw new Error("unknown command "+h)}return[w,I,A,R]},jl.prototype.toGeoJSON=function(c,o,h){var f,_,b=this.extent*Math.pow(2,h),w=this.extent*c,A=this.extent*o,I=this.loadGeometry(),R=jl.types[this.type];function k(j){for(var X=0;X<j.length;X++){var Z=j[X];j[X]=[360*(Z.x+w)/b-180,360/Math.PI*Math.atan(Math.exp((180-360*(Z.y+A)/b)*Math.PI/180))-90]}}switch(this.type){case 1:var F=[];for(f=0;f<I.length;f++)F[f]=I[f][0];k(I=F);break;case 2:for(f=0;f<I.length;f++)k(I[f]);break;case 3:for(I=(function(j){var X=j.length;if(X<=1)return[j];for(var Z,se,ue=[],Me=0;Me<X;Me++){var xe=HS(j[Me]);xe!==0&&(se===void 0&&(se=xe<0),se===xe<0?(Z&&ue.push(Z),Z=[j[Me]]):Z.push(j[Me]))}return Z&&ue.push(Z),ue})(I),f=0;f<I.length;f++)for(_=0;_<I[f].length;_++)k(I[f][_])}I.length===1?I=I[0]:R="Multi"+R;var V={type:"Feature",geometry:{type:R,coordinates:I},properties:this.properties};return"id"in this&&(V.id=this.id),V};var qS=bx,wx=Tx;function Tx(c,o){this.version=1,this.name=null,this.extent=4096,this.length=0,this._pbf=c,this._keys=[],this._values=[],this._features=[],c.readFields(XS,this,o),this.length=this._features.length}function XS(c,o,h){c===15?o.version=h.readVarint():c===1?o.name=h.readString():c===5?o.extent=h.readVarint():c===2?o._features.push(h.pos):c===3?o._keys.push(h.readString()):c===4&&o._values.push((function(f){for(var _=null,b=f.readVarint()+f.pos;f.pos<b;){var w=f.readVarint()>>3;_=w===1?f.readString():w===2?f.readFloat():w===3?f.readDouble():w===4?f.readVarint64():w===5?f.readVarint():w===6?f.readSVarint():w===7?f.readBoolean():null}return _})(h))}Tx.prototype.feature=function(c){if(c<0||c>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[c];var o=this._pbf.readVarint()+this._pbf.pos;return new qS(this._pbf,o,this.extent,this._keys,this._values)};var ZS=wx;function YS(c,o,h){if(c===3){var f=new ZS(h,h.readVarint()+h.pos);f.length&&(o[f.name]=f)}}Do.VectorTile=function(c,o){this.layers=c.readFields(YS,{},o)},Do.VectorTileFeature=bx,Do.VectorTileLayer=wx;const GS=Do.VectorTileFeature.types,mg=Math.pow(2,13);function Ru(c,o,h,f,_,b,w,A){c.emplaceBack(o,h,2*Math.floor(f*mg)+w,_*mg*2,b*mg*2,Math.round(A))}class _g{constructor(o){this.zoom=o.zoom,this.overscaling=o.overscaling,this.layers=o.layers,this.layerIds=this.layers.map((h=>h.id)),this.index=o.index,this.hasPattern=!1,this.layoutVertexArray=new Io,this.centroidVertexArray=new mr,this.indexArray=new Es,this.programConfigurations=new Aa(o.layers,o.zoom),this.segments=new ti,this.stateDependentLayerIds=this.layers.filter((h=>h.isStateDependent())).map((h=>h.id))}populate(o,h,f){this.features=[],this.hasPattern=fg("fill-extrusion",this.layers,h);for(const{feature:_,id:b,index:w,sourceLayerIndex:A}of o){const I=this.layers[0]._featureFilter.needGeometry,R=Ia(_,I);if(!this.layers[0]._featureFilter.filter(new Ti(this.zoom),R,f))continue;const k={id:b,sourceLayerIndex:A,index:w,geometry:I?R.geometry:Ea(_),properties:_.properties,type:_.type,patterns:{}};this.hasPattern?this.features.push(pg("fill-extrusion",this.layers,k,this.zoom,h)):this.addFeature(k,k.geometry,w,f,{}),h.featureIndex.insert(_,k.geometry,w,A,this.index,!0)}}addFeatures(o,h,f){for(const _ of this.features){const{geometry:b}=_;this.addFeature(_,b,_.index,h,f)}}update(o,h,f){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(o,h,this.stateDependentLayers,f)}isEmpty(){return this.layoutVertexArray.length===0&&this.centroidVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(o){this.uploaded||(this.layoutVertexBuffer=o.createVertexBuffer(this.layoutVertexArray,jS),this.centroidVertexBuffer=o.createVertexBuffer(this.centroidVertexArray,VS.members,!0),this.indexBuffer=o.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(o),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.centroidVertexBuffer.destroy())}addFeature(o,h,f,_,b){for(const w of hl(h,500)){const A={x:0,y:0,vertexCount:0};let I=0;for(const X of w)I+=X.length;let R=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray);for(const X of w){if(X.length===0||JS(X))continue;let Z=0;for(let se=0;se<X.length;se++){const ue=X[se];if(se>=1){const Me=X[se-1];if(!KS(ue,Me)){R.vertexLength+4>ti.MAX_VERTEX_ARRAY_LENGTH&&(R=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray));const xe=ue.sub(Me)._perp()._unit(),Ee=Me.dist(ue);Z+Ee>32768&&(Z=0),Ru(this.layoutVertexArray,ue.x,ue.y,xe.x,xe.y,0,0,Z),Ru(this.layoutVertexArray,ue.x,ue.y,xe.x,xe.y,0,1,Z),A.x+=2*ue.x,A.y+=2*ue.y,A.vertexCount+=2,Z+=Ee,Ru(this.layoutVertexArray,Me.x,Me.y,xe.x,xe.y,0,0,Z),Ru(this.layoutVertexArray,Me.x,Me.y,xe.x,xe.y,0,1,Z),A.x+=2*Me.x,A.y+=2*Me.y,A.vertexCount+=2;const Ue=R.vertexLength;this.indexArray.emplaceBack(Ue,Ue+2,Ue+1),this.indexArray.emplaceBack(Ue+1,Ue+2,Ue+3),R.vertexLength+=4,R.primitiveLength+=2}}}}if(R.vertexLength+I>ti.MAX_VERTEX_ARRAY_LENGTH&&(R=this.segments.prepareSegment(I,this.layoutVertexArray,this.indexArray)),GS[o.type]!=="Polygon")continue;const k=[],F=[],V=R.vertexLength;for(const X of w)if(X.length!==0){X!==w[0]&&F.push(k.length/2);for(let Z=0;Z<X.length;Z++){const se=X[Z];Ru(this.layoutVertexArray,se.x,se.y,0,0,1,1,0),A.x+=se.x,A.y+=se.y,A.vertexCount+=1,k.push(se.x),k.push(se.y)}}const j=px(k,F);for(let X=0;X<j.length;X+=3)this.indexArray.emplaceBack(V+j[X],V+j[X+2],V+j[X+1]);R.primitiveLength+=j.length/3,R.vertexLength+=I;for(let X=0;X<A.vertexCount;X++){const Z=Math.floor(A.x/A.vertexCount),se=Math.floor(A.y/A.vertexCount);this.centroidVertexArray.emplaceBack(Z,se)}}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,o,f,b,_)}}function KS(c,o){return c.x===o.x&&(c.x<0||c.x>Yi)||c.y===o.y&&(c.y<0||c.y>Yi)}function JS(c){return c.every((o=>o.x<0))||c.every((o=>o.x>Yi))||c.every((o=>o.y<0))||c.every((o=>o.y>Yi))}let Sx;vt("FillExtrusionBucket",_g,{omit:["layers","features"]});var QS={get paint(){return Sx=Sx||new x({"fill-extrusion-opacity":new St(Ce["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new Ft(Ce["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new St(Ce["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new St(Ce["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new Rl(Ce["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-height":new Ft(Ce["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new Ft(Ce["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-vertical-gradient":new St(Ce["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"])})}};class eA extends d{constructor(o){super(o,QS)}createBucket(o){return new _g(o)}queryRadius(){return Pd(this.paint.get("fill-extrusion-translate"))}is3D(){return!0}queryIntersectsFeature(o,h,f,_,b,w,A,I){const R=Md(o,this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),w.angle,A),k=this.paint.get("fill-extrusion-height").evaluate(h,f),F=this.paint.get("fill-extrusion-base").evaluate(h,f),V=(function(X,Z,se,ue){const Me=[];for(const xe of X){const Ee=[xe.x,xe.y,0,1];Rd(Ee,Ee,Z),Me.push(new S(Ee[0]/Ee[3],Ee[1]/Ee[3]))}return Me})(R,I),j=(function(X,Z,se,ue){const Me=[],xe=[],Ee=ue[8]*Z,Ue=ue[9]*Z,et=ue[10]*Z,mt=ue[11]*Z,Ot=ue[8]*se,pt=ue[9]*se,ut=ue[10]*se,Ct=ue[11]*se;for(const Tt of X){const xt=[],$e=[];for(const Pt of Tt){const It=Pt.x,Vt=Pt.y,_i=ue[0]*It+ue[4]*Vt+ue[12],gi=ue[1]*It+ue[5]*Vt+ue[13],ir=ue[2]*It+ue[6]*Vt+ue[14],Hs=ue[3]*It+ue[7]*Vt+ue[15],xr=ir+et,rr=Hs+mt,Nr=_i+Ot,zr=gi+pt,Ur=ir+ut,ji=Hs+Ct,sr=new S((_i+Ee)/rr,(gi+Ue)/rr);sr.z=xr/rr,xt.push(sr);const Ir=new S(Nr/ji,zr/ji);Ir.z=Ur/ji,$e.push(Ir)}Me.push(xt),xe.push($e)}return[Me,xe]})(_,F,k,I);return(function(X,Z,se){let ue=1/0;ix(se,Z)&&(ue=Ax(se,Z[0]));for(let Me=0;Me<Z.length;Me++){const xe=Z[Me],Ee=X[Me];for(let Ue=0;Ue<xe.length-1;Ue++){const et=xe[Ue],mt=[et,xe[Ue+1],Ee[Ue+1],Ee[Ue],et];tx(se,mt)&&(ue=Math.min(ue,Ax(se,mt)))}}return ue!==1/0&&ue})(j[0],j[1],V)}}function ku(c,o){return c.x*o.x+c.y*o.y}function Ax(c,o){if(c.length===1){let h=0;const f=o[h++];let _;for(;!_||f.equals(_);)if(_=o[h++],!_)return 1/0;for(;h<o.length;h++){const b=o[h],w=c[0],A=_.sub(f),I=b.sub(f),R=w.sub(f),k=ku(A,A),F=ku(A,I),V=ku(I,I),j=ku(R,A),X=ku(R,I),Z=k*V-F*F,se=(V*j-F*X)/Z,ue=(k*X-F*j)/Z,Me=f.z*(1-se-ue)+_.z*se+b.z*ue;if(isFinite(Me))return Me}return 1/0}{let h=1/0;for(const f of o)h=Math.min(h,f.z);return h}}const tA=E([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"}],4),{members:iA}=tA,rA=E([{name:"a_uv_x",components:1,type:"Float32"},{name:"a_split_index",components:1,type:"Float32"}]),{members:sA}=rA,nA=Do.VectorTileFeature.types,oA=Math.cos(Math.PI/180*37.5),Ex=Math.pow(2,14)/.5;class yg{constructor(o){this.zoom=o.zoom,this.overscaling=o.overscaling,this.layers=o.layers,this.layerIds=this.layers.map((h=>h.id)),this.index=o.index,this.hasPattern=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach((h=>{this.gradients[h.id]={}})),this.layoutVertexArray=new Dl,this.layoutVertexArray2=new Co,this.indexArray=new Es,this.programConfigurations=new Aa(o.layers,o.zoom),this.segments=new ti,this.maxLineLength=0,this.stateDependentLayerIds=this.layers.filter((h=>h.isStateDependent())).map((h=>h.id))}populate(o,h,f){this.hasPattern=fg("line",this.layers,h);const _=this.layers[0].layout.get("line-sort-key"),b=!_.isConstant(),w=[];for(const{feature:A,id:I,index:R,sourceLayerIndex:k}of o){const F=this.layers[0]._featureFilter.needGeometry,V=Ia(A,F);if(!this.layers[0]._featureFilter.filter(new Ti(this.zoom),V,f))continue;const j=b?_.evaluate(V,{},f):void 0,X={id:I,properties:A.properties,type:A.type,sourceLayerIndex:k,index:R,geometry:F?V.geometry:Ea(A),patterns:{},sortKey:j};w.push(X)}b&&w.sort(((A,I)=>A.sortKey-I.sortKey));for(const A of w){const{geometry:I,index:R,sourceLayerIndex:k}=A;if(this.hasPattern){const F=pg("line",this.layers,A,this.zoom,h);this.patternFeatures.push(F)}else this.addFeature(A,I,R,f,{});h.featureIndex.insert(o[R].feature,I,R,k,this.index)}}update(o,h,f){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(o,h,this.stateDependentLayers,f)}addFeatures(o,h,f){for(const _ of this.patternFeatures)this.addFeature(_,_.geometry,_.index,h,f)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(o){this.uploaded||(this.layoutVertexArray2.length!==0&&(this.layoutVertexBuffer2=o.createVertexBuffer(this.layoutVertexArray2,sA)),this.layoutVertexBuffer=o.createVertexBuffer(this.layoutVertexArray,iA),this.indexBuffer=o.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(o),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(o){if(o.properties&&Object.prototype.hasOwnProperty.call(o.properties,"mapbox_clip_start")&&Object.prototype.hasOwnProperty.call(o.properties,"mapbox_clip_end"))return{start:+o.properties.mapbox_clip_start,end:+o.properties.mapbox_clip_end}}addFeature(o,h,f,_,b){const w=this.layers[0].layout,A=w.get("line-join").evaluate(o,{}),I=w.get("line-cap"),R=w.get("line-miter-limit"),k=w.get("line-round-limit");this.lineClips=this.lineFeatureClips(o);for(const F of h)this.addLine(F,o,A,I,R,k);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,o,f,b,_)}addLine(o,h,f,_,b,w){if(this.distance=0,this.scaledDistance=0,this.totalDistance=0,this.lineClips){this.lineClipsArray.push(this.lineClips);for(let ue=0;ue<o.length-1;ue++)this.totalDistance+=o[ue].dist(o[ue+1]);this.updateScaledDistance(),this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}const A=nA[h.type]==="Polygon";let I=o.length;for(;I>=2&&o[I-1].equals(o[I-2]);)I--;let R=0;for(;R<I-1&&o[R].equals(o[R+1]);)R++;if(I<(A?3:2))return;f==="bevel"&&(b=1.05);const k=this.overscaling<=16?15*Yi/(512*this.overscaling):0,F=this.segments.prepareSegment(10*I,this.layoutVertexArray,this.indexArray);let V,j,X,Z,se;this.e1=this.e2=-1,A&&(V=o[I-2],se=o[R].sub(V)._unit()._perp());for(let ue=R;ue<I;ue++){if(X=ue===I-1?A?o[R+1]:void 0:o[ue+1],X&&o[ue].equals(X))continue;se&&(Z=se),V&&(j=V),V=o[ue],se=X?X.sub(V)._unit()._perp():Z,Z=Z||se;let Me=Z.add(se);Me.x===0&&Me.y===0||Me._unit();const xe=Z.x*se.x+Z.y*se.y,Ee=Me.x*se.x+Me.y*se.y,Ue=Ee!==0?1/Ee:1/0,et=2*Math.sqrt(2-2*Ee),mt=Ee<oA&&j&&X,Ot=Z.x*se.y-Z.y*se.x>0;if(mt&&ue>R){const Ct=V.dist(j);if(Ct>2*k){const Tt=V.sub(V.sub(j)._mult(k/Ct)._round());this.updateDistance(j,Tt),this.addCurrentVertex(Tt,Z,0,0,F),j=Tt}}const pt=j&&X;let ut=pt?f:A?"butt":_;if(pt&&ut==="round"&&(Ue<w?ut="miter":Ue<=2&&(ut="fakeround")),ut==="miter"&&Ue>b&&(ut="bevel"),ut==="bevel"&&(Ue>2&&(ut="flipbevel"),Ue<b&&(ut="miter")),j&&this.updateDistance(j,V),ut==="miter")Me._mult(Ue),this.addCurrentVertex(V,Me,0,0,F);else if(ut==="flipbevel"){if(Ue>100)Me=se.mult(-1);else{const Ct=Ue*Z.add(se).mag()/Z.sub(se).mag();Me._perp()._mult(Ct*(Ot?-1:1))}this.addCurrentVertex(V,Me,0,0,F),this.addCurrentVertex(V,Me.mult(-1),0,0,F)}else if(ut==="bevel"||ut==="fakeround"){const Ct=-Math.sqrt(Ue*Ue-1),Tt=Ot?Ct:0,xt=Ot?0:Ct;if(j&&this.addCurrentVertex(V,Z,Tt,xt,F),ut==="fakeround"){const $e=Math.round(180*et/Math.PI/20);for(let Pt=1;Pt<$e;Pt++){let It=Pt/$e;if(It!==.5){const _i=It-.5;It+=It*_i*(It-1)*((1.0904+xe*(xe*(3.55645-1.43519*xe)-3.2452))*_i*_i+(.848013+xe*(.215638*xe-1.06021)))}const Vt=se.sub(Z)._mult(It)._add(Z)._unit()._mult(Ot?-1:1);this.addHalfVertex(V,Vt.x,Vt.y,!1,Ot,0,F)}}X&&this.addCurrentVertex(V,se,-Tt,-xt,F)}else if(ut==="butt")this.addCurrentVertex(V,Me,0,0,F);else if(ut==="square"){const Ct=j?1:-1;this.addCurrentVertex(V,Me,Ct,Ct,F)}else ut==="round"&&(j&&(this.addCurrentVertex(V,Z,0,0,F),this.addCurrentVertex(V,Z,1,1,F,!0)),X&&(this.addCurrentVertex(V,se,-1,-1,F,!0),this.addCurrentVertex(V,se,0,0,F)));if(mt&&ue<I-1){const Ct=V.dist(X);if(Ct>2*k){const Tt=V.add(X.sub(V)._mult(k/Ct)._round());this.updateDistance(V,Tt),this.addCurrentVertex(Tt,se,0,0,F),V=Tt}}}}addCurrentVertex(o,h,f,_,b,w=!1){const A=h.y*_-h.x,I=-h.y-h.x*_;this.addHalfVertex(o,h.x+h.y*f,h.y-h.x*f,w,!1,f,b),this.addHalfVertex(o,A,I,w,!0,-_,b),this.distance>Ex/2&&this.totalDistance===0&&(this.distance=0,this.updateScaledDistance(),this.addCurrentVertex(o,h,f,_,b,w))}addHalfVertex({x:o,y:h},f,_,b,w,A,I){const R=.5*(this.lineClips?this.scaledDistance*(Ex-1):this.scaledDistance);this.layoutVertexArray.emplaceBack((o<<1)+(b?1:0),(h<<1)+(w?1:0),Math.round(63*f)+128,Math.round(63*_)+128,1+(A===0?0:A<0?-1:1)|(63&R)<<2,R>>6),this.lineClips&&this.layoutVertexArray2.emplaceBack((this.scaledDistance-this.lineClips.start)/(this.lineClips.end-this.lineClips.start),this.lineClipsArray.length);const k=I.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,k),I.primitiveLength++),w?this.e2=k:this.e1=k}updateScaledDistance(){this.scaledDistance=this.lineClips?this.lineClips.start+(this.lineClips.end-this.lineClips.start)*this.distance/this.totalDistance:this.distance}updateDistance(o,h){this.distance+=o.dist(h),this.updateScaledDistance()}}let Ix,Cx;vt("LineBucket",yg,{omit:["layers","patternFeatures"]});var Px={get paint(){return Cx=Cx||new x({"line-opacity":new Ft(Ce.paint_line["line-opacity"]),"line-color":new Ft(Ce.paint_line["line-color"]),"line-translate":new St(Ce.paint_line["line-translate"]),"line-translate-anchor":new St(Ce.paint_line["line-translate-anchor"]),"line-width":new Ft(Ce.paint_line["line-width"]),"line-gap-width":new Ft(Ce.paint_line["line-gap-width"]),"line-offset":new Ft(Ce.paint_line["line-offset"]),"line-blur":new Ft(Ce.paint_line["line-blur"]),"line-dasharray":new kl(Ce.paint_line["line-dasharray"]),"line-pattern":new Rl(Ce.paint_line["line-pattern"]),"line-gradient":new wu(Ce.paint_line["line-gradient"])})},get layout(){return Ix=Ix||new x({"line-cap":new St(Ce.layout_line["line-cap"]),"line-join":new Ft(Ce.layout_line["line-join"]),"line-miter-limit":new St(Ce.layout_line["line-miter-limit"]),"line-round-limit":new St(Ce.layout_line["line-round-limit"]),"line-sort-key":new Ft(Ce.layout_line["line-sort-key"])})}};class aA extends Ft{possiblyEvaluate(o,h){return h=new Ti(Math.floor(h.zoom),{now:h.now,fadeDuration:h.fadeDuration,zoomHistory:h.zoomHistory,transition:h.transition}),super.possiblyEvaluate(o,h)}evaluate(o,h,f,_){return h=Je({},h,{zoom:Math.floor(h.zoom)}),super.evaluate(o,h,f,_)}}let Ld;class lA extends d{constructor(o){super(o,Px),this.gradientVersion=0,Ld||(Ld=new aA(Px.paint.properties["line-width"].specification),Ld.useIntegerZoom=!0)}_handleSpecialPaintPropertyUpdate(o){if(o==="line-gradient"){const h=this.gradientExpression();this.stepInterpolant=!!(function(f){return f._styleExpression!==void 0})(h)&&h._styleExpression.expression instanceof lo,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}recalculate(o,h){super.recalculate(o,h),this.paint._values["line-floorwidth"]=Ld.possiblyEvaluate(this._transitioningPaint._values["line-width"].value,o)}createBucket(o){return new yg(o)}queryRadius(o){const h=o,f=Mx(Au("line-width",this,h),Au("line-gap-width",this,h)),_=Au("line-offset",this,h);return f/2+Math.abs(_)+Pd(this.paint.get("line-translate"))}queryIntersectsFeature(o,h,f,_,b,w,A){const I=Md(o,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),w.angle,A),R=A/2*Mx(this.paint.get("line-width").evaluate(h,f),this.paint.get("line-gap-width").evaluate(h,f)),k=this.paint.get("line-offset").evaluate(h,f);return k&&(_=(function(F,V){const j=[];for(let X=0;X<F.length;X++){const Z=F[X],se=[];for(let ue=0;ue<Z.length;ue++){const Me=Z[ue-1],xe=Z[ue],Ee=Z[ue+1],Ue=ue===0?new S(0,0):xe.sub(Me)._unit()._perp(),et=ue===Z.length-1?new S(0,0):Ee.sub(xe)._unit()._perp(),mt=Ue._add(et)._unit(),Ot=mt.x*et.x+mt.y*et.y;Ot!==0&&mt._mult(1/Ot),se.push(mt._mult(V)._add(xe))}j.push(se)}return j})(_,k*A)),(function(F,V,j){for(let X=0;X<V.length;X++){const Z=V[X];if(F.length>=3){for(let se=0;se<Z.length;se++)if(zl(F,Z[se]))return!0}if(_S(F,Z,j))return!0}return!1})(I,_,R)}isTileClipped(){return!0}}function Mx(c,o){return o>0?o+2*c:c}const cA=E([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_data",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),uA=E([{name:"a_projected_pos",components:3,type:"Float32"}],4);E([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);const hA=E([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"},{name:"a_box_real",components:2,type:"Int16"}]);E([{type:"Int16",name:"anchorPointX"},{type:"Int16",name:"anchorPointY"},{type:"Int16",name:"x1"},{type:"Int16",name:"y1"},{type:"Int16",name:"x2"},{type:"Int16",name:"y2"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);const Rx=E([{name:"a_pos",components:2,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),dA=E([{name:"a_pos",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);function fA(c,o,h){return c.sections.forEach((f=>{f.text=(function(_,b,w){const A=b.layout.get("text-transform").evaluate(w,{});return A==="uppercase"?_=_.toLocaleUpperCase():A==="lowercase"&&(_=_.toLocaleLowerCase()),es.applyArabicShaping&&(_=es.applyArabicShaping(_)),_})(f.text,o,h)})),c}E([{name:"triangle",components:3,type:"Uint16"}]),E([{type:"Int16",name:"anchorX"},{type:"Int16",name:"anchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"}]),E([{type:"Int16",name:"anchorX"},{type:"Int16",name:"anchorY"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",name:"textBoxScale"},{type:"Float32",name:"collisionCircleDiameter"},{type:"Uint16",name:"textAnchorOffsetStartIndex"},{type:"Uint16",name:"textAnchorOffsetEndIndex"}]),E([{type:"Float32",name:"offsetX"}]),E([{type:"Int16",name:"x"},{type:"Int16",name:"y"},{type:"Int16",name:"tileUnitDistanceFromAnchor"}]),E([{type:"Uint16",name:"textAnchor"},{type:"Float32",components:2,name:"textOffset"}]);const Du={"!":"","#":"",$:"","%":"","&":"","(":"",")":"","*":"","+":"",",":"","-":"",".":"","/":"",":":"",";":"","<":"","=":"",">":"","?":"","@":"","[":"","\\":"","]":"","^":"",_:"","`":"","{":"","|":"","}":"","~":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":""};var Qi=24,kx=pi,Dx=function(c,o,h,f,_){var b,w,A=8*_-f-1,I=(1<<A)-1,R=I>>1,k=-7,F=_-1,V=-1,j=c[o+F];for(F+=V,b=j&(1<<-k)-1,j>>=-k,k+=A;k>0;b=256*b+c[o+F],F+=V,k-=8);for(w=b&(1<<-k)-1,b>>=-k,k+=f;k>0;w=256*w+c[o+F],F+=V,k-=8);if(b===0)b=1-R;else{if(b===I)return w?NaN:1/0*(j?-1:1);w+=Math.pow(2,f),b-=R}return(j?-1:1)*w*Math.pow(2,b-f)},Ox=function(c,o,h,f,_,b){var w,A,I,R=8*b-_-1,k=(1<<R)-1,F=k>>1,V=_===23?Math.pow(2,-24)-Math.pow(2,-77):0,j=0,X=1,Z=o<0||o===0&&1/o<0?1:0;for(o=Math.abs(o),isNaN(o)||o===1/0?(A=isNaN(o)?1:0,w=k):(w=Math.floor(Math.log(o)/Math.LN2),o*(I=Math.pow(2,-w))<1&&(w--,I*=2),(o+=w+F>=1?V/I:V*Math.pow(2,1-F))*I>=2&&(w++,I/=2),w+F>=k?(A=0,w=k):w+F>=1?(A=(o*I-1)*Math.pow(2,_),w+=F):(A=o*Math.pow(2,F-1)*Math.pow(2,_),w=0));_>=8;c[h+j]=255&A,j+=X,A/=256,_-=8);for(w=w<<_|A,R+=_;R>0;c[h+j]=255&w,j+=X,w/=256,R-=8);c[h+j-X]|=128*Z};function pi(c){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(c)?c:new Uint8Array(c||0),this.pos=0,this.type=0,this.length=this.buf.length}pi.Varint=0,pi.Fixed64=1,pi.Bytes=2,pi.Fixed32=5;var xg=4294967296,Lx=1/xg,Fx=typeof TextDecoder>"u"?null:new TextDecoder("utf-8");function Hn(c){return c.type===pi.Bytes?c.readVarint()+c.pos:c.pos+1}function $l(c,o,h){return h?4294967296*o+(c>>>0):4294967296*(o>>>0)+(c>>>0)}function Bx(c,o,h){var f=o<=16383?1:o<=2097151?2:o<=268435455?3:Math.floor(Math.log(o)/(7*Math.LN2));h.realloc(f);for(var _=h.pos-1;_>=c;_--)h.buf[_+f]=h.buf[_]}function pA(c,o){for(var h=0;h<c.length;h++)o.writeVarint(c[h])}function gA(c,o){for(var h=0;h<c.length;h++)o.writeSVarint(c[h])}function mA(c,o){for(var h=0;h<c.length;h++)o.writeFloat(c[h])}function _A(c,o){for(var h=0;h<c.length;h++)o.writeDouble(c[h])}function yA(c,o){for(var h=0;h<c.length;h++)o.writeBoolean(c[h])}function xA(c,o){for(var h=0;h<c.length;h++)o.writeFixed32(c[h])}function vA(c,o){for(var h=0;h<c.length;h++)o.writeSFixed32(c[h])}function bA(c,o){for(var h=0;h<c.length;h++)o.writeFixed64(c[h])}function wA(c,o){for(var h=0;h<c.length;h++)o.writeSFixed64(c[h])}function Fd(c,o){return(c[o]|c[o+1]<<8|c[o+2]<<16)+16777216*c[o+3]}function Wl(c,o,h){c[h]=o,c[h+1]=o>>>8,c[h+2]=o>>>16,c[h+3]=o>>>24}function Nx(c,o){return(c[o]|c[o+1]<<8|c[o+2]<<16)+(c[o+3]<<24)}pi.prototype={destroy:function(){this.buf=null},readFields:function(c,o,h){for(h=h||this.length;this.pos<h;){var f=this.readVarint(),_=f>>3,b=this.pos;this.type=7&f,c(_,o,this),this.pos===b&&this.skip(f)}return o},readMessage:function(c,o){return this.readFields(c,o,this.readVarint()+this.pos)},readFixed32:function(){var c=Fd(this.buf,this.pos);return this.pos+=4,c},readSFixed32:function(){var c=Nx(this.buf,this.pos);return this.pos+=4,c},readFixed64:function(){var c=Fd(this.buf,this.pos)+Fd(this.buf,this.pos+4)*xg;return this.pos+=8,c},readSFixed64:function(){var c=Fd(this.buf,this.pos)+Nx(this.buf,this.pos+4)*xg;return this.pos+=8,c},readFloat:function(){var c=Dx(this.buf,this.pos,!0,23,4);return this.pos+=4,c},readDouble:function(){var c=Dx(this.buf,this.pos,!0,52,8);return this.pos+=8,c},readVarint:function(c){var o,h,f=this.buf;return o=127&(h=f[this.pos++]),h<128?o:(o|=(127&(h=f[this.pos++]))<<7,h<128?o:(o|=(127&(h=f[this.pos++]))<<14,h<128?o:(o|=(127&(h=f[this.pos++]))<<21,h<128?o:(function(_,b,w){var A,I,R=w.buf;if(A=(112&(I=R[w.pos++]))>>4,I<128||(A|=(127&(I=R[w.pos++]))<<3,I<128)||(A|=(127&(I=R[w.pos++]))<<10,I<128)||(A|=(127&(I=R[w.pos++]))<<17,I<128)||(A|=(127&(I=R[w.pos++]))<<24,I<128)||(A|=(1&(I=R[w.pos++]))<<31,I<128))return $l(_,A,b);throw new Error("Expected varint not more than 10 bytes")})(o|=(15&(h=f[this.pos]))<<28,c,this))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var c=this.readVarint();return c%2==1?(c+1)/-2:c/2},readBoolean:function(){return!!this.readVarint()},readString:function(){var c=this.readVarint()+this.pos,o=this.pos;return this.pos=c,c-o>=12&&Fx?(function(h,f,_){return Fx.decode(h.subarray(f,_))})(this.buf,o,c):(function(h,f,_){for(var b="",w=f;w<_;){var A,I,R,k=h[w],F=null,V=k>239?4:k>223?3:k>191?2:1;if(w+V>_)break;V===1?k<128&&(F=k):V===2?(192&(A=h[w+1]))==128&&(F=(31&k)<<6|63&A)<=127&&(F=null):V===3?(I=h[w+2],(192&(A=h[w+1]))==128&&(192&I)==128&&((F=(15&k)<<12|(63&A)<<6|63&I)<=2047||F>=55296&&F<=57343)&&(F=null)):V===4&&(I=h[w+2],R=h[w+3],(192&(A=h[w+1]))==128&&(192&I)==128&&(192&R)==128&&((F=(15&k)<<18|(63&A)<<12|(63&I)<<6|63&R)<=65535||F>=1114112)&&(F=null)),F===null?(F=65533,V=1):F>65535&&(F-=65536,b+=String.fromCharCode(F>>>10&1023|55296),F=56320|1023&F),b+=String.fromCharCode(F),w+=V}return b})(this.buf,o,c)},readBytes:function(){var c=this.readVarint()+this.pos,o=this.buf.subarray(this.pos,c);return this.pos=c,o},readPackedVarint:function(c,o){if(this.type!==pi.Bytes)return c.push(this.readVarint(o));var h=Hn(this);for(c=c||[];this.pos<h;)c.push(this.readVarint(o));return c},readPackedSVarint:function(c){if(this.type!==pi.Bytes)return c.push(this.readSVarint());var o=Hn(this);for(c=c||[];this.pos<o;)c.push(this.readSVarint());return c},readPackedBoolean:function(c){if(this.type!==pi.Bytes)return c.push(this.readBoolean());var o=Hn(this);for(c=c||[];this.pos<o;)c.push(this.readBoolean());return c},readPackedFloat:function(c){if(this.type!==pi.Bytes)return c.push(this.readFloat());var o=Hn(this);for(c=c||[];this.pos<o;)c.push(this.readFloat());return c},readPackedDouble:function(c){if(this.type!==pi.Bytes)return c.push(this.readDouble());var o=Hn(this);for(c=c||[];this.pos<o;)c.push(this.readDouble());return c},readPackedFixed32:function(c){if(this.type!==pi.Bytes)return c.push(this.readFixed32());var o=Hn(this);for(c=c||[];this.pos<o;)c.push(this.readFixed32());return c},readPackedSFixed32:function(c){if(this.type!==pi.Bytes)return c.push(this.readSFixed32());var o=Hn(this);for(c=c||[];this.pos<o;)c.push(this.readSFixed32());return c},readPackedFixed64:function(c){if(this.type!==pi.Bytes)return c.push(this.readFixed64());var o=Hn(this);for(c=c||[];this.pos<o;)c.push(this.readFixed64());return c},readPackedSFixed64:function(c){if(this.type!==pi.Bytes)return c.push(this.readSFixed64());var o=Hn(this);for(c=c||[];this.pos<o;)c.push(this.readSFixed64());return c},skip:function(c){var o=7&c;if(o===pi.Varint)for(;this.buf[this.pos++]>127;);else if(o===pi.Bytes)this.pos=this.readVarint()+this.pos;else if(o===pi.Fixed32)this.pos+=4;else{if(o!==pi.Fixed64)throw new Error("Unimplemented type: "+o);this.pos+=8}},writeTag:function(c,o){this.writeVarint(c<<3|o)},realloc:function(c){for(var o=this.length||16;o<this.pos+c;)o*=2;if(o!==this.length){var h=new Uint8Array(o);h.set(this.buf),this.buf=h,this.length=o}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(c){this.realloc(4),Wl(this.buf,c,this.pos),this.pos+=4},writeSFixed32:function(c){this.realloc(4),Wl(this.buf,c,this.pos),this.pos+=4},writeFixed64:function(c){this.realloc(8),Wl(this.buf,-1&c,this.pos),Wl(this.buf,Math.floor(c*Lx),this.pos+4),this.pos+=8},writeSFixed64:function(c){this.realloc(8),Wl(this.buf,-1&c,this.pos),Wl(this.buf,Math.floor(c*Lx),this.pos+4),this.pos+=8},writeVarint:function(c){(c=+c||0)>268435455||c<0?(function(o,h){var f,_;if(o>=0?(f=o%4294967296|0,_=o/4294967296|0):(_=~(-o/4294967296),4294967295^(f=~(-o%4294967296))?f=f+1|0:(f=0,_=_+1|0)),o>=18446744073709552e3||o<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");h.realloc(10),(function(b,w,A){A.buf[A.pos++]=127&b|128,b>>>=7,A.buf[A.pos++]=127&b|128,b>>>=7,A.buf[A.pos++]=127&b|128,b>>>=7,A.buf[A.pos++]=127&b|128,A.buf[A.pos]=127&(b>>>=7)})(f,0,h),(function(b,w){var A=(7&b)<<4;w.buf[w.pos++]|=A|((b>>>=3)?128:0),b&&(w.buf[w.pos++]=127&b|((b>>>=7)?128:0),b&&(w.buf[w.pos++]=127&b|((b>>>=7)?128:0),b&&(w.buf[w.pos++]=127&b|((b>>>=7)?128:0),b&&(w.buf[w.pos++]=127&b|((b>>>=7)?128:0),b&&(w.buf[w.pos++]=127&b)))))})(_,h)})(c,this):(this.realloc(4),this.buf[this.pos++]=127&c|(c>127?128:0),c<=127||(this.buf[this.pos++]=127&(c>>>=7)|(c>127?128:0),c<=127||(this.buf[this.pos++]=127&(c>>>=7)|(c>127?128:0),c<=127||(this.buf[this.pos++]=c>>>7&127))))},writeSVarint:function(c){this.writeVarint(c<0?2*-c-1:2*c)},writeBoolean:function(c){this.writeVarint(!!c)},writeString:function(c){c=String(c),this.realloc(4*c.length),this.pos++;var o=this.pos;this.pos=(function(f,_,b){for(var w,A,I=0;I<_.length;I++){if((w=_.charCodeAt(I))>55295&&w<57344){if(!A){w>56319||I+1===_.length?(f[b++]=239,f[b++]=191,f[b++]=189):A=w;continue}if(w<56320){f[b++]=239,f[b++]=191,f[b++]=189,A=w;continue}w=A-55296<<10|w-56320|65536,A=null}else A&&(f[b++]=239,f[b++]=191,f[b++]=189,A=null);w<128?f[b++]=w:(w<2048?f[b++]=w>>6|192:(w<65536?f[b++]=w>>12|224:(f[b++]=w>>18|240,f[b++]=w>>12&63|128),f[b++]=w>>6&63|128),f[b++]=63&w|128)}return b})(this.buf,c,this.pos);var h=this.pos-o;h>=128&&Bx(o,h,this),this.pos=o-1,this.writeVarint(h),this.pos+=h},writeFloat:function(c){this.realloc(4),Ox(this.buf,c,this.pos,!0,23,4),this.pos+=4},writeDouble:function(c){this.realloc(8),Ox(this.buf,c,this.pos,!0,52,8),this.pos+=8},writeBytes:function(c){var o=c.length;this.writeVarint(o),this.realloc(o);for(var h=0;h<o;h++)this.buf[this.pos++]=c[h]},writeRawMessage:function(c,o){this.pos++;var h=this.pos;c(o,this);var f=this.pos-h;f>=128&&Bx(h,f,this),this.pos=h-1,this.writeVarint(f),this.pos+=f},writeMessage:function(c,o,h){this.writeTag(c,pi.Bytes),this.writeRawMessage(o,h)},writePackedVarint:function(c,o){o.length&&this.writeMessage(c,pA,o)},writePackedSVarint:function(c,o){o.length&&this.writeMessage(c,gA,o)},writePackedBoolean:function(c,o){o.length&&this.writeMessage(c,yA,o)},writePackedFloat:function(c,o){o.length&&this.writeMessage(c,mA,o)},writePackedDouble:function(c,o){o.length&&this.writeMessage(c,_A,o)},writePackedFixed32:function(c,o){o.length&&this.writeMessage(c,xA,o)},writePackedSFixed32:function(c,o){o.length&&this.writeMessage(c,vA,o)},writePackedFixed64:function(c,o){o.length&&this.writeMessage(c,bA,o)},writePackedSFixed64:function(c,o){o.length&&this.writeMessage(c,wA,o)},writeBytesField:function(c,o){this.writeTag(c,pi.Bytes),this.writeBytes(o)},writeFixed32Field:function(c,o){this.writeTag(c,pi.Fixed32),this.writeFixed32(o)},writeSFixed32Field:function(c,o){this.writeTag(c,pi.Fixed32),this.writeSFixed32(o)},writeFixed64Field:function(c,o){this.writeTag(c,pi.Fixed64),this.writeFixed64(o)},writeSFixed64Field:function(c,o){this.writeTag(c,pi.Fixed64),this.writeSFixed64(o)},writeVarintField:function(c,o){this.writeTag(c,pi.Varint),this.writeVarint(o)},writeSVarintField:function(c,o){this.writeTag(c,pi.Varint),this.writeSVarint(o)},writeStringField:function(c,o){this.writeTag(c,pi.Bytes),this.writeString(o)},writeFloatField:function(c,o){this.writeTag(c,pi.Fixed32),this.writeFloat(o)},writeDoubleField:function(c,o){this.writeTag(c,pi.Fixed64),this.writeDouble(o)},writeBooleanField:function(c,o){this.writeVarintField(c,!!o)}};var vg=g(kx);const bg=3;function TA(c,o,h){c===1&&h.readMessage(SA,o)}function SA(c,o,h){if(c===3){const{id:f,bitmap:_,width:b,height:w,left:A,top:I,advance:R}=h.readMessage(AA,{});o.push({id:f,bitmap:new Iu({width:b+2*bg,height:w+2*bg},_),metrics:{width:b,height:w,left:A,top:I,advance:R}})}}function AA(c,o,h){c===1?o.id=h.readVarint():c===2?o.bitmap=h.readBytes():c===3?o.width=h.readVarint():c===4?o.height=h.readVarint():c===5?o.left=h.readSVarint():c===6?o.top=h.readSVarint():c===7&&(o.advance=h.readVarint())}const zx=bg;function Ux(c){let o=0,h=0;for(const w of c)o+=w.w*w.h,h=Math.max(h,w.w);c.sort(((w,A)=>A.h-w.h));const f=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(o/.95)),h),h:1/0}];let _=0,b=0;for(const w of c)for(let A=f.length-1;A>=0;A--){const I=f[A];if(!(w.w>I.w||w.h>I.h)){if(w.x=I.x,w.y=I.y,b=Math.max(b,w.y+w.h),_=Math.max(_,w.x+w.w),w.w===I.w&&w.h===I.h){const R=f.pop();A<f.length&&(f[A]=R)}else w.h===I.h?(I.x+=w.w,I.w-=w.w):w.w===I.w?(I.y+=w.h,I.h-=w.h):(f.push({x:I.x+w.w,y:I.y,w:I.w-w.w,h:w.h}),I.y+=w.h,I.h-=w.h);break}}return{w:_,h:b,fill:o/(_*b)||0}}const is=1;class wg{constructor(o,{pixelRatio:h,version:f,stretchX:_,stretchY:b,content:w,textFitWidth:A,textFitHeight:I}){this.paddedRect=o,this.pixelRatio=h,this.stretchX=_,this.stretchY=b,this.content=w,this.version=f,this.textFitWidth=A,this.textFitHeight=I}get tl(){return[this.paddedRect.x+is,this.paddedRect.y+is]}get br(){return[this.paddedRect.x+this.paddedRect.w-is,this.paddedRect.y+this.paddedRect.h-is]}get tlbr(){return this.tl.concat(this.br)}get displaySize(){return[(this.paddedRect.w-2*is)/this.pixelRatio,(this.paddedRect.h-2*is)/this.pixelRatio]}}class Vx{constructor(o,h){const f={},_={};this.haveRenderCallbacks=[];const b=[];this.addImages(o,f,b),this.addImages(h,_,b);const{w,h:A}=Ux(b),I=new Is({width:w||1,height:A||1});for(const R in o){const k=o[R],F=f[R].paddedRect;Is.copy(k.data,I,{x:0,y:0},{x:F.x+is,y:F.y+is},k.data)}for(const R in h){const k=h[R],F=_[R].paddedRect,V=F.x+is,j=F.y+is,X=k.data.width,Z=k.data.height;Is.copy(k.data,I,{x:0,y:0},{x:V,y:j},k.data),Is.copy(k.data,I,{x:0,y:Z-1},{x:V,y:j-1},{width:X,height:1}),Is.copy(k.data,I,{x:0,y:0},{x:V,y:j+Z},{width:X,height:1}),Is.copy(k.data,I,{x:X-1,y:0},{x:V-1,y:j},{width:1,height:Z}),Is.copy(k.data,I,{x:0,y:0},{x:V+X,y:j},{width:1,height:Z})}this.image=I,this.iconPositions=f,this.patternPositions=_}addImages(o,h,f){for(const _ in o){const b=o[_],w={x:0,y:0,w:b.data.width+2*is,h:b.data.height+2*is};f.push(w),h[_]=new wg(w,b),b.hasRenderCallback&&this.haveRenderCallbacks.push(_)}}patchUpdatedImages(o,h){o.dispatchRenderCallbacks(this.haveRenderCallbacks);for(const f in o.updatedImages)this.patchUpdatedImage(this.iconPositions[f],o.getImage(f),h),this.patchUpdatedImage(this.patternPositions[f],o.getImage(f),h)}patchUpdatedImage(o,h,f){if(!o||!h||o.version===h.version)return;o.version=h.version;const[_,b]=o.tl;f.update(h.data,void 0,{x:_,y:b})}}var Oo;vt("ImagePosition",wg),vt("ImageAtlas",Vx),u.ah=void 0,(Oo=u.ah||(u.ah={}))[Oo.none=0]="none",Oo[Oo.horizontal=1]="horizontal",Oo[Oo.vertical=2]="vertical",Oo[Oo.horizontalOnly=3]="horizontalOnly";const Ou=-17;class Lu{constructor(){this.scale=1,this.fontStack="",this.imageName=null}static forText(o,h){const f=new Lu;return f.scale=o||1,f.fontStack=h,f}static forImage(o){const h=new Lu;return h.imageName=o,h}}class Hl{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(o,h){const f=new Hl;for(let _=0;_<o.sections.length;_++){const b=o.sections[_];b.image?f.addImageSection(b):f.addTextSection(b,h)}return f}length(){return this.text.length}getSection(o){return this.sections[this.sectionIndex[o]]}getSectionIndex(o){return this.sectionIndex[o]}getCharCode(o){return this.text.charCodeAt(o)}verticalizePunctuation(){this.text=(function(o){let h="";for(let f=0;f<o.length;f++){const _=o.charCodeAt(f+1)||null,b=o.charCodeAt(f-1)||null;h+=_&&wd(_)&&!Du[o[f+1]]||b&&wd(b)&&!Du[o[f-1]]||!Du[o[f]]?o[f]:Du[o[f]]}return h})(this.text)}trim(){let o=0;for(let f=0;f<this.text.length&&Nd[this.text.charCodeAt(f)];f++)o++;let h=this.text.length;for(let f=this.text.length-1;f>=0&&f>=o&&Nd[this.text.charCodeAt(f)];f--)h--;this.text=this.text.substring(o,h),this.sectionIndex=this.sectionIndex.slice(o,h)}substring(o,h){const f=new Hl;return f.text=this.text.substring(o,h),f.sectionIndex=this.sectionIndex.slice(o,h),f.sections=this.sections,f}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce(((o,h)=>Math.max(o,this.sections[h].scale)),0)}addTextSection(o,h){this.text+=o.text,this.sections.push(Lu.forText(o.scale,o.fontStack||h));const f=this.sections.length-1;for(let _=0;_<o.text.length;++_)this.sectionIndex.push(f)}addImageSection(o){const h=o.image?o.image.name:"";if(h.length===0)return void Ke("Can't add FormattedSection with an empty image.");const f=this.getNextImageSectionCharCode();f?(this.text+=String.fromCharCode(f),this.sections.push(Lu.forImage(h)),this.sectionIndex.push(this.sections.length-1)):Ke("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function Bd(c,o,h,f,_,b,w,A,I,R,k,F,V,j,X){const Z=Hl.fromFeature(c,_);let se;F===u.ah.vertical&&Z.verticalizePunctuation();const{processBidirectionalText:ue,processStyledBidirectionalText:Me}=es;if(ue&&Z.sections.length===1){se=[];const Ue=ue(Z.toString(),Tg(Z,R,b,o,f,j));for(const et of Ue){const mt=new Hl;mt.text=et,mt.sections=Z.sections;for(let Ot=0;Ot<et.length;Ot++)mt.sectionIndex.push(0);se.push(mt)}}else if(Me){se=[];const Ue=Me(Z.text,Z.sectionIndex,Tg(Z,R,b,o,f,j));for(const et of Ue){const mt=new Hl;mt.text=et[0],mt.sectionIndex=et[1],mt.sections=Z.sections,se.push(mt)}}else se=(function(Ue,et){const mt=[],Ot=Ue.text;let pt=0;for(const ut of et)mt.push(Ue.substring(pt,ut)),pt=ut;return pt<Ot.length&&mt.push(Ue.substring(pt,Ot.length)),mt})(Z,Tg(Z,R,b,o,f,j));const xe=[],Ee={positionedLines:xe,text:Z.toString(),top:k[1],bottom:k[1],left:k[0],right:k[0],writingMode:F,iconsInText:!1,verticalizable:!1};return(function(Ue,et,mt,Ot,pt,ut,Ct,Tt,xt,$e,Pt,It){let Vt=0,_i=Ou,gi=0,ir=0;const Hs=Tt==="right"?1:Tt==="left"?0:.5;let xr=0;for(const ji of pt){ji.trim();const sr=ji.getMaxScale(),Ir=(sr-1)*Qi,vr={positionedGlyphs:[],lineOffset:0};Ue.positionedLines[xr]=vr;const Vr=vr.positionedGlyphs;let br=0;if(!ji.length()){_i+=ut,++xr;continue}for(let rs=0;rs<ji.length();rs++){const ai=ji.getSection(rs),vi=ji.getSectionIndex(rs),Ii=ji.getCharCode(rs);let gs=0,Ni=null,Yl=null,_n=null,yn=Qi;const qs=!(xt===u.ah.horizontal||!Pt&&!vu(Ii)||Pt&&(Nd[Ii]||(rr=Ii,/\p{sc=Arab}/u.test(String.fromCodePoint(rr)))));if(ai.imageName){const Ms=Ot[ai.imageName];if(!Ms)continue;_n=ai.imageName,Ue.iconsInText=Ue.iconsInText||!0,Yl=Ms.paddedRect;const ur=Ms.displaySize;ai.scale=ai.scale*Qi/It,Ni={width:ur[0],height:ur[1],left:is,top:-zx,advance:qs?ur[1]:ur[0]},gs=Ir+(Qi-ur[1]*ai.scale),yn=Ni.advance;const qn=qs?ur[0]*ai.scale-Qi*sr:ur[1]*ai.scale-Qi*sr;qn>0&&qn>br&&(br=qn)}else{const Ms=mt[ai.fontStack],ur=Ms&&Ms[Ii];if(ur&&ur.rect)Yl=ur.rect,Ni=ur.metrics;else{const qn=et[ai.fontStack],Vu=qn&&qn[Ii];if(!Vu)continue;Ni=Vu.metrics}gs=(sr-ai.scale)*Qi}qs?(Ue.verticalizable=!0,Vr.push({glyph:Ii,imageName:_n,x:Vt,y:_i+gs,vertical:qs,scale:ai.scale,fontStack:ai.fontStack,sectionIndex:vi,metrics:Ni,rect:Yl}),Vt+=yn*ai.scale+$e):(Vr.push({glyph:Ii,imageName:_n,x:Vt,y:_i+gs,vertical:qs,scale:ai.scale,fontStack:ai.fontStack,sectionIndex:vi,metrics:Ni,rect:Yl}),Vt+=Ni.advance*ai.scale+$e)}Vr.length!==0&&(gi=Math.max(Vt-$e,gi),PA(Vr,0,Vr.length-1,Hs,br)),Vt=0;const Ps=ut*sr+br;vr.lineOffset=Math.max(br,Ir),_i+=Ps,ir=Math.max(Ps,ir),++xr}var rr;const Nr=_i-Ou,{horizontalAlign:zr,verticalAlign:Ur}=Sg(Ct);(function(ji,sr,Ir,vr,Vr,br,Ps,rs,ai){const vi=(sr-Ir)*Vr;let Ii=0;Ii=br!==Ps?-rs*vr-Ou:(-vr*ai+.5)*Ps;for(const gs of ji)for(const Ni of gs.positionedGlyphs)Ni.x+=vi,Ni.y+=Ii})(Ue.positionedLines,Hs,zr,Ur,gi,ir,ut,Nr,pt.length),Ue.top+=-Ur*Nr,Ue.bottom=Ue.top+Nr,Ue.left+=-zr*gi,Ue.right=Ue.left+gi})(Ee,o,h,f,se,w,A,I,F,R,V,X),!(function(Ue){for(const et of Ue)if(et.positionedGlyphs.length!==0)return!1;return!0})(xe)&&Ee}const Nd={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},EA={10:!0,32:!0,38:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0},IA={40:!0};function jx(c,o,h,f,_,b){if(o.imageName){const w=f[o.imageName];return w?w.displaySize[0]*o.scale*Qi/b+_:0}{const w=h[o.fontStack],A=w&&w[c];return A?A.metrics.advance*o.scale+_:0}}function $x(c,o,h,f){const _=Math.pow(c-o,2);return f?c<o?_/2:2*_:_+Math.abs(h)*h}function CA(c,o,h){let f=0;return c===10&&(f-=1e4),h&&(f+=150),c!==40&&c!==65288||(f+=50),o!==41&&o!==65289||(f+=50),f}function Wx(c,o,h,f,_,b){let w=null,A=$x(o,h,_,b);for(const I of f){const R=$x(o-I.x,h,_,b)+I.badness;R<=A&&(w=I,A=R)}return{index:c,x:o,priorBreak:w,badness:A}}function Hx(c){return c?Hx(c.priorBreak).concat(c.index):[]}function Tg(c,o,h,f,_,b){if(!c)return[];const w=[],A=(function(F,V,j,X,Z,se){let ue=0;for(let Me=0;Me<F.length();Me++){const xe=F.getSection(Me);ue+=jx(F.getCharCode(Me),xe,X,Z,V,se)}return ue/Math.max(1,Math.ceil(ue/j))})(c,o,h,f,_,b),I=c.text.indexOf("")>=0;let R=0;for(let F=0;F<c.length();F++){const V=c.getSection(F),j=c.getCharCode(F);if(Nd[j]||(R+=jx(j,V,f,_,o,b)),F<c.length()-1){const X=!((k=j)<11904)&&(!!ei["CJK Compatibility Forms"](k)||!!ei["CJK Compatibility"](k)||!!ei["CJK Strokes"](k)||!!ei["CJK Symbols and Punctuation"](k)||!!ei["Enclosed CJK Letters and Months"](k)||!!ei["Halfwidth and Fullwidth Forms"](k)||!!ei["Ideographic Description Characters"](k)||!!ei["Vertical Forms"](k)||bd.test(String.fromCodePoint(k)));(EA[j]||X||V.imageName||F!==c.length()-2&&IA[c.getCharCode(F+1)])&&w.push(Wx(F+1,R,A,w,CA(j,c.getCharCode(F+1),X&&I),!1))}}var k;return Hx(Wx(c.length(),R,A,w,0,!0))}function Sg(c){let o=.5,h=.5;switch(c){case"right":case"top-right":case"bottom-right":o=1;break;case"left":case"top-left":case"bottom-left":o=0}switch(c){case"bottom":case"bottom-right":case"bottom-left":h=1;break;case"top":case"top-right":case"top-left":h=0}return{horizontalAlign:o,verticalAlign:h}}function PA(c,o,h,f,_){if(!f&&!_)return;const b=c[h],w=(c[h].x+b.metrics.advance*b.scale)*f;for(let A=o;A<=h;A++)c[A].x-=w,c[A].y+=_}function MA(c,o,h){const{horizontalAlign:f,verticalAlign:_}=Sg(h),b=o[0]-c.displaySize[0]*f,w=o[1]-c.displaySize[1]*_;return{image:c,top:w,bottom:w+c.displaySize[1],left:b,right:b+c.displaySize[0]}}function qx(c){var o,h;let f=c.left,_=c.top,b=c.right-f,w=c.bottom-_;const A=(o=c.image.textFitWidth)!==null&&o!==void 0?o:"stretchOrShrink",I=(h=c.image.textFitHeight)!==null&&h!==void 0?h:"stretchOrShrink",R=(c.image.content[2]-c.image.content[0])/(c.image.content[3]-c.image.content[1]);if(I==="proportional"){if(A==="stretchOnly"&&b/w<R||A==="proportional"){const k=Math.ceil(w*R);f*=k/b,b=k}}else if(A==="proportional"&&I==="stretchOnly"&&R!==0&&b/w>R){const k=Math.ceil(b/R);_*=k/w,w=k}return{x1:f,y1:_,x2:f+b,y2:_+w}}function Xx(c,o,h,f,_,b){const w=c.image;let A;if(w.content){const se=w.content,ue=w.pixelRatio||1;A=[se[0]/ue,se[1]/ue,w.displaySize[0]-se[2]/ue,w.displaySize[1]-se[3]/ue]}const I=o.left*b,R=o.right*b;let k,F,V,j;h==="width"||h==="both"?(j=_[0]+I-f[3],F=_[0]+R+f[1]):(j=_[0]+(I+R-w.displaySize[0])/2,F=j+w.displaySize[0]);const X=o.top*b,Z=o.bottom*b;return h==="height"||h==="both"?(k=_[1]+X-f[0],V=_[1]+Z+f[2]):(k=_[1]+(X+Z-w.displaySize[1])/2,V=k+w.displaySize[1]),{image:w,top:k,right:F,bottom:V,left:j,collisionPadding:A}}const Fu=255,mn=128,Lo=Fu*mn;function Zx(c,o){const{expression:h}=o;if(h.kind==="constant")return{kind:"constant",layoutSize:h.evaluate(new Ti(c+1))};if(h.kind==="source")return{kind:"source"};{const{zoomStops:f,interpolationType:_}=h;let b=0;for(;b<f.length&&f[b]<=c;)b++;b=Math.max(0,b-1);let w=b;for(;w<f.length&&f[w]<c+1;)w++;w=Math.min(f.length-1,w);const A=f[b],I=f[w];return h.kind==="composite"?{kind:"composite",minZoom:A,maxZoom:I,interpolationType:_}:{kind:"camera",minZoom:A,maxZoom:I,minSize:h.evaluate(new Ti(A)),maxSize:h.evaluate(new Ti(I)),interpolationType:_}}}function Ag(c,o,h){let f="never";const _=c.get(o);return _?f=_:c.get(h)&&(f="always"),f}const RA=Do.VectorTileFeature.types,kA=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function zd(c,o,h,f,_,b,w,A,I,R,k,F,V){const j=A?Math.min(Lo,Math.round(A[0])):0,X=A?Math.min(Lo,Math.round(A[1])):0;c.emplaceBack(o,h,Math.round(32*f),Math.round(32*_),b,w,(j<<1)+(I?1:0),X,16*R,16*k,256*F,256*V)}function Eg(c,o,h){c.emplaceBack(o.x,o.y,h),c.emplaceBack(o.x,o.y,h),c.emplaceBack(o.x,o.y,h),c.emplaceBack(o.x,o.y,h)}function DA(c){for(const o of c.sections)if(eg(o.text))return!0;return!1}class Ig{constructor(o){this.layoutVertexArray=new Ol,this.indexArray=new Es,this.programConfigurations=o,this.segments=new ti,this.dynamicLayoutVertexArray=new Tu,this.opacityVertexArray=new fs,this.hasVisibleVertices=!1,this.placedSymbolArray=new Si}isEmpty(){return this.layoutVertexArray.length===0&&this.indexArray.length===0&&this.dynamicLayoutVertexArray.length===0&&this.opacityVertexArray.length===0}upload(o,h,f,_){this.isEmpty()||(f&&(this.layoutVertexBuffer=o.createVertexBuffer(this.layoutVertexArray,cA.members),this.indexBuffer=o.createIndexBuffer(this.indexArray,h),this.dynamicLayoutVertexBuffer=o.createVertexBuffer(this.dynamicLayoutVertexArray,uA.members,!0),this.opacityVertexBuffer=o.createVertexBuffer(this.opacityVertexArray,kA,!0),this.opacityVertexBuffer.itemSize=1),(f||_)&&this.programConfigurations.upload(o))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy())}}vt("SymbolBuffers",Ig);class Cg{constructor(o,h,f){this.layoutVertexArray=new o,this.layoutAttributes=h,this.indexArray=new f,this.segments=new ti,this.collisionVertexArray=new pn}upload(o){this.layoutVertexBuffer=o.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=o.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=o.createVertexBuffer(this.collisionVertexArray,hA.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy())}}vt("CollisionBuffers",Cg);class ql{constructor(o){this.collisionBoxArray=o.collisionBoxArray,this.zoom=o.zoom,this.overscaling=o.overscaling,this.layers=o.layers,this.layerIds=this.layers.map((w=>w.id)),this.index=o.index,this.pixelRatio=o.pixelRatio,this.sourceLayerIndex=o.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.sortKeyRanges=[],this.collisionCircleArray=[],this.placementInvProjMatrix=ag([]),this.placementViewportMatrix=ag([]);const h=this.layers[0]._unevaluatedLayout._values;this.textSizeData=Zx(this.zoom,h["text-size"]),this.iconSizeData=Zx(this.zoom,h["icon-size"]);const f=this.layers[0].layout,_=f.get("symbol-sort-key"),b=f.get("symbol-z-order");this.canOverlap=Ag(f,"text-overlap","text-allow-overlap")!=="never"||Ag(f,"icon-overlap","icon-allow-overlap")!=="never"||f.get("text-ignore-placement")||f.get("icon-ignore-placement"),this.sortFeaturesByKey=b!=="viewport-y"&&!_.isConstant(),this.sortFeaturesByY=(b==="viewport-y"||b==="auto"&&!this.sortFeaturesByKey)&&this.canOverlap,f.get("symbol-placement")==="point"&&(this.writingModes=f.get("text-writing-mode").map((w=>u.ah[w]))),this.stateDependentLayerIds=this.layers.filter((w=>w.isStateDependent())).map((w=>w.id)),this.sourceID=o.sourceID}createArrays(){this.text=new Ig(new Aa(this.layers,this.zoom,(o=>/^text/.test(o)))),this.icon=new Ig(new Aa(this.layers,this.zoom,(o=>/^icon/.test(o)))),this.glyphOffsetArray=new Ai,this.lineVertexArray=new gr,this.symbolInstances=new Qt,this.textAnchorOffsets=new Ei}calculateGlyphDependencies(o,h,f,_,b){for(let w=0;w<o.length;w++)if(h[o.charCodeAt(w)]=!0,(f||_)&&b){const A=Du[o.charAt(w)];A&&(h[A.charCodeAt(0)]=!0)}}populate(o,h,f){const _=this.layers[0],b=_.layout,w=b.get("text-font"),A=b.get("text-field"),I=b.get("icon-image"),R=(A.value.kind!=="constant"||A.value.value instanceof Gr&&!A.value.value.isEmpty()||A.value.value.toString().length>0)&&(w.value.kind!=="constant"||w.value.value.length>0),k=I.value.kind!=="constant"||!!I.value.value||Object.keys(I.parameters).length>0,F=b.get("symbol-sort-key");if(this.features=[],!R&&!k)return;const V=h.iconDependencies,j=h.glyphDependencies,X=h.availableImages,Z=new Ti(this.zoom);for(const{feature:se,id:ue,index:Me,sourceLayerIndex:xe}of o){const Ee=_._featureFilter.needGeometry,Ue=Ia(se,Ee);if(!_._featureFilter.filter(Z,Ue,f))continue;let et,mt;if(Ee||(Ue.geometry=Ea(se)),R){const pt=_.getValueAndResolveTokens("text-field",Ue,f,X),ut=Gr.factory(pt),Ct=this.hasRTLText=this.hasRTLText||DA(ut);(!Ct||es.getRTLTextPluginStatus()==="unavailable"||Ct&&es.isParsed())&&(et=fA(ut,_,Ue))}if(k){const pt=_.getValueAndResolveTokens("icon-image",Ue,f,X);mt=pt instanceof Jr?pt:Jr.fromString(pt)}if(!et&&!mt)continue;const Ot=this.sortFeaturesByKey?F.evaluate(Ue,{},f):void 0;if(this.features.push({id:ue,text:et,icon:mt,index:Me,sourceLayerIndex:xe,geometry:Ue.geometry,properties:se.properties,type:RA[se.type],sortKey:Ot}),mt&&(V[mt.name]=!0),et){const pt=w.evaluate(Ue,{},f).join(","),ut=b.get("text-rotation-alignment")!=="viewport"&&b.get("symbol-placement")!=="point";this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(u.ah.vertical)>=0;for(const Ct of et.sections)if(Ct.image)V[Ct.image.name]=!0;else{const Tt=yu(et.toString()),xt=Ct.fontStack||pt,$e=j[xt]=j[xt]||{};this.calculateGlyphDependencies(Ct.text,$e,ut,this.allowVerticalPlacement,Tt)}}}b.get("symbol-placement")==="line"&&(this.features=(function(se){const ue={},Me={},xe=[];let Ee=0;function Ue(pt){xe.push(se[pt]),Ee++}function et(pt,ut,Ct){const Tt=Me[pt];return delete Me[pt],Me[ut]=Tt,xe[Tt].geometry[0].pop(),xe[Tt].geometry[0]=xe[Tt].geometry[0].concat(Ct[0]),Tt}function mt(pt,ut,Ct){const Tt=ue[ut];return delete ue[ut],ue[pt]=Tt,xe[Tt].geometry[0].shift(),xe[Tt].geometry[0]=Ct[0].concat(xe[Tt].geometry[0]),Tt}function Ot(pt,ut,Ct){const Tt=Ct?ut[0][ut[0].length-1]:ut[0][0];return`${pt}:${Tt.x}:${Tt.y}`}for(let pt=0;pt<se.length;pt++){const ut=se[pt],Ct=ut.geometry,Tt=ut.text?ut.text.toString():null;if(!Tt){Ue(pt);continue}const xt=Ot(Tt,Ct),$e=Ot(Tt,Ct,!0);if(xt in Me&&$e in ue&&Me[xt]!==ue[$e]){const Pt=mt(xt,$e,Ct),It=et(xt,$e,xe[Pt].geometry);delete ue[xt],delete Me[$e],Me[Ot(Tt,xe[It].geometry,!0)]=It,xe[Pt].geometry=null}else xt in Me?et(xt,$e,Ct):$e in ue?mt(xt,$e,Ct):(Ue(pt),ue[xt]=Ee-1,Me[$e]=Ee-1)}return xe.filter((pt=>pt.geometry))})(this.features)),this.sortFeaturesByKey&&this.features.sort(((se,ue)=>se.sortKey-ue.sortKey))}update(o,h,f){this.stateDependentLayers.length&&(this.text.programConfigurations.updatePaintArrays(o,h,this.layers,f),this.icon.programConfigurations.updatePaintArrays(o,h,this.layers,f))}isEmpty(){return this.symbolInstances.length===0&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(o){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(o),this.iconCollisionBox.upload(o)),this.text.upload(o,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload),this.icon.upload(o,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload),this.uploaded=!0}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(o,h){const f=this.lineVertexArray.length;if(o.segment!==void 0){let _=o.dist(h[o.segment+1]),b=o.dist(h[o.segment]);const w={};for(let A=o.segment+1;A<h.length;A++)w[A]={x:h[A].x,y:h[A].y,tileUnitDistanceFromAnchor:_},A<h.length-1&&(_+=h[A+1].dist(h[A]));for(let A=o.segment||0;A>=0;A--)w[A]={x:h[A].x,y:h[A].y,tileUnitDistanceFromAnchor:b},A>0&&(b+=h[A-1].dist(h[A]));for(let A=0;A<h.length;A++){const I=w[A];this.lineVertexArray.emplaceBack(I.x,I.y,I.tileUnitDistanceFromAnchor)}}return{lineStartIndex:f,lineLength:this.lineVertexArray.length-f}}addSymbols(o,h,f,_,b,w,A,I,R,k,F,V){const j=o.indexArray,X=o.layoutVertexArray,Z=o.segments.prepareSegment(4*h.length,X,j,this.canOverlap?w.sortKey:void 0),se=this.glyphOffsetArray.length,ue=Z.vertexLength,Me=this.allowVerticalPlacement&&A===u.ah.vertical?Math.PI/2:0,xe=w.text&&w.text.sections;for(let Ee=0;Ee<h.length;Ee++){const{tl:Ue,tr:et,bl:mt,br:Ot,tex:pt,pixelOffsetTL:ut,pixelOffsetBR:Ct,minFontScaleX:Tt,minFontScaleY:xt,glyphOffset:$e,isSDF:Pt,sectionIndex:It}=h[Ee],Vt=Z.vertexLength,_i=$e[1];zd(X,I.x,I.y,Ue.x,_i+Ue.y,pt.x,pt.y,f,Pt,ut.x,ut.y,Tt,xt),zd(X,I.x,I.y,et.x,_i+et.y,pt.x+pt.w,pt.y,f,Pt,Ct.x,ut.y,Tt,xt),zd(X,I.x,I.y,mt.x,_i+mt.y,pt.x,pt.y+pt.h,f,Pt,ut.x,Ct.y,Tt,xt),zd(X,I.x,I.y,Ot.x,_i+Ot.y,pt.x+pt.w,pt.y+pt.h,f,Pt,Ct.x,Ct.y,Tt,xt),Eg(o.dynamicLayoutVertexArray,I,Me),j.emplaceBack(Vt,Vt+1,Vt+2),j.emplaceBack(Vt+1,Vt+2,Vt+3),Z.vertexLength+=4,Z.primitiveLength+=2,this.glyphOffsetArray.emplaceBack($e[0]),Ee!==h.length-1&&It===h[Ee+1].sectionIndex||o.programConfigurations.populatePaintArrays(X.length,w,w.index,{},V,xe&&xe[It])}o.placedSymbolArray.emplaceBack(I.x,I.y,se,this.glyphOffsetArray.length-se,ue,R,k,I.segment,f?f[0]:0,f?f[1]:0,_[0],_[1],A,0,!1,0,F)}_addCollisionDebugVertex(o,h,f,_,b,w){return h.emplaceBack(0,0),o.emplaceBack(f.x,f.y,_,b,Math.round(w.x),Math.round(w.y))}addCollisionDebugVertices(o,h,f,_,b,w,A){const I=b.segments.prepareSegment(4,b.layoutVertexArray,b.indexArray),R=I.vertexLength,k=b.layoutVertexArray,F=b.collisionVertexArray,V=A.anchorX,j=A.anchorY;this._addCollisionDebugVertex(k,F,w,V,j,new S(o,h)),this._addCollisionDebugVertex(k,F,w,V,j,new S(f,h)),this._addCollisionDebugVertex(k,F,w,V,j,new S(f,_)),this._addCollisionDebugVertex(k,F,w,V,j,new S(o,_)),I.vertexLength+=4;const X=b.indexArray;X.emplaceBack(R,R+1),X.emplaceBack(R+1,R+2),X.emplaceBack(R+2,R+3),X.emplaceBack(R+3,R),I.primitiveLength+=4}addDebugCollisionBoxes(o,h,f,_){for(let b=o;b<h;b++){const w=this.collisionBoxArray.get(b);this.addCollisionDebugVertices(w.x1,w.y1,w.x2,w.y2,_?this.textCollisionBox:this.iconCollisionBox,w.anchorPoint,f)}}generateCollisionDebugBuffers(){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new Cg(ps,Rx.members,cr),this.iconCollisionBox=new Cg(ps,Rx.members,cr);for(let o=0;o<this.symbolInstances.length;o++){const h=this.symbolInstances.get(o);this.addDebugCollisionBoxes(h.textBoxStartIndex,h.textBoxEndIndex,h,!0),this.addDebugCollisionBoxes(h.verticalTextBoxStartIndex,h.verticalTextBoxEndIndex,h,!0),this.addDebugCollisionBoxes(h.iconBoxStartIndex,h.iconBoxEndIndex,h,!1),this.addDebugCollisionBoxes(h.verticalIconBoxStartIndex,h.verticalIconBoxEndIndex,h,!1)}}_deserializeCollisionBoxesForSymbol(o,h,f,_,b,w,A,I,R){const k={};for(let F=h;F<f;F++){const V=o.get(F);k.textBox={x1:V.x1,y1:V.y1,x2:V.x2,y2:V.y2,anchorPointX:V.anchorPointX,anchorPointY:V.anchorPointY},k.textFeatureIndex=V.featureIndex;break}for(let F=_;F<b;F++){const V=o.get(F);k.verticalTextBox={x1:V.x1,y1:V.y1,x2:V.x2,y2:V.y2,anchorPointX:V.anchorPointX,anchorPointY:V.anchorPointY},k.verticalTextFeatureIndex=V.featureIndex;break}for(let F=w;F<A;F++){const V=o.get(F);k.iconBox={x1:V.x1,y1:V.y1,x2:V.x2,y2:V.y2,anchorPointX:V.anchorPointX,anchorPointY:V.anchorPointY},k.iconFeatureIndex=V.featureIndex;break}for(let F=I;F<R;F++){const V=o.get(F);k.verticalIconBox={x1:V.x1,y1:V.y1,x2:V.x2,y2:V.y2,anchorPointX:V.anchorPointX,anchorPointY:V.anchorPointY},k.verticalIconFeatureIndex=V.featureIndex;break}return k}deserializeCollisionBoxes(o){this.collisionArrays=[];for(let h=0;h<this.symbolInstances.length;h++){const f=this.symbolInstances.get(h);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(o,f.textBoxStartIndex,f.textBoxEndIndex,f.verticalTextBoxStartIndex,f.verticalTextBoxEndIndex,f.iconBoxStartIndex,f.iconBoxEndIndex,f.verticalIconBoxStartIndex,f.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}addIndicesForPlacedSymbol(o,h){const f=o.placedSymbolArray.get(h),_=f.vertexStartIndex+4*f.numGlyphs;for(let b=f.vertexStartIndex;b<_;b+=4)o.indexArray.emplaceBack(b,b+1,b+2),o.indexArray.emplaceBack(b+1,b+2,b+3)}getSortedSymbolIndexes(o){if(this.sortedAngle===o&&this.symbolInstanceIndexes!==void 0)return this.symbolInstanceIndexes;const h=Math.sin(o),f=Math.cos(o),_=[],b=[],w=[];for(let A=0;A<this.symbolInstances.length;++A){w.push(A);const I=this.symbolInstances.get(A);_.push(0|Math.round(h*I.anchorX+f*I.anchorY)),b.push(I.featureIndex)}return w.sort(((A,I)=>_[A]-_[I]||b[I]-b[A])),w}addToSortKeyRanges(o,h){const f=this.sortKeyRanges[this.sortKeyRanges.length-1];f&&f.sortKey===h?f.symbolInstanceEnd=o+1:this.sortKeyRanges.push({sortKey:h,symbolInstanceStart:o,symbolInstanceEnd:o+1})}sortFeatures(o){if(this.sortFeaturesByY&&this.sortedAngle!==o&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(o),this.sortedAngle=o,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(const h of this.symbolInstanceIndexes){const f=this.symbolInstances.get(h);this.featureSortOrder.push(f.featureIndex),[f.rightJustifiedTextSymbolIndex,f.centerJustifiedTextSymbolIndex,f.leftJustifiedTextSymbolIndex].forEach(((_,b,w)=>{_>=0&&w.indexOf(_)===b&&this.addIndicesForPlacedSymbol(this.text,_)})),f.verticalPlacedTextSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.text,f.verticalPlacedTextSymbolIndex),f.placedIconSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.icon,f.placedIconSymbolIndex),f.verticalPlacedIconSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.icon,f.verticalPlacedIconSymbolIndex)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}}let Yx,Gx;vt("SymbolBucket",ql,{omit:["layers","collisionBoxArray","features","compareText"]}),ql.MAX_GLYPHS=65535,ql.addDynamicAttributes=Eg;var Pg={get paint(){return Gx=Gx||new x({"icon-opacity":new Ft(Ce.paint_symbol["icon-opacity"]),"icon-color":new Ft(Ce.paint_symbol["icon-color"]),"icon-halo-color":new Ft(Ce.paint_symbol["icon-halo-color"]),"icon-halo-width":new Ft(Ce.paint_symbol["icon-halo-width"]),"icon-halo-blur":new Ft(Ce.paint_symbol["icon-halo-blur"]),"icon-translate":new St(Ce.paint_symbol["icon-translate"]),"icon-translate-anchor":new St(Ce.paint_symbol["icon-translate-anchor"]),"text-opacity":new Ft(Ce.paint_symbol["text-opacity"]),"text-color":new Ft(Ce.paint_symbol["text-color"],{runtimeType:Ji,getOverride:c=>c.textColor,hasOverride:c=>!!c.textColor}),"text-halo-color":new Ft(Ce.paint_symbol["text-halo-color"]),"text-halo-width":new Ft(Ce.paint_symbol["text-halo-width"]),"text-halo-blur":new Ft(Ce.paint_symbol["text-halo-blur"]),"text-translate":new St(Ce.paint_symbol["text-translate"]),"text-translate-anchor":new St(Ce.paint_symbol["text-translate-anchor"])})},get layout(){return Yx=Yx||new x({"symbol-placement":new St(Ce.layout_symbol["symbol-placement"]),"symbol-spacing":new St(Ce.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new St(Ce.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new Ft(Ce.layout_symbol["symbol-sort-key"]),"symbol-z-order":new St(Ce.layout_symbol["symbol-z-order"]),"icon-allow-overlap":new St(Ce.layout_symbol["icon-allow-overlap"]),"icon-overlap":new St(Ce.layout_symbol["icon-overlap"]),"icon-ignore-placement":new St(Ce.layout_symbol["icon-ignore-placement"]),"icon-optional":new St(Ce.layout_symbol["icon-optional"]),"icon-rotation-alignment":new St(Ce.layout_symbol["icon-rotation-alignment"]),"icon-size":new Ft(Ce.layout_symbol["icon-size"]),"icon-text-fit":new St(Ce.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new St(Ce.layout_symbol["icon-text-fit-padding"]),"icon-image":new Ft(Ce.layout_symbol["icon-image"]),"icon-rotate":new Ft(Ce.layout_symbol["icon-rotate"]),"icon-padding":new Ft(Ce.layout_symbol["icon-padding"]),"icon-keep-upright":new St(Ce.layout_symbol["icon-keep-upright"]),"icon-offset":new Ft(Ce.layout_symbol["icon-offset"]),"icon-anchor":new Ft(Ce.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new St(Ce.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new St(Ce.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new St(Ce.layout_symbol["text-rotation-alignment"]),"text-field":new Ft(Ce.layout_symbol["text-field"]),"text-font":new Ft(Ce.layout_symbol["text-font"]),"text-size":new Ft(Ce.layout_symbol["text-size"]),"text-max-width":new Ft(Ce.layout_symbol["text-max-width"]),"text-line-height":new St(Ce.layout_symbol["text-line-height"]),"text-letter-spacing":new Ft(Ce.layout_symbol["text-letter-spacing"]),"text-justify":new Ft(Ce.layout_symbol["text-justify"]),"text-radial-offset":new Ft(Ce.layout_symbol["text-radial-offset"]),"text-variable-anchor":new St(Ce.layout_symbol["text-variable-anchor"]),"text-variable-anchor-offset":new Ft(Ce.layout_symbol["text-variable-anchor-offset"]),"text-anchor":new Ft(Ce.layout_symbol["text-anchor"]),"text-max-angle":new St(Ce.layout_symbol["text-max-angle"]),"text-writing-mode":new St(Ce.layout_symbol["text-writing-mode"]),"text-rotate":new Ft(Ce.layout_symbol["text-rotate"]),"text-padding":new St(Ce.layout_symbol["text-padding"]),"text-keep-upright":new St(Ce.layout_symbol["text-keep-upright"]),"text-transform":new Ft(Ce.layout_symbol["text-transform"]),"text-offset":new Ft(Ce.layout_symbol["text-offset"]),"text-allow-overlap":new St(Ce.layout_symbol["text-allow-overlap"]),"text-overlap":new St(Ce.layout_symbol["text-overlap"]),"text-ignore-placement":new St(Ce.layout_symbol["text-ignore-placement"]),"text-optional":new St(Ce.layout_symbol["text-optional"])})}};class Kx{constructor(o){if(o.property.overrides===void 0)throw new Error("overrides must be provided to instantiate FormatSectionOverride class");this.type=o.property.overrides?o.property.overrides.runtimeType:ys,this.defaultValue=o}evaluate(o){if(o.formattedSection){const h=this.defaultValue.property.overrides;if(h&&h.hasOverride(o.formattedSection))return h.getOverride(o.formattedSection)}return o.feature&&o.featureState?this.defaultValue.evaluate(o.feature,o.featureState):this.defaultValue.property.specification.default}eachChild(o){this.defaultValue.isConstant()||o(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}vt("FormatSectionOverride",Kx,{omit:["defaultValue"]});class Ud extends d{constructor(o){super(o,Pg)}recalculate(o,h){if(super.recalculate(o,h),this.layout.get("icon-rotation-alignment")==="auto"&&(this.layout._values["icon-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-rotation-alignment")==="auto"&&(this.layout._values["text-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-pitch-alignment")==="auto"&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")==="map"?"map":"viewport"),this.layout.get("icon-pitch-alignment")==="auto"&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment")),this.layout.get("symbol-placement")==="point"){const f=this.layout.get("text-writing-mode");if(f){const _=[];for(const b of f)_.indexOf(b)<0&&_.push(b);this.layout._values["text-writing-mode"]=_}else this.layout._values["text-writing-mode"]=["horizontal"]}this._setPaintOverrides()}getValueAndResolveTokens(o,h,f,_){const b=this.layout.get(o).evaluate(h,{},f,_),w=this._unevaluatedLayout._values[o];return w.isDataDriven()||xl(w.value)||!b?b:(function(A,I){return I.replace(/{([^{}]+)}/g,((R,k)=>A&&k in A?String(A[k]):""))})(h.properties,b)}createBucket(o){return new ql(o)}queryRadius(){return 0}queryIntersectsFeature(){throw new Error("Should take a different path in FeatureIndex")}_setPaintOverrides(){for(const o of Pg.paint.overridableProperties){if(!Ud.hasPaintOverride(this.layout,o))continue;const h=this.paint.get(o),f=new Kx(h),_=new yl(f,h.property.specification);let b=null;b=h.value.kind==="constant"||h.value.kind==="source"?new yo("source",_):new xo("composite",_,h.value.zoomStops),this.paint._values[o]=new $s(h.property,b,h.parameters)}}_handleOverridablePaintPropertyUpdate(o,h,f){return!(!this.layout||h.isDataDriven()||f.isDataDriven())&&Ud.hasPaintOverride(this.layout,o)}static hasPaintOverride(o,h){const f=o.get("text-field"),_=Pg.paint.properties[h];let b=!1;const w=A=>{for(const I of A)if(_.overrides&&_.overrides.hasOverride(I))return void(b=!0)};if(f.value.kind==="constant"&&f.value.value instanceof Gr)w(f.value.value.sections);else if(f.value.kind==="source"){const A=R=>{b||(R instanceof vs&&Zi(R.value)===xs?w(R.value.sections):R instanceof cl?w(R.sections):R.eachChild(A))},I=f.value;I._styleExpression&&A(I._styleExpression.expression)}return b}}let Jx;var OA={get paint(){return Jx=Jx||new x({"background-color":new St(Ce.paint_background["background-color"]),"background-pattern":new kl(Ce.paint_background["background-pattern"]),"background-opacity":new St(Ce.paint_background["background-opacity"])})}};class LA extends d{constructor(o){super(o,OA)}}let Qx;var FA={get paint(){return Qx=Qx||new x({"raster-opacity":new St(Ce.paint_raster["raster-opacity"]),"raster-hue-rotate":new St(Ce.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new St(Ce.paint_raster["raster-brightness-min"]),"raster-brightness-max":new St(Ce.paint_raster["raster-brightness-max"]),"raster-saturation":new St(Ce.paint_raster["raster-saturation"]),"raster-contrast":new St(Ce.paint_raster["raster-contrast"]),"raster-resampling":new St(Ce.paint_raster["raster-resampling"]),"raster-fade-duration":new St(Ce.paint_raster["raster-fade-duration"])})}};class BA extends d{constructor(o){super(o,FA)}}class NA extends d{constructor(o){super(o,{}),this.onAdd=h=>{this.implementation.onAdd&&this.implementation.onAdd(h,h.painter.context.gl)},this.onRemove=h=>{this.implementation.onRemove&&this.implementation.onRemove(h,h.painter.context.gl)},this.implementation=o}is3D(){return this.implementation.renderingMode==="3d"}hasOffscreenPass(){return this.implementation.prerender!==void 0}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){throw new Error("Custom layers cannot be serialized")}}class zA{constructor(o){this._methodToThrottle=o,this._triggered=!1,typeof MessageChannel<"u"&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._methodToThrottle()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout((()=>{this._triggered=!1,this._methodToThrottle()}),0))}remove(){delete this._channel,this._methodToThrottle=()=>{}}}const Mg=63710088e-1;class Fo{constructor(o,h){if(isNaN(o)||isNaN(h))throw new Error(`Invalid LngLat object: (${o}, ${h})`);if(this.lng=+o,this.lat=+h,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new Fo(Oe(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(o){const h=Math.PI/180,f=this.lat*h,_=o.lat*h,b=Math.sin(f)*Math.sin(_)+Math.cos(f)*Math.cos(_)*Math.cos((o.lng-this.lng)*h);return Mg*Math.acos(Math.min(b,1))}static convert(o){if(o instanceof Fo)return o;if(Array.isArray(o)&&(o.length===2||o.length===3))return new Fo(Number(o[0]),Number(o[1]));if(!Array.isArray(o)&&typeof o=="object"&&o!==null)return new Fo(Number("lng"in o?o.lng:o.lon),Number(o.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}const ev=2*Math.PI*Mg;function tv(c){return ev*Math.cos(c*Math.PI/180)}function iv(c){return(180+c)/360}function rv(c){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+c*Math.PI/360)))/360}function sv(c,o){return c/tv(o)}function Rg(c){return 360/Math.PI*Math.atan(Math.exp((180-360*c)*Math.PI/180))-90}class Bu{constructor(o,h,f=0){this.x=+o,this.y=+h,this.z=+f}static fromLngLat(o,h=0){const f=Fo.convert(o);return new Bu(iv(f.lng),rv(f.lat),sv(h,f.lat))}toLngLat(){return new Fo(360*this.x-180,Rg(this.y))}toAltitude(){return this.z*tv(Rg(this.y))}meterInMercatorCoordinateUnits(){return 1/ev*(o=Rg(this.y),1/Math.cos(o*Math.PI/180));var o}}function nv(c,o,h){var f=2*Math.PI*6378137/256/Math.pow(2,h);return[c*f-2*Math.PI*6378137/2,o*f-2*Math.PI*6378137/2]}class kg{constructor(o,h,f){if(!(function(_,b,w){return!(_<0||_>25||w<0||w>=Math.pow(2,_)||b<0||b>=Math.pow(2,_))})(o,h,f))throw new Error(`x=${h}, y=${f}, z=${o} outside of bounds. 0<=x<${Math.pow(2,o)}, 0<=y<${Math.pow(2,o)} 0<=z<=25 `);this.z=o,this.x=h,this.y=f,this.key=Nu(0,o,o,h,f)}equals(o){return this.z===o.z&&this.x===o.x&&this.y===o.y}url(o,h,f){const _=(w=this.y,A=this.z,I=nv(256*(b=this.x),256*(w=Math.pow(2,A)-w-1),A),R=nv(256*(b+1),256*(w+1),A),I[0]+","+I[1]+","+R[0]+","+R[1]);var b,w,A,I,R;const k=(function(F,V,j){let X,Z="";for(let se=F;se>0;se--)X=1<<se-1,Z+=(V&X?1:0)+(j&X?2:0);return Z})(this.z,this.x,this.y);return o[(this.x+this.y)%o.length].replace(/{prefix}/g,(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String(f==="tms"?Math.pow(2,this.z)-this.y-1:this.y)).replace(/{ratio}/g,h>1?"@2x":"").replace(/{quadkey}/g,k).replace(/{bbox-epsg-3857}/g,_)}isChildOf(o){const h=this.z-o.z;return h>0&&o.x===this.x>>h&&o.y===this.y>>h}getTilePoint(o){const h=Math.pow(2,this.z);return new S((o.x*h-this.x)*Yi,(o.y*h-this.y)*Yi)}toString(){return`${this.z}/${this.x}/${this.y}`}}class ov{constructor(o,h){this.wrap=o,this.canonical=h,this.key=Nu(o,h.z,h.z,h.x,h.y)}}class Cs{constructor(o,h,f,_,b){if(o<f)throw new Error(`overscaledZ should be >= z; overscaledZ = ${o}; z = ${f}`);this.overscaledZ=o,this.wrap=h,this.canonical=new kg(f,+_,+b),this.key=Nu(h,o,f,_,b)}clone(){return new Cs(this.overscaledZ,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)}equals(o){return this.overscaledZ===o.overscaledZ&&this.wrap===o.wrap&&this.canonical.equals(o.canonical)}scaledTo(o){if(o>this.overscaledZ)throw new Error(`targetZ > this.overscaledZ; targetZ = ${o}; overscaledZ = ${this.overscaledZ}`);const h=this.canonical.z-o;return o>this.canonical.z?new Cs(o,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new Cs(o,this.wrap,o,this.canonical.x>>h,this.canonical.y>>h)}calculateScaledKey(o,h){if(o>this.overscaledZ)throw new Error(`targetZ > this.overscaledZ; targetZ = ${o}; overscaledZ = ${this.overscaledZ}`);const f=this.canonical.z-o;return o>this.canonical.z?Nu(this.wrap*+h,o,this.canonical.z,this.canonical.x,this.canonical.y):Nu(this.wrap*+h,o,o,this.canonical.x>>f,this.canonical.y>>f)}isChildOf(o){if(o.wrap!==this.wrap)return!1;const h=this.canonical.z-o.canonical.z;return o.overscaledZ===0||o.overscaledZ<this.overscaledZ&&o.canonical.x===this.canonical.x>>h&&o.canonical.y===this.canonical.y>>h}children(o){if(this.overscaledZ>=o)return[new Cs(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];const h=this.canonical.z+1,f=2*this.canonical.x,_=2*this.canonical.y;return[new Cs(h,this.wrap,h,f,_),new Cs(h,this.wrap,h,f+1,_),new Cs(h,this.wrap,h,f,_+1),new Cs(h,this.wrap,h,f+1,_+1)]}isLessThan(o){return this.wrap<o.wrap||!(this.wrap>o.wrap)&&(this.overscaledZ<o.overscaledZ||!(this.overscaledZ>o.overscaledZ)&&(this.canonical.x<o.canonical.x||!(this.canonical.x>o.canonical.x)&&this.canonical.y<o.canonical.y))}wrapped(){return new Cs(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(o){return new Cs(this.overscaledZ,o,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new ov(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}getTilePoint(o){return this.canonical.getTilePoint(new Bu(o.x-this.wrap,o.y))}}function Nu(c,o,h,f,_){(c*=2)<0&&(c=-1*c-1);const b=1<<h;return(b*b*c+b*_+f).toString(36)+h.toString(36)+o.toString(36)}vt("CanonicalTileID",kg),vt("OverscaledTileID",Cs,{omit:["posMatrix"]});class av{constructor(o,h,f,_=1,b=1,w=1,A=0){if(this.uid=o,h.height!==h.width)throw new RangeError("DEM tiles must be square");if(f&&!["mapbox","terrarium","custom"].includes(f))return void Ke(`"${f}" is not a valid encoding type. Valid types include "mapbox", "terrarium" and "custom".`);this.stride=h.height;const I=this.dim=h.height-2;switch(this.data=new Uint32Array(h.data.buffer),f){case"terrarium":this.redFactor=256,this.greenFactor=1,this.blueFactor=1/256,this.baseShift=32768;break;case"custom":this.redFactor=_,this.greenFactor=b,this.blueFactor=w,this.baseShift=A;break;default:this.redFactor=6553.6,this.greenFactor=25.6,this.blueFactor=.1,this.baseShift=1e4}for(let R=0;R<I;R++)this.data[this._idx(-1,R)]=this.data[this._idx(0,R)],this.data[this._idx(I,R)]=this.data[this._idx(I-1,R)],this.data[this._idx(R,-1)]=this.data[this._idx(R,0)],this.data[this._idx(R,I)]=this.data[this._idx(R,I-1)];this.data[this._idx(-1,-1)]=this.data[this._idx(0,0)],this.data[this._idx(I,-1)]=this.data[this._idx(I-1,0)],this.data[this._idx(-1,I)]=this.data[this._idx(0,I-1)],this.data[this._idx(I,I)]=this.data[this._idx(I-1,I-1)],this.min=Number.MAX_SAFE_INTEGER,this.max=Number.MIN_SAFE_INTEGER;for(let R=0;R<I;R++)for(let k=0;k<I;k++){const F=this.get(R,k);F>this.max&&(this.max=F),F<this.min&&(this.min=F)}}get(o,h){const f=new Uint8Array(this.data.buffer),_=4*this._idx(o,h);return this.unpack(f[_],f[_+1],f[_+2])}getUnpackVector(){return[this.redFactor,this.greenFactor,this.blueFactor,this.baseShift]}_idx(o,h){if(o<-1||o>=this.dim+1||h<-1||h>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(h+1)*this.stride+(o+1)}unpack(o,h,f){return o*this.redFactor+h*this.greenFactor+f*this.blueFactor-this.baseShift}getPixels(){return new Is({width:this.stride,height:this.stride},new Uint8Array(this.data.buffer))}backfillBorder(o,h,f){if(this.dim!==o.dim)throw new Error("dem dimension mismatch");let _=h*this.dim,b=h*this.dim+this.dim,w=f*this.dim,A=f*this.dim+this.dim;switch(h){case-1:_=b-1;break;case 1:b=_+1}switch(f){case-1:w=A-1;break;case 1:A=w+1}const I=-h*this.dim,R=-f*this.dim;for(let k=w;k<A;k++)for(let F=_;F<b;F++)this.data[this._idx(F,k)]=o.data[this._idx(F+I,k+R)]}}vt("DEMData",av);class lv{constructor(o){this._stringToNumber={},this._numberToString=[];for(let h=0;h<o.length;h++){const f=o[h];this._stringToNumber[f]=h,this._numberToString[h]=f}}encode(o){return this._stringToNumber[o]}decode(o){if(o>=this._numberToString.length)throw new Error(`Out of bounds. Index requested n=${o} can't be >= this._numberToString.length ${this._numberToString.length}`);return this._numberToString[o]}}class cv{constructor(o,h,f,_,b){this.type="Feature",this._vectorTileFeature=o,o._z=h,o._x=f,o._y=_,this.properties=o.properties,this.id=b}get geometry(){return this._geometry===void 0&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._vectorTileFeature._x,this._vectorTileFeature._y,this._vectorTileFeature._z).geometry),this._geometry}set geometry(o){this._geometry=o}toJSON(){const o={geometry:this.geometry};for(const h in this)h!=="_geometry"&&h!=="_vectorTileFeature"&&(o[h]=this[h]);return o}}class uv{constructor(o,h){this.tileID=o,this.x=o.canonical.x,this.y=o.canonical.y,this.z=o.canonical.z,this.grid=new wo(Yi,16,0),this.grid3D=new wo(Yi,16,0),this.featureIndexArray=new Ar,this.promoteId=h}insert(o,h,f,_,b,w){const A=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(f,_,b);const I=w?this.grid3D:this.grid;for(let R=0;R<h.length;R++){const k=h[R],F=[1/0,1/0,-1/0,-1/0];for(let V=0;V<k.length;V++){const j=k[V];F[0]=Math.min(F[0],j.x),F[1]=Math.min(F[1],j.y),F[2]=Math.max(F[2],j.x),F[3]=Math.max(F[3],j.y)}F[0]<Yi&&F[1]<Yi&&F[2]>=0&&F[3]>=0&&I.insert(A,F[0],F[1],F[2],F[3])}}loadVTLayers(){return this.vtLayers||(this.vtLayers=new Do.VectorTile(new vg(this.rawTileData)).layers,this.sourceLayerCoder=new lv(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"])),this.vtLayers}query(o,h,f,_){this.loadVTLayers();const b=o.params||{},w=Yi/o.tileSize/o.scale,A=ru(b.filter),I=o.queryGeometry,R=o.queryPadding*w,k=dv(I),F=this.grid.query(k.minX-R,k.minY-R,k.maxX+R,k.maxY+R),V=dv(o.cameraQueryGeometry),j=this.grid3D.query(V.minX-R,V.minY-R,V.maxX+R,V.maxY+R,((se,ue,Me,xe)=>(function(Ee,Ue,et,mt,Ot){for(const ut of Ee)if(Ue<=ut.x&&et<=ut.y&&mt>=ut.x&&Ot>=ut.y)return!0;const pt=[new S(Ue,et),new S(Ue,Ot),new S(mt,Ot),new S(mt,et)];if(Ee.length>2){for(const ut of pt)if(zl(Ee,ut))return!0}for(let ut=0;ut<Ee.length-1;ut++)if(xS(Ee[ut],Ee[ut+1],pt))return!0;return!1})(o.cameraQueryGeometry,se-R,ue-R,Me+R,xe+R)));for(const se of j)F.push(se);F.sort(UA);const X={};let Z;for(let se=0;se<F.length;se++){const ue=F[se];if(ue===Z)continue;Z=ue;const Me=this.featureIndexArray.get(ue);let xe=null;this.loadMatchingFeature(X,Me.bucketIndex,Me.sourceLayerIndex,Me.featureIndex,A,b.layers,b.availableImages,h,f,_,((Ee,Ue,et)=>(xe||(xe=Ea(Ee)),Ue.queryIntersectsFeature(I,Ee,et,xe,this.z,o.transform,w,o.pixelPosMatrix))))}return X}loadMatchingFeature(o,h,f,_,b,w,A,I,R,k,F){const V=this.bucketLayerIDs[h];if(w&&!(function(se,ue){for(let Me=0;Me<se.length;Me++)if(ue.indexOf(se[Me])>=0)return!0;return!1})(w,V))return;const j=this.sourceLayerCoder.decode(f),X=this.vtLayers[j].feature(_);if(b.needGeometry){const se=Ia(X,!0);if(!b.filter(new Ti(this.tileID.overscaledZ),se,this.tileID.canonical))return}else if(!b.filter(new Ti(this.tileID.overscaledZ),X))return;const Z=this.getId(X,j);for(let se=0;se<V.length;se++){const ue=V[se];if(w&&w.indexOf(ue)<0)continue;const Me=I[ue];if(!Me)continue;let xe={};Z&&k&&(xe=k.getState(Me.sourceLayer||"_geojsonTileLayer",Z));const Ee=Je({},R[ue]);Ee.paint=hv(Ee.paint,Me.paint,X,xe,A),Ee.layout=hv(Ee.layout,Me.layout,X,xe,A);const Ue=!F||F(X,Me,xe);if(!Ue)continue;const et=new cv(X,this.z,this.x,this.y,Z);et.layer=Ee;let mt=o[ue];mt===void 0&&(mt=o[ue]=[]),mt.push({featureIndex:_,feature:et,intersectionZ:Ue})}}lookupSymbolFeatures(o,h,f,_,b,w,A,I){const R={};this.loadVTLayers();const k=ru(b);for(const F of o)this.loadMatchingFeature(R,f,_,F,k,w,A,I,h);return R}hasLayer(o){for(const h of this.bucketLayerIDs)for(const f of h)if(o===f)return!0;return!1}getId(o,h){let f=o.id;return this.promoteId&&(f=o.properties[typeof this.promoteId=="string"?this.promoteId:this.promoteId[h]],typeof f=="boolean"&&(f=Number(f))),f}}function hv(c,o,h,f,_){return He(c,((b,w)=>{const A=o instanceof wa?o.get(w):null;return A&&A.evaluate?A.evaluate(h,f,_):A}))}function dv(c){let o=1/0,h=1/0,f=-1/0,_=-1/0;for(const b of c)o=Math.min(o,b.x),h=Math.min(h,b.y),f=Math.max(f,b.x),_=Math.max(_,b.y);return{minX:o,minY:h,maxX:f,maxY:_}}function UA(c,o){return o-c}function fv(c,o,h,f,_){const b=[];for(let w=0;w<c.length;w++){const A=c[w];let I;for(let R=0;R<A.length-1;R++){let k=A[R],F=A[R+1];k.x<o&&F.x<o||(k.x<o?k=new S(o,k.y+(o-k.x)/(F.x-k.x)*(F.y-k.y))._round():F.x<o&&(F=new S(o,k.y+(o-k.x)/(F.x-k.x)*(F.y-k.y))._round()),k.y<h&&F.y<h||(k.y<h?k=new S(k.x+(h-k.y)/(F.y-k.y)*(F.x-k.x),h)._round():F.y<h&&(F=new S(k.x+(h-k.y)/(F.y-k.y)*(F.x-k.x),h)._round()),k.x>=f&&F.x>=f||(k.x>=f?k=new S(f,k.y+(f-k.x)/(F.x-k.x)*(F.y-k.y))._round():F.x>=f&&(F=new S(f,k.y+(f-k.x)/(F.x-k.x)*(F.y-k.y))._round()),k.y>=_&&F.y>=_||(k.y>=_?k=new S(k.x+(_-k.y)/(F.y-k.y)*(F.x-k.x),_)._round():F.y>=_&&(F=new S(k.x+(_-k.y)/(F.y-k.y)*(F.x-k.x),_)._round()),I&&k.equals(I[I.length-1])||(I=[k],b.push(I)),I.push(F)))))}}return b}vt("FeatureIndex",uv,{omit:["rawTileData","sourceLayerCoder"]});class Bo extends S{constructor(o,h,f,_){super(o,h),this.angle=f,_!==void 0&&(this.segment=_)}clone(){return new Bo(this.x,this.y,this.angle,this.segment)}}function pv(c,o,h,f,_){if(o.segment===void 0||h===0)return!0;let b=o,w=o.segment+1,A=0;for(;A>-h/2;){if(w--,w<0)return!1;A-=c[w].dist(b),b=c[w]}A+=c[w].dist(c[w+1]),w++;const I=[];let R=0;for(;A<h/2;){const k=c[w],F=c[w+1];if(!F)return!1;let V=c[w-1].angleTo(k)-k.angleTo(F);for(V=Math.abs((V+3*Math.PI)%(2*Math.PI)-Math.PI),I.push({distance:A,angleDelta:V}),R+=V;A-I[0].distance>f;)R-=I.shift().angleDelta;if(R>_)return!1;w++,A+=k.dist(F)}return!0}function gv(c){let o=0;for(let h=0;h<c.length-1;h++)o+=c[h].dist(c[h+1]);return o}function mv(c,o,h){return c?.6*o*h:0}function _v(c,o){return Math.max(c?c.right-c.left:0,o?o.right-o.left:0)}function VA(c,o,h,f,_,b){const w=mv(h,_,b),A=_v(h,f)*b;let I=0;const R=gv(c)/2;for(let k=0;k<c.length-1;k++){const F=c[k],V=c[k+1],j=F.dist(V);if(I+j>R){const X=(R-I)/j,Z=Or.number(F.x,V.x,X),se=Or.number(F.y,V.y,X),ue=new Bo(Z,se,V.angleTo(F),k);return ue._round(),!w||pv(c,ue,A,w,o)?ue:void 0}I+=j}}function jA(c,o,h,f,_,b,w,A,I){const R=mv(f,b,w),k=_v(f,_),F=k*w,V=c[0].x===0||c[0].x===I||c[0].y===0||c[0].y===I;return o-F<o/4&&(o=F+o/4),yv(c,V?o/2*A%o:(k/2+2*b)*w*A%o,o,R,h,F,V,!1,I)}function yv(c,o,h,f,_,b,w,A,I){const R=b/2,k=gv(c);let F=0,V=o-h,j=[];for(let X=0;X<c.length-1;X++){const Z=c[X],se=c[X+1],ue=Z.dist(se),Me=se.angleTo(Z);for(;V+h<F+ue;){V+=h;const xe=(V-F)/ue,Ee=Or.number(Z.x,se.x,xe),Ue=Or.number(Z.y,se.y,xe);if(Ee>=0&&Ee<I&&Ue>=0&&Ue<I&&V-R>=0&&V+R<=k){const et=new Bo(Ee,Ue,Me,X);et._round(),f&&!pv(c,et,b,f,_)||j.push(et)}}F+=ue}return A||j.length||w||(j=yv(c,F/2,h,f,_,b,w,!0,I)),j}vt("Anchor",Bo);const Xl=is;function xv(c,o,h,f){const _=[],b=c.image,w=b.pixelRatio,A=b.paddedRect.w-2*Xl,I=b.paddedRect.h-2*Xl;let R={x1:c.left,y1:c.top,x2:c.right,y2:c.bottom};const k=b.stretchX||[[0,A]],F=b.stretchY||[[0,I]],V=($e,Pt)=>$e+Pt[1]-Pt[0],j=k.reduce(V,0),X=F.reduce(V,0),Z=A-j,se=I-X;let ue=0,Me=j,xe=0,Ee=X,Ue=0,et=Z,mt=0,Ot=se;if(b.content&&f){const $e=b.content,Pt=$e[2]-$e[0],It=$e[3]-$e[1];(b.textFitWidth||b.textFitHeight)&&(R=qx(c)),ue=Vd(k,0,$e[0]),xe=Vd(F,0,$e[1]),Me=Vd(k,$e[0],$e[2]),Ee=Vd(F,$e[1],$e[3]),Ue=$e[0]-ue,mt=$e[1]-xe,et=Pt-Me,Ot=It-Ee}const pt=R.x1,ut=R.y1,Ct=R.x2-pt,Tt=R.y2-ut,xt=($e,Pt,It,Vt)=>{const _i=jd($e.stretch-ue,Me,Ct,pt),gi=$d($e.fixed-Ue,et,$e.stretch,j),ir=jd(Pt.stretch-xe,Ee,Tt,ut),Hs=$d(Pt.fixed-mt,Ot,Pt.stretch,X),xr=jd(It.stretch-ue,Me,Ct,pt),rr=$d(It.fixed-Ue,et,It.stretch,j),Nr=jd(Vt.stretch-xe,Ee,Tt,ut),zr=$d(Vt.fixed-mt,Ot,Vt.stretch,X),Ur=new S(_i,ir),ji=new S(xr,ir),sr=new S(xr,Nr),Ir=new S(_i,Nr),vr=new S(gi/w,Hs/w),Vr=new S(rr/w,zr/w),br=o*Math.PI/180;if(br){const ai=Math.sin(br),vi=Math.cos(br),Ii=[vi,-ai,ai,vi];Ur._matMult(Ii),ji._matMult(Ii),Ir._matMult(Ii),sr._matMult(Ii)}const Ps=$e.stretch+$e.fixed,rs=Pt.stretch+Pt.fixed;return{tl:Ur,tr:ji,bl:Ir,br:sr,tex:{x:b.paddedRect.x+Xl+Ps,y:b.paddedRect.y+Xl+rs,w:It.stretch+It.fixed-Ps,h:Vt.stretch+Vt.fixed-rs},writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:vr,pixelOffsetBR:Vr,minFontScaleX:et/w/Ct,minFontScaleY:Ot/w/Tt,isSDF:h}};if(f&&(b.stretchX||b.stretchY)){const $e=vv(k,Z,j),Pt=vv(F,se,X);for(let It=0;It<$e.length-1;It++){const Vt=$e[It],_i=$e[It+1];for(let gi=0;gi<Pt.length-1;gi++)_.push(xt(Vt,Pt[gi],_i,Pt[gi+1]))}}else _.push(xt({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:A+1},{fixed:0,stretch:I+1}));return _}function Vd(c,o,h){let f=0;for(const _ of c)f+=Math.max(o,Math.min(h,_[1]))-Math.max(o,Math.min(h,_[0]));return f}function vv(c,o,h){const f=[{fixed:-Xl,stretch:0}];for(const[_,b]of c){const w=f[f.length-1];f.push({fixed:_-w.stretch,stretch:w.stretch}),f.push({fixed:_-w.stretch,stretch:w.stretch+(b-_)})}return f.push({fixed:o+Xl,stretch:h}),f}function jd(c,o,h,f){return c/o*h+f}function $d(c,o,h,f){return c-o*h/f}class Wd{constructor(o,h,f,_,b,w,A,I,R,k){var F;if(this.boxStartIndex=o.length,R){let V=w.top,j=w.bottom;const X=w.collisionPadding;X&&(V-=X[1],j+=X[3]);let Z=j-V;Z>0&&(Z=Math.max(10,Z),this.circleDiameter=Z)}else{const V=!((F=w.image)===null||F===void 0)&&F.content&&(w.image.textFitWidth||w.image.textFitHeight)?qx(w):{x1:w.left,y1:w.top,x2:w.right,y2:w.bottom};V.y1=V.y1*A-I[0],V.y2=V.y2*A+I[2],V.x1=V.x1*A-I[3],V.x2=V.x2*A+I[1];const j=w.collisionPadding;if(j&&(V.x1-=j[0]*A,V.y1-=j[1]*A,V.x2+=j[2]*A,V.y2+=j[3]*A),k){const X=new S(V.x1,V.y1),Z=new S(V.x2,V.y1),se=new S(V.x1,V.y2),ue=new S(V.x2,V.y2),Me=k*Math.PI/180;X._rotate(Me),Z._rotate(Me),se._rotate(Me),ue._rotate(Me),V.x1=Math.min(X.x,Z.x,se.x,ue.x),V.x2=Math.max(X.x,Z.x,se.x,ue.x),V.y1=Math.min(X.y,Z.y,se.y,ue.y),V.y2=Math.max(X.y,Z.y,se.y,ue.y)}o.emplaceBack(h.x,h.y,V.x1,V.y1,V.x2,V.y2,f,_,b)}this.boxEndIndex=o.length}}class $A{constructor(o=[],h=((f,_)=>f<_?-1:f>_?1:0)){if(this.data=o,this.length=this.data.length,this.compare=h,this.length>0)for(let f=(this.length>>1)-1;f>=0;f--)this._down(f)}push(o){this.data.push(o),this._up(this.length++)}pop(){if(this.length===0)return;const o=this.data[0],h=this.data.pop();return--this.length>0&&(this.data[0]=h,this._down(0)),o}peek(){return this.data[0]}_up(o){const{data:h,compare:f}=this,_=h[o];for(;o>0;){const b=o-1>>1,w=h[b];if(f(_,w)>=0)break;h[o]=w,o=b}h[o]=_}_down(o){const{data:h,compare:f}=this,_=this.length>>1,b=h[o];for(;o<_;){let w=1+(o<<1);const A=w+1;if(A<this.length&&f(h[A],h[w])<0&&(w=A),f(h[w],b)>=0)break;h[o]=h[w],o=w}h[o]=b}}function WA(c,o=1,h=!1){let f=1/0,_=1/0,b=-1/0,w=-1/0;const A=c[0];for(let j=0;j<A.length;j++){const X=A[j];(!j||X.x<f)&&(f=X.x),(!j||X.y<_)&&(_=X.y),(!j||X.x>b)&&(b=X.x),(!j||X.y>w)&&(w=X.y)}const I=Math.min(b-f,w-_);let R=I/2;const k=new $A([],HA);if(I===0)return new S(f,_);for(let j=f;j<b;j+=I)for(let X=_;X<w;X+=I)k.push(new Zl(j+R,X+R,R,c));let F=(function(j){let X=0,Z=0,se=0;const ue=j[0];for(let Me=0,xe=ue.length,Ee=xe-1;Me<xe;Ee=Me++){const Ue=ue[Me],et=ue[Ee],mt=Ue.x*et.y-et.x*Ue.y;Z+=(Ue.x+et.x)*mt,se+=(Ue.y+et.y)*mt,X+=3*mt}return new Zl(Z/X,se/X,0,j)})(c),V=k.length;for(;k.length;){const j=k.pop();(j.d>F.d||!F.d)&&(F=j,h&&console.log("found best %d after %d probes",Math.round(1e4*j.d)/1e4,V)),j.max-F.d<=o||(R=j.h/2,k.push(new Zl(j.p.x-R,j.p.y-R,R,c)),k.push(new Zl(j.p.x+R,j.p.y-R,R,c)),k.push(new Zl(j.p.x-R,j.p.y+R,R,c)),k.push(new Zl(j.p.x+R,j.p.y+R,R,c)),V+=4)}return h&&(console.log(`num probes: ${V}`),console.log(`best distance: ${F.d}`)),F.p}function HA(c,o){return o.max-c.max}function Zl(c,o,h,f){this.p=new S(c,o),this.h=h,this.d=(function(_,b){let w=!1,A=1/0;for(let I=0;I<b.length;I++){const R=b[I];for(let k=0,F=R.length,V=F-1;k<F;V=k++){const j=R[k],X=R[V];j.y>_.y!=X.y>_.y&&_.x<(X.x-j.x)*(_.y-j.y)/(X.y-j.y)+j.x&&(w=!w),A=Math.min(A,rx(_,j,X))}}return(w?1:-1)*Math.sqrt(A)})(this.p,f),this.max=this.d+this.h*Math.SQRT2}var yr;u.aq=void 0,(yr=u.aq||(u.aq={}))[yr.center=1]="center",yr[yr.left=2]="left",yr[yr.right=3]="right",yr[yr.top=4]="top",yr[yr.bottom=5]="bottom",yr[yr["top-left"]=6]="top-left",yr[yr["top-right"]=7]="top-right",yr[yr["bottom-left"]=8]="bottom-left",yr[yr["bottom-right"]=9]="bottom-right";const No=7,Dg=Number.POSITIVE_INFINITY;function bv(c,o){return o[1]!==Dg?(function(h,f,_){let b=0,w=0;switch(f=Math.abs(f),_=Math.abs(_),h){case"top-right":case"top-left":case"top":w=_-No;break;case"bottom-right":case"bottom-left":case"bottom":w=-_+No}switch(h){case"top-right":case"bottom-right":case"right":b=-f;break;case"top-left":case"bottom-left":case"left":b=f}return[b,w]})(c,o[0],o[1]):(function(h,f){let _=0,b=0;f<0&&(f=0);const w=f/Math.SQRT2;switch(h){case"top-right":case"top-left":b=w-No;break;case"bottom-right":case"bottom-left":b=-w+No;break;case"bottom":b=-f+No;break;case"top":b=f-No}switch(h){case"top-right":case"bottom-right":_=-w;break;case"top-left":case"bottom-left":_=w;break;case"left":_=f;break;case"right":_=-f}return[_,b]})(c,o[0])}function wv(c,o,h){var f;const _=c.layout,b=(f=_.get("text-variable-anchor-offset"))===null||f===void 0?void 0:f.evaluate(o,{},h);if(b){const A=b.values,I=[];for(let R=0;R<A.length;R+=2){const k=I[R]=A[R],F=A[R+1].map((V=>V*Qi));k.startsWith("top")?F[1]-=No:k.startsWith("bottom")&&(F[1]+=No),I[R+1]=F}return new ls(I)}const w=_.get("text-variable-anchor");if(w){let A;A=c._unevaluatedLayout.getValue("text-radial-offset")!==void 0?[_.get("text-radial-offset").evaluate(o,{},h)*Qi,Dg]:_.get("text-offset").evaluate(o,{},h).map((R=>R*Qi));const I=[];for(const R of w)I.push(R,bv(R,A));return new ls(I)}return null}function Og(c){switch(c){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function qA(c,o,h,f,_,b,w,A,I,R,k){let F=b.textMaxSize.evaluate(o,{});F===void 0&&(F=w);const V=c.layers[0].layout,j=V.get("icon-offset").evaluate(o,{},k),X=Sv(h.horizontal),Z=w/24,se=c.tilePixelRatio*Z,ue=c.tilePixelRatio*F/24,Me=c.tilePixelRatio*A,xe=c.tilePixelRatio*V.get("symbol-spacing"),Ee=V.get("text-padding")*c.tilePixelRatio,Ue=(function($e,Pt,It,Vt=1){const _i=$e.get("icon-padding").evaluate(Pt,{},It),gi=_i&&_i.values;return[gi[0]*Vt,gi[1]*Vt,gi[2]*Vt,gi[3]*Vt]})(V,o,k,c.tilePixelRatio),et=V.get("text-max-angle")/180*Math.PI,mt=V.get("text-rotation-alignment")!=="viewport"&&V.get("symbol-placement")!=="point",Ot=V.get("icon-rotation-alignment")==="map"&&V.get("symbol-placement")!=="point",pt=V.get("symbol-placement"),ut=xe/2,Ct=V.get("icon-text-fit");let Tt;f&&Ct!=="none"&&(c.allowVerticalPlacement&&h.vertical&&(Tt=Xx(f,h.vertical,Ct,V.get("icon-text-fit-padding"),j,Z)),X&&(f=Xx(f,X,Ct,V.get("icon-text-fit-padding"),j,Z)));const xt=($e,Pt)=>{Pt.x<0||Pt.x>=Yi||Pt.y<0||Pt.y>=Yi||(function(It,Vt,_i,gi,ir,Hs,xr,rr,Nr,zr,Ur,ji,sr,Ir,vr,Vr,br,Ps,rs,ai,vi,Ii,gs,Ni,Yl){const _n=It.addToLineVertexArray(Vt,_i);let yn,qs,Ms,ur,qn=0,Vu=0,Cv=0,Pv=0,jg=-1,$g=-1;const Xn={};let Mv=Ll("");if(It.allowVerticalPlacement&&gi.vertical){const Cr=rr.layout.get("text-rotate").evaluate(vi,{},Ni)+90;Ms=new Wd(Nr,Vt,zr,Ur,ji,gi.vertical,sr,Ir,vr,Cr),xr&&(ur=new Wd(Nr,Vt,zr,Ur,ji,xr,br,Ps,vr,Cr))}if(ir){const Cr=rr.layout.get("icon-rotate").evaluate(vi,{}),Rs=rr.layout.get("icon-text-fit")!=="none",Pa=xv(ir,Cr,gs,Rs),sn=xr?xv(xr,Cr,gs,Rs):void 0;qs=new Wd(Nr,Vt,zr,Ur,ji,ir,br,Ps,!1,Cr),qn=4*Pa.length;const Ma=It.iconSizeData;let xn=null;Ma.kind==="source"?(xn=[mn*rr.layout.get("icon-size").evaluate(vi,{})],xn[0]>Lo&&Ke(`${It.layerIds[0]}: Value for "icon-size" is >= ${Fu}. Reduce your "icon-size".`)):Ma.kind==="composite"&&(xn=[mn*Ii.compositeIconSizes[0].evaluate(vi,{},Ni),mn*Ii.compositeIconSizes[1].evaluate(vi,{},Ni)],(xn[0]>Lo||xn[1]>Lo)&&Ke(`${It.layerIds[0]}: Value for "icon-size" is >= ${Fu}. Reduce your "icon-size".`)),It.addSymbols(It.icon,Pa,xn,ai,rs,vi,u.ah.none,Vt,_n.lineStartIndex,_n.lineLength,-1,Ni),jg=It.icon.placedSymbolArray.length-1,sn&&(Vu=4*sn.length,It.addSymbols(It.icon,sn,xn,ai,rs,vi,u.ah.vertical,Vt,_n.lineStartIndex,_n.lineLength,-1,Ni),$g=It.icon.placedSymbolArray.length-1)}const Rv=Object.keys(gi.horizontal);for(const Cr of Rv){const Rs=gi.horizontal[Cr];if(!yn){Mv=Ll(Rs.text);const sn=rr.layout.get("text-rotate").evaluate(vi,{},Ni);yn=new Wd(Nr,Vt,zr,Ur,ji,Rs,sr,Ir,vr,sn)}const Pa=Rs.positionedLines.length===1;if(Cv+=Tv(It,Vt,Rs,Hs,rr,vr,vi,Vr,_n,gi.vertical?u.ah.horizontal:u.ah.horizontalOnly,Pa?Rv:[Cr],Xn,jg,Ii,Ni),Pa)break}gi.vertical&&(Pv+=Tv(It,Vt,gi.vertical,Hs,rr,vr,vi,Vr,_n,u.ah.vertical,["vertical"],Xn,$g,Ii,Ni));const YA=yn?yn.boxStartIndex:It.collisionBoxArray.length,GA=yn?yn.boxEndIndex:It.collisionBoxArray.length,KA=Ms?Ms.boxStartIndex:It.collisionBoxArray.length,JA=Ms?Ms.boxEndIndex:It.collisionBoxArray.length,QA=qs?qs.boxStartIndex:It.collisionBoxArray.length,eE=qs?qs.boxEndIndex:It.collisionBoxArray.length,tE=ur?ur.boxStartIndex:It.collisionBoxArray.length,iE=ur?ur.boxEndIndex:It.collisionBoxArray.length;let rn=-1;const qd=(Cr,Rs)=>Cr&&Cr.circleDiameter?Math.max(Cr.circleDiameter,Rs):Rs;rn=qd(yn,rn),rn=qd(Ms,rn),rn=qd(qs,rn),rn=qd(ur,rn);const kv=rn>-1?1:0;kv&&(rn*=Yl/Qi),It.glyphOffsetArray.length>=ql.MAX_GLYPHS&&Ke("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),vi.sortKey!==void 0&&It.addToSortKeyRanges(It.symbolInstances.length,vi.sortKey);const rE=wv(rr,vi,Ni),[sE,nE]=(function(Cr,Rs){const Pa=Cr.length,sn=Rs?.values;if(sn?.length>0)for(let Ma=0;Ma<sn.length;Ma+=2){const xn=sn[Ma+1];Cr.emplaceBack(u.aq[sn[Ma]],xn[0],xn[1])}return[Pa,Cr.length]})(It.textAnchorOffsets,rE);It.symbolInstances.emplaceBack(Vt.x,Vt.y,Xn.right>=0?Xn.right:-1,Xn.center>=0?Xn.center:-1,Xn.left>=0?Xn.left:-1,Xn.vertical||-1,jg,$g,Mv,YA,GA,KA,JA,QA,eE,tE,iE,zr,Cv,Pv,qn,Vu,kv,0,sr,rn,sE,nE)})(c,Pt,$e,h,f,_,Tt,c.layers[0],c.collisionBoxArray,o.index,o.sourceLayerIndex,c.index,se,[Ee,Ee,Ee,Ee],mt,I,Me,Ue,Ot,j,o,b,R,k,w)};if(pt==="line")for(const $e of fv(o.geometry,0,0,Yi,Yi)){const Pt=jA($e,xe,et,h.vertical||X,f,24,ue,c.overscaling,Yi);for(const It of Pt)X&&XA(c,X.text,ut,It)||xt($e,It)}else if(pt==="line-center"){for(const $e of o.geometry)if($e.length>1){const Pt=VA($e,et,h.vertical||X,f,24,ue);Pt&&xt($e,Pt)}}else if(o.type==="Polygon")for(const $e of hl(o.geometry,0)){const Pt=WA($e,16);xt($e[0],new Bo(Pt.x,Pt.y,0))}else if(o.type==="LineString")for(const $e of o.geometry)xt($e,new Bo($e[0].x,$e[0].y,0));else if(o.type==="Point")for(const $e of o.geometry)for(const Pt of $e)xt([Pt],new Bo(Pt.x,Pt.y,0))}function Tv(c,o,h,f,_,b,w,A,I,R,k,F,V,j,X){const Z=(function(Me,xe,Ee,Ue,et,mt,Ot,pt){const ut=Ue.layout.get("text-rotate").evaluate(mt,{})*Math.PI/180,Ct=[];for(const Tt of xe.positionedLines)for(const xt of Tt.positionedGlyphs){if(!xt.rect)continue;const $e=xt.rect||{};let Pt=zx+1,It=!0,Vt=1,_i=0;const gi=(et||pt)&&xt.vertical,ir=xt.metrics.advance*xt.scale/2;if(pt&&xe.verticalizable&&(_i=Tt.lineOffset/2-(xt.imageName?-(Qi-xt.metrics.width*xt.scale)/2:(xt.scale-1)*Qi)),xt.imageName){const ai=Ot[xt.imageName];It=ai.sdf,Vt=ai.pixelRatio,Pt=is/Vt}const Hs=et?[xt.x+ir,xt.y]:[0,0];let xr=et?[0,0]:[xt.x+ir+Ee[0],xt.y+Ee[1]-_i],rr=[0,0];gi&&(rr=xr,xr=[0,0]);const Nr=xt.metrics.isDoubleResolution?2:1,zr=(xt.metrics.left-Pt)*xt.scale-ir+xr[0],Ur=(-xt.metrics.top-Pt)*xt.scale+xr[1],ji=zr+$e.w/Nr*xt.scale/Vt,sr=Ur+$e.h/Nr*xt.scale/Vt,Ir=new S(zr,Ur),vr=new S(ji,Ur),Vr=new S(zr,sr),br=new S(ji,sr);if(gi){const ai=new S(-ir,ir-Ou),vi=-Math.PI/2,Ii=Qi/2-ir,gs=new S(5-Ou-Ii,-(xt.imageName?Ii:0)),Ni=new S(...rr);Ir._rotateAround(vi,ai)._add(gs)._add(Ni),vr._rotateAround(vi,ai)._add(gs)._add(Ni),Vr._rotateAround(vi,ai)._add(gs)._add(Ni),br._rotateAround(vi,ai)._add(gs)._add(Ni)}if(ut){const ai=Math.sin(ut),vi=Math.cos(ut),Ii=[vi,-ai,ai,vi];Ir._matMult(Ii),vr._matMult(Ii),Vr._matMult(Ii),br._matMult(Ii)}const Ps=new S(0,0),rs=new S(0,0);Ct.push({tl:Ir,tr:vr,bl:Vr,br,tex:$e,writingMode:xe.writingMode,glyphOffset:Hs,sectionIndex:xt.sectionIndex,isSDF:It,pixelOffsetTL:Ps,pixelOffsetBR:rs,minFontScaleX:0,minFontScaleY:0})}return Ct})(0,h,A,_,b,w,f,c.allowVerticalPlacement),se=c.textSizeData;let ue=null;se.kind==="source"?(ue=[mn*_.layout.get("text-size").evaluate(w,{})],ue[0]>Lo&&Ke(`${c.layerIds[0]}: Value for "text-size" is >= ${Fu}. Reduce your "text-size".`)):se.kind==="composite"&&(ue=[mn*j.compositeTextSizes[0].evaluate(w,{},X),mn*j.compositeTextSizes[1].evaluate(w,{},X)],(ue[0]>Lo||ue[1]>Lo)&&Ke(`${c.layerIds[0]}: Value for "text-size" is >= ${Fu}. Reduce your "text-size".`)),c.addSymbols(c.text,Z,ue,A,b,w,R,o,I.lineStartIndex,I.lineLength,V,X);for(const Me of k)F[Me]=c.text.placedSymbolArray.length-1;return 4*Z.length}function Sv(c){for(const o in c)return c[o];return null}function XA(c,o,h,f){const _=c.compareText;if(o in _){const b=_[o];for(let w=b.length-1;w>=0;w--)if(f.dist(b[w])<h)return!0}else _[o]=[];return _[o].push(f),!1}const Av=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class Lg{static from(o){if(!(o instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[h,f]=new Uint8Array(o,0,2);if(h!==219)throw new Error("Data does not appear to be in a KDBush format.");const _=f>>4;if(_!==1)throw new Error(`Got v${_} data when expected v1.`);const b=Av[15&f];if(!b)throw new Error("Unrecognized array type.");const[w]=new Uint16Array(o,2,1),[A]=new Uint32Array(o,4,1);return new Lg(A,w,b,o)}constructor(o,h=64,f=Float64Array,_){if(isNaN(o)||o<0)throw new Error(`Unpexpected numItems value: ${o}.`);this.numItems=+o,this.nodeSize=Math.min(Math.max(+h,2),65535),this.ArrayType=f,this.IndexArrayType=o<65536?Uint16Array:Uint32Array;const b=Av.indexOf(this.ArrayType),w=2*o*this.ArrayType.BYTES_PER_ELEMENT,A=o*this.IndexArrayType.BYTES_PER_ELEMENT,I=(8-A%8)%8;if(b<0)throw new Error(`Unexpected typed array class: ${f}.`);_&&_ instanceof ArrayBuffer?(this.data=_,this.ids=new this.IndexArrayType(this.data,8,o),this.coords=new this.ArrayType(this.data,8+A+I,2*o),this._pos=2*o,this._finished=!0):(this.data=new ArrayBuffer(8+w+A+I),this.ids=new this.IndexArrayType(this.data,8,o),this.coords=new this.ArrayType(this.data,8+A+I,2*o),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+b]),new Uint16Array(this.data,2,1)[0]=h,new Uint32Array(this.data,4,1)[0]=o)}add(o,h){const f=this._pos>>1;return this.ids[f]=f,this.coords[this._pos++]=o,this.coords[this._pos++]=h,f}finish(){const o=this._pos>>1;if(o!==this.numItems)throw new Error(`Added ${o} items when expected ${this.numItems}.`);return Fg(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(o,h,f,_){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:b,coords:w,nodeSize:A}=this,I=[0,b.length-1,0],R=[];for(;I.length;){const k=I.pop()||0,F=I.pop()||0,V=I.pop()||0;if(F-V<=A){for(let se=V;se<=F;se++){const ue=w[2*se],Me=w[2*se+1];ue>=o&&ue<=f&&Me>=h&&Me<=_&&R.push(b[se])}continue}const j=V+F>>1,X=w[2*j],Z=w[2*j+1];X>=o&&X<=f&&Z>=h&&Z<=_&&R.push(b[j]),(k===0?o<=X:h<=Z)&&(I.push(V),I.push(j-1),I.push(1-k)),(k===0?f>=X:_>=Z)&&(I.push(j+1),I.push(F),I.push(1-k))}return R}within(o,h,f){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:_,coords:b,nodeSize:w}=this,A=[0,_.length-1,0],I=[],R=f*f;for(;A.length;){const k=A.pop()||0,F=A.pop()||0,V=A.pop()||0;if(F-V<=w){for(let se=V;se<=F;se++)Iv(b[2*se],b[2*se+1],o,h)<=R&&I.push(_[se]);continue}const j=V+F>>1,X=b[2*j],Z=b[2*j+1];Iv(X,Z,o,h)<=R&&I.push(_[j]),(k===0?o-f<=X:h-f<=Z)&&(A.push(V),A.push(j-1),A.push(1-k)),(k===0?o+f>=X:h+f>=Z)&&(A.push(j+1),A.push(F),A.push(1-k))}return I}}function Fg(c,o,h,f,_,b){if(_-f<=h)return;const w=f+_>>1;Ev(c,o,w,f,_,b),Fg(c,o,h,f,w-1,1-b),Fg(c,o,h,w+1,_,1-b)}function Ev(c,o,h,f,_,b){for(;_>f;){if(_-f>600){const R=_-f+1,k=h-f+1,F=Math.log(R),V=.5*Math.exp(2*F/3),j=.5*Math.sqrt(F*V*(R-V)/R)*(k-R/2<0?-1:1);Ev(c,o,h,Math.max(f,Math.floor(h-k*V/R+j)),Math.min(_,Math.floor(h+(R-k)*V/R+j)),b)}const w=o[2*h+b];let A=f,I=_;for(zu(c,o,f,h),o[2*_+b]>w&&zu(c,o,f,_);A<I;){for(zu(c,o,A,I),A++,I--;o[2*A+b]<w;)A++;for(;o[2*I+b]>w;)I--}o[2*f+b]===w?zu(c,o,f,I):(I++,zu(c,o,I,_)),I<=h&&(f=I+1),h<=I&&(_=I-1)}}function zu(c,o,h,f){Bg(c,h,f),Bg(o,2*h,2*f),Bg(o,2*h+1,2*f+1)}function Bg(c,o,h){const f=c[o];c[o]=c[h],c[h]=f}function Iv(c,o,h,f){const _=c-h,b=o-f;return _*_+b*b}var Ng;u.bg=void 0,(Ng=u.bg||(u.bg={})).create="create",Ng.load="load",Ng.fullLoad="fullLoad";let Hd=null,Uu=[];const zg=1e3/60,Ug="loadTime",Vg="fullLoadTime",ZA={mark(c){performance.mark(c)},frame(c){const o=c;Hd!=null&&Uu.push(o-Hd),Hd=o},clearMetrics(){Hd=null,Uu=[],performance.clearMeasures(Ug),performance.clearMeasures(Vg);for(const c in u.bg)performance.clearMarks(u.bg[c])},getPerformanceMetrics(){performance.measure(Ug,u.bg.create,u.bg.load),performance.measure(Vg,u.bg.create,u.bg.fullLoad);const c=performance.getEntriesByName(Ug)[0].duration,o=performance.getEntriesByName(Vg)[0].duration,h=Uu.length,f=1/(Uu.reduce(((b,w)=>b+w),0)/h/1e3),_=Uu.filter((b=>b>zg)).reduce(((b,w)=>b+(w-zg)/zg),0);return{loadTime:c,fullLoadTime:o,fps:f,percentDroppedFrames:_/(h+_)*100,totalFrames:h}}};u.$=class extends N{},u.A=Ul,u.B=Yp,u.C=function(c){if(ie==null){const o=c.navigator?c.navigator.userAgent:null;ie=!!c.safari||!(!o||!(/\b(iPad|iPhone|iPod)\b/.test(o)||o.match("Safari")&&!o.match("Chrome")))}return ie},u.D=St,u.E=Lt,u.F=class{constructor(c,o){this.target=c,this.mapId=o,this.resolveRejects={},this.tasks={},this.taskQueue=[],this.abortControllers={},this.messageHandlers={},this.invoker=new zA((()=>this.process())),this.subscription=(function(h,f,_,b){return h.addEventListener(f,_,!1),{unsubscribe:()=>{h.removeEventListener(f,_,!1)}}})(this.target,"message",(h=>this.receive(h))),this.globalScope=ve(self)?c:window}registerMessageHandler(c,o){this.messageHandlers[c]=o}sendAsync(c,o){return new Promise(((h,f)=>{const _=Math.round(1e18*Math.random()).toString(36).substring(0,10);this.resolveRejects[_]={resolve:h,reject:f},o&&o.signal.addEventListener("abort",(()=>{delete this.resolveRejects[_];const A={id:_,type:"<cancel>",origin:location.origin,targetMapId:c.targetMapId,sourceMapId:this.mapId};this.target.postMessage(A)}),{once:!0});const b=[],w=Object.assign(Object.assign({},c),{id:_,sourceMapId:this.mapId,origin:location.origin,data:To(c.data,b)});this.target.postMessage(w,{transfer:b})}))}receive(c){const o=c.data,h=o.id;if(!(o.origin!=="file://"&&location.origin!=="file://"&&o.origin!=="resource://android"&&location.origin!=="resource://android"&&o.origin!==location.origin||o.targetMapId&&this.mapId!==o.targetMapId)){if(o.type==="<cancel>"){delete this.tasks[h];const f=this.abortControllers[h];return delete this.abortControllers[h],void(f&&f.abort())}if(ve(self)||o.mustQueue)return this.tasks[h]=o,this.taskQueue.push(h),void this.invoker.trigger();this.processTask(h,o)}}process(){if(this.taskQueue.length===0)return;const c=this.taskQueue.shift(),o=this.tasks[c];delete this.tasks[c],this.taskQueue.length>0&&this.invoker.trigger(),o&&this.processTask(c,o)}processTask(c,o){return l(this,void 0,void 0,(function*(){if(o.type==="<response>"){const _=this.resolveRejects[c];return delete this.resolveRejects[c],_?void(o.error?_.reject(So(o.error)):_.resolve(So(o.data))):void 0}if(!this.messageHandlers[o.type])return void this.completeTask(c,new Error(`Could not find a registered handler for ${o.type}, map ID: ${this.mapId}, available handlers: ${Object.keys(this.messageHandlers).join(", ")}`));const h=So(o.data),f=new AbortController;this.abortControllers[c]=f;try{const _=yield this.messageHandlers[o.type](o.sourceMapId,h,f);this.completeTask(c,null,_)}catch(_){this.completeTask(c,_)}}))}completeTask(c,o,h){const f=[];delete this.abortControllers[c];const _={id:c,type:"<response>",sourceMapId:this.mapId,origin:location.origin,error:o?To(o):null,data:To(h,f)};this.target.postMessage(_,{transfer:f})}remove(){this.invoker.remove(),this.subscription.unsubscribe()}},u.G=$t,u.H=function(){var c=new Ul(16);return Ul!=Float32Array&&(c[1]=0,c[2]=0,c[3]=0,c[4]=0,c[6]=0,c[7]=0,c[8]=0,c[9]=0,c[11]=0,c[12]=0,c[13]=0,c[14]=0),c[0]=1,c[5]=1,c[10]=1,c[15]=1,c},u.I=wg,u.J=function(c,o,h){var f,_,b,w,A,I,R,k,F,V,j,X,Z=h[0],se=h[1],ue=h[2];return o===c?(c[12]=o[0]*Z+o[4]*se+o[8]*ue+o[12],c[13]=o[1]*Z+o[5]*se+o[9]*ue+o[13],c[14]=o[2]*Z+o[6]*se+o[10]*ue+o[14],c[15]=o[3]*Z+o[7]*se+o[11]*ue+o[15]):(_=o[1],b=o[2],w=o[3],A=o[4],I=o[5],R=o[6],k=o[7],F=o[8],V=o[9],j=o[10],X=o[11],c[0]=f=o[0],c[1]=_,c[2]=b,c[3]=w,c[4]=A,c[5]=I,c[6]=R,c[7]=k,c[8]=F,c[9]=V,c[10]=j,c[11]=X,c[12]=f*Z+A*se+F*ue+o[12],c[13]=_*Z+I*se+V*ue+o[13],c[14]=b*Z+R*se+j*ue+o[14],c[15]=w*Z+k*se+X*ue+o[15]),c},u.K=function(c,o,h){var f=h[0],_=h[1],b=h[2];return c[0]=o[0]*f,c[1]=o[1]*f,c[2]=o[2]*f,c[3]=o[3]*f,c[4]=o[4]*_,c[5]=o[5]*_,c[6]=o[6]*_,c[7]=o[7]*_,c[8]=o[8]*b,c[9]=o[9]*b,c[10]=o[10]*b,c[11]=o[11]*b,c[12]=o[12],c[13]=o[13],c[14]=o[14],c[15]=o[15],c},u.L=ax,u.M=function(c,o){const h={};for(let f=0;f<o.length;f++){const _=o[f];_ in c&&(h[_]=c[_])}return h},u.N=Fo,u.O=iv,u.P=S,u.Q=rv,u.R=Is,u.S=Cs,u.T=Ml,u.U=Q,u.V=ae,u.W=ke,u.X=Yi,u.Y=E,u.Z=Bu,u._=l,u.a=wt,u.a$=function(c,o){var h=c[0],f=c[1],_=c[2],b=c[3],w=c[4],A=c[5],I=c[6],R=c[7],k=c[8],F=c[9],V=c[10],j=c[11],X=c[12],Z=c[13],se=c[14],ue=c[15],Me=o[0],xe=o[1],Ee=o[2],Ue=o[3],et=o[4],mt=o[5],Ot=o[6],pt=o[7],ut=o[8],Ct=o[9],Tt=o[10],xt=o[11],$e=o[12],Pt=o[13],It=o[14],Vt=o[15];return Math.abs(h-Me)<=Br*Math.max(1,Math.abs(h),Math.abs(Me))&&Math.abs(f-xe)<=Br*Math.max(1,Math.abs(f),Math.abs(xe))&&Math.abs(_-Ee)<=Br*Math.max(1,Math.abs(_),Math.abs(Ee))&&Math.abs(b-Ue)<=Br*Math.max(1,Math.abs(b),Math.abs(Ue))&&Math.abs(w-et)<=Br*Math.max(1,Math.abs(w),Math.abs(et))&&Math.abs(A-mt)<=Br*Math.max(1,Math.abs(A),Math.abs(mt))&&Math.abs(I-Ot)<=Br*Math.max(1,Math.abs(I),Math.abs(Ot))&&Math.abs(R-pt)<=Br*Math.max(1,Math.abs(R),Math.abs(pt))&&Math.abs(k-ut)<=Br*Math.max(1,Math.abs(k),Math.abs(ut))&&Math.abs(F-Ct)<=Br*Math.max(1,Math.abs(F),Math.abs(Ct))&&Math.abs(V-Tt)<=Br*Math.max(1,Math.abs(V),Math.abs(Tt))&&Math.abs(j-xt)<=Br*Math.max(1,Math.abs(j),Math.abs(xt))&&Math.abs(X-$e)<=Br*Math.max(1,Math.abs(X),Math.abs($e))&&Math.abs(Z-Pt)<=Br*Math.max(1,Math.abs(Z),Math.abs(Pt))&&Math.abs(se-It)<=Br*Math.max(1,Math.abs(se),Math.abs(It))&&Math.abs(ue-Vt)<=Br*Math.max(1,Math.abs(ue),Math.abs(Vt))},u.a0=ti,u.a1=kg,u.a2=st,u.a3=c=>{const o=window.document.createElement("video");return o.muted=!0,new Promise((h=>{o.onloadstart=()=>{h(o)};for(const f of c){const _=window.document.createElement("source");Et(f)||(o.crossOrigin="Anonymous"),_.src=f,o.appendChild(_)}}))},u.a4=function(){return it++},u.a5=gt,u.a6=ql,u.a7=ru,u.a8=Ia,u.a9=cv,u.aA=function(c){if(c.type==="custom")return new NA(c);switch(c.type){case"background":return new LA(c);case"circle":return new wS(c);case"fill":return new zS(c);case"fill-extrusion":return new eA(c);case"heatmap":return new SS(c);case"hillshade":return new ES(c);case"line":return new lA(c);case"raster":return new BA(c);case"symbol":return new Ud(c)}},u.aB=Ye,u.aC=function(c,o){if(!c)return[{command:"setStyle",args:[o]}];let h=[];try{if(!ii(c.version,o.version))return[{command:"setStyle",args:[o]}];ii(c.center,o.center)||h.push({command:"setCenter",args:[o.center]}),ii(c.zoom,o.zoom)||h.push({command:"setZoom",args:[o.zoom]}),ii(c.bearing,o.bearing)||h.push({command:"setBearing",args:[o.bearing]}),ii(c.pitch,o.pitch)||h.push({command:"setPitch",args:[o.pitch]}),ii(c.sprite,o.sprite)||h.push({command:"setSprite",args:[o.sprite]}),ii(c.glyphs,o.glyphs)||h.push({command:"setGlyphs",args:[o.glyphs]}),ii(c.transition,o.transition)||h.push({command:"setTransition",args:[o.transition]}),ii(c.light,o.light)||h.push({command:"setLight",args:[o.light]}),ii(c.terrain,o.terrain)||h.push({command:"setTerrain",args:[o.terrain]}),ii(c.sky,o.sky)||h.push({command:"setSky",args:[o.sky]}),ii(c.projection,o.projection)||h.push({command:"setProjection",args:[o.projection]});const f={},_=[];(function(w,A,I,R){let k;for(k in A=A||{},w=w||{})Object.prototype.hasOwnProperty.call(w,k)&&(Object.prototype.hasOwnProperty.call(A,k)||Ns(k,I,R));for(k in A)Object.prototype.hasOwnProperty.call(A,k)&&(Object.prototype.hasOwnProperty.call(w,k)?ii(w[k],A[k])||(w[k].type==="geojson"&&A[k].type==="geojson"&&zs(w,A,k)?wi(I,{command:"setGeoJSONSourceData",args:[k,A[k].data]}):_s(k,A,I,R)):qi(k,A,I))})(c.sources,o.sources,_,f);const b=[];c.layers&&c.layers.forEach((w=>{"source"in w&&f[w.source]?h.push({command:"removeLayer",args:[w.id]}):b.push(w)})),h=h.concat(_),(function(w,A,I){A=A||[];const R=(w=w||[]).map(Pn),k=A.map(Pn),F=w.reduce(Mn,{}),V=A.reduce(Mn,{}),j=R.slice(),X=Object.create(null);let Z,se,ue,Me,xe;for(let Ee=0,Ue=0;Ee<R.length;Ee++)Z=R[Ee],Object.prototype.hasOwnProperty.call(V,Z)?Ue++:(wi(I,{command:"removeLayer",args:[Z]}),j.splice(j.indexOf(Z,Ue),1));for(let Ee=0,Ue=0;Ee<k.length;Ee++)Z=k[k.length-1-Ee],j[j.length-1-Ee]!==Z&&(Object.prototype.hasOwnProperty.call(F,Z)?(wi(I,{command:"removeLayer",args:[Z]}),j.splice(j.lastIndexOf(Z,j.length-Ue),1)):Ue++,Me=j[j.length-Ee],wi(I,{command:"addLayer",args:[V[Z],Me]}),j.splice(j.length-Ee,0,Z),X[Z]=!0);for(let Ee=0;Ee<k.length;Ee++)if(Z=k[Ee],se=F[Z],ue=V[Z],!X[Z]&&!ii(se,ue))if(ii(se.source,ue.source)&&ii(se["source-layer"],ue["source-layer"])&&ii(se.type,ue.type)){for(xe in kr(se.layout,ue.layout,I,Z,null,"setLayoutProperty"),kr(se.paint,ue.paint,I,Z,null,"setPaintProperty"),ii(se.filter,ue.filter)||wi(I,{command:"setFilter",args:[Z,ue.filter]}),ii(se.minzoom,ue.minzoom)&&ii(se.maxzoom,ue.maxzoom)||wi(I,{command:"setLayerZoomRange",args:[Z,ue.minzoom,ue.maxzoom]}),se)Object.prototype.hasOwnProperty.call(se,xe)&&xe!=="layout"&&xe!=="paint"&&xe!=="filter"&&xe!=="metadata"&&xe!=="minzoom"&&xe!=="maxzoom"&&(xe.indexOf("paint.")===0?kr(se[xe],ue[xe],I,Z,xe.slice(6),"setPaintProperty"):ii(se[xe],ue[xe])||wi(I,{command:"setLayerProperty",args:[Z,xe,ue[xe]]}));for(xe in ue)Object.prototype.hasOwnProperty.call(ue,xe)&&!Object.prototype.hasOwnProperty.call(se,xe)&&xe!=="layout"&&xe!=="paint"&&xe!=="filter"&&xe!=="metadata"&&xe!=="minzoom"&&xe!=="maxzoom"&&(xe.indexOf("paint.")===0?kr(se[xe],ue[xe],I,Z,xe.slice(6),"setPaintProperty"):ii(se[xe],ue[xe])||wi(I,{command:"setLayerProperty",args:[Z,xe,ue[xe]]}))}else wi(I,{command:"removeLayer",args:[Z]}),Me=j[j.lastIndexOf(Z)+1],wi(I,{command:"addLayer",args:[ue,Me]})})(b,o.layers,h)}catch(f){console.warn("Unable to compute style diff:",f),h=[{command:"setStyle",args:[o]}]}return h},u.aD=function(c){const o=[],h=c.id;return h===void 0&&o.push({message:`layers.${h}: missing required property "id"`}),c.render===void 0&&o.push({message:`layers.${h}: missing required method "render"`}),c.renderingMode&&c.renderingMode!=="2d"&&c.renderingMode!=="3d"&&o.push({message:`layers.${h}: property "renderingMode" must be either "2d" or "3d"`}),o},u.aE=function c(o,h){if(Array.isArray(o)){if(!Array.isArray(h)||o.length!==h.length)return!1;for(let f=0;f<o.length;f++)if(!c(o[f],h[f]))return!1;return!0}if(typeof o=="object"&&o!==null&&h!==null){if(typeof h!="object"||Object.keys(o).length!==Object.keys(h).length)return!1;for(const f in o)if(!c(o[f],h[f]))return!1;return!0}return o===h},u.aF=He,u.aG=ht,u.aH=class extends Sa{constructor(c,o){super(c,o),this.current=0}set(c){this.current!==c&&(this.current=c,this.gl.uniform1i(this.location,c))}},u.aI=Id,u.aJ=class extends Sa{constructor(c,o){super(c,o),this.current=pS}set(c){if(c[12]!==this.current[12]||c[0]!==this.current[0])return this.current=c,void this.gl.uniformMatrix4fv(this.location,!1,c);for(let o=1;o<16;o++)if(c[o]!==this.current[o]){this.current=c,this.gl.uniformMatrix4fv(this.location,!1,c);break}}},u.aK=Gy,u.aL=Ky,u.aM=di,u.aN=class extends Sa{constructor(c,o){super(c,o),this.current=[0,0,0]}set(c){c[0]===this.current[0]&&c[1]===this.current[1]&&c[2]===this.current[2]||(this.current=c,this.gl.uniform3f(this.location,c[0],c[1],c[2]))}},u.aO=class extends Sa{constructor(c,o){super(c,o),this.current=[0,0]}set(c){c[0]===this.current[0]&&c[1]===this.current[1]||(this.current=c,this.gl.uniform2f(this.location,c[0],c[1]))}},u.aP=function(c,o,h,f,_,b,w){var A=1/(o-h),I=1/(f-_),R=1/(b-w);return c[0]=-2*A,c[1]=0,c[2]=0,c[3]=0,c[4]=0,c[5]=-2*I,c[6]=0,c[7]=0,c[8]=0,c[9]=0,c[10]=2*R,c[11]=0,c[12]=(o+h)*A,c[13]=(_+f)*I,c[14]=(w+b)*R,c[15]=1,c},u.aQ=bS,u.aR=class extends be{},u.aS=dA,u.aT=class extends De{},u.aU=ug,u.aV=function(c){return c<=1?1:Math.pow(2,Math.ceil(Math.log(c)/Math.LN2))},u.aW=dx,u.aX=mr,u.aY=Es,u.aZ=class extends At{},u.a_=function(c,o){return c[0]===o[0]&&c[1]===o[1]&&c[2]===o[2]&&c[3]===o[3]&&c[4]===o[4]&&c[5]===o[5]&&c[6]===o[6]&&c[7]===o[7]&&c[8]===o[8]&&c[9]===o[9]&&c[10]===o[10]&&c[11]===o[11]&&c[12]===o[12]&&c[13]===o[13]&&c[14]===o[14]&&c[15]===o[15]},u.aa=function(c){const o={};if(c.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,((h,f,_,b)=>{const w=_||b;return o[f]=!w||w.toLowerCase(),""})),o["max-age"]){const h=parseInt(o["max-age"],10);isNaN(h)?delete o["max-age"]:o["max-age"]=h}return o},u.ab=function(c,o){const h=[];for(const f in c)f in o||h.push(f);return h},u.ac=we,u.ad=function(c,o,h){var f=Math.sin(h),_=Math.cos(h),b=o[0],w=o[1],A=o[2],I=o[3],R=o[4],k=o[5],F=o[6],V=o[7];return o!==c&&(c[8]=o[8],c[9]=o[9],c[10]=o[10],c[11]=o[11],c[12]=o[12],c[13]=o[13],c[14]=o[14],c[15]=o[15]),c[0]=b*_+R*f,c[1]=w*_+k*f,c[2]=A*_+F*f,c[3]=I*_+V*f,c[4]=R*_-b*f,c[5]=k*_-w*f,c[6]=F*_-A*f,c[7]=V*_-I*f,c},u.ae=function(c){var o=new Ul(16);return o[0]=c[0],o[1]=c[1],o[2]=c[2],o[3]=c[3],o[4]=c[4],o[5]=c[5],o[6]=c[6],o[7]=c[7],o[8]=c[8],o[9]=c[9],o[10]=c[10],o[11]=c[11],o[12]=c[12],o[13]=c[13],o[14]=c[14],o[15]=c[15],o},u.af=Rd,u.ag=function(c,o){let h=0,f=0;if(c.kind==="constant")f=c.layoutSize;else if(c.kind!=="source"){const{interpolationType:_,minZoom:b,maxZoom:w}=c,A=_?we(Lr.interpolationFactor(_,o,b,w),0,1):0;c.kind==="camera"?f=Or.number(c.minSize,c.maxSize,A):h=A}return{uSizeT:h,uSize:f}},u.ai=function(c,{uSize:o,uSizeT:h},{lowerSize:f,upperSize:_}){return c.kind==="source"?f/mn:c.kind==="composite"?Or.number(f/mn,_/mn,h):o},u.aj=Eg,u.ak=function(c,o,h,f){const _=o.y-c.y,b=o.x-c.x,w=f.y-h.y,A=f.x-h.x,I=w*b-A*_;if(I===0)return null;const R=(A*(c.y-h.y)-w*(c.x-h.x))/I;return new S(c.x+R*b,c.y+R*_)},u.al=fv,u.am=tx,u.an=ag,u.ao=function(c){let o=1/0,h=1/0,f=-1/0,_=-1/0;for(const b of c)o=Math.min(o,b.x),h=Math.min(h,b.y),f=Math.max(f,b.x),_=Math.max(_,b.y);return[o,h,f,_]},u.ap=Qi,u.ar=Ag,u.as=function(c,o){var h=o[0],f=o[1],_=o[2],b=o[3],w=o[4],A=o[5],I=o[6],R=o[7],k=o[8],F=o[9],V=o[10],j=o[11],X=o[12],Z=o[13],se=o[14],ue=o[15],Me=h*A-f*w,xe=h*I-_*w,Ee=h*R-b*w,Ue=f*I-_*A,et=f*R-b*A,mt=_*R-b*I,Ot=k*Z-F*X,pt=k*se-V*X,ut=k*ue-j*X,Ct=F*se-V*Z,Tt=F*ue-j*Z,xt=V*ue-j*se,$e=Me*xt-xe*Tt+Ee*Ct+Ue*ut-et*pt+mt*Ot;return $e?(c[0]=(A*xt-I*Tt+R*Ct)*($e=1/$e),c[1]=(_*Tt-f*xt-b*Ct)*$e,c[2]=(Z*mt-se*et+ue*Ue)*$e,c[3]=(V*et-F*mt-j*Ue)*$e,c[4]=(I*ut-w*xt-R*pt)*$e,c[5]=(h*xt-_*ut+b*pt)*$e,c[6]=(se*Ee-X*mt-ue*xe)*$e,c[7]=(k*mt-V*Ee+j*xe)*$e,c[8]=(w*Tt-A*ut+R*Ot)*$e,c[9]=(f*ut-h*Tt-b*Ot)*$e,c[10]=(X*et-Z*Ee+ue*Me)*$e,c[11]=(F*Ee-k*et-j*Me)*$e,c[12]=(A*pt-w*Ct-I*Ot)*$e,c[13]=(h*Ct-f*pt+_*Ot)*$e,c[14]=(Z*xe-X*Ue-se*Me)*$e,c[15]=(k*Ue-F*xe+V*Me)*$e,c):null},u.at=Og,u.au=Sg,u.av=Lg,u.aw=function(){const c={},o=Ce.$version;for(const h in Ce.$root){const f=Ce.$root[h];if(f.required){let _=null;_=h==="version"?o:f.type==="array"?[]:{},_!=null&&(c[h]=_)}}return c},u.ax=_u,u.ay=Bt,u.az=function(c){c=c.slice();const o=Object.create(null);for(let h=0;h<c.length;h++)o[c[h].id]=c[h];for(let h=0;h<c.length;h++)"ref"in c[h]&&(c[h]=os(c[h],o[c[h].ref]));return c},u.b=ge,u.b0=function(c,o){return c[0]=o[0],c[1]=o[1],c[2]=o[2],c[3]=o[3],c[4]=o[4],c[5]=o[5],c[6]=o[6],c[7]=o[7],c[8]=o[8],c[9]=o[9],c[10]=o[10],c[11]=o[11],c[12]=o[12],c[13]=o[13],c[14]=o[14],c[15]=o[15],c},u.b1=function(c,o,h){return c[0]=o[0]*h[0],c[1]=o[1]*h[1],c[2]=o[2]*h[2],c[3]=o[3]*h[3],c},u.b2=function(c,o){return c[0]*o[0]+c[1]*o[1]+c[2]*o[2]+c[3]*o[3]},u.b3=Oe,u.b4=ov,u.b5=sv,u.b6=function(c,o,h,f,_){var b,w=1/Math.tan(o/2);return c[0]=w/h,c[1]=0,c[2]=0,c[3]=0,c[4]=0,c[5]=w,c[6]=0,c[7]=0,c[8]=0,c[9]=0,c[11]=-1,c[12]=0,c[13]=0,c[15]=0,_!=null&&_!==1/0?(c[10]=(_+f)*(b=1/(f-_)),c[14]=2*_*f*b):(c[10]=-1,c[14]=-2*f),c},u.b7=function(c,o,h){var f=Math.sin(h),_=Math.cos(h),b=o[4],w=o[5],A=o[6],I=o[7],R=o[8],k=o[9],F=o[10],V=o[11];return o!==c&&(c[0]=o[0],c[1]=o[1],c[2]=o[2],c[3]=o[3],c[12]=o[12],c[13]=o[13],c[14]=o[14],c[15]=o[15]),c[4]=b*_+R*f,c[5]=w*_+k*f,c[6]=A*_+F*f,c[7]=I*_+V*f,c[8]=R*_-b*f,c[9]=k*_-w*f,c[10]=F*_-A*f,c[11]=V*_-I*f,c},u.b8=te,u.b9=me,u.bA=kx,u.bB=function(c){return c.message===We},u.bC=_o,u.bD=es,u.ba=function(c){return c*Math.PI/180},u.bb=function(c,o){const{x:h,y:f}=Bu.fromLngLat(o);return!(c<0||c>25||f<0||f>=1||h<0||h>=1)},u.bc=function(c,o){return c[0]=o[0],c[1]=0,c[2]=0,c[3]=0,c[4]=0,c[5]=o[1],c[6]=0,c[7]=0,c[8]=0,c[9]=0,c[10]=o[2],c[11]=0,c[12]=0,c[13]=0,c[14]=0,c[15]=1,c},u.bd=class extends D{},u.be=Mg,u.bf=ZA,u.bh=kt,u.bi=function(c,o){wt.REGISTERED_PROTOCOLS[c]=o},u.bj=function(c){delete wt.REGISTERED_PROTOCOLS[c]},u.bk=function(c,o){const h={};for(let _=0;_<c.length;_++){const b=o&&o[c[_].id]||gd(c[_]);o&&(o[c[_].id]=b);let w=h[b];w||(w=h[b]=[]),w.push(c[_])}const f=[];for(const _ in h)f.push(h[_]);return f},u.bl=vt,u.bm=lv,u.bn=uv,u.bo=Vx,u.bp=function(c){c.bucket.createArrays(),c.bucket.tilePixelRatio=Yi/(512*c.bucket.overscaling),c.bucket.compareText={},c.bucket.iconsNeedLinear=!1;const o=c.bucket.layers[0],h=o.layout,f=o._unevaluatedLayout._values,_={layoutIconSize:f["icon-size"].possiblyEvaluate(new Ti(c.bucket.zoom+1),c.canonical),layoutTextSize:f["text-size"].possiblyEvaluate(new Ti(c.bucket.zoom+1),c.canonical),textMaxSize:f["text-size"].possiblyEvaluate(new Ti(18))};if(c.bucket.textSizeData.kind==="composite"){const{minZoom:R,maxZoom:k}=c.bucket.textSizeData;_.compositeTextSizes=[f["text-size"].possiblyEvaluate(new Ti(R),c.canonical),f["text-size"].possiblyEvaluate(new Ti(k),c.canonical)]}if(c.bucket.iconSizeData.kind==="composite"){const{minZoom:R,maxZoom:k}=c.bucket.iconSizeData;_.compositeIconSizes=[f["icon-size"].possiblyEvaluate(new Ti(R),c.canonical),f["icon-size"].possiblyEvaluate(new Ti(k),c.canonical)]}const b=h.get("text-line-height")*Qi,w=h.get("text-rotation-alignment")!=="viewport"&&h.get("symbol-placement")!=="point",A=h.get("text-keep-upright"),I=h.get("text-size");for(const R of c.bucket.features){const k=h.get("text-font").evaluate(R,{},c.canonical).join(","),F=I.evaluate(R,{},c.canonical),V=_.layoutTextSize.evaluate(R,{},c.canonical),j=_.layoutIconSize.evaluate(R,{},c.canonical),X={horizontal:{},vertical:void 0},Z=R.text;let se,ue=[0,0];if(Z){const Ee=Z.toString(),Ue=h.get("text-letter-spacing").evaluate(R,{},c.canonical)*Qi,et=Gp(Ee)?Ue:0,mt=h.get("text-anchor").evaluate(R,{},c.canonical),Ot=wv(o,R,c.canonical);if(!Ot){const Tt=h.get("text-radial-offset").evaluate(R,{},c.canonical);ue=Tt?bv(mt,[Tt*Qi,Dg]):h.get("text-offset").evaluate(R,{},c.canonical).map((xt=>xt*Qi))}let pt=w?"center":h.get("text-justify").evaluate(R,{},c.canonical);const ut=h.get("symbol-placement")==="point"?h.get("text-max-width").evaluate(R,{},c.canonical)*Qi:1/0,Ct=()=>{c.bucket.allowVerticalPlacement&&yu(Ee)&&(X.vertical=Bd(Z,c.glyphMap,c.glyphPositions,c.imagePositions,k,ut,b,mt,"left",et,ue,u.ah.vertical,!0,V,F))};if(!w&&Ot){const Tt=new Set;if(pt==="auto")for(let $e=0;$e<Ot.values.length;$e+=2)Tt.add(Og(Ot.values[$e]));else Tt.add(pt);let xt=!1;for(const $e of Tt)if(!X.horizontal[$e])if(xt)X.horizontal[$e]=X.horizontal[0];else{const Pt=Bd(Z,c.glyphMap,c.glyphPositions,c.imagePositions,k,ut,b,"center",$e,et,ue,u.ah.horizontal,!1,V,F);Pt&&(X.horizontal[$e]=Pt,xt=Pt.positionedLines.length===1)}Ct()}else{pt==="auto"&&(pt=Og(mt));const Tt=Bd(Z,c.glyphMap,c.glyphPositions,c.imagePositions,k,ut,b,mt,pt,et,ue,u.ah.horizontal,!1,V,F);Tt&&(X.horizontal[pt]=Tt),Ct(),yu(Ee)&&w&&A&&(X.vertical=Bd(Z,c.glyphMap,c.glyphPositions,c.imagePositions,k,ut,b,mt,pt,et,ue,u.ah.vertical,!1,V,F))}}let Me=!1;if(R.icon&&R.icon.name){const Ee=c.imageMap[R.icon.name];Ee&&(se=MA(c.imagePositions[R.icon.name],h.get("icon-offset").evaluate(R,{},c.canonical),h.get("icon-anchor").evaluate(R,{},c.canonical)),Me=!!Ee.sdf,c.bucket.sdfIcons===void 0?c.bucket.sdfIcons=Me:c.bucket.sdfIcons!==Me&&Ke("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(Ee.pixelRatio!==c.bucket.pixelRatio||h.get("icon-rotate").constantOr(1)!==0)&&(c.bucket.iconsNeedLinear=!0))}const xe=Sv(X.horizontal)||X.vertical;c.bucket.iconsInText=!!xe&&xe.iconsInText,(xe||se)&&qA(c.bucket,R,X,se,c.imageMap,_,V,j,ue,Me,c.canonical)}c.showCollisionBoxes&&c.bucket.generateCollisionDebugBuffers()},u.bq=yg,u.br=gg,u.bs=_g,u.bt=Do,u.bu=vg,u.bv=class{constructor(c){this._marks={start:[c.url,"start"].join("#"),end:[c.url,"end"].join("#"),measure:c.url.toString()},performance.mark(this._marks.start)}finish(){performance.mark(this._marks.end);let c=performance.getEntriesByName(this._marks.measure);return c.length===0&&(performance.measure(this._marks.measure,this._marks.start,this._marks.end),c=performance.getEntriesByName(this._marks.measure),performance.clearMarks(this._marks.start),performance.clearMarks(this._marks.end),performance.clearMeasures(this._marks.measure)),c}},u.bw=function(c,o,h,f,_){return l(this,void 0,void 0,(function*(){if(ae())try{return yield ke(c,o,h,f,_)}catch{}return(function(b,w,A,I,R){const k=b.width,F=b.height;Be&&Ve||(Be=new OffscreenCanvas(k,F),Ve=Be.getContext("2d",{willReadFrequently:!0})),Be.width=k,Be.height=F,Ve.drawImage(b,0,0,k,F);const V=Ve.getImageData(w,A,I,R);return Ve.clearRect(0,0,k,F),V.data})(c,o,h,f,_)}))},u.bx=av,u.by=g,u.bz=v,u.c=tt,u.d=c=>l(void 0,void 0,void 0,(function*(){if(c.byteLength===0)return createImageBitmap(new ImageData(1,1));const o=new Blob([new Uint8Array(c)],{type:"image/png"});try{return createImageBitmap(o)}catch(h){throw new Error(`Could not load image because of ${h.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`)}})),u.e=Je,u.f=c=>new Promise(((o,h)=>{const f=new Image;f.onload=()=>{o(f),URL.revokeObjectURL(f.src),f.onload=null,window.requestAnimationFrame((()=>{f.src=ce}))},f.onerror=()=>h(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const _=new Blob([new Uint8Array(c)],{type:"image/png"});f.src=c.byteLength?URL.createObjectURL(_):ce})),u.g=_t,u.h=(c,o)=>Kt(Je(c,{type:"json"}),o),u.i=ve,u.j=Fi,u.k=Ri,u.l=(c,o)=>Kt(Je(c,{type:"arrayBuffer"}),o),u.m=Kt,u.n=function(c){return new vg(c).readFields(TA,[])},u.o=Iu,u.p=Ux,u.q=x,u.r=Zp,u.s=Et,u.t=gu,u.u=jn,u.v=Ce,u.w=Ke,u.x=function([c,o,h]){return o+=90,o*=Math.PI/180,h*=Math.PI/180,{x:c*Math.cos(o)*Math.sin(h),y:c*Math.sin(o)*Math.sin(h),z:c*Math.cos(h)}},u.y=Or,u.z=Ti})),s("worker",["./shared"],(function(u){class l{constructor(B){this.keyCache={},B&&this.replace(B)}replace(B){this._layerConfigs={},this._layers={},this.update(B,[])}update(B,U){for(const ee of B){this._layerConfigs[ee.id]=ee;const pe=this._layers[ee.id]=u.aA(ee);pe._featureFilter=u.a7(pe.filter),this.keyCache[ee.id]&&delete this.keyCache[ee.id]}for(const ee of U)delete this.keyCache[ee],delete this._layerConfigs[ee],delete this._layers[ee];this.familiesBySource={};const q=u.bk(Object.values(this._layerConfigs),this.keyCache);for(const ee of q){const pe=ee.map((Ne=>this._layers[Ne.id])),ye=pe[0];if(ye.visibility==="none")continue;const Te=ye.source||"";let de=this.familiesBySource[Te];de||(de=this.familiesBySource[Te]={});const ze=ye.sourceLayer||"_geojsonTileLayer";let qe=de[ze];qe||(qe=de[ze]=[]),qe.push(pe)}}}class g{constructor(B){const U={},q=[];for(const Te in B){const de=B[Te],ze=U[Te]={};for(const qe in de){const Ne=de[+qe];if(!Ne||Ne.bitmap.width===0||Ne.bitmap.height===0)continue;const nt={x:0,y:0,w:Ne.bitmap.width+2,h:Ne.bitmap.height+2};q.push(nt),ze[qe]={rect:nt,metrics:Ne.metrics}}}const{w:ee,h:pe}=u.p(q),ye=new u.o({width:ee||1,height:pe||1});for(const Te in B){const de=B[Te];for(const ze in de){const qe=de[+ze];if(!qe||qe.bitmap.width===0||qe.bitmap.height===0)continue;const Ne=U[Te][ze].rect;u.o.copy(qe.bitmap,ye,{x:0,y:0},{x:Ne.x+1,y:Ne.y+1},qe.bitmap)}}this.image=ye,this.positions=U}}u.bl("GlyphAtlas",g);class v{constructor(B){this.tileID=new u.S(B.tileID.overscaledZ,B.tileID.wrap,B.tileID.canonical.z,B.tileID.canonical.x,B.tileID.canonical.y),this.uid=B.uid,this.zoom=B.zoom,this.pixelRatio=B.pixelRatio,this.tileSize=B.tileSize,this.source=B.source,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=B.showCollisionBoxes,this.collectResourceTiming=!!B.collectResourceTiming,this.returnDependencies=!!B.returnDependencies,this.promoteId=B.promoteId,this.inFlightDependencies=[]}parse(B,U,q,ee){return u._(this,void 0,void 0,(function*(){this.status="parsing",this.data=B,this.collisionBoxArray=new u.a5;const pe=new u.bm(Object.keys(B.layers).sort()),ye=new u.bn(this.tileID,this.promoteId);ye.bucketLayerIDs=[];const Te={},de={featureIndex:ye,iconDependencies:{},patternDependencies:{},glyphDependencies:{},availableImages:q},ze=U.familiesBySource[this.source];for(const Zt in ze){const hi=B.layers[Zt];if(!hi)continue;hi.version===1&&u.w(`Vector tile source "${this.source}" layer "${Zt}" does not use vector tile spec v2 and therefore may have some rendering errors.`);const ki=pe.encode(Zt),tr=[];for(let lr=0;lr<hi.length;lr++){const Sr=hi.feature(lr),no=ye.getId(Sr,Zt);tr.push({feature:Sr,id:no,index:lr,sourceLayerIndex:ki})}for(const lr of ze[Zt]){const Sr=lr[0];Sr.source!==this.source&&u.w(`layer.source = ${Sr.source} does not equal this.source = ${this.source}`),Sr.minzoom&&this.zoom<Math.floor(Sr.minzoom)||Sr.maxzoom&&this.zoom>=Sr.maxzoom||Sr.visibility!=="none"&&(T(lr,this.zoom,q),(Te[Sr.id]=Sr.createBucket({index:ye.bucketLayerIDs.length,layers:lr,zoom:this.zoom,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:ki,sourceID:this.source})).populate(tr,de,this.tileID.canonical),ye.bucketLayerIDs.push(lr.map((no=>no.id))))}}const qe=u.aF(de.glyphDependencies,(Zt=>Object.keys(Zt).map(Number)));this.inFlightDependencies.forEach((Zt=>Zt?.abort())),this.inFlightDependencies=[];let Ne=Promise.resolve({});if(Object.keys(qe).length){const Zt=new AbortController;this.inFlightDependencies.push(Zt),Ne=ee.sendAsync({type:"GG",data:{stacks:qe,source:this.source,tileID:this.tileID,type:"glyphs"}},Zt)}const nt=Object.keys(de.iconDependencies);let Rt=Promise.resolve({});if(nt.length){const Zt=new AbortController;this.inFlightDependencies.push(Zt),Rt=ee.sendAsync({type:"GI",data:{icons:nt,source:this.source,tileID:this.tileID,type:"icons"}},Zt)}const Dt=Object.keys(de.patternDependencies);let ri=Promise.resolve({});if(Dt.length){const Zt=new AbortController;this.inFlightDependencies.push(Zt),ri=ee.sendAsync({type:"GI",data:{icons:Dt,source:this.source,tileID:this.tileID,type:"patterns"}},Zt)}const[Ht,si,Jt]=yield Promise.all([Ne,Rt,ri]),Xi=new g(Ht),Bi=new u.bo(si,Jt);for(const Zt in Te){const hi=Te[Zt];hi instanceof u.a6?(T(hi.layers,this.zoom,q),u.bp({bucket:hi,glyphMap:Ht,glyphPositions:Xi.positions,imageMap:si,imagePositions:Bi.iconPositions,showCollisionBoxes:this.showCollisionBoxes,canonical:this.tileID.canonical})):hi.hasPattern&&(hi instanceof u.bq||hi instanceof u.br||hi instanceof u.bs)&&(T(hi.layers,this.zoom,q),hi.addFeatures(de,this.tileID.canonical,Bi.patternPositions))}return this.status="done",{buckets:Object.values(Te).filter((Zt=>!Zt.isEmpty())),featureIndex:ye,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:Xi.image,imageAtlas:Bi,glyphMap:this.returnDependencies?Ht:null,iconMap:this.returnDependencies?si:null,glyphPositions:this.returnDependencies?Xi.positions:null}}))}}function T(le,B,U){const q=new u.z(B);for(const ee of le)ee.recalculate(q,U)}class S{constructor(B,U,q){this.actor=B,this.layerIndex=U,this.availableImages=q,this.fetching={},this.loading={},this.loaded={}}loadVectorTile(B,U){return u._(this,void 0,void 0,(function*(){const q=yield u.l(B.request,U);try{return{vectorTile:new u.bt.VectorTile(new u.bu(q.data)),rawData:q.data,cacheControl:q.cacheControl,expires:q.expires}}catch(ee){const pe=new Uint8Array(q.data);let ye=`Unable to parse the tile at ${B.request.url}, `;throw ye+=pe[0]===31&&pe[1]===139?"please make sure the data is not gzipped and that you have configured the relevant header in the server":`got error: ${ee.message}`,new Error(ye)}}))}loadTile(B){return u._(this,void 0,void 0,(function*(){const U=B.uid,q=!!(B&&B.request&&B.request.collectResourceTiming)&&new u.bv(B.request),ee=new v(B);this.loading[U]=ee;const pe=new AbortController;ee.abort=pe;try{const ye=yield this.loadVectorTile(B,pe);if(delete this.loading[U],!ye)return null;const Te=ye.rawData,de={};ye.expires&&(de.expires=ye.expires),ye.cacheControl&&(de.cacheControl=ye.cacheControl);const ze={};if(q){const Ne=q.finish();Ne&&(ze.resourceTiming=JSON.parse(JSON.stringify(Ne)))}ee.vectorTile=ye.vectorTile;const qe=ee.parse(ye.vectorTile,this.layerIndex,this.availableImages,this.actor);this.loaded[U]=ee,this.fetching[U]={rawTileData:Te,cacheControl:de,resourceTiming:ze};try{const Ne=yield qe;return u.e({rawTileData:Te.slice(0)},Ne,de,ze)}finally{delete this.fetching[U]}}catch(ye){throw delete this.loading[U],ee.status="done",this.loaded[U]=ee,ye}}))}reloadTile(B){return u._(this,void 0,void 0,(function*(){const U=B.uid;if(!this.loaded||!this.loaded[U])throw new Error("Should not be trying to reload a tile that was never loaded or has been removed");const q=this.loaded[U];if(q.showCollisionBoxes=B.showCollisionBoxes,q.status==="parsing"){const ee=yield q.parse(q.vectorTile,this.layerIndex,this.availableImages,this.actor);let pe;if(this.fetching[U]){const{rawTileData:ye,cacheControl:Te,resourceTiming:de}=this.fetching[U];delete this.fetching[U],pe=u.e({rawTileData:ye.slice(0)},ee,Te,de)}else pe=ee;return pe}if(q.status==="done"&&q.vectorTile)return q.parse(q.vectorTile,this.layerIndex,this.availableImages,this.actor)}))}abortTile(B){return u._(this,void 0,void 0,(function*(){const U=this.loading,q=B.uid;U&&U[q]&&U[q].abort&&(U[q].abort.abort(),delete U[q])}))}removeTile(B){return u._(this,void 0,void 0,(function*(){this.loaded&&this.loaded[B.uid]&&delete this.loaded[B.uid]}))}}class P{constructor(){this.loaded={}}loadTile(B){return u._(this,void 0,void 0,(function*(){const{uid:U,encoding:q,rawImageData:ee,redFactor:pe,greenFactor:ye,blueFactor:Te,baseShift:de}=B,ze=ee.width+2,qe=ee.height+2,Ne=u.b(ee)?new u.R({width:ze,height:qe},yield u.bw(ee,-1,-1,ze,qe)):ee,nt=new u.bx(U,Ne,q,pe,ye,Te,de);return this.loaded=this.loaded||{},this.loaded[U]=nt,nt}))}removeTile(B){const U=this.loaded,q=B.uid;U&&U[q]&&delete U[q]}}function O(le,B){if(le.length!==0){$(le[0],B);for(var U=1;U<le.length;U++)$(le[U],!B)}}function $(le,B){for(var U=0,q=0,ee=0,pe=le.length,ye=pe-1;ee<pe;ye=ee++){var Te=(le[ee][0]-le[ye][0])*(le[ye][1]+le[ee][1]),de=U+Te;q+=Math.abs(U)>=Math.abs(Te)?U-de+Te:Te-de+U,U=de}U+q>=0!=!!B&&le.reverse()}var W=u.by((function le(B,U){var q,ee=B&&B.type;if(ee==="FeatureCollection")for(q=0;q<B.features.length;q++)le(B.features[q],U);else if(ee==="GeometryCollection")for(q=0;q<B.geometries.length;q++)le(B.geometries[q],U);else if(ee==="Feature")le(B.geometry,U);else if(ee==="Polygon")O(B.coordinates,U);else if(ee==="MultiPolygon")for(q=0;q<B.coordinates.length;q++)O(B.coordinates[q],U);return B}));const G=u.bt.VectorTileFeature.prototype.toGeoJSON;var Q={exports:{}},ae=u.bz,te=u.bt.VectorTileFeature,me=we;function we(le,B){this.options=B||{},this.features=le,this.length=le.length}function Oe(le,B){this.id=typeof le.id=="number"?le.id:void 0,this.type=le.type,this.rawGeometry=le.type===1?[le.geometry]:le.geometry,this.properties=le.tags,this.extent=B||4096}we.prototype.feature=function(le){return new Oe(this.features[le],this.options.extent)},Oe.prototype.loadGeometry=function(){var le=this.rawGeometry;this.geometry=[];for(var B=0;B<le.length;B++){for(var U=le[B],q=[],ee=0;ee<U.length;ee++)q.push(new ae(U[ee][0],U[ee][1]));this.geometry.push(q)}return this.geometry},Oe.prototype.bbox=function(){this.geometry||this.loadGeometry();for(var le=this.geometry,B=1/0,U=-1/0,q=1/0,ee=-1/0,pe=0;pe<le.length;pe++)for(var ye=le[pe],Te=0;Te<ye.length;Te++){var de=ye[Te];B=Math.min(B,de.x),U=Math.max(U,de.x),q=Math.min(q,de.y),ee=Math.max(ee,de.y)}return[B,q,U,ee]},Oe.prototype.toGeoJSON=te.prototype.toGeoJSON;var Je=u.bA,it=me;function He(le){var B=new Je;return(function(U,q){for(var ee in U.layers)q.writeMessage(3,ht,U.layers[ee])})(le,B),B.finish()}function ht(le,B){var U;B.writeVarintField(15,le.version||1),B.writeStringField(1,le.name||""),B.writeVarintField(5,le.extent||4096);var q={keys:[],values:[],keycache:{},valuecache:{}};for(U=0;U<le.length;U++)q.feature=le.feature(U),B.writeMessage(2,Ye,q);var ee=q.keys;for(U=0;U<ee.length;U++)B.writeStringField(3,ee[U]);var pe=q.values;for(U=0;U<pe.length;U++)B.writeMessage(4,ie,pe[U])}function Ye(le,B){var U=le.feature;U.id!==void 0&&B.writeVarintField(1,U.id),B.writeMessage(2,ft,le),B.writeVarintField(3,U.type),B.writeMessage(4,ve,U)}function ft(le,B){var U=le.feature,q=le.keys,ee=le.values,pe=le.keycache,ye=le.valuecache;for(var Te in U.properties){var de=U.properties[Te],ze=pe[Te];if(de!==null){ze===void 0&&(q.push(Te),pe[Te]=ze=q.length-1),B.writeVarint(ze);var qe=typeof de;qe!=="string"&&qe!=="boolean"&&qe!=="number"&&(de=JSON.stringify(de));var Ne=qe+":"+de,nt=ye[Ne];nt===void 0&&(ee.push(de),ye[Ne]=nt=ee.length-1),B.writeVarint(nt)}}}function Ke(le,B){return(B<<3)+(7&le)}function Ze(le){return le<<1^le>>31}function ve(le,B){for(var U=le.loadGeometry(),q=le.type,ee=0,pe=0,ye=U.length,Te=0;Te<ye;Te++){var de=U[Te],ze=1;q===1&&(ze=de.length),B.writeVarint(Ke(1,ze));for(var qe=q===3?de.length-1:de.length,Ne=0;Ne<qe;Ne++){Ne===1&&q!==1&&B.writeVarint(Ke(2,qe-1));var nt=de[Ne].x-ee,Rt=de[Ne].y-pe;B.writeVarint(Ze(nt)),B.writeVarint(Ze(Rt)),ee+=nt,pe+=Rt}q===3&&B.writeVarint(Ke(7,1))}}function ie(le,B){var U=typeof le;U==="string"?B.writeStringField(1,le):U==="boolean"?B.writeBooleanField(7,le):U==="number"&&(le%1!=0?B.writeDoubleField(3,le):le<0?B.writeSVarintField(6,le):B.writeVarintField(5,le))}Q.exports=He,Q.exports.fromVectorTileJs=He,Q.exports.fromGeojsonVt=function(le,B){B=B||{};var U={};for(var q in le)U[q]=new it(le[q].features,B),U[q].name=q,U[q].version=B.version,U[q].extent=B.extent;return He({layers:U})},Q.exports.GeoJSONWrapper=it;var ge=u.by(Q.exports);const ce={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:le=>le},ke=Math.fround||(Be=new Float32Array(1),le=>(Be[0]=+le,Be[0]));var Be;const Ve=3,We=5,tt=6;class wt{constructor(B){this.options=Object.assign(Object.create(ce),B),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(B){const{log:U,minZoom:q,maxZoom:ee}=this.options;U&&console.time("total time");const pe=`prepare ${B.length} points`;U&&console.time(pe),this.points=B;const ye=[];for(let de=0;de<B.length;de++){const ze=B[de];if(!ze.geometry)continue;const[qe,Ne]=ze.geometry.coordinates,nt=ke(kt(qe)),Rt=ke(Bt(Ne));ye.push(nt,Rt,1/0,de,-1,1),this.options.reduce&&ye.push(0)}let Te=this.trees[ee+1]=this._createTree(ye);U&&console.timeEnd(pe);for(let de=ee;de>=q;de--){const ze=+Date.now();Te=this.trees[de]=this._createTree(this._cluster(Te,de)),U&&console.log("z%d: %d clusters in %dms",de,Te.numItems,+Date.now()-ze)}return U&&console.timeEnd("total time"),this}getClusters(B,U){let q=((B[0]+180)%360+360)%360-180;const ee=Math.max(-90,Math.min(90,B[1]));let pe=B[2]===180?180:((B[2]+180)%360+360)%360-180;const ye=Math.max(-90,Math.min(90,B[3]));if(B[2]-B[0]>=360)q=-180,pe=180;else if(q>pe){const Ne=this.getClusters([q,ee,180,ye],U),nt=this.getClusters([-180,ee,pe,ye],U);return Ne.concat(nt)}const Te=this.trees[this._limitZoom(U)],de=Te.range(kt(q),Bt(ye),kt(pe),Bt(ee)),ze=Te.data,qe=[];for(const Ne of de){const nt=this.stride*Ne;qe.push(ze[nt+We]>1?_t(ze,nt,this.clusterProps):this.points[ze[nt+Ve]])}return qe}getChildren(B){const U=this._getOriginId(B),q=this._getOriginZoom(B),ee="No cluster with the specified id.",pe=this.trees[q];if(!pe)throw new Error(ee);const ye=pe.data;if(U*this.stride>=ye.length)throw new Error(ee);const Te=this.options.radius/(this.options.extent*Math.pow(2,q-1)),de=pe.within(ye[U*this.stride],ye[U*this.stride+1],Te),ze=[];for(const qe of de){const Ne=qe*this.stride;ye[Ne+4]===B&&ze.push(ye[Ne+We]>1?_t(ye,Ne,this.clusterProps):this.points[ye[Ne+Ve]])}if(ze.length===0)throw new Error(ee);return ze}getLeaves(B,U,q){const ee=[];return this._appendLeaves(ee,B,U=U||10,q=q||0,0),ee}getTile(B,U,q){const ee=this.trees[this._limitZoom(B)],pe=Math.pow(2,B),{extent:ye,radius:Te}=this.options,de=Te/ye,ze=(q-de)/pe,qe=(q+1+de)/pe,Ne={features:[]};return this._addTileFeatures(ee.range((U-de)/pe,ze,(U+1+de)/pe,qe),ee.data,U,q,pe,Ne),U===0&&this._addTileFeatures(ee.range(1-de/pe,ze,1,qe),ee.data,pe,q,pe,Ne),U===pe-1&&this._addTileFeatures(ee.range(0,ze,de/pe,qe),ee.data,-1,q,pe,Ne),Ne.features.length?Ne:null}getClusterExpansionZoom(B){let U=this._getOriginZoom(B)-1;for(;U<=this.options.maxZoom;){const q=this.getChildren(B);if(U++,q.length!==1)break;B=q[0].properties.cluster_id}return U}_appendLeaves(B,U,q,ee,pe){const ye=this.getChildren(U);for(const Te of ye){const de=Te.properties;if(de&&de.cluster?pe+de.point_count<=ee?pe+=de.point_count:pe=this._appendLeaves(B,de.cluster_id,q,ee,pe):pe<ee?pe++:B.push(Te),B.length===q)break}return pe}_createTree(B){const U=new u.av(B.length/this.stride|0,this.options.nodeSize,Float32Array);for(let q=0;q<B.length;q+=this.stride)U.add(B[q],B[q+1]);return U.finish(),U.data=B,U}_addTileFeatures(B,U,q,ee,pe,ye){for(const Te of B){const de=Te*this.stride,ze=U[de+We]>1;let qe,Ne,nt;if(ze)qe=$t(U,de,this.clusterProps),Ne=U[de],nt=U[de+1];else{const ri=this.points[U[de+Ve]];qe=ri.properties;const[Ht,si]=ri.geometry.coordinates;Ne=kt(Ht),nt=Bt(si)}const Rt={type:1,geometry:[[Math.round(this.options.extent*(Ne*pe-q)),Math.round(this.options.extent*(nt*pe-ee))]],tags:qe};let Dt;Dt=ze||this.options.generateId?U[de+Ve]:this.points[U[de+Ve]].id,Dt!==void 0&&(Rt.id=Dt),ye.features.push(Rt)}}_limitZoom(B){return Math.max(this.options.minZoom,Math.min(Math.floor(+B),this.options.maxZoom+1))}_cluster(B,U){const{radius:q,extent:ee,reduce:pe,minPoints:ye}=this.options,Te=q/(ee*Math.pow(2,U)),de=B.data,ze=[],qe=this.stride;for(let Ne=0;Ne<de.length;Ne+=qe){if(de[Ne+2]<=U)continue;de[Ne+2]=U;const nt=de[Ne],Rt=de[Ne+1],Dt=B.within(de[Ne],de[Ne+1],Te),ri=de[Ne+We];let Ht=ri;for(const si of Dt){const Jt=si*qe;de[Jt+2]>U&&(Ht+=de[Jt+We])}if(Ht>ri&&Ht>=ye){let si,Jt=nt*ri,Xi=Rt*ri,Bi=-1;const Zt=((Ne/qe|0)<<5)+(U+1)+this.points.length;for(const hi of Dt){const ki=hi*qe;if(de[ki+2]<=U)continue;de[ki+2]=U;const tr=de[ki+We];Jt+=de[ki]*tr,Xi+=de[ki+1]*tr,de[ki+4]=Zt,pe&&(si||(si=this._map(de,Ne,!0),Bi=this.clusterProps.length,this.clusterProps.push(si)),pe(si,this._map(de,ki)))}de[Ne+4]=Zt,ze.push(Jt/Ht,Xi/Ht,1/0,Zt,-1,Ht),pe&&ze.push(Bi)}else{for(let si=0;si<qe;si++)ze.push(de[Ne+si]);if(Ht>1)for(const si of Dt){const Jt=si*qe;if(!(de[Jt+2]<=U)){de[Jt+2]=U;for(let Xi=0;Xi<qe;Xi++)ze.push(de[Jt+Xi])}}}}return ze}_getOriginId(B){return B-this.points.length>>5}_getOriginZoom(B){return(B-this.points.length)%32}_map(B,U,q){if(B[U+We]>1){const ye=this.clusterProps[B[U+tt]];return q?Object.assign({},ye):ye}const ee=this.points[B[U+Ve]].properties,pe=this.options.map(ee);return q&&pe===ee?Object.assign({},pe):pe}}function _t(le,B,U){return{type:"Feature",id:le[B+Ve],properties:$t(le,B,U),geometry:{type:"Point",coordinates:[(q=le[B],360*(q-.5)),Kt(le[B+1])]}};var q}function $t(le,B,U){const q=le[B+We],ee=q>=1e4?`${Math.round(q/1e3)}k`:q>=1e3?Math.round(q/100)/10+"k":q,pe=le[B+tt],ye=pe===-1?{}:Object.assign({},U[pe]);return Object.assign(ye,{cluster:!0,cluster_id:le[B+Ve],point_count:q,point_count_abbreviated:ee})}function kt(le){return le/360+.5}function Bt(le){const B=Math.sin(le*Math.PI/180),U=.5-.25*Math.log((1+B)/(1-B))/Math.PI;return U<0?0:U>1?1:U}function Kt(le){const B=(180-360*le)*Math.PI/180;return 360*Math.atan(Math.exp(B))/Math.PI-90}function Et(le,B,U,q){let ee=q;const pe=B+(U-B>>1);let ye,Te=U-B;const de=le[B],ze=le[B+1],qe=le[U],Ne=le[U+1];for(let nt=B+3;nt<U;nt+=3){const Rt=Li(le[nt],le[nt+1],de,ze,qe,Ne);if(Rt>ee)ye=nt,ee=Rt;else if(Rt===ee){const Dt=Math.abs(nt-pe);Dt<Te&&(ye=nt,Te=Dt)}}ee>q&&(ye-B>3&&Et(le,B,ye,q),le[ye+2]=ee,U-ye>3&&Et(le,ye,U,q))}function Li(le,B,U,q,ee,pe){let ye=ee-U,Te=pe-q;if(ye!==0||Te!==0){const de=((le-U)*ye+(B-q)*Te)/(ye*ye+Te*Te);de>1?(U=ee,q=pe):de>0&&(U+=ye*de,q+=Te*de)}return ye=le-U,Te=B-q,ye*ye+Te*Te}function bi(le,B,U,q){const ee={id:le??null,type:B,geometry:U,tags:q,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};if(B==="Point"||B==="MultiPoint"||B==="LineString")Ri(ee,U);else if(B==="Polygon")Ri(ee,U[0]);else if(B==="MultiLineString")for(const pe of U)Ri(ee,pe);else if(B==="MultiPolygon")for(const pe of U)Ri(ee,pe[0]);return ee}function Ri(le,B){for(let U=0;U<B.length;U+=3)le.minX=Math.min(le.minX,B[U]),le.minY=Math.min(le.minY,B[U+1]),le.maxX=Math.max(le.maxX,B[U]),le.maxY=Math.max(le.maxY,B[U+1])}function Fi(le,B,U,q){if(!B.geometry)return;const ee=B.geometry.coordinates;if(ee&&ee.length===0)return;const pe=B.geometry.type,ye=Math.pow(U.tolerance/((1<<U.maxZoom)*U.extent),2);let Te=[],de=B.id;if(U.promoteId?de=B.properties[U.promoteId]:U.generateId&&(de=q||0),pe==="Point")Lt(ee,Te);else if(pe==="MultiPoint")for(const ze of ee)Lt(ze,Te);else if(pe==="LineString")Ce(ee,Te,ye,!1);else if(pe==="MultiLineString"){if(U.lineMetrics){for(const ze of ee)Te=[],Ce(ze,Te,ye,!1),le.push(bi(de,"LineString",Te,B.properties));return}ns(ee,Te,ye,!1)}else if(pe==="Polygon")ns(ee,Te,ye,!0);else{if(pe!=="MultiPolygon"){if(pe==="GeometryCollection"){for(const ze of B.geometry.geometries)Fi(le,{id:de,geometry:ze,properties:B.properties},U,q);return}throw new Error("Input data is not a valid GeoJSON object.")}for(const ze of ee){const qe=[];ns(ze,qe,ye,!0),Te.push(qe)}}le.push(bi(de,pe,Te,B.properties))}function Lt(le,B){B.push(os(le[0]),ii(le[1]),0)}function Ce(le,B,U,q){let ee,pe,ye=0;for(let de=0;de<le.length;de++){const ze=os(le[de][0]),qe=ii(le[de][1]);B.push(ze,qe,0),de>0&&(ye+=q?(ee*qe-ze*pe)/2:Math.sqrt(Math.pow(ze-ee,2)+Math.pow(qe-pe,2))),ee=ze,pe=qe}const Te=B.length-3;B[2]=1,Et(B,0,Te,U),B[Te+2]=1,B.size=Math.abs(ye),B.start=0,B.end=B.size}function ns(le,B,U,q){for(let ee=0;ee<le.length;ee++){const pe=[];Ce(le[ee],pe,U,q),B.push(pe)}}function os(le){return le/360+.5}function ii(le){const B=Math.sin(le*Math.PI/180),U=.5-.25*Math.log((1+B)/(1-B))/Math.PI;return U<0?0:U>1?1:U}function wi(le,B,U,q,ee,pe,ye,Te){if(q/=B,pe>=(U/=B)&&ye<q)return le;if(ye<U||pe>=q)return null;const de=[];for(const ze of le){const qe=ze.geometry;let Ne=ze.type;const nt=ee===0?ze.minX:ze.minY,Rt=ee===0?ze.maxX:ze.maxY;if(nt>=U&&Rt<q){de.push(ze);continue}if(Rt<U||nt>=q)continue;let Dt=[];if(Ne==="Point"||Ne==="MultiPoint")qi(qe,Dt,U,q,ee);else if(Ne==="LineString")Ns(qe,Dt,U,q,ee,!1,Te.lineMetrics);else if(Ne==="MultiLineString")zs(qe,Dt,U,q,ee,!1);else if(Ne==="Polygon")zs(qe,Dt,U,q,ee,!0);else if(Ne==="MultiPolygon")for(const ri of qe){const Ht=[];zs(ri,Ht,U,q,ee,!0),Ht.length&&Dt.push(Ht)}if(Dt.length){if(Te.lineMetrics&&Ne==="LineString"){for(const ri of Dt)de.push(bi(ze.id,Ne,ri,ze.tags));continue}Ne!=="LineString"&&Ne!=="MultiLineString"||(Dt.length===1?(Ne="LineString",Dt=Dt[0]):Ne="MultiLineString"),Ne!=="Point"&&Ne!=="MultiPoint"||(Ne=Dt.length===3?"Point":"MultiPoint"),de.push(bi(ze.id,Ne,Dt,ze.tags))}}return de.length?de:null}function qi(le,B,U,q,ee){for(let pe=0;pe<le.length;pe+=3){const ye=le[pe+ee];ye>=U&&ye<=q&&kr(B,le[pe],le[pe+1],le[pe+2])}}function Ns(le,B,U,q,ee,pe,ye){let Te=_s(le);const de=ee===0?Pn:Mn;let ze,qe,Ne=le.start;for(let Ht=0;Ht<le.length-3;Ht+=3){const si=le[Ht],Jt=le[Ht+1],Xi=le[Ht+2],Bi=le[Ht+3],Zt=le[Ht+4],hi=ee===0?si:Jt,ki=ee===0?Bi:Zt;let tr=!1;ye&&(ze=Math.sqrt(Math.pow(si-Bi,2)+Math.pow(Jt-Zt,2))),hi<U?ki>U&&(qe=de(Te,si,Jt,Bi,Zt,U),ye&&(Te.start=Ne+ze*qe)):hi>q?ki<q&&(qe=de(Te,si,Jt,Bi,Zt,q),ye&&(Te.start=Ne+ze*qe)):kr(Te,si,Jt,Xi),ki<U&&hi>=U&&(qe=de(Te,si,Jt,Bi,Zt,U),tr=!0),ki>q&&hi<=q&&(qe=de(Te,si,Jt,Bi,Zt,q),tr=!0),!pe&&tr&&(ye&&(Te.end=Ne+ze*qe),B.push(Te),Te=_s(le)),ye&&(Ne+=ze)}let nt=le.length-3;const Rt=le[nt],Dt=le[nt+1],ri=ee===0?Rt:Dt;ri>=U&&ri<=q&&kr(Te,Rt,Dt,le[nt+2]),nt=Te.length-3,pe&&nt>=3&&(Te[nt]!==Te[0]||Te[nt+1]!==Te[1])&&kr(Te,Te[0],Te[1],Te[2]),Te.length&&B.push(Te)}function _s(le){const B=[];return B.size=le.size,B.start=le.start,B.end=le.end,B}function zs(le,B,U,q,ee,pe){for(const ye of le)Ns(ye,B,U,q,ee,pe,!1)}function kr(le,B,U,q){le.push(B,U,q)}function Pn(le,B,U,q,ee,pe){const ye=(pe-B)/(q-B);return kr(le,pe,U+(ee-U)*ye,1),ye}function Mn(le,B,U,q,ee,pe){const ye=(pe-U)/(ee-U);return kr(le,B+(q-B)*ye,pe,1),ye}function st(le,B){const U=[];for(let q=0;q<le.length;q++){const ee=le[q],pe=ee.type;let ye;if(pe==="Point"||pe==="MultiPoint"||pe==="LineString")ye=Xr(ee.geometry,B);else if(pe==="MultiLineString"||pe==="Polygon"){ye=[];for(const Te of ee.geometry)ye.push(Xr(Te,B))}else if(pe==="MultiPolygon"){ye=[];for(const Te of ee.geometry){const de=[];for(const ze of Te)de.push(Xr(ze,B));ye.push(de)}}U.push(bi(ee.id,pe,ye,ee.tags))}return U}function Xr(le,B){const U=[];U.size=le.size,le.start!==void 0&&(U.start=le.start,U.end=le.end);for(let q=0;q<le.length;q+=3)U.push(le[q]+B,le[q+1],le[q+2]);return U}function er(le,B){if(le.transformed)return le;const U=1<<le.z,q=le.x,ee=le.y;for(const pe of le.features){const ye=pe.geometry,Te=pe.type;if(pe.geometry=[],Te===1)for(let de=0;de<ye.length;de+=2)pe.geometry.push(Dr(ye[de],ye[de+1],B,U,q,ee));else for(let de=0;de<ye.length;de++){const ze=[];for(let qe=0;qe<ye[de].length;qe+=2)ze.push(Dr(ye[de][qe],ye[de][qe+1],B,U,q,ee));pe.geometry.push(ze)}}return le.transformed=!0,le}function Dr(le,B,U,q,ee,pe){return[Math.round(U*(le*q-ee)),Math.round(U*(B*q-pe))]}function ys(le,B,U,q,ee){const pe=B===ee.maxZoom?0:ee.tolerance/((1<<B)*ee.extent),ye={features:[],numPoints:0,numSimplified:0,numFeatures:le.length,source:null,x:U,y:q,z:B,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0};for(const Te of le)ot(ye,Te,pe,ee);return ye}function ot(le,B,U,q){const ee=B.geometry,pe=B.type,ye=[];if(le.minX=Math.min(le.minX,B.minX),le.minY=Math.min(le.minY,B.minY),le.maxX=Math.max(le.maxX,B.maxX),le.maxY=Math.max(le.maxY,B.maxY),pe==="Point"||pe==="MultiPoint")for(let Te=0;Te<ee.length;Te+=3)ye.push(ee[Te],ee[Te+1]),le.numPoints++,le.numSimplified++;else if(pe==="LineString")qt(ye,ee,le,U,!1,!1);else if(pe==="MultiLineString"||pe==="Polygon")for(let Te=0;Te<ee.length;Te++)qt(ye,ee[Te],le,U,pe==="Polygon",Te===0);else if(pe==="MultiPolygon")for(let Te=0;Te<ee.length;Te++){const de=ee[Te];for(let ze=0;ze<de.length;ze++)qt(ye,de[ze],le,U,!0,ze===0)}if(ye.length){let Te=B.tags||null;if(pe==="LineString"&&q.lineMetrics){Te={};for(const ze in B.tags)Te[ze]=B.tags[ze];Te.mapbox_clip_start=ee.start/ee.size,Te.mapbox_clip_end=ee.end/ee.size}const de={geometry:ye,type:pe==="Polygon"||pe==="MultiPolygon"?3:pe==="LineString"||pe==="MultiLineString"?2:1,tags:Te};B.id!==null&&(de.id=B.id),le.features.push(de)}}function qt(le,B,U,q,ee,pe){const ye=q*q;if(q>0&&B.size<(ee?ye:q))return void(U.numPoints+=B.length/3);const Te=[];for(let de=0;de<B.length;de+=3)(q===0||B[de+2]>ye)&&(U.numSimplified++,Te.push(B[de],B[de+1])),U.numPoints++;ee&&(function(de,ze){let qe=0;for(let Ne=0,nt=de.length,Rt=nt-2;Ne<nt;Rt=Ne,Ne+=2)qe+=(de[Ne]-de[Rt])*(de[Ne+1]+de[Rt+1]);if(qe>0===ze)for(let Ne=0,nt=de.length;Ne<nt/2;Ne+=2){const Rt=de[Ne],Dt=de[Ne+1];de[Ne]=de[nt-2-Ne],de[Ne+1]=de[nt-1-Ne],de[nt-2-Ne]=Rt,de[nt-1-Ne]=Dt}})(Te,pe),le.push(Te)}const Nt={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0};class Ji{constructor(B,U){const q=(U=this.options=(function(pe,ye){for(const Te in ye)pe[Te]=ye[Te];return pe})(Object.create(Nt),U)).debug;if(q&&console.time("preprocess data"),U.maxZoom<0||U.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(U.promoteId&&U.generateId)throw new Error("promoteId and generateId cannot be used together.");let ee=(function(pe,ye){const Te=[];if(pe.type==="FeatureCollection")for(let de=0;de<pe.features.length;de++)Fi(Te,pe.features[de],ye,de);else Fi(Te,pe.type==="Feature"?pe:{geometry:pe},ye);return Te})(B,U);this.tiles={},this.tileCoords=[],q&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",U.indexMaxZoom,U.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),ee=(function(pe,ye){const Te=ye.buffer/ye.extent;let de=pe;const ze=wi(pe,1,-1-Te,Te,0,-1,2,ye),qe=wi(pe,1,1-Te,2+Te,0,-1,2,ye);return(ze||qe)&&(de=wi(pe,1,-Te,1+Te,0,-1,2,ye)||[],ze&&(de=st(ze,1).concat(de)),qe&&(de=de.concat(st(qe,-1)))),de})(ee,U),ee.length&&this.splitTile(ee,0,0,0),q&&(ee.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}splitTile(B,U,q,ee,pe,ye,Te){const de=[B,U,q,ee],ze=this.options,qe=ze.debug;for(;de.length;){ee=de.pop(),q=de.pop(),U=de.pop(),B=de.pop();const Ne=1<<U,nt=Zr(U,q,ee);let Rt=this.tiles[nt];if(!Rt&&(qe>1&&console.time("creation"),Rt=this.tiles[nt]=ys(B,U,q,ee,ze),this.tileCoords.push({z:U,x:q,y:ee}),qe)){qe>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",U,q,ee,Rt.numFeatures,Rt.numPoints,Rt.numSimplified),console.timeEnd("creation"));const tr=`z${U}`;this.stats[tr]=(this.stats[tr]||0)+1,this.total++}if(Rt.source=B,pe==null){if(U===ze.indexMaxZoom||Rt.numPoints<=ze.indexMaxPoints)continue}else{if(U===ze.maxZoom||U===pe)continue;if(pe!=null){const tr=pe-U;if(q!==ye>>tr||ee!==Te>>tr)continue}}if(Rt.source=null,B.length===0)continue;qe>1&&console.time("clipping");const Dt=.5*ze.buffer/ze.extent,ri=.5-Dt,Ht=.5+Dt,si=1+Dt;let Jt=null,Xi=null,Bi=null,Zt=null,hi=wi(B,Ne,q-Dt,q+Ht,0,Rt.minX,Rt.maxX,ze),ki=wi(B,Ne,q+ri,q+si,0,Rt.minX,Rt.maxX,ze);B=null,hi&&(Jt=wi(hi,Ne,ee-Dt,ee+Ht,1,Rt.minY,Rt.maxY,ze),Xi=wi(hi,Ne,ee+ri,ee+si,1,Rt.minY,Rt.maxY,ze),hi=null),ki&&(Bi=wi(ki,Ne,ee-Dt,ee+Ht,1,Rt.minY,Rt.maxY,ze),Zt=wi(ki,Ne,ee+ri,ee+si,1,Rt.minY,Rt.maxY,ze),ki=null),qe>1&&console.timeEnd("clipping"),de.push(Jt||[],U+1,2*q,2*ee),de.push(Xi||[],U+1,2*q,2*ee+1),de.push(Bi||[],U+1,2*q+1,2*ee),de.push(Zt||[],U+1,2*q+1,2*ee+1)}}getTile(B,U,q){B=+B,U=+U,q=+q;const ee=this.options,{extent:pe,debug:ye}=ee;if(B<0||B>24)return null;const Te=1<<B,de=Zr(B,U=U+Te&Te-1,q);if(this.tiles[de])return er(this.tiles[de],pe);ye>1&&console.log("drilling down to z%d-%d-%d",B,U,q);let ze,qe=B,Ne=U,nt=q;for(;!ze&&qe>0;)qe--,Ne>>=1,nt>>=1,ze=this.tiles[Zr(qe,Ne,nt)];return ze&&ze.source?(ye>1&&(console.log("found parent tile z%d-%d-%d",qe,Ne,nt),console.time("drilling down")),this.splitTile(ze.source,qe,Ne,nt,B,U,q),ye>1&&console.timeEnd("drilling down"),this.tiles[de]?er(this.tiles[de],pe):null):null}}function Zr(le,B,U){return 32*((1<<le)*U+B)+le}function zt(le,B){return B?le.properties[B]:le.id}function Yr(le,B){if(le==null)return!0;if(le.type==="Feature")return zt(le,B)!=null;if(le.type==="FeatureCollection"){const U=new Set;for(const q of le.features){const ee=zt(q,B);if(ee==null||U.has(ee))return!1;U.add(ee)}return!0}return!1}function xs(le,B){const U=new Map;if(le!=null)if(le.type==="Feature")U.set(zt(le,B),le);else for(const q of le.features)U.set(zt(q,B),q);return U}class Us extends S{constructor(){super(...arguments),this._dataUpdateable=new Map}loadVectorTile(B,U){return u._(this,void 0,void 0,(function*(){const q=B.tileID.canonical;if(!this._geoJSONIndex)throw new Error("Unable to parse the data into a cluster or geojson");const ee=this._geoJSONIndex.getTile(q.z,q.x,q.y);if(!ee)return null;const pe=new class{constructor(Te){this.layers={_geojsonTileLayer:this},this.name="_geojsonTileLayer",this.extent=u.X,this.length=Te.length,this._features=Te}feature(Te){return new class{constructor(de){this._feature=de,this.extent=u.X,this.type=de.type,this.properties=de.tags,"id"in de&&!isNaN(de.id)&&(this.id=parseInt(de.id,10))}loadGeometry(){if(this._feature.type===1){const de=[];for(const ze of this._feature.geometry)de.push([new u.P(ze[0],ze[1])]);return de}{const de=[];for(const ze of this._feature.geometry){const qe=[];for(const Ne of ze)qe.push(new u.P(Ne[0],Ne[1]));de.push(qe)}return de}}toGeoJSON(de,ze,qe){return G.call(this,de,ze,qe)}}(this._features[Te])}}(ee.features);let ye=ge(pe);return ye.byteOffset===0&&ye.byteLength===ye.buffer.byteLength||(ye=new Uint8Array(ye)),{vectorTile:pe,rawData:ye.buffer}}))}loadData(B){return u._(this,void 0,void 0,(function*(){var U;(U=this._pendingRequest)===null||U===void 0||U.abort();const q=!!(B&&B.request&&B.request.collectResourceTiming)&&new u.bv(B.request);this._pendingRequest=new AbortController;try{this._pendingData=this.loadAndProcessGeoJSON(B,this._pendingRequest),this._geoJSONIndex=B.cluster?new wt((function({superclusterOptions:ye,clusterProperties:Te}){if(!Te||!ye)return ye;const de={},ze={},qe={accumulated:null,zoom:0},Ne={properties:null},nt=Object.keys(Te);for(const Rt of nt){const[Dt,ri]=Te[Rt],Ht=u.bC(ri),si=u.bC(typeof Dt=="string"?[Dt,["accumulated"],["get",Rt]]:Dt);de[Rt]=Ht.value,ze[Rt]=si.value}return ye.map=Rt=>{Ne.properties=Rt;const Dt={};for(const ri of nt)Dt[ri]=de[ri].evaluate(qe,Ne);return Dt},ye.reduce=(Rt,Dt)=>{Ne.properties=Dt;for(const ri of nt)qe.accumulated=Rt[ri],Rt[ri]=ze[ri].evaluate(qe,Ne)},ye})(B)).load((yield this._pendingData).features):(ee=yield this._pendingData,new Ji(ee,B.geojsonVtOptions)),this.loaded={};const pe={};if(q){const ye=q.finish();ye&&(pe.resourceTiming={},pe.resourceTiming[B.source]=JSON.parse(JSON.stringify(ye)))}return pe}catch(pe){if(delete this._pendingRequest,u.bB(pe))return{abandoned:!0};throw pe}var ee}))}getData(){return u._(this,void 0,void 0,(function*(){return this._pendingData}))}reloadTile(B){const U=this.loaded;return U&&U[B.uid]?super.reloadTile(B):this.loadTile(B)}loadAndProcessGeoJSON(B,U){return u._(this,void 0,void 0,(function*(){let q=yield this.loadGeoJSON(B,U);if(delete this._pendingRequest,typeof q!="object")throw new Error(`Input data given to '${B.source}' is not a valid GeoJSON object.`);if(W(q,!0),B.filter){const ee=u.bC(B.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if(ee.result==="error")throw new Error(ee.value.map((ye=>`${ye.key}: ${ye.message}`)).join(", "));q={type:"FeatureCollection",features:q.features.filter((ye=>ee.value.evaluate({zoom:0},ye)))}}return q}))}loadGeoJSON(B,U){return u._(this,void 0,void 0,(function*(){const{promoteId:q}=B;if(B.request){const ee=yield u.h(B.request,U);return this._dataUpdateable=Yr(ee.data,q)?xs(ee.data,q):void 0,ee.data}if(typeof B.data=="string")try{const ee=JSON.parse(B.data);return this._dataUpdateable=Yr(ee,q)?xs(ee,q):void 0,ee}catch{throw new Error(`Input data given to '${B.source}' is not a valid GeoJSON object.`)}if(!B.dataDiff)throw new Error(`Input data given to '${B.source}' is not a valid GeoJSON object.`);if(!this._dataUpdateable)throw new Error(`Cannot update existing geojson data in ${B.source}`);return(function(ee,pe,ye){var Te,de,ze,qe;if(pe.removeAll&&ee.clear(),pe.remove)for(const Ne of pe.remove)ee.delete(Ne);if(pe.add)for(const Ne of pe.add){const nt=zt(Ne,ye);nt!=null&&ee.set(nt,Ne)}if(pe.update)for(const Ne of pe.update){let nt=ee.get(Ne.id);if(nt==null)continue;const Rt=!Ne.removeAllProperties&&(((Te=Ne.removeProperties)===null||Te===void 0?void 0:Te.length)>0||((de=Ne.addOrUpdateProperties)===null||de===void 0?void 0:de.length)>0);if((Ne.newGeometry||Ne.removeAllProperties||Rt)&&(nt=Object.assign({},nt),ee.set(Ne.id,nt),Rt&&(nt.properties=Object.assign({},nt.properties))),Ne.newGeometry&&(nt.geometry=Ne.newGeometry),Ne.removeAllProperties)nt.properties={};else if(((ze=Ne.removeProperties)===null||ze===void 0?void 0:ze.length)>0)for(const Dt of Ne.removeProperties)Object.prototype.hasOwnProperty.call(nt.properties,Dt)&&delete nt.properties[Dt];if(((qe=Ne.addOrUpdateProperties)===null||qe===void 0?void 0:qe.length)>0)for(const{key:Dt,value:ri}of Ne.addOrUpdateProperties)nt.properties[Dt]=ri}})(this._dataUpdateable,B.dataDiff,q),{type:"FeatureCollection",features:Array.from(this._dataUpdateable.values())}}))}removeSource(B){return u._(this,void 0,void 0,(function*(){this._pendingRequest&&this._pendingRequest.abort()}))}getClusterExpansionZoom(B){return this._geoJSONIndex.getClusterExpansionZoom(B.clusterId)}getClusterChildren(B){return this._geoJSONIndex.getChildren(B.clusterId)}getClusterLeaves(B){return this._geoJSONIndex.getLeaves(B.clusterId,B.limit,B.offset)}}class as{constructor(B){this.self=B,this.actor=new u.F(B),this.layerIndexes={},this.availableImages={},this.workerSources={},this.demWorkerSources={},this.externalWorkerSourceTypes={},this.self.registerWorkerSource=(U,q)=>{if(this.externalWorkerSourceTypes[U])throw new Error(`Worker source with name "${U}" already registered.`);this.externalWorkerSourceTypes[U]=q},this.self.addProtocol=u.bi,this.self.removeProtocol=u.bj,this.self.registerRTLTextPlugin=U=>{if(u.bD.isParsed())throw new Error("RTL text plugin already registered.");u.bD.setMethods(U)},this.actor.registerMessageHandler("LDT",((U,q)=>this._getDEMWorkerSource(U,q.source).loadTile(q))),this.actor.registerMessageHandler("RDT",((U,q)=>u._(this,void 0,void 0,(function*(){this._getDEMWorkerSource(U,q.source).removeTile(q)})))),this.actor.registerMessageHandler("GCEZ",((U,q)=>u._(this,void 0,void 0,(function*(){return this._getWorkerSource(U,q.type,q.source).getClusterExpansionZoom(q)})))),this.actor.registerMessageHandler("GCC",((U,q)=>u._(this,void 0,void 0,(function*(){return this._getWorkerSource(U,q.type,q.source).getClusterChildren(q)})))),this.actor.registerMessageHandler("GCL",((U,q)=>u._(this,void 0,void 0,(function*(){return this._getWorkerSource(U,q.type,q.source).getClusterLeaves(q)})))),this.actor.registerMessageHandler("LD",((U,q)=>this._getWorkerSource(U,q.type,q.source).loadData(q))),this.actor.registerMessageHandler("GD",((U,q)=>this._getWorkerSource(U,q.type,q.source).getData())),this.actor.registerMessageHandler("LT",((U,q)=>this._getWorkerSource(U,q.type,q.source).loadTile(q))),this.actor.registerMessageHandler("RT",((U,q)=>this._getWorkerSource(U,q.type,q.source).reloadTile(q))),this.actor.registerMessageHandler("AT",((U,q)=>this._getWorkerSource(U,q.type,q.source).abortTile(q))),this.actor.registerMessageHandler("RMT",((U,q)=>this._getWorkerSource(U,q.type,q.source).removeTile(q))),this.actor.registerMessageHandler("RS",((U,q)=>u._(this,void 0,void 0,(function*(){if(!this.workerSources[U]||!this.workerSources[U][q.type]||!this.workerSources[U][q.type][q.source])return;const ee=this.workerSources[U][q.type][q.source];delete this.workerSources[U][q.type][q.source],ee.removeSource!==void 0&&ee.removeSource(q)})))),this.actor.registerMessageHandler("RM",(U=>u._(this,void 0,void 0,(function*(){delete this.layerIndexes[U],delete this.availableImages[U],delete this.workerSources[U],delete this.demWorkerSources[U]})))),this.actor.registerMessageHandler("SR",((U,q)=>u._(this,void 0,void 0,(function*(){this.referrer=q})))),this.actor.registerMessageHandler("SRPS",((U,q)=>this._syncRTLPluginState(U,q))),this.actor.registerMessageHandler("IS",((U,q)=>u._(this,void 0,void 0,(function*(){this.self.importScripts(q)})))),this.actor.registerMessageHandler("SI",((U,q)=>this._setImages(U,q))),this.actor.registerMessageHandler("UL",((U,q)=>u._(this,void 0,void 0,(function*(){this._getLayerIndex(U).update(q.layers,q.removedIds)})))),this.actor.registerMessageHandler("SL",((U,q)=>u._(this,void 0,void 0,(function*(){this._getLayerIndex(U).replace(q)}))))}_setImages(B,U){return u._(this,void 0,void 0,(function*(){this.availableImages[B]=U;for(const q in this.workerSources[B]){const ee=this.workerSources[B][q];for(const pe in ee)ee[pe].availableImages=U}}))}_syncRTLPluginState(B,U){return u._(this,void 0,void 0,(function*(){if(u.bD.isParsed())return u.bD.getState();if(U.pluginStatus!=="loading")return u.bD.setState(U),U;const q=U.pluginURL;if(this.self.importScripts(q),u.bD.isParsed()){const ee={pluginStatus:"loaded",pluginURL:q};return u.bD.setState(ee),ee}throw u.bD.setState({pluginStatus:"error",pluginURL:""}),new Error(`RTL Text Plugin failed to import scripts from ${q}`)}))}_getAvailableImages(B){let U=this.availableImages[B];return U||(U=[]),U}_getLayerIndex(B){let U=this.layerIndexes[B];return U||(U=this.layerIndexes[B]=new l),U}_getWorkerSource(B,U,q){if(this.workerSources[B]||(this.workerSources[B]={}),this.workerSources[B][U]||(this.workerSources[B][U]={}),!this.workerSources[B][U][q]){const ee={sendAsync:(pe,ye)=>(pe.targetMapId=B,this.actor.sendAsync(pe,ye))};switch(U){case"vector":this.workerSources[B][U][q]=new S(ee,this._getLayerIndex(B),this._getAvailableImages(B));break;case"geojson":this.workerSources[B][U][q]=new Us(ee,this._getLayerIndex(B),this._getAvailableImages(B));break;default:this.workerSources[B][U][q]=new this.externalWorkerSourceTypes[U](ee,this._getLayerIndex(B),this._getAvailableImages(B))}}return this.workerSources[B][U][q]}_getDEMWorkerSource(B,U){return this.demWorkerSources[B]||(this.demWorkerSources[B]={}),this.demWorkerSources[B][U]||(this.demWorkerSources[B][U]=new P),this.demWorkerSources[B][U]}}return u.i(self)&&(self.worker=new as(self)),as})),s("index",["exports","./shared"],(function(u,l){var g="4.7.1";let v,T;const S={now:typeof performance<"u"&&performance&&performance.now?performance.now.bind(performance):Date.now.bind(Date),frameAsync:x=>new Promise(((n,d)=>{const p=requestAnimationFrame(n);x.signal.addEventListener("abort",(()=>{cancelAnimationFrame(p),d(l.c())}))})),getImageData(x,n=0){return this.getImageCanvasContext(x).getImageData(-n,-n,x.width+2*n,x.height+2*n)},getImageCanvasContext(x){const n=window.document.createElement("canvas"),d=n.getContext("2d",{willReadFrequently:!0});if(!d)throw new Error("failed to create canvas 2d context");return n.width=x.width,n.height=x.height,d.drawImage(x,0,0,x.width,x.height),d},resolveURL:x=>(v||(v=document.createElement("a")),v.href=x,v.href),hardwareConcurrency:typeof navigator<"u"&&navigator.hardwareConcurrency||4,get prefersReducedMotion(){return!!matchMedia&&(T==null&&(T=matchMedia("(prefers-reduced-motion: reduce)")),T.matches)}};class P{static testProp(n){if(!P.docStyle)return n[0];for(let d=0;d<n.length;d++)if(n[d]in P.docStyle)return n[d];return n[0]}static create(n,d,p){const m=window.document.createElement(n);return d!==void 0&&(m.className=d),p&&p.appendChild(m),m}static createNS(n,d){return window.document.createElementNS(n,d)}static disableDrag(){P.docStyle&&P.selectProp&&(P.userSelect=P.docStyle[P.selectProp],P.docStyle[P.selectProp]="none")}static enableDrag(){P.docStyle&&P.selectProp&&(P.docStyle[P.selectProp]=P.userSelect)}static setTransform(n,d){n.style[P.transformProp]=d}static addEventListener(n,d,p,m={}){n.addEventListener(d,p,"passive"in m?m:m.capture)}static removeEventListener(n,d,p,m={}){n.removeEventListener(d,p,"passive"in m?m:m.capture)}static suppressClickInternal(n){n.preventDefault(),n.stopPropagation(),window.removeEventListener("click",P.suppressClickInternal,!0)}static suppressClick(){window.addEventListener("click",P.suppressClickInternal,!0),window.setTimeout((()=>{window.removeEventListener("click",P.suppressClickInternal,!0)}),0)}static getScale(n){const d=n.getBoundingClientRect();return{x:d.width/n.offsetWidth||1,y:d.height/n.offsetHeight||1,boundingClientRect:d}}static getPoint(n,d,p){const m=d.boundingClientRect;return new l.P((p.clientX-m.left)/d.x-n.clientLeft,(p.clientY-m.top)/d.y-n.clientTop)}static mousePos(n,d){const p=P.getScale(n);return P.getPoint(n,p,d)}static touchPos(n,d){const p=[],m=P.getScale(n);for(let y=0;y<d.length;y++)p.push(P.getPoint(n,m,d[y]));return p}static mouseButton(n){return n.button}static remove(n){n.parentNode&&n.parentNode.removeChild(n)}}P.docStyle=typeof window<"u"&&window.document&&window.document.documentElement.style,P.selectProp=P.testProp(["userSelect","MozUserSelect","WebkitUserSelect","msUserSelect"]),P.transformProp=P.testProp(["transform","WebkitTransform"]);const O={supported:!1,testSupport:function(x){!G&&W&&(Q?ae(x):$=x)}};let $,W,G=!1,Q=!1;function ae(x){const n=x.createTexture();x.bindTexture(x.TEXTURE_2D,n);try{if(x.texImage2D(x.TEXTURE_2D,0,x.RGBA,x.RGBA,x.UNSIGNED_BYTE,W),x.isContextLost())return;O.supported=!0}catch{}x.deleteTexture(n),G=!0}var te;typeof document<"u"&&(W=document.createElement("img"),W.onload=()=>{$&&ae($),$=null,Q=!0},W.onerror=()=>{G=!0,$=null},W.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA="),(function(x){let n,d,p,m;x.resetRequestQueue=()=>{n=[],d=0,p=0,m={}},x.addThrottleControl=M=>{const D=p++;return m[D]=M,D},x.removeThrottleControl=M=>{delete m[M],E()},x.getImage=(M,D,N=!0)=>new Promise(((z,H)=>{O.supported&&(M.headers||(M.headers={}),M.headers.accept="image/webp,*/*"),l.e(M,{type:"image"}),n.push({abortController:D,requestParameters:M,supportImageRefresh:N,state:"queued",onError:Y=>{H(Y)},onSuccess:Y=>{z(Y)}}),E()}));const y=M=>l._(this,void 0,void 0,(function*(){M.state="running";const{requestParameters:D,supportImageRefresh:N,onError:z,onSuccess:H,abortController:Y}=M,K=N===!1&&!l.i(self)&&!l.g(D.url)&&(!D.headers||Object.keys(D.headers).reduce(((fe,_e)=>fe&&_e==="accept"),!0));d++;const oe=K?C(D,Y):l.m(D,Y);try{const fe=yield oe;delete M.abortController,M.state="completed",fe.data instanceof HTMLImageElement||l.b(fe.data)?H(fe):fe.data&&H({data:yield(he=fe.data,typeof createImageBitmap=="function"?l.d(he):l.f(he)),cacheControl:fe.cacheControl,expires:fe.expires})}catch(fe){delete M.abortController,z(fe)}finally{d--,E()}var he})),E=()=>{const M=(()=>{for(const D of Object.keys(m))if(m[D]())return!0;return!1})()?l.a.MAX_PARALLEL_IMAGE_REQUESTS_PER_FRAME:l.a.MAX_PARALLEL_IMAGE_REQUESTS;for(let D=d;D<M&&n.length>0;D++){const N=n.shift();N.abortController.signal.aborted?D--:y(N)}},C=(M,D)=>new Promise(((N,z)=>{const H=new Image,Y=M.url,K=M.credentials;K&&K==="include"?H.crossOrigin="use-credentials":(K&&K==="same-origin"||!l.s(Y))&&(H.crossOrigin="anonymous"),D.signal.addEventListener("abort",(()=>{H.src="",z(l.c())})),H.fetchPriority="high",H.onload=()=>{H.onerror=H.onload=null,N({data:H})},H.onerror=()=>{H.onerror=H.onload=null,D.signal.aborted||z(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."))},H.src=Y}))})(te||(te={})),te.resetRequestQueue();class me{constructor(n){this._transformRequestFn=n}transformRequest(n,d){return this._transformRequestFn&&this._transformRequestFn(n,d)||{url:n}}setTransformRequest(n){this._transformRequestFn=n}}function we(x){var n=new l.A(3);return n[0]=x[0],n[1]=x[1],n[2]=x[2],n}var Oe,Je=function(x,n,d){return x[0]=n[0]-d[0],x[1]=n[1]-d[1],x[2]=n[2]-d[2],x};Oe=new l.A(3),l.A!=Float32Array&&(Oe[0]=0,Oe[1]=0,Oe[2]=0);var it=function(x){var n=x[0],d=x[1];return n*n+d*d};function He(x){const n=[];if(typeof x=="string")n.push({id:"default",url:x});else if(x&&x.length>0){const d=[];for(const{id:p,url:m}of x){const y=`${p}${m}`;d.indexOf(y)===-1&&(d.push(y),n.push({id:p,url:m}))}}return n}function ht(x,n,d){const p=x.split("?");return p[0]+=`${n}${d}`,p.join("?")}(function(){var x=new l.A(2);l.A!=Float32Array&&(x[0]=0,x[1]=0)})();class Ye{constructor(n,d,p,m){this.context=n,this.format=p,this.texture=n.gl.createTexture(),this.update(d,m)}update(n,d,p){const{width:m,height:y}=n,E=!(this.size&&this.size[0]===m&&this.size[1]===y||p),{context:C}=this,{gl:M}=C;if(this.useMipmap=!!(d&&d.useMipmap),M.bindTexture(M.TEXTURE_2D,this.texture),C.pixelStoreUnpackFlipY.set(!1),C.pixelStoreUnpack.set(1),C.pixelStoreUnpackPremultiplyAlpha.set(this.format===M.RGBA&&(!d||d.premultiply!==!1)),E)this.size=[m,y],n instanceof HTMLImageElement||n instanceof HTMLCanvasElement||n instanceof HTMLVideoElement||n instanceof ImageData||l.b(n)?M.texImage2D(M.TEXTURE_2D,0,this.format,this.format,M.UNSIGNED_BYTE,n):M.texImage2D(M.TEXTURE_2D,0,this.format,m,y,0,this.format,M.UNSIGNED_BYTE,n.data);else{const{x:D,y:N}=p||{x:0,y:0};n instanceof HTMLImageElement||n instanceof HTMLCanvasElement||n instanceof HTMLVideoElement||n instanceof ImageData||l.b(n)?M.texSubImage2D(M.TEXTURE_2D,0,D,N,M.RGBA,M.UNSIGNED_BYTE,n):M.texSubImage2D(M.TEXTURE_2D,0,D,N,m,y,M.RGBA,M.UNSIGNED_BYTE,n.data)}this.useMipmap&&this.isSizePowerOfTwo()&&M.generateMipmap(M.TEXTURE_2D)}bind(n,d,p){const{context:m}=this,{gl:y}=m;y.bindTexture(y.TEXTURE_2D,this.texture),p!==y.LINEAR_MIPMAP_NEAREST||this.isSizePowerOfTwo()||(p=y.LINEAR),n!==this.filter&&(y.texParameteri(y.TEXTURE_2D,y.TEXTURE_MAG_FILTER,n),y.texParameteri(y.TEXTURE_2D,y.TEXTURE_MIN_FILTER,p||n),this.filter=n),d!==this.wrap&&(y.texParameteri(y.TEXTURE_2D,y.TEXTURE_WRAP_S,d),y.texParameteri(y.TEXTURE_2D,y.TEXTURE_WRAP_T,d),this.wrap=d)}isSizePowerOfTwo(){return this.size[0]===this.size[1]&&Math.log(this.size[0])/Math.LN2%1==0}destroy(){const{gl:n}=this.context;n.deleteTexture(this.texture),this.texture=null}}function ft(x){const{userImage:n}=x;return!!(n&&n.render&&n.render())&&(x.data.replace(new Uint8Array(n.data.buffer)),!0)}class Ke extends l.E{constructor(){super(),this.images={},this.updatedImages={},this.callbackDispatchedThisFrame={},this.loaded=!1,this.requestors=[],this.patterns={},this.atlasImage=new l.R({width:1,height:1}),this.dirty=!0}isLoaded(){return this.loaded}setLoaded(n){if(this.loaded!==n&&(this.loaded=n,n)){for(const{ids:d,promiseResolve:p}of this.requestors)p(this._getImagesForIds(d));this.requestors=[]}}getImage(n){const d=this.images[n];if(d&&!d.data&&d.spriteData){const p=d.spriteData;d.data=new l.R({width:p.width,height:p.height},p.context.getImageData(p.x,p.y,p.width,p.height).data),d.spriteData=null}return d}addImage(n,d){if(this.images[n])throw new Error(`Image id ${n} already exist, use updateImage instead`);this._validate(n,d)&&(this.images[n]=d)}_validate(n,d){let p=!0;const m=d.data||d.spriteData;return this._validateStretch(d.stretchX,m&&m.width)||(this.fire(new l.j(new Error(`Image "${n}" has invalid "stretchX" value`))),p=!1),this._validateStretch(d.stretchY,m&&m.height)||(this.fire(new l.j(new Error(`Image "${n}" has invalid "stretchY" value`))),p=!1),this._validateContent(d.content,d)||(this.fire(new l.j(new Error(`Image "${n}" has invalid "content" value`))),p=!1),p}_validateStretch(n,d){if(!n)return!0;let p=0;for(const m of n){if(m[0]<p||m[1]<m[0]||d<m[1])return!1;p=m[1]}return!0}_validateContent(n,d){if(!n)return!0;if(n.length!==4)return!1;const p=d.spriteData,m=p&&p.width||d.data.width,y=p&&p.height||d.data.height;return!(n[0]<0||m<n[0]||n[1]<0||y<n[1]||n[2]<0||m<n[2]||n[3]<0||y<n[3]||n[2]<n[0]||n[3]<n[1])}updateImage(n,d,p=!0){const m=this.getImage(n);if(p&&(m.data.width!==d.data.width||m.data.height!==d.data.height))throw new Error(`size mismatch between old image (${m.data.width}x${m.data.height}) and new image (${d.data.width}x${d.data.height}).`);d.version=m.version+1,this.images[n]=d,this.updatedImages[n]=!0}removeImage(n){const d=this.images[n];delete this.images[n],delete this.patterns[n],d.userImage&&d.userImage.onRemove&&d.userImage.onRemove()}listImages(){return Object.keys(this.images)}getImages(n){return new Promise(((d,p)=>{let m=!0;if(!this.isLoaded())for(const y of n)this.images[y]||(m=!1);this.isLoaded()||m?d(this._getImagesForIds(n)):this.requestors.push({ids:n,promiseResolve:d})}))}_getImagesForIds(n){const d={};for(const p of n){let m=this.getImage(p);m||(this.fire(new l.k("styleimagemissing",{id:p})),m=this.getImage(p)),m?d[p]={data:m.data.clone(),pixelRatio:m.pixelRatio,sdf:m.sdf,version:m.version,stretchX:m.stretchX,stretchY:m.stretchY,content:m.content,textFitWidth:m.textFitWidth,textFitHeight:m.textFitHeight,hasRenderCallback:!!(m.userImage&&m.userImage.render)}:l.w(`Image "${p}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`)}return d}getPixelSize(){const{width:n,height:d}=this.atlasImage;return{width:n,height:d}}getPattern(n){const d=this.patterns[n],p=this.getImage(n);if(!p)return null;if(d&&d.position.version===p.version)return d.position;if(d)d.position.version=p.version;else{const m={w:p.data.width+2,h:p.data.height+2,x:0,y:0},y=new l.I(m,p);this.patterns[n]={bin:m,position:y}}return this._updatePatternAtlas(),this.patterns[n].position}bind(n){const d=n.gl;this.atlasTexture?this.dirty&&(this.atlasTexture.update(this.atlasImage),this.dirty=!1):this.atlasTexture=new Ye(n,this.atlasImage,d.RGBA),this.atlasTexture.bind(d.LINEAR,d.CLAMP_TO_EDGE)}_updatePatternAtlas(){const n=[];for(const y in this.patterns)n.push(this.patterns[y].bin);const{w:d,h:p}=l.p(n),m=this.atlasImage;m.resize({width:d||1,height:p||1});for(const y in this.patterns){const{bin:E}=this.patterns[y],C=E.x+1,M=E.y+1,D=this.getImage(y).data,N=D.width,z=D.height;l.R.copy(D,m,{x:0,y:0},{x:C,y:M},{width:N,height:z}),l.R.copy(D,m,{x:0,y:z-1},{x:C,y:M-1},{width:N,height:1}),l.R.copy(D,m,{x:0,y:0},{x:C,y:M+z},{width:N,height:1}),l.R.copy(D,m,{x:N-1,y:0},{x:C-1,y:M},{width:1,height:z}),l.R.copy(D,m,{x:0,y:0},{x:C+N,y:M},{width:1,height:z})}this.dirty=!0}beginFrame(){this.callbackDispatchedThisFrame={}}dispatchRenderCallbacks(n){for(const d of n){if(this.callbackDispatchedThisFrame[d])continue;this.callbackDispatchedThisFrame[d]=!0;const p=this.getImage(d);p||l.w(`Image with ID: "${d}" was not found`),ft(p)&&this.updateImage(d,p)}}}const Ze=1e20;function ve(x,n,d,p,m,y,E,C,M){for(let D=n;D<n+p;D++)ie(x,d*y+D,y,m,E,C,M);for(let D=d;D<d+m;D++)ie(x,D*y+n,1,p,E,C,M)}function ie(x,n,d,p,m,y,E){y[0]=0,E[0]=-Ze,E[1]=Ze,m[0]=x[n];for(let C=1,M=0,D=0;C<p;C++){m[C]=x[n+C*d];const N=C*C;do{const z=y[M];D=(m[C]-m[z]+N-z*z)/(C-z)/2}while(D<=E[M]&&--M>-1);M++,y[M]=C,E[M]=D,E[M+1]=Ze}for(let C=0,M=0;C<p;C++){for(;E[M+1]<C;)M++;const D=y[M],N=C-D;x[n+C*d]=m[D]+N*N}}class ge{constructor(n,d){this.requestManager=n,this.localIdeographFontFamily=d,this.entries={}}setURL(n){this.url=n}getGlyphs(n){return l._(this,void 0,void 0,(function*(){const d=[];for(const y in n)for(const E of n[y])d.push(this._getAndCacheGlyphsPromise(y,E));const p=yield Promise.all(d),m={};for(const{stack:y,id:E,glyph:C}of p)m[y]||(m[y]={}),m[y][E]=C&&{id:C.id,bitmap:C.bitmap.clone(),metrics:C.metrics};return m}))}_getAndCacheGlyphsPromise(n,d){return l._(this,void 0,void 0,(function*(){let p=this.entries[n];p||(p=this.entries[n]={glyphs:{},requests:{},ranges:{}});let m=p.glyphs[d];if(m!==void 0)return{stack:n,id:d,glyph:m};if(m=this._tinySDF(p,n,d),m)return p.glyphs[d]=m,{stack:n,id:d,glyph:m};const y=Math.floor(d/256);if(256*y>65535)throw new Error("glyphs > 65535 not supported");if(p.ranges[y])return{stack:n,id:d,glyph:m};if(!this.url)throw new Error("glyphsUrl is not set");if(!p.requests[y]){const C=ge.loadGlyphRange(n,y,this.url,this.requestManager);p.requests[y]=C}const E=yield p.requests[y];for(const C in E)this._doesCharSupportLocalGlyph(+C)||(p.glyphs[+C]=E[+C]);return p.ranges[y]=!0,{stack:n,id:d,glyph:E[d]||null}}))}_doesCharSupportLocalGlyph(n){return!!this.localIdeographFontFamily&&/\p{Ideo}|\p{sc=Hang}|\p{sc=Hira}|\p{sc=Kana}/u.test(String.fromCodePoint(n))}_tinySDF(n,d,p){const m=this.localIdeographFontFamily;if(!m||!this._doesCharSupportLocalGlyph(p))return;let y=n.tinySDF;if(!y){let C="400";/bold/i.test(d)?C="900":/medium/i.test(d)?C="500":/light/i.test(d)&&(C="200"),y=n.tinySDF=new ge.TinySDF({fontSize:48,buffer:6,radius:16,cutoff:.25,fontFamily:m,fontWeight:C})}const E=y.draw(String.fromCharCode(p));return{id:p,bitmap:new l.o({width:E.width||60,height:E.height||60},E.data),metrics:{width:E.glyphWidth/2||24,height:E.glyphHeight/2||24,left:E.glyphLeft/2+.5||0,top:E.glyphTop/2-27.5||-8,advance:E.glyphAdvance/2||24,isDoubleResolution:!0}}}}ge.loadGlyphRange=function(x,n,d,p){return l._(this,void 0,void 0,(function*(){const m=256*n,y=m+255,E=p.transformRequest(d.replace("{fontstack}",x).replace("{range}",`${m}-${y}`),"Glyphs"),C=yield l.l(E,new AbortController);if(!C||!C.data)throw new Error(`Could not load glyph range. range: ${n}, ${m}-${y}`);const M={};for(const D of l.n(C.data))M[D.id]=D;return M}))},ge.TinySDF=class{constructor({fontSize:x=24,buffer:n=3,radius:d=8,cutoff:p=.25,fontFamily:m="sans-serif",fontWeight:y="normal",fontStyle:E="normal"}={}){this.buffer=n,this.cutoff=p,this.radius=d;const C=this.size=x+4*n,M=this._createCanvas(C),D=this.ctx=M.getContext("2d",{willReadFrequently:!0});D.font=`${E} ${y} ${x}px ${m}`,D.textBaseline="alphabetic",D.textAlign="left",D.fillStyle="black",this.gridOuter=new Float64Array(C*C),this.gridInner=new Float64Array(C*C),this.f=new Float64Array(C),this.z=new Float64Array(C+1),this.v=new Uint16Array(C)}_createCanvas(x){const n=document.createElement("canvas");return n.width=n.height=x,n}draw(x){const{width:n,actualBoundingBoxAscent:d,actualBoundingBoxDescent:p,actualBoundingBoxLeft:m,actualBoundingBoxRight:y}=this.ctx.measureText(x),E=Math.ceil(d),C=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(y-m))),M=Math.min(this.size-this.buffer,E+Math.ceil(p)),D=C+2*this.buffer,N=M+2*this.buffer,z=Math.max(D*N,0),H=new Uint8ClampedArray(z),Y={data:H,width:D,height:N,glyphWidth:C,glyphHeight:M,glyphTop:E,glyphLeft:0,glyphAdvance:n};if(C===0||M===0)return Y;const{ctx:K,buffer:oe,gridInner:he,gridOuter:fe}=this;K.clearRect(oe,oe,C,M),K.fillText(x,oe,oe+E);const _e=K.getImageData(oe,oe,C,M);fe.fill(Ze,0,z),he.fill(0,0,z);for(let re=0;re<M;re++)for(let be=0;be<C;be++){const Se=_e.data[4*(re*C+be)+3]/255;if(Se===0)continue;const De=(re+oe)*D+be+oe;if(Se===1)fe[De]=0,he[De]=Ze;else{const Xe=.5-Se;fe[De]=Xe>0?Xe*Xe:0,he[De]=Xe<0?Xe*Xe:0}}ve(fe,0,0,D,N,D,this.f,this.v,this.z),ve(he,oe,oe,C,M,D,this.f,this.v,this.z);for(let re=0;re<z;re++){const be=Math.sqrt(fe[re])-Math.sqrt(he[re]);H[re]=Math.round(255-255*(be/this.radius+this.cutoff))}return Y}};class ce{constructor(){this.specification=l.v.light.position}possiblyEvaluate(n,d){return l.x(n.expression.evaluate(d))}interpolate(n,d,p){return{x:l.y.number(n.x,d.x,p),y:l.y.number(n.y,d.y,p),z:l.y.number(n.z,d.z,p)}}}let ke;class Be extends l.E{constructor(n){super(),ke=ke||new l.q({anchor:new l.D(l.v.light.anchor),position:new ce,color:new l.D(l.v.light.color),intensity:new l.D(l.v.light.intensity)}),this._transitionable=new l.T(ke),this.setLight(n),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(n,d={}){if(!this._validate(l.r,n,d))for(const p in n){const m=n[p];p.endsWith("-transition")?this._transitionable.setTransition(p.slice(0,-11),m):this._transitionable.setValue(p,m)}}updateTransitions(n){this._transitioning=this._transitionable.transitioned(n,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(n){this.properties=this._transitioning.possiblyEvaluate(n)}_validate(n,d,p){return(!p||p.validate!==!1)&&l.t(this,n.call(l.u,{value:d,style:{glyphs:!0,sprite:!0},styleSpec:l.v}))}}const Ve=new l.q({"sky-color":new l.D(l.v.sky["sky-color"]),"horizon-color":new l.D(l.v.sky["horizon-color"]),"fog-color":new l.D(l.v.sky["fog-color"]),"fog-ground-blend":new l.D(l.v.sky["fog-ground-blend"]),"horizon-fog-blend":new l.D(l.v.sky["horizon-fog-blend"]),"sky-horizon-blend":new l.D(l.v.sky["sky-horizon-blend"]),"atmosphere-blend":new l.D(l.v.sky["atmosphere-blend"])});class We extends l.E{constructor(n){super(),this._transitionable=new l.T(Ve),this.setSky(n),this._transitioning=this._transitionable.untransitioned(),this.recalculate(new l.z(0))}setSky(n,d={}){if(!this._validate(l.B,n,d)){n||(n={"sky-color":"transparent","horizon-color":"transparent","fog-color":"transparent","fog-ground-blend":1,"atmosphere-blend":0});for(const p in n){const m=n[p];p.endsWith("-transition")?this._transitionable.setTransition(p.slice(0,-11),m):this._transitionable.setValue(p,m)}}}getSky(){return this._transitionable.serialize()}updateTransitions(n){this._transitioning=this._transitionable.transitioned(n,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(n){this.properties=this._transitioning.possiblyEvaluate(n)}_validate(n,d,p={}){return p?.validate!==!1&&l.t(this,n.call(l.u,l.e({value:d,style:{glyphs:!0,sprite:!0},styleSpec:l.v})))}calculateFogBlendOpacity(n){return n<60?0:n<70?(n-60)/10:1}}class tt{constructor(n,d){this.width=n,this.height=d,this.nextRow=0,this.data=new Uint8Array(this.width*this.height),this.dashEntry={}}getDash(n,d){const p=n.join(",")+String(d);return this.dashEntry[p]||(this.dashEntry[p]=this.addDash(n,d)),this.dashEntry[p]}getDashRanges(n,d,p){const m=[];let y=n.length%2==1?-n[n.length-1]*p:0,E=n[0]*p,C=!0;m.push({left:y,right:E,isDash:C,zeroLength:n[0]===0});let M=n[0];for(let D=1;D<n.length;D++){C=!C;const N=n[D];y=M*p,M+=N,E=M*p,m.push({left:y,right:E,isDash:C,zeroLength:N===0})}return m}addRoundDash(n,d,p){const m=d/2;for(let y=-p;y<=p;y++){const E=this.width*(this.nextRow+p+y);let C=0,M=n[C];for(let D=0;D<this.width;D++){D/M.right>1&&(M=n[++C]);const N=Math.abs(D-M.left),z=Math.abs(D-M.right),H=Math.min(N,z);let Y;const K=y/p*(m+1);if(M.isDash){const oe=m-Math.abs(K);Y=Math.sqrt(H*H+oe*oe)}else Y=m-Math.sqrt(H*H+K*K);this.data[E+D]=Math.max(0,Math.min(255,Y+128))}}}addRegularDash(n){for(let C=n.length-1;C>=0;--C){const M=n[C],D=n[C+1];M.zeroLength?n.splice(C,1):D&&D.isDash===M.isDash&&(D.left=M.left,n.splice(C,1))}const d=n[0],p=n[n.length-1];d.isDash===p.isDash&&(d.left=p.left-this.width,p.right=d.right+this.width);const m=this.width*this.nextRow;let y=0,E=n[y];for(let C=0;C<this.width;C++){C/E.right>1&&(E=n[++y]);const M=Math.abs(C-E.left),D=Math.abs(C-E.right),N=Math.min(M,D);this.data[m+C]=Math.max(0,Math.min(255,(E.isDash?N:-N)+128))}}addDash(n,d){const p=d?7:0,m=2*p+1;if(this.nextRow+m>this.height)return l.w("LineAtlas out of space"),null;let y=0;for(let C=0;C<n.length;C++)y+=n[C];if(y!==0){const C=this.width/y,M=this.getDashRanges(n,this.width,C);d?this.addRoundDash(M,C,p):this.addRegularDash(M)}const E={y:(this.nextRow+p+.5)/this.height,height:2*p/this.height,width:y};return this.nextRow+=m,this.dirty=!0,E}bind(n){const d=n.gl;this.texture?(d.bindTexture(d.TEXTURE_2D,this.texture),this.dirty&&(this.dirty=!1,d.texSubImage2D(d.TEXTURE_2D,0,0,0,this.width,this.height,d.ALPHA,d.UNSIGNED_BYTE,this.data))):(this.texture=d.createTexture(),d.bindTexture(d.TEXTURE_2D,this.texture),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,d.REPEAT),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,d.REPEAT),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d.LINEAR),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.LINEAR),d.texImage2D(d.TEXTURE_2D,0,d.ALPHA,this.width,this.height,0,d.ALPHA,d.UNSIGNED_BYTE,this.data))}}const wt="maplibre_preloaded_worker_pool";class _t{constructor(){this.active={}}acquire(n){if(!this.workers)for(this.workers=[];this.workers.length<_t.workerCount;)this.workers.push(new Worker(l.a.WORKER_URL));return this.active[n]=!0,this.workers.slice()}release(n){delete this.active[n],this.numActive()===0&&(this.workers.forEach((d=>{d.terminate()})),this.workers=null)}isPreloaded(){return!!this.active[wt]}numActive(){return Object.keys(this.active).length}}const $t=Math.floor(S.hardwareConcurrency/2);let kt,Bt;function Kt(){return kt||(kt=new _t),kt}_t.workerCount=l.C(globalThis)?Math.max(Math.min($t,3),1):1;class Et{constructor(n,d){this.workerPool=n,this.actors=[],this.currentActor=0,this.id=d;const p=this.workerPool.acquire(d);for(let m=0;m<p.length;m++){const y=new l.F(p[m],d);y.name=`Worker ${m}`,this.actors.push(y)}if(!this.actors.length)throw new Error("No actors found")}broadcast(n,d){const p=[];for(const m of this.actors)p.push(m.sendAsync({type:n,data:d}));return Promise.all(p)}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(n=!0){this.actors.forEach((d=>{d.remove()})),this.actors=[],n&&this.workerPool.release(this.id)}registerMessageHandler(n,d){for(const p of this.actors)p.registerMessageHandler(n,d)}}function Li(){return Bt||(Bt=new Et(Kt(),l.G),Bt.registerMessageHandler("GR",((x,n,d)=>l.m(n,d)))),Bt}function bi(x,n){const d=l.H();return l.J(d,d,[1,1,0]),l.K(d,d,[.5*x.width,.5*x.height,1]),l.L(d,d,x.calculatePosMatrix(n.toUnwrapped()))}function Ri(x,n,d,p,m,y){const E=(function(z,H,Y){if(z)for(const K of z){const oe=H[K];if(oe&&oe.source===Y&&oe.type==="fill-extrusion")return!0}else for(const K in H){const oe=H[K];if(oe.source===Y&&oe.type==="fill-extrusion")return!0}return!1})(m&&m.layers,n,x.id),C=y.maxPitchScaleFactor(),M=x.tilesIn(p,C,E);M.sort(Fi);const D=[];for(const z of M)D.push({wrappedTileID:z.tileID.wrapped().key,queryResults:z.tile.queryRenderedFeatures(n,d,x._state,z.queryGeometry,z.cameraQueryGeometry,z.scale,m,y,C,bi(x.transform,z.tileID))});const N=(function(z){const H={},Y={};for(const K of z){const oe=K.queryResults,he=K.wrappedTileID,fe=Y[he]=Y[he]||{};for(const _e in oe){const re=oe[_e],be=fe[_e]=fe[_e]||{},Se=H[_e]=H[_e]||[];for(const De of re)be[De.featureIndex]||(be[De.featureIndex]=!0,Se.push(De))}}return H})(D);for(const z in N)N[z].forEach((H=>{const Y=H.feature,K=x.getFeatureState(Y.layer["source-layer"],Y.id);Y.source=Y.layer.source,Y.layer["source-layer"]&&(Y.sourceLayer=Y.layer["source-layer"]),Y.state=K}));return N}function Fi(x,n){const d=x.tileID,p=n.tileID;return d.overscaledZ-p.overscaledZ||d.canonical.y-p.canonical.y||d.wrap-p.wrap||d.canonical.x-p.canonical.x}function Lt(x,n,d){return l._(this,void 0,void 0,(function*(){let p=x;if(x.url?p=(yield l.h(n.transformRequest(x.url,"Source"),d)).data:yield S.frameAsync(d),!p)return null;const m=l.M(l.e(p,x),["tiles","minzoom","maxzoom","attribution","bounds","scheme","tileSize","encoding"]);return"vector_layers"in p&&p.vector_layers&&(m.vectorLayerIds=p.vector_layers.map((y=>y.id))),m}))}class Ce{constructor(n,d){n&&(d?this.setSouthWest(n).setNorthEast(d):Array.isArray(n)&&(n.length===4?this.setSouthWest([n[0],n[1]]).setNorthEast([n[2],n[3]]):this.setSouthWest(n[0]).setNorthEast(n[1])))}setNorthEast(n){return this._ne=n instanceof l.N?new l.N(n.lng,n.lat):l.N.convert(n),this}setSouthWest(n){return this._sw=n instanceof l.N?new l.N(n.lng,n.lat):l.N.convert(n),this}extend(n){const d=this._sw,p=this._ne;let m,y;if(n instanceof l.N)m=n,y=n;else{if(!(n instanceof Ce))return Array.isArray(n)?n.length===4||n.every(Array.isArray)?this.extend(Ce.convert(n)):this.extend(l.N.convert(n)):n&&("lng"in n||"lon"in n)&&"lat"in n?this.extend(l.N.convert(n)):this;if(m=n._sw,y=n._ne,!m||!y)return this}return d||p?(d.lng=Math.min(m.lng,d.lng),d.lat=Math.min(m.lat,d.lat),p.lng=Math.max(y.lng,p.lng),p.lat=Math.max(y.lat,p.lat)):(this._sw=new l.N(m.lng,m.lat),this._ne=new l.N(y.lng,y.lat)),this}getCenter(){return new l.N((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new l.N(this.getWest(),this.getNorth())}getSouthEast(){return new l.N(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(n){const{lng:d,lat:p}=l.N.convert(n);let m=this._sw.lng<=d&&d<=this._ne.lng;return this._sw.lng>this._ne.lng&&(m=this._sw.lng>=d&&d>=this._ne.lng),this._sw.lat<=p&&p<=this._ne.lat&&m}static convert(n){return n instanceof Ce?n:n&&new Ce(n)}static fromLngLat(n,d=0){const p=360*d/40075017,m=p/Math.cos(Math.PI/180*n.lat);return new Ce(new l.N(n.lng-m,n.lat-p),new l.N(n.lng+m,n.lat+p))}adjustAntiMeridian(){const n=new l.N(this._sw.lng,this._sw.lat),d=new l.N(this._ne.lng,this._ne.lat);return new Ce(n,n.lng>d.lng?new l.N(d.lng+360,d.lat):d)}}class ns{constructor(n,d,p){this.bounds=Ce.convert(this.validateBounds(n)),this.minzoom=d||0,this.maxzoom=p||24}validateBounds(n){return Array.isArray(n)&&n.length===4?[Math.max(-180,n[0]),Math.max(-90,n[1]),Math.min(180,n[2]),Math.min(90,n[3])]:[-180,-90,180,90]}contains(n){const d=Math.pow(2,n.z),p=Math.floor(l.O(this.bounds.getWest())*d),m=Math.floor(l.Q(this.bounds.getNorth())*d),y=Math.ceil(l.O(this.bounds.getEast())*d),E=Math.ceil(l.Q(this.bounds.getSouth())*d);return n.x>=p&&n.x<y&&n.y>=m&&n.y<E}}class os extends l.E{constructor(n,d,p,m){if(super(),this.id=n,this.dispatcher=p,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,l.e(this,l.M(d,["url","scheme","tileSize","promoteId"])),this._options=l.e({type:"vector"},d),this._collectResourceTiming=d.collectResourceTiming,this.tileSize!==512)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(m)}load(){return l._(this,void 0,void 0,(function*(){this._loaded=!1,this.fire(new l.k("dataloading",{dataType:"source"})),this._tileJSONRequest=new AbortController;try{const n=yield Lt(this._options,this.map._requestManager,this._tileJSONRequest);this._tileJSONRequest=null,this._loaded=!0,this.map.style.sourceCaches[this.id].clearTiles(),n&&(l.e(this,n),n.bounds&&(this.tileBounds=new ns(n.bounds,this.minzoom,this.maxzoom)),this.fire(new l.k("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new l.k("data",{dataType:"source",sourceDataType:"content"})))}catch(n){this._tileJSONRequest=null,this.fire(new l.j(n))}}))}loaded(){return this._loaded}hasTile(n){return!this.tileBounds||this.tileBounds.contains(n.canonical)}onAdd(n){this.map=n,this.load()}setSourceProperty(n){this._tileJSONRequest&&this._tileJSONRequest.abort(),n(),this.load()}setTiles(n){return this.setSourceProperty((()=>{this._options.tiles=n})),this}setUrl(n){return this.setSourceProperty((()=>{this.url=n,this._options.url=n})),this}onRemove(){this._tileJSONRequest&&(this._tileJSONRequest.abort(),this._tileJSONRequest=null)}serialize(){return l.e({},this._options)}loadTile(n){return l._(this,void 0,void 0,(function*(){const d=n.tileID.canonical.url(this.tiles,this.map.getPixelRatio(),this.scheme),p={request:this.map._requestManager.transformRequest(d,"Tile"),uid:n.uid,tileID:n.tileID,zoom:n.tileID.overscaledZ,tileSize:this.tileSize*n.tileID.overscaleFactor(),type:this.type,source:this.id,pixelRatio:this.map.getPixelRatio(),showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId};p.request.collectResourceTiming=this._collectResourceTiming;let m="RT";if(n.actor&&n.state!=="expired"){if(n.state==="loading")return new Promise(((y,E)=>{n.reloadPromise={resolve:y,reject:E}}))}else n.actor=this.dispatcher.getActor(),m="LT";n.abortController=new AbortController;try{const y=yield n.actor.sendAsync({type:m,data:p},n.abortController);if(delete n.abortController,n.aborted)return;this._afterTileLoadWorkerResponse(n,y)}catch(y){if(delete n.abortController,n.aborted)return;if(y&&y.status!==404)throw y;this._afterTileLoadWorkerResponse(n,null)}}))}_afterTileLoadWorkerResponse(n,d){if(d&&d.resourceTiming&&(n.resourceTiming=d.resourceTiming),d&&this.map._refreshExpiredTiles&&n.setExpiryData(d),n.loadVectorData(d,this.map.painter),n.reloadPromise){const p=n.reloadPromise;n.reloadPromise=null,this.loadTile(n).then(p.resolve).catch(p.reject)}}abortTile(n){return l._(this,void 0,void 0,(function*(){n.abortController&&(n.abortController.abort(),delete n.abortController),n.actor&&(yield n.actor.sendAsync({type:"AT",data:{uid:n.uid,type:this.type,source:this.id}}))}))}unloadTile(n){return l._(this,void 0,void 0,(function*(){n.unloadVectorData(),n.actor&&(yield n.actor.sendAsync({type:"RMT",data:{uid:n.uid,type:this.type,source:this.id}}))}))}hasTransition(){return!1}}class ii extends l.E{constructor(n,d,p,m){super(),this.id=n,this.dispatcher=p,this.setEventedParent(m),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=l.e({type:"raster"},d),l.e(this,l.M(d,["url","scheme","tileSize"]))}load(){return l._(this,void 0,void 0,(function*(){this._loaded=!1,this.fire(new l.k("dataloading",{dataType:"source"})),this._tileJSONRequest=new AbortController;try{const n=yield Lt(this._options,this.map._requestManager,this._tileJSONRequest);this._tileJSONRequest=null,this._loaded=!0,n&&(l.e(this,n),n.bounds&&(this.tileBounds=new ns(n.bounds,this.minzoom,this.maxzoom)),this.fire(new l.k("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new l.k("data",{dataType:"source",sourceDataType:"content"})))}catch(n){this._tileJSONRequest=null,this.fire(new l.j(n))}}))}loaded(){return this._loaded}onAdd(n){this.map=n,this.load()}onRemove(){this._tileJSONRequest&&(this._tileJSONRequest.abort(),this._tileJSONRequest=null)}setSourceProperty(n){this._tileJSONRequest&&(this._tileJSONRequest.abort(),this._tileJSONRequest=null),n(),this.load()}setTiles(n){return this.setSourceProperty((()=>{this._options.tiles=n})),this}setUrl(n){return this.setSourceProperty((()=>{this.url=n,this._options.url=n})),this}serialize(){return l.e({},this._options)}hasTile(n){return!this.tileBounds||this.tileBounds.contains(n.canonical)}loadTile(n){return l._(this,void 0,void 0,(function*(){const d=n.tileID.canonical.url(this.tiles,this.map.getPixelRatio(),this.scheme);n.abortController=new AbortController;try{const p=yield te.getImage(this.map._requestManager.transformRequest(d,"Tile"),n.abortController,this.map._refreshExpiredTiles);if(delete n.abortController,n.aborted)return void(n.state="unloaded");if(p&&p.data){this.map._refreshExpiredTiles&&p.cacheControl&&p.expires&&n.setExpiryData({cacheControl:p.cacheControl,expires:p.expires});const m=this.map.painter.context,y=m.gl,E=p.data;n.texture=this.map.painter.getTileTexture(E.width),n.texture?n.texture.update(E,{useMipmap:!0}):(n.texture=new Ye(m,E,y.RGBA,{useMipmap:!0}),n.texture.bind(y.LINEAR,y.CLAMP_TO_EDGE,y.LINEAR_MIPMAP_NEAREST)),n.state="loaded"}}catch(p){if(delete n.abortController,n.aborted)n.state="unloaded";else if(p)throw n.state="errored",p}}))}abortTile(n){return l._(this,void 0,void 0,(function*(){n.abortController&&(n.abortController.abort(),delete n.abortController)}))}unloadTile(n){return l._(this,void 0,void 0,(function*(){n.texture&&this.map.painter.saveTileTexture(n.texture)}))}hasTransition(){return!1}}class wi extends ii{constructor(n,d,p,m){super(n,d,p,m),this.type="raster-dem",this.maxzoom=22,this._options=l.e({type:"raster-dem"},d),this.encoding=d.encoding||"mapbox",this.redFactor=d.redFactor,this.greenFactor=d.greenFactor,this.blueFactor=d.blueFactor,this.baseShift=d.baseShift}loadTile(n){return l._(this,void 0,void 0,(function*(){const d=n.tileID.canonical.url(this.tiles,this.map.getPixelRatio(),this.scheme),p=this.map._requestManager.transformRequest(d,"Tile");n.neighboringTiles=this._getNeighboringTiles(n.tileID),n.abortController=new AbortController;try{const m=yield te.getImage(p,n.abortController,this.map._refreshExpiredTiles);if(delete n.abortController,n.aborted)return void(n.state="unloaded");if(m&&m.data){const y=m.data;this.map._refreshExpiredTiles&&m.cacheControl&&m.expires&&n.setExpiryData({cacheControl:m.cacheControl,expires:m.expires});const E=l.b(y)&&l.U()?y:yield this.readImageNow(y),C={type:this.type,uid:n.uid,source:this.id,rawImageData:E,encoding:this.encoding,redFactor:this.redFactor,greenFactor:this.greenFactor,blueFactor:this.blueFactor,baseShift:this.baseShift};if(!n.actor||n.state==="expired"){n.actor=this.dispatcher.getActor();const M=yield n.actor.sendAsync({type:"LDT",data:C});n.dem=M,n.needsHillshadePrepare=!0,n.needsTerrainPrepare=!0,n.state="loaded"}}}catch(m){if(delete n.abortController,n.aborted)n.state="unloaded";else if(m)throw n.state="errored",m}}))}readImageNow(n){return l._(this,void 0,void 0,(function*(){if(typeof VideoFrame<"u"&&l.V()){const d=n.width+2,p=n.height+2;try{return new l.R({width:d,height:p},yield l.W(n,-1,-1,d,p))}catch{}}return S.getImageData(n,1)}))}_getNeighboringTiles(n){const d=n.canonical,p=Math.pow(2,d.z),m=(d.x-1+p)%p,y=d.x===0?n.wrap-1:n.wrap,E=(d.x+1+p)%p,C=d.x+1===p?n.wrap+1:n.wrap,M={};return M[new l.S(n.overscaledZ,y,d.z,m,d.y).key]={backfilled:!1},M[new l.S(n.overscaledZ,C,d.z,E,d.y).key]={backfilled:!1},d.y>0&&(M[new l.S(n.overscaledZ,y,d.z,m,d.y-1).key]={backfilled:!1},M[new l.S(n.overscaledZ,n.wrap,d.z,d.x,d.y-1).key]={backfilled:!1},M[new l.S(n.overscaledZ,C,d.z,E,d.y-1).key]={backfilled:!1}),d.y+1<p&&(M[new l.S(n.overscaledZ,y,d.z,m,d.y+1).key]={backfilled:!1},M[new l.S(n.overscaledZ,n.wrap,d.z,d.x,d.y+1).key]={backfilled:!1},M[new l.S(n.overscaledZ,C,d.z,E,d.y+1).key]={backfilled:!1}),M}unloadTile(n){return l._(this,void 0,void 0,(function*(){n.demTexture&&this.map.painter.saveTileTexture(n.demTexture),n.fbo&&(n.fbo.destroy(),delete n.fbo),n.dem&&delete n.dem,delete n.neighboringTiles,n.state="unloaded",n.actor&&(yield n.actor.sendAsync({type:"RDT",data:{type:this.type,uid:n.uid,source:this.id}}))}))}}class qi extends l.E{constructor(n,d,p,m){super(),this.id=n,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._removed=!1,this._pendingLoads=0,this.actor=p.getActor(),this.setEventedParent(m),this._data=d.data,this._options=l.e({},d),this._collectResourceTiming=d.collectResourceTiming,d.maxzoom!==void 0&&(this.maxzoom=d.maxzoom),d.type&&(this.type=d.type),d.attribution&&(this.attribution=d.attribution),this.promoteId=d.promoteId;const y=l.X/this.tileSize;d.clusterMaxZoom!==void 0&&this.maxzoom<=d.clusterMaxZoom&&l.w(`The maxzoom value "${this.maxzoom}" is expected to be greater than the clusterMaxZoom value "${d.clusterMaxZoom}".`),this.workerOptions=l.e({source:this.id,cluster:d.cluster||!1,geojsonVtOptions:{buffer:(d.buffer!==void 0?d.buffer:128)*y,tolerance:(d.tolerance!==void 0?d.tolerance:.375)*y,extent:l.X,maxZoom:this.maxzoom,lineMetrics:d.lineMetrics||!1,generateId:d.generateId||!1},superclusterOptions:{maxZoom:d.clusterMaxZoom!==void 0?d.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,d.clusterMinPoints||2),extent:l.X,radius:(d.clusterRadius||50)*y,log:!1,generateId:d.generateId||!1},clusterProperties:d.clusterProperties,filter:d.filter},d.workerOptions),typeof this.promoteId=="string"&&(this.workerOptions.promoteId=this.promoteId)}load(){return l._(this,void 0,void 0,(function*(){yield this._updateWorkerData()}))}onAdd(n){this.map=n,this.load()}setData(n){return this._data=n,this._updateWorkerData(),this}updateData(n){return this._updateWorkerData(n),this}getData(){return l._(this,void 0,void 0,(function*(){const n=l.e({type:this.type},this.workerOptions);return this.actor.sendAsync({type:"GD",data:n})}))}setClusterOptions(n){return this.workerOptions.cluster=n.cluster,n&&(n.clusterRadius!==void 0&&(this.workerOptions.superclusterOptions.radius=n.clusterRadius),n.clusterMaxZoom!==void 0&&(this.workerOptions.superclusterOptions.maxZoom=n.clusterMaxZoom)),this._updateWorkerData(),this}getClusterExpansionZoom(n){return this.actor.sendAsync({type:"GCEZ",data:{type:this.type,clusterId:n,source:this.id}})}getClusterChildren(n){return this.actor.sendAsync({type:"GCC",data:{type:this.type,clusterId:n,source:this.id}})}getClusterLeaves(n,d,p){return this.actor.sendAsync({type:"GCL",data:{type:this.type,source:this.id,clusterId:n,limit:d,offset:p}})}_updateWorkerData(n){return l._(this,void 0,void 0,(function*(){const d=l.e({type:this.type},this.workerOptions);n?d.dataDiff=n:typeof this._data=="string"?(d.request=this.map._requestManager.transformRequest(S.resolveURL(this._data),"Source"),d.request.collectResourceTiming=this._collectResourceTiming):d.data=JSON.stringify(this._data),this._pendingLoads++,this.fire(new l.k("dataloading",{dataType:"source"}));try{const p=yield this.actor.sendAsync({type:"LD",data:d});if(this._pendingLoads--,this._removed||p.abandoned)return void this.fire(new l.k("dataabort",{dataType:"source"}));let m=null;p.resourceTiming&&p.resourceTiming[this.id]&&(m=p.resourceTiming[this.id].slice(0));const y={dataType:"source"};this._collectResourceTiming&&m&&m.length>0&&l.e(y,{resourceTiming:m}),this.fire(new l.k("data",Object.assign(Object.assign({},y),{sourceDataType:"metadata"}))),this.fire(new l.k("data",Object.assign(Object.assign({},y),{sourceDataType:"content"})))}catch(p){if(this._pendingLoads--,this._removed)return void this.fire(new l.k("dataabort",{dataType:"source"}));this.fire(new l.j(p))}}))}loaded(){return this._pendingLoads===0}loadTile(n){return l._(this,void 0,void 0,(function*(){const d=n.actor?"RT":"LT";n.actor=this.actor;const p={type:this.type,uid:n.uid,tileID:n.tileID,zoom:n.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,pixelRatio:this.map.getPixelRatio(),showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId};n.abortController=new AbortController;const m=yield this.actor.sendAsync({type:d,data:p},n.abortController);delete n.abortController,n.unloadVectorData(),n.aborted||n.loadVectorData(m,this.map.painter,d==="RT")}))}abortTile(n){return l._(this,void 0,void 0,(function*(){n.abortController&&(n.abortController.abort(),delete n.abortController),n.aborted=!0}))}unloadTile(n){return l._(this,void 0,void 0,(function*(){n.unloadVectorData(),yield this.actor.sendAsync({type:"RMT",data:{uid:n.uid,type:this.type,source:this.id}})}))}onRemove(){this._removed=!0,this.actor.sendAsync({type:"RS",data:{type:this.type,source:this.id}})}serialize(){return l.e({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}}var Ns=l.Y([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);class _s extends l.E{constructor(n,d,p,m){super(),this.id=n,this.dispatcher=p,this.coordinates=d.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.setEventedParent(m),this.options=d}load(n){return l._(this,void 0,void 0,(function*(){this._loaded=!1,this.fire(new l.k("dataloading",{dataType:"source"})),this.url=this.options.url,this._request=new AbortController;try{const d=yield te.getImage(this.map._requestManager.transformRequest(this.url,"Image"),this._request);this._request=null,this._loaded=!0,d&&d.data&&(this.image=d.data,n&&(this.coordinates=n),this._finishLoading())}catch(d){this._request=null,this._loaded=!0,this.fire(new l.j(d))}}))}loaded(){return this._loaded}updateImage(n){return n.url?(this._request&&(this._request.abort(),this._request=null),this.options.url=n.url,this.load(n.coordinates).finally((()=>{this.texture=null})),this):this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new l.k("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(n){this.map=n,this.load()}onRemove(){this._request&&(this._request.abort(),this._request=null)}setCoordinates(n){this.coordinates=n;const d=n.map(l.Z.fromLngLat);this.tileID=(function(m){let y=1/0,E=1/0,C=-1/0,M=-1/0;for(const H of m)y=Math.min(y,H.x),E=Math.min(E,H.y),C=Math.max(C,H.x),M=Math.max(M,H.y);const D=Math.max(C-y,M-E),N=Math.max(0,Math.floor(-Math.log(D)/Math.LN2)),z=Math.pow(2,N);return new l.a1(N,Math.floor((y+C)/2*z),Math.floor((E+M)/2*z))})(d),this.minzoom=this.maxzoom=this.tileID.z;const p=d.map((m=>this.tileID.getTilePoint(m)._round()));return this._boundsArray=new l.$,this._boundsArray.emplaceBack(p[0].x,p[0].y,0,0),this._boundsArray.emplaceBack(p[1].x,p[1].y,l.X,0),this._boundsArray.emplaceBack(p[3].x,p[3].y,0,l.X),this._boundsArray.emplaceBack(p[2].x,p[2].y,l.X,l.X),this.boundsBuffer&&(this.boundsBuffer.destroy(),delete this.boundsBuffer),this.fire(new l.k("data",{dataType:"source",sourceDataType:"content"})),this}prepare(){if(Object.keys(this.tiles).length===0||!this.image)return;const n=this.map.painter.context,d=n.gl;this.boundsBuffer||(this.boundsBuffer=n.createVertexBuffer(this._boundsArray,Ns.members)),this.boundsSegments||(this.boundsSegments=l.a0.simpleSegment(0,0,4,2)),this.texture||(this.texture=new Ye(n,this.image,d.RGBA),this.texture.bind(d.LINEAR,d.CLAMP_TO_EDGE));let p=!1;for(const m in this.tiles){const y=this.tiles[m];y.state!=="loaded"&&(y.state="loaded",y.texture=this.texture,p=!0)}p&&this.fire(new l.k("data",{dataType:"source",sourceDataType:"idle",sourceId:this.id}))}loadTile(n){return l._(this,void 0,void 0,(function*(){this.tileID&&this.tileID.equals(n.tileID.canonical)?(this.tiles[String(n.tileID.wrap)]=n,n.buckets={}):n.state="errored"}))}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}}class zs extends _s{constructor(n,d,p,m){super(n,d,p,m),this.roundZoom=!0,this.type="video",this.options=d}load(){return l._(this,void 0,void 0,(function*(){this._loaded=!1;const n=this.options;this.urls=[];for(const d of n.urls)this.urls.push(this.map._requestManager.transformRequest(d,"Source").url);try{const d=yield l.a3(this.urls);if(this._loaded=!0,!d)return;this.video=d,this.video.loop=!0,this.video.addEventListener("playing",(()=>{this.map.triggerRepaint()})),this.map&&this.video.play(),this._finishLoading()}catch(d){this.fire(new l.j(d))}}))}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(n){if(this.video){const d=this.video.seekable;n<d.start(0)||n>d.end(0)?this.fire(new l.j(new l.a2(`sources.${this.id}`,null,`Playback for this video can be set only between the ${d.start(0)} and ${d.end(0)}-second mark.`))):this.video.currentTime=n}}getVideo(){return this.video}onAdd(n){this.map||(this.map=n,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(Object.keys(this.tiles).length===0||this.video.readyState<2)return;const n=this.map.painter.context,d=n.gl;this.boundsBuffer||(this.boundsBuffer=n.createVertexBuffer(this._boundsArray,Ns.members)),this.boundsSegments||(this.boundsSegments=l.a0.simpleSegment(0,0,4,2)),this.texture?this.video.paused||(this.texture.bind(d.LINEAR,d.CLAMP_TO_EDGE),d.texSubImage2D(d.TEXTURE_2D,0,0,0,d.RGBA,d.UNSIGNED_BYTE,this.video)):(this.texture=new Ye(n,this.video,d.RGBA),this.texture.bind(d.LINEAR,d.CLAMP_TO_EDGE));let p=!1;for(const m in this.tiles){const y=this.tiles[m];y.state!=="loaded"&&(y.state="loaded",y.texture=this.texture,p=!0)}p&&this.fire(new l.k("data",{dataType:"source",sourceDataType:"idle",sourceId:this.id}))}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}}class kr extends _s{constructor(n,d,p,m){super(n,d,p,m),d.coordinates?Array.isArray(d.coordinates)&&d.coordinates.length===4&&!d.coordinates.some((y=>!Array.isArray(y)||y.length!==2||y.some((E=>typeof E!="number"))))||this.fire(new l.j(new l.a2(`sources.${n}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new l.j(new l.a2(`sources.${n}`,null,'missing required property "coordinates"'))),d.animate&&typeof d.animate!="boolean"&&this.fire(new l.j(new l.a2(`sources.${n}`,null,'optional "animate" property must be a boolean value'))),d.canvas?typeof d.canvas=="string"||d.canvas instanceof HTMLCanvasElement||this.fire(new l.j(new l.a2(`sources.${n}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new l.j(new l.a2(`sources.${n}`,null,'missing required property "canvas"'))),this.options=d,this.animate=d.animate===void 0||d.animate}load(){return l._(this,void 0,void 0,(function*(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof HTMLCanvasElement?this.options.canvas:document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new l.j(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())}))}getCanvas(){return this.canvas}onAdd(n){this.map=n,this.load(),this.canvas&&this.animate&&this.play()}onRemove(){this.pause()}prepare(){let n=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,n=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,n=!0),this._hasInvalidDimensions()||Object.keys(this.tiles).length===0)return;const d=this.map.painter.context,p=d.gl;this.boundsBuffer||(this.boundsBuffer=d.createVertexBuffer(this._boundsArray,Ns.members)),this.boundsSegments||(this.boundsSegments=l.a0.simpleSegment(0,0,4,2)),this.texture?(n||this._playing)&&this.texture.update(this.canvas,{premultiply:!0}):this.texture=new Ye(d,this.canvas,p.RGBA,{premultiply:!0});let m=!1;for(const y in this.tiles){const E=this.tiles[y];E.state!=="loaded"&&(E.state="loaded",E.texture=this.texture,m=!0)}m&&this.fire(new l.k("data",{dataType:"source",sourceDataType:"idle",sourceId:this.id}))}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(const n of[this.canvas.width,this.canvas.height])if(isNaN(n)||n<=0)return!0;return!1}}const Pn={},Mn=x=>{switch(x){case"geojson":return qi;case"image":return _s;case"raster":return ii;case"raster-dem":return wi;case"vector":return os;case"video":return zs;case"canvas":return kr}return Pn[x]},st="RTLPluginLoaded";class Xr extends l.E{constructor(){super(...arguments),this.status="unavailable",this.url=null,this.dispatcher=Li()}_syncState(n){return this.status=n,this.dispatcher.broadcast("SRPS",{pluginStatus:n,pluginURL:this.url}).catch((d=>{throw this.status="error",d}))}getRTLTextPluginStatus(){return this.status}clearRTLTextPlugin(){this.status="unavailable",this.url=null}setRTLTextPlugin(n){return l._(this,arguments,void 0,(function*(d,p=!1){if(this.url)throw new Error("setRTLTextPlugin cannot be called multiple times.");if(this.url=S.resolveURL(d),!this.url)throw new Error(`requested url ${d} is invalid`);if(this.status==="unavailable"){if(!p)return this._requestImport();this.status="deferred",this._syncState(this.status)}else if(this.status==="requested")return this._requestImport()}))}_requestImport(){return l._(this,void 0,void 0,(function*(){yield this._syncState("loading"),this.status="loaded",this.fire(new l.k(st))}))}lazyLoad(){this.status==="unavailable"?this.status="requested":this.status==="deferred"&&this._requestImport()}}let er=null;function Dr(){return er||(er=new Xr),er}class ys{constructor(n,d){this.timeAdded=0,this.fadeEndTime=0,this.tileID=n,this.uid=l.a4(),this.uses=0,this.tileSize=d,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.rtt=[],this.rttCoords={},this.expiredRequestCount=0,this.state="loading"}registerFadeDuration(n){const d=n+this.timeAdded;d<this.fadeEndTime||(this.fadeEndTime=d)}wasRequested(){return this.state==="errored"||this.state==="loaded"||this.state==="reloading"}clearTextures(n){this.demTexture&&n.saveTileTexture(this.demTexture),this.demTexture=null}loadVectorData(n,d,p){if(this.hasData()&&this.unloadVectorData(),this.state="loaded",n){n.featureIndex&&(this.latestFeatureIndex=n.featureIndex,n.rawTileData?(this.latestRawTileData=n.rawTileData,this.latestFeatureIndex.rawTileData=n.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=n.collisionBoxArray,this.buckets=(function(m,y){const E={};if(!y)return E;for(const C of m){const M=C.layerIds.map((D=>y.getLayer(D))).filter(Boolean);if(M.length!==0){C.layers=M,C.stateDependentLayerIds&&(C.stateDependentLayers=C.stateDependentLayerIds.map((D=>M.filter((N=>N.id===D))[0])));for(const D of M)E[D.id]=C}}return E})(n.buckets,d.style),this.hasSymbolBuckets=!1;for(const m in this.buckets){const y=this.buckets[m];if(y instanceof l.a6){if(this.hasSymbolBuckets=!0,!p)break;y.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(const m in this.buckets){const y=this.buckets[m];if(y instanceof l.a6&&y.hasRTLText){this.hasRTLText=!0,Dr().lazyLoad();break}}this.queryPadding=0;for(const m in this.buckets){const y=this.buckets[m];this.queryPadding=Math.max(this.queryPadding,d.style.getLayer(m).queryRadius(y))}n.imageAtlas&&(this.imageAtlas=n.imageAtlas),n.glyphAtlasImage&&(this.glyphAtlasImage=n.glyphAtlasImage)}else this.collisionBoxArray=new l.a5}unloadVectorData(){for(const n in this.buckets)this.buckets[n].destroy();this.buckets={},this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.imageAtlas&&(this.imageAtlas=null),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.latestFeatureIndex=null,this.state="unloaded"}getBucket(n){return this.buckets[n.id]}upload(n){for(const p in this.buckets){const m=this.buckets[p];m.uploadPending()&&m.upload(n)}const d=n.gl;this.imageAtlas&&!this.imageAtlas.uploaded&&(this.imageAtlasTexture=new Ye(n,this.imageAtlas.image,d.RGBA),this.imageAtlas.uploaded=!0),this.glyphAtlasImage&&(this.glyphAtlasTexture=new Ye(n,this.glyphAtlasImage,d.ALPHA),this.glyphAtlasImage=null)}prepare(n){this.imageAtlas&&this.imageAtlas.patchUpdatedImages(n,this.imageAtlasTexture)}queryRenderedFeatures(n,d,p,m,y,E,C,M,D,N){return this.latestFeatureIndex&&this.latestFeatureIndex.rawTileData?this.latestFeatureIndex.query({queryGeometry:m,cameraQueryGeometry:y,scale:E,tileSize:this.tileSize,pixelPosMatrix:N,transform:M,params:C,queryPadding:this.queryPadding*D},n,d,p):{}}querySourceFeatures(n,d){const p=this.latestFeatureIndex;if(!p||!p.rawTileData)return;const m=p.loadVTLayers(),y=d&&d.sourceLayer?d.sourceLayer:"",E=m._geojsonTileLayer||m[y];if(!E)return;const C=l.a7(d&&d.filter),{z:M,x:D,y:N}=this.tileID.canonical,z={z:M,x:D,y:N};for(let H=0;H<E.length;H++){const Y=E.feature(H);if(C.needGeometry){const he=l.a8(Y,!0);if(!C.filter(new l.z(this.tileID.overscaledZ),he,this.tileID.canonical))continue}else if(!C.filter(new l.z(this.tileID.overscaledZ),Y))continue;const K=p.getId(Y,y),oe=new l.a9(Y,M,D,N,K);oe.tile=z,n.push(oe)}}hasData(){return this.state==="loaded"||this.state==="reloading"||this.state==="expired"}patternsLoaded(){return this.imageAtlas&&!!Object.keys(this.imageAtlas.patternPositions).length}setExpiryData(n){const d=this.expirationTime;if(n.cacheControl){const p=l.aa(n.cacheControl);p["max-age"]&&(this.expirationTime=Date.now()+1e3*p["max-age"])}else n.expires&&(this.expirationTime=new Date(n.expires).getTime());if(this.expirationTime){const p=Date.now();let m=!1;if(this.expirationTime>p)m=!1;else if(d)if(this.expirationTime<d)m=!0;else{const y=this.expirationTime-d;y?this.expirationTime=p+Math.max(y,3e4):m=!0}else m=!0;m?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-new Date().getTime(),Math.pow(2,31)-1)}setFeatureState(n,d){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData||Object.keys(n).length===0)return;const p=this.latestFeatureIndex.loadVTLayers();for(const m in this.buckets){if(!d.style.hasLayer(m))continue;const y=this.buckets[m],E=y.layers[0].sourceLayer||"_geojsonTileLayer",C=p[E],M=n[E];if(!C||!M||Object.keys(M).length===0)continue;y.update(M,C,this.imageAtlas&&this.imageAtlas.patternPositions||{});const D=d&&d.style&&d.style.getLayer(m);D&&(this.queryPadding=Math.max(this.queryPadding,D.queryRadius(y)))}}holdingForFade(){return this.symbolFadeHoldUntil!==void 0}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<S.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(n){this.symbolFadeHoldUntil=S.now()+n}setDependencies(n,d){const p={};for(const m of d)p[m]=!0;this.dependencies[n]=p}hasDependency(n,d){for(const p of n){const m=this.dependencies[p];if(m){for(const y of d)if(m[y])return!0}}return!1}}class ot{constructor(n,d){this.max=n,this.onRemove=d,this.reset()}reset(){for(const n in this.data)for(const d of this.data[n])d.timeout&&clearTimeout(d.timeout),this.onRemove(d.value);return this.data={},this.order=[],this}add(n,d,p){const m=n.wrapped().key;this.data[m]===void 0&&(this.data[m]=[]);const y={value:d,timeout:void 0};if(p!==void 0&&(y.timeout=setTimeout((()=>{this.remove(n,y)}),p)),this.data[m].push(y),this.order.push(m),this.order.length>this.max){const E=this._getAndRemoveByKey(this.order[0]);E&&this.onRemove(E)}return this}has(n){return n.wrapped().key in this.data}getAndRemove(n){return this.has(n)?this._getAndRemoveByKey(n.wrapped().key):null}_getAndRemoveByKey(n){const d=this.data[n].shift();return d.timeout&&clearTimeout(d.timeout),this.data[n].length===0&&delete this.data[n],this.order.splice(this.order.indexOf(n),1),d.value}getByKey(n){const d=this.data[n];return d?d[0].value:null}get(n){return this.has(n)?this.data[n.wrapped().key][0].value:null}remove(n,d){if(!this.has(n))return this;const p=n.wrapped().key,m=d===void 0?0:this.data[p].indexOf(d),y=this.data[p][m];return this.data[p].splice(m,1),y.timeout&&clearTimeout(y.timeout),this.data[p].length===0&&delete this.data[p],this.onRemove(y.value),this.order.splice(this.order.indexOf(p),1),this}setMaxSize(n){for(this.max=n;this.order.length>this.max;){const d=this._getAndRemoveByKey(this.order[0]);d&&this.onRemove(d)}return this}filter(n){const d=[];for(const p in this.data)for(const m of this.data[p])n(m.value)||d.push(m);for(const p of d)this.remove(p.value.tileID,p)}}class qt{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(n,d,p){const m=String(d);if(this.stateChanges[n]=this.stateChanges[n]||{},this.stateChanges[n][m]=this.stateChanges[n][m]||{},l.e(this.stateChanges[n][m],p),this.deletedStates[n]===null){this.deletedStates[n]={};for(const y in this.state[n])y!==m&&(this.deletedStates[n][y]=null)}else if(this.deletedStates[n]&&this.deletedStates[n][m]===null){this.deletedStates[n][m]={};for(const y in this.state[n][m])p[y]||(this.deletedStates[n][m][y]=null)}else for(const y in p)this.deletedStates[n]&&this.deletedStates[n][m]&&this.deletedStates[n][m][y]===null&&delete this.deletedStates[n][m][y]}removeFeatureState(n,d,p){if(this.deletedStates[n]===null)return;const m=String(d);if(this.deletedStates[n]=this.deletedStates[n]||{},p&&d!==void 0)this.deletedStates[n][m]!==null&&(this.deletedStates[n][m]=this.deletedStates[n][m]||{},this.deletedStates[n][m][p]=null);else if(d!==void 0)if(this.stateChanges[n]&&this.stateChanges[n][m])for(p in this.deletedStates[n][m]={},this.stateChanges[n][m])this.deletedStates[n][m][p]=null;else this.deletedStates[n][m]=null;else this.deletedStates[n]=null}getState(n,d){const p=String(d),m=l.e({},(this.state[n]||{})[p],(this.stateChanges[n]||{})[p]);if(this.deletedStates[n]===null)return{};if(this.deletedStates[n]){const y=this.deletedStates[n][d];if(y===null)return{};for(const E in y)delete m[E]}return m}initializeTileState(n,d){n.setFeatureState(this.state,d)}coalesceChanges(n,d){const p={};for(const m in this.stateChanges){this.state[m]=this.state[m]||{};const y={};for(const E in this.stateChanges[m])this.state[m][E]||(this.state[m][E]={}),l.e(this.state[m][E],this.stateChanges[m][E]),y[E]=this.state[m][E];p[m]=y}for(const m in this.deletedStates){this.state[m]=this.state[m]||{};const y={};if(this.deletedStates[m]===null)for(const E in this.state[m])y[E]={},this.state[m][E]={};else for(const E in this.deletedStates[m]){if(this.deletedStates[m][E]===null)this.state[m][E]={};else for(const C of Object.keys(this.deletedStates[m][E]))delete this.state[m][E][C];y[E]=this.state[m][E]}p[m]=p[m]||{},l.e(p[m],y)}if(this.stateChanges={},this.deletedStates={},Object.keys(p).length!==0)for(const m in n)n[m].setFeatureState(p,d)}}class Nt extends l.E{constructor(n,d,p){super(),this.id=n,this.dispatcher=p,this.on("data",(m=>this._dataHandler(m))),this.on("dataloading",(()=>{this._sourceErrored=!1})),this.on("error",(()=>{this._sourceErrored=this._source.loaded()})),this._source=((m,y,E,C)=>{const M=new(Mn(y.type))(m,y,E,C);if(M.id!==m)throw new Error(`Expected Source id to be ${m} instead of ${M.id}`);return M})(n,d,p,this),this._tiles={},this._cache=new ot(0,(m=>this._unloadTile(m))),this._timers={},this._cacheTimers={},this._maxTileCacheSize=null,this._maxTileCacheZoomLevels=null,this._loadedParentTiles={},this._coveredTiles={},this._state=new qt,this._didEmitContent=!1,this._updated=!1}onAdd(n){this.map=n,this._maxTileCacheSize=n?n._maxTileCacheSize:null,this._maxTileCacheZoomLevels=n?n._maxTileCacheZoomLevels:null,this._source&&this._source.onAdd&&this._source.onAdd(n)}onRemove(n){this.clearTiles(),this._source&&this._source.onRemove&&this._source.onRemove(n)}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded||!this._source.loaded())return!1;if(!(this.used===void 0&&this.usedForTerrain===void 0||this.used||this.usedForTerrain))return!0;if(!this._updated)return!1;for(const n in this._tiles){const d=this._tiles[n];if(d.state!=="loaded"&&d.state!=="errored")return!1}return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;const n=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,n&&this.reload(),this.transform&&this.update(this.transform,this.terrain)}_loadTile(n,d,p){return l._(this,void 0,void 0,(function*(){try{yield this._source.loadTile(n),this._tileLoaded(n,d,p)}catch(m){n.state="errored",m.status!==404?this._source.fire(new l.j(m,{tile:n})):this.update(this.transform,this.terrain)}}))}_unloadTile(n){this._source.unloadTile&&this._source.unloadTile(n)}_abortTile(n){this._source.abortTile&&this._source.abortTile(n),this._source.fire(new l.k("dataabort",{tile:n,coord:n.tileID,dataType:"source"}))}serialize(){return this._source.serialize()}prepare(n){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(const d in this._tiles){const p=this._tiles[d];p.upload(n),p.prepare(this.map.style.imageManager)}}getIds(){return Object.values(this._tiles).map((n=>n.tileID)).sort(Ji).map((n=>n.key))}getRenderableIds(n){const d=[];for(const p in this._tiles)this._isIdRenderable(p,n)&&d.push(this._tiles[p]);return n?d.sort(((p,m)=>{const y=p.tileID,E=m.tileID,C=new l.P(y.canonical.x,y.canonical.y)._rotate(this.transform.angle),M=new l.P(E.canonical.x,E.canonical.y)._rotate(this.transform.angle);return y.overscaledZ-E.overscaledZ||M.y-C.y||M.x-C.x})).map((p=>p.tileID.key)):d.map((p=>p.tileID)).sort(Ji).map((p=>p.key))}hasRenderableParent(n){const d=this.findLoadedParent(n,0);return!!d&&this._isIdRenderable(d.tileID.key)}_isIdRenderable(n,d){return this._tiles[n]&&this._tiles[n].hasData()&&!this._coveredTiles[n]&&(d||!this._tiles[n].holdingForFade())}reload(){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(const n in this._tiles)this._tiles[n].state!=="errored"&&this._reloadTile(n,"reloading")}}_reloadTile(n,d){return l._(this,void 0,void 0,(function*(){const p=this._tiles[n];p&&(p.state!=="loading"&&(p.state=d),yield this._loadTile(p,n,d))}))}_tileLoaded(n,d,p){n.timeAdded=S.now(),p==="expired"&&(n.refreshedUponExpiration=!0),this._setTileReloadTimer(d,n),this.getSource().type==="raster-dem"&&n.dem&&this._backfillDEM(n),this._state.initializeTileState(n,this.map?this.map.painter:null),n.aborted||this._source.fire(new l.k("data",{dataType:"source",tile:n,coord:n.tileID}))}_backfillDEM(n){const d=this.getRenderableIds();for(let m=0;m<d.length;m++){const y=d[m];if(n.neighboringTiles&&n.neighboringTiles[y]){const E=this.getTileByID(y);p(n,E),p(E,n)}}function p(m,y){m.needsHillshadePrepare=!0,m.needsTerrainPrepare=!0;let E=y.tileID.canonical.x-m.tileID.canonical.x;const C=y.tileID.canonical.y-m.tileID.canonical.y,M=Math.pow(2,m.tileID.canonical.z),D=y.tileID.key;E===0&&C===0||Math.abs(C)>1||(Math.abs(E)>1&&(Math.abs(E+M)===1?E+=M:Math.abs(E-M)===1&&(E-=M)),y.dem&&m.dem&&(m.dem.backfillBorder(y.dem,E,C),m.neighboringTiles&&m.neighboringTiles[D]&&(m.neighboringTiles[D].backfilled=!0)))}}getTile(n){return this.getTileByID(n.key)}getTileByID(n){return this._tiles[n]}_retainLoadedChildren(n,d,p,m){for(const y in this._tiles){let E=this._tiles[y];if(m[y]||!E.hasData()||E.tileID.overscaledZ<=d||E.tileID.overscaledZ>p)continue;let C=E.tileID;for(;E&&E.tileID.overscaledZ>d+1;){const D=E.tileID.scaledTo(E.tileID.overscaledZ-1);E=this._tiles[D.key],E&&E.hasData()&&(C=D)}let M=C;for(;M.overscaledZ>d;)if(M=M.scaledTo(M.overscaledZ-1),n[M.key]){m[C.key]=C;break}}}findLoadedParent(n,d){if(n.key in this._loadedParentTiles){const p=this._loadedParentTiles[n.key];return p&&p.tileID.overscaledZ>=d?p:null}for(let p=n.overscaledZ-1;p>=d;p--){const m=n.scaledTo(p),y=this._getLoadedTile(m);if(y)return y}}findLoadedSibling(n){return this._getLoadedTile(n)}_getLoadedTile(n){const d=this._tiles[n.key];return d&&d.hasData()?d:this._cache.getByKey(n.wrapped().key)}updateCacheSize(n){const d=Math.ceil(n.width/this._source.tileSize)+1,p=Math.ceil(n.height/this._source.tileSize)+1,m=Math.floor(d*p*(this._maxTileCacheZoomLevels===null?l.a.MAX_TILE_CACHE_ZOOM_LEVELS:this._maxTileCacheZoomLevels)),y=typeof this._maxTileCacheSize=="number"?Math.min(this._maxTileCacheSize,m):m;this._cache.setMaxSize(y)}handleWrapJump(n){const d=Math.round((n-(this._prevLng===void 0?n:this._prevLng))/360);if(this._prevLng=n,d){const p={};for(const m in this._tiles){const y=this._tiles[m];y.tileID=y.tileID.unwrapTo(y.tileID.wrap+d),p[y.tileID.key]=y}this._tiles=p;for(const m in this._timers)clearTimeout(this._timers[m]),delete this._timers[m];for(const m in this._tiles)this._setTileReloadTimer(m,this._tiles[m])}}_updateCoveredAndRetainedTiles(n,d,p,m,y,E){const C={},M={},D=Object.keys(n),N=S.now();for(const z of D){const H=n[z],Y=this._tiles[z];if(!Y||Y.fadeEndTime!==0&&Y.fadeEndTime<=N)continue;const K=this.findLoadedParent(H,d),oe=this.findLoadedSibling(H),he=K||oe||null;he&&(this._addTile(he.tileID),C[he.tileID.key]=he.tileID),M[z]=H}this._retainLoadedChildren(M,m,p,n);for(const z in C)n[z]||(this._coveredTiles[z]=!0,n[z]=C[z]);if(E){const z={},H={};for(const Y of y)this._tiles[Y.key].hasData()?z[Y.key]=Y:H[Y.key]=Y;for(const Y in H){const K=H[Y].children(this._source.maxzoom);this._tiles[K[0].key]&&this._tiles[K[1].key]&&this._tiles[K[2].key]&&this._tiles[K[3].key]&&(z[K[0].key]=n[K[0].key]=K[0],z[K[1].key]=n[K[1].key]=K[1],z[K[2].key]=n[K[2].key]=K[2],z[K[3].key]=n[K[3].key]=K[3],delete H[Y])}for(const Y in H){const K=H[Y],oe=this.findLoadedParent(K,this._source.minzoom),he=this.findLoadedSibling(K),fe=oe||he||null;if(fe){z[fe.tileID.key]=n[fe.tileID.key]=fe.tileID;for(const _e in z)z[_e].isChildOf(fe.tileID)&&delete z[_e]}}for(const Y in this._tiles)z[Y]||(this._coveredTiles[Y]=!0)}}update(n,d){if(!this._sourceLoaded||this._paused)return;let p;this.transform=n,this.terrain=d,this.updateCacheSize(n),this.handleWrapJump(this.transform.center.lng),this._coveredTiles={},this.used||this.usedForTerrain?this._source.tileID?p=n.getVisibleUnwrappedCoordinates(this._source.tileID).map((N=>new l.S(N.canonical.z,N.wrap,N.canonical.z,N.canonical.x,N.canonical.y))):(p=n.coveringTiles({tileSize:this.usedForTerrain?this.tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:!this.usedForTerrain&&this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled,terrain:d}),this._source.hasTile&&(p=p.filter((N=>this._source.hasTile(N))))):p=[];const m=n.coveringZoomLevel(this._source),y=Math.max(m-Nt.maxOverzooming,this._source.minzoom),E=Math.max(m+Nt.maxUnderzooming,this._source.minzoom);if(this.usedForTerrain){const N={};for(const z of p)if(z.canonical.z>this._source.minzoom){const H=z.scaledTo(z.canonical.z-1);N[H.key]=H;const Y=z.scaledTo(Math.max(this._source.minzoom,Math.min(z.canonical.z,5)));N[Y.key]=Y}p=p.concat(Object.values(N))}const C=p.length===0&&!this._updated&&this._didEmitContent;this._updated=!0,C&&this.fire(new l.k("data",{sourceDataType:"idle",dataType:"source",sourceId:this.id}));const M=this._updateRetainedTiles(p,m);Zr(this._source.type)&&this._updateCoveredAndRetainedTiles(M,y,E,m,p,d);for(const N in M)this._tiles[N].clearFadeHold();const D=l.ab(this._tiles,M);for(const N of D){const z=this._tiles[N];z.hasSymbolBuckets&&!z.holdingForFade()?z.setHoldDuration(this.map._fadeDuration):z.hasSymbolBuckets&&!z.symbolFadeFinished()||this._removeTile(N)}this._updateLoadedParentTileCache(),this._updateLoadedSiblingTileCache()}releaseSymbolFadeTiles(){for(const n in this._tiles)this._tiles[n].holdingForFade()&&this._removeTile(n)}_updateRetainedTiles(n,d){var p;const m={},y={},E=Math.max(d-Nt.maxOverzooming,this._source.minzoom),C=Math.max(d+Nt.maxUnderzooming,this._source.minzoom),M={};for(const D of n){const N=this._addTile(D);m[D.key]=D,N.hasData()||d<this._source.maxzoom&&(M[D.key]=D)}this._retainLoadedChildren(M,d,C,m);for(const D of n){let N=this._tiles[D.key];if(N.hasData())continue;if(d+1>this._source.maxzoom){const H=D.children(this._source.maxzoom)[0],Y=this.getTile(H);if(Y&&Y.hasData()){m[H.key]=H;continue}}else{const H=D.children(this._source.maxzoom);if(m[H[0].key]&&m[H[1].key]&&m[H[2].key]&&m[H[3].key])continue}let z=N.wasRequested();for(let H=D.overscaledZ-1;H>=E;--H){const Y=D.scaledTo(H);if(y[Y.key])break;if(y[Y.key]=!0,N=this.getTile(Y),!N&&z&&(N=this._addTile(Y)),N){const K=N.hasData();if((K||!(!((p=this.map)===null||p===void 0)&&p.cancelPendingTileRequestsWhileZooming)||z)&&(m[Y.key]=Y),z=N.wasRequested(),K)break}}}return m}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(const n in this._tiles){const d=[];let p,m=this._tiles[n].tileID;for(;m.overscaledZ>0;){if(m.key in this._loadedParentTiles){p=this._loadedParentTiles[m.key];break}d.push(m.key);const y=m.scaledTo(m.overscaledZ-1);if(p=this._getLoadedTile(y),p)break;m=y}for(const y of d)this._loadedParentTiles[y]=p}}_updateLoadedSiblingTileCache(){this._loadedSiblingTiles={};for(const n in this._tiles){const d=this._tiles[n].tileID,p=this._getLoadedTile(d);this._loadedSiblingTiles[d.key]=p}}_addTile(n){let d=this._tiles[n.key];if(d)return d;d=this._cache.getAndRemove(n),d&&(this._setTileReloadTimer(n.key,d),d.tileID=n,this._state.initializeTileState(d,this.map?this.map.painter:null),this._cacheTimers[n.key]&&(clearTimeout(this._cacheTimers[n.key]),delete this._cacheTimers[n.key],this._setTileReloadTimer(n.key,d)));const p=d;return d||(d=new ys(n,this._source.tileSize*n.overscaleFactor()),this._loadTile(d,n.key,d.state)),d.uses++,this._tiles[n.key]=d,p||this._source.fire(new l.k("dataloading",{tile:d,coord:d.tileID,dataType:"source"})),d}_setTileReloadTimer(n,d){n in this._timers&&(clearTimeout(this._timers[n]),delete this._timers[n]);const p=d.getExpiryTimeout();p&&(this._timers[n]=setTimeout((()=>{this._reloadTile(n,"expired"),delete this._timers[n]}),p))}_removeTile(n){const d=this._tiles[n];d&&(d.uses--,delete this._tiles[n],this._timers[n]&&(clearTimeout(this._timers[n]),delete this._timers[n]),d.uses>0||(d.hasData()&&d.state!=="reloading"?this._cache.add(d.tileID,d,d.getExpiryTimeout()):(d.aborted=!0,this._abortTile(d),this._unloadTile(d))))}_dataHandler(n){const d=n.sourceDataType;n.dataType==="source"&&d==="metadata"&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&n.dataType==="source"&&d==="content"&&(this.reload(),this.transform&&this.update(this.transform,this.terrain),this._didEmitContent=!0)}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(const n in this._tiles)this._removeTile(n);this._cache.reset()}tilesIn(n,d,p){const m=[],y=this.transform;if(!y)return m;const E=p?y.getCameraQueryGeometry(n):n,C=n.map((K=>y.pointCoordinate(K,this.terrain))),M=E.map((K=>y.pointCoordinate(K,this.terrain))),D=this.getIds();let N=1/0,z=1/0,H=-1/0,Y=-1/0;for(const K of M)N=Math.min(N,K.x),z=Math.min(z,K.y),H=Math.max(H,K.x),Y=Math.max(Y,K.y);for(let K=0;K<D.length;K++){const oe=this._tiles[D[K]];if(oe.holdingForFade())continue;const he=oe.tileID,fe=Math.pow(2,y.zoom-oe.tileID.overscaledZ),_e=d*oe.queryPadding*l.X/oe.tileSize/fe,re=[he.getTilePoint(new l.Z(N,z)),he.getTilePoint(new l.Z(H,Y))];if(re[0].x-_e<l.X&&re[0].y-_e<l.X&&re[1].x+_e>=0&&re[1].y+_e>=0){const be=C.map((De=>he.getTilePoint(De))),Se=M.map((De=>he.getTilePoint(De)));m.push({tile:oe,tileID:he,queryGeometry:be,cameraQueryGeometry:Se,scale:fe})}}return m}getVisibleCoordinates(n){const d=this.getRenderableIds(n).map((p=>this._tiles[p].tileID));for(const p of d)p.posMatrix=this.transform.calculatePosMatrix(p.toUnwrapped());return d}hasTransition(){if(this._source.hasTransition())return!0;if(Zr(this._source.type)){const n=S.now();for(const d in this._tiles)if(this._tiles[d].fadeEndTime>=n)return!0}return!1}setFeatureState(n,d,p){this._state.updateState(n=n||"_geojsonTileLayer",d,p)}removeFeatureState(n,d,p){this._state.removeFeatureState(n=n||"_geojsonTileLayer",d,p)}getFeatureState(n,d){return this._state.getState(n=n||"_geojsonTileLayer",d)}setDependencies(n,d,p){const m=this._tiles[n];m&&m.setDependencies(d,p)}reloadTilesForDependencies(n,d){for(const p in this._tiles)this._tiles[p].hasDependency(n,d)&&this._reloadTile(p,"reloading");this._cache.filter((p=>!p.hasDependency(n,d)))}}function Ji(x,n){const d=Math.abs(2*x.wrap)-+(x.wrap<0),p=Math.abs(2*n.wrap)-+(n.wrap<0);return x.overscaledZ-n.overscaledZ||p-d||n.canonical.y-x.canonical.y||n.canonical.x-x.canonical.x}function Zr(x){return x==="raster"||x==="image"||x==="video"}Nt.maxOverzooming=10,Nt.maxUnderzooming=3;class zt{constructor(n,d){this.reset(n,d)}reset(n,d){this.points=n||[],this._distances=[0];for(let p=1;p<this.points.length;p++)this._distances[p]=this._distances[p-1]+this.points[p].dist(this.points[p-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(d||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(n){if(this.points.length===1)return this.points[0];n=l.ac(n,0,1);let d=1,p=this._distances[d];const m=n*this.paddedLength+this.padding;for(;p<m&&d<this._distances.length;)p=this._distances[++d];const y=d-1,E=this._distances[y],C=p-E,M=C>0?(m-E)/C:0;return this.points[y].mult(1-M).add(this.points[d].mult(M))}}function Yr(x,n){let d=!0;return x==="always"||x!=="never"&&n!=="never"||(d=!1),d}class xs{constructor(n,d,p){const m=this.boxCells=[],y=this.circleCells=[];this.xCellCount=Math.ceil(n/p),this.yCellCount=Math.ceil(d/p);for(let E=0;E<this.xCellCount*this.yCellCount;E++)m.push([]),y.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=n,this.height=d,this.xScale=this.xCellCount/n,this.yScale=this.yCellCount/d,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(n,d,p,m,y){this._forEachCell(d,p,m,y,this._insertBoxCell,this.boxUid++),this.boxKeys.push(n),this.bboxes.push(d),this.bboxes.push(p),this.bboxes.push(m),this.bboxes.push(y)}insertCircle(n,d,p,m){this._forEachCell(d-m,p-m,d+m,p+m,this._insertCircleCell,this.circleUid++),this.circleKeys.push(n),this.circles.push(d),this.circles.push(p),this.circles.push(m)}_insertBoxCell(n,d,p,m,y,E){this.boxCells[y].push(E)}_insertCircleCell(n,d,p,m,y,E){this.circleCells[y].push(E)}_query(n,d,p,m,y,E,C){if(p<0||n>this.width||m<0||d>this.height)return[];const M=[];if(n<=0&&d<=0&&this.width<=p&&this.height<=m){if(y)return[{key:null,x1:n,y1:d,x2:p,y2:m}];for(let D=0;D<this.boxKeys.length;D++)M.push({key:this.boxKeys[D],x1:this.bboxes[4*D],y1:this.bboxes[4*D+1],x2:this.bboxes[4*D+2],y2:this.bboxes[4*D+3]});for(let D=0;D<this.circleKeys.length;D++){const N=this.circles[3*D],z=this.circles[3*D+1],H=this.circles[3*D+2];M.push({key:this.circleKeys[D],x1:N-H,y1:z-H,x2:N+H,y2:z+H})}}else this._forEachCell(n,d,p,m,this._queryCell,M,{hitTest:y,overlapMode:E,seenUids:{box:{},circle:{}}},C);return M}query(n,d,p,m){return this._query(n,d,p,m,!1,null)}hitTest(n,d,p,m,y,E){return this._query(n,d,p,m,!0,y,E).length>0}hitTestCircle(n,d,p,m,y){const E=n-p,C=n+p,M=d-p,D=d+p;if(C<0||E>this.width||D<0||M>this.height)return!1;const N=[];return this._forEachCell(E,M,C,D,this._queryCellCircle,N,{hitTest:!0,overlapMode:m,circle:{x:n,y:d,radius:p},seenUids:{box:{},circle:{}}},y),N.length>0}_queryCell(n,d,p,m,y,E,C,M){const{seenUids:D,hitTest:N,overlapMode:z}=C,H=this.boxCells[y];if(H!==null){const K=this.bboxes;for(const oe of H)if(!D.box[oe]){D.box[oe]=!0;const he=4*oe,fe=this.boxKeys[oe];if(n<=K[he+2]&&d<=K[he+3]&&p>=K[he+0]&&m>=K[he+1]&&(!M||M(fe))&&(!N||!Yr(z,fe.overlapMode))&&(E.push({key:fe,x1:K[he],y1:K[he+1],x2:K[he+2],y2:K[he+3]}),N))return!0}}const Y=this.circleCells[y];if(Y!==null){const K=this.circles;for(const oe of Y)if(!D.circle[oe]){D.circle[oe]=!0;const he=3*oe,fe=this.circleKeys[oe];if(this._circleAndRectCollide(K[he],K[he+1],K[he+2],n,d,p,m)&&(!M||M(fe))&&(!N||!Yr(z,fe.overlapMode))){const _e=K[he],re=K[he+1],be=K[he+2];if(E.push({key:fe,x1:_e-be,y1:re-be,x2:_e+be,y2:re+be}),N)return!0}}}return!1}_queryCellCircle(n,d,p,m,y,E,C,M){const{circle:D,seenUids:N,overlapMode:z}=C,H=this.boxCells[y];if(H!==null){const K=this.bboxes;for(const oe of H)if(!N.box[oe]){N.box[oe]=!0;const he=4*oe,fe=this.boxKeys[oe];if(this._circleAndRectCollide(D.x,D.y,D.radius,K[he+0],K[he+1],K[he+2],K[he+3])&&(!M||M(fe))&&!Yr(z,fe.overlapMode))return E.push(!0),!0}}const Y=this.circleCells[y];if(Y!==null){const K=this.circles;for(const oe of Y)if(!N.circle[oe]){N.circle[oe]=!0;const he=3*oe,fe=this.circleKeys[oe];if(this._circlesCollide(K[he],K[he+1],K[he+2],D.x,D.y,D.radius)&&(!M||M(fe))&&!Yr(z,fe.overlapMode))return E.push(!0),!0}}}_forEachCell(n,d,p,m,y,E,C,M){const D=this._convertToXCellCoord(n),N=this._convertToYCellCoord(d),z=this._convertToXCellCoord(p),H=this._convertToYCellCoord(m);for(let Y=D;Y<=z;Y++)for(let K=N;K<=H;K++)if(y.call(this,n,d,p,m,this.xCellCount*K+Y,E,C,M))return}_convertToXCellCoord(n){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(n*this.xScale)))}_convertToYCellCoord(n){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(n*this.yScale)))}_circlesCollide(n,d,p,m,y,E){const C=m-n,M=y-d,D=p+E;return D*D>C*C+M*M}_circleAndRectCollide(n,d,p,m,y,E,C){const M=(E-m)/2,D=Math.abs(n-(m+M));if(D>M+p)return!1;const N=(C-y)/2,z=Math.abs(d-(y+N));if(z>N+p)return!1;if(D<=M||z<=N)return!0;const H=D-M,Y=z-N;return H*H+Y*Y<=p*p}}function Us(x,n,d,p,m){const y=l.H();return n?(l.K(y,y,[1/m,1/m,1]),d||l.ad(y,y,p.angle)):l.L(y,p.labelPlaneMatrix,x),y}function as(x,n,d,p,m){if(n){const y=l.ae(x);return l.K(y,y,[m,m,1]),d||l.ad(y,y,-p.angle),y}return p.glCoordMatrix}function le(x,n,d,p){let m;p?(m=[x,n,p(x,n),1],l.af(m,m,d)):(m=[x,n,0,1],ri(m,m,d));const y=m[3];return{point:new l.P(m[0]/y,m[1]/y),signedDistanceFromCamera:y,isOccluded:!1}}function B(x,n){return .5+x/n*.5}function U(x,n){return x.x>=-n[0]&&x.x<=n[0]&&x.y>=-n[1]&&x.y<=n[1]}function q(x,n,d,p,m,y,E,C,M,D,N,z,H,Y,K){const oe=p?x.textSizeData:x.iconSizeData,he=l.ag(oe,d.transform.zoom),fe=[256/d.width*2+1,256/d.height*2+1],_e=p?x.text.dynamicLayoutVertexArray:x.icon.dynamicLayoutVertexArray;_e.clear();const re=x.lineVertexArray,be=p?x.text.placedSymbolArray:x.icon.placedSymbolArray,Se=d.transform.width/d.transform.height;let De=!1;for(let Xe=0;Xe<be.length;Xe++){const rt=be.get(Xe);if(rt.hidden||rt.writingMode===l.ah.vertical&&!De){Dt(rt.numGlyphs,_e);continue}De=!1;const dt=le(rt.anchorX,rt.anchorY,n,K);if(!U(dt.point,fe)){Dt(rt.numGlyphs,_e);continue}const yt=B(d.transform.cameraToCenterDistance,dt.signedDistanceFromCamera),lt=l.ai(oe,he,rt),at=E?lt/yt:lt*yt,At={getElevation:K,labelPlaneMatrix:m,lineVertexArray:re,pitchWithMap:E,projectionCache:{projections:{},offsets:{},cachedAnchorPoint:void 0,anyProjectionOccluded:!1},projection:D,tileAnchorPoint:new l.P(rt.anchorX,rt.anchorY),unwrappedTileID:N,width:z,height:H,translation:Y},jt=ye(At,rt,at,!1,C,n,y,x.glyphOffsetArray,_e,Se,M);De=jt.useVertical,(jt.notEnoughRoom||De||jt.needsFlipping&&ye(At,rt,at,!0,C,n,y,x.glyphOffsetArray,_e,Se,M).notEnoughRoom)&&Dt(rt.numGlyphs,_e)}p?x.text.dynamicLayoutVertexBuffer.updateData(_e):x.icon.dynamicLayoutVertexBuffer.updateData(_e)}function ee(x,n,d,p,m,y,E,C){const M=y.glyphStartIndex+y.numGlyphs,D=y.lineStartIndex,N=y.lineStartIndex+y.lineLength,z=n.getoffsetX(y.glyphStartIndex),H=n.getoffsetX(M-1),Y=nt(x*z,d,p,m,y.segment,D,N,C,E);if(!Y)return null;const K=nt(x*H,d,p,m,y.segment,D,N,C,E);return K?C.projectionCache.anyProjectionOccluded?null:{first:Y,last:K}:null}function pe(x,n,d,p){return x===l.ah.horizontal&&Math.abs(d.y-n.y)>Math.abs(d.x-n.x)*p?{useVertical:!0}:(x===l.ah.vertical?n.y<d.y:n.x>d.x)?{needsFlipping:!0}:null}function ye(x,n,d,p,m,y,E,C,M,D,N){const z=d/24,H=n.lineOffsetX*z,Y=n.lineOffsetY*z;let K;if(n.numGlyphs>1){const oe=n.glyphStartIndex+n.numGlyphs,he=n.lineStartIndex,fe=n.lineStartIndex+n.lineLength,_e=ee(z,C,H,Y,p,n,N,x);if(!_e)return{notEnoughRoom:!0};const re=le(_e.first.point.x,_e.first.point.y,E,x.getElevation).point,be=le(_e.last.point.x,_e.last.point.y,E,x.getElevation).point;if(m&&!p){const Se=pe(n.writingMode,re,be,D);if(Se)return Se}K=[_e.first];for(let Se=n.glyphStartIndex+1;Se<oe-1;Se++)K.push(nt(z*C.getoffsetX(Se),H,Y,p,n.segment,he,fe,x,N));K.push(_e.last)}else{if(m&&!p){const he=le(x.tileAnchorPoint.x,x.tileAnchorPoint.y,y,x.getElevation).point,fe=n.lineStartIndex+n.segment+1,_e=new l.P(x.lineVertexArray.getx(fe),x.lineVertexArray.gety(fe)),re=le(_e.x,_e.y,y,x.getElevation),be=re.signedDistanceFromCamera>0?re.point:(function(De,Xe,rt,dt,yt,lt){return Te(De,Xe,rt,1,yt,lt)})(x.tileAnchorPoint,_e,he,0,y,x),Se=pe(n.writingMode,he,be,D);if(Se)return Se}const oe=nt(z*C.getoffsetX(n.glyphStartIndex),H,Y,p,n.segment,n.lineStartIndex,n.lineStartIndex+n.lineLength,x,N);if(!oe||x.projectionCache.anyProjectionOccluded)return{notEnoughRoom:!0};K=[oe]}for(const oe of K)l.aj(M,oe.point,oe.angle);return{}}function Te(x,n,d,p,m,y){const E=x.add(x.sub(n)._unit()),C=m!==void 0?le(E.x,E.y,m,y.getElevation).point:ze(E.x,E.y,y).point,M=d.sub(C);return d.add(M._mult(p/M.mag()))}function de(x,n,d){const p=n.projectionCache;if(p.projections[x])return p.projections[x];const m=new l.P(n.lineVertexArray.getx(x),n.lineVertexArray.gety(x)),y=ze(m.x,m.y,n);if(y.signedDistanceFromCamera>0)return p.projections[x]=y.point,p.anyProjectionOccluded=p.anyProjectionOccluded||y.isOccluded,y.point;const E=x-d.direction;return(function(C,M,D,N,z){return Te(C,M,D,N,void 0,z)})(d.distanceFromAnchor===0?n.tileAnchorPoint:new l.P(n.lineVertexArray.getx(E),n.lineVertexArray.gety(E)),m,d.previousVertex,d.absOffsetX-d.distanceFromAnchor+1,n)}function ze(x,n,d){const p=x+d.translation[0],m=n+d.translation[1];let y;return!d.pitchWithMap&&d.projection.useSpecialProjectionForSymbols?(y=d.projection.projectTileCoordinates(p,m,d.unwrappedTileID,d.getElevation),y.point.x=(.5*y.point.x+.5)*d.width,y.point.y=(.5*-y.point.y+.5)*d.height):(y=le(p,m,d.labelPlaneMatrix,d.getElevation),y.isOccluded=!1),y}function qe(x,n,d){return x._unit()._perp()._mult(n*d)}function Ne(x,n,d,p,m,y,E,C,M){if(C.projectionCache.offsets[x])return C.projectionCache.offsets[x];const D=d.add(n);if(x+M.direction<p||x+M.direction>=m)return C.projectionCache.offsets[x]=D,D;const N=de(x+M.direction,C,M),z=qe(N.sub(d),E,M.direction),H=d.add(z),Y=N.add(z);return C.projectionCache.offsets[x]=l.ak(y,D,H,Y)||D,C.projectionCache.offsets[x]}function nt(x,n,d,p,m,y,E,C,M){const D=p?x-n:x+n;let N=D>0?1:-1,z=0;p&&(N*=-1,z=Math.PI),N<0&&(z+=Math.PI);let H,Y=N>0?y+m:y+m+1;C.projectionCache.cachedAnchorPoint?H=C.projectionCache.cachedAnchorPoint:(H=ze(C.tileAnchorPoint.x,C.tileAnchorPoint.y,C).point,C.projectionCache.cachedAnchorPoint=H);let K,oe,he=H,fe=H,_e=0,re=0;const be=Math.abs(D),Se=[];let De;for(;_e+re<=be;){if(Y+=N,Y<y||Y>=E)return null;_e+=re,fe=he,oe=K;const dt={absOffsetX:be,direction:N,distanceFromAnchor:_e,previousVertex:fe};if(he=de(Y,C,dt),d===0)Se.push(fe),De=he.sub(fe);else{let yt;const lt=he.sub(fe);yt=lt.mag()===0?qe(de(Y+N,C,dt).sub(he),d,N):qe(lt,d,N),oe||(oe=fe.add(yt)),K=Ne(Y,yt,he,y,E,oe,d,C,dt),Se.push(oe),De=K.sub(oe)}re=De.mag()}const Xe=De._mult((be-_e)/re)._add(oe||fe),rt=z+Math.atan2(he.y-fe.y,he.x-fe.x);return Se.push(Xe),{point:Xe,angle:M?rt:0,path:Se}}const Rt=new Float32Array([-1/0,-1/0,0,-1/0,-1/0,0,-1/0,-1/0,0,-1/0,-1/0,0]);function Dt(x,n){for(let d=0;d<x;d++){const p=n.length;n.resize(p+4),n.float32.set(Rt,3*p)}}function ri(x,n,d){const p=n[0],m=n[1];return x[0]=d[0]*p+d[4]*m+d[12],x[1]=d[1]*p+d[5]*m+d[13],x[3]=d[3]*p+d[7]*m+d[15],x}const Ht=100;class si{constructor(n,d,p=new xs(n.width+200,n.height+200,25),m=new xs(n.width+200,n.height+200,25)){this.transform=n,this.mapProjection=d,this.grid=p,this.ignoredGrid=m,this.pitchFactor=Math.cos(n._pitch)*n.cameraToCenterDistance,this.screenRightBoundary=n.width+Ht,this.screenBottomBoundary=n.height+Ht,this.gridRightBoundary=n.width+200,this.gridBottomBoundary=n.height+200,this.perspectiveRatioCutoff=.6}placeCollisionBox(n,d,p,m,y,E,C,M,D,N,z){const H=n.anchorPointX+M[0],Y=n.anchorPointY+M[1],K=this.projectAndGetPerspectiveRatio(m,H,Y,y,N),oe=p*K.perspectiveRatio;let he;if(E||C)he=this._projectCollisionBox(n,oe,m,y,E,C,M,K,N,z);else{const Se=K.point.x+(z?z.x*oe:0),De=K.point.y+(z?z.y*oe:0);he={allPointsOccluded:!1,box:[Se+n.x1*oe,De+n.y1*oe,Se+n.x2*oe,De+n.y2*oe]}}const[fe,_e,re,be]=he.box;return this.mapProjection.useSpecialProjectionForSymbols&&(E?he.allPointsOccluded:this.mapProjection.isOccluded(H,Y,y))||K.perspectiveRatio<this.perspectiveRatioCutoff||!this.isInsideGrid(fe,_e,re,be)||d!=="always"&&this.grid.hitTest(fe,_e,re,be,d,D)?{box:[fe,_e,re,be],placeable:!1,offscreen:!1}:{box:[fe,_e,re,be],placeable:!0,offscreen:this.isOffscreen(fe,_e,re,be)}}placeCollisionCircles(n,d,p,m,y,E,C,M,D,N,z,H,Y,K,oe,he){const fe=[],_e=new l.P(d.anchorX,d.anchorY),re=this.getPerspectiveRatio(E,_e.x,_e.y,C,he),be=(z?y/re:y*re)/l.ap,Se={getElevation:he,labelPlaneMatrix:M,lineVertexArray:p,pitchWithMap:z,projectionCache:{projections:{},offsets:{},cachedAnchorPoint:void 0,anyProjectionOccluded:!1},projection:this.mapProjection,tileAnchorPoint:_e,unwrappedTileID:C,width:this.transform.width,height:this.transform.height,translation:oe},De=ee(be,m,d.lineOffsetX*be,d.lineOffsetY*be,!1,d,!1,Se);let Xe=!1,rt=!1,dt=!0;if(De){const yt=.5*Y*re+K,lt=new l.P(-100,-100),at=new l.P(this.screenRightBoundary,this.screenBottomBoundary),At=new zt,jt=De.first,ct=De.last;let gt=[];for(let Xt=jt.path.length-1;Xt>=1;Xt--)gt.push(jt.path[Xt]);for(let Xt=1;Xt<ct.path.length;Xt++)gt.push(ct.path[Xt]);const Ut=2.5*yt;if(D){const Xt=this.projectPathToScreenSpace(gt,Se,D);gt=Xt.some((Qt=>Qt.signedDistanceFromCamera<=0))?[]:Xt.map((Qt=>Qt.point))}let Si=[];if(gt.length>0){const Xt=gt[0].clone(),Qt=gt[0].clone();for(let Ai=1;Ai<gt.length;Ai++)Xt.x=Math.min(Xt.x,gt[Ai].x),Xt.y=Math.min(Xt.y,gt[Ai].y),Qt.x=Math.max(Qt.x,gt[Ai].x),Qt.y=Math.max(Qt.y,gt[Ai].y);Si=Xt.x>=lt.x&&Qt.x<=at.x&&Xt.y>=lt.y&&Qt.y<=at.y?[gt]:Qt.x<lt.x||Xt.x>at.x||Qt.y<lt.y||Xt.y>at.y?[]:l.al([gt],lt.x,lt.y,at.x,at.y)}for(const Xt of Si){At.reset(Xt,.25*yt);let Qt=0;Qt=At.length<=.5*yt?1:Math.ceil(At.paddedLength/Ut)+1;for(let Ai=0;Ai<Qt;Ai++){const gr=Ai/Math.max(Qt-1,1),As=At.lerp(gr),Ei=As.x+Ht,Fr=As.y+Ht;fe.push(Ei,Fr,yt,0);const Ar=Ei-yt,mr=Fr-yt,Er=Ei+yt,Ws=Fr+yt;if(dt=dt&&this.isOffscreen(Ar,mr,Er,Ws),rt=rt||this.isInsideGrid(Ar,mr,Er,Ws),n!=="always"&&this.grid.hitTestCircle(Ei,Fr,yt,n,H)&&(Xe=!0,!N))return{circles:[],offscreen:!1,collisionDetected:Xe}}}}return{circles:!N&&Xe||!rt||re<this.perspectiveRatioCutoff?[]:fe,offscreen:dt,collisionDetected:Xe}}projectPathToScreenSpace(n,d,p){return n.map((m=>le(m.x,m.y,p,d.getElevation)))}queryRenderedSymbols(n){if(n.length===0||this.grid.keysLength()===0&&this.ignoredGrid.keysLength()===0)return{};const d=[];let p=1/0,m=1/0,y=-1/0,E=-1/0;for(const N of n){const z=new l.P(N.x+Ht,N.y+Ht);p=Math.min(p,z.x),m=Math.min(m,z.y),y=Math.max(y,z.x),E=Math.max(E,z.y),d.push(z)}const C=this.grid.query(p,m,y,E).concat(this.ignoredGrid.query(p,m,y,E)),M={},D={};for(const N of C){const z=N.key;if(M[z.bucketInstanceId]===void 0&&(M[z.bucketInstanceId]={}),M[z.bucketInstanceId][z.featureIndex])continue;const H=[new l.P(N.x1,N.y1),new l.P(N.x2,N.y1),new l.P(N.x2,N.y2),new l.P(N.x1,N.y2)];l.am(d,H)&&(M[z.bucketInstanceId][z.featureIndex]=!0,D[z.bucketInstanceId]===void 0&&(D[z.bucketInstanceId]=[]),D[z.bucketInstanceId].push(z.featureIndex))}return D}insertCollisionBox(n,d,p,m,y,E){(p?this.ignoredGrid:this.grid).insert({bucketInstanceId:m,featureIndex:y,collisionGroupID:E,overlapMode:d},n[0],n[1],n[2],n[3])}insertCollisionCircles(n,d,p,m,y,E){const C=p?this.ignoredGrid:this.grid,M={bucketInstanceId:m,featureIndex:y,collisionGroupID:E,overlapMode:d};for(let D=0;D<n.length;D+=4)C.insertCircle(M,n[D],n[D+1],n[D+2])}projectAndGetPerspectiveRatio(n,d,p,m,y){let E;y?(E=[d,p,y(d,p),1],l.af(E,E,n)):(E=[d,p,0,1],ri(E,E,n));const C=E[3];return{point:new l.P((E[0]/C+1)/2*this.transform.width+Ht,(-E[1]/C+1)/2*this.transform.height+Ht),perspectiveRatio:.5+this.transform.cameraToCenterDistance/C*.5,isOccluded:!1,signedDistanceFromCamera:C}}getPerspectiveRatio(n,d,p,m,y){const E=this.mapProjection.useSpecialProjectionForSymbols?this.mapProjection.projectTileCoordinates(d,p,m,y):le(d,p,n,y);return .5+this.transform.cameraToCenterDistance/E.signedDistanceFromCamera*.5}isOffscreen(n,d,p,m){return p<Ht||n>=this.screenRightBoundary||m<Ht||d>this.screenBottomBoundary}isInsideGrid(n,d,p,m){return p>=0&&n<this.gridRightBoundary&&m>=0&&d<this.gridBottomBoundary}getViewportMatrix(){const n=l.an([]);return l.J(n,n,[-100,-100,0]),n}_projectCollisionBox(n,d,p,m,y,E,C,M,D,N){let z=new l.P(1,0),H=new l.P(0,1);const Y=new l.P(n.anchorPointX+C[0],n.anchorPointY+C[1]);if(E&&!y){const dt=this.projectAndGetPerspectiveRatio(p,Y.x+1,Y.y,m,D).point.sub(M.point).unit(),yt=Math.atan(dt.y/dt.x)+(dt.x<0?Math.PI:0),lt=Math.sin(yt),at=Math.cos(yt);z=new l.P(at,lt),H=new l.P(-lt,at)}else if(!E&&y){const dt=-this.transform.angle,yt=Math.sin(dt),lt=Math.cos(dt);z=new l.P(lt,yt),H=new l.P(-yt,lt)}let K=M.point,oe=d;if(y){K=Y;const dt=this.transform.zoom-Math.floor(this.transform.zoom);oe=Math.pow(2,-dt),oe*=this.mapProjection.getPitchedTextCorrection(this.transform,Y,m),N||(oe*=l.ac(.5+M.signedDistanceFromCamera/this.transform.cameraToCenterDistance*.5,0,4))}N&&(K=K.add(z.mult(N.x*oe)).add(H.mult(N.y*oe)));const he=n.x1*oe,fe=n.x2*oe,_e=(he+fe)/2,re=n.y1*oe,be=n.y2*oe,Se=(re+be)/2,De=[{offsetX:he,offsetY:re},{offsetX:_e,offsetY:re},{offsetX:fe,offsetY:re},{offsetX:fe,offsetY:Se},{offsetX:fe,offsetY:be},{offsetX:_e,offsetY:be},{offsetX:he,offsetY:be},{offsetX:he,offsetY:Se}];let Xe=[];for(const{offsetX:dt,offsetY:yt}of De)Xe.push(new l.P(K.x+z.x*dt+H.x*yt,K.y+z.y*dt+H.y*yt));let rt=!1;if(y){const dt=Xe.map((yt=>this.projectAndGetPerspectiveRatio(p,yt.x,yt.y,m,D)));rt=dt.some((yt=>!yt.isOccluded)),Xe=dt.map((yt=>yt.point))}else rt=!0;return{box:l.ao(Xe),allPointsOccluded:!rt}}}function Jt(x,n,d){return n*(l.X/(x.tileSize*Math.pow(2,d-x.tileID.overscaledZ)))}class Xi{constructor(n,d,p,m){this.opacity=n?Math.max(0,Math.min(1,n.opacity+(n.placed?d:-d))):m&&p?1:0,this.placed=p}isHidden(){return this.opacity===0&&!this.placed}}class Bi{constructor(n,d,p,m,y){this.text=new Xi(n?n.text:null,d,p,y),this.icon=new Xi(n?n.icon:null,d,m,y)}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class Zt{constructor(n,d,p){this.text=n,this.icon=d,this.skipFade=p}}class hi{constructor(){this.invProjMatrix=l.H(),this.viewportMatrix=l.H(),this.circles=[]}}class ki{constructor(n,d,p,m,y){this.bucketInstanceId=n,this.featureIndex=d,this.sourceLayerIndex=p,this.bucketIndex=m,this.tileID=y}}class tr{constructor(n){this.crossSourceCollisions=n,this.maxGroupID=0,this.collisionGroups={}}get(n){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[n]){const d=++this.maxGroupID;this.collisionGroups[n]={ID:d,predicate:p=>p.collisionGroupID===d}}return this.collisionGroups[n]}}function lr(x,n,d,p,m){const{horizontalAlign:y,verticalAlign:E}=l.au(x);return new l.P(-(y-.5)*n+p[0]*m,-(E-.5)*d+p[1]*m)}class Sr{constructor(n,d,p,m,y,E){this.transform=n.clone(),this.terrain=p,this.collisionIndex=new si(this.transform,d),this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=m,this.retainedQueryData={},this.collisionGroups=new tr(y),this.collisionCircleArrays={},this.collisionBoxArrays=new Map,this.prevPlacement=E,E&&(E.prevPlacement=void 0),this.placedOrientations={}}_getTerrainElevationFunc(n){const d=this.terrain;return d?(p,m)=>d.getElevation(n,p,m):null}getBucketParts(n,d,p,m){const y=p.getBucket(d),E=p.latestFeatureIndex;if(!y||!E||d.id!==y.layerIds[0])return;const C=p.collisionBoxArray,M=y.layers[0].layout,D=y.layers[0].paint,N=Math.pow(2,this.transform.zoom-p.tileID.overscaledZ),z=p.tileSize/l.X,H=p.tileID.toUnwrapped(),Y=this.transform.calculatePosMatrix(H),K=M.get("text-pitch-alignment")==="map",oe=M.get("text-rotation-alignment")==="map",he=Jt(p,1,this.transform.zoom),fe=this.collisionIndex.mapProjection.translatePosition(this.transform,p,D.get("text-translate"),D.get("text-translate-anchor")),_e=this.collisionIndex.mapProjection.translatePosition(this.transform,p,D.get("icon-translate"),D.get("icon-translate-anchor")),re=Us(Y,K,oe,this.transform,he);let be=null;if(K){const De=as(Y,K,oe,this.transform,he);be=l.L([],this.transform.labelPlaneMatrix,De)}this.retainedQueryData[y.bucketInstanceId]=new ki(y.bucketInstanceId,E,y.sourceLayerIndex,y.index,p.tileID);const Se={bucket:y,layout:M,translationText:fe,translationIcon:_e,posMatrix:Y,unwrappedTileID:H,textLabelPlaneMatrix:re,labelToScreenMatrix:be,scale:N,textPixelRatio:z,holdingForFade:p.holdingForFade(),collisionBoxArray:C,partiallyEvaluatedTextSize:l.ag(y.textSizeData,this.transform.zoom),collisionGroup:this.collisionGroups.get(y.sourceID)};if(m)for(const De of y.sortKeyRanges){const{sortKey:Xe,symbolInstanceStart:rt,symbolInstanceEnd:dt}=De;n.push({sortKey:Xe,symbolInstanceStart:rt,symbolInstanceEnd:dt,parameters:Se})}else n.push({symbolInstanceStart:0,symbolInstanceEnd:y.symbolInstances.length,parameters:Se})}attemptAnchorPlacement(n,d,p,m,y,E,C,M,D,N,z,H,Y,K,oe,he,fe,_e,re){const be=l.aq[n.textAnchor],Se=[n.textOffset0,n.textOffset1],De=lr(be,p,m,Se,y),Xe=this.collisionIndex.placeCollisionBox(d,H,M,D,N,C,E,he,z.predicate,re,De);if((!_e||this.collisionIndex.placeCollisionBox(_e,H,M,D,N,C,E,fe,z.predicate,re,De).placeable)&&Xe.placeable){let rt;if(this.prevPlacement&&this.prevPlacement.variableOffsets[Y.crossTileID]&&this.prevPlacement.placements[Y.crossTileID]&&this.prevPlacement.placements[Y.crossTileID].text&&(rt=this.prevPlacement.variableOffsets[Y.crossTileID].anchor),Y.crossTileID===0)throw new Error("symbolInstance.crossTileID can't be 0");return this.variableOffsets[Y.crossTileID]={textOffset:Se,width:p,height:m,anchor:be,textBoxScale:y,prevAnchor:rt},this.markUsedJustification(K,be,Y,oe),K.allowVerticalPlacement&&(this.markUsedOrientation(K,oe,Y),this.placedOrientations[Y.crossTileID]=oe),{shift:De,placedGlyphBoxes:Xe}}}placeLayerBucketPart(n,d,p){const{bucket:m,layout:y,translationText:E,translationIcon:C,posMatrix:M,unwrappedTileID:D,textLabelPlaneMatrix:N,labelToScreenMatrix:z,textPixelRatio:H,holdingForFade:Y,collisionBoxArray:K,partiallyEvaluatedTextSize:oe,collisionGroup:he}=n.parameters,fe=y.get("text-optional"),_e=y.get("icon-optional"),re=l.ar(y,"text-overlap","text-allow-overlap"),be=re==="always",Se=l.ar(y,"icon-overlap","icon-allow-overlap"),De=Se==="always",Xe=y.get("text-rotation-alignment")==="map",rt=y.get("text-pitch-alignment")==="map",dt=y.get("icon-text-fit")!=="none",yt=y.get("symbol-z-order")==="viewport-y",lt=be&&(De||!m.hasIconData()||_e),at=De&&(be||!m.hasTextData()||fe);!m.collisionArrays&&K&&m.deserializeCollisionBoxes(K);const At=this._getTerrainElevationFunc(this.retainedQueryData[m.bucketInstanceId].tileID),jt=(ct,gt,Ut)=>{var Si,Xt;if(d[ct.crossTileID])return;if(Y)return void(this.placements[ct.crossTileID]=new Zt(!1,!1,!1));let Qt=!1,Ai=!1,gr=!0,As=null,Ei={box:null,placeable:!1,offscreen:null},Fr={placeable:!1},Ar=null,mr=null,Er=null,Ws=0,Io=0,Dl=0;gt.textFeatureIndex?Ws=gt.textFeatureIndex:ct.useRuntimeCollisionCircles&&(Ws=ct.featureIndex),gt.verticalTextFeatureIndex&&(Io=gt.verticalTextFeatureIndex);const Co=gt.textBox;if(Co){const fs=cr=>{let _r=l.ah.horizontal;if(m.allowVerticalPlacement&&!cr&&this.prevPlacement){const ts=this.prevPlacement.placedOrientations[ct.crossTileID];ts&&(this.placedOrientations[ct.crossTileID]=ts,_r=ts,this.markUsedOrientation(m,_r,ct))}return _r},ps=(cr,_r)=>{if(m.allowVerticalPlacement&&ct.numVerticalGlyphVertices>0&&gt.verticalTextBox){for(const ts of m.writingModes)if(ts===l.ah.vertical?(Ei=_r(),Fr=Ei):Ei=cr(),Ei&&Ei.placeable)break}else Ei=cr()},pn=ct.textAnchorOffsetStartIndex,Es=ct.textAnchorOffsetEndIndex;if(Es===pn){const cr=(_r,ts)=>{const ti=this.collisionIndex.placeCollisionBox(_r,re,H,M,D,rt,Xe,E,he.predicate,At);return ti&&ti.placeable&&(this.markUsedOrientation(m,ts,ct),this.placedOrientations[ct.crossTileID]=ts),ti};ps((()=>cr(Co,l.ah.horizontal)),(()=>{const _r=gt.verticalTextBox;return m.allowVerticalPlacement&&ct.numVerticalGlyphVertices>0&&_r?cr(_r,l.ah.vertical):{box:null,offscreen:null}})),fs(Ei&&Ei.placeable)}else{let cr=l.aq[(Xt=(Si=this.prevPlacement)===null||Si===void 0?void 0:Si.variableOffsets[ct.crossTileID])===null||Xt===void 0?void 0:Xt.anchor];const _r=(ti,$n,Po)=>{const Mo=ti.x2-ti.x1,Sd=ti.y2-ti.y1,tg=ct.textBoxScale,Ad=dt&&Se==="never"?$n:null;let gn=null,Ed=re==="never"?1:2,Ll="never";cr&&Ed++;for(let Ta=0;Ta<Ed;Ta++){for(let Fl=pn;Fl<Es;Fl++){const Bl=m.textAnchorOffsets.get(Fl);if(cr&&Bl.textAnchor!==cr)continue;const Ro=this.attemptAnchorPlacement(Bl,ti,Mo,Sd,tg,Xe,rt,H,M,D,he,Ll,ct,m,Po,E,C,Ad,At);if(Ro&&(gn=Ro.placedGlyphBoxes,gn&&gn.placeable))return Qt=!0,As=Ro.shift,gn}cr?cr=null:Ll=re}return p&&!gn&&(gn={box:this.collisionIndex.placeCollisionBox(Co,"always",H,M,D,rt,Xe,E,he.predicate,At,new l.P(0,0)).box,offscreen:!1,placeable:!1}),gn};ps((()=>_r(Co,gt.iconBox,l.ah.horizontal)),(()=>{const ti=gt.verticalTextBox;return m.allowVerticalPlacement&&(!Ei||!Ei.placeable)&&ct.numVerticalGlyphVertices>0&&ti?_r(ti,gt.verticalIconBox,l.ah.vertical):{box:null,occluded:!0,offscreen:null}})),Ei&&(Qt=Ei.placeable,gr=Ei.offscreen);const ts=fs(Ei&&Ei.placeable);if(!Qt&&this.prevPlacement){const ti=this.prevPlacement.variableOffsets[ct.crossTileID];ti&&(this.variableOffsets[ct.crossTileID]=ti,this.markUsedJustification(m,ti.anchor,ct,ts))}}}if(Ar=Ei,Qt=Ar&&Ar.placeable,gr=Ar&&Ar.offscreen,ct.useRuntimeCollisionCircles){const fs=m.text.placedSymbolArray.get(ct.centerJustifiedTextSymbolIndex),ps=l.ai(m.textSizeData,oe,fs),pn=y.get("text-padding");mr=this.collisionIndex.placeCollisionCircles(re,fs,m.lineVertexArray,m.glyphOffsetArray,ps,M,D,N,z,p,rt,he.predicate,ct.collisionCircleDiameter,pn,E,At),mr.circles.length&&mr.collisionDetected&&!p&&l.w("Collisions detected, but collision boxes are not shown"),Qt=be||mr.circles.length>0&&!mr.collisionDetected,gr=gr&&mr.offscreen}if(gt.iconFeatureIndex&&(Dl=gt.iconFeatureIndex),gt.iconBox){const fs=ps=>this.collisionIndex.placeCollisionBox(ps,Se,H,M,D,rt,Xe,C,he.predicate,At,dt&&As?As:void 0);Fr&&Fr.placeable&&gt.verticalIconBox?(Er=fs(gt.verticalIconBox),Ai=Er.placeable):(Er=fs(gt.iconBox),Ai=Er.placeable),gr=gr&&Er.offscreen}const ds=fe||ct.numHorizontalGlyphVertices===0&&ct.numVerticalGlyphVertices===0,Ol=_e||ct.numIconVertices===0;ds||Ol?Ol?ds||(Ai=Ai&&Qt):Qt=Ai&&Qt:Ai=Qt=Ai&&Qt;const Tu=Ai&&Er.placeable;if(Qt&&Ar.placeable&&this.collisionIndex.insertCollisionBox(Ar.box,re,y.get("text-ignore-placement"),m.bucketInstanceId,Fr&&Fr.placeable&&Io?Io:Ws,he.ID),Tu&&this.collisionIndex.insertCollisionBox(Er.box,Se,y.get("icon-ignore-placement"),m.bucketInstanceId,Dl,he.ID),mr&&Qt&&this.collisionIndex.insertCollisionCircles(mr.circles,re,y.get("text-ignore-placement"),m.bucketInstanceId,Ws,he.ID),p&&this.storeCollisionData(m.bucketInstanceId,Ut,gt,Ar,Er,mr),ct.crossTileID===0)throw new Error("symbolInstance.crossTileID can't be 0");if(m.bucketInstanceId===0)throw new Error("bucket.bucketInstanceId can't be 0");this.placements[ct.crossTileID]=new Zt(Qt||lt,Ai||at,gr||m.justReloaded),d[ct.crossTileID]=!0};if(yt){if(n.symbolInstanceStart!==0)throw new Error("bucket.bucketInstanceId should be 0");const ct=m.getSortedSymbolIndexes(this.transform.angle);for(let gt=ct.length-1;gt>=0;--gt){const Ut=ct[gt];jt(m.symbolInstances.get(Ut),m.collisionArrays[Ut],Ut)}}else for(let ct=n.symbolInstanceStart;ct<n.symbolInstanceEnd;ct++)jt(m.symbolInstances.get(ct),m.collisionArrays[ct],ct);if(p&&m.bucketInstanceId in this.collisionCircleArrays){const ct=this.collisionCircleArrays[m.bucketInstanceId];l.as(ct.invProjMatrix,M),ct.viewportMatrix=this.collisionIndex.getViewportMatrix()}m.justReloaded=!1}storeCollisionData(n,d,p,m,y,E){if(p.textBox||p.iconBox){let C,M;this.collisionBoxArrays.has(n)?C=this.collisionBoxArrays.get(n):(C=new Map,this.collisionBoxArrays.set(n,C)),C.has(d)?M=C.get(d):(M={text:null,icon:null},C.set(d,M)),p.textBox&&(M.text=m.box),p.iconBox&&(M.icon=y.box)}if(E){let C=this.collisionCircleArrays[n];C===void 0&&(C=this.collisionCircleArrays[n]=new hi);for(let M=0;M<E.circles.length;M+=4)C.circles.push(E.circles[M+0]),C.circles.push(E.circles[M+1]),C.circles.push(E.circles[M+2]),C.circles.push(E.collisionDetected?1:0)}}markUsedJustification(n,d,p,m){let y;y=m===l.ah.vertical?p.verticalPlacedTextSymbolIndex:{left:p.leftJustifiedTextSymbolIndex,center:p.centerJustifiedTextSymbolIndex,right:p.rightJustifiedTextSymbolIndex}[l.at(d)];const E=[p.leftJustifiedTextSymbolIndex,p.centerJustifiedTextSymbolIndex,p.rightJustifiedTextSymbolIndex,p.verticalPlacedTextSymbolIndex];for(const C of E)C>=0&&(n.text.placedSymbolArray.get(C).crossTileID=y>=0&&C!==y?0:p.crossTileID)}markUsedOrientation(n,d,p){const m=d===l.ah.horizontal||d===l.ah.horizontalOnly?d:0,y=d===l.ah.vertical?d:0,E=[p.leftJustifiedTextSymbolIndex,p.centerJustifiedTextSymbolIndex,p.rightJustifiedTextSymbolIndex];for(const C of E)n.text.placedSymbolArray.get(C).placedOrientation=m;p.verticalPlacedTextSymbolIndex&&(n.text.placedSymbolArray.get(p.verticalPlacedTextSymbolIndex).placedOrientation=y)}commit(n){this.commitTime=n,this.zoomAtLastRecencyCheck=this.transform.zoom;const d=this.prevPlacement;let p=!1;this.prevZoomAdjustment=d?d.zoomAdjustment(this.transform.zoom):0;const m=d?d.symbolFadeChange(n):1,y=d?d.opacities:{},E=d?d.variableOffsets:{},C=d?d.placedOrientations:{};for(const M in this.placements){const D=this.placements[M],N=y[M];N?(this.opacities[M]=new Bi(N,m,D.text,D.icon),p=p||D.text!==N.text.placed||D.icon!==N.icon.placed):(this.opacities[M]=new Bi(null,m,D.text,D.icon,D.skipFade),p=p||D.text||D.icon)}for(const M in y){const D=y[M];if(!this.opacities[M]){const N=new Bi(D,m,!1,!1);N.isHidden()||(this.opacities[M]=N,p=p||D.text.placed||D.icon.placed)}}for(const M in E)this.variableOffsets[M]||!this.opacities[M]||this.opacities[M].isHidden()||(this.variableOffsets[M]=E[M]);for(const M in C)this.placedOrientations[M]||!this.opacities[M]||this.opacities[M].isHidden()||(this.placedOrientations[M]=C[M]);if(d&&d.lastPlacementChangeTime===void 0)throw new Error("Last placement time for previous placement is not defined");p?this.lastPlacementChangeTime=n:typeof this.lastPlacementChangeTime!="number"&&(this.lastPlacementChangeTime=d?d.lastPlacementChangeTime:n)}updateLayerOpacities(n,d){const p={};for(const m of d){const y=m.getBucket(n);y&&m.latestFeatureIndex&&n.id===y.layerIds[0]&&this.updateBucketOpacities(y,m.tileID,p,m.collisionBoxArray)}}updateBucketOpacities(n,d,p,m){n.hasTextData()&&(n.text.opacityVertexArray.clear(),n.text.hasVisibleVertices=!1),n.hasIconData()&&(n.icon.opacityVertexArray.clear(),n.icon.hasVisibleVertices=!1),n.hasIconCollisionBoxData()&&n.iconCollisionBox.collisionVertexArray.clear(),n.hasTextCollisionBoxData()&&n.textCollisionBox.collisionVertexArray.clear();const y=n.layers[0],E=y.layout,C=new Bi(null,0,!1,!1,!0),M=E.get("text-allow-overlap"),D=E.get("icon-allow-overlap"),N=y._unevaluatedLayout.hasValue("text-variable-anchor")||y._unevaluatedLayout.hasValue("text-variable-anchor-offset"),z=E.get("text-rotation-alignment")==="map",H=E.get("text-pitch-alignment")==="map",Y=E.get("icon-text-fit")!=="none",K=new Bi(null,0,M&&(D||!n.hasIconData()||E.get("icon-optional")),D&&(M||!n.hasTextData()||E.get("text-optional")),!0);!n.collisionArrays&&m&&(n.hasIconCollisionBoxData()||n.hasTextCollisionBoxData())&&n.deserializeCollisionBoxes(m);const oe=(fe,_e,re)=>{for(let be=0;be<_e/4;be++)fe.opacityVertexArray.emplaceBack(re);fe.hasVisibleVertices=fe.hasVisibleVertices||re!==oo},he=this.collisionBoxArrays.get(n.bucketInstanceId);for(let fe=0;fe<n.symbolInstances.length;fe++){const _e=n.symbolInstances.get(fe),{numHorizontalGlyphVertices:re,numVerticalGlyphVertices:be,crossTileID:Se}=_e;let De=this.opacities[Se];p[Se]?De=C:De||(De=K,this.opacities[Se]=De),p[Se]=!0;const Xe=_e.numIconVertices>0,rt=this.placedOrientations[_e.crossTileID],dt=rt===l.ah.vertical,yt=rt===l.ah.horizontal||rt===l.ah.horizontalOnly;if(re>0||be>0){const at=Jr(De.text);oe(n.text,re,dt?oo:at),oe(n.text,be,yt?oo:at);const At=De.text.isHidden();[_e.rightJustifiedTextSymbolIndex,_e.centerJustifiedTextSymbolIndex,_e.leftJustifiedTextSymbolIndex].forEach((gt=>{gt>=0&&(n.text.placedSymbolArray.get(gt).hidden=At||dt?1:0)})),_e.verticalPlacedTextSymbolIndex>=0&&(n.text.placedSymbolArray.get(_e.verticalPlacedTextSymbolIndex).hidden=At||yt?1:0);const jt=this.variableOffsets[_e.crossTileID];jt&&this.markUsedJustification(n,jt.anchor,_e,rt);const ct=this.placedOrientations[_e.crossTileID];ct&&(this.markUsedJustification(n,"left",_e,ct),this.markUsedOrientation(n,ct,_e))}if(Xe){const at=Jr(De.icon),At=!(Y&&_e.verticalPlacedIconSymbolIndex&&dt);_e.placedIconSymbolIndex>=0&&(oe(n.icon,_e.numIconVertices,At?at:oo),n.icon.placedSymbolArray.get(_e.placedIconSymbolIndex).hidden=De.icon.isHidden()),_e.verticalPlacedIconSymbolIndex>=0&&(oe(n.icon,_e.numVerticalIconVertices,At?oo:at),n.icon.placedSymbolArray.get(_e.verticalPlacedIconSymbolIndex).hidden=De.icon.isHidden())}const lt=he&&he.has(fe)?he.get(fe):{text:null,icon:null};if(n.hasIconCollisionBoxData()||n.hasTextCollisionBoxData()){const at=n.collisionArrays[fe];if(at){let At=new l.P(0,0);if(at.textBox||at.verticalTextBox){let jt=!0;if(N){const ct=this.variableOffsets[Se];ct?(At=lr(ct.anchor,ct.width,ct.height,ct.textOffset,ct.textBoxScale),z&&At._rotate(H?this.transform.angle:-this.transform.angle)):jt=!1}if(at.textBox||at.verticalTextBox){let ct;at.textBox&&(ct=dt),at.verticalTextBox&&(ct=yt),no(n.textCollisionBox.collisionVertexArray,De.text.placed,!jt||ct,lt.text,At.x,At.y)}}if(at.iconBox||at.verticalIconBox){const jt=!!(!yt&&at.verticalIconBox);let ct;at.iconBox&&(ct=jt),at.verticalIconBox&&(ct=!jt),no(n.iconCollisionBox.collisionVertexArray,De.icon.placed,ct,lt.icon,Y?At.x:0,Y?At.y:0)}}}}if(n.sortFeatures(this.transform.angle),this.retainedQueryData[n.bucketInstanceId]&&(this.retainedQueryData[n.bucketInstanceId].featureSortOrder=n.featureSortOrder),n.hasTextData()&&n.text.opacityVertexBuffer&&n.text.opacityVertexBuffer.updateData(n.text.opacityVertexArray),n.hasIconData()&&n.icon.opacityVertexBuffer&&n.icon.opacityVertexBuffer.updateData(n.icon.opacityVertexArray),n.hasIconCollisionBoxData()&&n.iconCollisionBox.collisionVertexBuffer&&n.iconCollisionBox.collisionVertexBuffer.updateData(n.iconCollisionBox.collisionVertexArray),n.hasTextCollisionBoxData()&&n.textCollisionBox.collisionVertexBuffer&&n.textCollisionBox.collisionVertexBuffer.updateData(n.textCollisionBox.collisionVertexArray),n.text.opacityVertexArray.length!==n.text.layoutVertexArray.length/4)throw new Error(`bucket.text.opacityVertexArray.length (= ${n.text.opacityVertexArray.length}) !== bucket.text.layoutVertexArray.length (= ${n.text.layoutVertexArray.length}) / 4`);if(n.icon.opacityVertexArray.length!==n.icon.layoutVertexArray.length/4)throw new Error(`bucket.icon.opacityVertexArray.length (= ${n.icon.opacityVertexArray.length}) !== bucket.icon.layoutVertexArray.length (= ${n.icon.layoutVertexArray.length}) / 4`);if(n.bucketInstanceId in this.collisionCircleArrays){const fe=this.collisionCircleArrays[n.bucketInstanceId];n.placementInvProjMatrix=fe.invProjMatrix,n.placementViewportMatrix=fe.viewportMatrix,n.collisionCircleArray=fe.circles,delete this.collisionCircleArrays[n.bucketInstanceId]}}symbolFadeChange(n){return this.fadeDuration===0?1:(n-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(n){return Math.max(0,(this.transform.zoom-n)/1.5)}hasTransitions(n){return this.stale||n-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(n,d){const p=this.zoomAtLastRecencyCheck===d?1-this.zoomAdjustment(d):1;return this.zoomAtLastRecencyCheck=d,this.commitTime+this.fadeDuration*p>n}setStale(){this.stale=!0}}function no(x,n,d,p,m,y){p&&p.length!==0||(p=[0,0,0,0]);const E=p[0]-Ht,C=p[1]-Ht,M=p[2]-Ht,D=p[3]-Ht;x.emplaceBack(n?1:0,d?1:0,m||0,y||0,E,C),x.emplaceBack(n?1:0,d?1:0,m||0,y||0,M,C),x.emplaceBack(n?1:0,d?1:0,m||0,y||0,M,D),x.emplaceBack(n?1:0,d?1:0,m||0,y||0,E,D)}const di=Math.pow(2,25),Oc=Math.pow(2,24),Lc=Math.pow(2,17),Gr=Math.pow(2,16),Kr=Math.pow(2,9),Pp=Math.pow(2,8),ls=Math.pow(2,1);function Jr(x){if(x.opacity===0&&!x.placed)return 0;if(x.opacity===1&&x.placed)return 4294967295;const n=x.placed?1:0,d=Math.floor(127*x.opacity);return d*di+n*Oc+d*Lc+n*Gr+d*Kr+n*Pp+d*ls+n}const oo=0;function Rn(){return{isOccluded:(x,n,d)=>!1,getPitchedTextCorrection:(x,n,d)=>1,get useSpecialProjectionForSymbols(){return!1},projectTileCoordinates(x,n,d,p){throw new Error("Not implemented.")},translatePosition:(x,n,d,p)=>(function(m,y,E,C,M=!1){if(!E[0]&&!E[1])return[0,0];const D=M?C==="map"?m.angle:0:C==="viewport"?-m.angle:0;if(D){const N=Math.sin(D),z=Math.cos(D);E=[E[0]*z-E[1]*N,E[0]*N+E[1]*z]}return[M?E[0]:Jt(y,E[0],m.zoom),M?E[1]:Jt(y,E[1],m.zoom)]})(x,n,d,p),getCircleRadiusCorrection:x=>1}}class Zi{constructor(n){this._sortAcrossTiles=n.layout.get("symbol-z-order")!=="viewport-y"&&!n.layout.get("symbol-sort-key").isConstant(),this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs={},this._bucketParts=[]}continuePlacement(n,d,p,m,y){const E=this._bucketParts;for(;this._currentTileIndex<n.length;)if(d.getBucketParts(E,m,n[this._currentTileIndex],this._sortAcrossTiles),this._currentTileIndex++,y())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,E.sort(((C,M)=>C.sortKey-M.sortKey)));this._currentPartIndex<E.length;)if(d.placeLayerBucketPart(E[this._currentPartIndex],this._seenCrossTileIDs,p),this._currentPartIndex++,y())return!0;return!1}}class sa{constructor(n,d,p,m,y,E,C,M){this.placement=new Sr(n,Rn(),d,E,C,M),this._currentPlacementIndex=p.length-1,this._forceFullPlacement=m,this._showCollisionBoxes=y,this._done=!1}isDone(){return this._done}continuePlacement(n,d,p){const m=S.now(),y=()=>!this._forceFullPlacement&&S.now()-m>2;for(;this._currentPlacementIndex>=0;){const E=d[n[this._currentPlacementIndex]],C=this.placement.collisionIndex.transform.zoom;if(E.type==="symbol"&&(!E.minzoom||E.minzoom<=C)&&(!E.maxzoom||E.maxzoom>C)){if(this._inProgressLayer||(this._inProgressLayer=new Zi(E)),this._inProgressLayer.continuePlacement(p[E.source],this.placement,this._showCollisionBoxes,E,y))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(n){return this.placement.commit(n),this.placement}}const vs=512/l.X/2;class Wi{constructor(n,d,p){this.tileID=n,this.bucketInstanceId=p,this._symbolsByKey={};const m=new Map;for(let y=0;y<d.length;y++){const E=d.get(y),C=E.key,M=m.get(C);M?M.push(E):m.set(C,[E])}for(const[y,E]of m){const C={positions:E.map((M=>({x:Math.floor(M.anchorX*vs),y:Math.floor(M.anchorY*vs)}))),crossTileIDs:E.map((M=>M.crossTileID))};if(C.positions.length>128){const M=new l.av(C.positions.length,16,Uint16Array);for(const{x:D,y:N}of C.positions)M.add(D,N);M.finish(),delete C.positions,C.index=M}this._symbolsByKey[y]=C}}getScaledCoordinates(n,d){const{x:p,y:m,z:y}=this.tileID.canonical,{x:E,y:C,z:M}=d.canonical,D=vs/Math.pow(2,M-y),N=(C*l.X+n.anchorY)*D,z=m*l.X*vs;return{x:Math.floor((E*l.X+n.anchorX)*D-p*l.X*vs),y:Math.floor(N-z)}}findMatches(n,d,p){const m=this.tileID.canonical.z<d.canonical.z?1:Math.pow(2,this.tileID.canonical.z-d.canonical.z);for(let y=0;y<n.length;y++){const E=n.get(y);if(E.crossTileID)continue;const C=this._symbolsByKey[E.key];if(!C)continue;const M=this.getScaledCoordinates(E,d);if(C.index){const D=C.index.range(M.x-m,M.y-m,M.x+m,M.y+m).sort();for(const N of D){const z=C.crossTileIDs[N];if(!p[z]){p[z]=!0,E.crossTileID=z;break}}}else if(C.positions)for(let D=0;D<C.positions.length;D++){const N=C.positions[D],z=C.crossTileIDs[D];if(Math.abs(N.x-M.x)<=m&&Math.abs(N.y-M.y)<=m&&!p[z]){p[z]=!0,E.crossTileID=z;break}}}}getCrossTileIDsLists(){return Object.values(this._symbolsByKey).map((({crossTileIDs:n})=>n))}}class il{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class bs{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(n){const d=Math.round((n-this.lng)/360);if(d!==0)for(const p in this.indexes){const m=this.indexes[p],y={};for(const E in m){const C=m[E];C.tileID=C.tileID.unwrapTo(C.tileID.wrap+d),y[C.tileID.key]=C}this.indexes[p]=y}this.lng=n}addBucket(n,d,p){if(this.indexes[n.overscaledZ]&&this.indexes[n.overscaledZ][n.key]){if(this.indexes[n.overscaledZ][n.key].bucketInstanceId===d.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(n.overscaledZ,this.indexes[n.overscaledZ][n.key])}for(let y=0;y<d.symbolInstances.length;y++)d.symbolInstances.get(y).crossTileID=0;this.usedCrossTileIDs[n.overscaledZ]||(this.usedCrossTileIDs[n.overscaledZ]={});const m=this.usedCrossTileIDs[n.overscaledZ];for(const y in this.indexes){const E=this.indexes[y];if(Number(y)>n.overscaledZ)for(const C in E){const M=E[C];M.tileID.isChildOf(n)&&M.findMatches(d.symbolInstances,n,m)}else{const C=E[n.scaledTo(Number(y)).key];C&&C.findMatches(d.symbolInstances,n,m)}}for(let y=0;y<d.symbolInstances.length;y++){const E=d.symbolInstances.get(y);E.crossTileID||(E.crossTileID=p.generate(),m[E.crossTileID]=!0)}return this.indexes[n.overscaledZ]===void 0&&(this.indexes[n.overscaledZ]={}),this.indexes[n.overscaledZ][n.key]=new Wi(n,d.symbolInstances,d.bucketInstanceId),!0}removeBucketCrossTileIDs(n,d){for(const p of d.getCrossTileIDsLists())for(const m of p)delete this.usedCrossTileIDs[n][m]}removeStaleBuckets(n){let d=!1;for(const p in this.indexes){const m=this.indexes[p];for(const y in m)n[m[y].bucketInstanceId]||(this.removeBucketCrossTileIDs(p,m[y]),delete m[y],d=!0)}return d}}class Fc{constructor(){this.layerIndexes={},this.crossTileIDs=new il,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(n,d,p){let m=this.layerIndexes[n.id];m===void 0&&(m=this.layerIndexes[n.id]=new bs);let y=!1;const E={};m.handleWrapJump(p);for(const C of d){const M=C.getBucket(n);M&&n.id===M.layerIds[0]&&(M.bucketInstanceId||(M.bucketInstanceId=++this.maxBucketInstanceId),m.addBucket(C.tileID,M,this.crossTileIDs)&&(y=!0),E[M.bucketInstanceId]=!0)}return m.removeStaleBuckets(E)&&(y=!0),y}pruneUnusedLayers(n){const d={};n.forEach((p=>{d[p]=!0}));for(const p in this.layerIndexes)d[p]||delete this.layerIndexes[p]}}const ws=(x,n)=>l.t(x,n&&n.filter((d=>d.identifier!=="source.canvas"))),Mp=l.aw();class rl extends l.E{constructor(n,d={}){super(),this._rtlPluginLoaded=()=>{for(const p in this.sourceCaches){const m=this.sourceCaches[p].getSource().type;m!=="vector"&&m!=="geojson"||this.sourceCaches[p].reload()}},this.map=n,this.dispatcher=new Et(Kt(),n._getMapId()),this.dispatcher.registerMessageHandler("GG",((p,m)=>this.getGlyphs(p,m))),this.dispatcher.registerMessageHandler("GI",((p,m)=>this.getImages(p,m))),this.imageManager=new Ke,this.imageManager.setEventedParent(this),this.glyphManager=new ge(n._requestManager,d.localIdeographFontFamily),this.lineAtlas=new tt(256,512),this.crossTileSymbolIndex=new Fc,this._spritesImagesIds={},this._layers={},this._order=[],this.sourceCaches={},this.zoomHistory=new l.ax,this._loaded=!1,this._availableImages=[],this._resetUpdates(),this.dispatcher.broadcast("SR",l.ay()),Dr().on(st,this._rtlPluginLoaded),this.on("data",(p=>{if(p.dataType!=="source"||p.sourceDataType!=="metadata")return;const m=this.sourceCaches[p.sourceId];if(!m)return;const y=m.getSource();if(y&&y.vectorLayerIds)for(const E in this._layers){const C=this._layers[E];C.source===y.id&&this._validateLayer(C)}}))}loadURL(n,d={},p){this.fire(new l.k("dataloading",{dataType:"style"})),d.validate=typeof d.validate!="boolean"||d.validate;const m=this.map._requestManager.transformRequest(n,"Style");this._loadStyleRequest=new AbortController;const y=this._loadStyleRequest;l.h(m,this._loadStyleRequest).then((E=>{this._loadStyleRequest=null,this._load(E.data,d,p)})).catch((E=>{this._loadStyleRequest=null,E&&!y.signal.aborted&&this.fire(new l.j(E))}))}loadJSON(n,d={},p){this.fire(new l.k("dataloading",{dataType:"style"})),this._frameRequest=new AbortController,S.frameAsync(this._frameRequest).then((()=>{this._frameRequest=null,d.validate=d.validate!==!1,this._load(n,d,p)})).catch((()=>{}))}loadEmpty(){this.fire(new l.k("dataloading",{dataType:"style"})),this._load(Mp,{validate:!1})}_load(n,d,p){var m;const y=d.transformStyle?d.transformStyle(p,n):n;if(!d.validate||!ws(this,l.u(y))){this._loaded=!0,this.stylesheet=y;for(const E in y.sources)this.addSource(E,y.sources[E],{validate:!1});y.sprite?this._loadSprite(y.sprite):this.imageManager.setLoaded(!0),this.glyphManager.setURL(y.glyphs),this._createLayers(),this.light=new Be(this.stylesheet.light),this.sky=new We(this.stylesheet.sky),this.map.setTerrain((m=this.stylesheet.terrain)!==null&&m!==void 0?m:null),this.fire(new l.k("data",{dataType:"style"})),this.fire(new l.k("style.load"))}}_createLayers(){const n=l.az(this.stylesheet.layers);this.dispatcher.broadcast("SL",n),this._order=n.map((d=>d.id)),this._layers={},this._serializedLayers=null;for(const d of n){const p=l.aA(d);p.setEventedParent(this,{layer:{id:d.id}}),this._layers[d.id]=p}}_loadSprite(n,d=!1,p=void 0){let m;this.imageManager.setLoaded(!1),this._spriteRequest=new AbortController,(function(y,E,C,M){return l._(this,void 0,void 0,(function*(){const D=He(y),N=C>1?"@2x":"",z={},H={};for(const{id:Y,url:K}of D){const oe=E.transformRequest(ht(K,N,".json"),"SpriteJSON");z[Y]=l.h(oe,M);const he=E.transformRequest(ht(K,N,".png"),"SpriteImage");H[Y]=te.getImage(he,M)}return yield Promise.all([...Object.values(z),...Object.values(H)]),(function(Y,K){return l._(this,void 0,void 0,(function*(){const oe={};for(const he in Y){oe[he]={};const fe=S.getImageCanvasContext((yield K[he]).data),_e=(yield Y[he]).data;for(const re in _e){const{width:be,height:Se,x:De,y:Xe,sdf:rt,pixelRatio:dt,stretchX:yt,stretchY:lt,content:at,textFitWidth:At,textFitHeight:jt}=_e[re];oe[he][re]={data:null,pixelRatio:dt,sdf:rt,stretchX:yt,stretchY:lt,content:at,textFitWidth:At,textFitHeight:jt,spriteData:{width:be,height:Se,x:De,y:Xe,context:fe}}}}return oe}))})(z,H)}))})(n,this.map._requestManager,this.map.getPixelRatio(),this._spriteRequest).then((y=>{if(this._spriteRequest=null,y)for(const E in y){this._spritesImagesIds[E]=[];const C=this._spritesImagesIds[E]?this._spritesImagesIds[E].filter((M=>!(M in y))):[];for(const M of C)this.imageManager.removeImage(M),this._changedImages[M]=!0;for(const M in y[E]){const D=E==="default"?M:`${E}:${M}`;this._spritesImagesIds[E].push(D),D in this.imageManager.images?this.imageManager.updateImage(D,y[E][M],!1):this.imageManager.addImage(D,y[E][M]),d&&(this._changedImages[D]=!0)}}})).catch((y=>{this._spriteRequest=null,m=y,this.fire(new l.j(m))})).finally((()=>{this.imageManager.setLoaded(!0),this._availableImages=this.imageManager.listImages(),d&&(this._changed=!0),this.dispatcher.broadcast("SI",this._availableImages),this.fire(new l.k("data",{dataType:"style"})),p&&p(m)}))}_unloadSprite(){for(const n of Object.values(this._spritesImagesIds).flat())this.imageManager.removeImage(n),this._changedImages[n]=!0;this._spritesImagesIds={},this._availableImages=this.imageManager.listImages(),this._changed=!0,this.dispatcher.broadcast("SI",this._availableImages),this.fire(new l.k("data",{dataType:"style"}))}_validateLayer(n){const d=this.sourceCaches[n.source];if(!d)return;const p=n.sourceLayer;if(!p)return;const m=d.getSource();(m.type==="geojson"||m.vectorLayerIds&&m.vectorLayerIds.indexOf(p)===-1)&&this.fire(new l.j(new Error(`Source layer "${p}" does not exist on source "${m.id}" as specified by style layer "${n.id}".`)))}loaded(){if(!this._loaded||Object.keys(this._updatedSources).length)return!1;for(const n in this.sourceCaches)if(!this.sourceCaches[n].loaded())return!1;return!!this.imageManager.isLoaded()}_serializeByIds(n,d=!1){const p=this._serializedAllLayers();if(!n||n.length===0)return Object.values(d?l.aB(p):p);const m=[];for(const y of n)if(p[y]){const E=d?l.aB(p[y]):p[y];m.push(E)}return m}_serializedAllLayers(){let n=this._serializedLayers;if(n)return n;n=this._serializedLayers={};const d=Object.keys(this._layers);for(const p of d){const m=this._layers[p];m.type!=="custom"&&(n[p]=m.serialize())}return n}hasTransitions(){if(this.light&&this.light.hasTransition()||this.sky&&this.sky.hasTransition())return!0;for(const n in this.sourceCaches)if(this.sourceCaches[n].hasTransition())return!0;for(const n in this._layers)if(this._layers[n].hasTransition())return!0;return!1}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading.")}update(n){if(!this._loaded)return;const d=this._changed;if(d){const m=Object.keys(this._updatedLayers),y=Object.keys(this._removedLayers);(m.length||y.length)&&this._updateWorkerLayers(m,y);for(const E in this._updatedSources){const C=this._updatedSources[E];if(C==="reload")this._reloadSource(E);else{if(C!=="clear")throw new Error(`Invalid action ${C}`);this._clearSource(E)}}this._updateTilesForChangedImages(),this._updateTilesForChangedGlyphs();for(const E in this._updatedPaintProps)this._layers[E].updateTransitions(n);this.light.updateTransitions(n),this.sky.updateTransitions(n),this._resetUpdates()}const p={};for(const m in this.sourceCaches){const y=this.sourceCaches[m];p[m]=y.used,y.used=!1}for(const m of this._order){const y=this._layers[m];y.recalculate(n,this._availableImages),!y.isHidden(n.zoom)&&y.source&&(this.sourceCaches[y.source].used=!0)}for(const m in p){const y=this.sourceCaches[m];!!p[m]!=!!y.used&&y.fire(new l.k("data",{sourceDataType:"visibility",dataType:"source",sourceId:m}))}this.light.recalculate(n),this.sky.recalculate(n),this.z=n.zoom,d&&this.fire(new l.k("data",{dataType:"style"}))}_updateTilesForChangedImages(){const n=Object.keys(this._changedImages);if(n.length){for(const d in this.sourceCaches)this.sourceCaches[d].reloadTilesForDependencies(["icons","patterns"],n);this._changedImages={}}}_updateTilesForChangedGlyphs(){if(this._glyphsDidChange){for(const n in this.sourceCaches)this.sourceCaches[n].reloadTilesForDependencies(["glyphs"],[""]);this._glyphsDidChange=!1}}_updateWorkerLayers(n,d){this.dispatcher.broadcast("UL",{layers:this._serializeByIds(n,!1),removedIds:d})}_resetUpdates(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSources={},this._updatedPaintProps={},this._changedImages={},this._glyphsDidChange=!1}setState(n,d={}){var p;this._checkLoaded();const m=this.serialize();if(n=d.transformStyle?d.transformStyle(m,n):n,((p=d.validate)===null||p===void 0||p)&&ws(this,l.u(n)))return!1;(n=l.aB(n)).layers=l.az(n.layers);const y=l.aC(m,n),E=this._getOperationsToPerform(y);if(E.unimplemented.length>0)throw new Error(`Unimplemented: ${E.unimplemented.join(", ")}.`);if(E.operations.length===0)return!1;for(const C of E.operations)C();return this.stylesheet=n,this._serializedLayers=null,!0}_getOperationsToPerform(n){const d=[],p=[];for(const m of n)switch(m.command){case"setCenter":case"setZoom":case"setBearing":case"setPitch":continue;case"addLayer":d.push((()=>this.addLayer.apply(this,m.args)));break;case"removeLayer":d.push((()=>this.removeLayer.apply(this,m.args)));break;case"setPaintProperty":d.push((()=>this.setPaintProperty.apply(this,m.args)));break;case"setLayoutProperty":d.push((()=>this.setLayoutProperty.apply(this,m.args)));break;case"setFilter":d.push((()=>this.setFilter.apply(this,m.args)));break;case"addSource":d.push((()=>this.addSource.apply(this,m.args)));break;case"removeSource":d.push((()=>this.removeSource.apply(this,m.args)));break;case"setLayerZoomRange":d.push((()=>this.setLayerZoomRange.apply(this,m.args)));break;case"setLight":d.push((()=>this.setLight.apply(this,m.args)));break;case"setGeoJSONSourceData":d.push((()=>this.setGeoJSONSourceData.apply(this,m.args)));break;case"setGlyphs":d.push((()=>this.setGlyphs.apply(this,m.args)));break;case"setSprite":d.push((()=>this.setSprite.apply(this,m.args)));break;case"setSky":d.push((()=>this.setSky.apply(this,m.args)));break;case"setTerrain":d.push((()=>this.map.setTerrain.apply(this,m.args)));break;case"setTransition":d.push((()=>{}));break;default:p.push(m.command)}return{operations:d,unimplemented:p}}addImage(n,d){if(this.getImage(n))return this.fire(new l.j(new Error(`An image named "${n}" already exists.`)));this.imageManager.addImage(n,d),this._afterImageUpdated(n)}updateImage(n,d){this.imageManager.updateImage(n,d)}getImage(n){return this.imageManager.getImage(n)}removeImage(n){if(!this.getImage(n))return this.fire(new l.j(new Error(`An image named "${n}" does not exist.`)));this.imageManager.removeImage(n),this._afterImageUpdated(n)}_afterImageUpdated(n){this._availableImages=this.imageManager.listImages(),this._changedImages[n]=!0,this._changed=!0,this.dispatcher.broadcast("SI",this._availableImages),this.fire(new l.k("data",{dataType:"style"}))}listImages(){return this._checkLoaded(),this.imageManager.listImages()}addSource(n,d,p={}){if(this._checkLoaded(),this.sourceCaches[n]!==void 0)throw new Error(`Source "${n}" already exists.`);if(!d.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(d).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(d.type)>=0&&this._validate(l.u.source,`sources.${n}`,d,null,p))return;this.map&&this.map._collectResourceTiming&&(d.collectResourceTiming=!0);const m=this.sourceCaches[n]=new Nt(n,d,this.dispatcher);m.style=this,m.setEventedParent(this,(()=>({isSourceLoaded:m.loaded(),source:m.serialize(),sourceId:n}))),m.onAdd(this.map),this._changed=!0}removeSource(n){if(this._checkLoaded(),this.sourceCaches[n]===void 0)throw new Error("There is no source with this ID");for(const p in this._layers)if(this._layers[p].source===n)return this.fire(new l.j(new Error(`Source "${n}" cannot be removed while layer "${p}" is using it.`)));const d=this.sourceCaches[n];delete this.sourceCaches[n],delete this._updatedSources[n],d.fire(new l.k("data",{sourceDataType:"metadata",dataType:"source",sourceId:n})),d.setEventedParent(null),d.onRemove(this.map),this._changed=!0}setGeoJSONSourceData(n,d){if(this._checkLoaded(),this.sourceCaches[n]===void 0)throw new Error(`There is no source with this ID=${n}`);const p=this.sourceCaches[n].getSource();if(p.type!=="geojson")throw new Error(`geojsonSource.type is ${p.type}, which is !== 'geojson`);p.setData(d),this._changed=!0}getSource(n){return this.sourceCaches[n]&&this.sourceCaches[n].getSource()}addLayer(n,d,p={}){this._checkLoaded();const m=n.id;if(this.getLayer(m))return void this.fire(new l.j(new Error(`Layer "${m}" already exists on this map.`)));let y;if(n.type==="custom"){if(ws(this,l.aD(n)))return;y=l.aA(n)}else{if("source"in n&&typeof n.source=="object"&&(this.addSource(m,n.source),n=l.aB(n),n=l.e(n,{source:m})),this._validate(l.u.layer,`layers.${m}`,n,{arrayIndex:-1},p))return;y=l.aA(n),this._validateLayer(y),y.setEventedParent(this,{layer:{id:m}})}const E=d?this._order.indexOf(d):this._order.length;if(d&&E===-1)this.fire(new l.j(new Error(`Cannot add layer "${m}" before non-existing layer "${d}".`)));else{if(this._order.splice(E,0,m),this._layerOrderChanged=!0,this._layers[m]=y,this._removedLayers[m]&&y.source&&y.type!=="custom"){const C=this._removedLayers[m];delete this._removedLayers[m],C.type!==y.type?this._updatedSources[y.source]="clear":(this._updatedSources[y.source]="reload",this.sourceCaches[y.source].pause())}this._updateLayer(y),y.onAdd&&y.onAdd(this.map)}}moveLayer(n,d){if(this._checkLoaded(),this._changed=!0,!this._layers[n])return void this.fire(new l.j(new Error(`The layer '${n}' does not exist in the map's style and cannot be moved.`)));if(n===d)return;const p=this._order.indexOf(n);this._order.splice(p,1);const m=d?this._order.indexOf(d):this._order.length;d&&m===-1?this.fire(new l.j(new Error(`Cannot move layer "${n}" before non-existing layer "${d}".`))):(this._order.splice(m,0,n),this._layerOrderChanged=!0)}removeLayer(n){this._checkLoaded();const d=this._layers[n];if(!d)return void this.fire(new l.j(new Error(`Cannot remove non-existing layer "${n}".`)));d.setEventedParent(null);const p=this._order.indexOf(n);this._order.splice(p,1),this._layerOrderChanged=!0,this._changed=!0,this._removedLayers[n]=d,delete this._layers[n],this._serializedLayers&&delete this._serializedLayers[n],delete this._updatedLayers[n],delete this._updatedPaintProps[n],d.onRemove&&d.onRemove(this.map)}getLayer(n){return this._layers[n]}getLayersOrder(){return[...this._order]}hasLayer(n){return n in this._layers}setLayerZoomRange(n,d,p){this._checkLoaded();const m=this.getLayer(n);m?m.minzoom===d&&m.maxzoom===p||(d!=null&&(m.minzoom=d),p!=null&&(m.maxzoom=p),this._updateLayer(m)):this.fire(new l.j(new Error(`Cannot set the zoom range of non-existing layer "${n}".`)))}setFilter(n,d,p={}){this._checkLoaded();const m=this.getLayer(n);if(m){if(!l.aE(m.filter,d))return d==null?(m.filter=void 0,void this._updateLayer(m)):void(this._validate(l.u.filter,`layers.${m.id}.filter`,d,null,p)||(m.filter=l.aB(d),this._updateLayer(m)))}else this.fire(new l.j(new Error(`Cannot filter non-existing layer "${n}".`)))}getFilter(n){return l.aB(this.getLayer(n).filter)}setLayoutProperty(n,d,p,m={}){this._checkLoaded();const y=this.getLayer(n);y?l.aE(y.getLayoutProperty(d),p)||(y.setLayoutProperty(d,p,m),this._updateLayer(y)):this.fire(new l.j(new Error(`Cannot style non-existing layer "${n}".`)))}getLayoutProperty(n,d){const p=this.getLayer(n);if(p)return p.getLayoutProperty(d);this.fire(new l.j(new Error(`Cannot get style of non-existing layer "${n}".`)))}setPaintProperty(n,d,p,m={}){this._checkLoaded();const y=this.getLayer(n);y?l.aE(y.getPaintProperty(d),p)||(y.setPaintProperty(d,p,m)&&this._updateLayer(y),this._changed=!0,this._updatedPaintProps[n]=!0,this._serializedLayers=null):this.fire(new l.j(new Error(`Cannot style non-existing layer "${n}".`)))}getPaintProperty(n,d){return this.getLayer(n).getPaintProperty(d)}setFeatureState(n,d){this._checkLoaded();const p=n.source,m=n.sourceLayer,y=this.sourceCaches[p];if(y===void 0)return void this.fire(new l.j(new Error(`The source '${p}' does not exist in the map's style.`)));const E=y.getSource().type;E==="geojson"&&m?this.fire(new l.j(new Error("GeoJSON sources cannot have a sourceLayer parameter."))):E!=="vector"||m?(n.id===void 0&&this.fire(new l.j(new Error("The feature id parameter must be provided."))),y.setFeatureState(m,n.id,d)):this.fire(new l.j(new Error("The sourceLayer parameter must be provided for vector source types.")))}removeFeatureState(n,d){this._checkLoaded();const p=n.source,m=this.sourceCaches[p];if(m===void 0)return void this.fire(new l.j(new Error(`The source '${p}' does not exist in the map's style.`)));const y=m.getSource().type,E=y==="vector"?n.sourceLayer:void 0;y!=="vector"||E?d&&typeof n.id!="string"&&typeof n.id!="number"?this.fire(new l.j(new Error("A feature id is required to remove its specific state property."))):m.removeFeatureState(E,n.id,d):this.fire(new l.j(new Error("The sourceLayer parameter must be provided for vector source types.")))}getFeatureState(n){this._checkLoaded();const d=n.source,p=n.sourceLayer,m=this.sourceCaches[d];if(m!==void 0)return m.getSource().type!=="vector"||p?(n.id===void 0&&this.fire(new l.j(new Error("The feature id parameter must be provided."))),m.getFeatureState(p,n.id)):void this.fire(new l.j(new Error("The sourceLayer parameter must be provided for vector source types.")));this.fire(new l.j(new Error(`The source '${d}' does not exist in the map's style.`)))}getTransition(){return l.e({duration:300,delay:0},this.stylesheet&&this.stylesheet.transition)}serialize(){if(!this._loaded)return;const n=l.aF(this.sourceCaches,(y=>y.serialize())),d=this._serializeByIds(this._order,!0),p=this.map.getTerrain()||void 0,m=this.stylesheet;return l.aG({version:m.version,name:m.name,metadata:m.metadata,light:m.light,sky:m.sky,center:m.center,zoom:m.zoom,bearing:m.bearing,pitch:m.pitch,sprite:m.sprite,glyphs:m.glyphs,transition:m.transition,sources:n,layers:d,terrain:p},(y=>y!==void 0))}_updateLayer(n){this._updatedLayers[n.id]=!0,n.source&&!this._updatedSources[n.source]&&this.sourceCaches[n.source].getSource().type!=="raster"&&(this._updatedSources[n.source]="reload",this.sourceCaches[n.source].pause()),this._serializedLayers=null,this._changed=!0}_flattenAndSortRenderedFeatures(n){const d=E=>this._layers[E].type==="fill-extrusion",p={},m=[];for(let E=this._order.length-1;E>=0;E--){const C=this._order[E];if(d(C)){p[C]=E;for(const M of n){const D=M[C];if(D)for(const N of D)m.push(N)}}}m.sort(((E,C)=>C.intersectionZ-E.intersectionZ));const y=[];for(let E=this._order.length-1;E>=0;E--){const C=this._order[E];if(d(C))for(let M=m.length-1;M>=0;M--){const D=m[M].feature;if(p[D.layer.id]<E)break;y.push(D),m.pop()}else for(const M of n){const D=M[C];if(D)for(const N of D)y.push(N.feature)}}return y}queryRenderedFeatures(n,d,p){d&&d.filter&&this._validate(l.u.filter,"queryRenderedFeatures.filter",d.filter,null,d);const m={};if(d&&d.layers){if(!Array.isArray(d.layers))return this.fire(new l.j(new Error("parameters.layers must be an Array."))),[];for(const C of d.layers){const M=this._layers[C];if(!M)return this.fire(new l.j(new Error(`The layer '${C}' does not exist in the map's style and cannot be queried for features.`))),[];m[M.source]=!0}}const y=[];d.availableImages=this._availableImages;const E=this._serializedAllLayers();for(const C in this.sourceCaches)d.layers&&!m[C]||y.push(Ri(this.sourceCaches[C],this._layers,E,n,d,p));return this.placement&&y.push((function(C,M,D,N,z,H,Y){const K={},oe=H.queryRenderedSymbols(N),he=[];for(const fe of Object.keys(oe).map(Number))he.push(Y[fe]);he.sort(Fi);for(const fe of he){const _e=fe.featureIndex.lookupSymbolFeatures(oe[fe.bucketInstanceId],M,fe.bucketIndex,fe.sourceLayerIndex,z.filter,z.layers,z.availableImages,C);for(const re in _e){const be=K[re]=K[re]||[],Se=_e[re];Se.sort(((De,Xe)=>{const rt=fe.featureSortOrder;if(rt){const dt=rt.indexOf(De.featureIndex);return rt.indexOf(Xe.featureIndex)-dt}return Xe.featureIndex-De.featureIndex}));for(const De of Se)be.push(De)}}for(const fe in K)K[fe].forEach((_e=>{const re=_e.feature,be=D[C[fe].source].getFeatureState(re.layer["source-layer"],re.id);re.source=re.layer.source,re.layer["source-layer"]&&(re.sourceLayer=re.layer["source-layer"]),re.state=be}));return K})(this._layers,E,this.sourceCaches,n,d,this.placement.collisionIndex,this.placement.retainedQueryData)),this._flattenAndSortRenderedFeatures(y)}querySourceFeatures(n,d){d&&d.filter&&this._validate(l.u.filter,"querySourceFeatures.filter",d.filter,null,d);const p=this.sourceCaches[n];return p?(function(m,y){const E=m.getRenderableIds().map((D=>m.getTileByID(D))),C=[],M={};for(let D=0;D<E.length;D++){const N=E[D],z=N.tileID.canonical.key;M[z]||(M[z]=!0,N.querySourceFeatures(C,y))}return C})(p,d):[]}getLight(){return this.light.getLight()}setLight(n,d={}){this._checkLoaded();const p=this.light.getLight();let m=!1;for(const E in n)if(!l.aE(n[E],p[E])){m=!0;break}if(!m)return;const y={now:S.now(),transition:l.e({duration:300,delay:0},this.stylesheet.transition)};this.light.setLight(n,d),this.light.updateTransitions(y)}getSky(){var n;return(n=this.stylesheet)===null||n===void 0?void 0:n.sky}setSky(n,d={}){const p=this.getSky();let m=!1;if(!n&&!p)return;if(n&&!p)m=!0;else if(!n&&p)m=!0;else for(const E in n)if(!l.aE(n[E],p[E])){m=!0;break}if(!m)return;const y={now:S.now(),transition:l.e({duration:300,delay:0},this.stylesheet.transition)};this.stylesheet.sky=n,this.sky.setSky(n,d),this.sky.updateTransitions(y)}_validate(n,d,p,m,y={}){return(!y||y.validate!==!1)&&ws(this,n.call(l.u,l.e({key:d,style:this.serialize(),value:p,styleSpec:l.v},m)))}_remove(n=!0){this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this._loadStyleRequest&&(this._loadStyleRequest.abort(),this._loadStyleRequest=null),this._spriteRequest&&(this._spriteRequest.abort(),this._spriteRequest=null),Dr().off(st,this._rtlPluginLoaded);for(const d in this._layers)this._layers[d].setEventedParent(null);for(const d in this.sourceCaches){const p=this.sourceCaches[d];p.setEventedParent(null),p.onRemove(this.map)}this.imageManager.setEventedParent(null),this.setEventedParent(null),n&&this.dispatcher.broadcast("RM",void 0),this.dispatcher.remove(n)}_clearSource(n){this.sourceCaches[n].clearTiles()}_reloadSource(n){this.sourceCaches[n].resume(),this.sourceCaches[n].reload()}_updateSources(n){for(const d in this.sourceCaches)this.sourceCaches[d].update(n,this.map.terrain)}_generateCollisionBoxes(){for(const n in this.sourceCaches)this._reloadSource(n)}_updatePlacement(n,d,p,m,y=!1){let E=!1,C=!1;const M={};for(const D of this._order){const N=this._layers[D];if(N.type!=="symbol")continue;if(!M[N.source]){const H=this.sourceCaches[N.source];M[N.source]=H.getRenderableIds(!0).map((Y=>H.getTileByID(Y))).sort(((Y,K)=>K.tileID.overscaledZ-Y.tileID.overscaledZ||(Y.tileID.isLessThan(K.tileID)?-1:1)))}const z=this.crossTileSymbolIndex.addLayer(N,M[N.source],n.center.lng);E=E||z}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._order),((y=y||this._layerOrderChanged||p===0)||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(S.now(),n.zoom))&&(this.pauseablePlacement=new sa(n,this.map.terrain,this._order,y,d,p,m,this.placement),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._order,this._layers,M),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(S.now()),C=!0),E&&this.pauseablePlacement.placement.setStale()),C||E)for(const D of this._order){const N=this._layers[D];N.type==="symbol"&&this.placement.updateLayerOpacities(N,M[N.source])}return!this.pauseablePlacement.isDone()||this.placement.hasTransitions(S.now())}_releaseSymbolFadeTiles(){for(const n in this.sourceCaches)this.sourceCaches[n].releaseSymbolFadeTiles()}getImages(n,d){return l._(this,void 0,void 0,(function*(){const p=yield this.imageManager.getImages(d.icons);this._updateTilesForChangedImages();const m=this.sourceCaches[d.source];return m&&m.setDependencies(d.tileID.key,d.type,d.icons),p}))}getGlyphs(n,d){return l._(this,void 0,void 0,(function*(){const p=yield this.glyphManager.getGlyphs(d.stacks),m=this.sourceCaches[d.source];return m&&m.setDependencies(d.tileID.key,d.type,[""]),p}))}getGlyphsUrl(){return this.stylesheet.glyphs||null}setGlyphs(n,d={}){this._checkLoaded(),n&&this._validate(l.u.glyphs,"glyphs",n,null,d)||(this._glyphsDidChange=!0,this.stylesheet.glyphs=n,this.glyphManager.entries={},this.glyphManager.setURL(n))}addSprite(n,d,p={},m){this._checkLoaded();const y=[{id:n,url:d}],E=[...He(this.stylesheet.sprite),...y];this._validate(l.u.sprite,"sprite",E,null,p)||(this.stylesheet.sprite=E,this._loadSprite(y,!0,m))}removeSprite(n){this._checkLoaded();const d=He(this.stylesheet.sprite);if(d.find((p=>p.id===n))){if(this._spritesImagesIds[n])for(const p of this._spritesImagesIds[n])this.imageManager.removeImage(p),this._changedImages[p]=!0;d.splice(d.findIndex((p=>p.id===n)),1),this.stylesheet.sprite=d.length>0?d:void 0,delete this._spritesImagesIds[n],this._availableImages=this.imageManager.listImages(),this._changed=!0,this.dispatcher.broadcast("SI",this._availableImages),this.fire(new l.k("data",{dataType:"style"}))}else this.fire(new l.j(new Error(`Sprite "${n}" doesn't exists on this map.`)))}getSprite(){return He(this.stylesheet.sprite)}setSprite(n,d={},p){this._checkLoaded(),n&&this._validate(l.u.sprite,"sprite",n,null,d)||(this.stylesheet.sprite=n,n?this._loadSprite(n,!0,p):(this._unloadSprite(),p&&p(null)))}}var kn=l.Y([{name:"a_pos",type:"Int16",components:2}]);const dn={prelude:ci(`#ifdef GL_ES
precision mediump float;
#else
#if !defined(lowp)
#define lowp
#endif
#if !defined(mediump)
#define mediump
#endif
#if !defined(highp)
#define highp
#endif
#endif
`,`#ifdef GL_ES
precision highp float;
#else
#if !defined(lowp)
#define lowp
#endif
#if !defined(mediump)
#define mediump
#endif
#if !defined(highp)
#define highp
#endif
#endif
vec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(unpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0
);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (tile_units_to_pixels*pos+offset)/pattern_size;}
#ifdef TERRAIN3D
uniform sampler2D u_terrain;uniform float u_terrain_dim;uniform mat4 u_terrain_matrix;uniform vec4 u_terrain_unpack;uniform float u_terrain_exaggeration;uniform highp sampler2D u_depth;
#endif
const highp vec4 bitSh=vec4(256.*256.*256.,256.*256.,256.,1.);const highp vec4 bitShifts=vec4(1.)/bitSh;highp float unpack(highp vec4 color) {return dot(color,bitShifts);}highp float depthOpacity(vec3 frag) {
#ifdef TERRAIN3D
highp float d=unpack(texture2D(u_depth,frag.xy*0.5+0.5))+0.0001-frag.z;return 1.0-max(0.0,min(1.0,-d*500.0));
#else
return 1.0;
#endif
}float calculate_visibility(vec4 pos) {
#ifdef TERRAIN3D
vec3 frag=pos.xyz/pos.w;highp float d=depthOpacity(frag);if (d > 0.95) return 1.0;return (d+depthOpacity(frag+vec3(0.0,0.01,0.0)))/2.0;
#else
return 1.0;
#endif
}float ele(vec2 pos) {
#ifdef TERRAIN3D
vec4 rgb=(texture2D(u_terrain,pos)*255.0)*u_terrain_unpack;return rgb.r+rgb.g+rgb.b-u_terrain_unpack.a;
#else
return 0.0;
#endif
}float get_elevation(vec2 pos) {
#ifdef TERRAIN3D
vec2 coord=(u_terrain_matrix*vec4(pos,0.0,1.0)).xy*u_terrain_dim+1.0;vec2 f=fract(coord);vec2 c=(floor(coord)+0.5)/(u_terrain_dim+2.0);float d=1.0/(u_terrain_dim+2.0);float tl=ele(c);float tr=ele(c+vec2(d,0.0));float bl=ele(c+vec2(0.0,d));float br=ele(c+vec2(d,d));float elevation=mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);return elevation*u_terrain_exaggeration;
#else
return 0.0;
#endif
}`),background:ci(`uniform vec4 u_color;uniform float u_opacity;void main() {gl_FragColor=u_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,"attribute vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),backgroundPattern:ci(`uniform vec2 u_pattern_tl_a;uniform vec2 u_pattern_br_a;uniform vec2 u_pattern_tl_b;uniform vec2 u_pattern_br_b;uniform vec2 u_texsize;uniform float u_mix;uniform float u_opacity;uniform sampler2D u_image;varying vec2 v_pos_a;varying vec2 v_pos_b;void main() {vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(u_pattern_tl_a/u_texsize,u_pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(u_pattern_tl_b/u_texsize,u_pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);gl_FragColor=mix(color1,color2,u_mix)*u_opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,"uniform mat4 u_matrix;uniform vec2 u_pattern_size_a;uniform vec2 u_pattern_size_b;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_scale_a;uniform float u_scale_b;uniform float u_tile_units_to_pixels;attribute vec2 a_pos;varying vec2 v_pos_a;varying vec2 v_pos_b;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_scale_a*u_pattern_size_a,u_tile_units_to_pixels,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_scale_b*u_pattern_size_b,u_tile_units_to_pixels,a_pos);}"),circle:ci(`varying vec3 v_data;varying float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=v_data.xy;float extrude_length=length(extrude);float antialiased_blur=v_data.z;float opacity_t=smoothstep(0.0,antialiased_blur,extrude_length-1.0);float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(antialiased_blur,0.0,extrude_length-radius/(radius+stroke_width));gl_FragColor=v_visibility*opacity_t*mix(color*opacity,stroke_color*stroke_opacity,color_t);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform bool u_scale_with_map;uniform bool u_pitch_with_map;uniform vec2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;attribute vec2 a_pos;varying vec3 v_data;varying float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
void main(void) {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=vec2(mod(a_pos,2.0)*2.0-1.0);vec2 circle_center=floor(a_pos*0.5);float ele=get_elevation(circle_center);v_visibility=calculate_visibility(u_matrix*vec4(circle_center,ele,1.0));if (u_pitch_with_map) {vec2 corner_position=circle_center;if (u_scale_with_map) {corner_position+=extrude*(radius+stroke_width)*u_extrude_scale;} else {vec4 projected_center=u_matrix*vec4(circle_center,0,1);corner_position+=extrude*(radius+stroke_width)*u_extrude_scale*(projected_center.w/u_camera_to_center_distance);}gl_Position=u_matrix*vec4(corner_position,ele,1);} else {gl_Position=u_matrix*vec4(circle_center,ele,1);if (u_scale_with_map) {gl_Position.xy+=extrude*(radius+stroke_width)*u_extrude_scale*u_camera_to_center_distance;} else {gl_Position.xy+=extrude*(radius+stroke_width)*u_extrude_scale*gl_Position.w;}}float antialiasblur=-max(1.0/u_device_pixel_ratio/(radius+stroke_width),blur);v_data=vec3(extrude.x,extrude.y,antialiasblur);}`),clippingMask:ci("void main() {gl_FragColor=vec4(1.0);}","attribute vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),heatmap:ci(`uniform highp float u_intensity;varying vec2 v_extrude;
#pragma mapbox: define highp float weight
#define GAUSS_COEF 0.3989422804014327
void main() {
#pragma mapbox: initialize highp float weight
float d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);gl_FragColor=vec4(val,1.0,1.0,1.0);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;attribute vec2 a_pos;varying vec2 v_extrude;
#pragma mapbox: define highp float weight
#pragma mapbox: define mediump float radius
const highp float ZERO=1.0/255.0/16.0;
#define GAUSS_COEF 0.3989422804014327
void main(void) {
#pragma mapbox: initialize highp float weight
#pragma mapbox: initialize mediump float radius
vec2 unscaled_extrude=vec2(mod(a_pos,2.0)*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec4 pos=vec4(floor(a_pos*0.5)+extrude,get_elevation(floor(a_pos*0.5)),1);gl_Position=u_matrix*pos;}`),heatmapTexture:ci(`uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;varying vec2 v_pos;void main() {float t=texture2D(u_image,v_pos).r;vec4 color=texture2D(u_color_ramp,vec2(t,0.5));gl_FragColor=color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(0.0);
#endif
}`,"uniform mat4 u_matrix;uniform vec2 u_world;attribute vec2 a_pos;varying vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos*u_world,0,1);v_pos.x=a_pos.x;v_pos.y=1.0-a_pos.y;}"),collisionBox:ci("varying float v_placed;varying float v_notUsed;void main() {float alpha=0.5;gl_FragColor=vec4(1.0,0.0,0.0,1.0)*alpha;if (v_placed > 0.5) {gl_FragColor=vec4(0.0,0.0,1.0,0.5)*alpha;}if (v_notUsed > 0.5) {gl_FragColor*=.1;}}","attribute vec2 a_anchor_pos;attribute vec2 a_placed;attribute vec2 a_box_real;uniform mat4 u_matrix;uniform vec2 u_pixel_extrude_scale;varying float v_placed;varying float v_notUsed;vec4 projectTileWithElevation(vec2 posInTile,float elevation) {return u_matrix*vec4(posInTile,elevation,1.0);}void main() {gl_Position=projectTileWithElevation(a_anchor_pos,get_elevation(a_anchor_pos));gl_Position.xy=((a_box_real+0.5)*u_pixel_extrude_scale*2.0-1.0)*vec2(1.0,-1.0)*gl_Position.w;if (gl_Position.z/gl_Position.w < 1.1) {gl_Position.z=0.5;}v_placed=a_placed.x;v_notUsed=a_placed.y;}"),collisionCircle:ci("varying float v_radius;varying vec2 v_extrude;varying float v_perspective_ratio;varying float v_collision;void main() {float alpha=0.5*min(v_perspective_ratio,1.0);float stroke_radius=0.9*max(v_perspective_ratio,1.0);float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);gl_FragColor=color*alpha*opacity_t;}","attribute vec2 a_pos;attribute float a_radius;attribute vec2 a_flags;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform vec2 u_viewport_size;uniform float u_camera_to_center_distance;varying float v_radius;varying vec2 v_extrude;varying float v_perspective_ratio;varying float v_collision;vec3 toTilePosition(vec2 screenPos) {vec4 rayStart=u_inv_matrix*vec4(screenPos,-1.0,1.0);vec4 rayEnd  =u_inv_matrix*vec4(screenPos, 1.0,1.0);rayStart.xyz/=rayStart.w;rayEnd.xyz  /=rayEnd.w;highp float t=(0.0-rayStart.z)/(rayEnd.z-rayStart.z);return mix(rayStart.xyz,rayEnd.xyz,t);}void main() {vec2 quadCenterPos=a_pos;float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(mix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;vec3 tilePos=toTilePosition(quadCenterPos);vec4 clipPos=u_matrix*vec4(tilePos,1.0);highp float camera_to_anchor_distance=clipPos.w;highp float collision_perspective_ratio=clamp(0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_perspective_ratio=collision_perspective_ratio;v_collision=collision;gl_Position=vec4(clipPos.xyz/clipPos.w,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}"),debug:ci("uniform highp vec4 u_color;uniform sampler2D u_overlay;varying vec2 v_uv;void main() {vec4 overlay_color=texture2D(u_overlay,v_uv);gl_FragColor=mix(u_color,overlay_color,overlay_color.a);}","attribute vec2 a_pos;varying vec2 v_uv;uniform mat4 u_matrix;uniform float u_overlay_scale;void main() {v_uv=a_pos/8192.0;gl_Position=u_matrix*vec4(a_pos*u_overlay_scale,get_elevation(a_pos),1);}"),fill:ci(`#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
gl_FragColor=color*opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec2 a_pos;uniform mat4 u_matrix;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
gl_Position=u_matrix*vec4(a_pos,0,1);}`),fillOutline:ci(`varying vec2 v_pos;
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);gl_FragColor=outline_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec2 a_pos;uniform mat4 u_matrix;uniform vec2 u_world;varying vec2 v_pos;
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;}`),fillOutlinePattern:ci(`uniform vec2 u_texsize;uniform sampler2D u_image;uniform float u_fade;varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec2 v_pos;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);gl_FragColor=mix(color1,color2,u_fade)*alpha*opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec3 u_scale;attribute vec2 a_pos;varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec2 v_pos;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;gl_Position=u_matrix*vec4(a_pos,0,1);vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileRatio,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileRatio,a_pos);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;}`),fillPattern:ci(`#ifdef GL_ES
precision highp float;
#endif
uniform vec2 u_texsize;uniform float u_fade;uniform sampler2D u_image;varying vec2 v_pos_a;varying vec2 v_pos_b;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);gl_FragColor=mix(color1,color2,u_fade)*opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec3 u_scale;attribute vec2 a_pos;varying vec2 v_pos_a;varying vec2 v_pos_b;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;gl_Position=u_matrix*vec4(a_pos,0,1);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileZoomRatio,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileZoomRatio,a_pos);}`),fillExtrusion:ci(`varying vec4 v_color;void main() {gl_FragColor=v_color;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;attribute vec2 a_pos;attribute vec4 a_normal_ed;
#ifdef TERRAIN3D
attribute vec2 a_centroid;
#endif
varying vec4 v_color;
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
vec3 normal=a_normal_ed.xyz;
#ifdef TERRAIN3D
float height_terrain3d_offset=get_elevation(a_centroid);float base_terrain3d_offset=height_terrain3d_offset-(base > 0.0 ? 0.0 : 10.0);
#else
float height_terrain3d_offset=0.0;float base_terrain3d_offset=0.0;
#endif
base=max(0.0,base)+base_terrain3d_offset;height=max(0.0,height)+height_terrain3d_offset;float t=mod(normal.x,2.0);gl_Position=u_matrix*vec4(a_pos,t > 0.0 ? height : base,1);float colorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;v_color=vec4(0.0,0.0,0.0,1.0);vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;float directional=clamp(dot(normal/16384.0,u_lightpos),0.0,1.0);directional=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),directional);if (normal.y !=0.0) {directional*=((1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),mix(0.7,0.98,1.0-u_lightintensity),1.0)));}v_color.r+=clamp(color.r*directional*u_lightcolor.r,mix(0.0,0.3,1.0-u_lightcolor.r),1.0);v_color.g+=clamp(color.g*directional*u_lightcolor.g,mix(0.0,0.3,1.0-u_lightcolor.g),1.0);v_color.b+=clamp(color.b*directional*u_lightcolor.b,mix(0.0,0.3,1.0-u_lightcolor.b),1.0);v_color*=u_opacity;}`),fillExtrusionPattern:ci(`uniform vec2 u_texsize;uniform float u_fade;uniform sampler2D u_image;varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec4 v_lighting;
#pragma mapbox: define lowp float base
#pragma mapbox: define lowp float height
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float base
#pragma mapbox: initialize lowp float height
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);vec4 mixedColor=mix(color1,color2,u_fade);gl_FragColor=mixedColor*v_lighting;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform vec3 u_scale;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;attribute vec2 a_pos;attribute vec4 a_normal_ed;
#ifdef TERRAIN3D
attribute vec2 a_centroid;
#endif
varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec4 v_lighting;
#pragma mapbox: define lowp float base
#pragma mapbox: define lowp float height
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float base
#pragma mapbox: initialize lowp float height
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec3 normal=a_normal_ed.xyz;float edgedistance=a_normal_ed.w;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;
#ifdef TERRAIN3D
float height_terrain3d_offset=get_elevation(a_centroid);float base_terrain3d_offset=height_terrain3d_offset-(base > 0.0 ? 0.0 : 10.0);
#else
float height_terrain3d_offset=0.0;float base_terrain3d_offset=0.0;
#endif
base=max(0.0,base)+base_terrain3d_offset;height=max(0.0,height)+height_terrain3d_offset;float t=mod(normal.x,2.0);float z=t > 0.0 ? height : base;gl_Position=u_matrix*vec4(a_pos,z,1);vec2 pos=normal.x==1.0 && normal.y==0.0 && normal.z==16384.0
? a_pos
: vec2(edgedistance,z*u_height_factor);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileRatio,pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileRatio,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float directional=clamp(dot(normal/16383.0,u_lightpos),0.0,1.0);directional=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),directional);if (normal.y !=0.0) {directional*=((1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),mix(0.7,0.98,1.0-u_lightintensity),1.0)));}v_lighting.rgb+=clamp(directional*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;}`),hillshadePrepare:ci(`#ifdef GL_ES
precision highp float;
#endif
uniform sampler2D u_image;varying vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;uniform vec4 u_unpack;float getElevation(vec2 coord,float bias) {vec4 data=texture2D(u_image,coord)*255.0;data.a=-1.0;return dot(data,u_unpack)/4.0;}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y),0.0);float b=getElevation(v_pos+vec2(0,-epsilon.y),0.0);float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y),0.0);float d=getElevation(v_pos+vec2(-epsilon.x,0),0.0);float e=getElevation(v_pos,0.0);float f=getElevation(v_pos+vec2(epsilon.x,0),0.0);float g=getElevation(v_pos+vec2(-epsilon.x,epsilon.y),0.0);float h=getElevation(v_pos+vec2(0,epsilon.y),0.0);float i=getElevation(v_pos+vec2(epsilon.x,epsilon.y),0.0);float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2((c+f+f+i)-(a+d+d+g),(g+h+h+i)-(a+b+b+c))/pow(2.0,exaggeration+(19.2562-u_zoom));gl_FragColor=clamp(vec4(deriv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,"uniform mat4 u_matrix;uniform vec2 u_dimension;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:ci(`uniform sampler2D u_image;varying vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;
#define PI 3.141592653589793
void main() {vec4 pixel=texture2D(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);gl_FragColor=accent_color*(1.0-shade_color.a)+shade_color;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,"uniform mat4 u_matrix;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=a_texture_pos/8192.0;}"),line:ci(`uniform lowp float u_device_pixel_ratio;varying vec2 v_width2;varying vec2 v_normal;varying float v_gamma_scale;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);gl_FragColor=color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
attribute vec2 a_pos_normal;attribute vec4 a_data;uniform mat4 u_matrix;uniform mediump float u_ratio;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;varying vec2 v_normal;varying vec2 v_width2;varying float v_gamma_scale;varying highp float v_linesofar;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;v_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*2.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist/u_ratio,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2/u_ratio,0.0,1.0)+projected_extrude;
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
v_width2=vec2(outset,inset);}`),lineGradient:ci(`uniform lowp float u_device_pixel_ratio;uniform sampler2D u_image;varying vec2 v_width2;varying vec2 v_normal;varying float v_gamma_scale;varying highp vec2 v_uv;
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);vec4 color=texture2D(u_image,v_uv);gl_FragColor=color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
attribute vec2 a_pos_normal;attribute vec4 a_data;attribute float a_uv_x;attribute float a_split_index;uniform mat4 u_matrix;uniform mediump float u_ratio;uniform lowp float u_device_pixel_ratio;uniform vec2 u_units_to_pixels;uniform float u_image_height;varying vec2 v_normal;varying vec2 v_width2;varying float v_gamma_scale;varying highp vec2 v_uv;
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;highp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec2(a_uv_x,a_split_index*texel_height-half_texel_height);vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist/u_ratio,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2/u_ratio,0.0,1.0)+projected_extrude;
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
v_width2=vec2(outset,inset);}`),linePattern:ci(`#ifdef GL_ES
precision highp float;
#endif
uniform lowp float u_device_pixel_ratio;uniform vec2 u_texsize;uniform float u_fade;uniform mediump vec3 u_scale;uniform sampler2D u_image;varying vec2 v_normal;varying vec2 v_width2;varying float v_linesofar;varying float v_gamma_scale;varying float v_width;
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;vec2 pattern_size_a=vec2(display_size_a.x*fromScale/tileZoomRatio,display_size_a.y);vec2 pattern_size_b=vec2(display_size_b.x*toScale/tileZoomRatio,display_size_b.y);float aspect_a=display_size_a.y/v_width;float aspect_b=display_size_b.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);float x_a=mod(v_linesofar/pattern_size_a.x*aspect_a,1.0);float x_b=mod(v_linesofar/pattern_size_b.x*aspect_b,1.0);float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;vec2 pos_a=mix(pattern_tl_a*texel_size-texel_size,pattern_br_a*texel_size+texel_size,vec2(x_a,y));vec2 pos_b=mix(pattern_tl_b*texel_size-texel_size,pattern_br_b*texel_size+texel_size,vec2(x_b,y));vec4 color=mix(texture2D(u_image,pos_a),texture2D(u_image,pos_b),u_fade);gl_FragColor=color*alpha*opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
#define LINE_DISTANCE_SCALE 2.0
attribute vec2 a_pos_normal;attribute vec4 a_data;uniform mat4 u_matrix;uniform vec2 u_units_to_pixels;uniform mediump float u_ratio;uniform lowp float u_device_pixel_ratio;varying vec2 v_normal;varying vec2 v_width2;varying float v_linesofar;varying float v_gamma_scale;varying float v_width;
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;float a_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*LINE_DISTANCE_SCALE;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist/u_ratio,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2/u_ratio,0.0,1.0)+projected_extrude;
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
v_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=floorwidth;}`),lineSDF:ci(`uniform lowp float u_device_pixel_ratio;uniform sampler2D u_image;uniform float u_sdfgamma;uniform float u_mix;varying vec2 v_normal;varying vec2 v_width2;varying vec2 v_tex_a;varying vec2 v_tex_b;varying float v_gamma_scale;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);float sdfdist_a=texture2D(u_image,v_tex_a).a;float sdfdist_b=texture2D(u_image,v_tex_b).a;float sdfdist=mix(sdfdist_a,sdfdist_b,u_mix);alpha*=smoothstep(0.5-u_sdfgamma/floorwidth,0.5+u_sdfgamma/floorwidth,sdfdist);gl_FragColor=color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
#define LINE_DISTANCE_SCALE 2.0
attribute vec2 a_pos_normal;attribute vec4 a_data;uniform mat4 u_matrix;uniform mediump float u_ratio;uniform lowp float u_device_pixel_ratio;uniform vec2 u_patternscale_a;uniform float u_tex_y_a;uniform vec2 u_patternscale_b;uniform float u_tex_y_b;uniform vec2 u_units_to_pixels;varying vec2 v_normal;varying vec2 v_width2;varying vec2 v_tex_a;varying vec2 v_tex_b;varying float v_gamma_scale;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;float a_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*LINE_DISTANCE_SCALE;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist/u_ratio,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2/u_ratio,0.0,1.0)+projected_extrude;
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
v_tex_a=vec2(a_linesofar*u_patternscale_a.x/floorwidth,normal.y*u_patternscale_a.y+u_tex_y_a);v_tex_b=vec2(a_linesofar*u_patternscale_b.x/floorwidth,normal.y*u_patternscale_b.y+u_tex_y_b);v_width2=vec2(outset,inset);}`),raster:ci(`uniform float u_fade_t;uniform float u_opacity;uniform sampler2D u_image0;uniform sampler2D u_image1;varying vec2 v_pos0;varying vec2 v_pos1;uniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;void main() {vec4 color0=texture2D(u_image0,v_pos0);vec4 color1=texture2D(u_image1,v_pos1);if (color0.a > 0.0) {color0.rgb=color0.rgb/color0.a;}if (color1.a > 0.0) {color1.rgb=color1.rgb/color1.a;}vec4 color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 rgb=color.rgb;rgb=vec3(dot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);gl_FragColor=vec4(mix(u_high_vec,u_low_vec,rgb)*color.a,color.a);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,"uniform mat4 u_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform float u_buffer_scale;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos0;varying vec2 v_pos1;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos0=(((a_texture_pos/8192.0)-0.5)/u_buffer_scale )+0.5;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;}"),symbolIcon:ci(`uniform sampler2D u_texture;varying vec2 v_tex;varying float v_fade_opacity;
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize lowp float opacity
lowp float alpha=opacity*v_fade_opacity;gl_FragColor=texture2D(u_texture,v_tex)*alpha;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec4 a_pos_offset;attribute vec4 a_data;attribute vec4 a_pixeloffset;attribute vec3 a_projected_pos;attribute float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform highp float u_camera_to_center_distance;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform float u_fade_change;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform vec2 u_texsize;uniform bool u_is_along_line;uniform bool u_is_variable_anchor;uniform vec2 u_translation;uniform float u_pitched_scale;varying vec2 v_tex;varying float v_fade_opacity;vec4 projectTileWithElevation(vec2 posInTile,float elevation) {return u_matrix*vec4(posInTile,elevation,1.0);}
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize lowp float opacity
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_minFontScale=a_pixeloffset.zw/256.0;float ele=get_elevation(a_pos);highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 translated_a_pos=a_pos+u_translation;vec4 projectedPoint=projectTileWithElevation(translated_a_pos,ele);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=projectTileWithElevation(translated_a_pos+vec2(1,0),ele);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);vec4 projected_pos;if (u_is_along_line || u_is_variable_anchor) {projected_pos=vec4(a_projected_pos.xy,ele,1.0);} else if (u_pitch_with_map) {projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy+u_translation,ele,1.0);} else {projected_pos=u_label_plane_matrix*projectTileWithElevation(a_projected_pos.xy+u_translation,ele);}float z=float(u_pitch_with_map)*projected_pos.z/projected_pos.w;float projectionScaling=1.0;vec4 finalPos=u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+rotation_matrix*(a_offset/32.0*max(a_minFontScale,fontScale)+a_pxoffset/16.0)*projectionScaling,z,1.0);if(u_pitch_with_map) {finalPos=projectTileWithElevation(finalPos.xy,finalPos.z);}gl_Position=finalPos;v_tex=a_tex/u_texsize;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float visibility=calculate_visibility(projectedPoint);v_fade_opacity=max(0.0,min(visibility,fade_opacity[0]+fade_change));}`),symbolSDF:ci(`#define SDF_PX 8.0
uniform bool u_is_halo;uniform sampler2D u_texture;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;varying vec2 v_data0;varying vec3 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
float EDGE_GAMMA=0.105/u_device_pixel_ratio;vec2 tex=v_data0.xy;float gamma_scale=v_data1.x;float size=v_data1.y;float fade_opacity=v_data1[2];float fontScale=u_is_text ? size/24.0 : size;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float inner_edge=(256.0-64.0)/256.0;if (u_is_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);inner_edge=inner_edge+gamma*gamma_scale;}lowp float dist=texture2D(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(inner_edge-gamma_scaled,inner_edge+gamma_scaled,dist);if (u_is_halo) {lowp float halo_edge=(6.0-halo_width/fontScale)/SDF_PX;alpha=min(smoothstep(halo_edge-gamma_scaled,halo_edge+gamma_scaled,dist),1.0-alpha);}gl_FragColor=color*(alpha*opacity*fade_opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec4 a_pos_offset;attribute vec4 a_data;attribute vec4 a_pixeloffset;attribute vec3 a_projected_pos;attribute float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform bool u_is_along_line;uniform bool u_is_variable_anchor;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec2 u_translation;uniform float u_pitched_scale;varying vec2 v_data0;varying vec3 v_data1;vec4 projectTileWithElevation(vec2 posInTile,float elevation) {return u_matrix*vec4(posInTile,elevation,1.0);}
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;float ele=get_elevation(a_pos);highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 translated_a_pos=a_pos+u_translation;vec4 projectedPoint=projectTileWithElevation(translated_a_pos,ele);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=projectTileWithElevation(translated_a_pos+vec2(1,0),ele);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);vec4 projected_pos;if (u_is_along_line || u_is_variable_anchor) {projected_pos=vec4(a_projected_pos.xy,ele,1.0);} else if (u_pitch_with_map) {projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy+u_translation,ele,1.0);} else {projected_pos=u_label_plane_matrix*projectTileWithElevation(a_projected_pos.xy+u_translation,ele);}float z=float(u_pitch_with_map)*projected_pos.z/projected_pos.w;float projectionScaling=1.0;vec4 finalPos=u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+rotation_matrix*(a_offset/32.0*fontScale+a_pxoffset)*projectionScaling,z,1.0);if(u_pitch_with_map) {finalPos=projectTileWithElevation(finalPos.xy,finalPos.z);}float gamma_scale=finalPos.w;gl_Position=finalPos;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float visibility=calculate_visibility(projectedPoint);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(visibility,fade_opacity[0]+fade_change));v_data0=a_tex/u_texsize;v_data1=vec3(gamma_scale,size,interpolated_fade_opacity);}`),symbolTextAndIcon:ci(`#define SDF_PX 8.0
#define SDF 1.0
#define ICON 0.0
uniform bool u_is_halo;uniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;varying vec4 v_data0;varying vec4 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
float fade_opacity=v_data1[2];if (v_data1.w==ICON) {vec2 tex_icon=v_data0.zw;lowp float alpha=opacity*fade_opacity;gl_FragColor=texture2D(u_texture_icon,tex_icon)*alpha;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
return;}vec2 tex=v_data0.xy;float EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_data1.x;float size=v_data1.y;float fontScale=size/24.0;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;if (u_is_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture2D(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);gl_FragColor=color*(alpha*opacity*fade_opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec4 a_pos_offset;attribute vec4 a_data;attribute vec3 a_projected_pos;attribute float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec2 u_texsize_icon;uniform bool u_is_along_line;uniform bool u_is_variable_anchor;uniform vec2 u_translation;uniform float u_pitched_scale;varying vec4 v_data0;varying vec4 v_data1;vec4 projectTileWithElevation(vec2 posInTile,float elevation) {return u_matrix*vec4(posInTile,elevation,1.0);}
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;float a_size_min=floor(a_size[0]*0.5);float is_sdf=a_size[0]-2.0*a_size_min;float ele=get_elevation(a_pos);highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 translated_a_pos=a_pos+u_translation;vec4 projectedPoint=projectTileWithElevation(translated_a_pos,ele);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);size*=perspective_ratio;float fontScale=size/24.0;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=projectTileWithElevation(translated_a_pos+vec2(1,0),ele);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);vec4 projected_pos;if (u_is_along_line || u_is_variable_anchor) {projected_pos=vec4(a_projected_pos.xy,ele,1.0);} else if (u_pitch_with_map) {projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy+u_translation,ele,1.0);} else {projected_pos=u_label_plane_matrix*projectTileWithElevation(a_projected_pos.xy+u_translation,ele);}float z=float(u_pitch_with_map)*projected_pos.z/projected_pos.w;float projectionScaling=1.0;vec4 finalPos=u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+rotation_matrix*(a_offset/32.0*fontScale)*projectionScaling,z,1.0);if(u_pitch_with_map) {finalPos=projectTileWithElevation(finalPos.xy,finalPos.z);}float gamma_scale=finalPos.w;gl_Position=finalPos;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float visibility=calculate_visibility(projectedPoint);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(visibility,fade_opacity[0]+fade_change));v_data0.xy=a_tex/u_texsize;v_data0.zw=a_tex/u_texsize_icon;v_data1=vec4(gamma_scale,size,interpolated_fade_opacity,is_sdf);}`),terrain:ci("uniform sampler2D u_texture;uniform vec4 u_fog_color;uniform vec4 u_horizon_color;uniform float u_fog_ground_blend;uniform float u_fog_ground_blend_opacity;uniform float u_horizon_fog_blend;varying vec2 v_texture_pos;varying float v_fog_depth;const float gamma=2.2;vec4 gammaToLinear(vec4 color) {return pow(color,vec4(gamma));}vec4 linearToGamma(vec4 color) {return pow(color,vec4(1.0/gamma));}void main() {vec4 surface_color=texture2D(u_texture,v_texture_pos);if (v_fog_depth > u_fog_ground_blend) {vec4 surface_color_linear=gammaToLinear(surface_color);float blend_color=smoothstep(0.0,1.0,max((v_fog_depth-u_horizon_fog_blend)/(1.0-u_horizon_fog_blend),0.0));vec4 fog_horizon_color_linear=mix(gammaToLinear(u_fog_color),gammaToLinear(u_horizon_color),blend_color);float factor_fog=max(v_fog_depth-u_fog_ground_blend,0.0)/(1.0-u_fog_ground_blend);gl_FragColor=linearToGamma(mix(surface_color_linear,fog_horizon_color_linear,pow(factor_fog,2.0)*u_fog_ground_blend_opacity));} else {gl_FragColor=surface_color;}}","attribute vec3 a_pos3d;uniform mat4 u_matrix;uniform mat4 u_fog_matrix;uniform float u_ele_delta;varying vec2 v_texture_pos;varying float v_fog_depth;void main() {float ele=get_elevation(a_pos3d.xy);float ele_delta=a_pos3d.z==1.0 ? u_ele_delta : 0.0;v_texture_pos=a_pos3d.xy/8192.0;gl_Position=u_matrix*vec4(a_pos3d.xy,ele-ele_delta,1.0);vec4 pos=u_fog_matrix*vec4(a_pos3d.xy,ele,1.0);v_fog_depth=pos.z/pos.w*0.5+0.5;}"),terrainDepth:ci("varying float v_depth;const highp vec4 bitSh=vec4(256.*256.*256.,256.*256.,256.,1.);const highp vec4 bitMsk=vec4(0.,vec3(1./256.0));highp vec4 pack(highp float value) {highp vec4 comp=fract(value*bitSh);comp-=comp.xxyz*bitMsk;return comp;}void main() {gl_FragColor=pack(v_depth);}","attribute vec3 a_pos3d;uniform mat4 u_matrix;uniform float u_ele_delta;varying float v_depth;void main() {float ele=get_elevation(a_pos3d.xy);float ele_delta=a_pos3d.z==1.0 ? u_ele_delta : 0.0;gl_Position=u_matrix*vec4(a_pos3d.xy,ele-ele_delta,1.0);v_depth=gl_Position.z/gl_Position.w;}"),terrainCoords:ci("precision mediump float;uniform sampler2D u_texture;uniform float u_terrain_coords_id;varying vec2 v_texture_pos;void main() {vec4 rgba=texture2D(u_texture,v_texture_pos);gl_FragColor=vec4(rgba.r,rgba.g,rgba.b,u_terrain_coords_id);}","attribute vec3 a_pos3d;uniform mat4 u_matrix;uniform float u_ele_delta;varying vec2 v_texture_pos;void main() {float ele=get_elevation(a_pos3d.xy);float ele_delta=a_pos3d.z==1.0 ? u_ele_delta : 0.0;v_texture_pos=a_pos3d.xy/8192.0;gl_Position=u_matrix*vec4(a_pos3d.xy,ele-ele_delta,1.0);}"),sky:ci("uniform vec4 u_sky_color;uniform vec4 u_horizon_color;uniform float u_horizon;uniform float u_sky_horizon_blend;void main() {float y=gl_FragCoord.y;if (y > u_horizon) {float blend=y-u_horizon;if (blend < u_sky_horizon_blend) {gl_FragColor=mix(u_sky_color,u_horizon_color,pow(1.0-blend/u_sky_horizon_blend,2.0));} else {gl_FragColor=u_sky_color;}}}","attribute vec2 a_pos;void main() {gl_Position=vec4(a_pos,1.0,1.0);}")};function ci(x,n){const d=/#pragma mapbox: ([\w]+) ([\w]+) ([\w]+) ([\w]+)/g,p=n.match(/attribute ([\w]+) ([\w]+)/g),m=x.match(/uniform ([\w]+) ([\w]+)([\s]*)([\w]*)/g),y=n.match(/uniform ([\w]+) ([\w]+)([\s]*)([\w]*)/g),E=y?y.concat(m):m,C={};return{fragmentSource:x=x.replace(d,((M,D,N,z,H)=>(C[H]=!0,D==="define"?`
#ifndef HAS_UNIFORM_u_${H}
varying ${N} ${z} ${H};
#else
uniform ${N} ${z} u_${H};
#endif
`:`
#ifdef HAS_UNIFORM_u_${H}
    ${N} ${z} ${H} = u_${H};
#endif
`))),vertexSource:n=n.replace(d,((M,D,N,z,H)=>{const Y=z==="float"?"vec2":"vec4",K=H.match(/color/)?"color":Y;return C[H]?D==="define"?`
#ifndef HAS_UNIFORM_u_${H}
uniform lowp float u_${H}_t;
attribute ${N} ${Y} a_${H};
varying ${N} ${z} ${H};
#else
uniform ${N} ${z} u_${H};
#endif
`:K==="vec4"?`
#ifndef HAS_UNIFORM_u_${H}
    ${H} = a_${H};
#else
    ${N} ${z} ${H} = u_${H};
#endif
`:`
#ifndef HAS_UNIFORM_u_${H}
    ${H} = unpack_mix_${K}(a_${H}, u_${H}_t);
#else
    ${N} ${z} ${H} = u_${H};
#endif
`:D==="define"?`
#ifndef HAS_UNIFORM_u_${H}
uniform lowp float u_${H}_t;
attribute ${N} ${Y} a_${H};
#else
uniform ${N} ${z} u_${H};
#endif
`:K==="vec4"?`
#ifndef HAS_UNIFORM_u_${H}
    ${N} ${z} ${H} = a_${H};
#else
    ${N} ${z} ${H} = u_${H};
#endif
`:`
#ifndef HAS_UNIFORM_u_${H}
    ${N} ${z} ${H} = unpack_mix_${K}(a_${H}, u_${H}_t);
#else
    ${N} ${z} ${H} = u_${H};
#endif
`})),staticAttributes:p,staticUniforms:E}}class Bc{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffer=null,this.vao=null}bind(n,d,p,m,y,E,C,M,D){this.context=n;let N=this.boundPaintVertexBuffers.length!==m.length;for(let z=0;!N&&z<m.length;z++)this.boundPaintVertexBuffers[z]!==m[z]&&(N=!0);!this.vao||this.boundProgram!==d||this.boundLayoutVertexBuffer!==p||N||this.boundIndexBuffer!==y||this.boundVertexOffset!==E||this.boundDynamicVertexBuffer!==C||this.boundDynamicVertexBuffer2!==M||this.boundDynamicVertexBuffer3!==D?this.freshBind(d,p,m,y,E,C,M,D):(n.bindVertexArray.set(this.vao),C&&C.bind(),y&&y.dynamicDraw&&y.bind(),M&&M.bind(),D&&D.bind())}freshBind(n,d,p,m,y,E,C,M){const D=n.numAttributes,N=this.context,z=N.gl;this.vao&&this.destroy(),this.vao=N.createVertexArray(),N.bindVertexArray.set(this.vao),this.boundProgram=n,this.boundLayoutVertexBuffer=d,this.boundPaintVertexBuffers=p,this.boundIndexBuffer=m,this.boundVertexOffset=y,this.boundDynamicVertexBuffer=E,this.boundDynamicVertexBuffer2=C,this.boundDynamicVertexBuffer3=M,d.enableAttributes(z,n);for(const H of p)H.enableAttributes(z,n);E&&E.enableAttributes(z,n),C&&C.enableAttributes(z,n),M&&M.enableAttributes(z,n),d.bind(),d.setVertexAttribPointers(z,n,y);for(const H of p)H.bind(),H.setVertexAttribPointers(z,n,y);E&&(E.bind(),E.setVertexAttribPointers(z,n,y)),m&&m.bind(),C&&(C.bind(),C.setVertexAttribPointers(z,n,y)),M&&(M.bind(),M.setVertexAttribPointers(z,n,y)),N.currentNumAttributes=D}destroy(){this.vao&&(this.context.deleteVertexArray(this.vao),this.vao=null)}}const Nc=(x,n,d,p,m)=>({u_matrix:x,u_texture:0,u_ele_delta:n,u_fog_matrix:d,u_fog_color:p?p.properties.get("fog-color"):l.aM.white,u_fog_ground_blend:p?p.properties.get("fog-ground-blend"):1,u_fog_ground_blend_opacity:p?p.calculateFogBlendOpacity(m):0,u_horizon_color:p?p.properties.get("horizon-color"):l.aM.white,u_horizon_fog_blend:p?p.properties.get("horizon-fog-blend"):1});function ao(x){const n=[];for(let d=0;d<x.length;d++){if(x[d]===null)continue;const p=x[d].split(" ");n.push(p.pop())}return n}class zc{constructor(n,d,p,m,y,E){const C=n.gl;this.program=C.createProgram();const M=ao(d.staticAttributes),D=p?p.getBinderAttributes():[],N=M.concat(D),z=dn.prelude.staticUniforms?ao(dn.prelude.staticUniforms):[],H=d.staticUniforms?ao(d.staticUniforms):[],Y=p?p.getBinderUniforms():[],K=z.concat(H).concat(Y),oe=[];for(const De of K)oe.indexOf(De)<0&&oe.push(De);const he=p?p.defines():[];y&&he.push("#define OVERDRAW_INSPECTOR;"),E&&he.push("#define TERRAIN3D;");const fe=he.concat(dn.prelude.fragmentSource,d.fragmentSource).join(`
`),_e=he.concat(dn.prelude.vertexSource,d.vertexSource).join(`
`),re=C.createShader(C.FRAGMENT_SHADER);if(C.isContextLost())return void(this.failedToCreate=!0);if(C.shaderSource(re,fe),C.compileShader(re),!C.getShaderParameter(re,C.COMPILE_STATUS))throw new Error(`Could not compile fragment shader: ${C.getShaderInfoLog(re)}`);C.attachShader(this.program,re);const be=C.createShader(C.VERTEX_SHADER);if(C.isContextLost())return void(this.failedToCreate=!0);if(C.shaderSource(be,_e),C.compileShader(be),!C.getShaderParameter(be,C.COMPILE_STATUS))throw new Error(`Could not compile vertex shader: ${C.getShaderInfoLog(be)}`);C.attachShader(this.program,be),this.attributes={};const Se={};this.numAttributes=N.length;for(let De=0;De<this.numAttributes;De++)N[De]&&(C.bindAttribLocation(this.program,De,N[De]),this.attributes[N[De]]=De);if(C.linkProgram(this.program),!C.getProgramParameter(this.program,C.LINK_STATUS))throw new Error(`Program failed to link: ${C.getProgramInfoLog(this.program)}`);C.deleteShader(be),C.deleteShader(re);for(let De=0;De<oe.length;De++){const Xe=oe[De];if(Xe&&!Se[Xe]){const rt=C.getUniformLocation(this.program,Xe);rt&&(Se[Xe]=rt)}}this.fixedUniforms=m(n,Se),this.terrainUniforms=((De,Xe)=>({u_depth:new l.aH(De,Xe.u_depth),u_terrain:new l.aH(De,Xe.u_terrain),u_terrain_dim:new l.aI(De,Xe.u_terrain_dim),u_terrain_matrix:new l.aJ(De,Xe.u_terrain_matrix),u_terrain_unpack:new l.aK(De,Xe.u_terrain_unpack),u_terrain_exaggeration:new l.aI(De,Xe.u_terrain_exaggeration)}))(n,Se),this.binderUniforms=p?p.getUniforms(n,Se):[]}draw(n,d,p,m,y,E,C,M,D,N,z,H,Y,K,oe,he,fe,_e){const re=n.gl;if(this.failedToCreate)return;if(n.program.set(this.program),n.setDepthMode(p),n.setStencilMode(m),n.setColorMode(y),n.setCullFace(E),M){n.activeTexture.set(re.TEXTURE2),re.bindTexture(re.TEXTURE_2D,M.depthTexture),n.activeTexture.set(re.TEXTURE3),re.bindTexture(re.TEXTURE_2D,M.texture);for(const Se in this.terrainUniforms)this.terrainUniforms[Se].set(M[Se])}for(const Se in this.fixedUniforms)this.fixedUniforms[Se].set(C[Se]);oe&&oe.setUniforms(n,this.binderUniforms,Y,{zoom:K});let be=0;switch(d){case re.LINES:be=2;break;case re.TRIANGLES:be=3;break;case re.LINE_STRIP:be=1}for(const Se of H.get()){const De=Se.vaos||(Se.vaos={});(De[D]||(De[D]=new Bc)).bind(n,this,N,oe?oe.getPaintVertexBuffers():[],z,Se.vertexOffset,he,fe,_e),re.drawElements(d,Se.primitiveLength*be,re.UNSIGNED_SHORT,Se.primitiveOffset*be*2)}}}function sl(x,n,d){const p=1/Jt(d,1,n.transform.tileZoom),m=Math.pow(2,d.tileID.overscaledZ),y=d.tileSize*Math.pow(2,n.transform.tileZoom)/m,E=y*(d.tileID.canonical.x+d.tileID.wrap*m),C=y*d.tileID.canonical.y;return{u_image:0,u_texsize:d.imageAtlasTexture.size,u_scale:[p,x.fromScale,x.toScale],u_fade:x.t,u_pixel_coord_upper:[E>>16,C>>16],u_pixel_coord_lower:[65535&E,65535&C]}}const na=(x,n,d,p)=>{const m=n.style.light,y=m.properties.get("position"),E=[y.x,y.y,y.z],C=(function(){var D=new l.A(9);return l.A!=Float32Array&&(D[1]=0,D[2]=0,D[3]=0,D[5]=0,D[6]=0,D[7]=0),D[0]=1,D[4]=1,D[8]=1,D})();m.properties.get("anchor")==="viewport"&&(function(D,N){var z=Math.sin(N),H=Math.cos(N);D[0]=H,D[1]=z,D[2]=0,D[3]=-z,D[4]=H,D[5]=0,D[6]=0,D[7]=0,D[8]=1})(C,-n.transform.angle),(function(D,N,z){var H=N[0],Y=N[1],K=N[2];D[0]=H*z[0]+Y*z[3]+K*z[6],D[1]=H*z[1]+Y*z[4]+K*z[7],D[2]=H*z[2]+Y*z[5]+K*z[8]})(E,E,C);const M=m.properties.get("color");return{u_matrix:x,u_lightpos:E,u_lightintensity:m.properties.get("intensity"),u_lightcolor:[M.r,M.g,M.b],u_vertical_gradient:+d,u_opacity:p}},nl=(x,n,d,p,m,y,E)=>l.e(na(x,n,d,p),sl(y,n,E),{u_height_factor:-Math.pow(2,m.overscaledZ)/E.tileSize/8}),lo=x=>({u_matrix:x}),Hh=(x,n,d,p)=>l.e(lo(x),sl(d,n,p)),Rp=(x,n)=>({u_matrix:x,u_world:n}),qh=(x,n,d,p,m)=>l.e(Hh(x,n,d,p),{u_world:m}),kp=(x,n,d,p)=>{const m=x.transform;let y,E;if(p.paint.get("circle-pitch-alignment")==="map"){const C=Jt(d,1,m.zoom);y=!0,E=[C,C]}else y=!1,E=m.pixelsToGLUnits;return{u_camera_to_center_distance:m.cameraToCenterDistance,u_scale_with_map:+(p.paint.get("circle-pitch-scale")==="map"),u_matrix:x.translatePosMatrix(n.posMatrix,d,p.paint.get("circle-translate"),p.paint.get("circle-translate-anchor")),u_pitch_with_map:+y,u_device_pixel_ratio:x.pixelRatio,u_extrude_scale:E}},Dn=(x,n,d)=>({u_matrix:x,u_inv_matrix:n,u_camera_to_center_distance:d.cameraToCenterDistance,u_viewport_size:[d.width,d.height]}),oa=(x,n,d=1)=>({u_matrix:x,u_color:n,u_overlay:0,u_overlay_scale:d}),Or=x=>({u_matrix:x}),Lr=(x,n,d,p)=>({u_matrix:x,u_extrude_scale:Jt(n,1,d),u_intensity:p}),ol=(x,n,d,p)=>{const m=l.H();l.aP(m,0,x.width,x.height,0,0,1);const y=x.context.gl;return{u_matrix:m,u_world:[y.drawingBufferWidth,y.drawingBufferHeight],u_image:d,u_color_ramp:p,u_opacity:n.paint.get("heatmap-opacity")}};function al(x,n){const d=Math.pow(2,n.canonical.z),p=n.canonical.y;return[new l.Z(0,p/d).toLngLat().lat,new l.Z(0,(p+1)/d).toLngLat().lat]}const ll=(x,n,d,p)=>{const m=x.transform;return{u_matrix:Yh(x,n,d,p),u_ratio:1/Jt(n,1,m.zoom),u_device_pixel_ratio:x.pixelRatio,u_units_to_pixels:[1/m.pixelsToGLUnits[0],1/m.pixelsToGLUnits[1]]}},Xh=(x,n,d,p,m)=>l.e(ll(x,n,d,m),{u_image:0,u_image_height:p}),co=(x,n,d,p,m)=>{const y=x.transform,E=Zh(n,y);return{u_matrix:Yh(x,n,d,m),u_texsize:n.imageAtlasTexture.size,u_ratio:1/Jt(n,1,y.zoom),u_device_pixel_ratio:x.pixelRatio,u_image:0,u_scale:[E,p.fromScale,p.toScale],u_fade:p.t,u_units_to_pixels:[1/y.pixelsToGLUnits[0],1/y.pixelsToGLUnits[1]]}},Dp=(x,n,d,p,m,y)=>{const E=x.lineAtlas,C=Zh(n,x.transform),M=d.layout.get("line-cap")==="round",D=E.getDash(p.from,M),N=E.getDash(p.to,M),z=D.width*m.fromScale,H=N.width*m.toScale;return l.e(ll(x,n,d,y),{u_patternscale_a:[C/z,-D.height/2],u_patternscale_b:[C/H,-N.height/2],u_sdfgamma:E.width/(256*Math.min(z,H)*x.pixelRatio)/2,u_image:0,u_tex_y_a:D.y,u_tex_y_b:N.y,u_mix:m.t})};function Zh(x,n){return 1/Jt(x,1,n.tileZoom)}function Yh(x,n,d,p){return x.translatePosMatrix(p?p.posMatrix:n.tileID.posMatrix,n,d.paint.get("line-translate"),d.paint.get("line-translate-anchor"))}const Op=(x,n,d,p,m)=>{return{u_matrix:x,u_tl_parent:n,u_scale_parent:d,u_buffer_scale:1,u_fade_t:p.mix,u_opacity:p.opacity*m.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:m.paint.get("raster-brightness-min"),u_brightness_high:m.paint.get("raster-brightness-max"),u_saturation_factor:(E=m.paint.get("raster-saturation"),E>0?1-1/(1.001-E):-E),u_contrast_factor:(y=m.paint.get("raster-contrast"),y>0?1/(1-y):1+y),u_spin_weights:Lp(m.paint.get("raster-hue-rotate"))};var y,E};function Lp(x){x*=Math.PI/180;const n=Math.sin(x),d=Math.cos(x);return[(2*d+1)/3,(-Math.sqrt(3)*n-d+1)/3,(Math.sqrt(3)*n-d+1)/3]}const Gh=(x,n,d,p,m,y,E,C,M,D,N,z,H,Y)=>{const K=E.transform;return{u_is_size_zoom_constant:+(x==="constant"||x==="source"),u_is_size_feature_constant:+(x==="constant"||x==="camera"),u_size_t:n?n.uSizeT:0,u_size:n?n.uSize:0,u_camera_to_center_distance:K.cameraToCenterDistance,u_pitch:K.pitch/360*2*Math.PI,u_rotate_symbol:+d,u_aspect_ratio:K.width/K.height,u_fade_change:E.options.fadeDuration?E.symbolFadeChange:1,u_matrix:C,u_label_plane_matrix:M,u_coord_matrix:D,u_is_text:+z,u_pitch_with_map:+p,u_is_along_line:m,u_is_variable_anchor:y,u_texsize:H,u_texture:0,u_translation:N,u_pitched_scale:Y}},aa=(x,n,d,p,m,y,E,C,M,D,N,z,H,Y,K)=>{const oe=E.transform;return l.e(Gh(x,n,d,p,m,y,E,C,M,D,N,z,H,K),{u_gamma_scale:p?Math.cos(oe._pitch)*oe.cameraToCenterDistance:1,u_device_pixel_ratio:E.pixelRatio,u_is_halo:1})},Uc=(x,n,d,p,m,y,E,C,M,D,N,z,H,Y)=>l.e(aa(x,n,d,p,m,y,E,C,M,D,N,!0,z,!0,Y),{u_texsize_icon:H,u_texture_icon:1}),cl=(x,n,d)=>({u_matrix:x,u_opacity:n,u_color:d}),Vc=(x,n,d,p,m,y)=>l.e((function(E,C,M,D){const N=M.imageManager.getPattern(E.from.toString()),z=M.imageManager.getPattern(E.to.toString()),{width:H,height:Y}=M.imageManager.getPixelSize(),K=Math.pow(2,D.tileID.overscaledZ),oe=D.tileSize*Math.pow(2,M.transform.tileZoom)/K,he=oe*(D.tileID.canonical.x+D.tileID.wrap*K),fe=oe*D.tileID.canonical.y;return{u_image:0,u_pattern_tl_a:N.tl,u_pattern_br_a:N.br,u_pattern_tl_b:z.tl,u_pattern_br_b:z.br,u_texsize:[H,Y],u_mix:C.t,u_pattern_size_a:N.displaySize,u_pattern_size_b:z.displaySize,u_scale_a:C.fromScale,u_scale_b:C.toScale,u_tile_units_to_pixels:1/Jt(D,1,M.transform.tileZoom),u_pixel_coord_upper:[he>>16,fe>>16],u_pixel_coord_lower:[65535&he,65535&fe]}})(p,y,d,m),{u_matrix:x,u_opacity:n}),jc={fillExtrusion:(x,n)=>({u_matrix:new l.aJ(x,n.u_matrix),u_lightpos:new l.aN(x,n.u_lightpos),u_lightintensity:new l.aI(x,n.u_lightintensity),u_lightcolor:new l.aN(x,n.u_lightcolor),u_vertical_gradient:new l.aI(x,n.u_vertical_gradient),u_opacity:new l.aI(x,n.u_opacity)}),fillExtrusionPattern:(x,n)=>({u_matrix:new l.aJ(x,n.u_matrix),u_lightpos:new l.aN(x,n.u_lightpos),u_lightintensity:new l.aI(x,n.u_lightintensity),u_lightcolor:new l.aN(x,n.u_lightcolor),u_vertical_gradient:new l.aI(x,n.u_vertical_gradient),u_height_factor:new l.aI(x,n.u_height_factor),u_image:new l.aH(x,n.u_image),u_texsize:new l.aO(x,n.u_texsize),u_pixel_coord_upper:new l.aO(x,n.u_pixel_coord_upper),u_pixel_coord_lower:new l.aO(x,n.u_pixel_coord_lower),u_scale:new l.aN(x,n.u_scale),u_fade:new l.aI(x,n.u_fade),u_opacity:new l.aI(x,n.u_opacity)}),fill:(x,n)=>({u_matrix:new l.aJ(x,n.u_matrix)}),fillPattern:(x,n)=>({u_matrix:new l.aJ(x,n.u_matrix),u_image:new l.aH(x,n.u_image),u_texsize:new l.aO(x,n.u_texsize),u_pixel_coord_upper:new l.aO(x,n.u_pixel_coord_upper),u_pixel_coord_lower:new l.aO(x,n.u_pixel_coord_lower),u_scale:new l.aN(x,n.u_scale),u_fade:new l.aI(x,n.u_fade)}),fillOutline:(x,n)=>({u_matrix:new l.aJ(x,n.u_matrix),u_world:new l.aO(x,n.u_world)}),fillOutlinePattern:(x,n)=>({u_matrix:new l.aJ(x,n.u_matrix),u_world:new l.aO(x,n.u_world),u_image:new l.aH(x,n.u_image),u_texsize:new l.aO(x,n.u_texsize),u_pixel_coord_upper:new l.aO(x,n.u_pixel_coord_upper),u_pixel_coord_lower:new l.aO(x,n.u_pixel_coord_lower),u_scale:new l.aN(x,n.u_scale),u_fade:new l.aI(x,n.u_fade)}),circle:(x,n)=>({u_camera_to_center_distance:new l.aI(x,n.u_camera_to_center_distance),u_scale_with_map:new l.aH(x,n.u_scale_with_map),u_pitch_with_map:new l.aH(x,n.u_pitch_with_map),u_extrude_scale:new l.aO(x,n.u_extrude_scale),u_device_pixel_ratio:new l.aI(x,n.u_device_pixel_ratio),u_matrix:new l.aJ(x,n.u_matrix)}),collisionBox:(x,n)=>({u_matrix:new l.aJ(x,n.u_matrix),u_pixel_extrude_scale:new l.aO(x,n.u_pixel_extrude_scale)}),collisionCircle:(x,n)=>({u_matrix:new l.aJ(x,n.u_matrix),u_inv_matrix:new l.aJ(x,n.u_inv_matrix),u_camera_to_center_distance:new l.aI(x,n.u_camera_to_center_distance),u_viewport_size:new l.aO(x,n.u_viewport_size)}),debug:(x,n)=>({u_color:new l.aL(x,n.u_color),u_matrix:new l.aJ(x,n.u_matrix),u_overlay:new l.aH(x,n.u_overlay),u_overlay_scale:new l.aI(x,n.u_overlay_scale)}),clippingMask:(x,n)=>({u_matrix:new l.aJ(x,n.u_matrix)}),heatmap:(x,n)=>({u_extrude_scale:new l.aI(x,n.u_extrude_scale),u_intensity:new l.aI(x,n.u_intensity),u_matrix:new l.aJ(x,n.u_matrix)}),heatmapTexture:(x,n)=>({u_matrix:new l.aJ(x,n.u_matrix),u_world:new l.aO(x,n.u_world),u_image:new l.aH(x,n.u_image),u_color_ramp:new l.aH(x,n.u_color_ramp),u_opacity:new l.aI(x,n.u_opacity)}),hillshade:(x,n)=>({u_matrix:new l.aJ(x,n.u_matrix),u_image:new l.aH(x,n.u_image),u_latrange:new l.aO(x,n.u_latrange),u_light:new l.aO(x,n.u_light),u_shadow:new l.aL(x,n.u_shadow),u_highlight:new l.aL(x,n.u_highlight),u_accent:new l.aL(x,n.u_accent)}),hillshadePrepare:(x,n)=>({u_matrix:new l.aJ(x,n.u_matrix),u_image:new l.aH(x,n.u_image),u_dimension:new l.aO(x,n.u_dimension),u_zoom:new l.aI(x,n.u_zoom),u_unpack:new l.aK(x,n.u_unpack)}),line:(x,n)=>({u_matrix:new l.aJ(x,n.u_matrix),u_ratio:new l.aI(x,n.u_ratio),u_device_pixel_ratio:new l.aI(x,n.u_device_pixel_ratio),u_units_to_pixels:new l.aO(x,n.u_units_to_pixels)}),lineGradient:(x,n)=>({u_matrix:new l.aJ(x,n.u_matrix),u_ratio:new l.aI(x,n.u_ratio),u_device_pixel_ratio:new l.aI(x,n.u_device_pixel_ratio),u_units_to_pixels:new l.aO(x,n.u_units_to_pixels),u_image:new l.aH(x,n.u_image),u_image_height:new l.aI(x,n.u_image_height)}),linePattern:(x,n)=>({u_matrix:new l.aJ(x,n.u_matrix),u_texsize:new l.aO(x,n.u_texsize),u_ratio:new l.aI(x,n.u_ratio),u_device_pixel_ratio:new l.aI(x,n.u_device_pixel_ratio),u_image:new l.aH(x,n.u_image),u_units_to_pixels:new l.aO(x,n.u_units_to_pixels),u_scale:new l.aN(x,n.u_scale),u_fade:new l.aI(x,n.u_fade)}),lineSDF:(x,n)=>({u_matrix:new l.aJ(x,n.u_matrix),u_ratio:new l.aI(x,n.u_ratio),u_device_pixel_ratio:new l.aI(x,n.u_device_pixel_ratio),u_units_to_pixels:new l.aO(x,n.u_units_to_pixels),u_patternscale_a:new l.aO(x,n.u_patternscale_a),u_patternscale_b:new l.aO(x,n.u_patternscale_b),u_sdfgamma:new l.aI(x,n.u_sdfgamma),u_image:new l.aH(x,n.u_image),u_tex_y_a:new l.aI(x,n.u_tex_y_a),u_tex_y_b:new l.aI(x,n.u_tex_y_b),u_mix:new l.aI(x,n.u_mix)}),raster:(x,n)=>({u_matrix:new l.aJ(x,n.u_matrix),u_tl_parent:new l.aO(x,n.u_tl_parent),u_scale_parent:new l.aI(x,n.u_scale_parent),u_buffer_scale:new l.aI(x,n.u_buffer_scale),u_fade_t:new l.aI(x,n.u_fade_t),u_opacity:new l.aI(x,n.u_opacity),u_image0:new l.aH(x,n.u_image0),u_image1:new l.aH(x,n.u_image1),u_brightness_low:new l.aI(x,n.u_brightness_low),u_brightness_high:new l.aI(x,n.u_brightness_high),u_saturation_factor:new l.aI(x,n.u_saturation_factor),u_contrast_factor:new l.aI(x,n.u_contrast_factor),u_spin_weights:new l.aN(x,n.u_spin_weights)}),symbolIcon:(x,n)=>({u_is_size_zoom_constant:new l.aH(x,n.u_is_size_zoom_constant),u_is_size_feature_constant:new l.aH(x,n.u_is_size_feature_constant),u_size_t:new l.aI(x,n.u_size_t),u_size:new l.aI(x,n.u_size),u_camera_to_center_distance:new l.aI(x,n.u_camera_to_center_distance),u_pitch:new l.aI(x,n.u_pitch),u_rotate_symbol:new l.aH(x,n.u_rotate_symbol),u_aspect_ratio:new l.aI(x,n.u_aspect_ratio),u_fade_change:new l.aI(x,n.u_fade_change),u_matrix:new l.aJ(x,n.u_matrix),u_label_plane_matrix:new l.aJ(x,n.u_label_plane_matrix),u_coord_matrix:new l.aJ(x,n.u_coord_matrix),u_is_text:new l.aH(x,n.u_is_text),u_pitch_with_map:new l.aH(x,n.u_pitch_with_map),u_is_along_line:new l.aH(x,n.u_is_along_line),u_is_variable_anchor:new l.aH(x,n.u_is_variable_anchor),u_texsize:new l.aO(x,n.u_texsize),u_texture:new l.aH(x,n.u_texture),u_translation:new l.aO(x,n.u_translation),u_pitched_scale:new l.aI(x,n.u_pitched_scale)}),symbolSDF:(x,n)=>({u_is_size_zoom_constant:new l.aH(x,n.u_is_size_zoom_constant),u_is_size_feature_constant:new l.aH(x,n.u_is_size_feature_constant),u_size_t:new l.aI(x,n.u_size_t),u_size:new l.aI(x,n.u_size),u_camera_to_center_distance:new l.aI(x,n.u_camera_to_center_distance),u_pitch:new l.aI(x,n.u_pitch),u_rotate_symbol:new l.aH(x,n.u_rotate_symbol),u_aspect_ratio:new l.aI(x,n.u_aspect_ratio),u_fade_change:new l.aI(x,n.u_fade_change),u_matrix:new l.aJ(x,n.u_matrix),u_label_plane_matrix:new l.aJ(x,n.u_label_plane_matrix),u_coord_matrix:new l.aJ(x,n.u_coord_matrix),u_is_text:new l.aH(x,n.u_is_text),u_pitch_with_map:new l.aH(x,n.u_pitch_with_map),u_is_along_line:new l.aH(x,n.u_is_along_line),u_is_variable_anchor:new l.aH(x,n.u_is_variable_anchor),u_texsize:new l.aO(x,n.u_texsize),u_texture:new l.aH(x,n.u_texture),u_gamma_scale:new l.aI(x,n.u_gamma_scale),u_device_pixel_ratio:new l.aI(x,n.u_device_pixel_ratio),u_is_halo:new l.aH(x,n.u_is_halo),u_translation:new l.aO(x,n.u_translation),u_pitched_scale:new l.aI(x,n.u_pitched_scale)}),symbolTextAndIcon:(x,n)=>({u_is_size_zoom_constant:new l.aH(x,n.u_is_size_zoom_constant),u_is_size_feature_constant:new l.aH(x,n.u_is_size_feature_constant),u_size_t:new l.aI(x,n.u_size_t),u_size:new l.aI(x,n.u_size),u_camera_to_center_distance:new l.aI(x,n.u_camera_to_center_distance),u_pitch:new l.aI(x,n.u_pitch),u_rotate_symbol:new l.aH(x,n.u_rotate_symbol),u_aspect_ratio:new l.aI(x,n.u_aspect_ratio),u_fade_change:new l.aI(x,n.u_fade_change),u_matrix:new l.aJ(x,n.u_matrix),u_label_plane_matrix:new l.aJ(x,n.u_label_plane_matrix),u_coord_matrix:new l.aJ(x,n.u_coord_matrix),u_is_text:new l.aH(x,n.u_is_text),u_pitch_with_map:new l.aH(x,n.u_pitch_with_map),u_is_along_line:new l.aH(x,n.u_is_along_line),u_is_variable_anchor:new l.aH(x,n.u_is_variable_anchor),u_texsize:new l.aO(x,n.u_texsize),u_texsize_icon:new l.aO(x,n.u_texsize_icon),u_texture:new l.aH(x,n.u_texture),u_texture_icon:new l.aH(x,n.u_texture_icon),u_gamma_scale:new l.aI(x,n.u_gamma_scale),u_device_pixel_ratio:new l.aI(x,n.u_device_pixel_ratio),u_is_halo:new l.aH(x,n.u_is_halo),u_translation:new l.aO(x,n.u_translation),u_pitched_scale:new l.aI(x,n.u_pitched_scale)}),background:(x,n)=>({u_matrix:new l.aJ(x,n.u_matrix),u_opacity:new l.aI(x,n.u_opacity),u_color:new l.aL(x,n.u_color)}),backgroundPattern:(x,n)=>({u_matrix:new l.aJ(x,n.u_matrix),u_opacity:new l.aI(x,n.u_opacity),u_image:new l.aH(x,n.u_image),u_pattern_tl_a:new l.aO(x,n.u_pattern_tl_a),u_pattern_br_a:new l.aO(x,n.u_pattern_br_a),u_pattern_tl_b:new l.aO(x,n.u_pattern_tl_b),u_pattern_br_b:new l.aO(x,n.u_pattern_br_b),u_texsize:new l.aO(x,n.u_texsize),u_mix:new l.aI(x,n.u_mix),u_pattern_size_a:new l.aO(x,n.u_pattern_size_a),u_pattern_size_b:new l.aO(x,n.u_pattern_size_b),u_scale_a:new l.aI(x,n.u_scale_a),u_scale_b:new l.aI(x,n.u_scale_b),u_pixel_coord_upper:new l.aO(x,n.u_pixel_coord_upper),u_pixel_coord_lower:new l.aO(x,n.u_pixel_coord_lower),u_tile_units_to_pixels:new l.aI(x,n.u_tile_units_to_pixels)}),terrain:(x,n)=>({u_matrix:new l.aJ(x,n.u_matrix),u_texture:new l.aH(x,n.u_texture),u_ele_delta:new l.aI(x,n.u_ele_delta),u_fog_matrix:new l.aJ(x,n.u_fog_matrix),u_fog_color:new l.aL(x,n.u_fog_color),u_fog_ground_blend:new l.aI(x,n.u_fog_ground_blend),u_fog_ground_blend_opacity:new l.aI(x,n.u_fog_ground_blend_opacity),u_horizon_color:new l.aL(x,n.u_horizon_color),u_horizon_fog_blend:new l.aI(x,n.u_horizon_fog_blend)}),terrainDepth:(x,n)=>({u_matrix:new l.aJ(x,n.u_matrix),u_ele_delta:new l.aI(x,n.u_ele_delta)}),terrainCoords:(x,n)=>({u_matrix:new l.aJ(x,n.u_matrix),u_texture:new l.aH(x,n.u_texture),u_terrain_coords_id:new l.aI(x,n.u_terrain_coords_id),u_ele_delta:new l.aI(x,n.u_ele_delta)}),sky:(x,n)=>({u_sky_color:new l.aL(x,n.u_sky_color),u_horizon_color:new l.aL(x,n.u_horizon_color),u_horizon:new l.aI(x,n.u_horizon),u_sky_horizon_blend:new l.aI(x,n.u_sky_horizon_blend)})};class Vs{constructor(n,d,p){this.context=n;const m=n.gl;this.buffer=m.createBuffer(),this.dynamicDraw=!!p,this.context.unbindVAO(),n.bindElementBuffer.set(this.buffer),m.bufferData(m.ELEMENT_ARRAY_BUFFER,d.arrayBuffer,this.dynamicDraw?m.DYNAMIC_DRAW:m.STATIC_DRAW),this.dynamicDraw||delete d.arrayBuffer}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(n){const d=this.context.gl;if(!this.dynamicDraw)throw new Error("Attempted to update data while not in dynamic mode.");this.context.unbindVAO(),this.bind(),d.bufferSubData(d.ELEMENT_ARRAY_BUFFER,0,n.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}const Fp={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class $c{constructor(n,d,p,m){this.length=d.length,this.attributes=p,this.itemSize=d.bytesPerElement,this.dynamicDraw=m,this.context=n;const y=n.gl;this.buffer=y.createBuffer(),n.bindVertexBuffer.set(this.buffer),y.bufferData(y.ARRAY_BUFFER,d.arrayBuffer,this.dynamicDraw?y.DYNAMIC_DRAW:y.STATIC_DRAW),this.dynamicDraw||delete d.arrayBuffer}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(n){if(n.length!==this.length)throw new Error(`Length of new data is ${n.length}, which doesn't match current length of ${this.length}`);const d=this.context.gl;this.bind(),d.bufferSubData(d.ARRAY_BUFFER,0,n.arrayBuffer)}enableAttributes(n,d){for(let p=0;p<this.attributes.length;p++){const m=d.attributes[this.attributes[p].name];m!==void 0&&n.enableVertexAttribArray(m)}}setVertexAttribPointers(n,d,p){for(let m=0;m<this.attributes.length;m++){const y=this.attributes[m],E=d.attributes[y.name];E!==void 0&&n.vertexAttribPointer(E,y.components,n[Fp[y.type]],!1,this.itemSize,y.offset+this.itemSize*(p||0))}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}const On=new WeakMap;function fn(x){var n;if(On.has(x))return On.get(x);{const d=(n=x.getParameter(x.VERSION))===null||n===void 0?void 0:n.startsWith("WebGL 2.0");return On.set(x,d),d}}class ui{constructor(n){this.gl=n.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(n){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class ul extends ui{getDefault(){return l.aM.transparent}set(n){const d=this.current;(n.r!==d.r||n.g!==d.g||n.b!==d.b||n.a!==d.a||this.dirty)&&(this.gl.clearColor(n.r,n.g,n.b,n.a),this.current=n,this.dirty=!1)}}class Bp extends ui{getDefault(){return 1}set(n){(n!==this.current||this.dirty)&&(this.gl.clearDepth(n),this.current=n,this.dirty=!1)}}class uo extends ui{getDefault(){return 0}set(n){(n!==this.current||this.dirty)&&(this.gl.clearStencil(n),this.current=n,this.dirty=!1)}}class Np extends ui{getDefault(){return[!0,!0,!0,!0]}set(n){const d=this.current;(n[0]!==d[0]||n[1]!==d[1]||n[2]!==d[2]||n[3]!==d[3]||this.dirty)&&(this.gl.colorMask(n[0],n[1],n[2],n[3]),this.current=n,this.dirty=!1)}}class Kh extends ui{getDefault(){return!0}set(n){(n!==this.current||this.dirty)&&(this.gl.depthMask(n),this.current=n,this.dirty=!1)}}class zp extends ui{getDefault(){return 255}set(n){(n!==this.current||this.dirty)&&(this.gl.stencilMask(n),this.current=n,this.dirty=!1)}}class Jh extends ui{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(n){const d=this.current;(n.func!==d.func||n.ref!==d.ref||n.mask!==d.mask||this.dirty)&&(this.gl.stencilFunc(n.func,n.ref,n.mask),this.current=n,this.dirty=!1)}}class Wc extends ui{getDefault(){const n=this.gl;return[n.KEEP,n.KEEP,n.KEEP]}set(n){const d=this.current;(n[0]!==d[0]||n[1]!==d[1]||n[2]!==d[2]||this.dirty)&&(this.gl.stencilOp(n[0],n[1],n[2]),this.current=n,this.dirty=!1)}}class Qh extends ui{getDefault(){return!1}set(n){if(n===this.current&&!this.dirty)return;const d=this.gl;n?d.enable(d.STENCIL_TEST):d.disable(d.STENCIL_TEST),this.current=n,this.dirty=!1}}class ed extends ui{getDefault(){return[0,1]}set(n){const d=this.current;(n[0]!==d[0]||n[1]!==d[1]||this.dirty)&&(this.gl.depthRange(n[0],n[1]),this.current=n,this.dirty=!1)}}class td extends ui{getDefault(){return!1}set(n){if(n===this.current&&!this.dirty)return;const d=this.gl;n?d.enable(d.DEPTH_TEST):d.disable(d.DEPTH_TEST),this.current=n,this.dirty=!1}}class id extends ui{getDefault(){return this.gl.LESS}set(n){(n!==this.current||this.dirty)&&(this.gl.depthFunc(n),this.current=n,this.dirty=!1)}}class Ln extends ui{getDefault(){return!1}set(n){if(n===this.current&&!this.dirty)return;const d=this.gl;n?d.enable(d.BLEND):d.disable(d.BLEND),this.current=n,this.dirty=!1}}class rd extends ui{getDefault(){const n=this.gl;return[n.ONE,n.ZERO]}set(n){const d=this.current;(n[0]!==d[0]||n[1]!==d[1]||this.dirty)&&(this.gl.blendFunc(n[0],n[1]),this.current=n,this.dirty=!1)}}class Up extends ui{getDefault(){return l.aM.transparent}set(n){const d=this.current;(n.r!==d.r||n.g!==d.g||n.b!==d.b||n.a!==d.a||this.dirty)&&(this.gl.blendColor(n.r,n.g,n.b,n.a),this.current=n,this.dirty=!1)}}class sd extends ui{getDefault(){return this.gl.FUNC_ADD}set(n){(n!==this.current||this.dirty)&&(this.gl.blendEquation(n),this.current=n,this.dirty=!1)}}class la extends ui{getDefault(){return!1}set(n){if(n===this.current&&!this.dirty)return;const d=this.gl;n?d.enable(d.CULL_FACE):d.disable(d.CULL_FACE),this.current=n,this.dirty=!1}}class Vp extends ui{getDefault(){return this.gl.BACK}set(n){(n!==this.current||this.dirty)&&(this.gl.cullFace(n),this.current=n,this.dirty=!1)}}class hl extends ui{getDefault(){return this.gl.CCW}set(n){(n!==this.current||this.dirty)&&(this.gl.frontFace(n),this.current=n,this.dirty=!1)}}class jp extends ui{getDefault(){return null}set(n){(n!==this.current||this.dirty)&&(this.gl.useProgram(n),this.current=n,this.dirty=!1)}}class $p extends ui{getDefault(){return this.gl.TEXTURE0}set(n){(n!==this.current||this.dirty)&&(this.gl.activeTexture(n),this.current=n,this.dirty=!1)}}class nd extends ui{getDefault(){const n=this.gl;return[0,0,n.drawingBufferWidth,n.drawingBufferHeight]}set(n){const d=this.current;(n[0]!==d[0]||n[1]!==d[1]||n[2]!==d[2]||n[3]!==d[3]||this.dirty)&&(this.gl.viewport(n[0],n[1],n[2],n[3]),this.current=n,this.dirty=!1)}}class od extends ui{getDefault(){return null}set(n){if(n===this.current&&!this.dirty)return;const d=this.gl;d.bindFramebuffer(d.FRAMEBUFFER,n),this.current=n,this.dirty=!1}}class ad extends ui{getDefault(){return null}set(n){if(n===this.current&&!this.dirty)return;const d=this.gl;d.bindRenderbuffer(d.RENDERBUFFER,n),this.current=n,this.dirty=!1}}class Hc extends ui{getDefault(){return null}set(n){if(n===this.current&&!this.dirty)return;const d=this.gl;d.bindTexture(d.TEXTURE_2D,n),this.current=n,this.dirty=!1}}class ld extends ui{getDefault(){return null}set(n){if(n===this.current&&!this.dirty)return;const d=this.gl;d.bindBuffer(d.ARRAY_BUFFER,n),this.current=n,this.dirty=!1}}class dl extends ui{getDefault(){return null}set(n){const d=this.gl;d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,n),this.current=n,this.dirty=!1}}class Qs extends ui{getDefault(){return null}set(n){var d;if(n===this.current&&!this.dirty)return;const p=this.gl;fn(p)?p.bindVertexArray(n):(d=p.getExtension("OES_vertex_array_object"))===null||d===void 0||d.bindVertexArrayOES(n),this.current=n,this.dirty=!1}}class qc extends ui{getDefault(){return 4}set(n){if(n===this.current&&!this.dirty)return;const d=this.gl;d.pixelStorei(d.UNPACK_ALIGNMENT,n),this.current=n,this.dirty=!1}}class Xc extends ui{getDefault(){return!1}set(n){if(n===this.current&&!this.dirty)return;const d=this.gl;d.pixelStorei(d.UNPACK_PREMULTIPLY_ALPHA_WEBGL,n),this.current=n,this.dirty=!1}}class Zc extends ui{getDefault(){return!1}set(n){if(n===this.current&&!this.dirty)return;const d=this.gl;d.pixelStorei(d.UNPACK_FLIP_Y_WEBGL,n),this.current=n,this.dirty=!1}}class fl extends ui{constructor(n,d){super(n),this.context=n,this.parent=d}getDefault(){return null}}class Yc extends fl{setDirty(){this.dirty=!0}set(n){if(n===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const d=this.gl;d.framebufferTexture2D(d.FRAMEBUFFER,d.COLOR_ATTACHMENT0,d.TEXTURE_2D,n,0),this.current=n,this.dirty=!1}}class Fn extends fl{set(n){if(n===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const d=this.gl;d.framebufferRenderbuffer(d.FRAMEBUFFER,d.DEPTH_ATTACHMENT,d.RENDERBUFFER,n),this.current=n,this.dirty=!1}}class Gc extends fl{set(n){if(n===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const d=this.gl;d.framebufferRenderbuffer(d.FRAMEBUFFER,d.DEPTH_STENCIL_ATTACHMENT,d.RENDERBUFFER,n),this.current=n,this.dirty=!1}}class Wp{constructor(n,d,p,m,y){this.context=n,this.width=d,this.height=p;const E=n.gl,C=this.framebuffer=E.createFramebuffer();if(this.colorAttachment=new Yc(n,C),m)this.depthAttachment=y?new Gc(n,C):new Fn(n,C);else if(y)throw new Error("Stencil cannot be set without depth");if(E.checkFramebufferStatus(E.FRAMEBUFFER)!==E.FRAMEBUFFER_COMPLETE)throw new Error("Framebuffer is not complete")}destroy(){const n=this.context.gl,d=this.colorAttachment.get();if(d&&n.deleteTexture(d),this.depthAttachment){const p=this.depthAttachment.get();p&&n.deleteRenderbuffer(p)}n.deleteFramebuffer(this.framebuffer)}}class Ui{constructor(n,d,p){this.blendFunction=n,this.blendColor=d,this.mask=p}}Ui.Replace=[1,0],Ui.disabled=new Ui(Ui.Replace,l.aM.transparent,[!1,!1,!1,!1]),Ui.unblended=new Ui(Ui.Replace,l.aM.transparent,[!0,!0,!0,!0]),Ui.alphaBlended=new Ui([1,771],l.aM.transparent,[!0,!0,!0,!0]);class Hp{constructor(n){var d,p;if(this.gl=n,this.clearColor=new ul(this),this.clearDepth=new Bp(this),this.clearStencil=new uo(this),this.colorMask=new Np(this),this.depthMask=new Kh(this),this.stencilMask=new zp(this),this.stencilFunc=new Jh(this),this.stencilOp=new Wc(this),this.stencilTest=new Qh(this),this.depthRange=new ed(this),this.depthTest=new td(this),this.depthFunc=new id(this),this.blend=new Ln(this),this.blendFunc=new rd(this),this.blendColor=new Up(this),this.blendEquation=new sd(this),this.cullFace=new la(this),this.cullFaceSide=new Vp(this),this.frontFace=new hl(this),this.program=new jp(this),this.activeTexture=new $p(this),this.viewport=new nd(this),this.bindFramebuffer=new od(this),this.bindRenderbuffer=new ad(this),this.bindTexture=new Hc(this),this.bindVertexBuffer=new ld(this),this.bindElementBuffer=new dl(this),this.bindVertexArray=new Qs(this),this.pixelStoreUnpack=new qc(this),this.pixelStoreUnpackPremultiplyAlpha=new Xc(this),this.pixelStoreUnpackFlipY=new Zc(this),this.extTextureFilterAnisotropic=n.getExtension("EXT_texture_filter_anisotropic")||n.getExtension("MOZ_EXT_texture_filter_anisotropic")||n.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=n.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT)),this.maxTextureSize=n.getParameter(n.MAX_TEXTURE_SIZE),fn(n)){this.HALF_FLOAT=n.HALF_FLOAT;const m=n.getExtension("EXT_color_buffer_half_float");this.RGBA16F=(d=n.RGBA16F)!==null&&d!==void 0?d:m?.RGBA16F_EXT,this.RGB16F=(p=n.RGB16F)!==null&&p!==void 0?p:m?.RGB16F_EXT,n.getExtension("EXT_color_buffer_float")}else{n.getExtension("EXT_color_buffer_half_float"),n.getExtension("OES_texture_half_float_linear");const m=n.getExtension("OES_texture_half_float");this.HALF_FLOAT=m?.HALF_FLOAT_OES}}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.bindVertexArray.dirty=!0,this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(n,d){return new Vs(this,n,d)}createVertexBuffer(n,d,p){return new $c(this,n,d,p)}createRenderbuffer(n,d,p){const m=this.gl,y=m.createRenderbuffer();return this.bindRenderbuffer.set(y),m.renderbufferStorage(m.RENDERBUFFER,n,d,p),this.bindRenderbuffer.set(null),y}createFramebuffer(n,d,p,m){return new Wp(this,n,d,p,m)}clear({color:n,depth:d,stencil:p}){const m=this.gl;let y=0;n&&(y|=m.COLOR_BUFFER_BIT,this.clearColor.set(n),this.colorMask.set([!0,!0,!0,!0])),d!==void 0&&(y|=m.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(d),this.depthMask.set(!0)),p!==void 0&&(y|=m.STENCIL_BUFFER_BIT,this.clearStencil.set(p),this.stencilMask.set(255)),m.clear(y)}setCullFace(n){n.enable===!1?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(n.mode),this.frontFace.set(n.frontFace))}setDepthMode(n){n.func!==this.gl.ALWAYS||n.mask?(this.depthTest.set(!0),this.depthFunc.set(n.func),this.depthMask.set(n.mask),this.depthRange.set(n.range)):this.depthTest.set(!1)}setStencilMode(n){n.test.func!==this.gl.ALWAYS||n.mask?(this.stencilTest.set(!0),this.stencilMask.set(n.mask),this.stencilOp.set([n.fail,n.depthFail,n.pass]),this.stencilFunc.set({func:n.test.func,ref:n.ref,mask:n.test.mask})):this.stencilTest.set(!1)}setColorMode(n){l.aE(n.blendFunction,Ui.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(n.blendFunction),this.blendColor.set(n.blendColor)),this.colorMask.set(n.mask)}createVertexArray(){var n;return fn(this.gl)?this.gl.createVertexArray():(n=this.gl.getExtension("OES_vertex_array_object"))===null||n===void 0?void 0:n.createVertexArrayOES()}deleteVertexArray(n){var d;return fn(this.gl)?this.gl.deleteVertexArray(n):(d=this.gl.getExtension("OES_vertex_array_object"))===null||d===void 0?void 0:d.deleteVertexArrayOES(n)}unbindVAO(){this.bindVertexArray.set(null)}}class Yt{constructor(n,d,p){this.func=n,this.mask=d,this.range=p}}Yt.ReadOnly=!1,Yt.ReadWrite=!0,Yt.disabled=new Yt(519,Yt.ReadOnly,[0,1]);const pl=7680;class xi{constructor(n,d,p,m,y,E){this.test=n,this.ref=d,this.mask=p,this.fail=m,this.depthFail=y,this.pass=E}}xi.disabled=new xi({func:519,mask:0},0,0,pl,pl,pl);class fi{constructor(n,d,p){this.enable=n,this.mode=d,this.frontFace=p}}let Bn;function ca(x,n,d,p,m){const y=x.context,E=y.gl,C=x.useProgram("collisionBox"),M=[];let D=0,N=0;for(let fe=0;fe<p.length;fe++){const _e=p[fe],re=n.getTile(_e).getBucket(d);if(!re)continue;const be=m?re.textCollisionBox:re.iconCollisionBox,Se=re.collisionCircleArray;if(Se.length>0){const De=l.H();l.aQ(De,re.placementInvProjMatrix,x.transform.glCoordMatrix),l.aQ(De,De,re.placementViewportMatrix),M.push({circleArray:Se,circleOffset:N,transform:_e.posMatrix,invTransform:De,coord:_e}),D+=Se.length/4,N=D}be&&C.draw(y,E.LINES,Yt.disabled,xi.disabled,x.colorModeForRenderPass(),fi.disabled,{u_matrix:_e.posMatrix,u_pixel_extrude_scale:[1/(z=x.transform).width,1/z.height]},x.style.map.terrain&&x.style.map.terrain.getTerrainData(_e),d.id,be.layoutVertexBuffer,be.indexBuffer,be.segments,null,x.transform.zoom,null,null,be.collisionVertexBuffer)}var z;if(!m||!M.length)return;const H=x.useProgram("collisionCircle"),Y=new l.aR;Y.resize(4*D),Y._trim();let K=0;for(const fe of M)for(let _e=0;_e<fe.circleArray.length/4;_e++){const re=4*_e,be=fe.circleArray[re+0],Se=fe.circleArray[re+1],De=fe.circleArray[re+2],Xe=fe.circleArray[re+3];Y.emplace(K++,be,Se,De,Xe,0),Y.emplace(K++,be,Se,De,Xe,1),Y.emplace(K++,be,Se,De,Xe,2),Y.emplace(K++,be,Se,De,Xe,3)}(!Bn||Bn.length<2*D)&&(Bn=(function(fe){const _e=2*fe,re=new l.aT;re.resize(_e),re._trim();for(let be=0;be<_e;be++){const Se=6*be;re.uint16[Se+0]=4*be+0,re.uint16[Se+1]=4*be+1,re.uint16[Se+2]=4*be+2,re.uint16[Se+3]=4*be+2,re.uint16[Se+4]=4*be+3,re.uint16[Se+5]=4*be+0}return re})(D));const oe=y.createIndexBuffer(Bn,!0),he=y.createVertexBuffer(Y,l.aS.members,!0);for(const fe of M){const _e=Dn(fe.transform,fe.invTransform,x.transform);H.draw(y,E.TRIANGLES,Yt.disabled,xi.disabled,x.colorModeForRenderPass(),fi.disabled,_e,x.style.map.terrain&&x.style.map.terrain.getTerrainData(fe.coord),d.id,he,oe,l.a0.simpleSegment(0,2*fe.circleOffset,fe.circleArray.length,fe.circleArray.length/2),null,x.transform.zoom,null,null,null)}he.destroy(),oe.destroy()}fi.disabled=new fi(!1,1029,2305),fi.backCCW=new fi(!0,1029,2305);const ua=l.an(new Float32Array(16));function Kc(x,n,d,p,m,y){const{horizontalAlign:E,verticalAlign:C}=l.au(x);return new l.P((-(E-.5)*n/m+p[0])*y,(-(C-.5)*d/m+p[1])*y)}function Nn(x,n,d,p,m,y){const E=n.tileAnchorPoint.add(new l.P(n.translation[0],n.translation[1]));if(n.pitchWithMap){let C=p.mult(y);d||(C=C.rotate(-m));const M=E.add(C);return le(M.x,M.y,n.labelPlaneMatrix,n.getElevation).point}if(d){const C=ze(n.tileAnchorPoint.x+1,n.tileAnchorPoint.y,n).point.sub(x),M=Math.atan(C.y/C.x)+(C.x<0?Math.PI:0);return x.add(p.rotate(M))}return x.add(p)}function ho(x,n,d,p,m,y,E,C,M,D,N,z,H,Y){const K=x.text.placedSymbolArray,oe=x.text.dynamicLayoutVertexArray,he=x.icon.dynamicLayoutVertexArray,fe={};oe.clear();for(let _e=0;_e<K.length;_e++){const re=K.get(_e),be=re.hidden||!re.crossTileID||x.allowVerticalPlacement&&!re.placedOrientation?null:p[re.crossTileID];if(be){const Se=new l.P(re.anchorX,re.anchorY),De={getElevation:Y,width:m.width,height:m.height,labelPlaneMatrix:y,pitchWithMap:d,projection:N,tileAnchorPoint:Se,translation:z,unwrappedTileID:H},Xe=d?le(Se.x,Se.y,E,Y):ze(Se.x,Se.y,De),rt=B(m.cameraToCenterDistance,Xe.signedDistanceFromCamera);let dt=l.ai(x.textSizeData,M,re)*rt/l.ap;d&&(dt*=x.tilePixelRatio/C);const{width:yt,height:lt,anchor:at,textOffset:At,textBoxScale:jt}=be,ct=Kc(at,yt,lt,At,jt,dt),gt=N.getPitchedTextCorrection(m,Se.add(new l.P(z[0],z[1])),H),Ut=Nn(Xe.point,De,n,ct,m.angle,gt),Si=x.allowVerticalPlacement&&re.placedOrientation===l.ah.vertical?Math.PI/2:0;for(let Xt=0;Xt<re.numGlyphs;Xt++)l.aj(oe,Ut,Si);D&&re.associatedIconIndex>=0&&(fe[re.associatedIconIndex]={shiftedAnchor:Ut,angle:Si})}else Dt(re.numGlyphs,oe)}if(D){he.clear();const _e=x.icon.placedSymbolArray;for(let re=0;re<_e.length;re++){const be=_e.get(re);if(be.hidden)Dt(be.numGlyphs,he);else{const Se=fe[re];if(Se)for(let De=0;De<be.numGlyphs;De++)l.aj(he,Se.shiftedAnchor,Se.angle);else Dt(be.numGlyphs,he)}}x.icon.dynamicLayoutVertexBuffer.updateData(he)}x.text.dynamicLayoutVertexBuffer.updateData(oe)}function cs(x,n,d){return d.iconsInText&&n?"symbolTextAndIcon":x?"symbolSDF":"symbolIcon"}function Jc(x,n,d,p,m,y,E,C,M,D,N,z){const H=x.context,Y=H.gl,K=x.transform,oe=Rn(),he=C==="map",fe=M==="map",_e=C!=="viewport"&&d.layout.get("symbol-placement")!=="point",re=he&&!fe&&!_e,be=!fe&&_e,Se=!d.layout.get("symbol-sort-key").isConstant();let De=!1;const Xe=x.depthModeForSublayer(0,Yt.ReadOnly),rt=d._unevaluatedLayout.hasValue("text-variable-anchor")||d._unevaluatedLayout.hasValue("text-variable-anchor-offset"),dt=[],yt=oe.getCircleRadiusCorrection(K);for(const lt of p){const at=n.getTile(lt),At=at.getBucket(d);if(!At)continue;const jt=m?At.text:At.icon;if(!jt||!jt.segments.get().length||!jt.hasVisibleVertices)continue;const ct=jt.programConfigurations.get(d.id),gt=m||At.sdfIcons,Ut=m?At.textSizeData:At.iconSizeData,Si=fe||K.pitch!==0,Xt=x.useProgram(cs(gt,m,At),ct),Qt=l.ag(Ut,K.zoom),Ai=x.style.map.terrain&&x.style.map.terrain.getTerrainData(lt);let gr,As,Ei,Fr,Ar=[0,0],mr=null;if(m)As=at.glyphAtlasTexture,Ei=Y.LINEAR,gr=at.glyphAtlasTexture.size,At.iconsInText&&(Ar=at.imageAtlasTexture.size,mr=at.imageAtlasTexture,Fr=Si||x.options.rotating||x.options.zooming||Ut.kind==="composite"||Ut.kind==="camera"?Y.LINEAR:Y.NEAREST);else{const ti=d.layout.get("icon-size").constantOr(0)!==1||At.iconsNeedLinear;As=at.imageAtlasTexture,Ei=gt||x.options.rotating||x.options.zooming||ti||Si?Y.LINEAR:Y.NEAREST,gr=at.imageAtlasTexture.size}const Er=Jt(at,1,x.transform.zoom),Ws=be?lt.posMatrix:ua,Io=Us(Ws,fe,he,x.transform,Er),Dl=as(Ws,fe,he,x.transform,Er),Co=as(lt.posMatrix,fe,he,x.transform,Er),ds=oe.translatePosition(x.transform,at,y,E),Ol=rt&&At.hasTextData(),Tu=d.layout.get("icon-text-fit")!=="none"&&Ol&&At.hasIconData();if(_e){const ti=x.style.map.terrain?(Po,Mo)=>x.style.map.terrain.getElevation(lt,Po,Mo):null,$n=d.layout.get("text-rotation-alignment")==="map";q(At,lt.posMatrix,x,m,Io,Co,fe,D,$n,oe,lt.toUnwrapped(),K.width,K.height,ds,ti)}const fs=lt.posMatrix,ps=m&&rt||Tu,pn=_e||ps?ua:Io,Es=Dl,cr=gt&&d.paint.get(m?"text-halo-width":"icon-halo-width").constantOr(1)!==0;let _r;_r=gt?At.iconsInText?Uc(Ut.kind,Qt,re,fe,_e,ps,x,fs,pn,Es,ds,gr,Ar,yt):aa(Ut.kind,Qt,re,fe,_e,ps,x,fs,pn,Es,ds,m,gr,!0,yt):Gh(Ut.kind,Qt,re,fe,_e,ps,x,fs,pn,Es,ds,m,gr,yt);const ts={program:Xt,buffers:jt,uniformValues:_r,atlasTexture:As,atlasTextureIcon:mr,atlasInterpolation:Ei,atlasInterpolationIcon:Fr,isSDF:gt,hasHalo:cr};if(Se&&At.canOverlap){De=!0;const ti=jt.segments.get();for(const $n of ti)dt.push({segments:new l.a0([$n]),sortKey:$n.sortKey,state:ts,terrainData:Ai})}else dt.push({segments:jt.segments,sortKey:0,state:ts,terrainData:Ai})}De&&dt.sort(((lt,at)=>lt.sortKey-at.sortKey));for(const lt of dt){const at=lt.state;if(H.activeTexture.set(Y.TEXTURE0),at.atlasTexture.bind(at.atlasInterpolation,Y.CLAMP_TO_EDGE),at.atlasTextureIcon&&(H.activeTexture.set(Y.TEXTURE1),at.atlasTextureIcon&&at.atlasTextureIcon.bind(at.atlasInterpolationIcon,Y.CLAMP_TO_EDGE)),at.isSDF){const At=at.uniformValues;at.hasHalo&&(At.u_is_halo=1,Qc(at.buffers,lt.segments,d,x,at.program,Xe,N,z,At,lt.terrainData)),At.u_is_halo=0}Qc(at.buffers,lt.segments,d,x,at.program,Xe,N,z,at.uniformValues,lt.terrainData)}}function Qc(x,n,d,p,m,y,E,C,M,D){const N=p.context;m.draw(N,N.gl.TRIANGLES,y,E,C,fi.disabled,M,D,d.id,x.layoutVertexBuffer,x.indexBuffer,n,d.paint,p.transform.zoom,x.programConfigurations.get(d.id),x.dynamicLayoutVertexBuffer,x.opacityVertexBuffer)}function eu(x,n,d,p){const m=x.context,y=m.gl,E=xi.disabled,C=new Ui([y.ONE,y.ONE],l.aM.transparent,[!0,!0,!0,!0]),M=n.getBucket(d);if(!M)return;const D=p.key;let N=d.heatmapFbos.get(D);N||(N=ha(m,n.tileSize,n.tileSize),d.heatmapFbos.set(D,N)),m.bindFramebuffer.set(N.framebuffer),m.viewport.set([0,0,n.tileSize,n.tileSize]),m.clear({color:l.aM.transparent});const z=M.programConfigurations.get(d.id),H=x.useProgram("heatmap",z),Y=x.style.map.terrain.getTerrainData(p);H.draw(m,y.TRIANGLES,Yt.disabled,E,C,fi.disabled,Lr(p.posMatrix,n,x.transform.zoom,d.paint.get("heatmap-intensity")),Y,d.id,M.layoutVertexBuffer,M.indexBuffer,M.segments,d.paint,x.transform.zoom,z)}function zn(x,n,d){const p=x.context,m=p.gl;p.setColorMode(x.colorModeForRenderPass());const y=da(p,n),E=d.key,C=n.heatmapFbos.get(E);C&&(p.activeTexture.set(m.TEXTURE0),m.bindTexture(m.TEXTURE_2D,C.colorAttachment.get()),p.activeTexture.set(m.TEXTURE1),y.bind(m.LINEAR,m.CLAMP_TO_EDGE),x.useProgram("heatmapTexture").draw(p,m.TRIANGLES,Yt.disabled,xi.disabled,x.colorModeForRenderPass(),fi.disabled,ol(x,n,0,1),null,n.id,x.rasterBoundsBuffer,x.quadTriangleIndexBuffer,x.rasterBoundsSegments,n.paint,x.transform.zoom),C.destroy(),n.heatmapFbos.delete(E))}function ha(x,n,d){var p,m;const y=x.gl,E=y.createTexture();y.bindTexture(y.TEXTURE_2D,E),y.texParameteri(y.TEXTURE_2D,y.TEXTURE_WRAP_S,y.CLAMP_TO_EDGE),y.texParameteri(y.TEXTURE_2D,y.TEXTURE_WRAP_T,y.CLAMP_TO_EDGE),y.texParameteri(y.TEXTURE_2D,y.TEXTURE_MIN_FILTER,y.LINEAR),y.texParameteri(y.TEXTURE_2D,y.TEXTURE_MAG_FILTER,y.LINEAR);const C=(p=x.HALF_FLOAT)!==null&&p!==void 0?p:y.UNSIGNED_BYTE,M=(m=x.RGBA16F)!==null&&m!==void 0?m:y.RGBA;y.texImage2D(y.TEXTURE_2D,0,M,n,d,0,y.RGBA,C,null);const D=x.createFramebuffer(n,d,!1,!1);return D.colorAttachment.set(E),D}function da(x,n){return n.colorRampTexture||(n.colorRampTexture=new Ye(x,n.colorRamp,x.gl.RGBA)),n.colorRampTexture}function fo(x,n,d,p,m){if(!d||!p||!p.imageAtlas)return;const y=p.imageAtlas.patternPositions;let E=y[d.to.toString()],C=y[d.from.toString()];if(!E&&C&&(E=C),!C&&E&&(C=E),!E||!C){const M=m.getPaintProperty(n);E=y[M],C=y[M]}E&&C&&x.setConstantPatternPositions(E,C)}function fa(x,n,d,p,m,y,E){const C=x.context.gl,M="fill-pattern",D=d.paint.get(M),N=D&&D.constantOr(1),z=d.getCrossfadeParameters();let H,Y,K,oe,he;E?(Y=N&&!d.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",H=C.LINES):(Y=N?"fillPattern":"fill",H=C.TRIANGLES);const fe=D.constantOr(null);for(const _e of p){const re=n.getTile(_e);if(N&&!re.patternsLoaded())continue;const be=re.getBucket(d);if(!be)continue;const Se=be.programConfigurations.get(d.id),De=x.useProgram(Y,Se),Xe=x.style.map.terrain&&x.style.map.terrain.getTerrainData(_e);N&&(x.context.activeTexture.set(C.TEXTURE0),re.imageAtlasTexture.bind(C.LINEAR,C.CLAMP_TO_EDGE),Se.updatePaintBuffers(z)),fo(Se,M,fe,re,d);const rt=Xe?_e:null,dt=x.translatePosMatrix(rt?rt.posMatrix:_e.posMatrix,re,d.paint.get("fill-translate"),d.paint.get("fill-translate-anchor"));if(E){oe=be.indexBuffer2,he=be.segments2;const yt=[C.drawingBufferWidth,C.drawingBufferHeight];K=Y==="fillOutlinePattern"&&N?qh(dt,x,z,re,yt):Rp(dt,yt)}else oe=be.indexBuffer,he=be.segments,K=N?Hh(dt,x,z,re):lo(dt);De.draw(x.context,H,m,x.stencilModeForClipping(_e),y,fi.disabled,K,Xe,d.id,be.layoutVertexBuffer,oe,he,d.paint,x.transform.zoom,Se)}}function gl(x,n,d,p,m,y,E){const C=x.context,M=C.gl,D="fill-extrusion-pattern",N=d.paint.get(D),z=N.constantOr(1),H=d.getCrossfadeParameters(),Y=d.paint.get("fill-extrusion-opacity"),K=N.constantOr(null);for(const oe of p){const he=n.getTile(oe),fe=he.getBucket(d);if(!fe)continue;const _e=x.style.map.terrain&&x.style.map.terrain.getTerrainData(oe),re=fe.programConfigurations.get(d.id),be=x.useProgram(z?"fillExtrusionPattern":"fillExtrusion",re);z&&(x.context.activeTexture.set(M.TEXTURE0),he.imageAtlasTexture.bind(M.LINEAR,M.CLAMP_TO_EDGE),re.updatePaintBuffers(H)),fo(re,D,K,he,d);const Se=x.translatePosMatrix(oe.posMatrix,he,d.paint.get("fill-extrusion-translate"),d.paint.get("fill-extrusion-translate-anchor")),De=d.paint.get("fill-extrusion-vertical-gradient"),Xe=z?nl(Se,x,De,Y,oe,H,he):na(Se,x,De,Y);be.draw(C,C.gl.TRIANGLES,m,y,E,fi.backCCW,Xe,_e,d.id,fe.layoutVertexBuffer,fe.indexBuffer,fe.segments,d.paint,x.transform.zoom,re,x.style.map.terrain&&fe.centroidVertexBuffer)}}function po(x,n,d,p,m,y,E){const C=x.context,M=C.gl,D=d.fbo;if(!D)return;const N=x.useProgram("hillshade"),z=x.style.map.terrain&&x.style.map.terrain.getTerrainData(n);C.activeTexture.set(M.TEXTURE0),M.bindTexture(M.TEXTURE_2D,D.colorAttachment.get()),N.draw(C,M.TRIANGLES,m,y,E,fi.disabled,((H,Y,K,oe)=>{const he=K.paint.get("hillshade-shadow-color"),fe=K.paint.get("hillshade-highlight-color"),_e=K.paint.get("hillshade-accent-color");let re=K.paint.get("hillshade-illumination-direction")*(Math.PI/180);K.paint.get("hillshade-illumination-anchor")==="viewport"&&(re-=H.transform.angle);const be=!H.options.moving;return{u_matrix:oe?oe.posMatrix:H.transform.calculatePosMatrix(Y.tileID.toUnwrapped(),be),u_image:0,u_latrange:al(0,Y.tileID),u_light:[K.paint.get("hillshade-exaggeration"),re],u_shadow:he,u_highlight:fe,u_accent:_e}})(x,d,p,z?n:null),z,p.id,x.rasterBoundsBuffer,x.quadTriangleIndexBuffer,x.rasterBoundsSegments)}function go(x,n,d,p,m,y){const E=x.context,C=E.gl,M=n.dem;if(M&&M.data){const D=M.dim,N=M.stride,z=M.getPixels();if(E.activeTexture.set(C.TEXTURE1),E.pixelStoreUnpackPremultiplyAlpha.set(!1),n.demTexture=n.demTexture||x.getTileTexture(N),n.demTexture){const Y=n.demTexture;Y.update(z,{premultiply:!1}),Y.bind(C.NEAREST,C.CLAMP_TO_EDGE)}else n.demTexture=new Ye(E,z,C.RGBA,{premultiply:!1}),n.demTexture.bind(C.NEAREST,C.CLAMP_TO_EDGE);E.activeTexture.set(C.TEXTURE0);let H=n.fbo;if(!H){const Y=new Ye(E,{width:D,height:D,data:null},C.RGBA);Y.bind(C.LINEAR,C.CLAMP_TO_EDGE),H=n.fbo=E.createFramebuffer(D,D,!0,!1),H.colorAttachment.set(Y.texture)}E.bindFramebuffer.set(H.framebuffer),E.viewport.set([0,0,D,D]),x.useProgram("hillshadePrepare").draw(E,C.TRIANGLES,p,m,y,fi.disabled,((Y,K)=>{const oe=K.stride,he=l.H();return l.aP(he,0,l.X,-l.X,0,0,1),l.J(he,he,[0,-l.X,0]),{u_matrix:he,u_image:1,u_dimension:[oe,oe],u_zoom:Y.overscaledZ,u_unpack:K.getUnpackVector()}})(n.tileID,M),null,d.id,x.rasterBoundsBuffer,x.quadTriangleIndexBuffer,x.rasterBoundsSegments),n.needsHillshadePrepare=!1}}function cd(x,n,d,p,m,y){const E=p.paint.get("raster-fade-duration");if(!y&&E>0){const C=S.now(),M=(C-x.timeAdded)/E,D=n?(C-n.timeAdded)/E:-1,N=d.getSource(),z=m.coveringZoomLevel({tileSize:N.tileSize,roundZoom:N.roundZoom}),H=!n||Math.abs(n.tileID.overscaledZ-z)>Math.abs(x.tileID.overscaledZ-z),Y=H&&x.refreshedUponExpiration?1:l.ac(H?M:1-D,0,1);return x.refreshedUponExpiration&&M>=1&&(x.refreshedUponExpiration=!1),n?{opacity:1,mix:1-Y}:{opacity:Y,mix:0}}return{opacity:1,mix:0}}const tu=new l.aM(1,0,0,1),oi=new l.aM(0,1,0,1),ml=new l.aM(0,0,1,1),qp=new l.aM(1,0,1,1),ud=new l.aM(0,1,1,1);function mo(x,n,d,p){_l(x,0,n+d/2,x.transform.width,d,p)}function hd(x,n,d,p){_l(x,n-d/2,0,d,x.transform.height,p)}function _l(x,n,d,p,m,y){const E=x.context,C=E.gl;C.enable(C.SCISSOR_TEST),C.scissor(n*x.pixelRatio,d*x.pixelRatio,p*x.pixelRatio,m*x.pixelRatio),E.clear({color:y}),C.disable(C.SCISSOR_TEST)}function dd(x,n,d){const p=x.context,m=p.gl,y=d.posMatrix,E=x.useProgram("debug"),C=Yt.disabled,M=xi.disabled,D=x.colorModeForRenderPass(),N="$debug",z=x.style.map.terrain&&x.style.map.terrain.getTerrainData(d);p.activeTexture.set(m.TEXTURE0);const H=n.getTileByID(d.key).latestRawTileData,Y=Math.floor((H&&H.byteLength||0)/1024),K=n.getTile(d).tileSize,oe=512/Math.min(K,512)*(d.overscaledZ/x.transform.zoom)*.5;let he=d.canonical.toString();d.overscaledZ!==d.canonical.z&&(he+=` => ${d.overscaledZ}`),(function(fe,_e){fe.initDebugOverlayCanvas();const re=fe.debugOverlayCanvas,be=fe.context.gl,Se=fe.debugOverlayCanvas.getContext("2d");Se.clearRect(0,0,re.width,re.height),Se.shadowColor="white",Se.shadowBlur=2,Se.lineWidth=1.5,Se.strokeStyle="white",Se.textBaseline="top",Se.font="bold 36px Open Sans, sans-serif",Se.fillText(_e,5,5),Se.strokeText(_e,5,5),fe.debugOverlayTexture.update(re),fe.debugOverlayTexture.bind(be.LINEAR,be.CLAMP_TO_EDGE)})(x,`${he} ${Y}kB`),E.draw(p,m.TRIANGLES,C,M,Ui.alphaBlended,fi.disabled,oa(y,l.aM.transparent,oe),null,N,x.debugBuffer,x.quadTriangleIndexBuffer,x.debugSegments),E.draw(p,m.LINE_STRIP,C,M,D,fi.disabled,oa(y,l.aM.red),z,N,x.debugBuffer,x.tileBorderIndexBuffer,x.debugSegments)}function fd(x,n,d){const p=x.context,m=p.gl,y=x.colorModeForRenderPass(),E=new Yt(m.LEQUAL,Yt.ReadWrite,x.depthRangeFor3D),C=x.useProgram("terrain"),M=n.getTerrainMesh();p.bindFramebuffer.set(null),p.viewport.set([0,0,x.width,x.height]);for(const D of d){const N=x.renderToTexture.getTexture(D),z=n.getTerrainData(D.tileID);p.activeTexture.set(m.TEXTURE0),m.bindTexture(m.TEXTURE_2D,N.texture);const H=x.transform.calculatePosMatrix(D.tileID.toUnwrapped()),Y=n.getMeshFrameDelta(x.transform.zoom),K=x.transform.calculateFogMatrix(D.tileID.toUnwrapped()),oe=Nc(H,Y,K,x.style.sky,x.transform.pitch);C.draw(p,m.TRIANGLES,E,xi.disabled,y,fi.backCCW,oe,z,"terrain",M.vertexBuffer,M.indexBuffer,M.segments)}}class yl{constructor(n,d,p){this.vertexBuffer=n,this.indexBuffer=d,this.segments=p}destroy(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.vertexBuffer=null,this.indexBuffer=null,this.segments=null}}class xl{constructor(n,d){this.context=new Hp(n),this.transform=d,this._tileTextures={},this.terrainFacilitator={dirty:!0,matrix:l.an(new Float64Array(16)),renderTime:0},this.setup(),this.numSublayers=Nt.maxUnderzooming+Nt.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.crossTileSymbolIndex=new Fc}resize(n,d,p){if(this.width=Math.floor(n*p),this.height=Math.floor(d*p),this.pixelRatio=p,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(const m of this.style._order)this.style._layers[m].resize()}setup(){const n=this.context,d=new l.aX;d.emplaceBack(0,0),d.emplaceBack(l.X,0),d.emplaceBack(0,l.X),d.emplaceBack(l.X,l.X),this.tileExtentBuffer=n.createVertexBuffer(d,kn.members),this.tileExtentSegments=l.a0.simpleSegment(0,0,4,2);const p=new l.aX;p.emplaceBack(0,0),p.emplaceBack(l.X,0),p.emplaceBack(0,l.X),p.emplaceBack(l.X,l.X),this.debugBuffer=n.createVertexBuffer(p,kn.members),this.debugSegments=l.a0.simpleSegment(0,0,4,5);const m=new l.$;m.emplaceBack(0,0,0,0),m.emplaceBack(l.X,0,l.X,0),m.emplaceBack(0,l.X,0,l.X),m.emplaceBack(l.X,l.X,l.X,l.X),this.rasterBoundsBuffer=n.createVertexBuffer(m,Ns.members),this.rasterBoundsSegments=l.a0.simpleSegment(0,0,4,2);const y=new l.aX;y.emplaceBack(0,0),y.emplaceBack(1,0),y.emplaceBack(0,1),y.emplaceBack(1,1),this.viewportBuffer=n.createVertexBuffer(y,kn.members),this.viewportSegments=l.a0.simpleSegment(0,0,4,2);const E=new l.aZ;E.emplaceBack(0),E.emplaceBack(1),E.emplaceBack(3),E.emplaceBack(2),E.emplaceBack(0),this.tileBorderIndexBuffer=n.createIndexBuffer(E);const C=new l.aY;C.emplaceBack(0,1,2),C.emplaceBack(2,1,3),this.quadTriangleIndexBuffer=n.createIndexBuffer(C);const M=this.context.gl;this.stencilClearMode=new xi({func:M.ALWAYS,mask:0},0,255,M.ZERO,M.ZERO,M.ZERO)}clearStencil(){const n=this.context,d=n.gl;this.nextStencilID=1,this.currentStencilSource=void 0;const p=l.H();l.aP(p,0,this.width,this.height,0,0,1),l.K(p,p,[d.drawingBufferWidth,d.drawingBufferHeight,0]),this.useProgram("clippingMask").draw(n,d.TRIANGLES,Yt.disabled,this.stencilClearMode,Ui.disabled,fi.disabled,Or(p),null,"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}_renderTileClippingMasks(n,d){if(this.currentStencilSource===n.source||!n.isTileClipped()||!d||!d.length)return;this.currentStencilSource=n.source;const p=this.context,m=p.gl;this.nextStencilID+d.length>256&&this.clearStencil(),p.setColorMode(Ui.disabled),p.setDepthMode(Yt.disabled);const y=this.useProgram("clippingMask");this._tileClippingMaskIDs={};for(const E of d){const C=this._tileClippingMaskIDs[E.key]=this.nextStencilID++,M=this.style.map.terrain&&this.style.map.terrain.getTerrainData(E);y.draw(p,m.TRIANGLES,Yt.disabled,new xi({func:m.ALWAYS,mask:0},C,255,m.KEEP,m.KEEP,m.REPLACE),Ui.disabled,fi.disabled,Or(E.posMatrix),M,"$clipping",this.tileExtentBuffer,this.quadTriangleIndexBuffer,this.tileExtentSegments)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();const n=this.nextStencilID++,d=this.context.gl;return new xi({func:d.NOTEQUAL,mask:255},n,255,d.KEEP,d.KEEP,d.REPLACE)}stencilModeForClipping(n){const d=this.context.gl;return new xi({func:d.EQUAL,mask:255},this._tileClippingMaskIDs[n.key],0,d.KEEP,d.KEEP,d.REPLACE)}stencilConfigForOverlap(n){const d=this.context.gl,p=n.sort(((E,C)=>C.overscaledZ-E.overscaledZ)),m=p[p.length-1].overscaledZ,y=p[0].overscaledZ-m+1;if(y>1){this.currentStencilSource=void 0,this.nextStencilID+y>256&&this.clearStencil();const E={};for(let C=0;C<y;C++)E[C+m]=new xi({func:d.GEQUAL,mask:255},C+this.nextStencilID,255,d.KEEP,d.KEEP,d.REPLACE);return this.nextStencilID+=y,[E,p]}return[{[m]:xi.disabled},p]}colorModeForRenderPass(){const n=this.context.gl;return this._showOverdrawInspector?new Ui([n.CONSTANT_COLOR,n.ONE],new l.aM(.125,.125,.125,0),[!0,!0,!0,!0]):this.renderPass==="opaque"?Ui.unblended:Ui.alphaBlended}depthModeForSublayer(n,d,p){if(!this.opaquePassEnabledForLayer())return Yt.disabled;const m=1-((1+this.currentLayer)*this.numSublayers+n)*this.depthEpsilon;return new Yt(p||this.context.gl.LEQUAL,d,[m,m])}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}render(n,d){this.style=n,this.options=d,this.lineAtlas=n.lineAtlas,this.imageManager=n.imageManager,this.glyphManager=n.glyphManager,this.symbolFadeChange=n.placement.symbolFadeChange(S.now()),this.imageManager.beginFrame();const p=this.style._order,m=this.style.sourceCaches,y={},E={},C={};for(const M in m){const D=m[M];D.used&&D.prepare(this.context),y[M]=D.getVisibleCoordinates(),E[M]=y[M].slice().reverse(),C[M]=D.getVisibleCoordinates(!0).reverse()}this.opaquePassCutoff=1/0;for(let M=0;M<p.length;M++)if(this.style._layers[p[M]].is3D()){this.opaquePassCutoff=M;break}this.maybeDrawDepthAndCoords(!1),this.renderToTexture&&(this.renderToTexture.prepareForRender(this.style,this.transform.zoom),this.opaquePassCutoff=0),this.renderPass="offscreen";for(const M of p){const D=this.style._layers[M];if(!D.hasOffscreenPass()||D.isHidden(this.transform.zoom))continue;const N=E[D.source];(D.type==="custom"||N.length)&&this.renderLayer(this,m[D.source],D,N)}if(this.context.bindFramebuffer.set(null),this.context.clear({color:d.showOverdrawInspector?l.aM.black:l.aM.transparent,depth:1}),this.clearStencil(),this.style.sky&&(function(M,D){const N=M.context,z=N.gl,H=((fe,_e,re)=>({u_sky_color:fe.properties.get("sky-color"),u_horizon_color:fe.properties.get("horizon-color"),u_horizon:(_e.height/2+_e.getHorizon())*re,u_sky_horizon_blend:fe.properties.get("sky-horizon-blend")*_e.height/2*re}))(D,M.style.map.transform,M.pixelRatio),Y=new Yt(z.LEQUAL,Yt.ReadWrite,[0,1]),K=xi.disabled,oe=M.colorModeForRenderPass(),he=M.useProgram("sky");if(!D.mesh){const fe=new l.aX;fe.emplaceBack(-1,-1),fe.emplaceBack(1,-1),fe.emplaceBack(1,1),fe.emplaceBack(-1,1);const _e=new l.aY;_e.emplaceBack(0,1,2),_e.emplaceBack(0,2,3),D.mesh=new yl(N.createVertexBuffer(fe,kn.members),N.createIndexBuffer(_e),l.a0.simpleSegment(0,0,fe.length,_e.length))}he.draw(N,z.TRIANGLES,Y,K,oe,fi.disabled,H,void 0,"sky",D.mesh.vertexBuffer,D.mesh.indexBuffer,D.mesh.segments)})(this,this.style.sky),this._showOverdrawInspector=d.showOverdrawInspector,this.depthRangeFor3D=[0,1-(n._order.length+2)*this.numSublayers*this.depthEpsilon],!this.renderToTexture)for(this.renderPass="opaque",this.currentLayer=p.length-1;this.currentLayer>=0;this.currentLayer--){const M=this.style._layers[p[this.currentLayer]],D=m[M.source],N=y[M.source];this._renderTileClippingMasks(M,N),this.renderLayer(this,D,M,N)}for(this.renderPass="translucent",this.currentLayer=0;this.currentLayer<p.length;this.currentLayer++){const M=this.style._layers[p[this.currentLayer]],D=m[M.source];if(this.renderToTexture&&this.renderToTexture.renderLayer(M))continue;const N=(M.type==="symbol"?C:E)[M.source];this._renderTileClippingMasks(M,y[M.source]),this.renderLayer(this,D,M,N)}if(this.options.showTileBoundaries){const M=(function(D,N){let z=null;const H=Object.values(D._layers).flatMap((he=>he.source&&!he.isHidden(N)?[D.sourceCaches[he.source]]:[])),Y=H.filter((he=>he.getSource().type==="vector")),K=H.filter((he=>he.getSource().type!=="vector")),oe=he=>{(!z||z.getSource().maxzoom<he.getSource().maxzoom)&&(z=he)};return Y.forEach((he=>oe(he))),z||K.forEach((he=>oe(he))),z})(this.style,this.transform.zoom);M&&(function(D,N,z){for(let H=0;H<z.length;H++)dd(D,N,z[H])})(this,M,M.getVisibleCoordinates())}this.options.showPadding&&(function(M){const D=M.transform.padding;mo(M,M.transform.height-(D.top||0),3,tu),mo(M,D.bottom||0,3,oi),hd(M,D.left||0,3,ml),hd(M,M.transform.width-(D.right||0),3,qp);const N=M.transform.centerPoint;(function(z,H,Y,K){_l(z,H-1,Y-10,2,20,K),_l(z,H-10,Y-1,20,2,K)})(M,N.x,M.transform.height-N.y,ud)})(this),this.context.setDefault()}maybeDrawDepthAndCoords(n){if(!this.style||!this.style.map||!this.style.map.terrain)return;const d=this.terrainFacilitator.matrix,p=this.transform.modelViewProjectionMatrix;let m=this.terrainFacilitator.dirty;m||(m=n?!l.a_(d,p):!l.a$(d,p)),m||(m=this.style.map.terrain.sourceCache.tilesAfterTime(this.terrainFacilitator.renderTime).length>0),m&&(l.b0(d,p),this.terrainFacilitator.renderTime=Date.now(),this.terrainFacilitator.dirty=!1,(function(y,E){const C=y.context,M=C.gl,D=Ui.unblended,N=new Yt(M.LEQUAL,Yt.ReadWrite,[0,1]),z=E.getTerrainMesh(),H=E.sourceCache.getRenderableTiles(),Y=y.useProgram("terrainDepth");C.bindFramebuffer.set(E.getFramebuffer("depth").framebuffer),C.viewport.set([0,0,y.width/devicePixelRatio,y.height/devicePixelRatio]),C.clear({color:l.aM.transparent,depth:1});for(const K of H){const oe=E.getTerrainData(K.tileID),he={u_matrix:y.transform.calculatePosMatrix(K.tileID.toUnwrapped()),u_ele_delta:E.getMeshFrameDelta(y.transform.zoom)};Y.draw(C,M.TRIANGLES,N,xi.disabled,D,fi.backCCW,he,oe,"terrain",z.vertexBuffer,z.indexBuffer,z.segments)}C.bindFramebuffer.set(null),C.viewport.set([0,0,y.width,y.height])})(this,this.style.map.terrain),(function(y,E){const C=y.context,M=C.gl,D=Ui.unblended,N=new Yt(M.LEQUAL,Yt.ReadWrite,[0,1]),z=E.getTerrainMesh(),H=E.getCoordsTexture(),Y=E.sourceCache.getRenderableTiles(),K=y.useProgram("terrainCoords");C.bindFramebuffer.set(E.getFramebuffer("coords").framebuffer),C.viewport.set([0,0,y.width/devicePixelRatio,y.height/devicePixelRatio]),C.clear({color:l.aM.transparent,depth:1}),E.coordsIndex=[];for(const oe of Y){const he=E.getTerrainData(oe.tileID);C.activeTexture.set(M.TEXTURE0),M.bindTexture(M.TEXTURE_2D,H.texture);const fe={u_matrix:y.transform.calculatePosMatrix(oe.tileID.toUnwrapped()),u_terrain_coords_id:(255-E.coordsIndex.length)/255,u_texture:0,u_ele_delta:E.getMeshFrameDelta(y.transform.zoom)};K.draw(C,M.TRIANGLES,N,xi.disabled,D,fi.backCCW,fe,he,"terrain",z.vertexBuffer,z.indexBuffer,z.segments),E.coordsIndex.push(oe.tileID.key)}C.bindFramebuffer.set(null),C.viewport.set([0,0,y.width,y.height])})(this,this.style.map.terrain))}renderLayer(n,d,p,m){if(!p.isHidden(this.transform.zoom)&&(p.type==="background"||p.type==="custom"||(m||[]).length))switch(this.id=p.id,p.type){case"symbol":(function(y,E,C,M,D){if(y.renderPass!=="translucent")return;const N=xi.disabled,z=y.colorModeForRenderPass();(C._unevaluatedLayout.hasValue("text-variable-anchor")||C._unevaluatedLayout.hasValue("text-variable-anchor-offset"))&&(function(H,Y,K,oe,he,fe,_e,re,be){const Se=Y.transform,De=Rn(),Xe=he==="map",rt=fe==="map";for(const dt of H){const yt=oe.getTile(dt),lt=yt.getBucket(K);if(!lt||!lt.text||!lt.text.segments.get().length)continue;const at=l.ag(lt.textSizeData,Se.zoom),At=Jt(yt,1,Y.transform.zoom),jt=Us(dt.posMatrix,rt,Xe,Y.transform,At),ct=K.layout.get("icon-text-fit")!=="none"&&lt.hasIconData();if(at){const gt=Math.pow(2,Se.zoom-yt.tileID.overscaledZ),Ut=Y.style.map.terrain?(Xt,Qt)=>Y.style.map.terrain.getElevation(dt,Xt,Qt):null,Si=De.translatePosition(Se,yt,_e,re);ho(lt,Xe,rt,be,Se,jt,dt.posMatrix,gt,at,ct,De,Si,dt.toUnwrapped(),Ut)}}})(M,y,C,E,C.layout.get("text-rotation-alignment"),C.layout.get("text-pitch-alignment"),C.paint.get("text-translate"),C.paint.get("text-translate-anchor"),D),C.paint.get("icon-opacity").constantOr(1)!==0&&Jc(y,E,C,M,!1,C.paint.get("icon-translate"),C.paint.get("icon-translate-anchor"),C.layout.get("icon-rotation-alignment"),C.layout.get("icon-pitch-alignment"),C.layout.get("icon-keep-upright"),N,z),C.paint.get("text-opacity").constantOr(1)!==0&&Jc(y,E,C,M,!0,C.paint.get("text-translate"),C.paint.get("text-translate-anchor"),C.layout.get("text-rotation-alignment"),C.layout.get("text-pitch-alignment"),C.layout.get("text-keep-upright"),N,z),E.map.showCollisionBoxes&&(ca(y,E,C,M,!0),ca(y,E,C,M,!1))})(n,d,p,m,this.style.placement.variableOffsets);break;case"circle":(function(y,E,C,M){if(y.renderPass!=="translucent")return;const D=C.paint.get("circle-opacity"),N=C.paint.get("circle-stroke-width"),z=C.paint.get("circle-stroke-opacity"),H=!C.layout.get("circle-sort-key").isConstant();if(D.constantOr(1)===0&&(N.constantOr(1)===0||z.constantOr(1)===0))return;const Y=y.context,K=Y.gl,oe=y.depthModeForSublayer(0,Yt.ReadOnly),he=xi.disabled,fe=y.colorModeForRenderPass(),_e=[];for(let re=0;re<M.length;re++){const be=M[re],Se=E.getTile(be),De=Se.getBucket(C);if(!De)continue;const Xe=De.programConfigurations.get(C.id),rt=y.useProgram("circle",Xe),dt=De.layoutVertexBuffer,yt=De.indexBuffer,lt=y.style.map.terrain&&y.style.map.terrain.getTerrainData(be),at={programConfiguration:Xe,program:rt,layoutVertexBuffer:dt,indexBuffer:yt,uniformValues:kp(y,be,Se,C),terrainData:lt};if(H){const At=De.segments.get();for(const jt of At)_e.push({segments:new l.a0([jt]),sortKey:jt.sortKey,state:at})}else _e.push({segments:De.segments,sortKey:0,state:at})}H&&_e.sort(((re,be)=>re.sortKey-be.sortKey));for(const re of _e){const{programConfiguration:be,program:Se,layoutVertexBuffer:De,indexBuffer:Xe,uniformValues:rt,terrainData:dt}=re.state;Se.draw(Y,K.TRIANGLES,oe,he,fe,fi.disabled,rt,dt,C.id,De,Xe,re.segments,C.paint,y.transform.zoom,be)}})(n,d,p,m);break;case"heatmap":(function(y,E,C,M){if(C.paint.get("heatmap-opacity")===0)return;const D=y.context;if(y.style.map.terrain){for(const N of M){const z=E.getTile(N);E.hasRenderableParent(N)||(y.renderPass==="offscreen"?eu(y,z,C,N):y.renderPass==="translucent"&&zn(y,C,N))}D.viewport.set([0,0,y.width,y.height])}else y.renderPass==="offscreen"?(function(N,z,H,Y){const K=N.context,oe=K.gl,he=xi.disabled,fe=new Ui([oe.ONE,oe.ONE],l.aM.transparent,[!0,!0,!0,!0]);(function(_e,re,be){const Se=_e.gl;_e.activeTexture.set(Se.TEXTURE1),_e.viewport.set([0,0,re.width/4,re.height/4]);let De=be.heatmapFbos.get(l.aU);De?(Se.bindTexture(Se.TEXTURE_2D,De.colorAttachment.get()),_e.bindFramebuffer.set(De.framebuffer)):(De=ha(_e,re.width/4,re.height/4),be.heatmapFbos.set(l.aU,De))})(K,N,H),K.clear({color:l.aM.transparent});for(let _e=0;_e<Y.length;_e++){const re=Y[_e];if(z.hasRenderableParent(re))continue;const be=z.getTile(re),Se=be.getBucket(H);if(!Se)continue;const De=Se.programConfigurations.get(H.id),Xe=N.useProgram("heatmap",De),{zoom:rt}=N.transform;Xe.draw(K,oe.TRIANGLES,Yt.disabled,he,fe,fi.disabled,Lr(re.posMatrix,be,rt,H.paint.get("heatmap-intensity")),null,H.id,Se.layoutVertexBuffer,Se.indexBuffer,Se.segments,H.paint,N.transform.zoom,De)}K.viewport.set([0,0,N.width,N.height])})(y,E,C,M):y.renderPass==="translucent"&&(function(N,z){const H=N.context,Y=H.gl;H.setColorMode(N.colorModeForRenderPass());const K=z.heatmapFbos.get(l.aU);K&&(H.activeTexture.set(Y.TEXTURE0),Y.bindTexture(Y.TEXTURE_2D,K.colorAttachment.get()),H.activeTexture.set(Y.TEXTURE1),da(H,z).bind(Y.LINEAR,Y.CLAMP_TO_EDGE),N.useProgram("heatmapTexture").draw(H,Y.TRIANGLES,Yt.disabled,xi.disabled,N.colorModeForRenderPass(),fi.disabled,ol(N,z,0,1),null,z.id,N.viewportBuffer,N.quadTriangleIndexBuffer,N.viewportSegments,z.paint,N.transform.zoom))})(y,C)})(n,d,p,m);break;case"line":(function(y,E,C,M){if(y.renderPass!=="translucent")return;const D=C.paint.get("line-opacity"),N=C.paint.get("line-width");if(D.constantOr(1)===0||N.constantOr(1)===0)return;const z=y.depthModeForSublayer(0,Yt.ReadOnly),H=y.colorModeForRenderPass(),Y=C.paint.get("line-dasharray"),K=C.paint.get("line-pattern"),oe=K.constantOr(1),he=C.paint.get("line-gradient"),fe=C.getCrossfadeParameters(),_e=oe?"linePattern":Y?"lineSDF":he?"lineGradient":"line",re=y.context,be=re.gl;let Se=!0;for(const De of M){const Xe=E.getTile(De);if(oe&&!Xe.patternsLoaded())continue;const rt=Xe.getBucket(C);if(!rt)continue;const dt=rt.programConfigurations.get(C.id),yt=y.context.program.get(),lt=y.useProgram(_e,dt),at=Se||lt.program!==yt,At=y.style.map.terrain&&y.style.map.terrain.getTerrainData(De),jt=K.constantOr(null);if(jt&&Xe.imageAtlas){const Ut=Xe.imageAtlas,Si=Ut.patternPositions[jt.to.toString()],Xt=Ut.patternPositions[jt.from.toString()];Si&&Xt&&dt.setConstantPatternPositions(Si,Xt)}const ct=At?De:null,gt=oe?co(y,Xe,C,fe,ct):Y?Dp(y,Xe,C,Y,fe,ct):he?Xh(y,Xe,C,rt.lineClipsArray.length,ct):ll(y,Xe,C,ct);if(oe)re.activeTexture.set(be.TEXTURE0),Xe.imageAtlasTexture.bind(be.LINEAR,be.CLAMP_TO_EDGE),dt.updatePaintBuffers(fe);else if(Y&&(at||y.lineAtlas.dirty))re.activeTexture.set(be.TEXTURE0),y.lineAtlas.bind(re);else if(he){const Ut=rt.gradients[C.id];let Si=Ut.texture;if(C.gradientVersion!==Ut.version){let Xt=256;if(C.stepInterpolant){const Qt=E.getSource().maxzoom,Ai=De.canonical.z===Qt?Math.ceil(1<<y.transform.maxZoom-De.canonical.z):1;Xt=l.ac(l.aV(rt.maxLineLength/l.X*1024*Ai),256,re.maxTextureSize)}Ut.gradient=l.aW({expression:C.gradientExpression(),evaluationKey:"lineProgress",resolution:Xt,image:Ut.gradient||void 0,clips:rt.lineClipsArray}),Ut.texture?Ut.texture.update(Ut.gradient):Ut.texture=new Ye(re,Ut.gradient,be.RGBA),Ut.version=C.gradientVersion,Si=Ut.texture}re.activeTexture.set(be.TEXTURE0),Si.bind(C.stepInterpolant?be.NEAREST:be.LINEAR,be.CLAMP_TO_EDGE)}lt.draw(re,be.TRIANGLES,z,y.stencilModeForClipping(De),H,fi.disabled,gt,At,C.id,rt.layoutVertexBuffer,rt.indexBuffer,rt.segments,C.paint,y.transform.zoom,dt,rt.layoutVertexBuffer2),Se=!1}})(n,d,p,m);break;case"fill":(function(y,E,C,M){const D=C.paint.get("fill-color"),N=C.paint.get("fill-opacity");if(N.constantOr(1)===0)return;const z=y.colorModeForRenderPass(),H=C.paint.get("fill-pattern"),Y=y.opaquePassEnabledForLayer()&&!H.constantOr(1)&&D.constantOr(l.aM.transparent).a===1&&N.constantOr(0)===1?"opaque":"translucent";if(y.renderPass===Y){const K=y.depthModeForSublayer(1,y.renderPass==="opaque"?Yt.ReadWrite:Yt.ReadOnly);fa(y,E,C,M,K,z,!1)}if(y.renderPass==="translucent"&&C.paint.get("fill-antialias")){const K=y.depthModeForSublayer(C.getPaintProperty("fill-outline-color")?2:0,Yt.ReadOnly);fa(y,E,C,M,K,z,!0)}})(n,d,p,m);break;case"fill-extrusion":(function(y,E,C,M){const D=C.paint.get("fill-extrusion-opacity");if(D!==0&&y.renderPass==="translucent"){const N=new Yt(y.context.gl.LEQUAL,Yt.ReadWrite,y.depthRangeFor3D);if(D!==1||C.paint.get("fill-extrusion-pattern").constantOr(1))gl(y,E,C,M,N,xi.disabled,Ui.disabled),gl(y,E,C,M,N,y.stencilModeFor3D(),y.colorModeForRenderPass());else{const z=y.colorModeForRenderPass();gl(y,E,C,M,N,xi.disabled,z)}}})(n,d,p,m);break;case"hillshade":(function(y,E,C,M){if(y.renderPass!=="offscreen"&&y.renderPass!=="translucent")return;const D=y.context,N=y.depthModeForSublayer(0,Yt.ReadOnly),z=y.colorModeForRenderPass(),[H,Y]=y.renderPass==="translucent"?y.stencilConfigForOverlap(M):[{},M];for(const K of Y){const oe=E.getTile(K);oe.needsHillshadePrepare!==void 0&&oe.needsHillshadePrepare&&y.renderPass==="offscreen"?go(y,oe,C,N,xi.disabled,z):y.renderPass==="translucent"&&po(y,K,oe,C,N,H[K.overscaledZ],z)}D.viewport.set([0,0,y.width,y.height])})(n,d,p,m);break;case"raster":(function(y,E,C,M){if(y.renderPass!=="translucent"||C.paint.get("raster-opacity")===0||!M.length)return;const D=y.context,N=D.gl,z=E.getSource(),H=y.useProgram("raster"),Y=y.colorModeForRenderPass(),[K,oe]=z instanceof _s?[{},M]:y.stencilConfigForOverlap(M),he=oe[oe.length-1].overscaledZ,fe=!y.options.moving;for(const _e of oe){const re=y.depthModeForSublayer(_e.overscaledZ-he,C.paint.get("raster-opacity")===1?Yt.ReadWrite:Yt.ReadOnly,N.LESS),be=E.getTile(_e);be.registerFadeDuration(C.paint.get("raster-fade-duration"));const Se=E.findLoadedParent(_e,0),De=E.findLoadedSibling(_e),Xe=cd(be,Se||De||null,E,C,y.transform,y.style.map.terrain);let rt,dt;const yt=C.paint.get("raster-resampling")==="nearest"?N.NEAREST:N.LINEAR;D.activeTexture.set(N.TEXTURE0),be.texture.bind(yt,N.CLAMP_TO_EDGE,N.LINEAR_MIPMAP_NEAREST),D.activeTexture.set(N.TEXTURE1),Se?(Se.texture.bind(yt,N.CLAMP_TO_EDGE,N.LINEAR_MIPMAP_NEAREST),rt=Math.pow(2,Se.tileID.overscaledZ-be.tileID.overscaledZ),dt=[be.tileID.canonical.x*rt%1,be.tileID.canonical.y*rt%1]):be.texture.bind(yt,N.CLAMP_TO_EDGE,N.LINEAR_MIPMAP_NEAREST),be.texture.useMipmap&&D.extTextureFilterAnisotropic&&y.transform.pitch>20&&N.texParameterf(N.TEXTURE_2D,D.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,D.extTextureFilterAnisotropicMax);const lt=y.style.map.terrain&&y.style.map.terrain.getTerrainData(_e),at=lt?_e:null,At=at?at.posMatrix:y.transform.calculatePosMatrix(_e.toUnwrapped(),fe),jt=Op(At,dt||[0,0],rt||1,Xe,C);z instanceof _s?H.draw(D,N.TRIANGLES,re,xi.disabled,Y,fi.disabled,jt,lt,C.id,z.boundsBuffer,y.quadTriangleIndexBuffer,z.boundsSegments):H.draw(D,N.TRIANGLES,re,K[_e.overscaledZ],Y,fi.disabled,jt,lt,C.id,y.rasterBoundsBuffer,y.quadTriangleIndexBuffer,y.rasterBoundsSegments)}})(n,d,p,m);break;case"background":(function(y,E,C,M){const D=C.paint.get("background-color"),N=C.paint.get("background-opacity");if(N===0)return;const z=y.context,H=z.gl,Y=y.transform,K=Y.tileSize,oe=C.paint.get("background-pattern");if(y.isPatternMissing(oe))return;const he=!oe&&D.a===1&&N===1&&y.opaquePassEnabledForLayer()?"opaque":"translucent";if(y.renderPass!==he)return;const fe=xi.disabled,_e=y.depthModeForSublayer(0,he==="opaque"?Yt.ReadWrite:Yt.ReadOnly),re=y.colorModeForRenderPass(),be=y.useProgram(oe?"backgroundPattern":"background"),Se=M||Y.coveringTiles({tileSize:K,terrain:y.style.map.terrain});oe&&(z.activeTexture.set(H.TEXTURE0),y.imageManager.bind(y.context));const De=C.getCrossfadeParameters();for(const Xe of Se){const rt=M?Xe.posMatrix:y.transform.calculatePosMatrix(Xe.toUnwrapped()),dt=oe?Vc(rt,N,y,oe,{tileID:Xe,tileSize:K},De):cl(rt,N,D),yt=y.style.map.terrain&&y.style.map.terrain.getTerrainData(Xe);be.draw(z,H.TRIANGLES,_e,fe,re,fi.disabled,dt,yt,C.id,y.tileExtentBuffer,y.quadTriangleIndexBuffer,y.tileExtentSegments)}})(n,0,p,m);break;case"custom":(function(y,E,C){const M=y.context,D=C.implementation;if(y.renderPass==="offscreen"){const N=D.prerender;N&&(y.setCustomLayerDefaults(),M.setColorMode(y.colorModeForRenderPass()),N.call(D,M.gl,y.transform.customLayerMatrix()),M.setDirty(),y.setBaseState())}else if(y.renderPass==="translucent"){y.setCustomLayerDefaults(),M.setColorMode(y.colorModeForRenderPass()),M.setStencilMode(xi.disabled);const N=D.renderingMode==="3d"?new Yt(y.context.gl.LEQUAL,Yt.ReadWrite,y.depthRangeFor3D):y.depthModeForSublayer(0,Yt.ReadOnly);M.setDepthMode(N),D.render(M.gl,y.transform.customLayerMatrix(),{farZ:y.transform.farZ,nearZ:y.transform.nearZ,fov:y.transform._fov,modelViewProjectionMatrix:y.transform.modelViewProjectionMatrix,projectionMatrix:y.transform.projectionMatrix}),M.setDirty(),y.setBaseState(),M.bindFramebuffer.set(null)}})(n,0,p)}}translatePosMatrix(n,d,p,m,y){if(!p[0]&&!p[1])return n;const E=y?m==="map"?this.transform.angle:0:m==="viewport"?-this.transform.angle:0;if(E){const D=Math.sin(E),N=Math.cos(E);p=[p[0]*N-p[1]*D,p[0]*D+p[1]*N]}const C=[y?p[0]:Jt(d,p[0],this.transform.zoom),y?p[1]:Jt(d,p[1],this.transform.zoom),0],M=new Float32Array(16);return l.J(M,n,C),M}saveTileTexture(n){const d=this._tileTextures[n.size[0]];d?d.push(n):this._tileTextures[n.size[0]]=[n]}getTileTexture(n){const d=this._tileTextures[n];return d&&d.length>0?d.pop():null}isPatternMissing(n){if(!n)return!1;if(!n.from||!n.to)return!0;const d=this.imageManager.getPattern(n.from.toString()),p=this.imageManager.getPattern(n.to.toString());return!d||!p}useProgram(n,d){this.cache=this.cache||{};const p=n+(d?d.cacheKey:"")+(this._showOverdrawInspector?"/overdraw":"")+(this.style.map.terrain?"/terrain":"");return this.cache[p]||(this.cache[p]=new zc(this.context,dn[n],d,jc[n],this._showOverdrawInspector,this.style.map.terrain)),this.cache[p]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){const n=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(n.FUNC_ADD)}initDebugOverlayCanvas(){this.debugOverlayCanvas==null&&(this.debugOverlayCanvas=document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new Ye(this.context,this.debugOverlayCanvas,this.context.gl.RGBA))}destroy(){this.debugOverlayTexture&&this.debugOverlayTexture.destroy()}overLimit(){const{drawingBufferWidth:n,drawingBufferHeight:d}=this.context.gl;return this.width!==n||this.height!==d}}class _o{constructor(n,d){this.points=n,this.planes=d}static fromInvProjectionMatrix(n,d,p){const m=Math.pow(2,p),y=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map((C=>{const M=1/(C=l.af([],C,n))[3]/d*m;return l.b1(C,C,[M,M,1/C[3],M])})),E=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map((C=>{const M=(function(H,Y){var K=Y[0],oe=Y[1],he=Y[2],fe=K*K+oe*oe+he*he;return fe>0&&(fe=1/Math.sqrt(fe)),H[0]=Y[0]*fe,H[1]=Y[1]*fe,H[2]=Y[2]*fe,H})([],(function(H,Y,K){var oe=Y[0],he=Y[1],fe=Y[2],_e=K[0],re=K[1],be=K[2];return H[0]=he*be-fe*re,H[1]=fe*_e-oe*be,H[2]=oe*re-he*_e,H})([],Je([],y[C[0]],y[C[1]]),Je([],y[C[2]],y[C[1]]))),D=-((N=M)[0]*(z=y[C[1]])[0]+N[1]*z[1]+N[2]*z[2]);var N,z;return M.concat(D)}));return new _o(y,E)}}class yo{constructor(n,d){this.min=n,this.max=d,this.center=(function(p,m,y){return p[0]=.5*m[0],p[1]=.5*m[1],p[2]=.5*m[2],p})([],(function(p,m,y){return p[0]=m[0]+y[0],p[1]=m[1]+y[1],p[2]=m[2]+y[2],p})([],this.min,this.max))}quadrant(n){const d=[n%2==0,n<2],p=we(this.min),m=we(this.max);for(let y=0;y<d.length;y++)p[y]=d[y]?this.min[y]:this.center[y],m[y]=d[y]?this.center[y]:this.max[y];return m[2]=this.max[2],new yo(p,m)}distanceX(n){return Math.max(Math.min(this.max[0],n[0]),this.min[0])-n[0]}distanceY(n){return Math.max(Math.min(this.max[1],n[1]),this.min[1])-n[1]}intersects(n){const d=[[this.min[0],this.min[1],this.min[2],1],[this.max[0],this.min[1],this.min[2],1],[this.max[0],this.max[1],this.min[2],1],[this.min[0],this.max[1],this.min[2],1],[this.min[0],this.min[1],this.max[2],1],[this.max[0],this.min[1],this.max[2],1],[this.max[0],this.max[1],this.max[2],1],[this.min[0],this.max[1],this.max[2],1]];let p=!0;for(let m=0;m<n.planes.length;m++){const y=n.planes[m];let E=0;for(let C=0;C<d.length;C++)l.b2(y,d[C])>=0&&E++;if(E===0)return 0;E!==d.length&&(p=!1)}if(p)return 2;for(let m=0;m<3;m++){let y=Number.MAX_VALUE,E=-Number.MAX_VALUE;for(let C=0;C<n.points.length;C++){const M=n.points[C][m]-this.min[m];y=Math.min(y,M),E=Math.max(E,M)}if(E<0||y>this.max[m]-this.min[m])return 0}return 1}}class xo{constructor(n=0,d=0,p=0,m=0){if(isNaN(n)||n<0||isNaN(d)||d<0||isNaN(p)||p<0||isNaN(m)||m<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=n,this.bottom=d,this.left=p,this.right=m}interpolate(n,d,p){return d.top!=null&&n.top!=null&&(this.top=l.y.number(n.top,d.top,p)),d.bottom!=null&&n.bottom!=null&&(this.bottom=l.y.number(n.bottom,d.bottom,p)),d.left!=null&&n.left!=null&&(this.left=l.y.number(n.left,d.left,p)),d.right!=null&&n.right!=null&&(this.right=l.y.number(n.right,d.right,p)),this}getCenter(n,d){const p=l.ac((this.left+n-this.right)/2,0,n),m=l.ac((this.top+d-this.bottom)/2,0,d);return new l.P(p,m)}equals(n){return this.top===n.top&&this.bottom===n.bottom&&this.left===n.left&&this.right===n.right}clone(){return new xo(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}const iu=85.051129;class vo{constructor(n,d,p,m,y){this.tileSize=512,this._renderWorldCopies=y===void 0||!!y,this._minZoom=n||0,this._maxZoom=d||22,this._minPitch=p??0,this._maxPitch=m??60,this.setMaxBounds(),this.width=0,this.height=0,this._center=new l.N(0,0),this._elevation=0,this.zoom=0,this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._unmodified=!0,this._edgeInsets=new xo,this._posMatrixCache={},this._alignedPosMatrixCache={},this._fogMatrixCache={},this.minElevationForCurrentTile=0}clone(){const n=new vo(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies);return n.apply(this),n}apply(n){this.tileSize=n.tileSize,this.latRange=n.latRange,this.lngRange=n.lngRange,this.width=n.width,this.height=n.height,this._center=n._center,this._elevation=n._elevation,this.minElevationForCurrentTile=n.minElevationForCurrentTile,this.zoom=n.zoom,this.angle=n.angle,this._fov=n._fov,this._pitch=n._pitch,this._unmodified=n._unmodified,this._edgeInsets=n._edgeInsets.clone(),this._calcMatrices()}get minZoom(){return this._minZoom}set minZoom(n){this._minZoom!==n&&(this._minZoom=n,this.zoom=Math.max(this.zoom,n))}get maxZoom(){return this._maxZoom}set maxZoom(n){this._maxZoom!==n&&(this._maxZoom=n,this.zoom=Math.min(this.zoom,n))}get minPitch(){return this._minPitch}set minPitch(n){this._minPitch!==n&&(this._minPitch=n,this.pitch=Math.max(this.pitch,n))}get maxPitch(){return this._maxPitch}set maxPitch(n){this._maxPitch!==n&&(this._maxPitch=n,this.pitch=Math.min(this.pitch,n))}get renderWorldCopies(){return this._renderWorldCopies}set renderWorldCopies(n){n===void 0?n=!0:n===null&&(n=!1),this._renderWorldCopies=n}get worldSize(){return this.tileSize*this.scale}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new l.P(this.width,this.height)}get bearing(){return-this.angle/Math.PI*180}set bearing(n){const d=-l.b3(n,-180,180)*Math.PI/180;this.angle!==d&&(this._unmodified=!1,this.angle=d,this._calcMatrices(),this.rotationMatrix=(function(){var p=new l.A(4);return l.A!=Float32Array&&(p[1]=0,p[2]=0),p[0]=1,p[3]=1,p})(),(function(p,m,y){var E=m[0],C=m[1],M=m[2],D=m[3],N=Math.sin(y),z=Math.cos(y);p[0]=E*z+M*N,p[1]=C*z+D*N,p[2]=E*-N+M*z,p[3]=C*-N+D*z})(this.rotationMatrix,this.rotationMatrix,this.angle))}get pitch(){return this._pitch/Math.PI*180}set pitch(n){const d=l.ac(n,this.minPitch,this.maxPitch)/180*Math.PI;this._pitch!==d&&(this._unmodified=!1,this._pitch=d,this._calcMatrices())}get fov(){return this._fov/Math.PI*180}set fov(n){n=Math.max(.01,Math.min(60,n)),this._fov!==n&&(this._unmodified=!1,this._fov=n/180*Math.PI,this._calcMatrices())}get zoom(){return this._zoom}set zoom(n){const d=Math.min(Math.max(n,this.minZoom),this.maxZoom);this._zoom!==d&&(this._unmodified=!1,this._zoom=d,this.tileZoom=Math.max(0,Math.floor(d)),this.scale=this.zoomScale(d),this._constrain(),this._calcMatrices())}get center(){return this._center}set center(n){n.lat===this._center.lat&&n.lng===this._center.lng||(this._unmodified=!1,this._center=n,this._constrain(),this._calcMatrices())}get elevation(){return this._elevation}set elevation(n){n!==this._elevation&&(this._elevation=n,this._constrain(),this._calcMatrices())}get padding(){return this._edgeInsets.toJSON()}set padding(n){this._edgeInsets.equals(n)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,n,1),this._calcMatrices())}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height)}isPaddingEqual(n){return this._edgeInsets.equals(n)}interpolatePadding(n,d,p){this._unmodified=!1,this._edgeInsets.interpolate(n,d,p),this._constrain(),this._calcMatrices()}coveringZoomLevel(n){const d=(n.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/n.tileSize));return Math.max(0,d)}getVisibleUnwrappedCoordinates(n){const d=[new l.b4(0,n)];if(this._renderWorldCopies){const p=this.pointCoordinate(new l.P(0,0)),m=this.pointCoordinate(new l.P(this.width,0)),y=this.pointCoordinate(new l.P(this.width,this.height)),E=this.pointCoordinate(new l.P(0,this.height)),C=Math.floor(Math.min(p.x,m.x,y.x,E.x)),M=Math.floor(Math.max(p.x,m.x,y.x,E.x)),D=1;for(let N=C-D;N<=M+D;N++)N!==0&&d.push(new l.b4(N,n))}return d}coveringTiles(n){var d,p;let m=this.coveringZoomLevel(n);const y=m;if(n.minzoom!==void 0&&m<n.minzoom)return[];n.maxzoom!==void 0&&m>n.maxzoom&&(m=n.maxzoom);const E=this.pointCoordinate(this.getCameraPoint()),C=l.Z.fromLngLat(this.center),M=Math.pow(2,m),D=[M*E.x,M*E.y,0],N=[M*C.x,M*C.y,0],z=_o.fromInvProjectionMatrix(this.invModelViewProjectionMatrix,this.worldSize,m);let H=n.minzoom||0;!n.terrain&&this.pitch<=60&&this._edgeInsets.top<.1&&(H=m);const Y=n.terrain?2/Math.min(this.tileSize,n.tileSize)*this.tileSize:3,K=re=>({aabb:new yo([re*M,0,0],[(re+1)*M,M,0]),zoom:0,x:0,y:0,wrap:re,fullyVisible:!1}),oe=[],he=[],fe=m,_e=n.reparseOverscaled?y:m;if(this._renderWorldCopies)for(let re=1;re<=3;re++)oe.push(K(-re)),oe.push(K(re));for(oe.push(K(0));oe.length>0;){const re=oe.pop(),be=re.x,Se=re.y;let De=re.fullyVisible;if(!De){const lt=re.aabb.intersects(z);if(lt===0)continue;De=lt===2}const Xe=n.terrain?D:N,rt=re.aabb.distanceX(Xe),dt=re.aabb.distanceY(Xe),yt=Math.max(Math.abs(rt),Math.abs(dt));if(re.zoom===fe||yt>Y+(1<<fe-re.zoom)-2&&re.zoom>=H){const lt=fe-re.zoom,at=D[0]-.5-(be<<lt),At=D[1]-.5-(Se<<lt);he.push({tileID:new l.S(re.zoom===fe?_e:re.zoom,re.wrap,re.zoom,be,Se),distanceSq:it([N[0]-.5-be,N[1]-.5-Se]),tileDistanceToCamera:Math.sqrt(at*at+At*At)})}else for(let lt=0;lt<4;lt++){const at=(be<<1)+lt%2,At=(Se<<1)+(lt>>1),jt=re.zoom+1;let ct=re.aabb.quadrant(lt);if(n.terrain){const gt=new l.S(jt,re.wrap,jt,at,At),Ut=n.terrain.getMinMaxElevation(gt),Si=(d=Ut.minElevation)!==null&&d!==void 0?d:this.elevation,Xt=(p=Ut.maxElevation)!==null&&p!==void 0?p:this.elevation;ct=new yo([ct.min[0],ct.min[1],Si],[ct.max[0],ct.max[1],Xt])}oe.push({aabb:ct,zoom:jt,x:at,y:At,wrap:re.wrap,fullyVisible:De})}}return he.sort(((re,be)=>re.distanceSq-be.distanceSq)).map((re=>re.tileID))}resize(n,d){this.width=n,this.height=d,this.pixelsToGLUnits=[2/n,-2/d],this._constrain(),this._calcMatrices()}get unmodified(){return this._unmodified}zoomScale(n){return Math.pow(2,n)}scaleZoom(n){return Math.log(n)/Math.LN2}project(n){const d=l.ac(n.lat,-85.051129,iu);return new l.P(l.O(n.lng)*this.worldSize,l.Q(d)*this.worldSize)}unproject(n){return new l.Z(n.x/this.worldSize,n.y/this.worldSize).toLngLat()}get point(){return this.project(this.center)}getCameraPosition(){return{lngLat:this.pointLocation(this.getCameraPoint()),altitude:Math.cos(this._pitch)*this.cameraToCenterDistance/this._pixelPerMeter+this.elevation}}recalculateZoom(n){const d=this.elevation,p=Math.cos(this._pitch)*this.cameraToCenterDistance/this._pixelPerMeter,m=this.pointLocation(this.centerPoint,n),y=n.getElevationForLngLatZoom(m,this.tileZoom);if(!(this.elevation-y))return;const E=p+d-y,C=Math.cos(this._pitch)*this.cameraToCenterDistance/E/l.b5(1,m.lat),M=this.scaleZoom(C/this.tileSize);this._elevation=y,this._center=m,this.zoom=M}setLocationAtPoint(n,d){const p=this.pointCoordinate(d),m=this.pointCoordinate(this.centerPoint),y=this.locationCoordinate(n),E=new l.Z(y.x-(p.x-m.x),y.y-(p.y-m.y));this.center=this.coordinateLocation(E),this._renderWorldCopies&&(this.center=this.center.wrap())}locationPoint(n,d){return d?this.coordinatePoint(this.locationCoordinate(n),d.getElevationForLngLatZoom(n,this.tileZoom),this.pixelMatrix3D):this.coordinatePoint(this.locationCoordinate(n))}pointLocation(n,d){return this.coordinateLocation(this.pointCoordinate(n,d))}locationCoordinate(n){return l.Z.fromLngLat(n)}coordinateLocation(n){return n&&n.toLngLat()}pointCoordinate(n,d){if(d){const H=d.pointCoordinate(n);if(H!=null)return H}const p=[n.x,n.y,0,1],m=[n.x,n.y,1,1];l.af(p,p,this.pixelMatrixInverse),l.af(m,m,this.pixelMatrixInverse);const y=p[3],E=m[3],C=p[1]/y,M=m[1]/E,D=p[2]/y,N=m[2]/E,z=D===N?0:(0-D)/(N-D);return new l.Z(l.y.number(p[0]/y,m[0]/E,z)/this.worldSize,l.y.number(C,M,z)/this.worldSize)}coordinatePoint(n,d=0,p=this.pixelMatrix){const m=[n.x*this.worldSize,n.y*this.worldSize,d,1];return l.af(m,m,p),new l.P(m[0]/m[3],m[1]/m[3])}getBounds(){const n=Math.max(0,this.height/2-this.getHorizon());return new Ce().extend(this.pointLocation(new l.P(0,n))).extend(this.pointLocation(new l.P(this.width,n))).extend(this.pointLocation(new l.P(this.width,this.height))).extend(this.pointLocation(new l.P(0,this.height)))}getMaxBounds(){return this.latRange&&this.latRange.length===2&&this.lngRange&&this.lngRange.length===2?new Ce([this.lngRange[0],this.latRange[0]],[this.lngRange[1],this.latRange[1]]):null}getHorizon(){return Math.tan(Math.PI/2-this._pitch)*this.cameraToCenterDistance*.85}setMaxBounds(n){n?(this.lngRange=[n.getWest(),n.getEast()],this.latRange=[n.getSouth(),n.getNorth()],this._constrain()):(this.lngRange=null,this.latRange=[-85.051129,iu])}calculateTileMatrix(n){const d=n.canonical,p=this.worldSize/this.zoomScale(d.z),m=d.x+Math.pow(2,d.z)*n.wrap,y=l.an(new Float64Array(16));return l.J(y,y,[m*p,d.y*p,0]),l.K(y,y,[p/l.X,p/l.X,1]),y}calculatePosMatrix(n,d=!1){const p=n.key,m=d?this._alignedPosMatrixCache:this._posMatrixCache;if(m[p])return m[p];const y=this.calculateTileMatrix(n);return l.L(y,d?this.alignedModelViewProjectionMatrix:this.modelViewProjectionMatrix,y),m[p]=new Float32Array(y),m[p]}calculateFogMatrix(n){const d=n.key,p=this._fogMatrixCache;if(p[d])return p[d];const m=this.calculateTileMatrix(n);return l.L(m,this.fogMatrix,m),p[d]=new Float32Array(m),p[d]}customLayerMatrix(){return this.mercatorMatrix.slice()}getConstrained(n,d){d=l.ac(+d,this.minZoom,this.maxZoom);const p={center:new l.N(n.lng,n.lat),zoom:d};let m=this.lngRange;if(!this._renderWorldCopies&&m===null){const re=179.9999999999;m=[-re,re]}const y=this.tileSize*this.zoomScale(p.zoom);let E=0,C=y,M=0,D=y,N=0,z=0;const{x:H,y:Y}=this.size;if(this.latRange){const re=this.latRange;E=l.Q(re[1])*y,C=l.Q(re[0])*y,C-E<Y&&(N=Y/(C-E))}m&&(M=l.b3(l.O(m[0])*y,0,y),D=l.b3(l.O(m[1])*y,0,y),D<M&&(D+=y),D-M<H&&(z=H/(D-M)));const{x:K,y:oe}=this.project.call({worldSize:y},n);let he,fe;const _e=Math.max(z||0,N||0);if(_e){const re=new l.P(z?(D+M)/2:K,N?(C+E)/2:oe);return p.center=this.unproject.call({worldSize:y},re).wrap(),p.zoom+=this.scaleZoom(_e),p}if(this.latRange){const re=Y/2;oe-re<E&&(fe=E+re),oe+re>C&&(fe=C-re)}if(m){const re=(M+D)/2;let be=K;this._renderWorldCopies&&(be=l.b3(K,re-y/2,re+y/2));const Se=H/2;be-Se<M&&(he=M+Se),be+Se>D&&(he=D-Se)}if(he!==void 0||fe!==void 0){const re=new l.P(he??K,fe??oe);p.center=this.unproject.call({worldSize:y},re).wrap()}return p}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;this._constraining=!0;const n=this._unmodified,{center:d,zoom:p}=this.getConstrained(this.center,this.zoom);this.center=d,this.zoom=p,this._unmodified=n,this._constraining=!1}_calcMatrices(){if(!this.height)return;const n=this.centerOffset,d=this.point.x,p=this.point.y;this.cameraToCenterDistance=.5/Math.tan(this._fov/2)*this.height,this._pixelPerMeter=l.b5(1,this.center.lat)*this.worldSize;let m=l.an(new Float64Array(16));l.K(m,m,[this.width/2,-this.height/2,1]),l.J(m,m,[1,-1,0]),this.labelPlaneMatrix=m,m=l.an(new Float64Array(16)),l.K(m,m,[1,-1,1]),l.J(m,m,[-1,-1,0]),l.K(m,m,[2/this.width,2/this.height,1]),this.glCoordMatrix=m;const y=this.cameraToCenterDistance+this._elevation*this._pixelPerMeter/Math.cos(this._pitch),E=Math.min(this.elevation,this.minElevationForCurrentTile),C=y-E*this._pixelPerMeter/Math.cos(this._pitch),M=E<0?C:y,D=Math.PI/2+this._pitch,N=this._fov*(.5+n.y/this.height),z=Math.sin(N)*M/Math.sin(l.ac(Math.PI-D-N,.01,Math.PI-.01)),H=this.getHorizon(),Y=2*Math.atan(H/this.cameraToCenterDistance)*(.5+n.y/(2*H)),K=Math.sin(Y)*M/Math.sin(l.ac(Math.PI-D-Y,.01,Math.PI-.01)),oe=Math.min(z,K);this.farZ=1.01*(Math.cos(Math.PI/2-this._pitch)*oe+M),this.nearZ=this.height/50,m=new Float64Array(16),l.b6(m,this._fov,this.width/this.height,this.nearZ,this.farZ),m[8]=2*-n.x/this.width,m[9]=2*n.y/this.height,this.projectionMatrix=l.ae(m),l.K(m,m,[1,-1,1]),l.J(m,m,[0,0,-this.cameraToCenterDistance]),l.b7(m,m,this._pitch),l.ad(m,m,this.angle),l.J(m,m,[-d,-p,0]),this.mercatorMatrix=l.K([],m,[this.worldSize,this.worldSize,this.worldSize]),l.K(m,m,[1,1,this._pixelPerMeter]),this.pixelMatrix=l.L(new Float64Array(16),this.labelPlaneMatrix,m),l.J(m,m,[0,0,-this.elevation]),this.modelViewProjectionMatrix=m,this.invModelViewProjectionMatrix=l.as([],m),this.fogMatrix=new Float64Array(16),l.b6(this.fogMatrix,this._fov,this.width/this.height,y,this.farZ),this.fogMatrix[8]=2*-n.x/this.width,this.fogMatrix[9]=2*n.y/this.height,l.K(this.fogMatrix,this.fogMatrix,[1,-1,1]),l.J(this.fogMatrix,this.fogMatrix,[0,0,-this.cameraToCenterDistance]),l.b7(this.fogMatrix,this.fogMatrix,this._pitch),l.ad(this.fogMatrix,this.fogMatrix,this.angle),l.J(this.fogMatrix,this.fogMatrix,[-d,-p,0]),l.K(this.fogMatrix,this.fogMatrix,[1,1,this._pixelPerMeter]),l.J(this.fogMatrix,this.fogMatrix,[0,0,-this.elevation]),this.pixelMatrix3D=l.L(new Float64Array(16),this.labelPlaneMatrix,m);const he=this.width%2/2,fe=this.height%2/2,_e=Math.cos(this.angle),re=Math.sin(this.angle),be=d-Math.round(d)+_e*he+re*fe,Se=p-Math.round(p)+_e*fe+re*he,De=new Float64Array(m);if(l.J(De,De,[be>.5?be-1:be,Se>.5?Se-1:Se,0]),this.alignedModelViewProjectionMatrix=De,m=l.as(new Float64Array(16),this.pixelMatrix),!m)throw new Error("failed to invert matrix");this.pixelMatrixInverse=m,this._posMatrixCache={},this._alignedPosMatrixCache={},this._fogMatrixCache={}}maxPitchScaleFactor(){if(!this.pixelMatrixInverse)return 1;const n=this.pointCoordinate(new l.P(0,0)),d=[n.x*this.worldSize,n.y*this.worldSize,0,1];return l.af(d,d,this.pixelMatrix)[3]/this.cameraToCenterDistance}getCameraPoint(){const n=Math.tan(this._pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new l.P(0,n))}getCameraQueryGeometry(n){const d=this.getCameraPoint();if(n.length===1)return[n[0],d];{let p=d.x,m=d.y,y=d.x,E=d.y;for(const C of n)p=Math.min(p,C.x),m=Math.min(m,C.y),y=Math.max(y,C.x),E=Math.max(E,C.y);return[new l.P(p,m),new l.P(y,m),new l.P(y,E),new l.P(p,E),new l.P(p,m)]}}lngLatToCameraDepth(n,d){const p=this.locationCoordinate(n),m=[p.x*this.worldSize,p.y*this.worldSize,d,1];return l.af(m,m,this.modelViewProjectionMatrix),m[2]/m[3]}}function pa(x,n){let d,p=!1,m=null,y=null;const E=()=>{m=null,p&&(x.apply(y,d),m=setTimeout(E,n),p=!1)};return(...C)=>(p=!0,y=this,d=C,m||E(),m)}class vl{constructor(n){this._getCurrentHash=()=>{const d=window.location.hash.replace("#","");if(this._hashName){let p;return d.split("&").map((m=>m.split("="))).forEach((m=>{m[0]===this._hashName&&(p=m)})),(p&&p[1]||"").split("/")}return d.split("/")},this._onHashChange=()=>{const d=this._getCurrentHash();if(d.length>=3&&!d.some((p=>isNaN(p)))){const p=this._map.dragRotate.isEnabled()&&this._map.touchZoomRotate.isEnabled()?+(d[3]||0):this._map.getBearing();return this._map.jumpTo({center:[+d[2],+d[1]],zoom:+d[0],bearing:p,pitch:+(d[4]||0)}),!0}return!1},this._updateHashUnthrottled=()=>{const d=window.location.href.replace(/(#.*)?$/,this.getHashString());window.history.replaceState(window.history.state,null,d)},this._removeHash=()=>{const d=this._getCurrentHash();if(d.length===0)return;const p=d.join("/");let m=p;m.split("&").length>0&&(m=m.split("&")[0]),this._hashName&&(m=`${this._hashName}=${p}`);let y=window.location.hash.replace(m,"");y.startsWith("#&")?y=y.slice(0,1)+y.slice(2):y==="#"&&(y="");let E=window.location.href.replace(/(#.+)?$/,y);E=E.replace("&&","&"),window.history.replaceState(window.history.state,null,E)},this._updateHash=pa(this._updateHashUnthrottled,300),this._hashName=n&&encodeURIComponent(n)}addTo(n){return this._map=n,addEventListener("hashchange",this._onHashChange,!1),this._map.on("moveend",this._updateHash),this}remove(){return removeEventListener("hashchange",this._onHashChange,!1),this._map.off("moveend",this._updateHash),clearTimeout(this._updateHash()),this._removeHash(),delete this._map,this}getHashString(n){const d=this._map.getCenter(),p=Math.round(100*this._map.getZoom())/100,m=Math.ceil((p*Math.LN2+Math.log(512/360/.5))/Math.LN10),y=Math.pow(10,m),E=Math.round(d.lng*y)/y,C=Math.round(d.lat*y)/y,M=this._map.getBearing(),D=this._map.getPitch();let N="";if(N+=n?`/${E}/${C}/${p}`:`${p}/${C}/${E}`,(M||D)&&(N+="/"+Math.round(10*M)/10),D&&(N+=`/${Math.round(D)}`),this._hashName){const z=this._hashName;let H=!1;const Y=window.location.hash.slice(1).split("&").map((K=>{const oe=K.split("=")[0];return oe===z?(H=!0,`${oe}=${N}`):K})).filter((K=>K));return H||Y.push(`${z}=${N}`),`#${Y.join("&")}`}return`#${N}`}}const bl={linearity:.3,easing:l.b8(0,0,.3,1)},ru=l.e({deceleration:2500,maxSpeed:1400},bl),Xp=l.e({deceleration:20,maxSpeed:1400},bl),pd=l.e({deceleration:1e3,maxSpeed:360},bl),wl=l.e({deceleration:1e3,maxSpeed:90},bl);class su{constructor(n){this._map=n,this.clear()}clear(){this._inertiaBuffer=[]}record(n){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:S.now(),settings:n})}_drainInertiaBuffer(){const n=this._inertiaBuffer,d=S.now();for(;n.length>0&&d-n[0].time>160;)n.shift()}_onMoveEnd(n){if(this._drainInertiaBuffer(),this._inertiaBuffer.length<2)return;const d={zoom:0,bearing:0,pitch:0,pan:new l.P(0,0),pinchAround:void 0,around:void 0};for(const{settings:y}of this._inertiaBuffer)d.zoom+=y.zoomDelta||0,d.bearing+=y.bearingDelta||0,d.pitch+=y.pitchDelta||0,y.panDelta&&d.pan._add(y.panDelta),y.around&&(d.around=y.around),y.pinchAround&&(d.pinchAround=y.pinchAround);const p=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,m={};if(d.pan.mag()){const y=ma(d.pan.mag(),p,l.e({},ru,n||{}));m.offset=d.pan.mult(y.amount/d.pan.mag()),m.center=this._map.transform.center,ga(m,y)}if(d.zoom){const y=ma(d.zoom,p,Xp);m.zoom=this._map.transform.zoom+y.amount,ga(m,y)}if(d.bearing){const y=ma(d.bearing,p,pd);m.bearing=this._map.transform.bearing+l.ac(y.amount,-179,179),ga(m,y)}if(d.pitch){const y=ma(d.pitch,p,wl);m.pitch=this._map.transform.pitch+y.amount,ga(m,y)}if(m.zoom||m.bearing){const y=d.pinchAround===void 0?d.around:d.pinchAround;m.around=y?this._map.unproject(y):this._map.getCenter()}return this.clear(),l.e(m,{noMoveStart:!0})}}function ga(x,n){(!x.duration||x.duration<n.duration)&&(x.duration=n.duration,x.easing=n.easing)}function ma(x,n,d){const{maxSpeed:p,linearity:m,deceleration:y}=d,E=l.ac(x*m/(n/1e3),-p,p),C=Math.abs(E)/(y*m);return{easing:d.easing,duration:1e3*C,amount:E*(C/2)}}class pr extends l.k{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(n,d,p,m={}){const y=P.mousePos(d.getCanvas(),p),E=d.unproject(y);super(n,l.e({point:y,lngLat:E,originalEvent:p},m)),this._defaultPrevented=!1,this.target=d}}class Un extends l.k{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(n,d,p){const m=n==="touchend"?p.changedTouches:p.touches,y=P.touchPos(d.getCanvasContainer(),m),E=y.map((M=>d.unproject(M))),C=y.reduce(((M,D,N,z)=>M.add(D.div(z.length))),new l.P(0,0));super(n,{points:y,point:C,lngLats:E,lngLat:d.unproject(C),originalEvent:p}),this._defaultPrevented=!1}}class gd extends l.k{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(n,d,p){super(n,{originalEvent:p}),this._defaultPrevented=!1}}class md{constructor(n,d){this._map=n,this._clickTolerance=d.clickTolerance}reset(){delete this._mousedownPos}wheel(n){return this._firePreventable(new gd(n.type,this._map,n))}mousedown(n,d){return this._mousedownPos=d,this._firePreventable(new pr(n.type,this._map,n))}mouseup(n){this._map.fire(new pr(n.type,this._map,n))}click(n,d){this._mousedownPos&&this._mousedownPos.dist(d)>=this._clickTolerance||this._map.fire(new pr(n.type,this._map,n))}dblclick(n){return this._firePreventable(new pr(n.type,this._map,n))}mouseover(n){this._map.fire(new pr(n.type,this._map,n))}mouseout(n){this._map.fire(new pr(n.type,this._map,n))}touchstart(n){return this._firePreventable(new Un(n.type,this._map,n))}touchmove(n){this._map.fire(new Un(n.type,this._map,n))}touchend(n){this._map.fire(new Un(n.type,this._map,n))}touchcancel(n){this._map.fire(new Un(n.type,this._map,n))}_firePreventable(n){if(this._map.fire(n),n.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class Vi{constructor(n){this._map=n}reset(){this._delayContextMenu=!1,this._ignoreContextMenu=!0,delete this._contextMenuEvent}mousemove(n){this._map.fire(new pr(n.type,this._map,n))}mousedown(){this._delayContextMenu=!0,this._ignoreContextMenu=!1}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new pr("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(n){this._delayContextMenu?this._contextMenuEvent=n:this._ignoreContextMenu||this._map.fire(new pr(n.type,this._map,n)),this._map.listens("contextmenu")&&n.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class Ts{constructor(n){this._map=n}get transform(){return this._map._requestedCameraState||this._map.transform}get center(){return{lng:this.transform.center.lng,lat:this.transform.center.lat}}get zoom(){return this.transform.zoom}get pitch(){return this.transform.pitch}get bearing(){return this.transform.bearing}unproject(n){return this.transform.pointLocation(l.P.convert(n),this._map.terrain)}}class Qr{constructor(n,d){this._map=n,this._tr=new Ts(n),this._el=n.getCanvasContainer(),this._container=n.getContainer(),this._clickTolerance=d.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(n,d){this.isEnabled()&&n.shiftKey&&n.button===0&&(P.disableDrag(),this._startPos=this._lastPos=d,this._active=!0)}mousemoveWindow(n,d){if(!this._active)return;const p=d;if(this._lastPos.equals(p)||!this._box&&p.dist(this._startPos)<this._clickTolerance)return;const m=this._startPos;this._lastPos=p,this._box||(this._box=P.create("div","maplibregl-boxzoom",this._container),this._container.classList.add("maplibregl-crosshair"),this._fireEvent("boxzoomstart",n));const y=Math.min(m.x,p.x),E=Math.max(m.x,p.x),C=Math.min(m.y,p.y),M=Math.max(m.y,p.y);P.setTransform(this._box,`translate(${y}px,${C}px)`),this._box.style.width=E-y+"px",this._box.style.height=M-C+"px"}mouseupWindow(n,d){if(!this._active||n.button!==0)return;const p=this._startPos,m=d;if(this.reset(),P.suppressClick(),p.x!==m.x||p.y!==m.y)return this._map.fire(new l.k("boxzoomend",{originalEvent:n})),{cameraAnimation:y=>y.fitScreenCoordinates(p,m,this._tr.bearing,{linear:!0})};this._fireEvent("boxzoomcancel",n)}keydown(n){this._active&&n.keyCode===27&&(this.reset(),this._fireEvent("boxzoomcancel",n))}reset(){this._active=!1,this._container.classList.remove("maplibregl-crosshair"),this._box&&(P.remove(this._box),this._box=null),P.enableDrag(),delete this._startPos,delete this._lastPos}_fireEvent(n,d){return this._map.fire(new l.k(n,{originalEvent:d}))}}function _a(x,n){if(x.length!==n.length)throw new Error(`The number of touches and points are not equal - touches ${x.length}, points ${n.length}`);const d={};for(let p=0;p<x.length;p++)d[x[p].identifier]=n[p];return d}class nu{constructor(n){this.reset(),this.numTouches=n.numTouches}reset(){delete this.centroid,delete this.startTime,delete this.touches,this.aborted=!1}touchstart(n,d,p){(this.centroid||p.length>this.numTouches)&&(this.aborted=!0),this.aborted||(this.startTime===void 0&&(this.startTime=n.timeStamp),p.length===this.numTouches&&(this.centroid=(function(m){const y=new l.P(0,0);for(const E of m)y._add(E);return y.div(m.length)})(d),this.touches=_a(p,d)))}touchmove(n,d,p){if(this.aborted||!this.centroid)return;const m=_a(p,d);for(const y in this.touches){const E=m[y];(!E||E.dist(this.touches[y])>30)&&(this.aborted=!0)}}touchend(n,d,p){if((!this.centroid||n.timeStamp-this.startTime>500)&&(this.aborted=!0),p.length===0){const m=!this.aborted&&this.centroid;if(this.reset(),m)return m}}}class Tl{constructor(n){this.singleTap=new nu(n),this.numTaps=n.numTaps,this.reset()}reset(){this.lastTime=1/0,delete this.lastTap,this.count=0,this.singleTap.reset()}touchstart(n,d,p){this.singleTap.touchstart(n,d,p)}touchmove(n,d,p){this.singleTap.touchmove(n,d,p)}touchend(n,d,p){const m=this.singleTap.touchend(n,d,p);if(m){const y=n.timeStamp-this.lastTime<500,E=!this.lastTap||this.lastTap.dist(m)<30;if(y&&E||this.reset(),this.count++,this.lastTime=n.timeStamp,this.lastTap=m,this.count===this.numTaps)return this.reset(),m}}}class bo{constructor(n){this._tr=new Ts(n),this._zoomIn=new Tl({numTouches:1,numTaps:2}),this._zoomOut=new Tl({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(n,d,p){this._zoomIn.touchstart(n,d,p),this._zoomOut.touchstart(n,d,p)}touchmove(n,d,p){this._zoomIn.touchmove(n,d,p),this._zoomOut.touchmove(n,d,p)}touchend(n,d,p){const m=this._zoomIn.touchend(n,d,p),y=this._zoomOut.touchend(n,d,p),E=this._tr;return m?(this._active=!0,n.preventDefault(),setTimeout((()=>this.reset()),0),{cameraAnimation:C=>C.easeTo({duration:300,zoom:E.zoom+1,around:E.unproject(m)},{originalEvent:n})}):y?(this._active=!0,n.preventDefault(),setTimeout((()=>this.reset()),0),{cameraAnimation:C=>C.easeTo({duration:300,zoom:E.zoom-1,around:E.unproject(y)},{originalEvent:n})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class en{constructor(n){this._enabled=!!n.enable,this._moveStateManager=n.moveStateManager,this._clickTolerance=n.clickTolerance||1,this._moveFunction=n.move,this._activateOnStart=!!n.activateOnStart,n.assignEvents(this),this.reset()}reset(n){this._active=!1,this._moved=!1,delete this._lastPoint,this._moveStateManager.endMove(n)}_move(...n){const d=this._moveFunction(...n);if(d.bearingDelta||d.pitchDelta||d.around||d.panDelta)return this._active=!0,d}dragStart(n,d){this.isEnabled()&&!this._lastPoint&&this._moveStateManager.isValidStartEvent(n)&&(this._moveStateManager.startMove(n),this._lastPoint=d.length?d[0]:d,this._activateOnStart&&this._lastPoint&&(this._active=!0))}dragMove(n,d){if(!this.isEnabled())return;const p=this._lastPoint;if(!p)return;if(n.preventDefault(),!this._moveStateManager.isValidMoveEvent(n))return void this.reset(n);const m=d.length?d[0]:d;return!this._moved&&m.dist(p)<this._clickTolerance?void 0:(this._moved=!0,this._lastPoint=m,this._move(p,m))}dragEnd(n){this.isEnabled()&&this._lastPoint&&this._moveStateManager.isValidEndEvent(n)&&(this._moved&&P.suppressClick(),this.reset(n))}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}getClickTolerance(){return this._clickTolerance}}const ou={0:1,2:2};class Sl{constructor(n){this._correctEvent=n.checkCorrectEvent}startMove(n){const d=P.mouseButton(n);this._eventButton=d}endMove(n){delete this._eventButton}isValidStartEvent(n){return this._correctEvent(n)}isValidMoveEvent(n){return!(function(d,p){const m=ou[p];return d.buttons===void 0||(d.buttons&m)!==m})(n,this._eventButton)}isValidEndEvent(n){return P.mouseButton(n)===this._eventButton}}class au{constructor(){this._firstTouch=void 0}_isOneFingerTouch(n){return n.targetTouches.length===1}_isSameTouchEvent(n){return n.targetTouches[0].identifier===this._firstTouch}startMove(n){this._firstTouch=n.targetTouches[0].identifier}endMove(n){delete this._firstTouch}isValidStartEvent(n){return this._isOneFingerTouch(n)}isValidMoveEvent(n){return this._isOneFingerTouch(n)&&this._isSameTouchEvent(n)}isValidEndEvent(n){return this._isOneFingerTouch(n)&&this._isSameTouchEvent(n)}}const Al=x=>{x.mousedown=x.dragStart,x.mousemoveWindow=x.dragMove,x.mouseup=x.dragEnd,x.contextmenu=n=>{n.preventDefault()}},lu=({enable:x,clickTolerance:n,bearingDegreesPerPixelMoved:d=.8})=>{const p=new Sl({checkCorrectEvent:m=>P.mouseButton(m)===0&&m.ctrlKey||P.mouseButton(m)===2});return new en({clickTolerance:n,move:(m,y)=>({bearingDelta:(y.x-m.x)*d}),moveStateManager:p,enable:x,assignEvents:Al})},cu=({enable:x,clickTolerance:n,pitchDegreesPerPixelMoved:d=-.5})=>{const p=new Sl({checkCorrectEvent:m=>P.mouseButton(m)===0&&m.ctrlKey||P.mouseButton(m)===2});return new en({clickTolerance:n,move:(m,y)=>({pitchDelta:(y.y-m.y)*d}),moveStateManager:p,enable:x,assignEvents:Al})};class Vn{constructor(n,d){this._clickTolerance=n.clickTolerance||1,this._map=d,this.reset()}reset(){this._active=!1,this._touches={},this._sum=new l.P(0,0)}_shouldBePrevented(n){return n<(this._map.cooperativeGestures.isEnabled()?2:1)}touchstart(n,d,p){return this._calculateTransform(n,d,p)}touchmove(n,d,p){if(this._active){if(!this._shouldBePrevented(p.length))return n.preventDefault(),this._calculateTransform(n,d,p);this._map.cooperativeGestures.notifyGestureBlocked("touch_pan",n)}}touchend(n,d,p){this._calculateTransform(n,d,p),this._active&&this._shouldBePrevented(p.length)&&this.reset()}touchcancel(){this.reset()}_calculateTransform(n,d,p){p.length>0&&(this._active=!0);const m=_a(p,d),y=new l.P(0,0),E=new l.P(0,0);let C=0;for(const D in m){const N=m[D],z=this._touches[D];z&&(y._add(N),E._add(N.sub(z)),C++,m[D]=N)}if(this._touches=m,this._shouldBePrevented(C)||!E.mag())return;const M=E.div(C);return this._sum._add(M),this._sum.mag()<this._clickTolerance?void 0:{around:y.div(C),panDelta:M}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class El{constructor(){this.reset()}reset(){this._active=!1,delete this._firstTwoTouches}touchstart(n,d,p){this._firstTwoTouches||p.length<2||(this._firstTwoTouches=[p[0].identifier,p[1].identifier],this._start([d[0],d[1]]))}touchmove(n,d,p){if(!this._firstTwoTouches)return;n.preventDefault();const[m,y]=this._firstTwoTouches,E=ya(p,d,m),C=ya(p,d,y);if(!E||!C)return;const M=this._aroundCenter?null:E.add(C).div(2);return this._move([E,C],M,n)}touchend(n,d,p){if(!this._firstTwoTouches)return;const[m,y]=this._firstTwoTouches,E=ya(p,d,m),C=ya(p,d,y);E&&C||(this._active&&P.suppressClick(),this.reset())}touchcancel(){this.reset()}enable(n){this._enabled=!0,this._aroundCenter=!!n&&n.around==="center"}disable(){this._enabled=!1,this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}}function ya(x,n,d){for(let p=0;p<x.length;p++)if(x[p].identifier===d)return n[p]}function uu(x,n){return Math.log(x/n)/Math.LN2}class hu extends El{reset(){super.reset(),delete this._distance,delete this._startDistance}_start(n){this._startDistance=this._distance=n[0].dist(n[1])}_move(n,d){const p=this._distance;if(this._distance=n[0].dist(n[1]),this._active||!(Math.abs(uu(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:uu(this._distance,p),pinchAround:d}}}function du(x,n){return 180*x.angleWith(n)/Math.PI}class fu extends El{reset(){super.reset(),delete this._minDiameter,delete this._startVector,delete this._vector}_start(n){this._startVector=this._vector=n[0].sub(n[1]),this._minDiameter=n[0].dist(n[1])}_move(n,d,p){const m=this._vector;if(this._vector=n[0].sub(n[1]),this._active||!this._isBelowThreshold(this._vector))return this._active=!0,{bearingDelta:du(this._vector,m),pinchAround:d}}_isBelowThreshold(n){this._minDiameter=Math.min(this._minDiameter,n.mag());const d=25/(Math.PI*this._minDiameter)*360,p=du(n,this._startVector);return Math.abs(p)<d}}function Il(x){return Math.abs(x.y)>Math.abs(x.x)}class xa extends El{constructor(n){super(),this._currentTouchCount=0,this._map=n}reset(){super.reset(),this._valid=void 0,delete this._firstMove,delete this._lastPoints}touchstart(n,d,p){super.touchstart(n,d,p),this._currentTouchCount=p.length}_start(n){this._lastPoints=n,Il(n[0].sub(n[1]))&&(this._valid=!1)}_move(n,d,p){if(this._map.cooperativeGestures.isEnabled()&&this._currentTouchCount<3)return;const m=n[0].sub(this._lastPoints[0]),y=n[1].sub(this._lastPoints[1]);return this._valid=this.gestureBeginsVertically(m,y,p.timeStamp),this._valid?(this._lastPoints=n,this._active=!0,{pitchDelta:(m.y+y.y)/2*-.5}):void 0}gestureBeginsVertically(n,d,p){if(this._valid!==void 0)return this._valid;const m=n.mag()>=2,y=d.mag()>=2;if(!m&&!y)return;if(!m||!y)return this._firstMove===void 0&&(this._firstMove=p),p-this._firstMove<100&&void 0;const E=n.y>0==d.y>0;return Il(n)&&Il(d)&&E}}const _d={panStep:100,bearingStep:15,pitchStep:10};class us{constructor(n){this._tr=new Ts(n);const d=_d;this._panStep=d.panStep,this._bearingStep=d.bearingStep,this._pitchStep=d.pitchStep,this._rotationDisabled=!1}reset(){this._active=!1}keydown(n){if(n.altKey||n.ctrlKey||n.metaKey)return;let d=0,p=0,m=0,y=0,E=0;switch(n.keyCode){case 61:case 107:case 171:case 187:d=1;break;case 189:case 109:case 173:d=-1;break;case 37:n.shiftKey?p=-1:(n.preventDefault(),y=-1);break;case 39:n.shiftKey?p=1:(n.preventDefault(),y=1);break;case 38:n.shiftKey?m=1:(n.preventDefault(),E=-1);break;case 40:n.shiftKey?m=-1:(n.preventDefault(),E=1);break;default:return}return this._rotationDisabled&&(p=0,m=0),{cameraAnimation:C=>{const M=this._tr;C.easeTo({duration:300,easeId:"keyboardHandler",easing:js,zoom:d?Math.round(M.zoom)+d*(n.shiftKey?2:1):M.zoom,bearing:M.bearing+p*this._bearingStep,pitch:M.pitch+m*this._pitchStep,offset:[-y*this._panStep,-E*this._panStep],center:M.center},{originalEvent:n})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function js(x){return x*(2-x)}const pu=4.000244140625;class Ss{constructor(n,d){this._onTimeout=p=>{this._type="wheel",this._delta-=this._lastValue,this._active||this._start(p)},this._map=n,this._tr=new Ts(n),this._triggerRenderFrame=d,this._delta=0,this._defaultZoomRate=.01,this._wheelZoomRate=.0022222222222222222}setZoomRate(n){this._defaultZoomRate=n}setWheelZoomRate(n){this._wheelZoomRate=n}isEnabled(){return!!this._enabled}isActive(){return!!this._active||this._finishTimeout!==void 0}isZooming(){return!!this._zooming}enable(n){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!n&&n.around==="center")}disable(){this.isEnabled()&&(this._enabled=!1)}_shouldBePrevented(n){return!!this._map.cooperativeGestures.isEnabled()&&!(n.ctrlKey||this._map.cooperativeGestures.isBypassed(n))}wheel(n){if(!this.isEnabled())return;if(this._shouldBePrevented(n))return void this._map.cooperativeGestures.notifyGestureBlocked("wheel_zoom",n);let d=n.deltaMode===WheelEvent.DOM_DELTA_LINE?40*n.deltaY:n.deltaY;const p=S.now(),m=p-(this._lastWheelEventTime||0);this._lastWheelEventTime=p,d!==0&&d%pu==0?this._type="wheel":d!==0&&Math.abs(d)<4?this._type="trackpad":m>400?(this._type=null,this._lastValue=d,this._timeout=setTimeout(this._onTimeout,40,n)):this._type||(this._type=Math.abs(m*d)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,d+=this._lastValue)),n.shiftKey&&d&&(d/=4),this._type&&(this._lastWheelEvent=n,this._delta-=d,this._active||this._start(n)),n.preventDefault()}_start(n){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);const d=P.mousePos(this._map.getCanvas(),n),p=this._tr;this._around=d.y>p.transform.height/2-p.transform.getHorizon()?l.N.convert(this._aroundCenter?p.center:p.unproject(d)):l.N.convert(p.center),this._aroundPoint=p.transform.locationPoint(this._around),this._frameId||(this._frameId=!0,this._triggerRenderFrame())}renderFrame(){if(!this._frameId||(this._frameId=null,!this.isActive()))return;const n=this._tr.transform;if(this._delta!==0){const M=this._type==="wheel"&&Math.abs(this._delta)>pu?this._wheelZoomRate:this._defaultZoomRate;let D=2/(1+Math.exp(-Math.abs(this._delta*M)));this._delta<0&&D!==0&&(D=1/D);const N=typeof this._targetZoom=="number"?n.zoomScale(this._targetZoom):n.scale;this._targetZoom=Math.min(n.maxZoom,Math.max(n.minZoom,n.scaleZoom(N*D))),this._type==="wheel"&&(this._startZoom=n.zoom,this._easing=this._smoothOutEasing(200)),this._delta=0}const d=typeof this._targetZoom=="number"?this._targetZoom:n.zoom,p=this._startZoom,m=this._easing;let y,E=!1;const C=S.now()-this._lastWheelEventTime;if(this._type==="wheel"&&p&&m&&C){const M=Math.min(C/200,1),D=m(M);y=l.y.number(p,d,D),M<1?this._frameId||(this._frameId=!0):E=!0}else y=d,E=!0;return this._active=!0,E&&(this._active=!1,this._finishTimeout=setTimeout((()=>{this._zooming=!1,this._triggerRenderFrame(),delete this._targetZoom,delete this._finishTimeout}),200)),{noInertia:!0,needsRenderFrame:!E,zoomDelta:y-n.zoom,around:this._aroundPoint,originalEvent:this._lastWheelEvent}}_smoothOutEasing(n){let d=l.b9;if(this._prevEase){const p=this._prevEase,m=(S.now()-p.start)/p.duration,y=p.easing(m+.01)-p.easing(m),E=.27/Math.sqrt(y*y+1e-4)*.01,C=Math.sqrt(.0729-E*E);d=l.b8(E,C,.25,1)}return this._prevEase={start:S.now(),duration:n,easing:d},d}reset(){this._active=!1,this._zooming=!1,delete this._targetZoom,this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout)}}class jn{constructor(n,d){this._clickZoom=n,this._tapZoom=d}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class Zp{constructor(n){this._tr=new Ts(n),this.reset()}reset(){this._active=!1}dblclick(n,d){return n.preventDefault(),{cameraAnimation:p=>{p.easeTo({duration:300,zoom:this._tr.zoom+(n.shiftKey?-1:1),around:this._tr.unproject(d)},{originalEvent:n})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Yp{constructor(){this._tap=new Tl({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,delete this._swipePoint,delete this._swipeTouch,delete this._tapTime,delete this._tapPoint,this._tap.reset()}touchstart(n,d,p){if(!this._swipePoint)if(this._tapTime){const m=d[0],y=n.timeStamp-this._tapTime<500,E=this._tapPoint.dist(m)<30;y&&E?p.length>0&&(this._swipePoint=m,this._swipeTouch=p[0].identifier):this.reset()}else this._tap.touchstart(n,d,p)}touchmove(n,d,p){if(this._tapTime){if(this._swipePoint){if(p[0].identifier!==this._swipeTouch)return;const m=d[0],y=m.y-this._swipePoint.y;return this._swipePoint=m,n.preventDefault(),this._active=!0,{zoomDelta:y/128}}}else this._tap.touchmove(n,d,p)}touchend(n,d,p){if(this._tapTime)this._swipePoint&&p.length===0&&this.reset();else{const m=this._tap.touchend(n,d,p);m&&(this._tapTime=n.timeStamp,this._tapPoint=m)}}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class yd{constructor(n,d,p){this._el=n,this._mousePan=d,this._touchPan=p}enable(n){this._inertiaOptions=n||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("maplibregl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("maplibregl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class xd{constructor(n,d,p){this._pitchWithRotate=n.pitchWithRotate,this._mouseRotate=d,this._mousePitch=p}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()}}class gu{constructor(n,d,p,m){this._el=n,this._touchZoom=d,this._touchRotate=p,this._tapDragZoom=m,this._rotationDisabled=!1,this._enabled=!0}enable(n){this._touchZoom.enable(n),this._rotationDisabled||this._touchRotate.enable(n),this._tapDragZoom.enable(),this._el.classList.add("maplibregl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("maplibregl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}class wo{constructor(n,d){this._bypassKey=navigator.userAgent.indexOf("Mac")!==-1?"metaKey":"ctrlKey",this._map=n,this._options=d,this._enabled=!1}isActive(){return!1}reset(){}_setupUI(){if(this._container)return;const n=this._map.getCanvasContainer();n.classList.add("maplibregl-cooperative-gestures"),this._container=P.create("div","maplibregl-cooperative-gesture-screen",n);let d=this._map._getUIString("CooperativeGesturesHandler.WindowsHelpText");this._bypassKey==="metaKey"&&(d=this._map._getUIString("CooperativeGesturesHandler.MacHelpText"));const p=this._map._getUIString("CooperativeGesturesHandler.MobileHelpText"),m=document.createElement("div");m.className="maplibregl-desktop-message",m.textContent=d,this._container.appendChild(m);const y=document.createElement("div");y.className="maplibregl-mobile-message",y.textContent=p,this._container.appendChild(y),this._container.setAttribute("aria-hidden","true")}_destroyUI(){this._container&&(P.remove(this._container),this._map.getCanvasContainer().classList.remove("maplibregl-cooperative-gestures")),delete this._container}enable(){this._setupUI(),this._enabled=!0}disable(){this._enabled=!1,this._destroyUI()}isEnabled(){return this._enabled}isBypassed(n){return n[this._bypassKey]}notifyGestureBlocked(n,d){this._enabled&&(this._map.fire(new l.k("cooperativegestureprevented",{gestureType:n,originalEvent:d})),this._container.classList.add("maplibregl-show"),setTimeout((()=>{this._container.classList.remove("maplibregl-show")}),100))}}const hs=x=>x.zoom||x.drag||x.pitch||x.rotate;class vt extends l.k{}function Cl(x){return x.panDelta&&x.panDelta.mag()||x.zoomDelta||x.bearingDelta||x.pitchDelta}class mu{constructor(n,d){this.handleWindowEvent=m=>{this.handleEvent(m,`${m.type}Window`)},this.handleEvent=(m,y)=>{if(m.type==="blur")return void this.stop(!0);this._updatingCamera=!0;const E=m.type==="renderFrame"?void 0:m,C={needsRenderFrame:!1},M={},D={},N=m.touches,z=N?this._getMapTouches(N):void 0,H=z?P.touchPos(this._map.getCanvas(),z):P.mousePos(this._map.getCanvas(),m);for(const{handlerName:oe,handler:he,allowed:fe}of this._handlers){if(!he.isEnabled())continue;let _e;this._blockedByActive(D,fe,oe)?he.reset():he[y||m.type]&&(_e=he[y||m.type](m,H,z),this.mergeHandlerResult(C,M,_e,oe,E),_e&&_e.needsRenderFrame&&this._triggerRenderFrame()),(_e||he.isActive())&&(D[oe]=he)}const Y={};for(const oe in this._previousActiveHandlers)D[oe]||(Y[oe]=E);this._previousActiveHandlers=D,(Object.keys(Y).length||Cl(C))&&(this._changes.push([C,M,Y]),this._triggerRenderFrame()),(Object.keys(D).length||Cl(C))&&this._map._stop(!0),this._updatingCamera=!1;const{cameraAnimation:K}=C;K&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],K(this._map))},this._map=n,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new su(n),this._bearingSnap=d.bearingSnap,this._previousActiveHandlers={},this._eventsInProgress={},this._addDefaultHandlers(d);const p=this._el;this._listeners=[[p,"touchstart",{passive:!0}],[p,"touchmove",{passive:!1}],[p,"touchend",void 0],[p,"touchcancel",void 0],[p,"mousedown",void 0],[p,"mousemove",void 0],[p,"mouseup",void 0],[document,"mousemove",{capture:!0}],[document,"mouseup",void 0],[p,"mouseover",void 0],[p,"mouseout",void 0],[p,"dblclick",void 0],[p,"click",void 0],[p,"keydown",{capture:!1}],[p,"keyup",void 0],[p,"wheel",{passive:!1}],[p,"contextmenu",void 0],[window,"blur",void 0]];for(const[m,y,E]of this._listeners)P.addEventListener(m,y,m===document?this.handleWindowEvent:this.handleEvent,E)}destroy(){for(const[n,d,p]of this._listeners)P.removeEventListener(n,d,n===document?this.handleWindowEvent:this.handleEvent,p)}_addDefaultHandlers(n){const d=this._map,p=d.getCanvasContainer();this._add("mapEvent",new md(d,n));const m=d.boxZoom=new Qr(d,n);this._add("boxZoom",m),n.interactive&&n.boxZoom&&m.enable();const y=d.cooperativeGestures=new wo(d,n.cooperativeGestures);this._add("cooperativeGestures",y),n.cooperativeGestures&&y.enable();const E=new bo(d),C=new Zp(d);d.doubleClickZoom=new jn(C,E),this._add("tapZoom",E),this._add("clickZoom",C),n.interactive&&n.doubleClickZoom&&d.doubleClickZoom.enable();const M=new Yp;this._add("tapDragZoom",M);const D=d.touchPitch=new xa(d);this._add("touchPitch",D),n.interactive&&n.touchPitch&&d.touchPitch.enable(n.touchPitch);const N=lu(n),z=cu(n);d.dragRotate=new xd(n,N,z),this._add("mouseRotate",N,["mousePitch"]),this._add("mousePitch",z,["mouseRotate"]),n.interactive&&n.dragRotate&&d.dragRotate.enable();const H=(({enable:_e,clickTolerance:re})=>{const be=new Sl({checkCorrectEvent:Se=>P.mouseButton(Se)===0&&!Se.ctrlKey});return new en({clickTolerance:re,move:(Se,De)=>({around:De,panDelta:De.sub(Se)}),activateOnStart:!0,moveStateManager:be,enable:_e,assignEvents:Al})})(n),Y=new Vn(n,d);d.dragPan=new yd(p,H,Y),this._add("mousePan",H),this._add("touchPan",Y,["touchZoom","touchRotate"]),n.interactive&&n.dragPan&&d.dragPan.enable(n.dragPan);const K=new fu,oe=new hu;d.touchZoomRotate=new gu(p,oe,K,M),this._add("touchRotate",K,["touchPan","touchZoom"]),this._add("touchZoom",oe,["touchPan","touchRotate"]),n.interactive&&n.touchZoomRotate&&d.touchZoomRotate.enable(n.touchZoomRotate);const he=d.scrollZoom=new Ss(d,(()=>this._triggerRenderFrame()));this._add("scrollZoom",he,["mousePan"]),n.interactive&&n.scrollZoom&&d.scrollZoom.enable(n.scrollZoom);const fe=d.keyboard=new us(d);this._add("keyboard",fe),n.interactive&&n.keyboard&&d.keyboard.enable(),this._add("blockableMapEvent",new Vi(d))}_add(n,d,p){this._handlers.push({handlerName:n,handler:d,allowed:p}),this._handlersById[n]=d}stop(n){if(!this._updatingCamera){for(const{handler:d}of this._handlers)d.reset();this._inertia.clear(),this._fireEvents({},{},n),this._changes=[]}}isActive(){for(const{handler:n}of this._handlers)if(n.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!hs(this._eventsInProgress)||this.isZooming()}_blockedByActive(n,d,p){for(const m in n)if(m!==p&&(!d||d.indexOf(m)<0))return!0;return!1}_getMapTouches(n){const d=[];for(const p of n)this._el.contains(p.target)&&d.push(p);return d}mergeHandlerResult(n,d,p,m,y){if(!p)return;l.e(n,p);const E={handlerName:m,originalEvent:p.originalEvent||y};p.zoomDelta!==void 0&&(d.zoom=E),p.panDelta!==void 0&&(d.drag=E),p.pitchDelta!==void 0&&(d.pitch=E),p.bearingDelta!==void 0&&(d.rotate=E)}_applyChanges(){const n={},d={},p={};for(const[m,y,E]of this._changes)m.panDelta&&(n.panDelta=(n.panDelta||new l.P(0,0))._add(m.panDelta)),m.zoomDelta&&(n.zoomDelta=(n.zoomDelta||0)+m.zoomDelta),m.bearingDelta&&(n.bearingDelta=(n.bearingDelta||0)+m.bearingDelta),m.pitchDelta&&(n.pitchDelta=(n.pitchDelta||0)+m.pitchDelta),m.around!==void 0&&(n.around=m.around),m.pinchAround!==void 0&&(n.pinchAround=m.pinchAround),m.noInertia&&(n.noInertia=m.noInertia),l.e(d,y),l.e(p,E);this._updateMapTransform(n,d,p),this._changes=[]}_updateMapTransform(n,d,p){const m=this._map,y=m._getTransformForUpdate(),E=m.terrain;if(!(Cl(n)||E&&this._terrainMovement))return this._fireEvents(d,p,!0);let{panDelta:C,zoomDelta:M,bearingDelta:D,pitchDelta:N,around:z,pinchAround:H}=n;H!==void 0&&(z=H),m._stop(!0),z=z||m.transform.centerPoint;const Y=y.pointLocation(C?z.sub(C):z);D&&(y.bearing+=D),N&&(y.pitch+=N),M&&(y.zoom+=M),E?this._terrainMovement||!d.drag&&!d.zoom?d.drag&&this._terrainMovement?y.center=y.pointLocation(y.centerPoint.sub(C)):y.setLocationAtPoint(Y,z):(this._terrainMovement=!0,this._map._elevationFreeze=!0,y.setLocationAtPoint(Y,z)):y.setLocationAtPoint(Y,z),m._applyUpdatedTransform(y),this._map._update(),n.noInertia||this._inertia.record(n),this._fireEvents(d,p,!0)}_fireEvents(n,d,p){const m=hs(this._eventsInProgress),y=hs(n),E={};for(const z in n){const{originalEvent:H}=n[z];this._eventsInProgress[z]||(E[`${z}start`]=H),this._eventsInProgress[z]=n[z]}!m&&y&&this._fireEvent("movestart",y.originalEvent);for(const z in E)this._fireEvent(z,E[z]);y&&this._fireEvent("move",y.originalEvent);for(const z in n){const{originalEvent:H}=n[z];this._fireEvent(z,H)}const C={};let M;for(const z in this._eventsInProgress){const{handlerName:H,originalEvent:Y}=this._eventsInProgress[z];this._handlersById[H].isActive()||(delete this._eventsInProgress[z],M=d[H]||Y,C[`${z}end`]=M)}for(const z in C)this._fireEvent(z,C[z]);const D=hs(this._eventsInProgress),N=(m||y)&&!D;if(N&&this._terrainMovement){this._map._elevationFreeze=!1,this._terrainMovement=!1;const z=this._map._getTransformForUpdate();z.recalculateZoom(this._map.terrain),this._map._applyUpdatedTransform(z)}if(p&&N){this._updatingCamera=!0;const z=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),H=Y=>Y!==0&&-this._bearingSnap<Y&&Y<this._bearingSnap;!z||!z.essential&&S.prefersReducedMotion?(this._map.fire(new l.k("moveend",{originalEvent:M})),H(this._map.getBearing())&&this._map.resetNorth()):(H(z.bearing||this._map.getBearing())&&(z.bearing=0),z.freezeElevation=!0,this._map.easeTo(z,{originalEvent:M})),this._updatingCamera=!1}}_fireEvent(n,d){this._map.fire(new l.k(n,d?{originalEvent:d}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add((n=>{delete this._frameId,this.handleEvent(new vt("renderFrame",{timeStamp:n})),this._applyChanges()}))}_triggerRenderFrame(){this._frameId===void 0&&(this._frameId=this._requestFrame())}}class vd extends l.E{constructor(n,d){super(),this._renderFrameCallback=()=>{const p=Math.min((S.now()-this._easeStart)/this._easeOptions.duration,1);this._onEaseFrame(this._easeOptions.easing(p)),p<1&&this._easeFrameId?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()},this._moving=!1,this._zooming=!1,this.transform=n,this._bearingSnap=d.bearingSnap,this.on("moveend",(()=>{delete this._requestedCameraState}))}getCenter(){return new l.N(this.transform.center.lng,this.transform.center.lat)}setCenter(n,d){return this.jumpTo({center:n},d)}panBy(n,d,p){return n=l.P.convert(n).mult(-1),this.panTo(this.transform.center,l.e({offset:n},d),p)}panTo(n,d,p){return this.easeTo(l.e({center:n},d),p)}getZoom(){return this.transform.zoom}setZoom(n,d){return this.jumpTo({zoom:n},d),this}zoomTo(n,d,p){return this.easeTo(l.e({zoom:n},d),p)}zoomIn(n,d){return this.zoomTo(this.getZoom()+1,n,d),this}zoomOut(n,d){return this.zoomTo(this.getZoom()-1,n,d),this}getBearing(){return this.transform.bearing}setBearing(n,d){return this.jumpTo({bearing:n},d),this}getPadding(){return this.transform.padding}setPadding(n,d){return this.jumpTo({padding:n},d),this}rotateTo(n,d,p){return this.easeTo(l.e({bearing:n},d),p)}resetNorth(n,d){return this.rotateTo(0,l.e({duration:1e3},n),d),this}resetNorthPitch(n,d){return this.easeTo(l.e({bearing:0,pitch:0,duration:1e3},n),d),this}snapToNorth(n,d){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(n,d):this}getPitch(){return this.transform.pitch}setPitch(n,d){return this.jumpTo({pitch:n},d),this}cameraForBounds(n,d){n=Ce.convert(n).adjustAntiMeridian();const p=d&&d.bearing||0;return this._cameraForBoxAndBearing(n.getNorthWest(),n.getSouthEast(),p,d)}_cameraForBoxAndBearing(n,d,p,m){const y={top:0,bottom:0,right:0,left:0};if(typeof(m=l.e({padding:y,offset:[0,0],maxZoom:this.transform.maxZoom},m)).padding=="number"){const lt=m.padding;m.padding={top:lt,bottom:lt,right:lt,left:lt}}m.padding=l.e(y,m.padding);const E=this.transform,C=E.padding,M=new Ce(n,d),D=E.project(M.getNorthWest()),N=E.project(M.getNorthEast()),z=E.project(M.getSouthEast()),H=E.project(M.getSouthWest()),Y=l.ba(-p),K=D.rotate(Y),oe=N.rotate(Y),he=z.rotate(Y),fe=H.rotate(Y),_e=new l.P(Math.max(K.x,oe.x,fe.x,he.x),Math.max(K.y,oe.y,fe.y,he.y)),re=new l.P(Math.min(K.x,oe.x,fe.x,he.x),Math.min(K.y,oe.y,fe.y,he.y)),be=_e.sub(re),Se=(E.width-(C.left+C.right+m.padding.left+m.padding.right))/be.x,De=(E.height-(C.top+C.bottom+m.padding.top+m.padding.bottom))/be.y;if(De<0||Se<0)return void l.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");const Xe=Math.min(E.scaleZoom(E.scale*Math.min(Se,De)),m.maxZoom),rt=l.P.convert(m.offset),dt=new l.P((m.padding.left-m.padding.right)/2,(m.padding.top-m.padding.bottom)/2).rotate(l.ba(p)),yt=rt.add(dt).mult(E.scale/E.zoomScale(Xe));return{center:E.unproject(D.add(z).div(2).sub(yt)),zoom:Xe,bearing:p}}fitBounds(n,d,p){return this._fitInternal(this.cameraForBounds(n,d),d,p)}fitScreenCoordinates(n,d,p,m,y){return this._fitInternal(this._cameraForBoxAndBearing(this.transform.pointLocation(l.P.convert(n)),this.transform.pointLocation(l.P.convert(d)),p,m),m,y)}_fitInternal(n,d,p){return n?(delete(d=l.e(n,d)).padding,d.linear?this.easeTo(d,p):this.flyTo(d,p)):this}jumpTo(n,d){this.stop();const p=this._getTransformForUpdate();let m=!1,y=!1,E=!1;return"zoom"in n&&p.zoom!==+n.zoom&&(m=!0,p.zoom=+n.zoom),n.center!==void 0&&(p.center=l.N.convert(n.center)),"bearing"in n&&p.bearing!==+n.bearing&&(y=!0,p.bearing=+n.bearing),"pitch"in n&&p.pitch!==+n.pitch&&(E=!0,p.pitch=+n.pitch),n.padding==null||p.isPaddingEqual(n.padding)||(p.padding=n.padding),this._applyUpdatedTransform(p),this.fire(new l.k("movestart",d)).fire(new l.k("move",d)),m&&this.fire(new l.k("zoomstart",d)).fire(new l.k("zoom",d)).fire(new l.k("zoomend",d)),y&&this.fire(new l.k("rotatestart",d)).fire(new l.k("rotate",d)).fire(new l.k("rotateend",d)),E&&this.fire(new l.k("pitchstart",d)).fire(new l.k("pitch",d)).fire(new l.k("pitchend",d)),this.fire(new l.k("moveend",d))}calculateCameraOptionsFromTo(n,d,p,m=0){const y=l.Z.fromLngLat(n,d),E=l.Z.fromLngLat(p,m),C=E.x-y.x,M=E.y-y.y,D=E.z-y.z,N=Math.hypot(C,M,D);if(N===0)throw new Error("Can't calculate camera options with same From and To");const z=Math.hypot(C,M),H=this.transform.scaleZoom(this.transform.cameraToCenterDistance/N/this.transform.tileSize),Y=180*Math.atan2(C,-M)/Math.PI;let K=180*Math.acos(z/N)/Math.PI;return K=D<0?90-K:90+K,{center:E.toLngLat(),zoom:H,pitch:K,bearing:Y}}easeTo(n,d){var p;this._stop(!1,n.easeId),((n=l.e({offset:[0,0],duration:500,easing:l.b9},n)).animate===!1||!n.essential&&S.prefersReducedMotion)&&(n.duration=0);const m=this._getTransformForUpdate(),y=m.zoom,E=m.bearing,C=m.pitch,M=m.padding,D="bearing"in n?this._normalizeBearing(n.bearing,E):E,N="pitch"in n?+n.pitch:C,z="padding"in n?n.padding:m.padding,H=l.P.convert(n.offset);let Y=m.centerPoint.add(H);const K=m.pointLocation(Y),{center:oe,zoom:he}=m.getConstrained(l.N.convert(n.center||K),(p=n.zoom)!==null&&p!==void 0?p:y);this._normalizeCenter(oe,m);const fe=m.project(K),_e=m.project(oe).sub(fe),re=m.zoomScale(he-y);let be,Se;n.around&&(be=l.N.convert(n.around),Se=m.locationPoint(be));const De={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};return this._zooming=this._zooming||he!==y,this._rotating=this._rotating||E!==D,this._pitching=this._pitching||N!==C,this._padding=!m.isPaddingEqual(z),this._easeId=n.easeId,this._prepareEase(d,n.noMoveStart,De),this.terrain&&this._prepareElevation(oe),this._ease((Xe=>{if(this._zooming&&(m.zoom=l.y.number(y,he,Xe)),this._rotating&&(m.bearing=l.y.number(E,D,Xe)),this._pitching&&(m.pitch=l.y.number(C,N,Xe)),this._padding&&(m.interpolatePadding(M,z,Xe),Y=m.centerPoint.add(H)),this.terrain&&!n.freezeElevation&&this._updateElevation(Xe),be)m.setLocationAtPoint(be,Se);else{const rt=m.zoomScale(m.zoom-y),dt=he>y?Math.min(2,re):Math.max(.5,re),yt=Math.pow(dt,1-Xe),lt=m.unproject(fe.add(_e.mult(Xe*yt)).mult(rt));m.setLocationAtPoint(m.renderWorldCopies?lt.wrap():lt,Y)}this._applyUpdatedTransform(m),this._fireMoveEvents(d)}),(Xe=>{this.terrain&&n.freezeElevation&&this._finalizeElevation(),this._afterEase(d,Xe)}),n),this}_prepareEase(n,d,p={}){this._moving=!0,d||p.moving||this.fire(new l.k("movestart",n)),this._zooming&&!p.zooming&&this.fire(new l.k("zoomstart",n)),this._rotating&&!p.rotating&&this.fire(new l.k("rotatestart",n)),this._pitching&&!p.pitching&&this.fire(new l.k("pitchstart",n))}_prepareElevation(n){this._elevationCenter=n,this._elevationStart=this.transform.elevation,this._elevationTarget=this.terrain.getElevationForLngLatZoom(n,this.transform.tileZoom),this._elevationFreeze=!0}_updateElevation(n){this.transform.minElevationForCurrentTile=this.terrain.getMinTileElevationForLngLatZoom(this._elevationCenter,this.transform.tileZoom);const d=this.terrain.getElevationForLngLatZoom(this._elevationCenter,this.transform.tileZoom);if(n<1&&d!==this._elevationTarget){const p=this._elevationTarget-this._elevationStart;this._elevationStart+=n*(p-(d-(p*n+this._elevationStart))/(1-n)),this._elevationTarget=d}this.transform.elevation=l.y.number(this._elevationStart,this._elevationTarget,n)}_finalizeElevation(){this._elevationFreeze=!1,this.transform.recalculateZoom(this.terrain)}_getTransformForUpdate(){return this.transformCameraUpdate||this.terrain?(this._requestedCameraState||(this._requestedCameraState=this.transform.clone()),this._requestedCameraState):this.transform}_elevateCameraIfInsideTerrain(n){const d=n.getCameraPosition(),p=this.terrain.getElevationForLngLatZoom(d.lngLat,n.zoom);if(d.altitude<p){const m=this.calculateCameraOptionsFromTo(d.lngLat,p,n.center,n.elevation);return{pitch:m.pitch,zoom:m.zoom}}return{}}_applyUpdatedTransform(n){const d=[];if(this.terrain&&d.push((m=>this._elevateCameraIfInsideTerrain(m))),this.transformCameraUpdate&&d.push((m=>this.transformCameraUpdate(m))),!d.length)return;const p=n.clone();for(const m of d){const y=p.clone(),{center:E,zoom:C,pitch:M,bearing:D,elevation:N}=m(y);E&&(y.center=E),C!==void 0&&(y.zoom=C),M!==void 0&&(y.pitch=M),D!==void 0&&(y.bearing=D),N!==void 0&&(y.elevation=N),p.apply(y)}this.transform.apply(p)}_fireMoveEvents(n){this.fire(new l.k("move",n)),this._zooming&&this.fire(new l.k("zoom",n)),this._rotating&&this.fire(new l.k("rotate",n)),this._pitching&&this.fire(new l.k("pitch",n))}_afterEase(n,d){if(this._easeId&&d&&this._easeId===d)return;delete this._easeId;const p=this._zooming,m=this._rotating,y=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._padding=!1,p&&this.fire(new l.k("zoomend",n)),m&&this.fire(new l.k("rotateend",n)),y&&this.fire(new l.k("pitchend",n)),this.fire(new l.k("moveend",n))}flyTo(n,d){var p;if(!n.essential&&S.prefersReducedMotion){const gt=l.M(n,["center","zoom","bearing","pitch","around"]);return this.jumpTo(gt,d)}this.stop(),n=l.e({offset:[0,0],speed:1.2,curve:1.42,easing:l.b9},n);const m=this._getTransformForUpdate(),y=m.zoom,E=m.bearing,C=m.pitch,M=m.padding,D="bearing"in n?this._normalizeBearing(n.bearing,E):E,N="pitch"in n?+n.pitch:C,z="padding"in n?n.padding:m.padding,H=l.P.convert(n.offset);let Y=m.centerPoint.add(H);const K=m.pointLocation(Y),{center:oe,zoom:he}=m.getConstrained(l.N.convert(n.center||K),(p=n.zoom)!==null&&p!==void 0?p:y);this._normalizeCenter(oe,m);const fe=m.zoomScale(he-y),_e=m.project(K),re=m.project(oe).sub(_e);let be=n.curve;const Se=Math.max(m.width,m.height),De=Se/fe,Xe=re.mag();if("minZoom"in n){const gt=l.ac(Math.min(n.minZoom,y,he),m.minZoom,m.maxZoom),Ut=Se/m.zoomScale(gt-y);be=Math.sqrt(Ut/Xe*2)}const rt=be*be;function dt(gt){const Ut=(De*De-Se*Se+(gt?-1:1)*rt*rt*Xe*Xe)/(2*(gt?De:Se)*rt*Xe);return Math.log(Math.sqrt(Ut*Ut+1)-Ut)}function yt(gt){return(Math.exp(gt)-Math.exp(-gt))/2}function lt(gt){return(Math.exp(gt)+Math.exp(-gt))/2}const at=dt(!1);let At=function(gt){return lt(at)/lt(at+be*gt)},jt=function(gt){return Se*((lt(at)*(yt(Ut=at+be*gt)/lt(Ut))-yt(at))/rt)/Xe;var Ut},ct=(dt(!0)-at)/be;if(Math.abs(Xe)<1e-6||!isFinite(ct)){if(Math.abs(Se-De)<1e-6)return this.easeTo(n,d);const gt=De<Se?-1:1;ct=Math.abs(Math.log(De/Se))/be,jt=()=>0,At=Ut=>Math.exp(gt*be*Ut)}return n.duration="duration"in n?+n.duration:1e3*ct/("screenSpeed"in n?+n.screenSpeed/be:+n.speed),n.maxDuration&&n.duration>n.maxDuration&&(n.duration=0),this._zooming=!0,this._rotating=E!==D,this._pitching=N!==C,this._padding=!m.isPaddingEqual(z),this._prepareEase(d,!1),this.terrain&&this._prepareElevation(oe),this._ease((gt=>{const Ut=gt*ct,Si=1/At(Ut);m.zoom=gt===1?he:y+m.scaleZoom(Si),this._rotating&&(m.bearing=l.y.number(E,D,gt)),this._pitching&&(m.pitch=l.y.number(C,N,gt)),this._padding&&(m.interpolatePadding(M,z,gt),Y=m.centerPoint.add(H)),this.terrain&&!n.freezeElevation&&this._updateElevation(gt);const Xt=gt===1?oe:m.unproject(_e.add(re.mult(jt(Ut))).mult(Si));m.setLocationAtPoint(m.renderWorldCopies?Xt.wrap():Xt,Y),this._applyUpdatedTransform(m),this._fireMoveEvents(d)}),(()=>{this.terrain&&n.freezeElevation&&this._finalizeElevation(),this._afterEase(d)}),n),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_stop(n,d){var p;if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),delete this._easeFrameId,delete this._onEaseFrame),this._onEaseEnd){const m=this._onEaseEnd;delete this._onEaseEnd,m.call(this,d)}return n||(p=this.handlers)===null||p===void 0||p.stop(!1),this}_ease(n,d,p){p.animate===!1||p.duration===0?(n(1),d()):(this._easeStart=S.now(),this._easeOptions=p,this._onEaseFrame=n,this._onEaseEnd=d,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_normalizeBearing(n,d){n=l.b3(n,-180,180);const p=Math.abs(n-d);return Math.abs(n-360-d)<p&&(n-=360),Math.abs(n+360-d)<p&&(n+=360),n}_normalizeCenter(n,d){if(!d.renderWorldCopies||d.lngRange)return;const p=n.lng-d.center.lng;n.lng+=p>180?-360:p<-180?360:0}queryTerrainElevation(n){return this.terrain?this.terrain.getElevationForLngLatZoom(l.N.convert(n),this.transform.tileZoom)-this.transform.elevation:null}}const To={compact:!0,customAttribution:'<a href="https://maplibre.org/" target="_blank">MapLibre</a>'};class So{constructor(n=To){this._toggleAttribution=()=>{this._container.classList.contains("maplibregl-compact")&&(this._container.classList.contains("maplibregl-compact-show")?(this._container.setAttribute("open",""),this._container.classList.remove("maplibregl-compact-show")):(this._container.classList.add("maplibregl-compact-show"),this._container.removeAttribute("open")))},this._updateData=d=>{!d||d.sourceDataType!=="metadata"&&d.sourceDataType!=="visibility"&&d.dataType!=="style"&&d.type!=="terrain"||this._updateAttributions()},this._updateCompact=()=>{this._map.getCanvasContainer().offsetWidth<=640||this._compact?this._compact===!1?this._container.setAttribute("open",""):this._container.classList.contains("maplibregl-compact")||this._container.classList.contains("maplibregl-attrib-empty")||(this._container.setAttribute("open",""),this._container.classList.add("maplibregl-compact","maplibregl-compact-show")):(this._container.setAttribute("open",""),this._container.classList.contains("maplibregl-compact")&&this._container.classList.remove("maplibregl-compact","maplibregl-compact-show"))},this._updateCompactMinimize=()=>{this._container.classList.contains("maplibregl-compact")&&this._container.classList.contains("maplibregl-compact-show")&&this._container.classList.remove("maplibregl-compact-show")},this.options=n}getDefaultPosition(){return"bottom-right"}onAdd(n){return this._map=n,this._compact=this.options.compact,this._container=P.create("details","maplibregl-ctrl maplibregl-ctrl-attrib"),this._compactButton=P.create("summary","maplibregl-ctrl-attrib-button",this._container),this._compactButton.addEventListener("click",this._toggleAttribution),this._setElementTitle(this._compactButton,"ToggleAttribution"),this._innerContainer=P.create("div","maplibregl-ctrl-attrib-inner",this._container),this._updateAttributions(),this._updateCompact(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("terrain",this._updateData),this._map.on("resize",this._updateCompact),this._map.on("drag",this._updateCompactMinimize),this._container}onRemove(){P.remove(this._container),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("terrain",this._updateData),this._map.off("resize",this._updateCompact),this._map.off("drag",this._updateCompactMinimize),this._map=void 0,this._compact=void 0,this._attribHTML=void 0}_setElementTitle(n,d){const p=this._map._getUIString(`AttributionControl.${d}`);n.title=p,n.setAttribute("aria-label",p)}_updateAttributions(){if(!this._map.style)return;let n=[];if(this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?n=n.concat(this.options.customAttribution.map((m=>typeof m!="string"?"":m))):typeof this.options.customAttribution=="string"&&n.push(this.options.customAttribution)),this._map.style.stylesheet){const m=this._map.style.stylesheet;this.styleOwner=m.owner,this.styleId=m.id}const d=this._map.style.sourceCaches;for(const m in d){const y=d[m];if(y.used||y.usedForTerrain){const E=y.getSource();E.attribution&&n.indexOf(E.attribution)<0&&n.push(E.attribution)}}n=n.filter((m=>String(m).trim())),n.sort(((m,y)=>m.length-y.length)),n=n.filter(((m,y)=>{for(let E=y+1;E<n.length;E++)if(n[E].indexOf(m)>=0)return!1;return!0}));const p=n.join(" | ");p!==this._attribHTML&&(this._attribHTML=p,n.length?(this._innerContainer.innerHTML=p,this._container.classList.remove("maplibregl-attrib-empty")):this._container.classList.add("maplibregl-attrib-empty"),this._updateCompact(),this._editLink=null)}}class _u{constructor(n={}){this._updateCompact=()=>{const d=this._container.children;if(d.length){const p=d[0];this._map.getCanvasContainer().offsetWidth<=640||this._compact?this._compact!==!1&&p.classList.add("maplibregl-compact"):p.classList.remove("maplibregl-compact")}},this.options=n}getDefaultPosition(){return"bottom-left"}onAdd(n){this._map=n,this._compact=this.options&&this.options.compact,this._container=P.create("div","maplibregl-ctrl");const d=P.create("a","maplibregl-ctrl-logo");return d.target="_blank",d.rel="noopener nofollow",d.href="https://maplibre.org/",d.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),d.setAttribute("rel","noopener nofollow"),this._container.appendChild(d),this._container.style.display="block",this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){P.remove(this._container),this._map.off("resize",this._updateCompact),this._map=void 0,this._compact=void 0}}class ei{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(n){const d=++this._id;return this._queue.push({callback:n,id:d,cancelled:!1}),d}remove(n){const d=this._currentlyRunning,p=d?this._queue.concat(d):this._queue;for(const m of p)if(m.id===n)return void(m.cancelled=!0)}run(n=0){if(this._currentlyRunning)throw new Error("Attempting to run(), but is already running.");const d=this._currentlyRunning=this._queue;this._queue=[];for(const p of d)if(!p.cancelled&&(p.callback(n),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}var yu=l.Y([{name:"a_pos3d",type:"Int16",components:3}]);class Gp extends l.E{constructor(n){super(),this.sourceCache=n,this._tiles={},this._renderableTilesKeys=[],this._sourceTileCache={},this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.deltaZoom=1,n.usedForTerrain=!0,n.tileSize=this.tileSize*2**this.deltaZoom}destruct(){this.sourceCache.usedForTerrain=!1,this.sourceCache.tileSize=null}update(n,d){this.sourceCache.update(n,d),this._renderableTilesKeys=[];const p={};for(const m of n.coveringTiles({tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,reparseOverscaled:!1,terrain:d}))p[m.key]=!0,this._renderableTilesKeys.push(m.key),this._tiles[m.key]||(m.posMatrix=new Float64Array(16),l.aP(m.posMatrix,0,l.X,0,l.X,0,1),this._tiles[m.key]=new ys(m,this.tileSize));for(const m in this._tiles)p[m]||delete this._tiles[m]}freeRtt(n){for(const d in this._tiles){const p=this._tiles[d];(!n||p.tileID.equals(n)||p.tileID.isChildOf(n)||n.isChildOf(p.tileID))&&(p.rtt=[])}}getRenderableTiles(){return this._renderableTilesKeys.map((n=>this.getTileByID(n)))}getTileByID(n){return this._tiles[n]}getTerrainCoords(n){const d={};for(const p of this._renderableTilesKeys){const m=this._tiles[p].tileID;if(m.canonical.equals(n.canonical)){const y=n.clone();y.posMatrix=new Float64Array(16),l.aP(y.posMatrix,0,l.X,0,l.X,0,1),d[p]=y}else if(m.canonical.isChildOf(n.canonical)){const y=n.clone();y.posMatrix=new Float64Array(16);const E=m.canonical.z-n.canonical.z,C=m.canonical.x-(m.canonical.x>>E<<E),M=m.canonical.y-(m.canonical.y>>E<<E),D=l.X>>E;l.aP(y.posMatrix,0,D,0,D,0,1),l.J(y.posMatrix,y.posMatrix,[-C*D,-M*D,0]),d[p]=y}else if(n.canonical.isChildOf(m.canonical)){const y=n.clone();y.posMatrix=new Float64Array(16);const E=n.canonical.z-m.canonical.z,C=n.canonical.x-(n.canonical.x>>E<<E),M=n.canonical.y-(n.canonical.y>>E<<E),D=l.X>>E;l.aP(y.posMatrix,0,l.X,0,l.X,0,1),l.J(y.posMatrix,y.posMatrix,[C*D,M*D,0]),l.K(y.posMatrix,y.posMatrix,[1/2**E,1/2**E,0]),d[p]=y}}return d}getSourceTile(n,d){const p=this.sourceCache._source;let m=n.overscaledZ-this.deltaZoom;if(m>p.maxzoom&&(m=p.maxzoom),m<p.minzoom)return null;this._sourceTileCache[n.key]||(this._sourceTileCache[n.key]=n.scaledTo(m).key);let y=this.sourceCache.getTileByID(this._sourceTileCache[n.key]);if((!y||!y.dem)&&d)for(;m>=p.minzoom&&(!y||!y.dem);)y=this.sourceCache.getTileByID(n.scaledTo(m--).key);return y}tilesAfterTime(n=Date.now()){return Object.values(this._tiles).filter((d=>d.timeAdded>=n))}}class xu{constructor(n,d,p){this.painter=n,this.sourceCache=new Gp(d),this.options=p,this.exaggeration=typeof p.exaggeration=="number"?p.exaggeration:1,this.qualityFactor=2,this.meshSize=128,this._demMatrixCache={},this.coordsIndex=[],this._coordsTextureSize=1024}getDEMElevation(n,d,p,m=l.X){var y;if(!(d>=0&&d<m&&p>=0&&p<m))return 0;const E=this.getTerrainData(n),C=(y=E.tile)===null||y===void 0?void 0:y.dem;if(!C)return 0;const M=(function(K,oe,he){var fe=oe[0],_e=oe[1];return K[0]=he[0]*fe+he[4]*_e+he[12],K[1]=he[1]*fe+he[5]*_e+he[13],K})([],[d/m*l.X,p/m*l.X],E.u_terrain_matrix),D=[M[0]*C.dim,M[1]*C.dim],N=Math.floor(D[0]),z=Math.floor(D[1]),H=D[0]-N,Y=D[1]-z;return C.get(N,z)*(1-H)*(1-Y)+C.get(N+1,z)*H*(1-Y)+C.get(N,z+1)*(1-H)*Y+C.get(N+1,z+1)*H*Y}getElevationForLngLatZoom(n,d){if(!l.bb(d,n.wrap()))return 0;const{tileID:p,mercatorX:m,mercatorY:y}=this._getOverscaledTileIDFromLngLatZoom(n,d);return this.getElevation(p,m%l.X,y%l.X,l.X)}getElevation(n,d,p,m=l.X){return this.getDEMElevation(n,d,p,m)*this.exaggeration}getTerrainData(n){if(!this._emptyDemTexture){const m=this.painter.context,y=new l.R({width:1,height:1},new Uint8Array(4));this._emptyDepthTexture=new Ye(m,y,m.gl.RGBA,{premultiply:!1}),this._emptyDemUnpack=[0,0,0,0],this._emptyDemTexture=new Ye(m,new l.R({width:1,height:1}),m.gl.RGBA,{premultiply:!1}),this._emptyDemTexture.bind(m.gl.NEAREST,m.gl.CLAMP_TO_EDGE),this._emptyDemMatrix=l.an([])}const d=this.sourceCache.getSourceTile(n,!0);if(d&&d.dem&&(!d.demTexture||d.needsTerrainPrepare)){const m=this.painter.context;d.demTexture=this.painter.getTileTexture(d.dem.stride),d.demTexture?d.demTexture.update(d.dem.getPixels(),{premultiply:!1}):d.demTexture=new Ye(m,d.dem.getPixels(),m.gl.RGBA,{premultiply:!1}),d.demTexture.bind(m.gl.NEAREST,m.gl.CLAMP_TO_EDGE),d.needsTerrainPrepare=!1}const p=d&&d+d.tileID.key+n.key;if(p&&!this._demMatrixCache[p]){const m=this.sourceCache.sourceCache._source.maxzoom;let y=n.canonical.z-d.tileID.canonical.z;n.overscaledZ>n.canonical.z&&(n.canonical.z>=m?y=n.canonical.z-m:l.w("cannot calculate elevation if elevation maxzoom > source.maxzoom"));const E=n.canonical.x-(n.canonical.x>>y<<y),C=n.canonical.y-(n.canonical.y>>y<<y),M=l.bc(new Float64Array(16),[1/(l.X<<y),1/(l.X<<y),0]);l.J(M,M,[E*l.X,C*l.X,0]),this._demMatrixCache[n.key]={matrix:M,coord:n}}return{u_depth:2,u_terrain:3,u_terrain_dim:d&&d.dem&&d.dem.dim||1,u_terrain_matrix:p?this._demMatrixCache[n.key].matrix:this._emptyDemMatrix,u_terrain_unpack:d&&d.dem&&d.dem.getUnpackVector()||this._emptyDemUnpack,u_terrain_exaggeration:this.exaggeration,texture:(d&&d.demTexture||this._emptyDemTexture).texture,depthTexture:(this._fboDepthTexture||this._emptyDepthTexture).texture,tile:d}}getFramebuffer(n){const d=this.painter,p=d.width/devicePixelRatio,m=d.height/devicePixelRatio;return!this._fbo||this._fbo.width===p&&this._fbo.height===m||(this._fbo.destroy(),this._fboCoordsTexture.destroy(),this._fboDepthTexture.destroy(),delete this._fbo,delete this._fboDepthTexture,delete this._fboCoordsTexture),this._fboCoordsTexture||(this._fboCoordsTexture=new Ye(d.context,{width:p,height:m,data:null},d.context.gl.RGBA,{premultiply:!1}),this._fboCoordsTexture.bind(d.context.gl.NEAREST,d.context.gl.CLAMP_TO_EDGE)),this._fboDepthTexture||(this._fboDepthTexture=new Ye(d.context,{width:p,height:m,data:null},d.context.gl.RGBA,{premultiply:!1}),this._fboDepthTexture.bind(d.context.gl.NEAREST,d.context.gl.CLAMP_TO_EDGE)),this._fbo||(this._fbo=d.context.createFramebuffer(p,m,!0,!1),this._fbo.depthAttachment.set(d.context.createRenderbuffer(d.context.gl.DEPTH_COMPONENT16,p,m))),this._fbo.colorAttachment.set(n==="coords"?this._fboCoordsTexture.texture:this._fboDepthTexture.texture),this._fbo}getCoordsTexture(){const n=this.painter.context;if(this._coordsTexture)return this._coordsTexture;const d=new Uint8Array(this._coordsTextureSize*this._coordsTextureSize*4);for(let y=0,E=0;y<this._coordsTextureSize;y++)for(let C=0;C<this._coordsTextureSize;C++,E+=4)d[E+0]=255&C,d[E+1]=255&y,d[E+2]=C>>8<<4|y>>8,d[E+3]=0;const p=new l.R({width:this._coordsTextureSize,height:this._coordsTextureSize},new Uint8Array(d.buffer)),m=new Ye(n,p,n.gl.RGBA,{premultiply:!1});return m.bind(n.gl.NEAREST,n.gl.CLAMP_TO_EDGE),this._coordsTexture=m,m}pointCoordinate(n){this.painter.maybeDrawDepthAndCoords(!0);const d=new Uint8Array(4),p=this.painter.context,m=p.gl,y=Math.round(n.x*this.painter.pixelRatio/devicePixelRatio),E=Math.round(n.y*this.painter.pixelRatio/devicePixelRatio),C=Math.round(this.painter.height/devicePixelRatio);p.bindFramebuffer.set(this.getFramebuffer("coords").framebuffer),m.readPixels(y,C-E-1,1,1,m.RGBA,m.UNSIGNED_BYTE,d),p.bindFramebuffer.set(null);const M=d[0]+(d[2]>>4<<8),D=d[1]+((15&d[2])<<8),N=this.coordsIndex[255-d[3]],z=N&&this.sourceCache.getTileByID(N);if(!z)return null;const H=this._coordsTextureSize,Y=(1<<z.tileID.canonical.z)*H;return new l.Z((z.tileID.canonical.x*H+M)/Y+z.tileID.wrap,(z.tileID.canonical.y*H+D)/Y,this.getElevation(z.tileID,M,D,H))}depthAtPoint(n){const d=new Uint8Array(4),p=this.painter.context,m=p.gl;return p.bindFramebuffer.set(this.getFramebuffer("depth").framebuffer),m.readPixels(n.x,this.painter.height/devicePixelRatio-n.y-1,1,1,m.RGBA,m.UNSIGNED_BYTE,d),p.bindFramebuffer.set(null),(d[0]/16777216+d[1]/65536+d[2]/256+d[3])/256}getTerrainMesh(){if(this._mesh)return this._mesh;const n=this.painter.context,d=new l.bd,p=new l.aY,m=this.meshSize,y=l.X/m,E=m*m;for(let z=0;z<=m;z++)for(let H=0;H<=m;H++)d.emplaceBack(H*y,z*y,0);for(let z=0;z<E;z+=m+1)for(let H=0;H<m;H++)p.emplaceBack(H+z,m+H+z+1,m+H+z+2),p.emplaceBack(H+z,m+H+z+2,H+z+1);const C=d.length,M=C+2*(m+1);for(const z of[0,1])for(let H=0;H<=m;H++)for(const Y of[0,1])d.emplaceBack(H*y,z*l.X,Y);for(let z=0;z<2*m;z+=2)p.emplaceBack(M+z,M+z+1,M+z+3),p.emplaceBack(M+z,M+z+3,M+z+2),p.emplaceBack(C+z,C+z+3,C+z+1),p.emplaceBack(C+z,C+z+2,C+z+3);const D=d.length,N=D+2*(m+1);for(const z of[0,1])for(let H=0;H<=m;H++)for(const Y of[0,1])d.emplaceBack(z*l.X,H*y,Y);for(let z=0;z<2*m;z+=2)p.emplaceBack(D+z,D+z+1,D+z+3),p.emplaceBack(D+z,D+z+3,D+z+2),p.emplaceBack(N+z,N+z+3,N+z+1),p.emplaceBack(N+z,N+z+2,N+z+3);return this._mesh=new yl(n.createVertexBuffer(d,yu.members),n.createIndexBuffer(p),l.a0.simpleSegment(0,0,d.length,p.length)),this._mesh}getMeshFrameDelta(n){return 2*Math.PI*l.be/Math.pow(2,n)/5}getMinTileElevationForLngLatZoom(n,d){var p;const{tileID:m}=this._getOverscaledTileIDFromLngLatZoom(n,d);return(p=this.getMinMaxElevation(m).minElevation)!==null&&p!==void 0?p:0}getMinMaxElevation(n){const d=this.getTerrainData(n).tile,p={minElevation:null,maxElevation:null};return d&&d.dem&&(p.minElevation=d.dem.min*this.exaggeration,p.maxElevation=d.dem.max*this.exaggeration),p}_getOverscaledTileIDFromLngLatZoom(n,d){const p=l.Z.fromLngLat(n.wrap()),m=(1<<d)*l.X,y=p.x*m,E=p.y*m,C=Math.floor(y/l.X),M=Math.floor(E/l.X);return{tileID:new l.S(d,0,d,C,M),mercatorX:y,mercatorY:E}}}class Kp{constructor(n,d,p){this._context=n,this._size=d,this._tileSize=p,this._objects=[],this._recentlyUsed=[],this._stamp=0}destruct(){for(const n of this._objects)n.texture.destroy(),n.fbo.destroy()}_createObject(n){const d=this._context.createFramebuffer(this._tileSize,this._tileSize,!0,!0),p=new Ye(this._context,{width:this._tileSize,height:this._tileSize,data:null},this._context.gl.RGBA);return p.bind(this._context.gl.LINEAR,this._context.gl.CLAMP_TO_EDGE),d.depthAttachment.set(this._context.createRenderbuffer(this._context.gl.DEPTH_STENCIL,this._tileSize,this._tileSize)),d.colorAttachment.set(p.texture),{id:n,fbo:d,texture:p,stamp:-1,inUse:!1}}getObjectForId(n){return this._objects[n]}useObject(n){n.inUse=!0,this._recentlyUsed=this._recentlyUsed.filter((d=>n.id!==d)),this._recentlyUsed.push(n.id)}stampObject(n){n.stamp=++this._stamp}getOrCreateFreeObject(){for(const d of this._recentlyUsed)if(!this._objects[d].inUse)return this._objects[d];if(this._objects.length>=this._size)throw new Error("No free RenderPool available, call freeAllObjects() required!");const n=this._createObject(this._objects.length);return this._objects.push(n),n}freeObject(n){n.inUse=!1}freeAllObjects(){for(const n of this._objects)this.freeObject(n)}isFull(){return!(this._objects.length<this._size)&&this._objects.some((n=>!n.inUse))===!1}}const Ao={background:!0,fill:!0,line:!0,raster:!0,hillshade:!0};class bd{constructor(n,d){this.painter=n,this.terrain=d,this.pool=new Kp(n.context,30,d.sourceCache.tileSize*d.qualityFactor)}destruct(){this.pool.destruct()}getTexture(n){return this.pool.getObjectForId(n.rtt[this._stacks.length-1].id).texture}prepareForRender(n,d){this._stacks=[],this._prevType=null,this._rttTiles=[],this._renderableTiles=this.terrain.sourceCache.getRenderableTiles(),this._renderableLayerIds=n._order.filter((p=>!n._layers[p].isHidden(d))),this._coordsDescendingInv={};for(const p in n.sourceCaches){this._coordsDescendingInv[p]={};const m=n.sourceCaches[p].getVisibleCoordinates();for(const y of m){const E=this.terrain.sourceCache.getTerrainCoords(y);for(const C in E)this._coordsDescendingInv[p][C]||(this._coordsDescendingInv[p][C]=[]),this._coordsDescendingInv[p][C].push(E[C])}}this._coordsDescendingInvStr={};for(const p of n._order){const m=n._layers[p],y=m.source;if(Ao[m.type]&&!this._coordsDescendingInvStr[y]){this._coordsDescendingInvStr[y]={};for(const E in this._coordsDescendingInv[y])this._coordsDescendingInvStr[y][E]=this._coordsDescendingInv[y][E].map((C=>C.key)).sort().join()}}for(const p of this._renderableTiles)for(const m in this._coordsDescendingInvStr){const y=this._coordsDescendingInvStr[m][p.tileID.key];y&&y!==p.rttCoords[m]&&(p.rtt=[])}}renderLayer(n){if(n.isHidden(this.painter.transform.zoom))return!1;const d=n.type,p=this.painter,m=this._renderableLayerIds[this._renderableLayerIds.length-1]===n.id;if(Ao[d]&&(this._prevType&&Ao[this._prevType]||this._stacks.push([]),this._prevType=d,this._stacks[this._stacks.length-1].push(n.id),!m))return!0;if(Ao[this._prevType]||Ao[d]&&m){this._prevType=d;const y=this._stacks.length-1,E=this._stacks[y]||[];for(const C of this._renderableTiles){if(this.pool.isFull()&&(fd(this.painter,this.terrain,this._rttTiles),this._rttTiles=[],this.pool.freeAllObjects()),this._rttTiles.push(C),C.rtt[y]){const D=this.pool.getObjectForId(C.rtt[y].id);if(D.stamp===C.rtt[y].stamp){this.pool.useObject(D);continue}}const M=this.pool.getOrCreateFreeObject();this.pool.useObject(M),this.pool.stampObject(M),C.rtt[y]={id:M.id,stamp:M.stamp},p.context.bindFramebuffer.set(M.fbo.framebuffer),p.context.clear({color:l.aM.transparent,stencil:0}),p.currentStencilSource=void 0;for(let D=0;D<E.length;D++){const N=p.style._layers[E[D]],z=N.source?this._coordsDescendingInv[N.source][C.tileID.key]:[C.tileID];p.context.viewport.set([0,0,M.fbo.width,M.fbo.height]),p._renderTileClippingMasks(N,z),p.renderLayer(p,p.style.sourceCaches[N.source],N,z),N.source&&(C.rttCoords[N.source]=this._coordsDescendingInvStr[N.source][C.tileID.key])}}return fd(this.painter,this.terrain,this._rttTiles),this._rttTiles=[],this.pool.freeAllObjects(),Ao[d]}return!1}}const vu={"AttributionControl.ToggleAttribution":"Toggle attribution","AttributionControl.MapFeedback":"Map feedback","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"MapLibre logo","Map.Title":"Map","Marker.Title":"Map marker","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","Popup.Close":"Close popup","ScaleControl.Feet":"ft","ScaleControl.Meters":"m","ScaleControl.Kilometers":"km","ScaleControl.Miles":"mi","ScaleControl.NauticalMiles":"nm","TerrainControl.Enable":"Enable terrain","TerrainControl.Disable":"Disable terrain","CooperativeGesturesHandler.WindowsHelpText":"Use Ctrl + scroll to zoom the map","CooperativeGesturesHandler.MacHelpText":"Use  + scroll to zoom the map","CooperativeGesturesHandler.MobileHelpText":"Use two fingers to move the map"},wd=g,Jp={hash:!1,interactive:!0,bearingSnap:7,attributionControl:To,maplibreLogo:!1,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,refreshExpiredTiles:!0,scrollZoom:!0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:60,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,trackResize:!0,center:[0,0],zoom:0,bearing:0,pitch:0,renderWorldCopies:!0,maxTileCacheSize:null,maxTileCacheZoomLevels:l.a.MAX_TILE_CACHE_ZOOM_LEVELS,transformRequest:null,transformCameraUpdate:null,fadeDuration:300,crossSourceCollisions:!0,clickTolerance:3,localIdeographFontFamily:"sans-serif",pitchWithRotate:!0,validateStyle:!0,maxCanvasSize:[4096,4096],cancelPendingTileRequestsWhileZooming:!0},bu=x=>{x.touchstart=x.dragStart,x.touchmoveWindow=x.dragMove,x.touchend=x.dragEnd},Qp={showCompass:!0,showZoom:!0,visualizePitch:!1};class eg{constructor(n,d,p=!1){this.mousedown=E=>{this.startMouse(l.e({},E,{ctrlKey:!0,preventDefault:()=>E.preventDefault()}),P.mousePos(this.element,E)),P.addEventListener(window,"mousemove",this.mousemove),P.addEventListener(window,"mouseup",this.mouseup)},this.mousemove=E=>{this.moveMouse(E,P.mousePos(this.element,E))},this.mouseup=E=>{this.mouseRotate.dragEnd(E),this.mousePitch&&this.mousePitch.dragEnd(E),this.offTemp()},this.touchstart=E=>{E.targetTouches.length!==1?this.reset():(this._startPos=this._lastPos=P.touchPos(this.element,E.targetTouches)[0],this.startTouch(E,this._startPos),P.addEventListener(window,"touchmove",this.touchmove,{passive:!1}),P.addEventListener(window,"touchend",this.touchend))},this.touchmove=E=>{E.targetTouches.length!==1?this.reset():(this._lastPos=P.touchPos(this.element,E.targetTouches)[0],this.moveTouch(E,this._lastPos))},this.touchend=E=>{E.targetTouches.length===0&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),delete this._startPos,delete this._lastPos,this.offTemp()},this.reset=()=>{this.mouseRotate.reset(),this.mousePitch&&this.mousePitch.reset(),this.touchRotate.reset(),this.touchPitch&&this.touchPitch.reset(),delete this._startPos,delete this._lastPos,this.offTemp()},this._clickTolerance=10;const m=n.dragRotate._mouseRotate.getClickTolerance(),y=n.dragRotate._mousePitch.getClickTolerance();this.element=d,this.mouseRotate=lu({clickTolerance:m,enable:!0}),this.touchRotate=(({enable:E,clickTolerance:C,bearingDegreesPerPixelMoved:M=.8})=>{const D=new au;return new en({clickTolerance:C,move:(N,z)=>({bearingDelta:(z.x-N.x)*M}),moveStateManager:D,enable:E,assignEvents:bu})})({clickTolerance:m,enable:!0}),this.map=n,p&&(this.mousePitch=cu({clickTolerance:y,enable:!0}),this.touchPitch=(({enable:E,clickTolerance:C,pitchDegreesPerPixelMoved:M=-.5})=>{const D=new au;return new en({clickTolerance:C,move:(N,z)=>({pitchDelta:(z.y-N.y)*M}),moveStateManager:D,enable:E,assignEvents:bu})})({clickTolerance:y,enable:!0})),P.addEventListener(d,"mousedown",this.mousedown),P.addEventListener(d,"touchstart",this.touchstart,{passive:!1}),P.addEventListener(d,"touchcancel",this.reset)}startMouse(n,d){this.mouseRotate.dragStart(n,d),this.mousePitch&&this.mousePitch.dragStart(n,d),P.disableDrag()}startTouch(n,d){this.touchRotate.dragStart(n,d),this.touchPitch&&this.touchPitch.dragStart(n,d),P.disableDrag()}moveMouse(n,d){const p=this.map,{bearingDelta:m}=this.mouseRotate.dragMove(n,d)||{};if(m&&p.setBearing(p.getBearing()+m),this.mousePitch){const{pitchDelta:y}=this.mousePitch.dragMove(n,d)||{};y&&p.setPitch(p.getPitch()+y)}}moveTouch(n,d){const p=this.map,{bearingDelta:m}=this.touchRotate.dragMove(n,d)||{};if(m&&p.setBearing(p.getBearing()+m),this.touchPitch){const{pitchDelta:y}=this.touchPitch.dragMove(n,d)||{};y&&p.setPitch(p.getPitch()+y)}}off(){const n=this.element;P.removeEventListener(n,"mousedown",this.mousedown),P.removeEventListener(n,"touchstart",this.touchstart,{passive:!1}),P.removeEventListener(window,"touchmove",this.touchmove,{passive:!1}),P.removeEventListener(window,"touchend",this.touchend),P.removeEventListener(n,"touchcancel",this.reset),this.offTemp()}offTemp(){P.enableDrag(),P.removeEventListener(window,"mousemove",this.mousemove),P.removeEventListener(window,"mouseup",this.mouseup),P.removeEventListener(window,"touchmove",this.touchmove,{passive:!1}),P.removeEventListener(window,"touchend",this.touchend)}}let es;function Ti(x,n,d){const p=new l.N(x.lng,x.lat);if(x=new l.N(x.lng,x.lat),n){const m=new l.N(x.lng-360,x.lat),y=new l.N(x.lng+360,x.lat),E=d.locationPoint(x).distSqr(n);d.locationPoint(m).distSqr(n)<E?x=m:d.locationPoint(y).distSqr(n)<E&&(x=y)}for(;Math.abs(x.lng-d.center.lng)>180;){const m=d.locationPoint(x);if(m.x>=0&&m.y>=0&&m.x<=d.width&&m.y<=d.height)break;x.lng>d.center.lng?x.lng-=360:x.lng+=360}return x.lng!==p.lng&&d.locationPoint(x).y>d.height/2-d.getHorizon()?x:p}const Eo={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"};function Pl(x,n,d){const p=x.classList;for(const m in Eo)p.remove(`maplibregl-${d}-anchor-${m}`);p.add(`maplibregl-${d}-anchor-${n}`)}class Ml extends l.E{constructor(n){if(super(),this._onKeyPress=d=>{const p=d.code,m=d.charCode||d.keyCode;p!=="Space"&&p!=="Enter"&&m!==32&&m!==13||this.togglePopup()},this._onMapClick=d=>{const p=d.originalEvent.target,m=this._element;this._popup&&(p===m||m.contains(p))&&this.togglePopup()},this._update=d=>{var p;if(!this._map)return;const m=this._map.loaded()&&!this._map.isMoving();(d?.type==="terrain"||d?.type==="render"&&!m)&&this._map.once("render",this._update),this._lngLat=this._map.transform.renderWorldCopies?Ti(this._lngLat,this._flatPos,this._map.transform):(p=this._lngLat)===null||p===void 0?void 0:p.wrap(),this._flatPos=this._pos=this._map.project(this._lngLat)._add(this._offset),this._map.terrain&&(this._flatPos=this._map.transform.locationPoint(this._lngLat)._add(this._offset));let y="";this._rotationAlignment==="viewport"||this._rotationAlignment==="auto"?y=`rotateZ(${this._rotation}deg)`:this._rotationAlignment==="map"&&(y=`rotateZ(${this._rotation-this._map.getBearing()}deg)`);let E="";this._pitchAlignment==="viewport"||this._pitchAlignment==="auto"?E="rotateX(0deg)":this._pitchAlignment==="map"&&(E=`rotateX(${this._map.getPitch()}deg)`),this._subpixelPositioning||d&&d.type!=="moveend"||(this._pos=this._pos.round()),P.setTransform(this._element,`${Eo[this._anchor]} translate(${this._pos.x}px, ${this._pos.y}px) ${E} ${y}`),S.frameAsync(new AbortController).then((()=>{this._updateOpacity(d&&d.type==="moveend")})).catch((()=>{}))},this._onMove=d=>{if(!this._isDragging){const p=this._clickTolerance||this._map._clickTolerance;this._isDragging=d.point.dist(this._pointerdownPos)>=p}this._isDragging&&(this._pos=d.point.sub(this._positionDelta),this._lngLat=this._map.unproject(this._pos),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none",this._state==="pending"&&(this._state="active",this.fire(new l.k("dragstart"))),this.fire(new l.k("drag")))},this._onUp=()=>{this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1,this._map.off("mousemove",this._onMove),this._map.off("touchmove",this._onMove),this._state==="active"&&this.fire(new l.k("dragend")),this._state="inactive"},this._addDragHandler=d=>{this._element.contains(d.originalEvent.target)&&(d.preventDefault(),this._positionDelta=d.point.sub(this._pos).add(this._offset),this._pointerdownPos=d.point,this._state="pending",this._map.on("mousemove",this._onMove),this._map.on("touchmove",this._onMove),this._map.once("mouseup",this._onUp),this._map.once("touchend",this._onUp))},this._anchor=n&&n.anchor||"center",this._color=n&&n.color||"#3FB1CE",this._scale=n&&n.scale||1,this._draggable=n&&n.draggable||!1,this._clickTolerance=n&&n.clickTolerance||0,this._subpixelPositioning=n&&n.subpixelPositioning||!1,this._isDragging=!1,this._state="inactive",this._rotation=n&&n.rotation||0,this._rotationAlignment=n&&n.rotationAlignment||"auto",this._pitchAlignment=n&&n.pitchAlignment&&n.pitchAlignment!=="auto"?n.pitchAlignment:this._rotationAlignment,this.setOpacity(),this.setOpacity(n?.opacity,n?.opacityWhenCovered),n&&n.element)this._element=n.element,this._offset=l.P.convert(n&&n.offset||[0,0]);else{this._defaultMarker=!0,this._element=P.create("div");const d=P.createNS("http://www.w3.org/2000/svg","svg"),p=41,m=27;d.setAttributeNS(null,"display","block"),d.setAttributeNS(null,"height",`${p}px`),d.setAttributeNS(null,"width",`${m}px`),d.setAttributeNS(null,"viewBox",`0 0 ${m} ${p}`);const y=P.createNS("http://www.w3.org/2000/svg","g");y.setAttributeNS(null,"stroke","none"),y.setAttributeNS(null,"stroke-width","1"),y.setAttributeNS(null,"fill","none"),y.setAttributeNS(null,"fill-rule","evenodd");const E=P.createNS("http://www.w3.org/2000/svg","g");E.setAttributeNS(null,"fill-rule","nonzero");const C=P.createNS("http://www.w3.org/2000/svg","g");C.setAttributeNS(null,"transform","translate(3.0, 29.0)"),C.setAttributeNS(null,"fill","#000000");const M=[{rx:"10.5",ry:"5.25002273"},{rx:"10.5",ry:"5.25002273"},{rx:"9.5",ry:"4.77275007"},{rx:"8.5",ry:"4.29549936"},{rx:"7.5",ry:"3.81822308"},{rx:"6.5",ry:"3.34094679"},{rx:"5.5",ry:"2.86367051"},{rx:"4.5",ry:"2.38636864"}];for(const fe of M){const _e=P.createNS("http://www.w3.org/2000/svg","ellipse");_e.setAttributeNS(null,"opacity","0.04"),_e.setAttributeNS(null,"cx","10.5"),_e.setAttributeNS(null,"cy","5.80029008"),_e.setAttributeNS(null,"rx",fe.rx),_e.setAttributeNS(null,"ry",fe.ry),C.appendChild(_e)}const D=P.createNS("http://www.w3.org/2000/svg","g");D.setAttributeNS(null,"fill",this._color);const N=P.createNS("http://www.w3.org/2000/svg","path");N.setAttributeNS(null,"d","M27,13.5 C27,19.074644 20.250001,27.000002 14.75,34.500002 C14.016665,35.500004 12.983335,35.500004 12.25,34.500002 C6.7499993,27.000002 0,19.222562 0,13.5 C0,6.0441559 6.0441559,0 13.5,0 C20.955844,0 27,6.0441559 27,13.5 Z"),D.appendChild(N);const z=P.createNS("http://www.w3.org/2000/svg","g");z.setAttributeNS(null,"opacity","0.25"),z.setAttributeNS(null,"fill","#000000");const H=P.createNS("http://www.w3.org/2000/svg","path");H.setAttributeNS(null,"d","M13.5,0 C6.0441559,0 0,6.0441559 0,13.5 C0,19.222562 6.7499993,27 12.25,34.5 C13,35.522727 14.016664,35.500004 14.75,34.5 C20.250001,27 27,19.074644 27,13.5 C27,6.0441559 20.955844,0 13.5,0 Z M13.5,1 C20.415404,1 26,6.584596 26,13.5 C26,15.898657 24.495584,19.181431 22.220703,22.738281 C19.945823,26.295132 16.705119,30.142167 13.943359,33.908203 C13.743445,34.180814 13.612715,34.322738 13.5,34.441406 C13.387285,34.322738 13.256555,34.180814 13.056641,33.908203 C10.284481,30.127985 7.4148684,26.314159 5.015625,22.773438 C2.6163816,19.232715 1,15.953538 1,13.5 C1,6.584596 6.584596,1 13.5,1 Z"),z.appendChild(H);const Y=P.createNS("http://www.w3.org/2000/svg","g");Y.setAttributeNS(null,"transform","translate(6.0, 7.0)"),Y.setAttributeNS(null,"fill","#FFFFFF");const K=P.createNS("http://www.w3.org/2000/svg","g");K.setAttributeNS(null,"transform","translate(8.0, 8.0)");const oe=P.createNS("http://www.w3.org/2000/svg","circle");oe.setAttributeNS(null,"fill","#000000"),oe.setAttributeNS(null,"opacity","0.25"),oe.setAttributeNS(null,"cx","5.5"),oe.setAttributeNS(null,"cy","5.5"),oe.setAttributeNS(null,"r","5.4999962");const he=P.createNS("http://www.w3.org/2000/svg","circle");he.setAttributeNS(null,"fill","#FFFFFF"),he.setAttributeNS(null,"cx","5.5"),he.setAttributeNS(null,"cy","5.5"),he.setAttributeNS(null,"r","5.4999962"),K.appendChild(oe),K.appendChild(he),E.appendChild(C),E.appendChild(D),E.appendChild(z),E.appendChild(Y),E.appendChild(K),d.appendChild(E),d.setAttributeNS(null,"height",p*this._scale+"px"),d.setAttributeNS(null,"width",m*this._scale+"px"),this._element.appendChild(d),this._offset=l.P.convert(n&&n.offset||[0,-14])}if(this._element.classList.add("maplibregl-marker"),this._element.addEventListener("dragstart",(d=>{d.preventDefault()})),this._element.addEventListener("mousedown",(d=>{d.preventDefault()})),Pl(this._element,this._anchor,"marker"),n&&n.className)for(const d of n.className.split(" "))this._element.classList.add(d);this._popup=null}addTo(n){return this.remove(),this._map=n,this._element.setAttribute("aria-label",n._getUIString("Marker.Title")),n.getCanvasContainer().appendChild(this._element),n.on("move",this._update),n.on("moveend",this._update),n.on("terrain",this._update),this.setDraggable(this._draggable),this._update(),this._map.on("click",this._onMapClick),this}remove(){return this._opacityTimeout&&(clearTimeout(this._opacityTimeout),delete this._opacityTimeout),this._map&&(this._map.off("click",this._onMapClick),this._map.off("move",this._update),this._map.off("moveend",this._update),this._map.off("terrain",this._update),this._map.off("mousedown",this._addDragHandler),this._map.off("touchstart",this._addDragHandler),this._map.off("mouseup",this._onUp),this._map.off("touchend",this._onUp),this._map.off("mousemove",this._onMove),this._map.off("touchmove",this._onMove),delete this._map),P.remove(this._element),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(n){return this._lngLat=l.N.convert(n),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(),this}getElement(){return this._element}setPopup(n){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),n){if(!("offset"in n.options)){const m=Math.abs(13.5)/Math.SQRT2;n.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-38.1],"bottom-left":[m,-1*(38.1-13.5+m)],"bottom-right":[-m,-1*(38.1-13.5+m)],left:[13.5,-1*(38.1-13.5)],right:[-13.5,-1*(38.1-13.5)]}:this._offset}this._popup=n,this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress)}return this}setSubpixelPositioning(n){return this._subpixelPositioning=n,this}getPopup(){return this._popup}togglePopup(){const n=this._popup;return this._element.style.opacity===this._opacityWhenCovered?this:n?(n.isOpen()?n.remove():(n.setLngLat(this._lngLat),n.addTo(this._map)),this):this}_updateOpacity(n=!1){var d,p;if(!(!((d=this._map)===null||d===void 0)&&d.terrain))return void(this._element.style.opacity!==this._opacity&&(this._element.style.opacity=this._opacity));if(n)this._opacityTimeout=null;else{if(this._opacityTimeout)return;this._opacityTimeout=setTimeout((()=>{this._opacityTimeout=null}),100)}const m=this._map,y=m.terrain.depthAtPoint(this._pos),E=m.terrain.getElevationForLngLatZoom(this._lngLat,m.transform.tileZoom);if(m.transform.lngLatToCameraDepth(this._lngLat,E)-y<.006)return void(this._element.style.opacity=this._opacity);const C=-this._offset.y/m.transform._pixelPerMeter,M=Math.sin(m.getPitch()*Math.PI/180)*C,D=m.terrain.depthAtPoint(new l.P(this._pos.x,this._pos.y-this._offset.y)),N=m.transform.lngLatToCameraDepth(this._lngLat,E+M)-D>.006;!((p=this._popup)===null||p===void 0)&&p.isOpen()&&N&&this._popup.remove(),this._element.style.opacity=N?this._opacityWhenCovered:this._opacity}getOffset(){return this._offset}setOffset(n){return this._offset=l.P.convert(n),this._update(),this}addClassName(n){this._element.classList.add(n)}removeClassName(n){this._element.classList.remove(n)}toggleClassName(n){return this._element.classList.toggle(n)}setDraggable(n){return this._draggable=!!n,this._map&&(n?(this._map.on("mousedown",this._addDragHandler),this._map.on("touchstart",this._addDragHandler)):(this._map.off("mousedown",this._addDragHandler),this._map.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(n){return this._rotation=n||0,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(n){return this._rotationAlignment=n||"auto",this._update(),this}getRotationAlignment(){return this._rotationAlignment}setPitchAlignment(n){return this._pitchAlignment=n&&n!=="auto"?n:this._rotationAlignment,this._update(),this}getPitchAlignment(){return this._pitchAlignment}setOpacity(n,d){return n===void 0&&d===void 0&&(this._opacity="1",this._opacityWhenCovered="0.2"),n!==void 0&&(this._opacity=n),d!==void 0&&(this._opacityWhenCovered=d),this._map&&this._updateOpacity(!0),this}}const Td={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0};let va=0,ba=!1;const $s={maxWidth:100,unit:"metric"};function wa(x,n,d){const p=d&&d.maxWidth||100,m=x._container.clientHeight/2,y=x.unproject([0,m]),E=x.unproject([p,m]),C=y.distanceTo(E);if(d&&d.unit==="imperial"){const M=3.2808*C;M>5280?St(n,p,M/5280,x._getUIString("ScaleControl.Miles")):St(n,p,M,x._getUIString("ScaleControl.Feet"))}else d&&d.unit==="nautical"?St(n,p,C/1852,x._getUIString("ScaleControl.NauticalMiles")):C>=1e3?St(n,p,C/1e3,x._getUIString("ScaleControl.Kilometers")):St(n,p,C,x._getUIString("ScaleControl.Meters"))}function St(x,n,d,p){const m=(function(y){const E=Math.pow(10,`${Math.floor(y)}`.length-1);let C=y/E;return C=C>=10?10:C>=5?5:C>=3?3:C>=2?2:C>=1?1:(function(M){const D=Math.pow(10,Math.ceil(-Math.log(M)/Math.LN10));return Math.round(M*D)/D})(C),E*C})(d);x.style.width=n*(m/d)+"px",x.innerHTML=`${m}&nbsp;${p}`}const Ft={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px",subpixelPositioning:!1},Rl=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function kl(x){if(x){if(typeof x=="number"){const n=Math.round(Math.abs(x)/Math.SQRT2);return{center:new l.P(0,0),top:new l.P(0,x),"top-left":new l.P(n,n),"top-right":new l.P(-n,n),bottom:new l.P(0,-x),"bottom-left":new l.P(n,-n),"bottom-right":new l.P(-n,-n),left:new l.P(x,0),right:new l.P(-x,0)}}if(x instanceof l.P||Array.isArray(x)){const n=l.P.convert(x);return{center:n,top:n,"top-left":n,"top-right":n,bottom:n,"bottom-left":n,"bottom-right":n,left:n,right:n}}return{center:l.P.convert(x.center||[0,0]),top:l.P.convert(x.top||[0,0]),"top-left":l.P.convert(x["top-left"]||[0,0]),"top-right":l.P.convert(x["top-right"]||[0,0]),bottom:l.P.convert(x.bottom||[0,0]),"bottom-left":l.P.convert(x["bottom-left"]||[0,0]),"bottom-right":l.P.convert(x["bottom-right"]||[0,0]),left:l.P.convert(x.left||[0,0]),right:l.P.convert(x.right||[0,0])}}return kl(new l.P(0,0))}const wu=g;u.AJAXError=l.bh,u.Evented=l.E,u.LngLat=l.N,u.MercatorCoordinate=l.Z,u.Point=l.P,u.addProtocol=l.bi,u.config=l.a,u.removeProtocol=l.bj,u.AttributionControl=So,u.BoxZoomHandler=Qr,u.CanvasSource=kr,u.CooperativeGesturesHandler=wo,u.DoubleClickZoomHandler=jn,u.DragPanHandler=yd,u.DragRotateHandler=xd,u.EdgeInsets=xo,u.FullscreenControl=class extends l.E{constructor(x={}){super(),this._onFullscreenChange=()=>{var n;let d=window.document.fullscreenElement||window.document.mozFullScreenElement||window.document.webkitFullscreenElement||window.document.msFullscreenElement;for(;!((n=d?.shadowRoot)===null||n===void 0)&&n.fullscreenElement;)d=d.shadowRoot.fullscreenElement;d===this._container!==this._fullscreen&&this._handleFullscreenChange()},this._onClickFullscreen=()=>{this._isFullscreen()?this._exitFullscreen():this._requestFullscreen()},this._fullscreen=!1,x&&x.container&&(x.container instanceof HTMLElement?this._container=x.container:l.w("Full screen control 'container' must be a DOM element.")),"onfullscreenchange"in document?this._fullscreenchange="fullscreenchange":"onmozfullscreenchange"in document?this._fullscreenchange="mozfullscreenchange":"onwebkitfullscreenchange"in document?this._fullscreenchange="webkitfullscreenchange":"onmsfullscreenchange"in document&&(this._fullscreenchange="MSFullscreenChange")}onAdd(x){return this._map=x,this._container||(this._container=this._map.getContainer()),this._controlContainer=P.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._setupUI(),this._controlContainer}onRemove(){P.remove(this._controlContainer),this._map=null,window.document.removeEventListener(this._fullscreenchange,this._onFullscreenChange)}_setupUI(){const x=this._fullscreenButton=P.create("button","maplibregl-ctrl-fullscreen",this._controlContainer);P.create("span","maplibregl-ctrl-icon",x).setAttribute("aria-hidden","true"),x.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),window.document.addEventListener(this._fullscreenchange,this._onFullscreenChange)}_updateTitle(){const x=this._getTitle();this._fullscreenButton.setAttribute("aria-label",x),this._fullscreenButton.title=x}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_handleFullscreenChange(){this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("maplibregl-ctrl-shrink"),this._fullscreenButton.classList.toggle("maplibregl-ctrl-fullscreen"),this._updateTitle(),this._fullscreen?(this.fire(new l.k("fullscreenstart")),this._prevCooperativeGesturesEnabled=this._map.cooperativeGestures.isEnabled(),this._map.cooperativeGestures.disable()):(this.fire(new l.k("fullscreenend")),this._prevCooperativeGesturesEnabled&&this._map.cooperativeGestures.enable())}_exitFullscreen(){window.document.exitFullscreen?window.document.exitFullscreen():window.document.mozCancelFullScreen?window.document.mozCancelFullScreen():window.document.msExitFullscreen?window.document.msExitFullscreen():window.document.webkitCancelFullScreen?window.document.webkitCancelFullScreen():this._togglePseudoFullScreen()}_requestFullscreen(){this._container.requestFullscreen?this._container.requestFullscreen():this._container.mozRequestFullScreen?this._container.mozRequestFullScreen():this._container.msRequestFullscreen?this._container.msRequestFullscreen():this._container.webkitRequestFullscreen?this._container.webkitRequestFullscreen():this._togglePseudoFullScreen()}_togglePseudoFullScreen(){this._container.classList.toggle("maplibregl-pseudo-fullscreen"),this._handleFullscreenChange(),this._map.resize()}},u.GeoJSONSource=qi,u.GeolocateControl=class extends l.E{constructor(x){super(),this._onSuccess=n=>{if(this._map){if(this._isOutOfMapMaxBounds(n))return this._setErrorState(),this.fire(new l.k("outofmaxbounds",n)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=n,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-background");break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}this.options.showUserLocation&&this._watchState!=="OFF"&&this._updateMarker(n),this.options.trackUserLocation&&this._watchState!=="ACTIVE_LOCK"||this._updateCamera(n),this.options.showUserLocation&&this._dotElement.classList.remove("maplibregl-user-location-dot-stale"),this.fire(new l.k("geolocate",n)),this._finish()}},this._updateCamera=n=>{const d=new l.N(n.coords.longitude,n.coords.latitude),p=n.coords.accuracy,m=this._map.getBearing(),y=l.e({bearing:m},this.options.fitBoundsOptions),E=Ce.fromLngLat(d,p);this._map.fitBounds(E,y,{geolocateSource:!0})},this._updateMarker=n=>{if(n){const d=new l.N(n.coords.longitude,n.coords.latitude);this._accuracyCircleMarker.setLngLat(d).addTo(this._map),this._userLocationDotMarker.setLngLat(d).addTo(this._map),this._accuracy=n.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()},this._onZoom=()=>{this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()},this._onError=n=>{if(this._map){if(this.options.trackUserLocation)if(n.code===1){this._watchState="OFF",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;const d=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.title=d,this._geolocateButton.setAttribute("aria-label",d),this._geolocationWatchID!==void 0&&this._clearWatch()}else{if(n.code===3&&ba)return;this._setErrorState()}this._watchState!=="OFF"&&this.options.showUserLocation&&this._dotElement.classList.add("maplibregl-user-location-dot-stale"),this.fire(new l.k("error",n)),this._finish()}},this._finish=()=>{this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0},this._setupUI=()=>{this._map&&(this._container.addEventListener("contextmenu",(n=>n.preventDefault())),this._geolocateButton=P.create("button","maplibregl-ctrl-geolocate",this._container),P.create("span","maplibregl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",this._geolocateButton.disabled=!0)},this._finishSetupUI=n=>{if(this._map){if(n===!1){l.w("Geolocation support is not available so the GeolocateControl will be disabled.");const d=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.title=d,this._geolocateButton.setAttribute("aria-label",d)}else{const d=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.disabled=!1,this._geolocateButton.title=d,this._geolocateButton.setAttribute("aria-label",d)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=P.create("div","maplibregl-user-location-dot"),this._userLocationDotMarker=new Ml({element:this._dotElement}),this._circleElement=P.create("div","maplibregl-user-location-accuracy-circle"),this._accuracyCircleMarker=new Ml({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",(()=>this.trigger())),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",(d=>{d.geolocateSource||this._watchState!=="ACTIVE_LOCK"||d.originalEvent&&d.originalEvent.type==="resize"||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this.fire(new l.k("trackuserlocationend")),this.fire(new l.k("userlocationlostfocus")))}))}},this.options=l.e({},Td,x)}onAdd(x){return this._map=x,this._container=P.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._setupUI(),(function(){return l._(this,arguments,void 0,(function*(n=!1){if(es!==void 0&&!n)return es;if(window.navigator.permissions===void 0)return es=!!window.navigator.geolocation,es;try{es=(yield window.navigator.permissions.query({name:"geolocation"})).state!=="denied"}catch{es=!!window.navigator.geolocation}return es}))})().then((n=>this._finishSetupUI(n))),this._container}onRemove(){this._geolocationWatchID!==void 0&&(window.navigator.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),P.remove(this._container),this._map.off("zoom",this._onZoom),this._map=void 0,va=0,ba=!1}_isOutOfMapMaxBounds(x){const n=this._map.getMaxBounds(),d=x.coords;return n&&(d.longitude<n.getWest()||d.longitude>n.getEast()||d.latitude<n.getSouth()||d.latitude>n.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting");break;case"ACTIVE_ERROR":break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}}_updateCircleRadius(){const x=this._map.getBounds(),n=x.getSouthEast(),d=x.getNorthEast(),p=n.distanceTo(d),m=Math.ceil(this._accuracy/(p/this._map._container.clientHeight)*2);this._circleElement.style.width=`${m}px`,this._circleElement.style.height=`${m}px`}trigger(){if(!this._setup)return l.w("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new l.k("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":va--,ba=!1,this._watchState="OFF",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background-error"),this.fire(new l.k("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new l.k("trackuserlocationstart")),this.fire(new l.k("userlocationfocus"));break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active");break;case"OFF":break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}if(this._watchState==="OFF"&&this._geolocationWatchID!==void 0)this._clearWatch();else if(this._geolocationWatchID===void 0){let x;this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),va++,va>1?(x={maximumAge:6e5,timeout:0},ba=!0):(x=this.options.positionOptions,ba=!1),this._geolocationWatchID=window.navigator.geolocation.watchPosition(this._onSuccess,this._onError,x)}}else window.navigator.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=setTimeout(this._finish,1e4);return!0}_clearWatch(){window.navigator.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},u.Hash=vl,u.ImageSource=_s,u.KeyboardHandler=us,u.LngLatBounds=Ce,u.LogoControl=_u,u.Map=class extends vd{constructor(x){l.bf.mark(l.bg.create);const n=Object.assign(Object.assign({},Jp),x);if(n.minZoom!=null&&n.maxZoom!=null&&n.minZoom>n.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(n.minPitch!=null&&n.maxPitch!=null&&n.minPitch>n.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(n.minPitch!=null&&n.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(n.maxPitch!=null&&n.maxPitch>85)throw new Error("maxPitch must be less than or equal to 85");if(super(new vo(n.minZoom,n.maxZoom,n.minPitch,n.maxPitch,n.renderWorldCopies),{bearingSnap:n.bearingSnap}),this._idleTriggered=!1,this._crossFadingFactor=1,this._renderTaskQueue=new ei,this._controls=[],this._mapId=l.a4(),this._contextLost=d=>{d.preventDefault(),this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this.fire(new l.k("webglcontextlost",{originalEvent:d}))},this._contextRestored=d=>{this._setupPainter(),this.resize(),this._update(),this.fire(new l.k("webglcontextrestored",{originalEvent:d}))},this._onMapScroll=d=>{if(d.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1},this._onWindowOnline=()=>{this._update()},this._interactive=n.interactive,this._maxTileCacheSize=n.maxTileCacheSize,this._maxTileCacheZoomLevels=n.maxTileCacheZoomLevels,this._failIfMajorPerformanceCaveat=n.failIfMajorPerformanceCaveat===!0,this._preserveDrawingBuffer=n.preserveDrawingBuffer===!0,this._antialias=n.antialias===!0,this._trackResize=n.trackResize===!0,this._bearingSnap=n.bearingSnap,this._refreshExpiredTiles=n.refreshExpiredTiles===!0,this._fadeDuration=n.fadeDuration,this._crossSourceCollisions=n.crossSourceCollisions===!0,this._collectResourceTiming=n.collectResourceTiming===!0,this._locale=Object.assign(Object.assign({},vu),n.locale),this._clickTolerance=n.clickTolerance,this._overridePixelRatio=n.pixelRatio,this._maxCanvasSize=n.maxCanvasSize,this.transformCameraUpdate=n.transformCameraUpdate,this.cancelPendingTileRequestsWhileZooming=n.cancelPendingTileRequestsWhileZooming===!0,this._imageQueueHandle=te.addThrottleControl((()=>this.isMoving())),this._requestManager=new me(n.transformRequest),typeof n.container=="string"){if(this._container=document.getElementById(n.container),!this._container)throw new Error(`Container '${n.container}' not found.`)}else{if(!(n.container instanceof HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=n.container}if(n.maxBounds&&this.setMaxBounds(n.maxBounds),this._setupContainer(),this._setupPainter(),this.on("move",(()=>this._update(!1))).on("moveend",(()=>this._update(!1))).on("zoom",(()=>this._update(!0))).on("terrain",(()=>{this.painter.terrainFacilitator.dirty=!0,this._update(!0)})).once("idle",(()=>{this._idleTriggered=!0})),typeof window<"u"){addEventListener("online",this._onWindowOnline,!1);let d=!1;const p=pa((m=>{this._trackResize&&!this._removed&&(this.resize(m),this.redraw())}),50);this._resizeObserver=new ResizeObserver((m=>{d?p(m):d=!0})),this._resizeObserver.observe(this._container)}this.handlers=new mu(this,n),this._hash=n.hash&&new vl(typeof n.hash=="string"&&n.hash||void 0).addTo(this),this._hash&&this._hash._onHashChange()||(this.jumpTo({center:n.center,zoom:n.zoom,bearing:n.bearing,pitch:n.pitch}),n.bounds&&(this.resize(),this.fitBounds(n.bounds,l.e({},n.fitBoundsOptions,{duration:0})))),this.resize(),this._localIdeographFontFamily=n.localIdeographFontFamily,this._validateStyle=n.validateStyle,n.style&&this.setStyle(n.style,{localIdeographFontFamily:n.localIdeographFontFamily}),n.attributionControl&&this.addControl(new So(typeof n.attributionControl=="boolean"?void 0:n.attributionControl)),n.maplibreLogo&&this.addControl(new _u,n.logoPosition),this.on("style.load",(()=>{this.transform.unmodified&&this.jumpTo(this.style.stylesheet)})),this.on("data",(d=>{this._update(d.dataType==="style"),this.fire(new l.k(`${d.dataType}data`,d))})),this.on("dataloading",(d=>{this.fire(new l.k(`${d.dataType}dataloading`,d))})),this.on("dataabort",(d=>{this.fire(new l.k("sourcedataabort",d))}))}_getMapId(){return this._mapId}addControl(x,n){if(n===void 0&&(n=x.getDefaultPosition?x.getDefaultPosition():"top-right"),!x||!x.onAdd)return this.fire(new l.j(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));const d=x.onAdd(this);this._controls.push(x);const p=this._controlPositions[n];return n.indexOf("bottom")!==-1?p.insertBefore(d,p.firstChild):p.appendChild(d),this}removeControl(x){if(!x||!x.onRemove)return this.fire(new l.j(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));const n=this._controls.indexOf(x);return n>-1&&this._controls.splice(n,1),x.onRemove(this),this}hasControl(x){return this._controls.indexOf(x)>-1}calculateCameraOptionsFromTo(x,n,d,p){return p==null&&this.terrain&&(p=this.terrain.getElevationForLngLatZoom(d,this.transform.tileZoom)),super.calculateCameraOptionsFromTo(x,n,d,p)}resize(x){var n;const d=this._containerDimensions(),p=d[0],m=d[1],y=this._getClampedPixelRatio(p,m);if(this._resizeCanvas(p,m,y),this.painter.resize(p,m,y),this.painter.overLimit()){const C=this.painter.context.gl;this._maxCanvasSize=[C.drawingBufferWidth,C.drawingBufferHeight];const M=this._getClampedPixelRatio(p,m);this._resizeCanvas(p,m,M),this.painter.resize(p,m,M)}this.transform.resize(p,m),(n=this._requestedCameraState)===null||n===void 0||n.resize(p,m);const E=!this._moving;return E&&(this.stop(),this.fire(new l.k("movestart",x)).fire(new l.k("move",x))),this.fire(new l.k("resize",x)),E&&this.fire(new l.k("moveend",x)),this}_getClampedPixelRatio(x,n){const{0:d,1:p}=this._maxCanvasSize,m=this.getPixelRatio(),y=x*m,E=n*m;return Math.min(y>d?d/y:1,E>p?p/E:1)*m}getPixelRatio(){var x;return(x=this._overridePixelRatio)!==null&&x!==void 0?x:devicePixelRatio}setPixelRatio(x){this._overridePixelRatio=x,this.resize()}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()}setMaxBounds(x){return this.transform.setMaxBounds(Ce.convert(x)),this._update()}setMinZoom(x){if((x=x??-2)>=-2&&x<=this.transform.maxZoom)return this.transform.minZoom=x,this._update(),this.getZoom()<x&&this.setZoom(x),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(x){if((x=x??22)>=this.transform.minZoom)return this.transform.maxZoom=x,this._update(),this.getZoom()>x&&this.setZoom(x),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(x){if((x=x??0)<0)throw new Error("minPitch must be greater than or equal to 0");if(x>=0&&x<=this.transform.maxPitch)return this.transform.minPitch=x,this._update(),this.getPitch()<x&&this.setPitch(x),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(x){if((x=x??60)>85)throw new Error("maxPitch must be less than or equal to 85");if(x>=this.transform.minPitch)return this.transform.maxPitch=x,this._update(),this.getPitch()>x&&this.setPitch(x),this;throw new Error("maxPitch must be greater than the current minPitch")}getMaxPitch(){return this.transform.maxPitch}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(x){return this.transform.renderWorldCopies=x,this._update()}project(x){return this.transform.locationPoint(l.N.convert(x),this.style&&this.terrain)}unproject(x){return this.transform.pointLocation(l.P.convert(x),this.terrain)}isMoving(){var x;return this._moving||((x=this.handlers)===null||x===void 0?void 0:x.isMoving())}isZooming(){var x;return this._zooming||((x=this.handlers)===null||x===void 0?void 0:x.isZooming())}isRotating(){var x;return this._rotating||((x=this.handlers)===null||x===void 0?void 0:x.isRotating())}_createDelegatedListener(x,n,d){if(x==="mouseenter"||x==="mouseover"){let p=!1;return{layers:n,listener:d,delegates:{mousemove:y=>{const E=n.filter((M=>this.getLayer(M))),C=E.length!==0?this.queryRenderedFeatures(y.point,{layers:E}):[];C.length?p||(p=!0,d.call(this,new pr(x,this,y.originalEvent,{features:C}))):p=!1},mouseout:()=>{p=!1}}}}if(x==="mouseleave"||x==="mouseout"){let p=!1;return{layers:n,listener:d,delegates:{mousemove:E=>{const C=n.filter((M=>this.getLayer(M)));(C.length!==0?this.queryRenderedFeatures(E.point,{layers:C}):[]).length?p=!0:p&&(p=!1,d.call(this,new pr(x,this,E.originalEvent)))},mouseout:E=>{p&&(p=!1,d.call(this,new pr(x,this,E.originalEvent)))}}}}{const p=m=>{const y=n.filter((C=>this.getLayer(C))),E=y.length!==0?this.queryRenderedFeatures(m.point,{layers:y}):[];E.length&&(m.features=E,d.call(this,m),delete m.features)};return{layers:n,listener:d,delegates:{[x]:p}}}}_saveDelegatedListener(x,n){this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[x]=this._delegatedListeners[x]||[],this._delegatedListeners[x].push(n)}_removeDelegatedListener(x,n,d){if(!this._delegatedListeners||!this._delegatedListeners[x])return;const p=this._delegatedListeners[x];for(let m=0;m<p.length;m++){const y=p[m];if(y.listener===d&&y.layers.length===n.length&&y.layers.every((E=>n.includes(E)))){for(const E in y.delegates)this.off(E,y.delegates[E]);return void p.splice(m,1)}}}on(x,n,d){if(d===void 0)return super.on(x,n);const p=this._createDelegatedListener(x,typeof n=="string"?[n]:n,d);this._saveDelegatedListener(x,p);for(const m in p.delegates)this.on(m,p.delegates[m]);return this}once(x,n,d){if(d===void 0)return super.once(x,n);const p=typeof n=="string"?[n]:n,m=this._createDelegatedListener(x,p,d);for(const y in m.delegates){const E=m.delegates[y];m.delegates[y]=(...C)=>{this._removeDelegatedListener(x,p,d),E(...C)}}this._saveDelegatedListener(x,m);for(const y in m.delegates)this.once(y,m.delegates[y]);return this}off(x,n,d){return d===void 0?super.off(x,n):(this._removeDelegatedListener(x,typeof n=="string"?[n]:n,d),this)}queryRenderedFeatures(x,n){if(!this.style)return[];let d;const p=x instanceof l.P||Array.isArray(x),m=p?x:[[0,0],[this.transform.width,this.transform.height]];if(n=n||(p?{}:x)||{},m instanceof l.P||typeof m[0]=="number")d=[l.P.convert(m)];else{const y=l.P.convert(m[0]),E=l.P.convert(m[1]);d=[y,new l.P(E.x,y.y),E,new l.P(y.x,E.y),y]}return this.style.queryRenderedFeatures(d,n,this.transform)}querySourceFeatures(x,n){return this.style.querySourceFeatures(x,n)}setStyle(x,n){return(n=l.e({},{localIdeographFontFamily:this._localIdeographFontFamily,validate:this._validateStyle},n)).diff!==!1&&n.localIdeographFontFamily===this._localIdeographFontFamily&&this.style&&x?(this._diffStyle(x,n),this):(this._localIdeographFontFamily=n.localIdeographFontFamily,this._updateStyle(x,n))}setTransformRequest(x){return this._requestManager.setTransformRequest(x),this}_getUIString(x){const n=this._locale[x];if(n==null)throw new Error(`Missing UI string '${x}'`);return n}_updateStyle(x,n){if(n.transformStyle&&this.style&&!this.style._loaded)return void this.style.once("style.load",(()=>this._updateStyle(x,n)));const d=this.style&&n.transformStyle?this.style.serialize():void 0;return this.style&&(this.style.setEventedParent(null),this.style._remove(!x)),x?(this.style=new rl(this,n||{}),this.style.setEventedParent(this,{style:this.style}),typeof x=="string"?this.style.loadURL(x,n,d):this.style.loadJSON(x,n,d),this):(delete this.style,this)}_lazyInitEmptyStyle(){this.style||(this.style=new rl(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}_diffStyle(x,n){if(typeof x=="string"){const d=this._requestManager.transformRequest(x,"Style");l.h(d,new AbortController).then((p=>{this._updateDiff(p.data,n)})).catch((p=>{p&&this.fire(new l.j(p))}))}else typeof x=="object"&&this._updateDiff(x,n)}_updateDiff(x,n){try{this.style.setState(x,n)&&this._update(!0)}catch(d){l.w(`Unable to perform style diff: ${d.message||d.error||d}.  Rebuilding the style from scratch.`),this._updateStyle(x,n)}}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():l.w("There is no style added to the map.")}addSource(x,n){return this._lazyInitEmptyStyle(),this.style.addSource(x,n),this._update(!0)}isSourceLoaded(x){const n=this.style&&this.style.sourceCaches[x];if(n!==void 0)return n.loaded();this.fire(new l.j(new Error(`There is no source with ID '${x}'`)))}setTerrain(x){if(this.style._checkLoaded(),this._terrainDataCallback&&this.style.off("data",this._terrainDataCallback),x){const n=this.style.sourceCaches[x.source];if(!n)throw new Error(`cannot load terrain, because there exists no source with ID: ${x.source}`);this.terrain===null&&n.reload();for(const d in this.style._layers){const p=this.style._layers[d];p.type==="hillshade"&&p.source===x.source&&l.w("You are using the same source for a hillshade layer and for 3D terrain. Please consider using two separate sources to improve rendering quality.")}this.terrain=new xu(this.painter,n,x),this.painter.renderToTexture=new bd(this.painter,this.terrain),this.transform.minElevationForCurrentTile=this.terrain.getMinTileElevationForLngLatZoom(this.transform.center,this.transform.tileZoom),this.transform.elevation=this.terrain.getElevationForLngLatZoom(this.transform.center,this.transform.tileZoom),this._terrainDataCallback=d=>{d.dataType==="style"?this.terrain.sourceCache.freeRtt():d.dataType==="source"&&d.tile&&(d.sourceId!==x.source||this._elevationFreeze||(this.transform.minElevationForCurrentTile=this.terrain.getMinTileElevationForLngLatZoom(this.transform.center,this.transform.tileZoom),this.transform.elevation=this.terrain.getElevationForLngLatZoom(this.transform.center,this.transform.tileZoom)),this.terrain.sourceCache.freeRtt(d.tile.tileID))},this.style.on("data",this._terrainDataCallback)}else this.terrain&&this.terrain.sourceCache.destruct(),this.terrain=null,this.painter.renderToTexture&&this.painter.renderToTexture.destruct(),this.painter.renderToTexture=null,this.transform.minElevationForCurrentTile=0,this.transform.elevation=0;return this.fire(new l.k("terrain",{terrain:x})),this}getTerrain(){var x,n;return(n=(x=this.terrain)===null||x===void 0?void 0:x.options)!==null&&n!==void 0?n:null}areTilesLoaded(){const x=this.style&&this.style.sourceCaches;for(const n in x){const d=x[n]._tiles;for(const p in d){const m=d[p];if(m.state!=="loaded"&&m.state!=="errored")return!1}}return!0}removeSource(x){return this.style.removeSource(x),this._update(!0)}getSource(x){return this.style.getSource(x)}addImage(x,n,d={}){const{pixelRatio:p=1,sdf:m=!1,stretchX:y,stretchY:E,content:C,textFitWidth:M,textFitHeight:D}=d;if(this._lazyInitEmptyStyle(),!(n instanceof HTMLImageElement||l.b(n))){if(n.width===void 0||n.height===void 0)return this.fire(new l.j(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));{const{width:N,height:z,data:H}=n,Y=n;return this.style.addImage(x,{data:new l.R({width:N,height:z},new Uint8Array(H)),pixelRatio:p,stretchX:y,stretchY:E,content:C,textFitWidth:M,textFitHeight:D,sdf:m,version:0,userImage:Y}),Y.onAdd&&Y.onAdd(this,x),this}}{const{width:N,height:z,data:H}=S.getImageData(n);this.style.addImage(x,{data:new l.R({width:N,height:z},H),pixelRatio:p,stretchX:y,stretchY:E,content:C,textFitWidth:M,textFitHeight:D,sdf:m,version:0})}}updateImage(x,n){const d=this.style.getImage(x);if(!d)return this.fire(new l.j(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));const p=n instanceof HTMLImageElement||l.b(n)?S.getImageData(n):n,{width:m,height:y,data:E}=p;if(m===void 0||y===void 0)return this.fire(new l.j(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));if(m!==d.data.width||y!==d.data.height)return this.fire(new l.j(new Error("The width and height of the updated image must be that same as the previous version of the image")));const C=!(n instanceof HTMLImageElement||l.b(n));return d.data.replace(E,C),this.style.updateImage(x,d),this}getImage(x){return this.style.getImage(x)}hasImage(x){return x?!!this.style.getImage(x):(this.fire(new l.j(new Error("Missing required image id"))),!1)}removeImage(x){this.style.removeImage(x)}loadImage(x){return te.getImage(this._requestManager.transformRequest(x,"Image"),new AbortController)}listImages(){return this.style.listImages()}addLayer(x,n){return this._lazyInitEmptyStyle(),this.style.addLayer(x,n),this._update(!0)}moveLayer(x,n){return this.style.moveLayer(x,n),this._update(!0)}removeLayer(x){return this.style.removeLayer(x),this._update(!0)}getLayer(x){return this.style.getLayer(x)}getLayersOrder(){return this.style.getLayersOrder()}setLayerZoomRange(x,n,d){return this.style.setLayerZoomRange(x,n,d),this._update(!0)}setFilter(x,n,d={}){return this.style.setFilter(x,n,d),this._update(!0)}getFilter(x){return this.style.getFilter(x)}setPaintProperty(x,n,d,p={}){return this.style.setPaintProperty(x,n,d,p),this._update(!0)}getPaintProperty(x,n){return this.style.getPaintProperty(x,n)}setLayoutProperty(x,n,d,p={}){return this.style.setLayoutProperty(x,n,d,p),this._update(!0)}getLayoutProperty(x,n){return this.style.getLayoutProperty(x,n)}setGlyphs(x,n={}){return this._lazyInitEmptyStyle(),this.style.setGlyphs(x,n),this._update(!0)}getGlyphs(){return this.style.getGlyphsUrl()}addSprite(x,n,d={}){return this._lazyInitEmptyStyle(),this.style.addSprite(x,n,d,(p=>{p||this._update(!0)})),this}removeSprite(x){return this._lazyInitEmptyStyle(),this.style.removeSprite(x),this._update(!0)}getSprite(){return this.style.getSprite()}setSprite(x,n={}){return this._lazyInitEmptyStyle(),this.style.setSprite(x,n,(d=>{d||this._update(!0)})),this}setLight(x,n={}){return this._lazyInitEmptyStyle(),this.style.setLight(x,n),this._update(!0)}getLight(){return this.style.getLight()}setSky(x){return this._lazyInitEmptyStyle(),this.style.setSky(x),this._update(!0)}getSky(){return this.style.getSky()}setFeatureState(x,n){return this.style.setFeatureState(x,n),this._update()}removeFeatureState(x,n){return this.style.removeFeatureState(x,n),this._update()}getFeatureState(x){return this.style.getFeatureState(x)}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}_containerDimensions(){let x=0,n=0;return this._container&&(x=this._container.clientWidth||400,n=this._container.clientHeight||300),[x,n]}_setupContainer(){const x=this._container;x.classList.add("maplibregl-map");const n=this._canvasContainer=P.create("div","maplibregl-canvas-container",x);this._interactive&&n.classList.add("maplibregl-interactive"),this._canvas=P.create("canvas","maplibregl-canvas",n),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("tabindex",this._interactive?"0":"-1"),this._canvas.setAttribute("aria-label",this._getUIString("Map.Title")),this._canvas.setAttribute("role","region");const d=this._containerDimensions(),p=this._getClampedPixelRatio(d[0],d[1]);this._resizeCanvas(d[0],d[1],p);const m=this._controlContainer=P.create("div","maplibregl-control-container",x),y=this._controlPositions={};["top-left","top-right","bottom-left","bottom-right"].forEach((E=>{y[E]=P.create("div",`maplibregl-ctrl-${E} `,m)})),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(x,n,d){this._canvas.width=Math.floor(d*x),this._canvas.height=Math.floor(d*n),this._canvas.style.width=`${x}px`,this._canvas.style.height=`${n}px`}_setupPainter(){const x={alpha:!0,stencil:!0,depth:!0,failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||!1};let n=null;this._canvas.addEventListener("webglcontextcreationerror",(p=>{n={requestedAttributes:x},p&&(n.statusMessage=p.statusMessage,n.type=p.type)}),{once:!0});const d=this._canvas.getContext("webgl2",x)||this._canvas.getContext("webgl",x);if(!d){const p="Failed to initialize WebGL";throw n?(n.message=p,new Error(JSON.stringify(n))):new Error(p)}this.painter=new xl(d,this.transform),O.testSupport(d)}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}_update(x){return this.style&&this.style._loaded?(this._styleDirty=this._styleDirty||x,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(x){return this._update(),this._renderTaskQueue.add(x)}_cancelRenderFrame(x){this._renderTaskQueue.remove(x)}_render(x){const n=this._idleTriggered?this._fadeDuration:0;if(this.painter.context.setDirty(),this.painter.setBaseState(),this._renderTaskQueue.run(x),this._removed)return;let d=!1;if(this.style&&this._styleDirty){this._styleDirty=!1;const m=this.transform.zoom,y=S.now();this.style.zoomHistory.update(m,y);const E=new l.z(m,{now:y,fadeDuration:n,zoomHistory:this.style.zoomHistory,transition:this.style.getTransition()}),C=E.crossFadingFactor();C===1&&C===this._crossFadingFactor||(d=!0,this._crossFadingFactor=C),this.style.update(E)}this.style&&this._sourcesDirty&&(this._sourcesDirty=!1,this.style._updateSources(this.transform)),this.terrain?(this.terrain.sourceCache.update(this.transform,this.terrain),this.transform.minElevationForCurrentTile=this.terrain.getMinTileElevationForLngLatZoom(this.transform.center,this.transform.tileZoom),this._elevationFreeze||(this.transform.elevation=this.terrain.getElevationForLngLatZoom(this.transform.center,this.transform.tileZoom))):(this.transform.minElevationForCurrentTile=0,this.transform.elevation=0),this._placementDirty=this.style&&this.style._updatePlacement(this.painter.transform,this.showCollisionBoxes,n,this._crossSourceCollisions),this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showOverdrawInspector:this._showOverdrawInspector,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:n,showPadding:this.showPadding}),this.fire(new l.k("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,l.bf.mark(l.bg.load),this.fire(new l.k("load"))),this.style&&(this.style.hasTransitions()||d)&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles();const p=this._sourcesDirty||this._styleDirty||this._placementDirty;return p||this._repaint?this.triggerRepaint():!this.isMoving()&&this.loaded()&&this.fire(new l.k("idle")),!this._loaded||this._fullyLoaded||p||(this._fullyLoaded=!0,l.bf.mark(l.bg.fullLoad)),this}redraw(){return this.style&&(this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this._render(0)),this}remove(){var x;this._hash&&this._hash.remove();for(const d of this._controls)d.onRemove(this);this._controls=[],this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this._renderTaskQueue.clear(),this.painter.destroy(),this.handlers.destroy(),delete this.handlers,this.setStyle(null),typeof window<"u"&&removeEventListener("online",this._onWindowOnline,!1),te.removeThrottleControl(this._imageQueueHandle),(x=this._resizeObserver)===null||x===void 0||x.disconnect();const n=this.painter.context.gl.getExtension("WEBGL_lose_context");n?.loseContext&&n.loseContext(),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),P.remove(this._canvasContainer),P.remove(this._controlContainer),this._container.classList.remove("maplibregl-map"),l.bf.clearMetrics(),this._removed=!0,this.fire(new l.k("remove"))}triggerRepaint(){this.style&&!this._frameRequest&&(this._frameRequest=new AbortController,S.frameAsync(this._frameRequest).then((x=>{l.bf.frame(x),this._frameRequest=null,this._render(x)})).catch((()=>{})))}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(x){this._showTileBoundaries!==x&&(this._showTileBoundaries=x,this._update())}get showPadding(){return!!this._showPadding}set showPadding(x){this._showPadding!==x&&(this._showPadding=x,this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(x){this._showCollisionBoxes!==x&&(this._showCollisionBoxes=x,x?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(x){this._showOverdrawInspector!==x&&(this._showOverdrawInspector=x,this._update())}get repaint(){return!!this._repaint}set repaint(x){this._repaint!==x&&(this._repaint=x,this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(x){this._vertices=x,this._update()}get version(){return wd}getCameraTargetElevation(){return this.transform.elevation}},u.MapMouseEvent=pr,u.MapTouchEvent=Un,u.MapWheelEvent=gd,u.Marker=Ml,u.NavigationControl=class{constructor(x){this._updateZoomButtons=()=>{const n=this._map.getZoom(),d=n===this._map.getMaxZoom(),p=n===this._map.getMinZoom();this._zoomInButton.disabled=d,this._zoomOutButton.disabled=p,this._zoomInButton.setAttribute("aria-disabled",d.toString()),this._zoomOutButton.setAttribute("aria-disabled",p.toString())},this._rotateCompassArrow=()=>{const n=this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(this._map.transform.pitch*(Math.PI/180)),.5)}) rotateX(${this._map.transform.pitch}deg) rotateZ(${this._map.transform.angle*(180/Math.PI)}deg)`:`rotate(${this._map.transform.angle*(180/Math.PI)}deg)`;this._compassIcon.style.transform=n},this._setButtonTitle=(n,d)=>{const p=this._map._getUIString(`NavigationControl.${d}`);n.title=p,n.setAttribute("aria-label",p)},this.options=l.e({},Qp,x),this._container=P.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._container.addEventListener("contextmenu",(n=>n.preventDefault())),this.options.showZoom&&(this._zoomInButton=this._createButton("maplibregl-ctrl-zoom-in",(n=>this._map.zoomIn({},{originalEvent:n}))),P.create("span","maplibregl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("maplibregl-ctrl-zoom-out",(n=>this._map.zoomOut({},{originalEvent:n}))),P.create("span","maplibregl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(this._compass=this._createButton("maplibregl-ctrl-compass",(n=>{this.options.visualizePitch?this._map.resetNorthPitch({},{originalEvent:n}):this._map.resetNorth({},{originalEvent:n})})),this._compassIcon=P.create("span","maplibregl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}onAdd(x){return this._map=x,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),this._map.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&this._map.on("pitch",this._rotateCompassArrow),this._map.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new eg(this._map,this._compass,this.options.visualizePitch)),this._container}onRemove(){P.remove(this._container),this.options.showZoom&&this._map.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&this._map.off("pitch",this._rotateCompassArrow),this._map.off("rotate",this._rotateCompassArrow),this._handler.off(),delete this._handler),delete this._map}_createButton(x,n){const d=P.create("button",x,this._container);return d.type="button",d.addEventListener("click",n),d}},u.Popup=class extends l.E{constructor(x){super(),this.remove=()=>(this._content&&P.remove(this._content),this._container&&(P.remove(this._container),delete this._container),this._map&&(this._map.off("move",this._update),this._map.off("move",this._onClose),this._map.off("click",this._onClose),this._map.off("remove",this.remove),this._map.off("mousemove",this._onMouseMove),this._map.off("mouseup",this._onMouseUp),this._map.off("drag",this._onDrag),this._map._canvasContainer.classList.remove("maplibregl-track-pointer"),delete this._map,this.fire(new l.k("close"))),this),this._onMouseUp=n=>{this._update(n.point)},this._onMouseMove=n=>{this._update(n.point)},this._onDrag=n=>{this._update(n.point)},this._update=n=>{var d;if(!this._map||!this._lngLat&&!this._trackPointer||!this._content)return;if(!this._container){if(this._container=P.create("div","maplibregl-popup",this._map.getContainer()),this._tip=P.create("div","maplibregl-popup-tip",this._container),this._container.appendChild(this._content),this.options.className)for(const C of this.options.className.split(" "))this._container.classList.add(C);this._closeButton&&this._closeButton.setAttribute("aria-label",this._map._getUIString("Popup.Close")),this._trackPointer&&this._container.classList.add("maplibregl-popup-track-pointer")}if(this.options.maxWidth&&this._container.style.maxWidth!==this.options.maxWidth&&(this._container.style.maxWidth=this.options.maxWidth),this._lngLat=this._map.transform.renderWorldCopies&&!this._trackPointer?Ti(this._lngLat,this._flatPos,this._map.transform):(d=this._lngLat)===null||d===void 0?void 0:d.wrap(),this._trackPointer&&!n)return;const p=this._flatPos=this._pos=this._trackPointer&&n?n:this._map.project(this._lngLat);this._map.terrain&&(this._flatPos=this._trackPointer&&n?n:this._map.transform.locationPoint(this._lngLat));let m=this.options.anchor;const y=kl(this.options.offset);if(!m){const C=this._container.offsetWidth,M=this._container.offsetHeight;let D;D=p.y+y.bottom.y<M?["top"]:p.y>this._map.transform.height-M?["bottom"]:[],p.x<C/2?D.push("left"):p.x>this._map.transform.width-C/2&&D.push("right"),m=D.length===0?"bottom":D.join("-")}let E=p.add(y[m]);this.options.subpixelPositioning||(E=E.round()),P.setTransform(this._container,`${Eo[m]} translate(${E.x}px,${E.y}px)`),Pl(this._container,m,"popup")},this._onClose=()=>{this.remove()},this.options=l.e(Object.create(Ft),x)}addTo(x){return this._map&&this.remove(),this._map=x,this.options.closeOnClick&&this._map.on("click",this._onClose),this.options.closeOnMove&&this._map.on("move",this._onClose),this._map.on("remove",this.remove),this._update(),this._focusFirstElement(),this._trackPointer?(this._map.on("mousemove",this._onMouseMove),this._map.on("mouseup",this._onMouseUp),this._container&&this._container.classList.add("maplibregl-popup-track-pointer"),this._map._canvasContainer.classList.add("maplibregl-track-pointer")):this._map.on("move",this._update),this.fire(new l.k("open")),this}isOpen(){return!!this._map}getLngLat(){return this._lngLat}setLngLat(x){return this._lngLat=l.N.convert(x),this._pos=null,this._flatPos=null,this._trackPointer=!1,this._update(),this._map&&(this._map.on("move",this._update),this._map.off("mousemove",this._onMouseMove),this._container&&this._container.classList.remove("maplibregl-popup-track-pointer"),this._map._canvasContainer.classList.remove("maplibregl-track-pointer")),this}trackPointer(){return this._trackPointer=!0,this._pos=null,this._flatPos=null,this._update(),this._map&&(this._map.off("move",this._update),this._map.on("mousemove",this._onMouseMove),this._map.on("drag",this._onDrag),this._container&&this._container.classList.add("maplibregl-popup-track-pointer"),this._map._canvasContainer.classList.add("maplibregl-track-pointer")),this}getElement(){return this._container}setText(x){return this.setDOMContent(document.createTextNode(x))}setHTML(x){const n=document.createDocumentFragment(),d=document.createElement("body");let p;for(d.innerHTML=x;p=d.firstChild,p;)n.appendChild(p);return this.setDOMContent(n)}getMaxWidth(){var x;return(x=this._container)===null||x===void 0?void 0:x.style.maxWidth}setMaxWidth(x){return this.options.maxWidth=x,this._update(),this}setDOMContent(x){if(this._content)for(;this._content.hasChildNodes();)this._content.firstChild&&this._content.removeChild(this._content.firstChild);else this._content=P.create("div","maplibregl-popup-content",this._container);return this._content.appendChild(x),this._createCloseButton(),this._update(),this._focusFirstElement(),this}addClassName(x){return this._container&&this._container.classList.add(x),this}removeClassName(x){return this._container&&this._container.classList.remove(x),this}setOffset(x){return this.options.offset=x,this._update(),this}toggleClassName(x){if(this._container)return this._container.classList.toggle(x)}setSubpixelPositioning(x){this.options.subpixelPositioning=x}_createCloseButton(){this.options.closeButton&&(this._closeButton=P.create("button","maplibregl-popup-close-button",this._content),this._closeButton.type="button",this._closeButton.innerHTML="&#215;",this._closeButton.addEventListener("click",this._onClose))}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;const x=this._container.querySelector(Rl);x&&x.focus()}},u.RasterDEMTileSource=wi,u.RasterTileSource=ii,u.ScaleControl=class{constructor(x){this._onMove=()=>{wa(this._map,this._container,this.options)},this.setUnit=n=>{this.options.unit=n,wa(this._map,this._container,this.options)},this.options=Object.assign(Object.assign({},$s),x)}getDefaultPosition(){return"bottom-left"}onAdd(x){return this._map=x,this._container=P.create("div","maplibregl-ctrl maplibregl-ctrl-scale",x.getContainer()),this._map.on("move",this._onMove),this._onMove(),this._container}onRemove(){P.remove(this._container),this._map.off("move",this._onMove),this._map=void 0}},u.ScrollZoomHandler=Ss,u.Style=rl,u.TerrainControl=class{constructor(x){this._toggleTerrain=()=>{this._map.getTerrain()?this._map.setTerrain(null):this._map.setTerrain(this.options),this._updateTerrainIcon()},this._updateTerrainIcon=()=>{this._terrainButton.classList.remove("maplibregl-ctrl-terrain"),this._terrainButton.classList.remove("maplibregl-ctrl-terrain-enabled"),this._map.terrain?(this._terrainButton.classList.add("maplibregl-ctrl-terrain-enabled"),this._terrainButton.title=this._map._getUIString("TerrainControl.Disable")):(this._terrainButton.classList.add("maplibregl-ctrl-terrain"),this._terrainButton.title=this._map._getUIString("TerrainControl.Enable"))},this.options=x}onAdd(x){return this._map=x,this._container=P.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._terrainButton=P.create("button","maplibregl-ctrl-terrain",this._container),P.create("span","maplibregl-ctrl-icon",this._terrainButton).setAttribute("aria-hidden","true"),this._terrainButton.type="button",this._terrainButton.addEventListener("click",this._toggleTerrain),this._updateTerrainIcon(),this._map.on("terrain",this._updateTerrainIcon),this._container}onRemove(){P.remove(this._container),this._map.off("terrain",this._updateTerrainIcon),this._map=void 0}},u.TwoFingersTouchPitchHandler=xa,u.TwoFingersTouchRotateHandler=fu,u.TwoFingersTouchZoomHandler=hu,u.TwoFingersTouchZoomRotateHandler=gu,u.VectorTileSource=os,u.VideoSource=zs,u.addSourceType=(x,n)=>l._(void 0,void 0,void 0,(function*(){if(Mn(x))throw new Error(`A source type called "${x}" already exists.`);((d,p)=>{Pn[d]=p})(x,n)})),u.clearPrewarmedResources=function(){const x=kt;x&&(x.isPreloaded()&&x.numActive()===1?(x.release(wt),kt=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},u.getMaxParallelImageRequests=function(){return l.a.MAX_PARALLEL_IMAGE_REQUESTS},u.getRTLTextPluginStatus=function(){return Dr().getRTLTextPluginStatus()},u.getVersion=function(){return wu},u.getWorkerCount=function(){return _t.workerCount},u.getWorkerUrl=function(){return l.a.WORKER_URL},u.importScriptInWorkers=function(x){return Li().broadcast("IS",x)},u.prewarm=function(){Kt().acquire(wt)},u.setMaxParallelImageRequests=function(x){l.a.MAX_PARALLEL_IMAGE_REQUESTS=x},u.setRTLTextPlugin=function(x,n){return Dr().setRTLTextPlugin(x,n)},u.setWorkerCount=function(x){_t.workerCount=x},u.setWorkerUrl=function(x){l.a.WORKER_URL=x}}));var a=t;return a}))})(Wf)),Wf.exports}var fS=q5();const D_=Qw(fS),X5=dE({__proto__:null,default:D_},[fS]);try{const i=D_;if(!i.getProtocol||!i.getProtocol("pmtiles")){const e=new F5;D_.addProtocol("pmtiles",e.tile.bind(e))}}catch{}const Gu="naivo-base-overlay",Oa="naivo-base-overlay",Ku="ign-contours",Ju="ign-contours",Qu="naivo-slopes-overlay",eh="naivo-slopes-overlay",th="naivo-snow-overlay",ih="naivo-snow-overlay",rh="naivo-ski-traces-overlay",sh="naivo-ski-traces-overlay",nh="opensnowmap-pistes",oh="opensnowmap-pistes",Af="naivo-peaks-circle",ah="naivo-peaks-marker",ic="naivo-peaks-marker-major",lh="naivo-peaks-label",ch="naivo-peaks-label-major",Z5=i=>{const{mapInstance:e,activeBaseLayer:t,hillshadeEnabled:r,contoursEnabled:s,slopesEnabled:a,snowEnabled:u,peaksEnabled:l,skiTracesEnabled:g,openSkiMapEnabled:v,baseLayer:T}=i,S=je.useRef({activeBaseLayer:t,hillshadeEnabled:r,contoursEnabled:s,slopesEnabled:a,snowEnabled:u,peaksEnabled:l,skiTracesEnabled:g,openSkiMapEnabled:v,baseLayer:T});je.useEffect(()=>{S.current={activeBaseLayer:t,hillshadeEnabled:r,contoursEnabled:s,slopesEnabled:a,snowEnabled:u,peaksEnabled:l,skiTracesEnabled:g,openSkiMapEnabled:v,baseLayer:T}});const P=ve=>{if(ve){try{ve.getLayer?.(Oa)&&ve.removeLayer(Oa)}catch{}try{ve.getSource?.(Gu)&&ve.removeSource(Gu)}catch{}}},O=ve=>{if(ve){try{ve.getLayer?.(Ju)&&ve.removeLayer(Ju)}catch{}try{ve.getSource?.(Ku)&&ve.removeSource(Ku)}catch{}}},$=ve=>{if(ve){try{ve.getLayer?.(eh)&&ve.removeLayer(eh)}catch{}try{ve.getSource?.(Qu)&&ve.removeSource(Qu)}catch{}}},W=ve=>{if(ve){try{ve.getLayer?.(ih)&&ve.removeLayer(ih)}catch{}try{ve.getSource?.(th)&&ve.removeSource(th)}catch{}}},G=ve=>{if(ve){try{ve.getLayer?.(sh)&&ve.removeLayer(sh)}catch{}try{ve.getSource?.(rh)&&ve.removeSource(rh)}catch{}}},Q=ve=>{if(ve){try{ve.getLayer?.(oh)&&ve.removeLayer(oh)}catch{}try{ve.getSource?.(nh)&&ve.removeSource(nh)}catch{}}},ae=ve=>{if(ve){try{ve.getLayer?.(lh)&&ve.removeLayer(lh)}catch{}try{ve.getLayer?.(ch)&&ve.removeLayer(ch)}catch{}try{ve.getLayer?.(ah)&&ve.removeLayer(ah)}catch{}try{ve.getLayer?.(ic)&&ve.removeLayer(ic)}catch{}try{ve.getLayer?.(Af)&&ve.removeLayer(Af)}catch{}}},te=(ve,ie=!1)=>{if(ve)try{const ce=ve.getStyle?.()?.layers;return!Array.isArray(ce)||ce.length===0?void 0:ie?ce[0]?.id:ce.find(Be=>Be?.type==="symbol"&&Be?.id)?.id}catch{return}},me=ve=>{if(!ve)return null;try{const ge=ve.getStyle?.()?.sources;if(!ge||typeof ge!="object")return null;const ce=["openmaptiles","openfreemap","osm","planet","composite"];for(const ke of ce)if(ge[ke]?.type==="vector")return ke;for(const[ke,Be]of Object.entries(ge))if(Be?.type==="vector")return ke}catch{}return null},we=ve=>{if(!ve)return null;try{const ge=ve.getStyle?.()?.layers;if(!Array.isArray(ge))return null;for(const ce of ge){if(ce?.type!=="symbol")continue;const ke=ce?.layout?.["text-font"];if(Array.isArray(ke))return ke}}catch{}return null},Oe=(ve,ie)=>{if(ve)try{const ce=ve.getStyle?.()?.layers;if(!Array.isArray(ce))return;ce.forEach(ke=>{if(ke.id===Oa)return;let Be="";if(ke.type==="background")Be="background-opacity";else if(ke.type==="fill")Be="fill-opacity";else if(ke.type==="raster"){if([Oa,Ju,eh,ih,sh,oh].includes(ke.id))return;Be="raster-opacity"}Be&&ve.setPaintProperty?.(ke.id,Be,ie)})}catch(ge){console.warn("[useMapSync] Failed to set base map opacity",ge)}},Je=ve=>{if(!ve)return;const ie=S.current.activeBaseLayer,ge=S.current.hillshadeEnabled!==!1;if(ie?.overlayMode!=="map"||!ie?.overlayUrl){P(ve);return}const ce=typeof ie.overlayOpacity=="number"?ie.overlayOpacity:1;try{ve.getSource?.(Gu)||ve.addSource(Gu,{type:"raster",tiles:[ie.overlayUrl],tileSize:256,maxzoom:12,attribution:ie.overlayAttributionLabel}),ve.getLayer?.(Oa)||ve.addLayer({id:Oa,type:"raster",source:Gu,paint:{"raster-opacity":ge?ce:0,"raster-saturation":-1,"raster-contrast":.15,"raster-brightness-min":0,"raster-brightness-max":1,"raster-fade-duration":0},maxzoom:24},te(ve,!0));const ke=ge?ce:0;ve.setPaintProperty?.(Oa,"raster-opacity",ke),Oe(ve,ge?.45:1)}catch{}},it=ve=>{if(!ve)return;if(!S.current.contoursEnabled){O(ve);return}try{ve.getSource?.(Ku)||ve.addSource(Ku,{type:"raster",tiles:["https://data.geopf.fr/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=ELEVATION.CONTOUR.LINE&STYLE=normal&TILEMATRIXSET=PM&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&FORMAT=image/png"],tileSize:256,minzoom:10,maxzoom:17,attribution:"Contours  IGN"}),ve.getLayer?.(Ju)||ve.addLayer({id:Ju,type:"raster",source:Ku,paint:{"raster-opacity":.65,"raster-fade-duration":0},maxzoom:24},te(ve))}catch{}},He=ve=>{if(!ve)return;if(!S.current.slopesEnabled){$(ve);return}try{ve.getSource?.(Qu)||ve.addSource(Qu,{type:"raster",tiles:[wN],tileSize:256,minzoom:6,maxzoom:17,attribution:IT}),ve.getLayer?.(eh)||ve.addLayer({id:eh,type:"raster",source:Qu,paint:{"raster-opacity":.55,"raster-fade-duration":0},maxzoom:24},te(ve))}catch(ge){console.warn("[useMapSync] Failed to sync slopes",ge)}},ht=ve=>{if(!ve)return;if(!S.current.snowEnabled){W(ve);return}try{ve.getSource?.(th)||ve.addSource(th,{type:"raster",url:"pmtiles://https://raw.githubusercontent.com/NCSdecoopman/naivo-data/master/data/tiles/snow_depth.pmtiles",tileSize:256,minzoom:6,maxzoom:12,attribution:"Snow  Naivo donnes BERA Mto-France"}),ve.getLayer?.(ih)||ve.addLayer({id:ih,type:"raster",source:th,paint:{"raster-opacity":.8,"raster-fade-duration":0},maxzoom:24},te(ve))}catch(ge){console.warn("[useMapSync] Failed to sync snow",ge)}},Ye=ve=>{if(!ve)return;if(!S.current.skiTracesEnabled){G(ve);return}try{ve.getSource?.(rh)||ve.addSource(rh,{type:"raster",tiles:["https://data.geopf.fr/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=TRACES.RANDO.HIVERNALE&STYLE=normal&FORMAT=image/png&TILEMATRIXSET=PM_6_16&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}"],tileSize:256}),ve.getLayer?.(sh)||ve.addLayer({id:sh,type:"raster",source:rh,minzoom:6,maxzoom:24,paint:{"raster-opacity":.8,"raster-fade-duration":0}},te(ve))}catch(ge){console.warn("[useMapSync] Failed to sync ski traces",ge)}},ft=ve=>{if(!ve)return;if(!S.current.openSkiMapEnabled){Q(ve);return}try{ve.getSource?.(nh)||ve.addSource(nh,{type:"raster",tiles:[TN],tileSize:256,attribution:CT}),ve.getLayer?.(oh)||ve.addLayer({id:oh,type:"raster",source:nh,paint:{"raster-opacity":.9,"raster-fade-duration":0}},te(ve))}catch(ge){console.warn("[useMapSync] Failed to sync open ski map",ge)}},Ke=ve=>{if(!ve)return;const ie=S.current.activeBaseLayer,ge=S.current.peaksEnabled!==!1;if(!ie?.showPeaks){ae(ve);return}if(!ge){const ke="none";[ic,ch,ah,lh,Af].forEach(Ve=>{try{ve.getLayer?.(Ve)&&ve.setLayoutProperty?.(Ve,"visibility",ke)}catch{}});return}const ce=me(ve);if(!ce){ae(ve);return}try{if(!!ve.getLayer?.(ic)){const ii="visible";[ic,ch,ah,lh,Af].forEach(qi=>{try{ve.getLayer?.(qi)&&ve.setLayoutProperty?.(qi,"visibility",ii)}catch{}});return}const Be=typeof ie.peaksMinZoom=="number"?ie.peaksMinZoom:11,Ve=typeof ie.peaksMajorMinZoom=="number"?ie.peaksMajorMinZoom:Math.min(Be,7),We=Math.max(0,Be-.01),tt=we(ve)??["Noto Sans Regular"],wt=["coalesce",["get","name:latin"],["get","name"],["get","name_en"],["get","name:fr"],""],_t=["coalesce",["to-number",["get","ele"]],["to-number",["get","elevation"]],0],$t=["coalesce",["to-number",["get","rank"]],999],kt=["to-string",_t],Kt=["<=",$t,["step",["zoom"],4,8,5,10,7,11,9]],Et=["coalesce",["-",["*",$t,1e5],_t],0],Ri=["case",["==",["slice",["downcase",["to-string",wt]],0,4],"col "],"||",""],Fi=["any",["has","name:latin"],["has","name"],["has","name_en"],["has","name:fr"]],Lt=["any",["has","ele"],["has","elevation"]],Ce=["concat",kt," m"],ns=["case",["all",Fi,Lt],["format",wt,{"font-scale":1},`
`,{},Ce,{"font-scale":.82,"text-color":"rgba(30, 41, 59, 0.9)"}],Fi,["format",wt,{"font-scale":1}],Lt,["format",Ce,{"font-scale":.9,"text-color":"rgba(30, 41, 59, 0.9)"}],["format","",{}]],os=["any",["has","name"],["has","name:fr"],["has","name:latin"],["has","name_en"],["has","ele"],["has","elevation"]];ae(ve),ve.addLayer({id:ic,type:"symbol",source:ce,"source-layer":"mountain_peak",minzoom:Ve,maxzoom:We,filter:["all",Kt,os],layout:{"symbol-sort-key":Et,"text-field":Ri,"text-font":tt,"text-size":["interpolate",["linear"],["zoom"],Ve,11,Ve+4,15],"text-anchor":"center","text-allow-overlap":!1,"text-ignore-placement":!1,"text-optional":!0},paint:{"text-color":"rgba(217, 119, 6, 0.95)","text-halo-color":"rgba(255, 255, 255, 0.95)","text-halo-width":1,"text-halo-blur":.6}}),ve.addLayer({id:ch,type:"symbol",source:ce,"source-layer":"mountain_peak",minzoom:Ve,maxzoom:We,filter:["all",Kt,os],layout:{"symbol-sort-key":Et,"text-field":ns,"text-font":tt,"text-size":["interpolate",["linear"],["zoom"],Ve,10,Ve+4,13],"text-line-height":1.15,"text-letter-spacing":.02,"text-offset":[0,.6],"text-anchor":"top","text-max-width":12,"text-allow-overlap":!1,"text-ignore-placement":!1,"text-optional":!0},paint:{"text-color":"rgba(15, 23, 42, 0.95)","text-halo-color":"rgba(255, 255, 255, 0.95)","text-halo-width":1.35,"text-halo-blur":.9}}),ve.addLayer({id:ah,type:"symbol",source:ce,"source-layer":"mountain_peak",minzoom:Be,filter:os,layout:{"symbol-sort-key":Et,"text-field":Ri,"text-font":tt,"text-size":["interpolate",["linear"],["zoom"],Be,12,Be+4,16],"text-anchor":"center","text-allow-overlap":!0,"text-ignore-placement":!0,"text-optional":!0},paint:{"text-color":"rgba(217, 119, 6, 0.95)","text-halo-color":"rgba(255, 255, 255, 0.95)","text-halo-width":1,"text-halo-blur":.6}}),ve.addLayer({id:lh,type:"symbol",source:ce,"source-layer":"mountain_peak",minzoom:Be,filter:os,layout:{"symbol-sort-key":Et,"text-field":ns,"text-font":tt,"text-size":["interpolate",["linear"],["zoom"],Be,10,Be+4,13],"text-line-height":1.15,"text-letter-spacing":.02,"text-max-width":["interpolate",["linear"],["zoom"],Be,8,Be+4,14],"text-padding":2,"text-variable-anchor":["top","top-right","right","bottom-right","bottom","bottom-left","left","top-left"],"text-radial-offset":.9,"text-justify":"auto","text-allow-overlap":!1,"text-ignore-placement":!1,"text-optional":!0},paint:{"text-color":"rgba(15, 23, 42, 0.95)","text-halo-color":"rgba(255, 255, 255, 0.95)","text-halo-width":1.35,"text-halo-blur":.9}})}catch{}},Ze=ve=>{ve&&(Je(ve),it(ve),He(ve),ht(ve),Ye(ve),ft(ve),Ke(ve))};je.useEffect(()=>{if(!e)return;const ve=e,ie=()=>{Ze(ve)};return ve.isStyleLoaded()&&ie(),ve.on("style.load",ie),()=>{ve.off("style.load",ie),P(ve),O(ve),$(ve),W(ve),G(ve),Q(ve),ae(ve)}},[e]),je.useEffect(()=>{!e||!e.isStyleLoaded()||Ze(e)},[e,t,r,s,a,u,g,v,l,T])},Y5="https://raw.githubusercontent.com/NCSdecoopman/naivo-data/master/data/tiles/snow_depth_raw.pmtiles",Nm=13;function G5(i,e,t){return i<<8|e}function K5(i,e,t){const r=Math.pow(2,t),s=(i+180)/360*r,a=e*Math.PI/180,u=(1-Math.asinh(Math.tan(a))/Math.PI)/2*r;return{tx:Math.floor(s),ty:Math.floor(u),px:Math.floor(s%1*256),py:Math.floor(u%1*256)}}const J5=(i,e)=>{const[t,r]=je.useState(null),[s,a]=je.useState(!1),u=je.useRef(null),l=je.useRef(null),g=je.useCallback(async()=>{if(l.current)return l.current;const S=u.current;if(!S)return{scheme:"xyz",maxZoom:Nm};try{const[P,O]=await Promise.all([S.getHeader?.(),S.getMetadata?.()]),W=(typeof O?.scheme=="string"?O.scheme.toLowerCase():"xyz")==="tms"?"tms":"xyz",G=Number.isFinite(P?.maxZoom)?P.maxZoom:Nm,Q={scheme:W,maxZoom:G};return l.current=Q,Q}catch{return{scheme:"xyz",maxZoom:Nm}}},[]),v=je.useCallback(async S=>{if(!(!i||!e)){a(!0);try{const{lng:P,lat:O}=S.lngLat,$=await oE(O,P,i),W=$??1500,G=$===void 0;u.current||(u.current=new k_(Y5),l.current=null);const{scheme:Q,maxZoom:ae}=await g(),te=Math.max(0,Math.floor(ae)),{tx:me,ty:we,px:Oe,py:Je}=K5(P,O,te),it=Q==="tms"?(1<<te)-1-we:we;let He=null;try{const ht=await u.current.getZxy(te,me,it);if(ht){const Ye=new Blob([ht.data],{type:"image/png"}),ft=URL.createObjectURL(Ye),Ke=new Image;Ke.src=ft,await new Promise((ie,ge)=>{Ke.onload=ie,Ke.onerror=ge});const Ze=document.createElement("canvas");Ze.width=256,Ze.height=256;const ve=Ze.getContext("2d",{willReadFrequently:!0});if(ve){ve.drawImage(Ke,0,0);const ie=ve.getImageData(Oe,Je,1,1).data,ge=ie[0],ce=ie[1],ke=ie[2];ie[3]===0?He=null:He=G5(ge,ce,ke)}URL.revokeObjectURL(ft)}}catch(ht){console.debug("[useSnowQuery] No tile or error sampling PMTiles:",ht)}r({lngLat:{lng:P,lat:O},elevation:Math.round(W),isEstimated:G,snowDepth:He})}catch(P){console.error("[useSnowQuery] Error:",P),r(null)}finally{a(!1)}}},[i,e]),T=je.useCallback(()=>r(null),[]);return{queryResult:t,loading:s,handleMapClick:v,clearQuery:T}},Q5=({baseLayer:i,setBaseLayer:e})=>Le.jsx("div",{className:"hidden sm:flex absolute z-[1200] flex-col items-end gap-1 pointer-events-none",style:{top:"calc(env(safe-area-inset-top, 0px) + 10px)",right:"calc(env(safe-area-inset-right, 0px) + 8px)"},children:Le.jsx("div",{className:"h-11 bg-[rgba(31,41,55,0.95)] border border-[var(--border)] rounded-[10px] shadow-[0_10px_30px_rgba(0,0,0,0.4)] overflow-hidden flex pointer-events-auto backdrop-blur-sm",children:Object.values(PT).map(t=>Le.jsx("button",{onClick:()=>e(t.id),className:`px-4 h-full flex items-center justify-center text-[11px] font-semibold transition-colors border-r border-[var(--border)]/70 last:border-r-0 ${i===t.id?"bg-[var(--primary)] text-white shadow-[0_8px_18px_rgba(59,130,246,0.32)]":"bg-[rgba(31,41,55,0.95)] text-[var(--text-main)] sm:hover:bg-[rgba(55,65,81,0.95)] active:bg-[rgba(255,255,255,0.12)]"}`,children:t.toggleLabel},t.id))})}),eU=({onZoomIn:i,onZoomOut:e,canZoomIn:t,canZoomOut:r})=>Le.jsx("div",{className:"absolute z-[4000]",style:{bottom:"calc(env(safe-area-inset-bottom, 0px) + 12px)",right:"calc(env(safe-area-inset-right, 0px) + 12px)"},children:Le.jsxs("div",{className:"w-11 bg-[rgba(31,41,55,0.95)] border border-[var(--border)] rounded-[10px] shadow-[0_10px_30px_rgba(0,0,0,0.4)] overflow-hidden flex flex-col pointer-events-auto backdrop-blur-sm",children:[Le.jsx("button",{type:"button","aria-label":"Zoomer",onClick:i,disabled:!t,className:"h-11 w-full text-white text-4xl font-semibold border-b border-[rgba(255,255,255,0.1)] transition-all duration-300 sm:hover:bg-[rgba(55,65,81,0.95)] active:bg-[rgba(75,85,99,0.95)] active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center pb-1",children:"+"}),Le.jsx("button",{type:"button","aria-label":"Dezoomer",onClick:e,disabled:!r,className:"h-11 w-full text-white text-4xl font-semibold transition-all duration-300 sm:hover:bg-[rgba(55,65,81,0.95)] active:bg-[rgba(75,85,99,0.95)] active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center pb-1",children:"-"})]})}),Hw=i=>{if(typeof window>"u")return;const e=document.getElementById(i);e&&e.click()},tU=({isOpen:i,setIsOpen:e,attributions:t=[]})=>{const r=je.useRef(null);return aE(r,()=>e(!1)),Le.jsxs("div",{ref:r,className:"relative",children:[Le.jsx("button",{onClick:()=>e(!i),className:"h-11 w-11 rounded-[10px] bg-[rgba(31,41,55,0.95)] border border-[var(--border)] text-white shadow-[0_10px_30px_rgba(0,0,0,0.4)] backdrop-blur-sm flex items-center justify-center transition-all duration-300 ease-out active:scale-95",title:"Informations et sources",children:Le.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",width:"22",height:"22",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[Le.jsx("circle",{cx:"12",cy:"12",r:"10"}),Le.jsx("line",{x1:"12",y1:"16",x2:"12",y2:"12"}),Le.jsx("line",{x1:"12",y1:"8",x2:"12.01",y2:"8"})]})}),i&&Le.jsxs("div",{className:"map-info-panel bg-[var(--card-bg)]/95 border border-[var(--border)] rounded-[var(--radius)] shadow-[var(--shadow)] backdrop-blur-md p-3 space-y-3",children:[Le.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[Le.jsx("a",{href:"/sources",className:"inline-flex items-center justify-center bg-[var(--input-bg)] border border-[var(--border)] rounded-[var(--radius)] px-2 h-10 text-[12px] font-medium text-[var(--text-main)]",onClick:()=>e(!1),children:"Sources"}),Le.jsx("a",{href:"/tutoriel",className:"inline-flex items-center justify-center bg-[var(--input-bg)] border border-[var(--border)] rounded-[var(--radius)] px-2 h-10 text-[12px] font-medium text-[var(--text-main)]",onClick:()=>e(!1),children:"Tutoriel"}),Le.jsx("a",{href:"/faq",className:"inline-flex items-center justify-center bg-[var(--input-bg)] border border-[var(--border)] rounded-[var(--radius)] px-2 h-10 text-[12px] font-medium text-[var(--text-main)]",onClick:()=>e(!1),children:"FAQ"})]}),Le.jsxs("div",{className:"grid grid-cols-4 gap-2",children:[Le.jsx("button",{type:"button","aria-label":"Ajouter Naivo sur Android",onClick:()=>{e(!1),Hw("install-pwa-android")},className:"inline-flex items-center justify-center bg-[var(--input-bg)] border border-[var(--border)] rounded-[var(--radius)] h-12 text-[var(--text-main)] shadow-sm transition-all duration-300 ease-out sm:hover:border-[var(--primary)] sm:hover:ring-1 sm:hover:ring-[var(--primary)] active:bg-[rgba(55,65,81,0.95)]",children:Le.jsxs("svg",{viewBox:"0 0 30 30",width:"22",height:"22","aria-hidden":"true",children:[Le.jsx("rect",{x:"3",y:"3",width:"24",height:"24",rx:"6",ry:"6",fill:"none",stroke:"currentColor",strokeWidth:"2"}),Le.jsx("path",{fill:"currentColor",d:"M12 9l8 5c.8.5.8 1.5 0 2l-8 5c-.7.5-1.7-.1-1.7-1V10c0-.9 1-1.5 1.7-1z"})]})}),Le.jsx("button",{type:"button","aria-label":"Ajouter Naivo sur iOS",onClick:()=>{e(!1),Hw("install-pwa-ios")},className:"inline-flex items-center justify-center bg-[var(--input-bg)] border border-[var(--border)] rounded-[var(--radius)] h-12 text-[var(--text-main)] shadow-sm transition-all duration-300 ease-out sm:hover:border-[var(--primary)] sm:hover:ring-1 sm:hover:ring-[var(--primary)] active:bg-[rgba(55,65,81,0.95)]",children:Le.jsxs("svg",{viewBox:"0 0 30 30",width:"22",height:"22","aria-hidden":"true",children:[Le.jsx("rect",{x:"3",y:"3",width:"24",height:"24",rx:"6",ry:"6",fill:"none",stroke:"currentColor",strokeWidth:"2"}),Le.jsx("path",{fill:"currentColor",d:"M18.3 15.9c-.01-1.3.58-2.3 1.78-3.0-.67-.95-1.68-1.49-3.02-1.59-1.27-.1-2.66.75-3.16.75-.53 0-1.74-.71-2.69-.71-1.97.03-4.08 1.54-4.08 4.58 0 .92.17 1.87.5 2.84.45 1.29 2.08 4.47 3.78 4.42.9-.02 1.52-.62 2.69-.62 1.14 0 1.73.62 2.69.62 1.69-.03 3.19-2.94 3.62-4.23-2.34-1.1-2.07-4.04-2.07-4.04zm-1.82-5.99c.94-1.12.85-2.14.83-2.37-.91.05-1.93.62-2.53 1.33-.55.65-.93 1.71-.82 2.7.98.08 1.99-.5 2.52-1.66z"})]})}),Le.jsx("a",{href:"https://www.facebook.com/naivo.fr/",target:"_blank",rel:"noreferrer","aria-label":"Facebook Naivo",className:"inline-flex items-center justify-center bg-[var(--input-bg)] border border-[var(--border)] rounded-[var(--radius)] h-12 text-[var(--text-main)] shadow-sm transition-all duration-300 ease-out sm:hover:border-[var(--primary)] sm:hover:ring-1 sm:hover:ring-[var(--primary)] active:bg-[rgba(55,65,81,0.95)]",onClick:()=>e(!1),children:Le.jsxs("svg",{viewBox:"0 0 30 30",width:"22",height:"22","aria-hidden":"true",children:[Le.jsx("rect",{x:"3",y:"3",width:"24",height:"24",rx:"6",ry:"6",fill:"none",stroke:"currentColor",strokeWidth:"2"}),Le.jsx("path",{fill:"currentColor",d:"M16 22v-6h2.2l.3-2H16v-1.5c0-.7.3-1.1 1.1-1.1h1.4V8.8c-.5 0-1.4-.1-2.5-.1-2.4 0-3.9 1.4-3.9 3.9V14h-2v2h2v6h3.9z"})]})}),Le.jsx("a",{href:"https://www.instagram.com/naivo.fr/",target:"_blank",rel:"noreferrer","aria-label":"Instagram Naivo",className:"inline-flex items-center justify-center bg-[var(--input-bg)] border border-[var(--border)] rounded-[var(--radius)] h-12 text-[var(--text-main)] shadow-sm transition-all duration-300 ease-out sm:hover:border-[var(--primary)] sm:hover:ring-1 sm:hover:ring-[var(--primary)] active:bg-[rgba(55,65,81,0.95)]",onClick:()=>e(!1),children:Le.jsxs("svg",{viewBox:"0 0 30 30",width:"22",height:"22","aria-hidden":"true",children:[Le.jsx("rect",{x:"3",y:"3",width:"24",height:"24",rx:"6",ry:"6",fill:"none",stroke:"currentColor",strokeWidth:"2"}),Le.jsx("circle",{cx:"15",cy:"15",r:"5",fill:"none",stroke:"currentColor",strokeWidth:"2"}),Le.jsx("circle",{cx:"20",cy:"8",r:"1.6",fill:"currentColor"})]})})]}),Le.jsx("div",{className:"text-[10px] text-[var(--text-muted)] leading-snug text-center flex flex-col gap-1",children:t.map((s,a)=>Le.jsx("div",{children:s},a))})]}),Le.jsx("style",{children:`
                .map-info-panel { 
                    position: fixed;
                    z-index: 4200;
                    left: calc(env(safe-area-inset-left, 0px) + 12px); 
                    right: calc(env(safe-area-inset-right, 0px) + 12px); 
                    top: calc(env(safe-area-inset-top, 0px) + 62px); 
                }
                @media (min-width: 640px) { 
                    .map-info-panel { 
                        position: absolute;
                        left: auto; 
                        right: 0; 
                        width: 320px; 
                        top: 52px;
                    } 
                }
            `})]})},iU=[{key:"neige",label:"Hauteur de neige",unit:"cm",color:"#ffffff",baselineZero:!0},{key:"temp",label:"Temprature",unit:"C",color:"#f97316",baselineZero:!0,tempPalette:{pos:"#ef4444",neg:"#2563eb"}},{key:"vent",label:"Vitesse moyenne du vent sur 10 min",unit:"km/h",color:"#10b981",baselineZero:!0},{key:"rafale",label:"Rafales",unit:"km/h",color:"#14b8a6",baselineZero:!0}],rU="https://raw.githubusercontent.com/NCSdecoopman/naivo-data/master/data//releves/releves.sqlite",sU="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.11.0/sql-wasm.js",qw="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.11.0",Xw="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js",Zw="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js";let Ef=null,If=null,Cf=null,Yw=!1;async function nU(){return typeof window>"u"?null:window.initSqlJs?window.initSqlJs({locateFile:i=>`${qw}/${i}`}):new Promise((i,e)=>{const t=document.createElement("script");t.src=sU,t.async=!0,t.onload=()=>{window.initSqlJs?window.initSqlJs({locateFile:r=>`${qw}/${r}`}).then(i).catch(e):e(new Error("initSqlJs not available"))},t.onerror=()=>e(new Error("Failed to load sql.js")),document.head.appendChild(t)})}async function oU(){return Ef||(Ef=(async()=>{const i=await nU();if(!i)return null;const t=await(await fetch(rU,{cache:"no-cache"})).arrayBuffer();return new i.Database(new Uint8Array(t))})(),Ef)}async function aU(){return If||(If=new Promise((i,e)=>{if(typeof window>"u"){i(null);return}if(window.Chart){i(window.Chart);return}const t=document.querySelector(`script[src="${Xw}"]`);if(t){t.addEventListener("load",()=>i(window.Chart)),t.addEventListener("error",()=>e(new Error("Failed to load Chart.js")));return}const r=document.createElement("script");r.src=Xw,r.async=!0,r.onload=()=>i(window.Chart),r.onerror=()=>e(new Error("Failed to load Chart.js")),document.head.appendChild(r)}),If.then(i=>(i&&i.register&&i.registerables&&!Yw&&(i.register(...i.registerables),Yw=!0),i)))}async function lU(){return Cf||(Cf=new Promise((i,e)=>{if(typeof window>"u"){i();return}if(window.Chart&&window.Chart._adapters?.date){i();return}const t=document.querySelector(`script[src="${Zw}"]`);if(t){t.addEventListener("load",()=>i()),t.addEventListener("error",()=>e(new Error("Failed to load Chart.js date adapter")));return}const r=document.createElement("script");r.src=Zw,r.async=!0,r.onload=()=>i(),r.onerror=()=>e(new Error("Failed to load Chart.js date adapter")),document.head.appendChild(r)}),Cf)}async function Gw(){const i=await aU();return await lU(),i}const cU=new Intl.DateTimeFormat("fr-FR",{day:"2-digit",month:"2-digit",hour:"2-digit",minute:"2-digit",hour12:!1}),uU=new Intl.DateTimeFormat("fr-FR",{day:"2-digit",month:"2-digit"}),hU={id:"clickLine",afterDraw(i){const e=i.$clickLineX;if(e==null)return;const{ctx:t,chartArea:r}=i;!r||e<r.left||e>r.right||(t.save(),t.strokeStyle="rgba(255,255,255,0.35)",t.lineWidth=1,t.beginPath(),t.moveTo(e,r.top),t.lineTo(e,r.bottom),t.stroke(),t.restore())}};function dU({values:i,times:e,color:t,baselineZero:r,tempPalette:s,label:a,unit:u,days:l,interactionEnabled:g}){const v=je.useRef(null),T=je.useRef(null),[S,P]=je.useState(null),[O,$]=je.useState(!1),[W,G]=je.useState(!1),Q=je.useRef(!0);return je.useEffect(()=>{Q.current=g},[g]),je.useEffect(()=>{if(typeof window>"u"||!window.matchMedia)return;const ae=window.matchMedia("(pointer: coarse)"),te=()=>G(ae.matches);return te(),ae.addEventListener?ae.addEventListener("change",te):ae.addListener&&ae.addListener(te),()=>{ae.removeEventListener?ae.removeEventListener("change",te):ae.removeListener&&ae.removeListener(te)}},[]),je.useEffect(()=>{let ae=!1;return Gw().then(te=>{if(!ae){if(!te){P("Chart.js non disponible");return}$(!0)}}).catch(te=>{console.error("Chart.js load error",te),ae||P("Chart.js non disponible")}),()=>{ae=!0}},[]),je.useEffect(()=>{let ae=!1;return(async()=>{try{const me=await Gw();if(ae||!me||!v.current||(T.current&&(T.current.destroy(),T.current=null),!i.length||!e.length))return;const we=s?s.pos:t,Oe=s?{target:"origin",above:s.pos+"33",below:s.neg+"33"}:!0,Je=Ke=>{if(!s)return we;const Ze=Ke?.p0?.parsed?.y,ve=Ke?.p1?.parsed?.y;if(!Number.isFinite(Ze)||!Number.isFinite(ve))return we;const ie=Ze>=0,ge=ve>=0;if(ie&&ge)return s.pos;if(!ie&&!ge)return s.neg;const ce=ie?s.pos:s.neg,ke=ge?s.pos:s.neg,Be=Ke?.chart,Ve=Be?.scales?.y;if(!Be||!Ve)return ce;const We=Ve.getPixelForValue(0),tt=Ke.p0.x,wt=Ke.p0.y,_t=Ke.p1.x,$t=Ke.p1.y,kt=Be.ctx.createLinearGradient(tt,wt,_t,$t),Bt=$t-wt,Kt=Bt===0?.5:(We-wt)/Bt,Et=Math.max(0,Math.min(1,Kt));return kt.addColorStop(0,ce),kt.addColorStop(Et,ce),kt.addColorStop(Et,ke),kt.addColorStop(1,ke),kt},it=e.map((Ke,Ze)=>({x:new Date(Ke),y:i[Ze]??null})),He=it.length?it[0].x.getTime():void 0,ht=it.length?it[it.length-1].x.getTime():void 0,Ye=l===1;T.current=new me(v.current,{type:"line",data:{datasets:[{label:`${a} (${u})`,data:it,borderColor:we,backgroundColor:`${we}30`,borderWidth:2,pointRadius:0,tension:.3,cubicInterpolationMode:s?"monotone":void 0,fill:Oe,segment:s?{borderColor:Je}:void 0}]},plugins:[hU],options:{events:["mousemove","mouseout","click"],responsive:!0,maintainAspectRatio:!1,scales:{x:{type:"time",bounds:"data",min:He,max:ht,time:{unit:"hour",stepSize:3,tooltipFormat:"dd/MM HH:mm",displayFormats:{hour:Ye?"HH'h'":"HH:mm",day:"dd/MM"}},afterBuildTicks:Ke=>{if(Ye)return;const Ze=Ke.ticks||[];if(!Ze.length)return;const ve=[],ie=new Set;Ze.forEach(ge=>{const ce=new Date(ge.value);ie.add(ce.toISOString().slice(0,10))}),ie.forEach(ge=>{const ce=new Date(`${ge}T12:00:00.000Z`).getTime();Ze.some(Be=>Math.abs(Be.value-ce)<1)||ve.push({value:ce,major:!1})}),ve.length&&(Ke.ticks=[...Ze,...ve].sort((ge,ce)=>ge.value-ce.value))},ticks:{autoSkip:!1,maxRotation:0,major:{enabled:!0},callback:(Ke,Ze,ve)=>{const ie=typeof Ke=="number"?Ke:Number(Ke);if(!Number.isFinite(ie))return"";const ge=ve?.[Ze],ce=new Date(ie),ke=`${String(ce.getHours()).padStart(2,"0")}h`;if(Ye)return ke;const Be=uU.format(ce);return W&&l>1||!W&&l===10?ge?.major?Be:"":ge?.major?`${Be}
${ke}`:ke},color:"#ffffff",font:{size:10}},grid:{color:Ke=>Ke.tick?.major?"rgba(255,255,255,0.18)":"rgba(255,255,255,0.08)",lineWidth:Ke=>Ke.tick?.major?1:.5}},y:{beginAtZero:r===!0,ticks:{color:"#ffffff",font:{size:10}},grid:{color:"rgba(255,255,255,0.15)"}}},plugins:{legend:{display:!1},tooltip:{intersect:!1,mode:"index",callbacks:{title:Ke=>{const Ze=Ke?.[0],ve=Ze?.parsed?.x;return typeof ve=="number"?cU.format(new Date(ve)):Ze?.label||""},label:Ke=>`${Ke.formattedValue} ${u}`}}}}});const ft=v.current;if(ft){let Ke=!1,Ze=0,ve=0,ie=!1,ge=!1,ce=!1;const ke=12,Be=6,Ve=Et=>{if(!T.current)return;const Li=ft.getBoundingClientRect(),bi=Et.clientX-Li.left;T.current.$clickLineX=bi,T.current.draw()},We=()=>{T.current&&(T.current.$clickLineX=null,T.current.draw())},tt=()=>{const Et=T.current;Et&&(Et.tooltip?.setActiveElements([],{x:0,y:0}),Et.setActiveElements([]),Et.update())},wt=()=>{Ke&&(ge=!0,ce=!0,We(),tt())},_t=Et=>{Q.current&&(Ke=!0,Ze=Et.clientX,ve=Et.clientY,ie=!1,ge=!1,ce=!1,document.addEventListener("scroll",wt,!0))},$t=Et=>{if(!Q.current||!Ke)return;const Li=Math.abs(Et.clientX-Ze),bi=Math.abs(Et.clientY-ve);if(!ie&&(Li>ke||bi>ke)){if(ie=!0,bi>=Li-Be){ge=!0,ce=!0,We(),tt();return}ce=!0}ge||Ve(Et)},kt=Et=>{Ke&&(!ge&&Et&&Ve(Et),Ke=!1,ie=!1,ge=!1,document.removeEventListener("scroll",wt,!0))},Bt=Et=>{(ce||ge)&&(Et.preventDefault(),Et.stopImmediatePropagation(),ce=!1)};ft.addEventListener("pointerdown",_t),ft.addEventListener("pointermove",$t),ft.addEventListener("pointerup",kt),ft.addEventListener("pointerleave",kt),ft.addEventListener("pointercancel",kt),ft.addEventListener("click",Bt,!0);const Kt=()=>{ft.removeEventListener("pointerdown",_t),ft.removeEventListener("pointermove",$t),ft.removeEventListener("pointerup",kt),ft.removeEventListener("pointerleave",kt),ft.removeEventListener("pointercancel",kt),ft.removeEventListener("click",Bt,!0),document.removeEventListener("scroll",wt,!0)};T.current&&(T.current._clickLineCleanup=Kt)}}catch(me){console.error("Chart init error",me),ae||P(me?.message||"Erreur affichage graphique")}})(),()=>{ae=!0,T.current&&(T.current._clickLineCleanup&&T.current._clickLineCleanup(),T.current.destroy())}},[i,e,t,r,s,a,u,l,W]),Le.jsxs("div",{className:"relative w-full h-[160px]",children:[!O&&Le.jsx("div",{className:"flex items-center justify-center py-8",children:Le.jsxs("div",{className:"loading-content",children:[Le.jsx("img",{src:"/logo/flocon-white.svg",alt:"",className:"loading-spinner h-8 w-8"}),Le.jsx("p",{className:"text-xs text-[var(--text-muted)]",children:"Chargement du moteur de graphique..."})]})}),S&&Le.jsx("div",{className:"text-xs text-red-500",children:S}),Le.jsx("canvas",{ref:v,className:"w-full h-full",style:{pointerEvents:g?"auto":"none",touchAction:"pan-y"}}),(!i.length||!e.length)&&Le.jsx("div",{className:"absolute inset-0 flex items-center justify-center text-xs text-[var(--text-muted)]",children:"Donnes indisponibles."})]})}function fU({stationId:i}){const[e,t]=je.useState([]),[r,s]=je.useState(!1),[a,u]=je.useState(null),[l,g]=je.useState(3),[v,T]=je.useState(!0);je.useEffect(()=>{if(typeof window>"u")return;if(!i){T(!1);return}let O=!1;T(!1);const $=()=>{O||(O=!0,T(!0))},W=()=>$();window.addEventListener("pointerup",W,{once:!0}),window.addEventListener("pointercancel",W,{once:!0});const G=window.setTimeout($,0);return()=>{window.removeEventListener("pointerup",W),window.removeEventListener("pointercancel",W),window.clearTimeout(G)}},[i]),je.useEffect(()=>{let O=!1;return(async()=>{if(i)try{s(!0),u(null);const W=await oU();if(!W)throw new Error("Base de donnes indisponible");const G=W.prepare("SELECT time, temp, vent, rafale, neige FROM releves WHERE id = ? ORDER BY time ASC");G.bind([i]);const Q=[];for(;G.step();){const ae=G.getAsObject();Q.push({time:ae.time,temp:ae.temp!==null?Number(ae.temp):null,vent:ae.vent!==null?Number(ae.vent)*3.6:null,rafale:ae.rafale!==null?Number(ae.rafale)*3.6:null,neige:ae.neige!==null?Number(ae.neige):null})}G.free(),O||t(Q)}catch(W){O||u(W?.message||"Impossible de charger les relevs")}finally{O||s(!1)}})(),()=>{O=!0}},[i]);const S=je.useMemo(()=>{if(!e.length)return[];const O=new Map;e.forEach(Q=>{const ae=new Date(Q.time).toISOString().slice(0,13);O.set(ae,Q)});const $=new Date(e[e.length-1].time),W=l*24,G=[];for(let Q=W;Q>=0;Q--){const ae=new Date($);ae.setHours(ae.getHours()-Q);const te=ae.toISOString().slice(0,13),me=O.get(te);me?G.push(me):G.push({time:ae.toISOString(),temp:null,vent:null,rafale:null,neige:null})}return G},[e,l]),P=[1,3,5,10];return Le.jsxs("div",{className:"flex flex-col gap-4 mt-1 w-full min-w-[280px]",children:[Le.jsx("div",{className:"flex items-center gap-2 text-xs text-white flex-wrap",children:Le.jsx("div",{className:"flex items-center gap-2",children:P.map(O=>Le.jsxs("button",{onClick:()=>g(O),className:`px-2.5 py-1 rounded-full border transition-colors text-xs ${l===O?"bg-[var(--primary)] border-[var(--primary)] text-white":"bg-[var(--card-bg)] border-[var(--border)] text-[var(--text-muted)] hover:text-[var(--text-main)]"}`,children:[O," j"]},O))})}),i===void 0&&Le.jsx("div",{className:"text-xs text-[var(--text-muted)]",children:"Aucune station slectionne"}),a&&Le.jsx("div",{className:"text-xs text-red-600",children:a}),r&&e.length===0&&Le.jsx("div",{className:"flex items-center justify-center py-12",children:Le.jsxs("div",{className:"loading-content",children:[Le.jsx("img",{src:"/logo/flocon-white.svg",alt:"",className:"loading-spinner"}),Le.jsx("p",{className:"text-sm",children:"Chargement des relevs..."})]})}),S.length===0&&!r&&!a&&Le.jsx("div",{className:"text-xs text-[var(--text-muted)]",children:"Aucune donne disponible."}),iU.map(O=>{const $=S.map(G=>{const Q=G[O.key];if(Q==null)return null;const ae=Number(Q);return Number.isNaN(ae)?null:ae});return $.some(G=>G!=null)?Le.jsxs("div",{className:"rounded-[var(--radius)] border border-[var(--border)] p-3 bg-[var(--card-bg)] shadow-[var(--shadow)]",children:[Le.jsxs("div",{className:"text-xs text-white mb-2 flex items-center gap-2",children:[Le.jsx("span",{className:"font-medium",children:O.label}),Le.jsx("span",{className:"text-[var(--text-muted)]",children:O.unit})]}),Le.jsx(dU,{values:$,times:S.map(G=>G.time),color:O.color,baselineZero:O.baselineZero,tempPalette:O.tempPalette,label:O.label,unit:O.unit,days:l,interactionEnabled:v})]},O.key):null})]})}const pU=({station:i,onClose:e})=>i?Le.jsx("div",{className:"fixed inset-0 z-[5000] flex sm:items-center sm:justify-center p-0 sm:p-4 bg-black/60 backdrop-blur-sm",onClick:e,children:Le.jsxs("div",{className:"bg-[var(--card-bg)] w-full h-full sm:h-auto sm:max-w-3xl sm:max-h-[90vh] sm:rounded-[var(--radius)] shadow-2xl border border-[var(--border)] overflow-y-auto",onClick:t=>t.stopPropagation(),children:[Le.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between px-4 py-3 border-b border-[var(--border)] gap-3 sm:gap-0 relative",children:[Le.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center gap-2 sm:gap-4 pr-8 sm:pr-0",children:[Le.jsx("div",{className:"text-lg font-semibold text-[var(--text-main)]",children:i.name}),Le.jsxs("div",{className:"text-xs text-[var(--text-muted)] flex flex-col sm:flex-row gap-1 sm:gap-3",children:[i.distance!==void 0&&Le.jsxs("span",{children:["Distance : ",i.distance.toFixed(2)," km"]}),i.altitude!==void 0&&Le.jsxs("span",{children:["Altitude : ",i.altitude," m",i.altitudeDiff!==void 0&&Le.jsxs("span",{children:[" (cart : ",i.altitudeDiff>=0?"+":"",i.altitudeDiff," m)"]})]})]})]}),Le.jsx("button",{onClick:t=>{t.stopPropagation(),t.preventDefault(),e()},onPointerDown:t=>t.stopPropagation(),className:"p-2 text-[var(--text-muted)] sm:hover:text-[var(--text-main)] sm:hover:bg-[rgba(55,65,81,0.95)] active:bg-[rgba(55,65,81,0.95)] rounded-lg transition-all duration-300 ease-out absolute top-2 right-2 sm:static sm:top-auto sm:right-auto",children:Le.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[Le.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),Le.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]}),Le.jsx("div",{className:"p-4",children:Le.jsx(fU,{stationId:i.stationId})})]})}):null,gU=i=>{if(!i)return"date inconnue";const e=new Date(i);if(Number.isNaN(e.getTime()))return i;const t=`${e.getDate()}`.padStart(2,"0"),r=`${e.getMonth()+1}`.padStart(2,"0"),s=e.getFullYear();return`${t}/${r}/${s}`},Kw=(i,e)=>{if(i==null)return null;const t=e==null||Number.isNaN(e)?null:` (cart : ${e>=0?"+":""}${Math.round(e)} m)`;return`Altitude : ${Math.round(i)} m${t??""}`},O_=i=>{const e=new Date(i);if(Number.isNaN(e.getTime()))return null;const t=`${e.getDate()}`.padStart(2,"0"),r=`${e.getMonth()+1}`.padStart(2,"0"),s=e.getFullYear(),a=`${e.getHours()}`.padStart(2,"0"),u=`${e.getMinutes()}`.padStart(2,"0");return`${t}/${r}/${s}  ${a}:${u}`},rc=(i,e)=>e?Le.jsxs("div",{children:[Le.jsx("div",{className:"text-[var(--text-main)] text-sm font-medium",children:i}),Le.jsx("div",{className:"text-[var(--text-muted)] text-xs whitespace-pre-line leading-relaxed",children:e})]}):null,mU=({condition:i,onClose:e})=>{const t=je.useMemo(()=>i?[...i.entries].sort((r,s)=>{const a=r.date_iso?new Date(r.date_iso).getTime():0;return(s.date_iso?new Date(s.date_iso).getTime():0)-a}):[],[i]);return i?Le.jsx("div",{className:"fixed inset-0 z-[5000] flex sm:items-center sm:justify-center p-0 sm:p-4 bg-black/60 backdrop-blur-sm",onClick:e,children:Le.jsxs("div",{className:"bg-[var(--card-bg)] w-full h-[100svh] max-h-[100svh] sm:h-auto sm:max-w-4xl sm:max-h-[90vh] sm:rounded-[var(--radius)] shadow-2xl border border-[var(--border)] overflow-hidden flex flex-col",onClick:r=>r.stopPropagation(),children:[Le.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between px-4 py-3 border-b border-[var(--border)] gap-3 sm:gap-0 relative",children:[Le.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center gap-2 sm:gap-4 pr-8 sm:pr-0",children:[Le.jsxs("div",{className:"text-lg font-semibold text-[var(--text-main)]",children:[t[0]?.nom||"Avis conditions"," - ",i.entries.length," avis"]}),Le.jsxs("div",{className:"text-xs text-[var(--text-muted)] flex flex-col sm:flex-row gap-1 sm:gap-3",children:[i.distance!==void 0&&Le.jsxs("span",{children:["Distance : ",i.distance.toFixed(2)," km"]}),t[0]?.altitude!==void 0&&Le.jsxs("span",{children:["Altitude : ",t[0].altitude," m",t[0].altitudeDiff!==null&&t[0].altitudeDiff!==void 0&&Le.jsxs("span",{children:[" (cart : ",t[0].altitudeDiff>=0?"+":"",t[0].altitudeDiff," m)"]})]}),t[0]?.orientation&&Le.jsxs("span",{children:["Orientation : ",t[0].orientation]})]})]}),Le.jsx("button",{onClick:r=>{r.stopPropagation(),r.preventDefault(),e()},onPointerDown:r=>r.stopPropagation(),className:"p-2 text-[var(--text-muted)] sm:hover:text-[var(--text-main)] sm:hover:bg-[rgba(55,65,81,0.95)] active:bg-[rgba(55,65,81,0.95)] rounded-lg transition-all duration-300 ease-out absolute top-2 right-2 sm:static sm:top-auto sm:right-auto",children:Le.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[Le.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),Le.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]}),Le.jsx("div",{className:"p-4 space-y-3 overflow-y-auto flex-1 min-h-0",style:{paddingBottom:"calc(1rem + env(safe-area-inset-bottom, 0px))"},children:t.map(r=>Le.jsxs("div",{className:"border border-[var(--border)] rounded-[var(--radius)] p-3 bg-[var(--card-bg)] shadow-sm space-y-3",children:[Le.jsxs("div",{className:"flex items-start justify-between gap-3",children:[Le.jsxs("div",{className:"space-y-1",children:[Le.jsxs("div",{className:"text-sm font-semibold text-[var(--text-main)]",children:["Avis du ",gU(r.date_iso)]}),Le.jsxs("div",{className:"text-[var(--text-muted)] text-xs flex gap-3 flex-wrap",children:[r.dif_ski&&Le.jsxs("span",{children:["Difficulte ski : ",r.dif_ski]}),r.skiabilite&&Le.jsxs("span",{children:["Skiabilite : ",r.skiabilite]})]})]}),r.source_url&&Le.jsx("a",{href:r.source_url,target:"_blank",rel:"noreferrer",className:"text-[var(--primary)] text-xs hover:text-[var(--primary-hover)] underline",children:"Voir la sortie"})]}),Le.jsxs("div",{className:"grid gap-3",children:[rc("Conditions de ski",r.conditions_ski),rc("Conditions nivo/avalanche",r.conditions_nivo_avalancheuse),rc("Acces parking",r.acces_parking),rc("Meteo / temperatures",r.meteo_temperatures),rc("Altitude chaussage/dechaussage",r.alt_chaussage_dechaussage),rc("Autres",r.conditions_autres)]})]},r.id))})]})}):null},_U=i=>{const[e,t]=je.useState(!1),[r,s]=je.useState(null),[a,u]=je.useState(0),[l,g]=je.useState(0),[v,T]=je.useState(null),[S,P]=je.useState(!1),O=(ae,te=new Date)=>{if(!ae?.imageUrl)return[];const me=ae.imageUrl.trim(),we=[],Oe=(ft,Ke,Ze)=>{if(!ft)return;const ve=ft.trim();ve&&(we.some(ie=>ie.url===ve)||we.push({url:ve,slotDate:Ke?Ke.toISOString():void 0,headUrl:Ze?Ze.trim():void 0}))},Je=(ft,Ke)=>{if(!ft)return;const Ze=ft.trim();if(Ze){try{if(new URL(Ze).protocol==="http:"){const ie=Ze.replace(/^http:\/\//i,"https://");Oe(ie,Ke,Ze),Oe(`${ew}/img?url=${encodeURIComponent(Ze)}`,Ke,Ze),Oe(Ze,Ke,Ze);return}}catch{}Oe(Ze,Ke,Ze)}},it=me.toLowerCase();it.includes("skaping.com")&&it.includes("thumb")&&(Je(me.replace(/thumb\.jpg/i,"large.jpg")),Je(me.replace(/thumb\.jpg/i,"full.jpg")),Je(me.replace(/thumb\.jpg/i,"medium.jpg")));const He=ae.imagePattern,ht=ae.periodicite,Ye=typeof ht=="number"?ht:Number(ht);if(He&&typeof He=="string"&&He.includes("{")&&Ye&&Number.isFinite(Ye)&&Ye>0){const ft=He.trim(),Ke=ae.decalage_horloge??0,Ze=ae.decalage_periodicite??0,ve=ae.fuseau_horaire??void 0,ie=ae.code_locale??"fr-FR",ge=Math.max(12,Math.min(200,Math.ceil(720/Ye))),ce=ae.imageDate?new Date(ae.imageDate):te,ke=lE(ce,Ye,Ke??0,Ze??0,ve);for(let Be=0;Be<ge;Be+=1){const Ve=new Date(ke.getTime()-Be*Ye*6e4),We=cE(ft,Ve,ie);Je(We,Ve)}}return Je(me,ae.imageDate?new Date(ae.imageDate):null),we},$=je.useMemo(()=>O(i),[i,a]),W=$[l],G=W?.url??i?.imageUrl,Q=W?.headUrl??G;return je.useEffect(()=>{if(!G)return;const ae=new AbortController;return(async()=>{P(!0),T(null);try{const me=await fetch(`${ew}/head?url=${encodeURIComponent(Q)}`,{signal:ae.signal});if(me.ok){const we=await me.json(),Oe=we?.last_modified||we?.lastModified;Oe&&T(O_(Oe))}}catch{}finally{P(!1)}})(),()=>ae.abort()},[G,Q,a]),je.useEffect(()=>{s(null),t(!!i?.imageUrl),u(ae=>ae+1),g(0)},[i]),{isWebcamLoading:e,setIsWebcamLoading:t,webcamError:r,setWebcamError:s,webcamReloadKey:a,setWebcamReloadKey:u,imageSourceIndex:l,setImageSourceIndex:g,captureDate:v,captureDateLoading:S,currentCandidate:W,currentImageSrc:G,imageCandidates:$}},yU=({webcam:i,onClose:e})=>{const{isWebcamLoading:t,setIsWebcamLoading:r,webcamError:s,setWebcamError:a,webcamReloadKey:u,setWebcamReloadKey:l,imageSourceIndex:g,setImageSourceIndex:v,captureDate:T,captureDateLoading:S,currentCandidate:P,currentImageSrc:O,imageCandidates:$}=_U(i),W=je.useRef(null),G=je.useRef(!1),Q=je.useRef(0),ae=je.useRef(0),[te,me]=hE.useState(!1),we=ce=>{const ke=W.current;ke&&(G.current=!0,me(!0),Q.current=ce.clientX,ae.current=ke.scrollLeft,ke.setPointerCapture(ce.pointerId))},Oe=ce=>{if(!G.current)return;const ke=W.current;ke&&(ke.scrollLeft=ae.current-(ce.clientX-Q.current))},Je=ce=>{G.current&&(G.current=!1,me(!1),W.current?.hasPointerCapture(ce.pointerId)&&W.current.releasePointerCapture(ce.pointerId))};if(!i)return null;const it=i.imageDate?O_(i.imageDate):null,He=P?.slotDate?O_(P.slotDate):null,ht=T||it||He||(S?"Chargement...":"inconnue"),Ye=i.largeur??null,ft=i.hauteur??null,Ke=Ye!==null&&ft!==null&&(Ye<=400||ft<=250),Ze=$.length>1,ie=Ke&&Ze?"calc(100svh - 140px)":ft?`min(${ft}px, calc(100svh - 140px))`:"calc(100svh - 140px)",ge=Ye&&ft?`${Ye} / ${ft}`:void 0;return Le.jsx("div",{className:"fixed inset-0 z-[5000] bg-black/80 backdrop-blur-sm",onClick:e,children:Le.jsxs("div",{className:"flex h-full w-full flex-col",onClick:ce=>ce.stopPropagation(),children:[Le.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between px-4 py-3 bg-[var(--card-bg)]/95 border-b border-[var(--border)] gap-3 sm:gap-0 relative",children:[Le.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center gap-2 sm:gap-4 pr-8 sm:pr-0",children:[Le.jsx("div",{className:"text-lg font-semibold text-[var(--text-main)]",children:i.name?.toUpperCase()||"WEBCAM"}),Le.jsxs("div",{className:"text-xs text-[var(--text-muted)] flex flex-col sm:flex-row gap-1 sm:gap-3 flex-wrap items-start sm:items-center",children:[i.distance!==void 0&&Le.jsxs("span",{children:["Distance : ",i.distance.toFixed(2)," km"]}),Kw(i.altitude,i.altitudeDiff)&&Le.jsx("span",{children:Kw(i.altitude,i.altitudeDiff)}),Le.jsxs("span",{children:["Date capture : ",ht]})]})]}),Le.jsx("div",{className:"flex items-center gap-3",children:i.pageUrl&&Le.jsx("a",{href:i.pageUrl,target:"_blank",rel:"noreferrer",className:"hidden sm:inline-block text-[var(--primary)] text-xs font-semibold hover:text-[var(--primary-hover)] underline",children:"Voir la source"})}),Le.jsx("button",{onClick:ce=>{ce.stopPropagation(),ce.preventDefault(),e()},onPointerDown:ce=>ce.stopPropagation(),className:"p-2 text-[var(--text-muted)] sm:hover:text-[var(--text-main)] sm:hover:bg-[rgba(55,65,81,0.95)] active:bg-[rgba(55,65,81,0.95)] rounded-lg transition-all duration-300 ease-out absolute top-2 right-2 sm:static sm:top-auto sm:right-auto",children:Le.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[Le.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),Le.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]}),Le.jsxs("div",{className:"relative flex-1 min-h-0 bg-black",children:[Le.jsx("a",{href:"https://www.spotair.mobi/",target:"_blank",rel:"noreferrer",className:"absolute top-4 right-4 z-30 bg-white/85 rounded-lg p-2 shadow-lg hover:scale-[1.02] transition-transform",children:Le.jsx("img",{src:"/logo/favicon-spotair.svg",alt:"SpotAir",className:"h-10 w-10"})}),t&&Le.jsx("div",{className:"absolute inset-0 bg-black/60 backdrop-blur-sm z-20 flex flex-col items-center justify-center",children:Le.jsxs("div",{className:"loading-content",children:[Le.jsx("img",{src:"/logo/flocon-white.svg",alt:"",className:"loading-spinner"}),Le.jsx("p",{children:"Chargement de la webcam..."})]})}),s&&!t&&Le.jsxs("div",{className:"absolute inset-0 bg-black/70 z-20 flex flex-col items-center justify-center gap-3 text-center p-4 text-white",children:[Le.jsx("p",{className:"font-medium",children:s}),Le.jsx("button",{onClick:()=>{a(null),r(!!i.imageUrl),l(ce=>ce+1),v(0)},className:"px-4 py-2 bg-[var(--primary)] text-white rounded-lg hover:bg-[var(--primary-hover)] transition-colors",children:"Reessayer"})]}),Le.jsx("div",{ref:W,className:`h-full w-full min-h-0 overflow-x-auto overflow-y-hidden bg-black ${te?"cursor-grabbing":"cursor-grab"} flex items-stretch`,style:{touchAction:"pan-x",height:"calc(100svh - 140px)",maxHeight:"calc(100svh - 140px)"},onPointerDown:we,onPointerMove:Oe,onPointerUp:Je,onPointerCancel:Je,onPointerLeave:Je,children:O?Le.jsx("img",{src:O,alt:i.name||"Webcam",className:"h-full w-auto block select-none pointer-events-none flex-shrink-0",style:{height:"100%",width:"auto",maxWidth:"none",maxHeight:ie,aspectRatio:ge},draggable:!1,onLoad:()=>r(!1),onError:()=>{const ce=g+1;if(ce<$.length){v(ce),r(!0);return}r(!1),a("Impossible de charger la webcam pour le moment.")}},`${i.id}-${u}-${g}`):Le.jsx("div",{className:"h-full w-full flex items-center justify-center text-[var(--text-muted)] text-sm px-4",children:"Aucune image disponible pour cette webcam."})})]})]})})},zm=i=>i.toString().normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().trim().replace(/\s+/g,"-").replace(/[^\w-]+/g,"").replace(/--+/g,"-"),JU=({stations:i,conditions:e,webcams:t,lat:r,lon:s,zoom:a=gh,initialSelectedId:u,initialSelectedType:l,onViewChange:g,radiusKm:v,showReference:T=!1,baseLayer:S,onBaseLayerChange:P,enableHillshade:O=!0,enableContours:$=!1,enableSlopes:W=!1,enableSnow:G=!1,enableSkiTraces:Q=!1,enableOpenSkiMap:ae=!1,enablePeaks:te=!0,initialView:me,onSelectionClear:we,topLeftOverlay:Oe,mapAttributionText:Je,isDeepLinkStation:it,isDeepLinkCondition:He,isDeepLinkWebcam:ht,onMapInstanceReady:Ye})=>{const ft=me?null:uE(),Ke={latitude:45.5,longitude:6.5,zoom:8.5,pitch:0,bearing:0},Ze=je.useMemo(()=>me?{latitude:me.center[0],longitude:me.center[1],zoom:me.zoom,pitch:0,bearing:0}:ft?{latitude:ft.center[0],longitude:ft.center[1],zoom:ft.zoom,pitch:0,bearing:0}:Ke,[me,ft]),[ve,ie]=je.useState(Ze),[ge,ce]=je.useState("test"),ke=S||ge,Be=B=>{P?P(B):ce(B)},[Ve,We]=je.useState(null),[tt,wt]=je.useState(null),[_t,$t]=je.useState(null),[kt,Bt]=je.useState(!1),Kt=je.useRef(null),Et=je.useRef(null),[Li,bi]=je.useState(null),Ri=je.useRef(!1);cN(Kt);const Fi=je.useMemo(()=>typeof window>"u"||typeof window.matchMedia!="function"?!1:window.matchMedia("(pointer: coarse)").matches,[]),Lt=PT[ke],Ce=Fi?15:0,ns=je.useMemo(()=>{if(!Fi)return{};const B=14;return{pan:{threshold:B},tap:{threshold:B,time:350}}},[Fi]),os=Fi?MN:PN,ii=Fi?22:8,wi=8;je.useEffect(()=>{if(u){if(l==="station"||!l){const B=i.find(U=>String(U.stationId)===u);if(B){We(B);return}}if(l==="condition"||!l){const B=e.find(U=>U.entries.some(q=>String(q.id)===u));if(B){wt(B);return}}if(l==="webcam"||!l){const B=t.find(U=>String(U.id)===u);if(B){$t(B);return}}}},[u,l,i,e,t]),Z5({mapInstance:Li,activeBaseLayer:Lt,hillshadeEnabled:O,contoursEnabled:$,slopesEnabled:W,snowEnabled:G,skiTracesEnabled:Q,openSkiMapEnabled:ae,peaksEnabled:te,baseLayer:ke});const{queryResult:qi,loading:Ns,handleMapClick:_s,clearQuery:zs}=J5(Li,G),{clusters:kr,clusterIndex:Pn}=RN({stations:i,conditions:e,webcams:t,viewState:ve}),Mn=d5({clusters:kr,activeBaseLayer:Lt,showReference:T,radiusKm:v,lat:r,lon:s,markerHitSize:os}),st=B=>{const U=B.target;U.on("styleimagemissing",q=>{const ee=q.id,pe=1,ye=1,Te=new Uint8Array(pe*ye*4);U.addImage(ee,{width:pe,height:ye,data:Te})}),bi(U),Ye?.(U)},Xr=()=>{Et.current&&Et.current.resize()};je.useEffect(()=>(window.addEventListener("resize",Xr),()=>window.removeEventListener("resize",Xr)),[]);const er=B=>{ie(U=>{const q=typeof U.zoom=="number"?U.zoom:gh,ee=Math.min(Math.max(q+B,0),22),pe={...U,zoom:ee},ye={center:[pe.latitude,pe.longitude],zoom:ee};return Wg(ye),g?.(ye),pe})},Dr=(B,U)=>{U(null);const q=window.location.hash.includes(`/${B}`);if(window.location.pathname.startsWith(`/${B}/`))window.location.href="/";else if(q){const pe=window.location.search,ye=window.location.pathname;window.history.pushState(null,"",ye+pe)}},ys=it??!!(u&&l==="station"),ot=He??!!(u&&l==="condition"),qt=ht??!!(u&&l==="webcam");Xd(!!Ve,()=>Dr("stations",We),"station",Ve?`/r#/stations/${Ve.stationId}-${zm(Ve.name)}`:void 0,ys),Xd(!!tt,()=>Dr("avis",wt),"avis",tt?`/r#/avis/${tt.entries[0]?.id||"0"}-${zm(tt.entries[0]?.nom||"avis")}`:void 0,ot),Xd(!!_t,()=>Dr("webcams",$t),"webcam",_t?`/r#/webcams/${_t.id}-${zm(_t.name||"cam")}`:void 0,qt),Xd(kt,()=>Bt(!1),"mapinfo");const Nt=B=>{const U=Kt.current?.deck?.getCanvas?.();if(!U)return null;const q=U.getBoundingClientRect(),ee=B?.srcEvent??B?.sourceEvent??B,pe=ee?.changedTouches?.[0]||ee?.touches?.[0],ye=typeof pe?.clientX=="number"?pe.clientX:typeof ee?.clientX=="number"?ee.clientX:typeof B?.center?.x=="number"?B.center.x:null,Te=typeof pe?.clientY=="number"?pe.clientY:typeof ee?.clientY=="number"?ee.clientY:typeof B?.center?.y=="number"?B.center.y:null;if(ye===null||Te===null){const de=B?.offsetCenter;return!de||typeof de.x!="number"||typeof de.y!="number"?null:{x:de.x,y:de.y}}return{x:ye-q.left,y:Te-q.top}},Ji=B=>{if(!B)return;const{kind:U,data:q}=B.properties||{};if(U==="station"&&q)We(q);else if(U==="condition"&&q)wt(q);else if(U==="webcam"&&q)$t(q);else if(B.properties?.cluster){const ee=typeof ve.zoom=="number"?ve.zoom:gh,pe=typeof B.id=="string"?B.id.split("-")[0]:B.id,ye=Number(pe);let Te=Pn.getClusterExpansionZoom(ye);const de=ee+2,ze=Math.min(Math.max(Te||0,de),20);ie(Ne=>({...Ne,longitude:B.geometry.coordinates[0],latitude:B.geometry.coordinates[1],zoom:ze,transitionDuration:400}));const qe={center:[B.geometry.coordinates[1],B.geometry.coordinates[0]],zoom:ze};Wg(qe),g?.(qe)}},Zr=B=>{const U=B?.viewport,q=B?.object?.geometry?.coordinates;if(!U||!Array.isArray(q)||q.length<2)return null;const[ee,pe]=U.project(q),ye=B?.object?.properties?.xOffset??0;return{x:ee+U.x+ye,y:pe+U.y}},zt=(B,U)=>{const q=Nt(B);if(!q||!Kt.current?.deck){U&&Ji(U);return}const pe=Math.max(Ce,Fi?24:10),ye=Kt.current.deck.pickMultipleObjects?.({x:q.x,y:q.y,radius:pe,depth:wi,layerIds:["marker-hit-areas"]})??[];if(ye.length>0){let Te=null;for(const de of ye){if(!de.object)continue;const ze=Zr(de);if(!ze)continue;const qe=ze.x-q.x,Ne=ze.y-q.y,nt=qe*qe+Ne*Ne;(!Te||nt<Te.dist)&&(Te={object:de.object,dist:nt})}if(Te){Ji(Te.object);return}}U&&Ji(U)},Yr=typeof ve.zoom=="number"?ve.zoom:gh,xs=Yr<22,Us=Yr>0,as=je.useMemo(()=>Lt.type==="vector"&&Lt.styleUrl?Lt.styleUrl:{version:8,sources:{"raster-tiles":{type:"raster",tiles:[Lt.url.replace("{s}","a"),Lt.url.replace("{s}","b"),Lt.url.replace("{s}","c")],tileSize:256,attribution:Lt.attributionLabel}},layers:[{id:"simple-tiles",type:"raster",source:"raster-tiles",minzoom:0,maxzoom:22}]},[Lt]),le=je.useMemo(()=>{const B=[];return Lt.attributionLabel&&B.push(Lt.attributionLabel),O&&Lt.overlayAttributionLabel&&B.push(Lt.overlayAttributionLabel),$&&B.push("Courbes de niveau  IGN  RGE ALTI  Goservices"),W&&B.push(IT),Q&&B.push("IGN Traces"),ae&&B.push(CT),G&&B.push(" Naivo Data Mto-France"),Je&&B.push(Je),[...new Set(B)]},[Lt,O,$,W,G,Q,Je]);return Le.jsxs("div",{className:"w-full h-full relative",children:[Le.jsx(VB,{ref:Kt,viewState:ve,onViewStateChange:B=>{ie(B.viewState);const U=B.viewState,q={center:[U.latitude,U.longitude],zoom:U.zoom};Wg(q),g?.(q)},controller:{doubleClickZoom:!1,scrollZoom:!0,dragPan:!0,dragRotate:!1,touchRotate:!1},layers:Mn,getCursor:({isHovering:B})=>B?"pointer":"grab",touchAction:"manipulation",pickingRadius:Ce,eventRecognizerOptions:ns,onClick:(B,U)=>{const q=U?.srcEvent??U?.sourceEvent;if(Ri.current){(q?.touches?.length||0)===0&&(Ri.current=!1);return}if(q?.touches&&q.touches.length>1){Ri.current=!0;return}if(B?.layer?.id==="marker-hit-areas"&&B.object){if(!Fi){Ji(B.object);return}zt(U,B.object);return}if(!B.object&&G&&B.coordinate){const ee={lng:B.coordinate[0],lat:B.coordinate[1]};_s({lngLat:ee});return}qi&&zs(),zt(U)},onDragEnd:(B,U)=>{if(!Fi)return;const q=U?.srcEvent??U?.sourceEvent,ee=q?.touches?.length||0,pe=q?.changedTouches?.length||0;if(ee>1||pe>1||Ri.current){ee===0?Ri.current=!1:Ri.current=!0;return}const ye=U?.deltaX??0,Te=U?.deltaY??0;Math.hypot(ye,Te)>ii||zt(U)},onDragStart:(B,U)=>{const q=U?.srcEvent??U?.sourceEvent;Ri.current=q?.touches?.length>1},children:Le.jsx(QB,{ref:Et,mapStyle:as,attributionControl:!1,interactive:!1,doubleClickZoom:!1,onLoad:st,children:qi&&Le.jsx(tN,{longitude:qi.lngLat.lng,latitude:qi.lngLat.lat,anchor:"bottom",onClose:zs,closeButton:!1,closeOnClick:!0,className:"snow-popup",maxWidth:"240px",children:Le.jsxs("div",{className:"p-1 px-0.5 min-w-[150px] text-white flex items-center justify-between gap-4",children:[Le.jsxs("div",{className:"flex flex-col",children:[Le.jsx("span",{className:"text-[10px] font-bold uppercase tracking-wider text-[var(--text-muted)] leading-tight",children:"Altitude"}),Le.jsxs("div",{className:"flex items-baseline gap-1",children:[Le.jsx("span",{className:"text-sm font-bold leading-tight",children:Math.round(qi.elevation)}),Le.jsx("span",{className:"text-[10px] font-bold text-[var(--text-muted)] leading-tight",children:"m"}),qi.isEstimated&&Le.jsx("span",{className:"text-[9px] text-[var(--text-muted)] italic opacity-50 ml-1",children:"est."})]})]}),Le.jsx("div",{className:"w-px h-7 bg-white/10 self-center"}),Le.jsxs("div",{className:"flex flex-col items-end",children:[Le.jsx("span",{className:"text-[10px] font-bold uppercase tracking-wider text-[var(--text-muted)] leading-tight",children:"Neige"}),Le.jsxs("div",{className:"flex items-baseline gap-1",children:[Le.jsx("span",{className:`text-sm font-black text-white leading-tight ${qi.snowDepth===null?"opacity-50":""}`,children:qi.snowDepth!==null?qi.snowDepth:"--"}),qi.snowDepth!==null?Le.jsx("span",{className:"text-[10px] font-bold text-[var(--text-muted)] leading-tight",children:"cm"}):Le.jsx("span",{className:"text-[9px] text-[var(--text-muted)] italic opacity-50 ml-1",children:"(pas de donnes)"})]})]})]})})},Lt.id)}),qi&&Le.jsx("div",{className:"absolute left-[62px] bottom-3 z-[4102]",children:Le.jsxs("button",{onClick:B=>{B.stopPropagation(),zs()},className:"px-4 h-11 bg-[#1f2937]/90 backdrop-blur-md border border-white/10 rounded-[10px] text-white text-[11px] font-bold shadow-2xl flex items-center gap-2 hover:bg-[#374151] transition-all active:scale-95 pointer-events-auto",children:[Le.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"3",strokeLinecap:"round",strokeLinejoin:"round",children:[Le.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),Le.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]}),"Fermer enneigement"]})}),Ns&&Le.jsx("div",{className:"absolute top-20 right-[50%] translate-x-[50%] z-[4100] bg-black/60 backdrop-blur-md rounded-full p-2 border border-white/20",children:Le.jsx("img",{src:"/logo/flocon-white.svg",alt:"",className:"w-5 h-5 animate-spin"})}),Le.jsxs("div",{className:"pointer-events-none absolute z-[4200] flex flex-row items-start gap-2",style:{top:"calc(env(safe-area-inset-top, 0px) + 10px)",left:"calc(env(safe-area-inset-left, 0px) + 10px)",right:"calc(env(safe-area-inset-right, 0px) + 10px)"},children:[Oe&&Le.jsx("div",{className:"pointer-events-auto flex-1 max-w-[460px]",children:Oe}),Le.jsx("div",{className:"pointer-events-auto shrink-0",children:Le.jsx(tU,{isOpen:kt,setIsOpen:Bt,attributions:le})})]}),Le.jsx(Q5,{baseLayer:ke,setBaseLayer:Be}),Le.jsx(eU,{onZoomIn:()=>er(1),onZoomOut:()=>er(-1),canZoomIn:xs,canZoomOut:Us}),Le.jsx(pU,{station:Ve,onClose:()=>{We(null),ys&&we?.()}}),Le.jsx(mU,{condition:tt,onClose:()=>{wt(null),ot&&we?.()}}),Le.jsx(yU,{webcam:_t,onClose:()=>{$t(null),qt&&we?.()}}),Le.jsx("style",{children:`
                .maplibregl-ctrl-group { background: rgba(31, 41, 55, 0.95) !important; border: 1px solid var(--border) !important; border-radius: 10px !important; box-shadow: 0 8px 20px rgba(0,0,0,0.35) !important; overflow: hidden; width: 40px !important; }
                .maplibregl-ctrl-group button { width: 40px !important; height: 38px !important; background: transparent !important; border: none !important; border-bottom: 1px solid rgba(255,255,255,0.1) !important; color: white !important; display: flex; align-items: center; justify-content: center; transition: background-color 300ms ease-out !important; }
                .maplibregl-ctrl-group button:last-child { border-bottom: none !important; }
                .maplibregl-ctrl-group button:hover { background: rgba(55, 65, 81, 0.95) !important; }
                .maplibregl-ctrl-group button span { filter: invert(1) brightness(2); width: 18px !important; height: 18px !important; }
                .maplibregl-ctrl-compass { display: none !important; }
                .snow-popup { z-index: 4500 !important; }
                .snow-popup .maplibregl-popup-content { background: rgba(31, 41, 55, 0.95) !important; backdrop-filter: blur(8px) !important; border: 1px solid var(--border) !important; border-radius: 10px !important; padding: 12px 14px !important; box-shadow: 0 10px 30px rgba(0,0,0,0.45) !important; color: white !important; }
                .snow-popup .maplibregl-popup-tip { border-top-color: rgba(31, 41, 55, 0.95) !important; }
                 .snow-popup .maplibregl-popup-close-button { display: none !important; }
            `})]})};export{JU as default};
